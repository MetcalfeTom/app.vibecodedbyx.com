<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Feedback Hub - VibeCodedByX</title>
<link rel="icon" href="https://emojicdn.elk.sh/üí¨">
<meta property="og:title" content="Feedback Hub - VibeCodedByX">
<meta property="og:description" content="Share your ideas and vote on suggestions for Sloppy and the stream!">
<meta property="og:url" content="https://app.vibecodedbyx.com/feedback">
<meta property="og:image" content="https://image.pollinations.ai/prompt/feedback%20voting%20suggestions%20community%20ideas%20purple%20modern?width=1200&height=630&referrer=vibecodedbyx.com">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#0f0a1a 0%,#1a1025 50%,#251530 100%);min-height:100vh;color:#fff;padding:20px;position:relative}
body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at 20% 80%,rgba(139,92,246,0.1) 0%,transparent 50%),radial-gradient(circle at 80% 20%,rgba(236,72,153,0.08) 0%,transparent 50%);pointer-events:none}
.container{max-width:900px;margin:0 auto;position:relative;z-index:1}
header{text-align:center;margin-bottom:30px}
h1{font-size:2.8em;background:linear-gradient(135deg,#8B5CF6,#EC4899,#F59E0B);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:10px}
.subtitle{color:rgba(255,255,255,0.6);font-size:1.1em}
.stats-bar{display:flex;gap:20px;justify-content:center;margin:25px 0;flex-wrap:wrap}
.stat-box{background:rgba(255,255,255,0.06);backdrop-filter:blur(10px);padding:16px 28px;border-radius:14px;border:1px solid rgba(255,255,255,0.1);text-align:center}
.stat-number{font-size:2em;font-weight:700;background:linear-gradient(135deg,#8B5CF6,#EC4899);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.stat-label{font-size:12px;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:1px;margin-top:4px}
.search-bar{margin-bottom:25px}
.search-bar input{width:100%;padding:14px 20px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:14px;color:#fff;font-size:15px;transition:all .3s}
.search-bar input::placeholder{color:rgba(255,255,255,0.35)}
.search-bar input:focus{outline:none;border-color:rgba(139,92,246,0.5);box-shadow:0 0 20px rgba(139,92,246,0.15)}
.tabs{display:flex;gap:10px;margin-bottom:25px;flex-wrap:wrap;justify-content:center}
.tab{padding:12px 24px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:12px;cursor:pointer;font-size:15px;font-weight:600;color:rgba(255,255,255,0.7);transition:all .3s}
.tab:hover{background:rgba(255,255,255,0.1)}
.tab.active{background:linear-gradient(135deg,rgba(139,92,246,0.3),rgba(236,72,153,0.3));border-color:rgba(139,92,246,0.5);color:#fff}
.tab .count{background:rgba(255,255,255,0.15);padding:2px 8px;border-radius:10px;font-size:12px;margin-left:6px}
.new-feedback{background:rgba(255,255,255,0.06);backdrop-filter:blur(20px);border-radius:20px;margin-bottom:25px;border:1px solid rgba(255,255,255,0.1);overflow:hidden}
.form-header{padding:18px 25px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;transition:background .3s}
.form-header:hover{background:rgba(255,255,255,0.03)}
.form-header h2{font-size:1.2em;color:rgba(255,255,255,0.9);display:flex;align-items:center;gap:10px}
.form-toggle{font-size:1.2em;transition:transform .3s}
.form-toggle.open{transform:rotate(180deg)}
.form-body{padding:0 25px 25px;display:none}
.form-body.open{display:block;animation:slideDown .3s ease}
@keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
.form-row{margin-bottom:18px}
.form-row label{display:block;margin-bottom:8px;font-weight:600;color:rgba(255,255,255,0.7);font-size:.95em}
.form-row input,.form-row textarea{width:100%;padding:14px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.12);border-radius:12px;color:#fff;font-size:15px;font-family:inherit;transition:all .3s}
.form-row input::placeholder,.form-row textarea::placeholder{color:rgba(255,255,255,0.35)}
.form-row input:focus,.form-row textarea:focus{outline:none;border-color:rgba(139,92,246,0.5);box-shadow:0 0 20px rgba(139,92,246,0.15)}
.form-row textarea{min-height:100px;resize:vertical}
.char-count{text-align:right;font-size:12px;color:rgba(255,255,255,0.4);margin-top:6px}
.char-count.warn{color:#FBBF24}
.char-count.limit{color:#F87171}
.categories{display:flex;gap:10px;flex-wrap:wrap}
.category-btn{padding:10px 18px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:10px;cursor:pointer;font-size:14px;color:rgba(255,255,255,0.7);transition:all .3s}
.category-btn:hover{background:rgba(255,255,255,0.1)}
.category-btn.selected{background:linear-gradient(135deg,rgba(139,92,246,0.3),rgba(236,72,153,0.2));border-color:rgba(139,92,246,0.5);color:#fff}
.submit-btn{width:100%;padding:16px;background:linear-gradient(135deg,#8B5CF6,#EC4899);border:none;border-radius:14px;color:#fff;font-size:17px;font-weight:600;cursor:pointer;transition:all .3s;margin-top:10px}
.submit-btn:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(139,92,246,0.4)}
.submit-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
.sort-bar{display:flex;gap:15px;margin-bottom:20px;align-items:center;flex-wrap:wrap}
.sort-bar span{color:rgba(255,255,255,0.5);font-size:14px}
.sort-btn{padding:8px 16px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:10px;cursor:pointer;font-size:13px;color:rgba(255,255,255,0.6);transition:all .3s}
.sort-btn:hover,.sort-btn.active{background:rgba(139,92,246,0.2);border-color:rgba(139,92,246,0.4);color:#fff}
.feedback-list{display:flex;flex-direction:column;gap:16px}
.feedback-card{background:rgba(255,255,255,0.06);backdrop-filter:blur(20px);border-radius:18px;padding:24px;border:1px solid rgba(255,255,255,0.1);transition:all .3s;display:flex;gap:20px;animation:cardIn .4s ease}
@keyframes cardIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.feedback-card:hover{background:rgba(255,255,255,0.08);transform:translateY(-2px)}
.feedback-card.own{border-left:3px solid #8B5CF6}
.vote-section{display:flex;flex-direction:column;align-items:center;gap:6px;min-width:60px}
.vote-btn{width:44px;height:44px;border-radius:12px;border:1px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.05);color:rgba(255,255,255,0.6);font-size:20px;cursor:pointer;transition:all .3s;display:flex;align-items:center;justify-content:center}
.vote-btn:hover{background:rgba(139,92,246,0.2);border-color:rgba(139,92,246,0.4);transform:scale(1.1)}
.vote-btn.voted{background:linear-gradient(135deg,rgba(139,92,246,0.5),rgba(236,72,153,0.4));border-color:rgba(139,92,246,0.6);color:#fff;animation:votePop .3s ease}
@keyframes votePop{0%{transform:scale(1)}50%{transform:scale(1.2)}100%{transform:scale(1)}}
.vote-count{font-size:1.5em;font-weight:700;color:#8B5CF6}
.feedback-content{flex:1}
.feedback-header{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:8px}
.feedback-title{font-size:1.2em;font-weight:600;color:rgba(255,255,255,0.95);flex:1}
.delete-btn{padding:6px 12px;background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.25);border-radius:8px;color:#F87171;font-size:12px;cursor:pointer;transition:all .3s;opacity:0.7}
.delete-btn:hover{background:rgba(239,68,68,0.25);opacity:1}
.feedback-desc{color:rgba(255,255,255,0.6);line-height:1.6;margin-bottom:12px;white-space:pre-wrap}
.feedback-meta{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.feedback-category{padding:6px 12px;background:rgba(139,92,246,0.2);border-radius:8px;font-size:12px;font-weight:600;color:#A78BFA;text-transform:uppercase;letter-spacing:.5px}
.feedback-category.sloppy{background:rgba(236,72,153,0.2);color:#F472B6}
.feedback-category.streamer{background:rgba(245,158,11,0.2);color:#FBBF24}
.feedback-category.apps{background:rgba(34,197,94,0.2);color:#4ADE80}
.feedback-time{font-size:13px;color:rgba(255,255,255,0.4)}
.feedback-status{padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;text-transform:uppercase}
.feedback-status.new{background:rgba(59,130,246,0.2);color:#60A5FA}
.feedback-status.planned{background:rgba(245,158,11,0.2);color:#FBBF24}
.feedback-status.done{background:rgba(34,197,94,0.2);color:#4ADE80}
.empty-state{text-align:center;padding:60px 20px;color:rgba(255,255,255,0.4)}
.empty-state-icon{font-size:4em;margin-bottom:20px;animation:float 3s ease-in-out infinite}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
.loading{text-align:center;padding:40px;color:rgba(255,255,255,0.5)}
.loading-spinner{width:40px;height:40px;border:3px solid rgba(139,92,246,0.2);border-top-color:#8B5CF6;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 15px}
@keyframes spin{to{transform:rotate(360deg)}}
.error{background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.3);color:#FCA5A5;padding:16px;border-radius:12px;margin-bottom:20px;display:none}
.error.show{display:block;animation:shake .4s ease}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
.success{background:rgba(34,197,94,0.15);border:1px solid rgba(34,197,94,0.3);color:#86EFAC;padding:16px;border-radius:12px;margin-bottom:20px;display:none}
.success.show{display:block;animation:fadeIn .3s}
@keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
.live-indicator{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:rgba(34,197,94,0.15);border-radius:20px;font-size:12px;color:#4ADE80;margin-left:15px}
.live-dot{width:8px;height:8px;background:#4ADE80;border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
.backlink{margin-top:40px;text-align:center}
.backlink a{color:rgba(139,92,246,0.8);text-decoration:none;font-weight:600;padding:12px 24px;background:rgba(255,255,255,0.05);border-radius:12px;transition:all .3s;border:1px solid rgba(255,255,255,0.08);display:inline-block;margin:5px}
.backlink a:hover{background:rgba(255,255,255,0.1);transform:translateY(-2px)}
@media(max-width:600px){
h1{font-size:2.2em}
.feedback-card{flex-direction:column;gap:15px}
.vote-section{flex-direction:row;width:100%;justify-content:flex-start}
.tabs{gap:8px}
.tab{padding:10px 16px;font-size:14px}
.stats-bar{gap:12px}
.stat-box{padding:12px 20px}
.stat-number{font-size:1.6em}
}
</style>
</head>
<body>
<div class="container">
<header>
<h1>Feedback Hub</h1>
<p class="subtitle">Share ideas & vote on suggestions for Sloppy and the stream!<span class="live-indicator"><span class="live-dot"></span>Live</span></p>
</header>

<div class="stats-bar">
<div class="stat-box">
<div class="stat-number" id="totalIdeas">0</div>
<div class="stat-label">Ideas</div>
</div>
<div class="stat-box">
<div class="stat-number" id="totalVotes">0</div>
<div class="stat-label">Votes</div>
</div>
<div class="stat-box">
<div class="stat-number" id="activeUsers">0</div>
<div class="stat-label">Contributors</div>
</div>
</div>

<div class="search-bar">
<input type="text" id="searchInput" placeholder="Search feedback...">
</div>

<div class="tabs">
<button class="tab active" data-filter="all">All</button>
<button class="tab" data-filter="sloppy">Sloppy/AI</button>
<button class="tab" data-filter="streamer">Streamer</button>
<button class="tab" data-filter="apps">Apps</button>
<button class="tab" data-filter="general">General</button>
<button class="tab" data-filter="mine">My Ideas<span class="count" id="myCount">0</span></button>
</div>

<div id="error" class="error"></div>
<div id="success" class="success"></div>

<div class="new-feedback">
<div class="form-header" id="formHeader">
<h2>‚ú® Submit New Idea</h2>
<span class="form-toggle" id="formToggle">‚ñº</span>
</div>
<div class="form-body" id="formBody">
<div class="form-row">
<label>Title</label>
<input type="text" id="title" placeholder="Short summary of your idea..." maxlength="100">
<div class="char-count"><span id="titleCount">0</span>/100</div>
</div>
<div class="form-row">
<label>Description (optional)</label>
<textarea id="description" placeholder="Describe your suggestion in detail..." maxlength="500"></textarea>
<div class="char-count"><span id="descCount">0</span>/500</div>
</div>
<div class="form-row">
<label>Category</label>
<div class="categories">
<button class="category-btn selected" data-category="sloppy">Sloppy/AI</button>
<button class="category-btn" data-category="streamer">Streamer</button>
<button class="category-btn" data-category="apps">Apps</button>
<button class="category-btn" data-category="general">General</button>
</div>
</div>
<button class="submit-btn" id="submitBtn">Submit Feedback</button>
</div>
</div>

<div class="sort-bar">
<span>Sort by:</span>
<button class="sort-btn active" data-sort="votes">Top Voted</button>
<button class="sort-btn" data-sort="newest">Newest</button>
<button class="sort-btn" data-sort="oldest">Oldest</button>
</div>

<div id="feedbackList" class="feedback-list">
<div class="loading"><div class="loading-spinner"></div>Loading feedback...</div>
</div>

<div class="backlink">
<a href="https://www.vibecodedbyx.com" target="_blank">Back to Stream</a>
<a href="https://app.vibecodedbyx.com/overview">View All Apps</a>
</div>
</div>

<script type="module">
import supabase, { supabaseSession } from '../../supabase-config.js';

let currentUser = null;
let userVotes = {};
let allFeedback = [];
let currentFilter = 'all';
let currentSort = 'votes';
let selectedCategory = 'sloppy';
let searchQuery = '';

async function init() {
    try {
        const { user } = await supabaseSession();
        currentUser = user;
        await loadUserVotes();
        await loadFeedback();
        setupEventListeners();
        setupRealtime();
        updateStats();
    } catch (e) {
        showError('Failed to initialize: ' + e.message);
    }
}

function setupEventListeners() {
    // Form toggle
    document.getElementById('formHeader').addEventListener('click', () => {
        document.getElementById('formBody').classList.toggle('open');
        document.getElementById('formToggle').classList.toggle('open');
    });
    // Open form by default
    document.getElementById('formBody').classList.add('open');
    document.getElementById('formToggle').classList.add('open');

    // Character counters
    document.getElementById('title').addEventListener('input', e => {
        const count = e.target.value.length;
        const el = document.getElementById('titleCount');
        el.textContent = count;
        el.parentElement.className = 'char-count' + (count > 90 ? ' limit' : count > 70 ? ' warn' : '');
    });
    document.getElementById('description').addEventListener('input', e => {
        const count = e.target.value.length;
        const el = document.getElementById('descCount');
        el.textContent = count;
        el.parentElement.className = 'char-count' + (count > 450 ? ' limit' : count > 350 ? ' warn' : '');
    });

    // Category buttons
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedCategory = btn.dataset.category;
        });
    });

    // Filter tabs
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            currentFilter = tab.dataset.filter;
            renderFeedback();
        });
    });

    // Sort buttons
    document.querySelectorAll('.sort-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentSort = btn.dataset.sort;
            renderFeedback();
        });
    });

    // Search
    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', e => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            searchQuery = e.target.value.toLowerCase().trim();
            renderFeedback();
        }, 300);
    });

    // Submit button
    document.getElementById('submitBtn').addEventListener('click', submitFeedback);
}

function setupRealtime() {
    // Subscribe to feedback changes
    supabase.channel('feedback-changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'feedback' }, () => {
            loadFeedback();
        })
        .on('postgres_changes', { event: '*', schema: 'public', table: 'feedback_votes' }, () => {
            loadFeedback();
            loadUserVotes();
        })
        .subscribe();
}

async function loadUserVotes() {
    if (!currentUser) return;
    try {
        const { data } = await supabase
            .from('feedback_votes')
            .select('feedback_id, vote_type')
            .eq('user_id', currentUser.id);
        userVotes = {};
        (data || []).forEach(v => userVotes[v.feedback_id] = v.vote_type);
    } catch (e) {
        console.error('Failed to load votes:', e);
    }
}

async function loadFeedback() {
    try {
        const { data, error } = await supabase
            .from('feedback')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) throw error;
        allFeedback = data || [];
        renderFeedback();
        updateStats();
    } catch (e) {
        document.getElementById('feedbackList').innerHTML = '<div class="empty-state">Failed to load feedback</div>';
        showError('Error: ' + e.message);
    }
}

function renderFeedback() {
    const listEl = document.getElementById('feedbackList');

    // Filter
    let filtered = allFeedback.filter(item => {
        if (currentFilter === 'mine') return item.user_id === currentUser?.id;
        if (currentFilter !== 'all') return item.category === currentFilter;
        return true;
    });

    // Search
    if (searchQuery) {
        filtered = filtered.filter(item =>
            item.title.toLowerCase().includes(searchQuery) ||
            (item.description || '').toLowerCase().includes(searchQuery)
        );
    }

    // Sort
    filtered.sort((a, b) => {
        if (currentSort === 'votes') return (b.votes || 0) - (a.votes || 0);
        if (currentSort === 'newest') return new Date(b.created_at) - new Date(a.created_at);
        if (currentSort === 'oldest') return new Date(a.created_at) - new Date(b.created_at);
        return 0;
    });

    // Update my count
    const myCount = allFeedback.filter(f => f.user_id === currentUser?.id).length;
    document.getElementById('myCount').textContent = myCount;

    if (filtered.length === 0) {
        listEl.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">${searchQuery ? 'üîç' : 'üí≠'}</div>
                <p>${searchQuery ? 'No results found' : currentFilter === 'mine' ? "You haven't submitted any ideas yet" : 'No feedback yet. Be the first!'}</p>
            </div>`;
        return;
    }

    listEl.innerHTML = filtered.map(item => renderCard(item)).join('');

    // Add event listeners
    listEl.querySelectorAll('.vote-btn').forEach(btn => {
        btn.addEventListener('click', () => vote(parseInt(btn.dataset.id)));
    });
    listEl.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', () => deleteFeedback(parseInt(btn.dataset.id)));
    });
}

function renderCard(item) {
    const hasVoted = userVotes[item.id] === 1;
    const isOwn = item.user_id === currentUser?.id;
    const timeAgo = getTimeAgo(new Date(item.created_at));

    return `
        <div class="feedback-card ${isOwn ? 'own' : ''}">
            <div class="vote-section">
                <button class="vote-btn ${hasVoted ? 'voted' : ''}" data-id="${item.id}">‚ñ≤</button>
                <span class="vote-count">${item.votes || 0}</span>
            </div>
            <div class="feedback-content">
                <div class="feedback-header">
                    <div class="feedback-title">${escapeHtml(item.title)}</div>
                    ${isOwn ? `<button class="delete-btn" data-id="${item.id}">Delete</button>` : ''}
                </div>
                ${item.description ? `<div class="feedback-desc">${escapeHtml(item.description)}</div>` : ''}
                <div class="feedback-meta">
                    <span class="feedback-category ${item.category}">${getCategoryLabel(item.category)}</span>
                    <span class="feedback-time">${timeAgo}</span>
                    ${item.status && item.status !== 'new' ? `<span class="feedback-status ${item.status}">${item.status}</span>` : ''}
                </div>
            </div>
        </div>`;
}

function updateStats() {
    document.getElementById('totalIdeas').textContent = allFeedback.length;
    const totalVotes = allFeedback.reduce((sum, f) => sum + (f.votes || 0), 0);
    document.getElementById('totalVotes').textContent = totalVotes;
    const uniqueUsers = new Set(allFeedback.map(f => f.user_id)).size;
    document.getElementById('activeUsers').textContent = uniqueUsers;
}

function getCategoryLabel(cat) {
    const labels = { sloppy: 'Sloppy/AI', streamer: 'Streamer', apps: 'Apps', general: 'General' };
    return labels[cat] || cat;
}

async function submitFeedback() {
    const title = document.getElementById('title').value.trim();
    const description = document.getElementById('description').value.trim();

    if (!title) {
        showError('Please enter a title');
        return;
    }
    if (title.length < 5) {
        showError('Title must be at least 5 characters');
        return;
    }

    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.textContent = 'Submitting...';

    try {
        const { error } = await supabase.from('feedback').insert({
            title,
            description: description || null,
            category: selectedCategory,
            votes: 0,
            status: 'new',
            user_id: currentUser.id
        });

        if (error) throw error;

        document.getElementById('title').value = '';
        document.getElementById('description').value = '';
        document.getElementById('titleCount').textContent = '0';
        document.getElementById('descCount').textContent = '0';
        showSuccess('Feedback submitted! Thanks for sharing your idea.');
        await loadFeedback();
    } catch (e) {
        showError('Failed to submit: ' + e.message);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Submit Feedback';
    }
}

async function vote(feedbackId) {
    if (!currentUser) {
        showError('Please sign in to vote');
        return;
    }

    const hasVoted = userVotes[feedbackId] === 1;
    const btn = document.querySelector(`.vote-btn[data-id="${feedbackId}"]`);

    // Optimistic update
    btn.classList.toggle('voted');
    const countEl = btn.nextElementSibling;
    const currentCount = parseInt(countEl.textContent) || 0;
    countEl.textContent = hasVoted ? currentCount - 1 : currentCount + 1;

    try {
        if (hasVoted) {
            await supabase.from('feedback_votes')
                .delete()
                .eq('feedback_id', feedbackId)
                .eq('user_id', currentUser.id);
            delete userVotes[feedbackId];
        } else {
            await supabase.from('feedback_votes').insert({
                feedback_id: feedbackId,
                vote_type: 1,
                user_id: currentUser.id
            });
            userVotes[feedbackId] = 1;
        }

        // Update vote count
        const { data } = await supabase
            .from('feedback_votes')
            .select('id')
            .eq('feedback_id', feedbackId);

        await supabase.from('feedback')
            .update({ votes: data?.length || 0 })
            .eq('id', feedbackId);

    } catch (e) {
        // Revert on error
        btn.classList.toggle('voted');
        countEl.textContent = currentCount;
        showError('Vote failed: ' + e.message);
    }
}

async function deleteFeedback(id) {
    if (!confirm('Delete this feedback?')) return;

    try {
        // Delete votes first
        await supabase.from('feedback_votes').delete().eq('feedback_id', id);
        // Delete feedback
        const { error } = await supabase.from('feedback').delete().eq('id', id);
        if (error) throw error;
        showSuccess('Feedback deleted');
        await loadFeedback();
    } catch (e) {
        showError('Failed to delete: ' + e.message);
    }
}

function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    if (seconds < 60) return 'just now';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return minutes + 'm ago';
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return hours + 'h ago';
    const days = Math.floor(hours / 24);
    if (days < 30) return days + 'd ago';
    return date.toLocaleDateString();
}

function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function showError(msg) {
    const el = document.getElementById('error');
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 5000);
}

function showSuccess(msg) {
    const el = document.getElementById('success');
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 4000);
}

init();
</script>
</body>
</html>
