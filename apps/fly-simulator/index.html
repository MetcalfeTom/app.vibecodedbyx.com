<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Fly Simulator</title>
  <link rel="icon" href="https://emojicdn.elk.sh/ü™∞">
  <meta property="og:title" content="Fly Simulator">
  <meta property="og:description" content="Dodge neon flyswatters! How long can you survive?">
  <meta property="og:url" content="https://app.sloppy.live/fly-simulator">
  <meta property="og:image" content="https://emojicdn.elk.sh/ü™∞?style=google">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Space+Mono:wght@700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      min-height: 100vh;
      background: #0a0a12;
      overflow: hidden;
      font-family: 'Space Mono', monospace;
      cursor: none;
    }

    canvas {
      display: block;
    }

    .ui {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 10;
      color: #fff;
      pointer-events: none;
    }

    .score {
      font-family: 'Bangers', cursive;
      font-size: 48px;
      color: #39ff14;
      text-shadow: 0 0 20px #39ff14, 0 0 40px #39ff14;
      letter-spacing: 3px;
    }

    .time {
      font-size: 14px;
      color: #888;
      margin-top: 5px;
    }

    .game-over {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .game-over h1 {
      font-family: 'Bangers', cursive;
      font-size: clamp(48px, 15vw, 100px);
      color: #ff006e;
      text-shadow: 0 0 30px #ff006e, 0 0 60px #ff006e;
      margin-bottom: 20px;
      animation: shake 0.5s ease-in-out;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20% { transform: translateX(-20px) rotate(-5deg); }
      40% { transform: translateX(20px) rotate(5deg); }
      60% { transform: translateX(-10px) rotate(-3deg); }
      80% { transform: translateX(10px) rotate(3deg); }
    }

    .game-over .final-score {
      font-family: 'Bangers', cursive;
      font-size: 36px;
      color: #39ff14;
      text-shadow: 0 0 20px #39ff14;
      margin-bottom: 30px;
    }

    .game-over .high-score {
      font-size: 16px;
      color: #ffbe0b;
      margin-bottom: 40px;
    }

    .btn {
      background: linear-gradient(135deg, #ff006e 0%, #8338ec 100%);
      border: none;
      padding: 18px 50px;
      font-family: 'Bangers', cursive;
      font-size: 28px;
      color: #fff;
      border-radius: 50px;
      cursor: pointer;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
      box-shadow: 0 0 30px rgba(255, 0, 110, 0.5);
      transition: all 0.2s ease;
      letter-spacing: 2px;
    }

    .btn:hover {
      transform: scale(1.1);
      box-shadow: 0 0 50px rgba(255, 0, 110, 0.8);
    }

    .start-screen {
      position: fixed;
      inset: 0;
      background: radial-gradient(ellipse at center, #1a1a2e 0%, #0a0a12 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .start-screen h1 {
      font-family: 'Bangers', cursive;
      font-size: clamp(48px, 12vw, 80px);
      background: linear-gradient(135deg, #39ff14, #00ffff, #ff006e);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
      animation: glow 2s ease-in-out infinite alternate;
    }

    @keyframes glow {
      from { filter: drop-shadow(0 0 20px #39ff14); }
      to { filter: drop-shadow(0 0 40px #00ffff); }
    }

    .start-screen .fly-icon {
      font-size: 80px;
      margin-bottom: 30px;
      animation: buzz 0.1s infinite;
    }

    @keyframes buzz {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      25% { transform: translate(2px, -1px) rotate(2deg); }
      50% { transform: translate(-1px, 2px) rotate(-1deg); }
      75% { transform: translate(-2px, -2px) rotate(1deg); }
    }

    .start-screen .instructions {
      color: #666;
      font-size: 14px;
      margin-bottom: 40px;
      text-align: center;
      line-height: 1.8;
    }

    .start-screen .instructions span {
      color: #39ff14;
    }

    .back-link {
      position: fixed;
      bottom: 20px;
      left: 20px;
      color: #333;
      text-decoration: none;
      font-size: 12px;
      z-index: 10;
      transition: color 0.2s;
    }

    .back-link:hover {
      color: #666;
    }

    .combo {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-family: 'Bangers', cursive;
      font-size: 60px;
      color: #ffbe0b;
      text-shadow: 0 0 30px #ffbe0b;
      pointer-events: none;
      opacity: 0;
      z-index: 50;
    }

    .combo.show {
      animation: comboPopup 0.8s ease-out forwards;
    }

    @keyframes comboPopup {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
      20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
      100% { opacity: 0; transform: translate(-50%, -80%) scale(1); }
    }

    .warning {
      position: fixed;
      font-family: 'Bangers', cursive;
      font-size: 24px;
      color: #ff006e;
      text-shadow: 0 0 10px #ff006e;
      pointer-events: none;
      animation: warningPulse 0.3s ease-in-out infinite;
    }

    @keyframes warningPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body>
  <canvas id="game"></canvas>

  <div class="ui">
    <div class="score" id="score">0</div>
    <div class="time" id="time">0.0s</div>
  </div>

  <div class="combo" id="combo"></div>

  <div class="start-screen" id="startScreen">
    <div class="fly-icon">ü™∞</div>
    <h1>FLY SIMULATOR</h1>
    <p class="instructions">
      <span>Mouse</span> or <span>Touch</span> to move<br>
      Dodge the neon flyswatters!<br>
      Survive as long as you can!
    </p>
    <button class="btn" id="startBtn">BUZZ OFF!</button>
  </div>

  <div class="game-over" id="gameOver" style="display:none">
    <h1>SPLAT!</h1>
    <div class="final-score" id="finalScore">Score: 0</div>
    <div class="high-score" id="highScore">High Score: 0</div>
    <button class="btn" id="restartBtn">TRY AGAIN</button>
  </div>

  <a href="https://sloppy.live" class="back-link">‚Üê sloppy.live</a>

  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    let width, height;
    let gameRunning = false;
    let score = 0;
    let startTime = 0;
    let highScore = parseInt(localStorage.getItem('flySimHighScore')) || 0;

    // Fly
    const fly = {
      x: 0,
      y: 0,
      targetX: 0,
      targetY: 0,
      size: 25,
      angle: 0,
      wingPhase: 0
    };

    // Swatters
    let swatters = [];
    let spawnTimer = 0;
    let difficulty = 1;

    // Particles
    let particles = [];

    // Audio context
    let audioCtx;

    function initAudio() {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }

    function playBuzz() {
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.frequency.value = 200 + Math.random() * 100;
      osc.type = 'sawtooth';
      gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
      gain.gain.exponentialDecayTo && gain.gain.exponentialDecayTo(0.01, audioCtx.currentTime + 0.1);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.05);
    }

    function playSplat() {
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.frequency.value = 100;
      osc.type = 'square';
      gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
      gain.gain.exponentialDecayTo && gain.gain.exponentialDecayTo(0.01, audioCtx.currentTime + 0.3);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.2);
    }

    function resize() {
      width = canvas.width = window.innerWidth;
      height = canvas.height = window.innerHeight;
    }

    class Swatter {
      constructor() {
        this.reset();
      }

      reset() {
        // Random edge spawn
        const edge = Math.floor(Math.random() * 4);
        const padding = 100;

        switch(edge) {
          case 0: // Top
            this.x = Math.random() * width;
            this.y = -padding;
            this.targetX = Math.random() * width;
            this.targetY = height + padding;
            break;
          case 1: // Right
            this.x = width + padding;
            this.y = Math.random() * height;
            this.targetX = -padding;
            this.targetY = Math.random() * height;
            break;
          case 2: // Bottom
            this.x = Math.random() * width;
            this.y = height + padding;
            this.targetX = Math.random() * width;
            this.targetY = -padding;
            break;
          case 3: // Left
            this.x = -padding;
            this.y = Math.random() * height;
            this.targetX = width + padding;
            this.targetY = Math.random() * height;
            break;
        }

        this.width = 60 + Math.random() * 40;
        this.height = 120 + Math.random() * 60;
        this.speed = (3 + Math.random() * 3) * difficulty;
        this.angle = Math.atan2(this.targetY - this.y, this.targetX - this.x);

        // Neon colors
        const colors = ['#ff006e', '#00ffff', '#39ff14', '#ffbe0b', '#8338ec', '#ff5733'];
        this.color = colors[Math.floor(Math.random() * colors.length)];

        this.warning = true;
        this.warningTimer = 60;
        this.active = false;
      }

      update() {
        if (this.warning) {
          this.warningTimer--;
          if (this.warningTimer <= 0) {
            this.warning = false;
            this.active = true;
          }
          return;
        }

        this.x += Math.cos(this.angle) * this.speed;
        this.y += Math.sin(this.angle) * this.speed;

        // Check if off screen
        if (this.x < -200 || this.x > width + 200 || this.y < -200 || this.y > height + 200) {
          this.reset();
        }
      }

      draw() {
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.angle + Math.PI / 2);

        if (this.warning) {
          // Warning indicator
          ctx.globalAlpha = 0.5 + Math.sin(Date.now() * 0.02) * 0.3;
          ctx.strokeStyle = this.color;
          ctx.lineWidth = 3;
          ctx.setLineDash([10, 10]);
          ctx.beginPath();
          ctx.rect(-this.width/2, -this.height/2, this.width, this.height);
          ctx.stroke();
          ctx.setLineDash([]);

          // Warning text
          ctx.fillStyle = this.color;
          ctx.font = 'bold 16px Space Mono';
          ctx.textAlign = 'center';
          ctx.fillText('!', 0, 5);
        } else {
          // Glow effect
          ctx.shadowColor = this.color;
          ctx.shadowBlur = 30;

          // Handle
          ctx.fillStyle = '#333';
          ctx.fillRect(-8, this.height/2 - 20, 16, 80);

          // Swatter head
          ctx.fillStyle = this.color;
          ctx.fillRect(-this.width/2, -this.height/2, this.width, this.height);

          // Grid pattern
          ctx.strokeStyle = 'rgba(0,0,0,0.5)';
          ctx.lineWidth = 2;
          for (let i = -this.width/2 + 10; i < this.width/2; i += 15) {
            ctx.beginPath();
            ctx.moveTo(i, -this.height/2);
            ctx.lineTo(i, this.height/2);
            ctx.stroke();
          }
          for (let i = -this.height/2 + 10; i < this.height/2; i += 15) {
            ctx.beginPath();
            ctx.moveTo(-this.width/2, i);
            ctx.lineTo(this.width/2, i);
            ctx.stroke();
          }

          // Border
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 3;
          ctx.strokeRect(-this.width/2, -this.height/2, this.width, this.height);
        }

        ctx.restore();
      }

      checkCollision(px, py, pr) {
        if (!this.active) return false;

        // Simple rectangle collision with rotation
        const dx = px - this.x;
        const dy = py - this.y;
        const cos = Math.cos(-this.angle - Math.PI/2);
        const sin = Math.sin(-this.angle - Math.PI/2);
        const localX = dx * cos - dy * sin;
        const localY = dx * sin + dy * cos;

        return localX > -this.width/2 - pr &&
               localX < this.width/2 + pr &&
               localY > -this.height/2 - pr &&
               localY < this.height/2 + pr;
      }
    }

    function spawnParticles(x, y, color, count = 20) {
      for (let i = 0; i < count; i++) {
        particles.push({
          x, y,
          vx: (Math.random() - 0.5) * 15,
          vy: (Math.random() - 0.5) * 15,
          size: 3 + Math.random() * 5,
          color,
          life: 1
        });
      }
    }

    function drawFly() {
      ctx.save();
      ctx.translate(fly.x, fly.y);
      ctx.rotate(fly.angle);

      // Wings
      fly.wingPhase += 0.8;
      const wingFlap = Math.sin(fly.wingPhase) * 0.5;

      ctx.fillStyle = 'rgba(200, 220, 255, 0.6)';
      ctx.shadowColor = '#00ffff';
      ctx.shadowBlur = 10;

      // Left wing
      ctx.save();
      ctx.rotate(-0.3 + wingFlap);
      ctx.beginPath();
      ctx.ellipse(-10, -5, 18, 8, -0.5, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();

      // Right wing
      ctx.save();
      ctx.rotate(0.3 - wingFlap);
      ctx.beginPath();
      ctx.ellipse(10, -5, 18, 8, 0.5, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();

      ctx.shadowBlur = 0;

      // Body
      ctx.fillStyle = '#1a1a2e';
      ctx.beginPath();
      ctx.ellipse(0, 0, 12, 18, 0, 0, Math.PI * 2);
      ctx.fill();

      // Stripes
      ctx.fillStyle = '#39ff14';
      ctx.fillRect(-8, -5, 16, 3);
      ctx.fillRect(-6, 2, 12, 2);

      // Head
      ctx.fillStyle = '#1a1a2e';
      ctx.beginPath();
      ctx.arc(0, -15, 10, 0, Math.PI * 2);
      ctx.fill();

      // Eyes
      ctx.fillStyle = '#ff006e';
      ctx.shadowColor = '#ff006e';
      ctx.shadowBlur = 10;
      ctx.beginPath();
      ctx.arc(-5, -17, 5, 0, Math.PI * 2);
      ctx.arc(5, -17, 5, 0, Math.PI * 2);
      ctx.fill();

      // Eye shine
      ctx.fillStyle = '#fff';
      ctx.shadowBlur = 0;
      ctx.beginPath();
      ctx.arc(-4, -18, 2, 0, Math.PI * 2);
      ctx.arc(6, -18, 2, 0, Math.PI * 2);
      ctx.fill();

      ctx.restore();
    }

    function updateFly() {
      // Smooth movement towards target
      const dx = fly.targetX - fly.x;
      const dy = fly.targetY - fly.y;
      fly.x += dx * 0.15;
      fly.y += dy * 0.15;

      // Calculate angle
      if (Math.abs(dx) > 1 || Math.abs(dy) > 1) {
        fly.angle = Math.atan2(dy, dx) + Math.PI / 2;
      }

      // Occasional buzz particle
      if (Math.random() < 0.1) {
        particles.push({
          x: fly.x + (Math.random() - 0.5) * 20,
          y: fly.y + (Math.random() - 0.5) * 20,
          vx: (Math.random() - 0.5) * 2,
          vy: (Math.random() - 0.5) * 2,
          size: 2,
          color: '#39ff14',
          life: 0.5
        });
      }
    }

    function updateParticles() {
      for (let i = particles.length - 1; i >= 0; i--) {
        const p = particles[i];
        p.x += p.vx;
        p.y += p.vy;
        p.vx *= 0.95;
        p.vy *= 0.95;
        p.life -= 0.02;

        if (p.life <= 0) {
          particles.splice(i, 1);
        }
      }
    }

    function drawParticles() {
      particles.forEach(p => {
        ctx.globalAlpha = p.life;
        ctx.fillStyle = p.color;
        ctx.shadowColor = p.color;
        ctx.shadowBlur = 10;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size * p.life, 0, Math.PI * 2);
        ctx.fill();
      });
      ctx.globalAlpha = 1;
      ctx.shadowBlur = 0;
    }

    function checkCollisions() {
      for (const swatter of swatters) {
        if (swatter.checkCollision(fly.x, fly.y, fly.size * 0.7)) {
          gameOver();
          return true;
        }
      }
      return false;
    }

    function gameOver() {
      gameRunning = false;
      playSplat();

      // Splat particles
      spawnParticles(fly.x, fly.y, '#39ff14', 50);
      spawnParticles(fly.x, fly.y, '#ff006e', 30);

      // Update high score
      if (score > highScore) {
        highScore = score;
        localStorage.setItem('flySimHighScore', highScore);
      }

      document.getElementById('finalScore').textContent = `Score: ${score}`;
      document.getElementById('highScore').textContent = `High Score: ${highScore}`;

      setTimeout(() => {
        document.getElementById('gameOver').style.display = 'flex';
      }, 500);
    }

    function startGame() {
      gameRunning = true;
      score = 0;
      startTime = Date.now();
      difficulty = 1;
      swatters = [];
      particles = [];

      // Spawn initial swatters
      for (let i = 0; i < 3; i++) {
        swatters.push(new Swatter());
      }

      fly.x = width / 2;
      fly.y = height / 2;
      fly.targetX = width / 2;
      fly.targetY = height / 2;

      document.getElementById('startScreen').style.display = 'none';
      document.getElementById('gameOver').style.display = 'none';

      if (!audioCtx) initAudio();

      gameLoop();
    }

    function gameLoop() {
      if (!gameRunning) return;

      // Clear
      ctx.fillStyle = '#0a0a12';
      ctx.fillRect(0, 0, width, height);

      // Background grid
      ctx.strokeStyle = 'rgba(57, 255, 20, 0.05)';
      ctx.lineWidth = 1;
      for (let x = 0; x < width; x += 50) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, height);
        ctx.stroke();
      }
      for (let y = 0; y < height; y += 50) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(width, y);
        ctx.stroke();
      }

      // Update difficulty
      const elapsed = (Date.now() - startTime) / 1000;
      difficulty = 1 + elapsed * 0.05;

      // Spawn swatters
      spawnTimer++;
      const spawnRate = Math.max(30, 120 - elapsed * 2);
      if (spawnTimer > spawnRate) {
        swatters.push(new Swatter());
        spawnTimer = 0;
      }

      // Update & draw swatters
      swatters.forEach(s => {
        s.update();
        s.draw();
      });

      // Update fly
      updateFly();

      // Check collisions
      if (checkCollisions()) {
        // Draw death particles
        updateParticles();
        drawParticles();
        requestAnimationFrame(() => {
          ctx.fillStyle = '#0a0a12';
          ctx.fillRect(0, 0, width, height);
          drawParticles();
          updateParticles();
          if (particles.length > 0) requestAnimationFrame(arguments.callee);
        });
        return;
      }

      // Draw fly
      drawFly();

      // Draw particles
      updateParticles();
      drawParticles();

      // Update score
      score = Math.floor(elapsed * 10);
      document.getElementById('score').textContent = score;
      document.getElementById('time').textContent = elapsed.toFixed(1) + 's';

      requestAnimationFrame(gameLoop);
    }

    // Event listeners
    function handleMove(x, y) {
      fly.targetX = x;
      fly.targetY = y;
    }

    canvas.addEventListener('mousemove', (e) => {
      handleMove(e.clientX, e.clientY);
    });

    canvas.addEventListener('touchmove', (e) => {
      e.preventDefault();
      const touch = e.touches[0];
      handleMove(touch.clientX, touch.clientY);
    }, { passive: false });

    canvas.addEventListener('touchstart', (e) => {
      e.preventDefault();
      const touch = e.touches[0];
      handleMove(touch.clientX, touch.clientY);
    }, { passive: false });

    document.getElementById('startBtn').addEventListener('click', startGame);
    document.getElementById('restartBtn').addEventListener('click', startGame);

    window.addEventListener('resize', resize);

    // Initialize
    resize();
    document.getElementById('highScore').textContent = `High Score: ${highScore}`;

    // Animate start screen background
    function animateStartScreen() {
      if (document.getElementById('startScreen').style.display === 'none') return;
      requestAnimationFrame(animateStartScreen);
    }
    animateStartScreen();
  </script>
<script src="/apps/sloppy-header/sloppy-bar.js"></script>
<script src="/vibelib-extended.js"></script>
<script>
  // Compatibility Patch for Legacy Apps
  window.addEventListener("load", () => {
    if (window.SloppyKarma && window.VibeLib.Economy) {
      // Redirect old calls to new engine
      window.SloppyKarma.track = window.VibeLib.Economy.track;
    }
  });
</script>
</body>
</html>
