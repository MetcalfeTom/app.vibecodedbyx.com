<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sloppy Chat</title>
    <link rel="icon" href="https://emojicdn.elk.sh/üí¨">
    <meta property="og:title" content="Sloppy Chat">
    <meta property="og:description" content="Global chatroom. Hacker markup, reactions, votes, tags ‚Äî all real-time.">
    <meta property="og:url" content="https://sloppy.live/sloppy-chat">
    <meta property="og:image" content="https://pollinations.ai/p/a%20retro%20terminal%20chat%20window%20with%20neon%20green%20and%20magenta%20text%20messages%20on%20dark%20background%20pixel%20art?width=1200&height=630&nologo=true&referrer=sloppy.live">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;700&family=JetBrains+Mono:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #08080e;
            --surface: #0e0e1a;
            --surface-hover: #16162a;
            --border: #1e1e36;
            --border-active: #34345a;
            --text: #d8d8f0;
            --text-dim: #8888b0;
            --text-muted: #4a4a6a;
            --accent: #a060f0;
            --accent-dim: #6030a0;
            --green: #40e868;
            --red: #e85050;
            --cyan: #00d8e8;
            --yellow: #e8d040;
            --display: 'Space Grotesk', sans-serif;
            --mono: 'JetBrains Mono', monospace;
        }
        *{margin:0;padding:0;box-sizing:border-box}
        body{background:var(--bg);color:var(--text);font-family:var(--mono);font-size:13px;height:100vh;display:flex;flex-direction:column;overflow:hidden}
        a{color:var(--accent);text-decoration:none}

        .chat-header{
            display:flex;align-items:center;gap:10px;padding:10px 14px;
            border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0;
        }
        .chat-header h1{font-family:var(--display);font-size:1.1rem;font-weight:500}
        .chat-header h1 span{color:var(--accent)}
        .header-stats{margin-left:auto;font-size:10px;color:var(--text-dim);display:flex;gap:12px}
        .header-stats strong{color:var(--accent)}

        .filter-bar{
            display:none;align-items:center;gap:8px;padding:6px 14px;
            background:rgba(160,96,240,0.06);border-bottom:1px solid var(--border);font-size:11px;flex-shrink:0;
        }
        .filter-bar.active{display:flex}
        .filter-bar .tag{color:var(--accent);font-weight:500}
        .filter-bar button{background:none;border:1px solid var(--border);color:var(--text-muted);font-family:var(--mono);font-size:10px;padding:2px 8px;border-radius:3px;cursor:pointer}
        .filter-bar button:hover{color:var(--text);border-color:var(--border-active)}

        .messages{flex:1;overflow-y:auto;padding:8px 10px;display:flex;flex-direction:column-reverse;gap:2px}
        .messages::-webkit-scrollbar{width:6px}
        .messages::-webkit-scrollbar-track{background:var(--bg)}
        .messages::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

        .msg{display:flex;gap:8px;padding:6px 8px;border-radius:6px;transition:background 0.12s;align-items:flex-start}
        .msg:hover{background:var(--surface-hover)}
        .msg.own{flex-direction:row-reverse}
        .msg.own .msg-bubble{border-color:var(--accent-dim);background:rgba(160,96,240,0.05)}
        .msg-avatar{width:28px;height:28px;border-radius:50%;background:var(--surface);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;overflow:hidden}
        .msg-avatar img{width:100%;height:100%;object-fit:cover}
        .msg-bubble{flex:1;min-width:0;border:1px solid var(--border);border-radius:6px;padding:6px 10px;max-width:85%}
        .msg-head{display:flex;align-items:center;gap:6px;font-size:11px;margin-bottom:2px}
        .msg-user{font-weight:500;color:var(--text);cursor:pointer}
        .msg-user:hover{color:var(--accent)}
        .msg-time{color:var(--text-muted);font-size:9px;margin-left:auto}
        .msg-del{background:none;border:none;color:var(--text-muted);font-size:9px;cursor:pointer;font-family:var(--mono)}
        .msg-del:hover{color:var(--red)}
        .msg-content{font-size:12px;line-height:1.5;word-break:break-word;color:var(--text)}
        .msg-content img{max-width:100%;max-height:300px;border-radius:4px;margin-top:4px;display:block;cursor:pointer}
        .msg-footer{display:flex;align-items:center;gap:4px;margin-top:4px;flex-wrap:wrap}

        /* Votes */
        .msg-votes{display:flex;align-items:center;gap:2px}
        .mv-btn{background:none;border:1px solid transparent;color:var(--text-muted);font-size:9px;padding:1px 4px;cursor:pointer;border-radius:2px;font-family:var(--mono)}
        .mv-btn:hover{background:var(--surface-hover);color:var(--text)}
        .mv-btn.up.active{color:var(--green);border-color:var(--green)}
        .mv-btn.down.active{color:var(--red);border-color:var(--red)}
        .mv-score{font-size:10px;font-weight:700;min-width:16px;text-align:center}
        .mv-score.pos{color:var(--green)}.mv-score.neg{color:var(--red)}.mv-score.zero{color:var(--text-muted)}

        /* Reactions */
        .msg-reactions{display:flex;flex-wrap:wrap;gap:3px;margin-top:3px}
        .rx-pill{display:flex;align-items:center;gap:2px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:1px 6px;font-size:11px;cursor:pointer;transition:all 0.1s}
        .rx-pill:hover{border-color:var(--border-active)}
        .rx-pill.mine{border-color:var(--accent-dim);background:rgba(160,96,240,0.08)}
        .rx-pill .ct{font-size:9px;color:var(--text-dim)}
        .rx-add{background:none;border:1px dashed var(--border);border-radius:10px;padding:1px 6px;font-size:10px;color:var(--text-muted);cursor:pointer;position:relative}
        .rx-add:hover{border-color:var(--border-active)}
        .rx-picker{display:none;position:absolute;bottom:24px;left:0;background:var(--surface);border:1px solid var(--border-active);border-radius:6px;padding:4px;gap:2px;z-index:30;flex-wrap:wrap;width:170px}
        .rx-picker.open{display:flex}
        .rx-picker button{background:none;border:none;font-size:16px;cursor:pointer;padding:3px;border-radius:3px}
        .rx-picker button:hover{background:var(--surface-hover)}

        /* Tags in messages */
        .chat-tag{color:var(--cyan);cursor:pointer;font-weight:500}
        .chat-tag:hover{text-decoration:underline}
        .chat-mention{color:var(--yellow);cursor:pointer;font-weight:500}
        .chat-mention.self{animation:selfPulse 2s ease-in-out infinite;background:rgba(232,208,64,0.1);padding:0 2px;border-radius:2px}
        @keyframes selfPulse{0%,100%{opacity:1}50%{opacity:0.6}}

        /* Hacker markup */
        .hm-shake{animation:hmShake 0.3s infinite}
        @keyframes hmShake{0%,100%{transform:translateX(0)}25%{transform:translateX(-2px)}75%{transform:translateX(2px)}}
        .hm-rainbow{animation:hmRainbow 2s linear infinite;background-size:200%}
        @keyframes hmRainbow{0%{color:#ff0000}17%{color:#ff8800}33%{color:#ffff00}50%{color:#00ff00}67%{color:#0088ff}83%{color:#8800ff}100%{color:#ff0000}}
        .hm-glitch{animation:hmGlitch 0.5s infinite;position:relative}
        @keyframes hmGlitch{0%{transform:none;opacity:1}20%{transform:skewX(-5deg);opacity:0.8}40%{transform:skewX(3deg);opacity:1}60%{transform:translateX(-2px);opacity:0.9}80%{transform:translateX(2px)}100%{transform:none;opacity:1}}
        .hm-pulse{animation:hmPulse 1.5s ease-in-out infinite}
        @keyframes hmPulse{0%,100%{opacity:1}50%{opacity:0.3}}
        .hm-neon{text-shadow:0 0 5px currentColor,0 0 10px currentColor;color:var(--cyan)}
        .hm-fire{color:#ff6600;text-shadow:0 0 4px #ff3300,0 0 8px #ff6600}
        .hm-ice{color:#88ccff;text-shadow:0 0 4px #4488ff}
        .hm-bounce{display:inline-block;animation:hmBounce 0.6s ease-in-out infinite}
        @keyframes hmBounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}
        .hm-wave span{display:inline-block;animation:hmWave 1s ease-in-out infinite}
        @keyframes hmWave{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}
        .hm-spoiler{background:var(--text-muted);color:transparent;cursor:pointer;border-radius:2px;padding:0 3px;transition:all 0.3s}
        .hm-spoiler.revealed{background:transparent;color:var(--text)}

        /* Input area */
        .input-area{
            flex-shrink:0;border-top:1px solid var(--border);background:var(--surface);padding:8px 10px;
            display:flex;gap:6px;align-items:flex-end;
        }
        .input-area textarea{
            flex:1;background:var(--bg);border:1px solid var(--border);border-radius:6px;
            color:var(--text);font-family:var(--mono);font-size:12px;padding:8px 10px;
            outline:none;resize:none;min-height:36px;max-height:120px;line-height:1.4;
        }
        .input-area textarea:focus{border-color:var(--accent-dim)}
        .input-area textarea::placeholder{color:var(--text-muted)}
        .send-btn{
            background:var(--accent-dim);border:none;color:#fff;font-family:var(--mono);
            font-size:11px;padding:8px 14px;border-radius:6px;cursor:pointer;font-weight:700;flex-shrink:0;
        }
        .send-btn:hover{background:var(--accent)}

        .markup-hint{
            flex-shrink:0;padding:2px 10px 6px;background:var(--surface);font-size:9px;color:var(--text-muted);
            display:none;
        }
        .markup-hint.visible{display:block}

        .backlink{text-align:center;padding:6px;font-size:10px;flex-shrink:0;background:var(--surface);border-top:1px solid var(--border)}

        .toast{
            position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);
            background:var(--surface);border:1px solid var(--accent-dim);color:var(--text);
            font-family:var(--mono);font-size:11px;padding:8px 18px;border-radius:6px;
            z-index:200;opacity:0;transition:all 0.3s;pointer-events:none;
        }
        .toast.visible{opacity:1;transform:translateX(-50%) translateY(0)}

        .load-older{
            text-align:center;padding:8px;
        }
        .load-older button{
            background:none;border:1px solid var(--border);color:var(--text-dim);
            font-family:var(--mono);font-size:10px;padding:5px 16px;border-radius:3px;cursor:pointer;
        }
        .load-older button:hover{border-color:var(--accent-dim);color:var(--accent)}

        @media(max-width:600px){
            .chat-header h1{font-size:0.95rem}
            .msg-bubble{max-width:92%}
            .header-stats{gap:8px}
        }
    </style>
</head>
<body>
    <div class="chat-header">
        <h1>Sloppy <span>Chat</span></h1>
        <div class="header-stats">
            <span><strong id="sCount">0</strong> msgs</span>
            <span><strong id="sOnline">1</strong> online</span>
        </div>
    </div>

    <div class="filter-bar" id="filterBar">
        <span>Filtering:</span>
        <span class="tag" id="filterLabel"></span>
        <button onclick="clearFilter()">clear ‚úï</button>
    </div>

    <div class="messages" id="messagesContainer"></div>

    <div class="load-older" id="loadOlder" style="display:none">
        <button onclick="loadMore()">Load older messages</button>
    </div>

    <div class="markup-hint" id="markupHint">
        Markup: [shake] [rainbow] [glitch] [pulse] [neon] [fire] [ice] [bounce] [wave] [spoiler] ‚Äî Tags: #tag ‚Äî Mentions: @user
    </div>

    <div class="input-area">
        <textarea id="msgInput" rows="1" placeholder="Type a message..." onkeydown="handleKey(event)" oninput="autoResize(this)" onfocus="showHint()" onblur="hideHint()"></textarea>
        <button class="send-btn" onclick="sendMessage()">Send</button>
    </div>

    <div class="backlink"><a href="https://sloppy.live">‚Üê sloppy.live</a></div>

    <div class="toast" id="toast"></div>

    <script src="/sloppy-header/sloppy-bar.js" data-position="bottom" data-minimized="true"></script>
    <script type="module">
        import { createBrowserClient } from "https://cdn.jsdelivr.net/npm/@supabase/ssr@0.7.0/+esm";

        const supabase = createBrowserClient(
            'https://yjyxteqzhhmtrgcaekgz.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM8IS32IUYR2eenCCjdDdioiBU',
            { cookieOptions: { name: 'sb-auth-token', domain: location.hostname.includes('sloppy.live') ? '.sloppy.live' : location.hostname, path: '/', sameSite: 'lax' } }
        );

        const PAGE_SIZE = 30;
        const REACTION_EMOJIS = ['üòÇ','üî•','‚ù§Ô∏è','üòÆ','üò¢','üëè','üôå','üíÄ'];
        const MAX_MSG_LEN = 2000;

        let currentUser = null;
        let profile = { username: 'Anonymous', avatar: 'üë§', avatarUrl: null };
        let messages = [];
        let seenIds = new Set();
        let messageVotes = {};
        let myVotes = {};
        let messageReactions = {};
        let myReactions = {};
        let page = 0;
        let hasMore = true;
        let loading = false;
        let activeFilter = null;
        let channel = null;

        const rateLimits = {};
        function checkRate(a, max, win) {
            const now = Date.now();
            if (!rateLimits[a]) rateLimits[a] = [];
            rateLimits[a] = rateLimits[a].filter(t => now - t < win);
            if (rateLimits[a].length >= max) return false;
            rateLimits[a].push(now);
            return true;
        }

        function escapeHtml(s) { return s ? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;') : ''; }
        function escapeAttr(s) { return escapeHtml(s); }
        function sanitize(s, max = MAX_MSG_LEN) {
            if (!s) return '';
            let t = s.trim().slice(0, max);
            if (/<script|javascript:|on\w+\s*=/i.test(t)) return '';
            return t;
        }
        function timeStr(d) { return new Date(d).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.classList.add('visible');
            setTimeout(() => t.classList.remove('visible'), 2200);
        }

        // --- Hacker Markup ---
        function parseMarkup(text) {
            let s = escapeHtml(text);
            // Tags
            const tags = [
                ['shake', 'hm-shake'], ['rainbow', 'hm-rainbow'], ['glitch', 'hm-glitch'],
                ['pulse', 'hm-pulse'], ['neon', 'hm-neon'], ['fire', 'hm-fire'],
                ['ice', 'hm-ice'], ['bounce', 'hm-bounce']
            ];
            tags.forEach(([tag, cls]) => {
                const re = new RegExp(`\\[${tag}\\](.*?)\\[\\/${tag}\\]`, 'gi');
                s = s.replace(re, `<span class="${cls}">$1</span>`);
            });
            // Wave (character-by-character, max 100 chars)
            s = s.replace(/\[wave\]([\s\S]{1,100}?)\[\/wave\]/gi, (_, inner) => {
                return '<span class="hm-wave">' + [...inner].map((c, i) =>
                    `<span style="animation-delay:${i * 0.05}s">${c}</span>`
                ).join('') + '</span>';
            });
            // Spoiler
            s = s.replace(/\[spoiler\](.*?)\[\/spoiler\]/gi,
                '<span class="hm-spoiler" onclick="this.classList.toggle(\'revealed\')">$1</span>');
            // #tags
            s = s.replace(/#(\w+(?:\/\w+)?)/g, (m, tag) =>
                `<span class="chat-tag" onclick="filterByTag('${escapeAttr(tag)}')">${m}</span>`);
            // @mentions
            s = s.replace(/@(\w+)/g, (m, user) => {
                const isSelf = user.toLowerCase() === profile.username.toLowerCase();
                return `<span class="chat-mention${isSelf ? ' self' : ''}">${m}</span>`;
            });
            return s;
        }

        // --- Auth ---
        async function initAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            let s = session;
            if (!s) { const { data } = await supabase.auth.signInAnonymously(); s = data?.session; }
            if (s?.user) {
                currentUser = s.user;
                const { data: prof } = await supabase.from('sloppygram_profiles')
                    .select('username, avatar, avatar_url').eq('user_id', currentUser.id).single();
                if (prof) {
                    profile.username = prof.username || 'Anonymous';
                    profile.avatar = prof.avatar || 'üë§';
                    profile.avatarUrl = prof.avatar_url || null;
                }
            }
        }

        // --- Load Messages ---
        async function loadMessages(older = false) {
            if (loading) return;
            loading = true;
            const from = older ? page * PAGE_SIZE : 0;
            const to = from + PAGE_SIZE - 1;

            const { data, error } = await supabase.from('sloppygram_messages')
                .select('id, username, avatar, avatar_url, content, image_data, drawing_data, message_type, user_id, created_at')
                .order('created_at', { ascending: false })
                .range(from, to);

            if (error) { console.error(error); loading = false; return; }
            const newMsgs = (data || []).filter(m => !seenIds.has(m.id));
            newMsgs.forEach(m => seenIds.add(m.id));

            if (older) {
                messages.push(...newMsgs);
            } else {
                messages = newMsgs;
            }

            hasMore = (data || []).length === PAGE_SIZE;
            if (older) page++;
            else page = 1;

            // Load votes + reactions in parallel
            const ids = newMsgs.map(m => m.id);
            if (ids.length) {
                const [votesR, reactR] = await Promise.all([
                    supabase.from('sloppygram_message_votes').select('message_id, voter_username, vote_type').in('message_id', ids),
                    supabase.from('sloppygram_message_reactions').select('message_id, emoji, username').in('message_id', ids)
                ]);
                (votesR.data || []).forEach(v => {
                    messageVotes[v.message_id] = (messageVotes[v.message_id] || 0) + (v.vote_type || 0);
                    if (v.voter_username === profile.username) myVotes[v.message_id] = v.vote_type;
                });
                (reactR.data || []).forEach(r => {
                    if (!messageReactions[r.message_id]) messageReactions[r.message_id] = {};
                    messageReactions[r.message_id][r.emoji] = (messageReactions[r.message_id][r.emoji] || 0) + 1;
                    if (r.username === profile.username) {
                        if (!myReactions[r.message_id]) myReactions[r.message_id] = new Set();
                        myReactions[r.message_id].add(r.emoji);
                    }
                });
            }

            loading = false;
            document.getElementById('sCount').textContent = messages.length;
            document.getElementById('loadOlder').style.display = hasMore ? '' : 'none';
            renderMessages();
        }

        window.loadMore = function() { loadMessages(true); };

        // --- Render ---
        function renderMessages() {
            const container = document.getElementById('messagesContainer');
            let filtered = messages;
            if (activeFilter) {
                if (activeFilter.type === 'tag') {
                    const tagLower = activeFilter.value.toLowerCase();
                    filtered = messages.filter(m => m.content && m.content.toLowerCase().includes('#' + tagLower));
                } else if (activeFilter.type === 'mention') {
                    const mentionLower = activeFilter.value.toLowerCase();
                    filtered = messages.filter(m => m.content && m.content.toLowerCase().includes('@' + mentionLower));
                }
            }

            if (filtered.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted)">No messages yet. Say something!</div>';
                return;
            }

            container.innerHTML = filtered.map(m => renderMsg(m)).join('');
        }

        function renderMsg(m) {
            const isOwn = currentUser && m.user_id === currentUser.id;
            const myV = myVotes[m.id] || 0;
            const score = messageVotes[m.id] || 0;
            const reactions = messageReactions[m.id] || {};
            const myR = myReactions[m.id] || new Set();
            const avatarHtml = m.avatar_url
                ? `<img src="${escapeHtml(m.avatar_url)}" alt="" loading="lazy">`
                : (m.avatar || 'üë§');

            // Content
            let contentHtml = '';
            if (m.content) contentHtml = parseMarkup(m.content);
            if (m.image_data) contentHtml += `<img src="${escapeHtml(m.image_data)}" alt="" loading="lazy" onerror="this.style.display='none'">`;
            if (m.drawing_data) contentHtml += `<img src="${escapeHtml(m.drawing_data)}" alt="" loading="lazy" onerror="this.style.display='none'">`;

            // Reactions HTML
            let rxHtml = '';
            for (const [emoji, count] of Object.entries(reactions)) {
                const mine = myR.has(emoji) ? ' mine' : '';
                rxHtml += `<span class="rx-pill${mine}" onclick="toggleReaction(${m.id},'${emoji}')">${emoji}<span class="ct">${count}</span></span>`;
            }

            const scoreClass = score > 0 ? 'pos' : score < 0 ? 'neg' : 'zero';

            return `<div class="msg${isOwn ? ' own' : ''}" data-id="${m.id}">
                <div class="msg-avatar">${avatarHtml}</div>
                <div class="msg-bubble">
                    <div class="msg-head">
                        <span class="msg-user">${escapeHtml(m.username || 'Anonymous')}</span>
                        <span class="msg-time">${timeStr(m.created_at)}</span>
                        ${isOwn ? `<button class="msg-del" onclick="deleteMsg(${m.id})">del</button>` : ''}
                    </div>
                    <div class="msg-content">${contentHtml}</div>
                    <div class="msg-footer">
                        <div class="msg-votes">
                            <button class="mv-btn up${myV===1?' active':''}" onclick="voteMsg(${m.id},1,${isOwn})">‚ñ≤</button>
                            <span class="mv-score ${scoreClass}">${score}</span>
                            <button class="mv-btn down${myV===-1?' active':''}" onclick="voteMsg(${m.id},-1,${isOwn})">‚ñº</button>
                        </div>
                        <div class="msg-reactions">
                            ${rxHtml}
                            <span class="rx-add" onclick="togglePicker(${m.id})">+
                                <div class="rx-picker" id="picker-${m.id}">
                                    ${REACTION_EMOJIS.map(e => `<button onclick="event.stopPropagation();toggleReaction(${m.id},'${e}')">${e}</button>`).join('')}
                                </div>
                            </span>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        // --- Send ---
        window.sendMessage = async function() {
            if (!currentUser) { showToast('Sign in to chat'); return; }
            if (!checkRate('msg', 10, 60000)) { showToast('Slow down'); return; }

            const input = document.getElementById('msgInput');
            const raw = input.value.trim();
            if (!raw) return;

            const content = sanitize(raw);
            if (!content) { showToast('Invalid content'); return; }

            const msg = {
                username: profile.username,
                avatar: profile.avatar,
                avatar_url: profile.avatarUrl || null,
                content,
                message_type: 'text',
                user_id: currentUser.id
            };

            const { data, error } = await supabase.from('sloppygram_messages').insert(msg).select().single();
            if (error) { showToast('Failed to send'); console.error(error); return; }

            // Extract and persist tags
            const tagMatches = content.match(/#(\w+(?:\/\w+)?)/g);
            if (tagMatches && tagMatches.length > 0) {
                const tagInserts = tagMatches.slice(0, 20).map(t => {
                    const full = t.slice(1);
                    const parts = full.split('/');
                    return {
                        message_id: data.id,
                        tag: parts.length > 1 ? parts.slice(1).join('/') : parts[0],
                        parent_tag: parts.length > 1 ? parts[0] : null,
                        user_id: currentUser.id
                    };
                });
                await supabase.from('sloppygram_message_tags').insert(tagInserts);
            }

            // Extract and persist mentions
            const mentionMatches = content.match(/@(\w+)/g);
            if (mentionMatches && mentionMatches.length > 0) {
                const mentionInserts = mentionMatches
                    .map(m => m.slice(1))
                    .filter(u => u.toLowerCase() !== profile.username.toLowerCase())
                    .slice(0, 10)
                    .map(u => ({
                        mentioned_username: u,
                        source_type: 'message',
                        source_id: String(data.id),
                        source_username: profile.username,
                        seen: false,
                        user_id: currentUser.id
                    }));
                if (mentionInserts.length) await supabase.from('sloppygram_mentions').insert(mentionInserts);
            }

            // Add locally
            if (!seenIds.has(data.id)) {
                seenIds.add(data.id);
                messages.unshift({ ...msg, id: data.id, created_at: new Date().toISOString() });
                document.getElementById('sCount').textContent = messages.length;
                renderMessages();
            }

            input.value = '';
            autoResize(input);
        };

        window.handleKey = function(e) {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        };
        window.autoResize = function(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 120) + 'px';
        };
        window.showHint = function() { document.getElementById('markupHint').classList.add('visible'); };
        window.hideHint = function() { setTimeout(() => document.getElementById('markupHint').classList.remove('visible'), 200); };

        // --- Vote ---
        window.voteMsg = async function(msgId, dir, isOwn) {
            if (!currentUser || isOwn) return;
            if (!checkRate('vote', 30, 60000)) { showToast('Slow down on votes'); return; }

            const current = myVotes[msgId] || 0;
            if (current === dir) {
                await supabase.from('sloppygram_message_votes').delete().eq('message_id', msgId).eq('user_id', currentUser.id);
                myVotes[msgId] = 0;
                messageVotes[msgId] = (messageVotes[msgId] || 0) - dir;
            } else {
                if (current !== 0) {
                    await supabase.from('sloppygram_message_votes').delete().eq('message_id', msgId).eq('user_id', currentUser.id);
                    messageVotes[msgId] = (messageVotes[msgId] || 0) - current;
                }
                await supabase.from('sloppygram_message_votes').insert({
                    message_id: msgId, voter_username: profile.username, vote_type: dir, user_id: currentUser.id
                });
                myVotes[msgId] = dir;
                messageVotes[msgId] = (messageVotes[msgId] || 0) + dir;
            }
            renderMessages();
        };

        // --- Reactions ---
        window.toggleReaction = async function(msgId, emoji) {
            if (!currentUser) return;
            if (!checkRate('react', 20, 60000)) return;
            const picker = document.getElementById(`picker-${msgId}`);
            if (picker) picker.classList.remove('open');

            const mine = myReactions[msgId] && myReactions[msgId].has(emoji);
            if (mine) {
                await supabase.from('sloppygram_message_reactions').delete().eq('message_id', msgId).eq('emoji', emoji).eq('user_id', currentUser.id);
                if (myReactions[msgId]) myReactions[msgId].delete(emoji);
                if (messageReactions[msgId]?.[emoji]) {
                    messageReactions[msgId][emoji]--;
                    if (messageReactions[msgId][emoji] <= 0) delete messageReactions[msgId][emoji];
                }
            } else {
                await supabase.from('sloppygram_message_reactions').insert({ message_id: msgId, emoji, username: profile.username, user_id: currentUser.id });
                if (!myReactions[msgId]) myReactions[msgId] = new Set();
                myReactions[msgId].add(emoji);
                if (!messageReactions[msgId]) messageReactions[msgId] = {};
                messageReactions[msgId][emoji] = (messageReactions[msgId][emoji] || 0) + 1;
            }
            renderMessages();
        };

        window.togglePicker = function(msgId) {
            const picker = document.getElementById(`picker-${msgId}`);
            if (picker) picker.classList.toggle('open');
        };

        // --- Delete ---
        window.deleteMsg = async function(msgId) {
            if (!currentUser || !confirm('Delete this message?')) return;
            const { error } = await supabase.from('sloppygram_messages').delete().eq('id', msgId).eq('user_id', currentUser.id);
            if (error) { showToast('Could not delete'); return; }
            messages = messages.filter(m => m.id !== msgId);
            seenIds.delete(msgId);
            delete messageVotes[msgId];
            delete messageReactions[msgId];
            renderMessages();
        };

        // --- Filter ---
        window.filterByTag = function(tag) {
            activeFilter = { type: 'tag', value: tag };
            document.getElementById('filterLabel').textContent = '#' + tag;
            document.getElementById('filterBar').classList.add('active');
            renderMessages();
        };
        window.clearFilter = function() {
            activeFilter = null;
            document.getElementById('filterBar').classList.remove('active');
            renderMessages();
        };

        // --- Real-time ---
        function subscribeRealtime() {
            channel = supabase.channel('sloppy-chat-rt');

            // Broadcast for instant delivery
            channel.on('broadcast', { event: 'new_message' }, payload => {
                const m = payload.payload;
                if (m && !seenIds.has(m.id)) {
                    seenIds.add(m.id);
                    messages.unshift(m);
                    document.getElementById('sCount').textContent = messages.length;
                    renderMessages();
                }
            });

            // Postgres changes fallback
            channel.on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'sloppygram_messages' }, payload => {
                const m = payload.new;
                if (!seenIds.has(m.id)) {
                    seenIds.add(m.id);
                    messages.unshift(m);
                    document.getElementById('sCount').textContent = messages.length;
                    renderMessages();
                }
            });

            channel.on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'sloppygram_messages' }, payload => {
                const id = payload.old?.id;
                if (id) {
                    messages = messages.filter(m => m.id !== id);
                    seenIds.delete(id);
                    renderMessages();
                }
            });

            // Presence
            channel.on('presence', { event: 'sync' }, () => {
                const count = Object.keys(channel.presenceState()).length;
                document.getElementById('sOnline').textContent = Math.max(1, count);
            });

            channel.subscribe(async (status) => {
                if (status === 'SUBSCRIBED') {
                    await channel.track({ user: profile.username });
                }
            });
        }

        // --- Init ---
        async function init() {
            await initAuth();
            await loadMessages();
            subscribeRealtime();
        }

        init().catch(err => {
            console.error('Init error:', err);
            document.getElementById('messagesContainer').innerHTML =
                '<div style="text-align:center;padding:40px;color:var(--text-muted)">Failed to load. Refresh to try again.</div>';
        });

        // Close pickers on outside click
        document.addEventListener('click', e => {
            if (!e.target.closest('.rx-add')) {
                document.querySelectorAll('.rx-picker.open').forEach(p => p.classList.remove('open'));
            }
        });
    </script>
</body>
</html>