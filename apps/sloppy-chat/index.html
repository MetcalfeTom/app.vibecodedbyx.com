<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sloppy Chat</title>
  <script src="/vibelib.js"></script>
  <script src="/vibelib-extended.js"></script>
  <script src="/apps/sloppy-header/sloppy-bar.js"></script>
  <script src="../app-data.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #1a1a2e;
      color: #e0e0e0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    #chat-header {
      padding: 10px 15px;
      background-color: #16213e;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    #chat-title {
      font-weight: bold;
      color: #00ff88;
    }

    #pop-out-btn {
      background: none;
      border: 1px solid #00ff88;
      color: #00ff88;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 12px;
      border-radius: 4px;
    }

    #pop-out-btn:hover {
      background: rgba(0, 255, 136, 0.1);
    }

    #messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .message {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-color: #333;
      overflow: hidden;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .message-content {
      background-color: #2a2a3e;
      padding: 8px 12px;
      border-radius: 8px;
      max-width: 80%;
      word-wrap: break-word;
    }

    .message.own .message-content {
      background-color: #0f3460;
      border: 1px solid #00ff88;
    }

    .username {
      font-size: 12px;
      color: #888;
      margin-bottom: 2px;
      display: block;
      font-weight: bold;
    }

    .text {
      font-size: 14px;
      line-height: 1.4;
    }

    .app-link {
      display: inline-block;
      margin-top: 5px;
      padding: 6px 12px;
      background: rgba(0, 255, 136, 0.1);
      border: 1px solid #00ff88;
      color: #00ff88;
      border-radius: 4px;
      cursor: pointer;
      font-family: inherit;
      font-size: 12px;
      text-transform: uppercase;
      font-weight: bold;
      transition: all 0.2s;
    }

    .app-link:hover {
      background: #00ff88;
      color: #000;
    }

    .user-badge {
      display: inline-block;
      margin-left: 4px;
      font-size: 14px;
    }

    #input-area {
      padding: 15px;
      background-color: #16213e;
      border-top: 1px solid #333;
      flex-shrink: 0;
    }

    #chat-form {
      display: flex;
      gap: 10px;
    }

    #message-input {
      flex: 1;
      background-color: #0f3460;
      border: 1px solid #333;
      color: #e0e0e0;
      padding: 10px;
      border-radius: 4px;
      resize: none;
      height: 40px; /* Initial height */
      font-family: inherit;
    }

    #message-input:focus {
      outline: none;
      border-color: #00ff88;
    }

    #send-btn {
      background-color: #00ff88;
      color: #000;
      border: none;
      padding: 0 20px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }

    #send-btn:hover {
      background-color: #00cc6a;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #1a1a2e;
    }
    ::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

  </style>
</head>
<body>

  <div id="chat-header">
    <span id="chat-title">Global Chat</span>
    <button id="pop-out-btn" onclick="window.open(window.location.href, '_blank')">Pop Out â†—</button>
  </div>

  <div id="messages">
    <!-- Messages will be injected here -->
    <div style="text-align: center; color: #555; margin-top: 20px;">Welcome to the new Universal Chat.</div>
  </div>

  <div id="input-area">
    <form id="chat-form">
      <textarea id="message-input" placeholder="Type a message..." rows="1"></textarea>
      <button type="submit" id="send-btn">Send</button>
    </form>
  </div>

  <script>
    const messagesContainer = document.getElementById('messages');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');

    let currentUser = null;
    let profile = null;

    // Handle Pop Out button visibility (hide if already standalone)
    if (window.self === window.top) {
      document.getElementById('pop-out-btn').style.display = 'none';
    }

    async function initChat() {
      // 1. Wait for VibeLib
      if (!window.VibeLib || !window.supabase) {
        setTimeout(initChat, 100);
        return;
      }

      // 2. Get User
      try {
        const { data: { user } } = await window.supabase.auth.getUser();
        currentUser = user;

        if (currentUser) {
           profile = await window.VibeLib.Identity.get(currentUser.id);
        } else {
           // Anon fallback
           profile = { username: 'Guest', avatar: 'ðŸ‘¤' };
        }
      } catch (e) {
        console.error("Error fetching identity:", e);
        profile = { username: 'Guest', avatar: 'ðŸ‘¤' };
      }

      // 3. Load Recent Messages
      loadRecentMessages();

      // 4. Subscribe to Realtime
      subscribeToChat();
    }

    async function loadRecentMessages() {
      const { data, error } = await window.supabase
        .from('universal_chat')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(50);

      if (error) {
        console.error('Error loading messages:', error);
        return;
      }

      // Clear initial welcome message if we have data
      if (data && data.length > 0) {
        messagesContainer.innerHTML = '';
        // Reverse to show oldest first at top
        data.reverse().forEach(msg => displayMessage(msg));
        scrollToBottom();
      }
    }

    function subscribeToChat() {
      const channel = window.supabase
        .channel('public:universal_chat')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'universal_chat' }, payload => {
          displayMessage(payload.new);
          scrollToBottom();
        })
        .subscribe();
    }

    // Cache user profiles to avoid repeated fetches
    const profileCache = {};

    async function getProfile(userId) {
      if (profileCache[userId]) return profileCache[userId];

      // Default
      let p = { username: 'Anon', avatar: 'ðŸ‘¤', inventory: [] };

      try {
        if (window.VibeLib && window.VibeLib.Identity) {
           const data = await window.VibeLib.Identity.get(userId);
           if (data) {
             p = { ...p, ...data };
           }
        }
        // Fetch economy balances for inventory
        if (window.supabase) {
          const { data: balance } = await window.supabase
            .from('economy_balances')
            .select('inventory')
            .eq('user_id', userId)
            .single();
          if (balance && balance.inventory) {
             p.inventory = balance.inventory;
          }
        }
      } catch (e) {
        // ignore error, use default
      }

      profileCache[userId] = p;
      return p;
    }

    async function displayMessage(msg) {
      const div = document.createElement('div');
      div.className = 'message';
      if (currentUser && msg.user_id === currentUser.id) {
        div.classList.add('own');
      }

      // Initial render (will be updated)
      div.innerHTML = `
        <div class="avatar">...</div>
        <div class="message-content">
          <span class="username">...</span>
          <span class="text">${escapeHtml(msg.content)}</span>
        </div>
      `;
      messagesContainer.appendChild(div);

      // Fetch profile details
      const p = await getProfile(msg.user_id);

      // Update with real data
      const avatarHtml = p.avatar && p.avatar.startsWith('http')
        ? `<img src="${p.avatar}" alt="${p.username}">`
        : (p.avatar || 'ðŸ‘¤');

      div.querySelector('.avatar').innerHTML = avatarHtml;

      // Render Username with Inventory Flex
      const usernameEl = div.querySelector('.username');
      usernameEl.textContent = p.username || 'Anon';

      if (p.inventory && Array.isArray(p.inventory)) {
        // Name Color
        const colorItem = p.inventory.find(i => i.type === 'name_color');
        if (colorItem && colorItem.value) {
          usernameEl.style.color = colorItem.value;
        }
        // Badges
        p.inventory.filter(i => i.type === 'badge').forEach(badge => {
          const span = document.createElement('span');
          span.className = 'user-badge';
          span.textContent = badge.icon || 'ðŸ…';
          span.title = badge.name || 'Badge';
          usernameEl.appendChild(span);
        });
      }

      // App Links parsing
      const textEl = div.querySelector('.text');
      const rawText = escapeHtml(msg.content);
      textEl.innerHTML = parseAppLinks(rawText);
    }

    function parseAppLinks(text) {
      if (!window.AppData || !window.AppData.apps) return text;

      // Regex to find potential app names (alphanumeric with hyphens)
      // We look for full words that match an app name
      return text.replace(/\b([a-zA-Z0-9-]+)\b/g, (match) => {
        if (window.AppData.apps.includes(match)) {
          return `<button class="app-link" onclick="launchApp('${match}')">Launch ${match}</button>`;
        }
        return match;
      });
    }

    window.launchApp = function(appName) {
      window.parent.postMessage({
        type: 'OPEN_WINDOW',
        url: `/apps/${appName}/index.html`,
        title: appName
      }, '*');
    };

    function escapeHtml(text) {
      if (!text) return '';
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function scrollToBottom() {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Handle Input
    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = messageInput.value.trim();
      if (!text) return;

      if (!currentUser) {
        alert('Please sign in via sloppy-id to chat.');
        return;
      }

      // Clear input immediately
      messageInput.value = '';

      // 1. Reward (VibeLib Economy)
      if (window.VibeLib && window.VibeLib.Economy) {
        window.VibeLib.Economy.track('participation', 1, 'Chat Message');
      }

      // 2. Send to DB
      const { error } = await window.supabase
        .from('universal_chat')
        .insert({
          user_id: currentUser.id,
          content: text,
          channel: 'global'
        });

      if (error) {
        console.error('Error sending message:', error);
        alert('Failed to send message.');
      }
    });

    // Submit on Enter (without Shift)
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        chatForm.dispatchEvent(new Event('submit'));
      }
    });

    // Start
    initChat();

  </script>
</body>
</html>
