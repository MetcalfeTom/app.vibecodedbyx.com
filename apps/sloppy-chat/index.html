<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sloppy Chat</title>
  <script src="/vibelib-extended.js"></script>
  <script src="/sloppy-header/sloppy-bar.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { margin: 0; background: #0a0a10; color: #e0e0e0; font-family: 'JetBrains Mono', monospace; display: flex; flex-direction: column; height: 100vh; }
    #chat-container { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
    .msg { padding: 8px 12px; background: #1a1a2e; border-radius: 6px; border-left: 3px solid #333; word-break: break-word; }
    .msg-header { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; margin-bottom: 4px; color: #888; }
    .msg-author { font-weight: bold; color: #aaa; }

    /* Flex Styles */
    .msg-author.gold-crown { color: #ffd700; text-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
    .msg-author.gold-crown::before { content: 'ðŸ‘‘ '; }
    .msg-author.blue-neon { color: #00ffff; text-shadow: 0 0 5px rgba(0, 255, 255, 0.5); }

    .msg-content { font-size: 0.95rem; line-height: 1.4; }

    .launch-btn {
        display: inline-block;
        margin-top: 5px;
        padding: 4px 10px;
        background: #00ff88;
        color: #000;
        text-decoration: none;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: bold;
        cursor: pointer;
    }

    #input-area { padding: 10px; background: #111; display: flex; gap: 10px; border-top: 1px solid #333; }
    #msg-input { flex: 1; padding: 10px; background: #222; border: 1px solid #444; color: #fff; border-radius: 4px; font-family: inherit; }
    #send-btn { padding: 10px 20px; background: #00ff88; color: #000; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
  </style>
</head>
<body>
  <div id="chat-container">
    <div style="text-align:center; color:#666; margin-top:20px;">Connecting to Universal Chat...</div>
  </div>
  <div id="input-area">
    <input type="text" id="msg-input" placeholder="Type a message..." maxlength="200">
    <button id="send-btn">Send</button>
  </div>

  <script>
    let currentUser = null;
    let userInventory = [];

    async function init() {
        if (!window.VibeLib) { setTimeout(init, 100); return; }
        currentUser = await window.VibeLib.Auth.getUser();

        if (currentUser) {
            // Fetch inventory for local user (to send with message? or just rely on server? user wants flex rendering)
            // The prompt says "Render author names in Gold/Blue if they have the corresponding items in their inventory."
            // This implies we need to know the inventory of EACH author.
            // Ideally, the chat table should contain this info, or we fetch it.
            // Since we can't easily change the table schema or join efficiently client-side for every message,
            // let's assume the sender includes their "flex" status in the message metadata or we do a quick lookup.
            // For this implementation, let's look up the profile of the sender from universal_profiles?
            // Or better, `economy_balances` has the inventory.
            // Doing a fetch for every message is heavy.
            // Let's assume the `universal_chat` table has a `metadata` column where we can store the flex items at send time.
        }

        setupRealtime();
        loadHistory();
    }

    function setupRealtime() {
        const channel = window.supabase.channel('universal_chat_room');
        channel
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'universal_chat' }, payload => {
                renderMessage(payload.new);
                scrollToBottom();
            })
            .subscribe();
    }

    async function loadHistory() {
        const { data, error } = await window.supabase
            .from('universal_chat')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(50);

        const container = document.getElementById('chat-container');
        container.innerHTML = '';

        if (data) {
            data.reverse().forEach(renderMessage);
            scrollToBottom();
        }
    }

    function renderMessage(msg) {
        const container = document.getElementById('chat-container');
        const div = document.createElement('div');
        div.className = 'msg';

        // Flex logic
        // We expect msg.metadata.inventory or similar to avoid N+1 queries.
        // If not present, we default to standard style.
        // For this demo, let's try to read it from metadata if possible.
        const inventory = msg.metadata?.inventory || [];
        let authorClass = 'msg-author';
        if (inventory.includes('gold_crown')) authorClass += ' gold-crown';
        else if (inventory.includes('blue_neon_theme')) authorClass += ' blue-neon';

        // Deep Link logic
        let content = escapeHtml(msg.content);
        let actionBtn = '';

        // Regex for /apps/app-name
        const appLinkRegex = /\/apps\/([\w-]+)/;
        const match = content.match(appLinkRegex);

        // Regex for "snake" keyword
        const snakeMatch = content.match(/\b(snake)\b/i);

        if (match) {
            const appName = match[1];
            actionBtn = `<div class="launch-btn" onclick="launchApp('${appName}')">ðŸš€ Launch ${appName}</div>`;
        } else if (snakeMatch) {
            const appName = 'snake';
            actionBtn = `<div class="launch-btn" onclick="launchApp('${appName}')">ðŸš€ Launch ${appName}</div>`;
        }

        const time = new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        div.innerHTML = `
            <div class="msg-header">
                <span class="${authorClass}">${escapeHtml(msg.username || 'Anon')}</span>
                <span>${time}</span>
            </div>
            <div class="msg-content">${content}</div>
            ${actionBtn}
        `;
        container.appendChild(div);
    }

    window.launchApp = function(appName) {
        window.parent.postMessage({
            type: 'OPEN_WINDOW',
            url: `/apps/${appName}/index.html`,
            title: appName
        }, '*');
    };

    function escapeHtml(text) {
        if (!text) return '';
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function scrollToBottom() {
        const container = document.getElementById('chat-container');
        container.scrollTop = container.scrollHeight;
    }

    document.getElementById('send-btn').addEventListener('click', sendMessage);
    document.getElementById('msg-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    async function sendMessage() {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        if (!text) return;

        if (!currentUser) {
            alert('Please login to chat!');
            return;
        }

        input.value = '';

        // Get inventory for flex
        let myInventory = [];
        try {
            const { inventory } = await window.VibeLib.Economy.get(currentUser.id);
            myInventory = inventory || [];
        } catch (e) {}

        const profile = await window.VibeLib.Identity.get(currentUser.id);
        const username = profile.username || 'Anon';

        const { error } = await window.supabase
            .from('universal_chat')
            .insert({
                user_id: currentUser.id,
                username: username,
                content: text,
                metadata: { inventory: myInventory }
            });

        if (error) {
            console.error('Send failed', error);
            alert('Failed to send message');
        }
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
