<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sloppy Chat</title>
    <link rel="icon" href="https://emojicdn.elk.sh/üí¨">
    <meta property="og:title" content="Sloppy Chat">
    <meta property="og:description" content="Global chatroom. Hacker markup, reactions, votes, tags ‚Äî all real-time.">
    <meta property="og:url" content="https://sloppy.live/sloppy-chat">
    <meta property="og:image" content="https://image.pollinations.ai/prompt/retro%20terminal%20chat%20window%20neon%20green%20magenta%20text%20messages%20dark%20background%20pixel%20art?width=1200&height=630&nologo=true&referrer=sloppy.live">
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --accent: #7c9885;
            --accent-light: #a8c4b0;
            --accent-dim: #5a7060;
            --highlight: #c9a87c;
            --dark-bg: #0a0a0f;
            --panel-bg: #12121a;
            --border-color: #2a2a35;
            --text-dim: #6a6a75;
            --msg-opacity: 0.95;
            --msg-color: 10, 10, 15;
            --msg-own-color: 90, 112, 96;
        }

        body {
            font-family: 'VT323', monospace;
            background: var(--dark-bg);
            color: var(--accent);
            overflow: hidden;
            height: 100vh;
        }

        body.embed-mode { background: transparent; }
        body.embed-mode .sloppy-bar { display: none !important; }

        .standalone-only { display: none; }
        body:not(.embed-mode) .standalone-only { display: block; }

        /* Standalone header */
        .standalone-header {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--panel-bg);
            flex-shrink: 0;
        }
        .standalone-header h1 {
            font-size: 1.4rem;
            color: var(--accent-light);
            font-weight: normal;
        }
        .standalone-header .back-link {
            color: var(--text-dim);
            text-decoration: none;
            font-size: 1rem;
        }
        .standalone-header .back-link:hover { color: var(--accent); }
        .standalone-header .online-count {
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        #chatApp {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        body:not(.embed-mode) #chatApp {
            height: calc(100vh - 50px);
        }

        /* Messages container */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .messages-container.hidden { display: none; }
        .messages-container::-webkit-scrollbar { width: 6px; }
        .messages-container::-webkit-scrollbar-track { background: transparent; }
        .messages-container::-webkit-scrollbar-thumb { background: var(--border-color); }

        /* Message */
        .message {
            display: flex;
            gap: 10px;
            animation: glitchIn 0.3s ease-out;
        }
        @keyframes glitchIn {
            0% { opacity: 0; transform: translateX(-10px); }
            50% { opacity: 1; transform: translateX(3px); }
            100% { transform: translateX(0); }
        }
        .message.own { flex-direction: row-reverse; }

        .avatar {
            width: 40px;
            height: 40px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
            background: var(--dark-bg);
        }

        .message-bubble {
            max-width: 70%;
            background: rgba(var(--msg-color), var(--msg-opacity));
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px 14px;
            color: var(--accent);
        }
        .message.own .message-bubble {
            background: rgba(var(--msg-own-color), var(--msg-opacity));
            color: var(--accent-light);
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        .message-username { color: var(--accent-light); font-size: 1rem; }
        .message.own .message-username { color: var(--highlight); }
        .message-time { font-size: 0.85rem; color: #555; }
        .message-content { font-size: 1.1rem; line-height: 1.4; word-wrap: break-word; }

        .message.bot-message { opacity: 0.9; }
        .message.bot-message .message-bubble {
            background: linear-gradient(135deg, rgba(124, 152, 133, 0.15), rgba(90, 122, 99, 0.1));
            border-left: 2px solid var(--accent);
        }
        .message.bot-message .avatar {
            background: linear-gradient(135deg, #7c9885, #5a7a63);
            font-size: 1.2rem;
        }

        .username-clickable { cursor: pointer; transition: color 0.15s; }
        .username-clickable:hover { color: var(--highlight); text-decoration: underline; }

        /* Chat Tags */
        .chat-tag {
            display: inline-block;
            background: linear-gradient(135deg, rgba(124, 152, 133, 0.2) 0%, rgba(124, 152, 133, 0.1) 100%);
            color: var(--accent-light);
            padding: 1px 6px;
            border-radius: 4px;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid rgba(124, 152, 133, 0.3);
        }
        .chat-tag:hover {
            background: linear-gradient(135deg, rgba(124, 152, 133, 0.35) 0%, rgba(124, 152, 133, 0.2) 100%);
            transform: translateY(-1px);
        }
        .chat-mention {
            display: inline-block;
            background: linear-gradient(135deg, rgba(255, 0, 255, 0.2) 0%, rgba(255, 0, 255, 0.1) 100%);
            color: #ff88ff;
            padding: 1px 6px;
            border-radius: 4px;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid rgba(255, 0, 255, 0.3);
        }
        .chat-mention:hover {
            background: linear-gradient(135deg, rgba(255, 0, 255, 0.35) 0%, rgba(255, 0, 255, 0.2) 100%);
            transform: translateY(-1px);
        }
        .chat-mention.self-mention {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.3) 0%, rgba(255, 165, 0, 0.2) 100%);
            color: #ffd700;
            border-color: rgba(255, 215, 0, 0.5);
            animation: mentionPulse 2s ease-in-out infinite;
        }
        @keyframes mentionPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4); }
            50% { box-shadow: 0 0 10px 2px rgba(255, 215, 0, 0.2); }
        }

        /* Tag hint */
        .tag-hint {
            position: absolute;
            bottom: 100%;
            left: 0; right: 0;
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-bottom: none;
            border-radius: 6px 6px 0 0;
            padding: 8px 12px;
            font-size: 0.85rem;
            color: var(--text-dim);
            display: none;
            z-index: 10;
        }
        .tag-hint.visible { display: block; }
        .tag-hint-item {
            display: inline-block;
            background: rgba(124, 152, 133, 0.15);
            padding: 2px 8px;
            margin: 2px 4px 2px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .tag-hint-item:hover { background: rgba(124, 152, 133, 0.3); }

        /* Input Area */
        .input-area {
            position: relative;
            background: var(--dark-bg);
            padding: 12px 16px;
            flex-shrink: 0;
            z-index: 5;
            border-bottom: 1px solid var(--border-color);
        }
        .input-row {
            display: flex;
            gap: 8px;
            align-items: flex-end;
            max-width: 800px;
            margin: 0 auto;
        }
        .input-actions { display: flex; gap: 4px; }
        .action-btn {
            width: 40px; height: 40px;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--accent);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .action-btn:hover { background: var(--accent-dim); color: white; }
        .message-input {
            flex: 1;
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            padding: 10px 16px;
            color: var(--accent-light);
            font-family: inherit;
            font-size: 1.1rem;
            resize: none;
            max-height: 100px;
        }
        .message-input:focus { outline: none; border-color: var(--accent-dim); }
        .message-input::placeholder { color: var(--text-dim); }

        /* Ghost Text */
        .ghost-input-wrapper { position: relative; flex: 1; display: flex; }
        .ghost-text-layer {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            padding: 10px 16px;
            font-family: inherit;
            font-size: 1.1rem;
            pointer-events: none;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow: hidden;
            color: transparent;
        }
        .ghost-text-layer .typed { color: transparent; }
        .ghost-text-layer .ghost {
            color: var(--accent-dim);
            opacity: 0.5;
            animation: ghostPulse 2s ease-in-out infinite;
        }
        @keyframes ghostPulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }
        .ghost-text-hint {
            position: absolute;
            bottom: -18px; right: 5px;
            font-size: 0.65rem;
            color: var(--text-dim);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        .ghost-input-wrapper:focus-within .ghost-text-hint.visible { opacity: 0.7; }

        .send-btn {
            width: 60px; height: 40px;
            border: 1px solid var(--border-color);
            background: var(--accent-dim);
            color: white;
            font-family: inherit;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .send-btn:hover { background: var(--accent); }

        /* Image/Drawing/GIF in messages */
        .message-image, .message-drawing {
            max-width: 100%;
            margin-top: 8px;
            cursor: pointer;
            border: 1px solid var(--border-color);
        }
        .message-gif {
            max-width: 250px;
            max-height: 200px;
            border-radius: 8px;
            cursor: pointer;
        }

        /* Image Preview */
        .image-preview {
            position: relative;
            display: none;
            margin-bottom: 8px;
        }
        .image-preview img {
            max-width: 200px;
            max-height: 150px;
            border: 1px solid var(--border-color);
        }
        .image-preview .remove-btn {
            position: absolute;
            top: -8px; right: -8px;
            width: 24px; height: 24px;
            background: #ff4444;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }

        /* Doodle Vote */
        .doodle-wrapper { position: relative; display: inline-block; }
        .doodle-vote-btn {
            position: absolute;
            bottom: 8px; right: 8px;
            background: rgba(0,0,0,0.7);
            border: 1px solid var(--border-color);
            color: var(--text-dim);
            padding: 4px 10px;
            font-family: inherit;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }
        .doodle-vote-btn:hover { background: rgba(0,0,0,0.9); border-color: var(--highlight); color: var(--highlight); }
        .doodle-vote-btn.voted { color: var(--highlight); border-color: var(--highlight); }

        /* Vote controls */
        .vote-controls {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 2px 4px;
        }
        .vote-btn {
            background: transparent;
            border: none;
            color: var(--text-dim);
            padding: 2px 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.15s;
            border-radius: 8px;
        }
        .vote-btn:hover { background: rgba(255,255,255,0.1); }
        .vote-btn.upvote:hover, .vote-btn.upvote.active { color: #00ff41; }
        .vote-btn.downvote:hover, .vote-btn.downvote.active { color: #ff4444; }
        .vote-btn.disabled { opacity: 0.3; cursor: not-allowed; }
        .vote-score { font-size: 0.8rem; min-width: 20px; text-align: center; font-weight: bold; }
        .vote-score.positive { color: #00ff41; }
        .vote-score.negative { color: #ff4444; }
        .vote-score.neutral { color: var(--text-dim); }

        /* Message footer */
        .message-footer {
            margin-top: 6px;
            padding-top: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .msg-tts-btn {
            background: transparent; border: none;
            color: var(--text-dim); cursor: pointer;
            padding: 2px 6px; font-size: 0.9rem;
            opacity: 0.7; transition: all 0.2s;
        }
        .msg-tts-btn:hover { opacity: 1; color: var(--accent-light); }
        .msg-tts-btn.speaking { opacity: 1; color: var(--accent-light); animation: pulseTts 1s ease-in-out infinite; }
        @keyframes pulseTts { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }
        .msg-fork-btn {
            background: transparent; border: none;
            color: #0f8; cursor: pointer;
            padding: 2px 6px; font-size: 0.75rem;
            opacity: 0.6; transition: all 0.2s;
        }
        .msg-fork-btn:hover { opacity: 1; transform: scale(1.1); }
        .msg-dna-badge {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.65rem;
            color: var(--text-dim);
            opacity: 0.5;
            letter-spacing: 0.5px;
        }
        .msg-dna-badge .nucleotide-A { color: #ff6b6b; }
        .msg-dna-badge .nucleotide-T { color: #4ecdc4; }
        .msg-dna-badge .nucleotide-C { color: #ffe66d; }
        .msg-dna-badge .nucleotide-G { color: #95e1a3; }
        .msg-delete-btn {
            background: transparent; border: none;
            color: var(--text-dim); cursor: pointer;
            padding: 2px 6px; font-size: 0.9rem;
            opacity: 0.7; margin-left: auto;
            transition: all 0.2s;
        }
        .msg-delete-btn:hover { opacity: 1; color: #ff6666; background: rgba(255,100,100,0.1); border-radius: 4px; }

        /* Reactions */
        .reaction-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 4px 10px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }
        .reaction-btn:hover { background: rgba(255,255,255,0.1); border-color: var(--accent); }
        .reaction-btn.active { background: rgba(124, 152, 133, 0.2); border-color: var(--accent); }
        .reaction-count { font-size: 0.8rem; color: var(--text-dim); }
        .add-reaction-btn {
            background: transparent;
            border: 1px dashed var(--border-color);
            border-radius: 16px;
            padding: 4px 10px;
            font-size: 0.9rem;
            cursor: pointer;
            color: var(--text-dim);
            transition: all 0.2s;
        }
        .add-reaction-btn:hover { border-color: var(--accent); color: var(--accent); }
        .reaction-picker {
            display: none;
            position: absolute;
            bottom: 100%; left: 0;
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px;
            gap: 4px;
            flex-wrap: wrap;
            max-width: 200px;
            z-index: 10;
        }
        .reaction-picker.active { display: flex; }
        .reaction-picker button {
            background: none; border: none;
            font-size: 1.2rem; cursor: pointer;
            padding: 4px; border-radius: 4px;
            transition: background 0.2s;
        }
        .reaction-picker button:hover { background: rgba(255,255,255,0.1); }
        .msg-reactions { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
        .msg-reactions .reaction-btn { padding: 2px 6px; font-size: 0.75rem; border-radius: 12px; }
        .msg-reactions .reaction-count { font-size: 0.7rem; }
        .msg-reactions .add-reaction-btn { padding: 2px 6px; font-size: 0.75rem; border-radius: 12px; }
        .msg-reactions .reaction-picker { bottom: auto; top: 100%; max-width: 180px; }

        /* Chat Filter Bar */
        .chat-filter-bar {
            display: none;
            padding: 8px 12px;
            background: linear-gradient(135deg, rgba(124, 152, 133, 0.15) 0%, rgba(124, 152, 133, 0.05) 100%);
            border-bottom: 1px solid var(--border-color);
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        .chat-filter-bar.active { display: flex; }
        .chat-filter-value {
            display: inline-block;
            background: var(--accent);
            color: var(--dark-bg);
            padding: 2px 10px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .chat-filter-value.mention {
            background: linear-gradient(135deg, #ff00ff 0%, #ff88ff 100%);
        }
        .clear-filter {
            background: none; border: none;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0 8px;
        }
        .clear-filter:hover { color: #ff6666; }

        /* Empty state */
        .empty-state { text-align: center; padding: 40px; color: var(--text-dim); }
        .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
        .loading-indicator {
            text-align: center;
            padding: 16px;
            color: var(--accent);
            font-size: 0.85rem;
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Toast */
        .toast-container {
            position: fixed;
            top: 20px; right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }
        .system-toast {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            padding: 10px 16px;
            color: var(--accent);
            font-family: inherit;
            font-size: 0.9rem;
            animation: toastIn 0.3s ease-out;
            pointer-events: auto;
        }
        .system-toast.warning { border-color: #c9a87c; color: #c9a87c; }
        .system-toast.error { border-color: #ff4444; color: #ff4444; }
        @keyframes toastIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Lightbox (standalone mode) */
        .lightbox-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .lightbox-overlay.active { display: flex; }
        .lightbox-overlay img { max-width: 90%; max-height: 90%; object-fit: contain; }

        /* Hacker Markup Effects */
        .hacker-shake { display: inline-block; animation: hackerShake 0.1s infinite; }
        @keyframes hackerShake {
            0%, 100% { transform: translate(0, 0); }
            25% { transform: translate(-2px, 1px); }
            50% { transform: translate(2px, -1px); }
            75% { transform: translate(-1px, -2px); }
        }
        .hacker-rainbow {
            display: inline-block;
            background: linear-gradient(90deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3, #ff0000);
            background-size: 400% 100%;
            -webkit-background-clip: text; background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: hackerRainbow 2s linear infinite;
        }
        @keyframes hackerRainbow {
            0% { background-position: 0% 50%; }
            100% { background-position: 400% 50%; }
        }
        .hacker-matrix {
            display: inline-block;
            color: #00ff00;
            text-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00;
            animation: hackerMatrix 0.5s steps(3) infinite;
            font-family: 'Courier New', monospace;
        }
        @keyframes hackerMatrix {
            0%, 100% { opacity: 1; filter: brightness(1); }
            33% { opacity: 0.8; filter: brightness(1.2); }
            66% { opacity: 0.9; filter: brightness(0.9); }
        }
        .hacker-glitch {
            display: inline-block; position: relative;
            animation: hackerGlitch 0.3s infinite;
        }
        @keyframes hackerGlitch {
            0%, 100% { transform: translate(0); filter: hue-rotate(0deg); }
            20% { transform: translate(-2px, 2px); filter: hue-rotate(90deg); }
            40% { transform: translate(2px, -2px); filter: hue-rotate(180deg); }
            60% { transform: translate(-1px, -1px); filter: hue-rotate(270deg); }
            80% { transform: translate(1px, 1px); filter: hue-rotate(360deg); }
        }
        .hacker-pulse { display: inline-block; animation: hackerPulse 1s ease-in-out infinite; }
        @keyframes hackerPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        .hacker-wave { display: inline-block; }
        .hacker-wave span { display: inline-block; animation: hackerWave 1s ease-in-out infinite; }
        @keyframes hackerWave {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .hacker-spoiler {
            display: inline-block;
            background: var(--text-dim);
            color: transparent;
            border-radius: 3px;
            padding: 0 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }
        .hacker-spoiler:hover, .hacker-spoiler.revealed { background: transparent; color: var(--accent); }
        .hacker-spoiler::before { content: '[spoiler]'; color: var(--accent); font-size: 0.7em; opacity: 0.7; }
        .hacker-spoiler:hover::before, .hacker-spoiler.revealed::before { content: ''; }
        .hacker-neon {
            display: inline-block; color: #fff;
            text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 20px #ff00ff, 0 0 40px #ff00ff, 0 0 80px #ff00ff;
            animation: hackerNeon 1.5s ease-in-out infinite alternate;
        }
        @keyframes hackerNeon {
            from { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 20px #ff00ff, 0 0 40px #ff00ff; }
            to { text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 40px #ff00ff, 0 0 80px #ff00ff, 0 0 120px #ff00ff; }
        }
        .hacker-fire {
            display: inline-block;
            background: linear-gradient(180deg, #ff0000 0%, #ff6600 30%, #ffcc00 60%, #ffff00 100%);
            -webkit-background-clip: text; background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: hackerFire 0.2s infinite alternate;
            filter: drop-shadow(0 0 8px #ff6600);
        }
        @keyframes hackerFire {
            0% { filter: drop-shadow(0 0 8px #ff6600) brightness(1); }
            100% { filter: drop-shadow(0 0 12px #ff3300) brightness(1.1); }
        }
        .hacker-ice {
            display: inline-block; color: #a8e6ff;
            text-shadow: 0 0 5px #a8e6ff, 0 0 10px #00bfff, 0 0 20px #00bfff;
            animation: hackerIce 2s ease-in-out infinite;
        }
        @keyframes hackerIce {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.3); }
        }
        .hacker-bounce { display: inline-block; }
        .hacker-bounce span { display: inline-block; animation: hackerBounce 0.5s ease infinite; }
        @keyframes hackerBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        /* Mobile */
        @media (max-width: 600px) {
            .message-bubble { max-width: 85%; }
            .input-row { flex-wrap: wrap; }
            .action-btn { width: 36px; height: 36px; font-size: 16px; }
        }
    </style>
</head>
<body>
    <div class="standalone-only">
        <div class="standalone-header">
            <a class="back-link" href="https://sloppy.live">‚Üê sloppy.live</a>
            <h1>üí¨ SLOPPY CHAT</h1>
            <span class="online-count" id="onlineCount"></span>
        </div>
    </div>

    <div id="chatApp">
        <div class="input-area" id="chatInputArea">
            <div class="tag-hint" id="tagHint">
                <span style="margin-right:8px;">üí° Use:</span>
                <span class="tag-hint-item" onclick="insertTag('#vibe')">#vibe</span>
                <span class="tag-hint-item" onclick="insertTag('#art')">#art</span>
                <span class="tag-hint-item" onclick="insertTag('#music')">#music</span>
                <span class="tag-hint-item" onclick="insertTag('#code')">#code</span>
                <span class="tag-hint-item" onclick="insertTag('#meme')">#meme</span>
            </div>
            <div class="image-preview" id="imagePreview">
                <img id="previewImg" src="">
                <button class="remove-btn" onclick="removeImage()">√ó</button>
            </div>
            <div class="input-row">
                <div class="input-actions">
                    <button class="action-btn" id="imgBtn" onclick="document.getElementById('imageInput').click()" title="Attach Image">üì∑</button>
                    <button class="action-btn" id="drawBtn" onclick="requestDrawing()" title="Draw Doodle">üé®</button>
                    <button class="action-btn" id="gifBtn" onclick="requestGifSearch()" title="Search GIFs">GIF</button>
                </div>
                <input type="file" id="imageInput" accept="image/*" style="display:none" onchange="handleImageSelect(event)">
                <div class="ghost-input-wrapper">
                    <div class="ghost-text-layer" id="ghostTextLayer"><span class="typed"></span><span class="ghost"></span></div>
                    <textarea class="message-input" id="messageInput" placeholder="Type a message... (use #tags and @mentions)" rows="1" oninput="handleTagInput(this); updateGhostText(this);"></textarea>
                    <div class="ghost-text-hint" id="ghostHint">TAB to accept</div>
                </div>
                <button class="send-btn" onclick="sendMessage()">SEND</button>
            </div>
        </div>
        <div class="chat-filter-bar" id="chatFilterBar">
            <span style="color:var(--text-dim);font-size:0.85rem;">Filtering by:</span>
            <span class="chat-filter-value" id="activeChatFilter"></span>
            <button class="clear-filter" onclick="clearChatFilter()">√ó</button>
        </div>
        <div class="messages-container" id="messagesContainer">
            <div class="empty-state" id="emptyState">
                <div class="icon">üíæ</div>
                <p>INITIALIZING CHAT PROTOCOL...</p>
                <p>Say something!</p>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>
    <div class="lightbox-overlay" id="lightboxOverlay" onclick="closeLightbox()">
        <img id="lightboxImg" src="">
    </div>

    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="/sloppy-header/sloppy-bar.js" data-position="bottom" data-minimized="true"></script>

    <script type="module">
        import { createBrowserClient } from 'https://cdn.jsdelivr.net/npm/@supabase/ssr@0.7.0/+esm';

        const isEmbed = new URLSearchParams(window.location.search).get('embed') === 'true';
        if (isEmbed) document.body.classList.add('embed-mode');

        // === SUPABASE ===
        const SUPABASE_URL = 'https://yjyxteqzhhmtrgcaekgz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM8IS32IUYR2eenCCjdDdioiBU';
        const STORAGE_BUCKET = 'sloppygram';
        const getCookieDomain = () => {
            const h = window.location.hostname;
            if (h.includes('sloppy.live')) return '.sloppy.live';
            if (h.includes('vibecodedbyx.com')) return '.vibecodedbyx.com';
            return '.youreabsolutelyright.xyz';
        };
        const supabase = createBrowserClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            cookieOptions: { name: 'sb-auth-token', domain: getCookieDomain(), path: '/', sameSite: 'lax' }
        });

        // === STATE ===
        let currentUser = null;
        let profile = {
            username: 'Anon' + Math.floor(Math.random() * 9999),
            avatar: 'üë§',
            avatarUrl: '',
            status: ''
        };
        let selectedImage = null;
        const seenMessageIds = new Set();
        let realtimeChannel = null;
        let chatVotesChannel = null;
        let doodleVotes = {};
        let myDoodleVotes = {};
        let messageVotes = {};
        let myMessageVotes = {};
        let messageReactions = {};
        let myMessageReactions = {};
        let activeChatFilter = null;
        const PAGE_SIZE = 30;
        let messagesPage = 0;
        let messagesHasMore = true;
        let messagesLoading = false;
        let currentSpeakingMsgId = null;
        let ghostCurrentSuggestion = '';
        const REACTION_EMOJIS = ['üòÇ', 'üî•', '‚ù§Ô∏è', 'üòÆ', 'üò¢', 'üëè', 'üôå', 'üíÄ'];
        let lastVisualChangeTime = 0;
        const VISUAL_CHANGE_COOLDOWN = 3000;
        window.cachedMessages = [];

        // === UTILITIES ===
        function escapeHtml(text) {
            if (!text) return '';
            return DOMPurify.sanitize(String(text), { ALLOWED_TAGS: [] });
        }
        function escapeAttr(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/'/g, '&#39;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\\/g, '&#92;');
        }
        function sanitizeUrl(url) {
            if (!url) return '';
            var str = String(url).trim();
            if (/^data:image\/(png|jpeg|jpg|gif|webp|svg\+xml);base64,/i.test(str)) return str;
            if (/^(javascript|data|vbscript|file):/i.test(str)) return '';
            return DOMPurify.sanitize(str, { ALLOWED_TAGS: [] });
        }
        function sanitizeForStorage(text, maxLength = 2000) {
            if (!text) return '';
            let clean = DOMPurify.sanitize(String(text), { ALLOWED_TAGS: [] });
            return clean.trim().slice(0, maxLength);
        }

        function showToast(message, type = 'info', duration = 4000) {
            if (isEmbed) {
                window.parent.postMessage({ type: 'show-toast', message, toastType: type }, '*');
                return;
            }
            var container = document.getElementById('toastContainer');
            if (!container) return;
            var toast = document.createElement('div');
            toast.className = 'system-toast ' + type;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(function() { toast.remove(); }, duration);
        }

        function dataURLtoBlob(dataURL) {
            if (!dataURL || typeof dataURL !== 'string') return null;
            try {
                var parts = dataURL.split(',');
                if (parts.length < 2) return null;
                var mimeMatch = parts[0].match(/:(.*?);/);
                var mime = mimeMatch ? mimeMatch[1] : 'application/octet-stream';
                var binary = atob(parts[1]);
                var array = new Uint8Array(binary.length);
                for (var i = 0; i < binary.length; i++) array[i] = binary.charCodeAt(i);
                return new Blob([array], { type: mime });
            } catch (err) { return null; }
        }

        async function uploadToStorage(blob, folder = 'images') {
            try {
                var ext = blob.type === 'image/png' ? 'png' : 'jpg';
                var filename = folder + '/' + Date.now() + '_' + Math.random().toString(36).slice(2) + '.' + ext;
                var result = await supabase.storage.from(STORAGE_BUCKET).upload(filename, blob, { contentType: blob.type, cacheControl: '3600', upsert: false });
                if (result.error) return null;
                var urlData = supabase.storage.from(STORAGE_BUCKET).getPublicUrl(result.data.path);
                return (urlData && urlData.data && urlData.data.publicUrl) ? urlData.data.publicUrl : null;
            } catch (err) { return null; }
        }

        // Rate limiting
        const rateLimits = {
            message: { limit: 5, window: 10000 },
            vote: { limit: 20, window: 60000 },
            drawing: { limit: 3, window: 30000 }
        };
        const actionTimestamps = {};
        function checkRateLimit(type) {
            var config = rateLimits[type];
            if (!config) return { allowed: true };
            var now = Date.now();
            var ts = actionTimestamps[type] || [];
            var valid = ts.filter(function(t) { return now - t < config.window; });
            actionTimestamps[type] = valid;
            if (valid.length >= config.limit) {
                var wait = Math.ceil((config.window - (now - valid[0])) / 1000);
                return { allowed: false, waitTime: wait, message: 'Rate limited. Wait ' + wait + 's' };
            }
            return { allowed: true };
        }
        function recordAction(type) {
            if (!actionTimestamps[type]) actionTimestamps[type] = [];
            actionTimestamps[type].push(Date.now());
        }

        // AI event logging
        async function logAiEvent(eventType, entityType, entityId, metadata) {
            if (!currentUser) return;
            try {
                await supabase.from('ai_events').insert({
                    event_type: eventType, entity_type: entityType,
                    entity_id: entityId, username: profile.username,
                    metadata: metadata || {}, user_id: currentUser.id
                });
            } catch (e) {}
        }

        // === AUTH ===
        function applyHeaderContext(ctx) {
            if (!ctx) return;
            if (ctx.username && ctx.username !== 'Guest') profile.username = ctx.username;
            if (ctx.avatar) profile.avatar = ctx.avatar;
            if (ctx.avatarUrl) profile.avatarUrl = ctx.avatarUrl;
        }

        async function initAuth() {
            var sessRes = await supabase.auth.getSession();
            var session = sessRes.data ? sessRes.data.session : null;
            if (!session) {
                var signRes = await supabase.auth.signInAnonymously();
                session = signRes.data ? signRes.data.session : null;
            }
            if (session && session.user) {
                currentUser = session.user;
            }
            // Use header sync context for profile instead of direct DB query
            if (window.sloppyBarGetContext) {
                var ctx = window.sloppyBarGetContext(function(readyCtx) {
                    applyHeaderContext(readyCtx);
                });
                applyHeaderContext(ctx);
                // Listen for identity changes across tabs
                window.sloppyBarOn('identity-changed', function(e) {
                    if (e.data) applyHeaderContext(e.data);
                });
                window.sloppyBarOn('context-ready', function(e) {
                    applyHeaderContext(e.data);
                });
            } else {
                // Fallback: direct DB query if header not loaded
                var result = await supabase.from('sloppygram_profiles').select('username, avatar, avatar_url').eq('user_id', currentUser.id).single();
                if (result.data) {
                    if (result.data.username) profile.username = result.data.username;
                    if (result.data.avatar) profile.avatar = result.data.avatar;
                    if (result.data.avatar_url) profile.avatarUrl = result.data.avatar_url;
                }
            }
        }

        // === CONTENT DNA ===
        function generateContentDNA(entity, type) {
            var nucleotides = ['A', 'T', 'C', 'G'];
            var prefixes = { msg: 'M', doodle: 'D', post: 'P', manifesto: 'X' };
            var seed = (entity.id || 0) * 7919;
            var content = entity.content || entity.caption || entity.title || '';
            seed += content.split('').reduce(function(a, c) { return a + c.charCodeAt(0); }, 0);
            seed += new Date(entity.created_at || Date.now()).getTime() % 100000;
            var seededRandom = function() { seed = (seed * 1103515245 + 12345) & 0x7fffffff; return seed / 0x7fffffff; };
            var dna = '';
            for (var i = 0; i < 8; i++) { if (i === 4) dna += '-'; dna += nucleotides[Math.floor(seededRandom() * 4)]; }
            var prefix = prefixes[type] || 'U';
            var idStr = String(entity.id || 0).padStart(4, '0');
            return { sequence: dna, code: prefix + idStr, full: prefix + idStr + '::' + dna };
        }

        // === HACKER MARKUP ===
        var MARKUP_MAX_LENGTH = 5000;
        var MARKUP_MAX_TAGS = 20;
        var WAVE_MAX_CHARS = 100;

        function parseHackerMarkup(text) {
            if (!text) return '';
            if (text.length > MARKUP_MAX_LENGTH) return escapeHtml(text);
            var hackerTags = {
                'shake': 'hacker-shake', 'rainbow': 'hacker-rainbow', 'matrix': 'hacker-matrix',
                'glitch': 'hacker-glitch', 'pulse': 'hacker-pulse', 'wave': 'hacker-wave',
                'spoiler': 'hacker-spoiler', 'neon': 'hacker-neon', 'fire': 'hacker-fire',
                'ice': 'hacker-ice', 'bounce': 'hacker-bounce'
            };
            var result = text;
            var totalTagsProcessed = 0;
            for (var tag in hackerTags) {
                var cssClass = hackerTags[tag];
                var regex = new RegExp('\\[' + tag + '\\](.+?)\\[\\/' + tag + '\\]', 'gi');
                if (tag === 'spoiler') {
                    result = result.replace(regex, function(match, content) {
                        if (++totalTagsProcessed > MARKUP_MAX_TAGS) return escapeHtml(match);
                        return '<span class="' + cssClass + '" onclick="this.classList.toggle(\'revealed\')">' + escapeHtml(content) + '</span>';
                    });
                } else if (tag === 'wave' || tag === 'bounce') {
                    result = result.replace(regex, function(match, content) {
                        if (++totalTagsProcessed > MARKUP_MAX_TAGS) return escapeHtml(match);
                        var safeContent = escapeHtml(content);
                        if (safeContent.length > WAVE_MAX_CHARS) return '<span class="' + cssClass + '">' + safeContent + '</span>';
                        var chars = safeContent.split('').map(function(c, i) {
                            if (c === ' ') return ' ';
                            return '<span style="animation-delay:' + (i * 0.05) + 's">' + c + '</span>';
                        }).join('');
                        return '<span class="' + cssClass + '">' + chars + '</span>';
                    });
                } else {
                    result = result.replace(regex, function(match, content) {
                        if (++totalTagsProcessed > MARKUP_MAX_TAGS) return escapeHtml(match);
                        return '<span class="' + cssClass + '">' + escapeHtml(content) + '</span>';
                    });
                }
            }
            return result;
        }

        // === CHAT TAGS ===
        function parseChatTags(text) {
            if (!text) return '';
            var escaped = escapeHtml(text);
            escaped = escaped.replace(/#(\w+)/g, function(match, tag) {
                return '<span class="chat-tag" onclick="filterChatByTag(\'' + escapeAttr(tag) + '\')">#' + escapeHtml(tag) + '</span>';
            });
            var currentUsername = profile.username ? profile.username.toLowerCase() : '';
            escaped = escaped.replace(/@(\w+)/g, function(match, username) {
                var isSelf = currentUsername && username.toLowerCase() === currentUsername;
                var cls = 'chat-mention' + (isSelf ? ' self-mention' : '');
                return '<span class="' + cls + '" onclick="handleUsernameClick(\'' + escapeAttr(username) + '\')">@' + escapeHtml(username) + '</span>';
            });
            return escaped;
        }

        // === GHOST TEXT PREDICTION ===
        var ghostPhrases = {
            'i': ['i believe we can build something amazing together', 'i appreciate everyone here'],
            'we': ['we should collaborate on something creative', 'we can make this space better together'],
            'the': ['the best ideas come from unexpected places', 'the community here inspires me'],
            'what': ['what if we tried something new today?', 'what inspires you to create?'],
            'how': ['how can we help each other grow?', 'how about we brainstorm together?'],
            'hello': ['hello! excited to connect with everyone', 'hello, what are you creating today?'],
            'help': ['help others and you help yourself grow', 'helping each other is what we do'],
            'create': ['create without fear of judgment', 'create something that didn\'t exist before'],
            'share': ['share your work, inspire others', 'share ideas freely and watch them grow'],
            'hey': ['hey! what are you working on?', 'hey, let\'s create something'],
            'hi': ['hi! excited to be here', 'hi everyone, let\'s make today creative'],
            'good': ['good vibes only', 'good ideas come from everywhere'],
            'cool': ['cool project! tell me more', 'cool things happen when we collaborate'],
            'nice': ['nice work! keep it up', 'nice to meet fellow creators'],
            'yes': ['yes! let\'s do this', 'yes to new ideas'],
            'code': ['code is poetry in motion', 'coding is creative problem solving'],
            'art': ['art connects us all', 'art is meant to be shared'],
            'love': ['love what you create', 'love this community'],
            'start': ['start before you\'re ready', 'start small, think big'],
            'try': ['try something new today', 'try sharing your work in progress'],
            'make': ['make something that matters to you', 'make today count'],
            'build': ['build something you\'re proud of', 'building together is more fun'],
            'think': ['thinking out loud helps clarify ideas', 'think big, start small, learn fast'],
            'lol': ['lol creativity is fun!', 'lol let\'s keep the good vibes going'],
            'just': ['just start and see what happens', 'just showing up is half the battle'],
            'want': ['want to collaborate on something?', 'want to share what I\'m working on'],
            'so': ['so many possibilities to explore', 'so what should we build next?']
        };

        window.updateGhostText = function(textarea) {
            var ghostLayer = document.getElementById('ghostTextLayer');
            var ghostHint = document.getElementById('ghostHint');
            if (!ghostLayer || !ghostHint) return;
            var typedSpan = ghostLayer.querySelector('.typed');
            var ghostSpan = ghostLayer.querySelector('.ghost');
            var text = textarea.value || '';
            typedSpan.textContent = text;
            var words = text.toLowerCase().split(/\s+/);
            var lastWord = words[words.length - 1] || '';
            var suggestion = '';
            if (lastWord.length >= 2 && !text.endsWith(' ')) {
                var matchingKeys = Object.keys(ghostPhrases).filter(function(key) { return key.startsWith(lastWord) && key !== lastWord; });
                if (matchingKeys.length > 0) {
                    var matchKey = matchingKeys[Math.floor(Math.random() * matchingKeys.length)];
                    suggestion = ghostPhrases[matchKey][Math.floor(Math.random() * ghostPhrases[matchKey].length)].slice(lastWord.length);
                } else if (ghostPhrases[lastWord]) {
                    suggestion = ghostPhrases[lastWord][Math.floor(Math.random() * ghostPhrases[lastWord].length)].slice(lastWord.length);
                }
            }
            ghostSpan.textContent = suggestion;
            ghostCurrentSuggestion = suggestion;
            ghostHint.classList.toggle('visible', !!suggestion);
        };

        document.addEventListener('keydown', function(e) {
            var input = document.getElementById('messageInput');
            if (!input || document.activeElement !== input) return;
            if (e.key === 'Tab' && ghostCurrentSuggestion) {
                e.preventDefault();
                input.value += ghostCurrentSuggestion;
                ghostCurrentSuggestion = '';
                updateGhostText(input);
            }
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // === TAG HINTS ===
        window.handleTagInput = function(textarea) {
            var hint = document.getElementById('tagHint');
            if (!hint) return;
            var val = textarea.value || '';
            var lastWord = val.split(/\s/).pop() || '';
            if (val.slice(-1) === '#' || val.slice(-1) === '@' || lastWord.startsWith('#') || lastWord.startsWith('@')) {
                hint.classList.add('visible');
            } else if (val.length === 0) { hint.classList.remove('visible'); }
            if (lastWord.length > 8 && (lastWord.startsWith('#') || lastWord.startsWith('@'))) { hint.classList.remove('visible'); }
        };

        window.insertTag = function(tag) {
            var input = document.getElementById('messageInput');
            if (!input) return;
            var val = input.value || '';
            if (val.endsWith('#') || val.endsWith('@')) { input.value = val.slice(0, -1) + tag + ' '; }
            else if (val.length > 0 && !val.endsWith(' ')) { input.value = val + ' ' + tag + ' '; }
            else { input.value = val + tag + ' '; }
            input.focus();
            var hint = document.getElementById('tagHint');
            if (hint) hint.classList.remove('visible');
        };

        // === CHAT FILTERING ===
        window.filterChatByTag = function(tag) {
            activeChatFilter = { type: 'tag', value: tag };
            var filterBar = document.getElementById('chatFilterBar');
            var filterValue = document.getElementById('activeChatFilter');
            if (filterBar) filterBar.classList.add('active');
            if (filterValue) { filterValue.textContent = '#' + tag; filterValue.classList.remove('mention'); }
            renderFilteredMessages();
            showToast('Filtering by #' + tag, 'info');
        };

        window.filterChatByMention = function(username) {
            activeChatFilter = { type: 'mention', value: username };
            var filterBar = document.getElementById('chatFilterBar');
            var filterValue = document.getElementById('activeChatFilter');
            if (filterBar) filterBar.classList.add('active');
            if (filterValue) { filterValue.textContent = '@' + username; filterValue.classList.add('mention'); }
            renderFilteredMessages();
        };

        window.clearChatFilter = function() {
            activeChatFilter = null;
            var filterBar = document.getElementById('chatFilterBar');
            if (filterBar) filterBar.classList.remove('active');
            renderMessages();
        };

        function renderMessages() {
            var container = document.getElementById('messagesContainer');
            var emptyState = document.getElementById('emptyState');
            if (!container) return;
            var all = window.cachedMessages || [];
            if (all.length === 0) {
                if (emptyState) { emptyState.innerHTML = '<div class="icon">üíæ</div><p>INITIALIZING CHAT PROTOCOL...</p><p>Say something!</p>'; emptyState.style.display = 'block'; }
                container.innerHTML = '';
                if (emptyState) container.appendChild(emptyState);
                return;
            }
            if (emptyState) emptyState.style.display = 'none';
            container.innerHTML = '';
            all.forEach(function(msg) { addMessageToUI(msg, false); });
            container.scrollTop = 0;
        }

        function renderFilteredMessages() {
            if (!activeChatFilter) { renderMessages(); return; }
            var container = document.getElementById('messagesContainer');
            var emptyState = document.getElementById('emptyState');
            if (!container) return;
            var all = window.cachedMessages || [];
            var filtered = all.filter(function(msg) {
                var content = msg.content || '';
                if (activeChatFilter.type === 'tag') { return new RegExp('#' + activeChatFilter.value + '\\b', 'i').test(content); }
                if (activeChatFilter.type === 'mention') { return msg.username === activeChatFilter.value || new RegExp('@' + activeChatFilter.value + '\\b', 'i').test(content); }
                return true;
            });
            if (filtered.length === 0) {
                var ft = activeChatFilter.type === 'tag' ? '#' + activeChatFilter.value : '@' + activeChatFilter.value;
                if (emptyState) { emptyState.innerHTML = '<div class="icon">üîç</div><p>No messages with ' + escapeHtml(ft) + '</p>'; emptyState.style.display = 'block'; }
                container.innerHTML = '';
                if (emptyState) container.appendChild(emptyState);
                return;
            }
            if (emptyState) emptyState.style.display = 'none';
            container.innerHTML = '';
            filtered.forEach(function(msg) { addMessageToUI(msg, false); });
        }

        // === USERNAME CLICK ===
        window.handleUsernameClick = function(username) {
            if (isEmbed) {
                window.parent.postMessage({ type: 'username-click', username: username }, '*');
            } else {
                filterChatByMention(username);
            }
        };

        // === LIGHTBOX ===
        window.openLightbox = function(src) {
            if (isEmbed) {
                window.parent.postMessage({ type: 'open-lightbox', url: src }, '*');
            } else {
                var overlay = document.getElementById('lightboxOverlay');
                var img = document.getElementById('lightboxImg');
                if (overlay && img) { img.src = src; overlay.classList.add('active'); }
            }
        };
        window.closeLightbox = function() {
            var overlay = document.getElementById('lightboxOverlay');
            if (overlay) overlay.classList.remove('active');
        };

        // === GIF / DRAWING DELEGATION ===
        window.requestGifSearch = function() {
            if (isEmbed) {
                window.parent.postMessage({ type: 'open-gif-search' }, '*');
            } else {
                showToast('GIF search available in Sloppygram', 'info');
            }
        };
        window.requestDrawing = function() {
            if (isEmbed) {
                window.parent.postMessage({ type: 'open-drawing' }, '*');
            } else {
                showToast('Drawing canvas available in Sloppygram', 'info');
            }
        };

        // === LOAD MESSAGES ===
        async function loadMessages(loadMore) {
            if (messagesLoading) return;
            if (loadMore && !messagesHasMore) return;
            messagesLoading = true;
            var container = document.getElementById('messagesContainer');
            if (loadMore) {
                var loader = document.createElement('div');
                loader.className = 'loading-indicator';
                loader.id = 'messagesLoader';
                loader.textContent = 'Loading...';
                container.appendChild(loader);
            }
            var from = loadMore ? messagesPage * PAGE_SIZE : 0;
            var to = from + PAGE_SIZE - 1;
            var result = await supabase.from('sloppygram_messages')
                .select('id, username, avatar, avatar_url, content, image_data, drawing_data, message_type, created_at, user_id')
                .order('created_at', { ascending: false })
                .range(from, to);
            var loaderEl = document.getElementById('messagesLoader');
            if (loaderEl) loaderEl.remove();
            messagesLoading = false;
            if (result.error) { console.error('Load error:', result.error); return; }
            var data = result.data || [];
            var emptyState = document.getElementById('emptyState');
            if (!loadMore && data.length === 0) { if (emptyState) emptyState.style.display = 'block'; return; }
            if (emptyState) emptyState.style.display = 'none';
            messagesHasMore = data.length === PAGE_SIZE;
            if (loadMore) { messagesPage++; } else { messagesPage = 1; }
            if (!loadMore) window.cachedMessages = [];
            data.forEach(function(msg) {
                if (!seenMessageIds.has(msg.id)) {
                    seenMessageIds.add(msg.id);
                    window.cachedMessages.push(msg);
                    addMessageToUI(msg, false);
                }
            });
            if (!loadMore) container.scrollTop = 0;
        }

        // === ADD MESSAGE TO UI ===
        function addMessageToUI(msg, prepend) {
            var container = document.getElementById('messagesContainer');
            var emptyState = document.getElementById('emptyState');
            if (emptyState) emptyState.style.display = 'none';
            var currentUserId = currentUser ? currentUser.id : null;
            var isOwn = msg.user_id === currentUserId;
            var time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            var div = document.createElement('div');
            div.className = 'message' + (isOwn ? ' own' : '');

            var contentHTML = '';
            if (msg.content) {
                contentHTML = '<div class="message-content">' + parseHackerMarkup(parseChatTags(msg.content)) + '</div>';
            }
            var safeImageData = sanitizeUrl(msg.image_data);
            if (safeImageData) {
                var imgClass = msg.message_type === 'gif' ? 'message-image message-gif' : 'message-image';
                contentHTML += '<img class="' + imgClass + '" src="' + safeImageData + '" onclick="openLightbox(this.src)">';
            }
            var safeDrawingData = sanitizeUrl(msg.drawing_data);
            if (safeDrawingData) {
                var doodleId = msg.id;
                var isRealDoodleId = typeof doodleId === 'number' || (typeof doodleId === 'string' && !doodleId.startsWith('temp_'));
                var doodleScore = doodleVotes[doodleId] || 0;
                var myDoodleVote = myDoodleVotes[doodleId] || 0;
                var isOwnDoodle = (currentUserId && msg.user_id === currentUserId) || msg.username === profile.username;
                var doodleScoreClass = doodleScore > 0 ? 'positive' : doodleScore < 0 ? 'negative' : 'neutral';
                var doodleDnaBadge = '';
                if (isRealDoodleId) {
                    var dDna = generateContentDNA(msg, 'doodle');
                    var coloredDSeq = dDna.sequence.split('').map(function(c) {
                        if (c === '-') return '<span style="opacity:0.3">¬∑</span>';
                        return '<span class="nucleotide-' + c + '">' + c + '</span>';
                    }).join('');
                    doodleDnaBadge = '<span class="msg-dna-badge" title="' + dDna.full + '">' + dDna.code + '::' + coloredDSeq + '</span>';
                }
                var doodleVoteControls = isRealDoodleId ? '<div class="vote-controls doodle-votes" data-doodle-id="' + escapeAttr(String(doodleId)) + '">' +
                    '<button class="vote-btn upvote ' + (myDoodleVote === 1 ? 'active' : '') + ' ' + (isOwnDoodle ? 'disabled' : '') + '" onclick="' + (isOwnDoodle ? '' : "voteDoodle('" + escapeAttr(String(doodleId)) + "', 1, '" + escapeAttr(msg.username) + "')") + '" title="' + (isOwnDoodle ? 'Cannot vote on own doodle' : 'Upvote') + '">‚ñ≤</button>' +
                    '<span class="vote-score ' + doodleScoreClass + '">' + doodleScore + '</span>' +
                    '<button class="vote-btn downvote ' + (myDoodleVote === -1 ? 'active' : '') + ' ' + (isOwnDoodle ? 'disabled' : '') + '" onclick="' + (isOwnDoodle ? '' : "voteDoodle('" + escapeAttr(String(doodleId)) + "', -1, '" + escapeAttr(msg.username) + "')") + '" title="' + (isOwnDoodle ? 'Cannot vote on own doodle' : 'Downvote') + '">‚ñº</button>' +
                    '<button class="msg-fork-btn" onclick="forkDoodle(\'' + escapeAttr(String(doodleId)) + '\')" title="Fork this doodle">üîÄ</button>' +
                    doodleDnaBadge + '</div>' : '';
                contentHTML += '<div class="doodle-wrapper"><img class="message-drawing" src="' + safeDrawingData + '">' + doodleVoteControls + '</div>';
            }

            var msgId = msg.id;
            var isRealId = typeof msgId === 'number' || (typeof msgId === 'string' && !msgId.startsWith('temp_'));
            var isOwnMessage = (currentUserId && msg.user_id === currentUserId) || msg.username === profile.username;
            var chatVoteScore = messageVotes[msgId] || 0;
            var myVoteType = myMessageVotes[msgId] || 0;
            var scoreClass = chatVoteScore > 0 ? 'positive' : chatVoteScore < 0 ? 'negative' : 'neutral';
            var safeMsgId = escapeAttr(String(msgId));
            var ttsBtn = (msg.content && !msg.drawing_data) ? '<button class="msg-tts-btn" id="msg-tts-' + safeMsgId + '" onclick="speakMessage(\'' + safeMsgId + '\')" title="Read aloud">üîä</button>' : '';
            var forkBtn = (msg.content && !msg.drawing_data && isRealId) ? '<button class="msg-fork-btn" onclick="forkMessage(\'' + safeMsgId + '\')" title="Fork">üîÄ</button>' : '';
            var msgDnaBadge = '';
            if (isRealId) {
                var msgDna = generateContentDNA(msg, msg.drawing_data ? 'doodle' : 'msg');
                var coloredSeq = msgDna.sequence.split('').map(function(c) { return c === '-' ? '<span style="opacity:0.3">¬∑</span>' : '<span class="nucleotide-' + c + '">' + c + '</span>'; }).join('');
                msgDnaBadge = '<span class="msg-dna-badge" title="' + msgDna.full + '">' + msgDna.code + '::' + coloredSeq + '</span>';
            }
            var msgReacts = messageReactions[msgId] || {};
            var myMsgReacts = myMessageReactions[msgId] || new Set();
            var msgReactionsHtml = Object.entries(msgReacts).sort(function(a, b) { return b[1] - a[1]; }).map(function(entry) {
                var emoji = entry[0], count = entry[1];
                var isActive = myMsgReacts.has ? myMsgReacts.has(emoji) : false;
                return '<button class="reaction-btn ' + (isActive ? 'active' : '') + '" onclick="toggleMessageReaction(\'' + escapeAttr(msgId) + '\', \'' + escapeAttr(emoji) + '\')">' + escapeHtml(emoji) + ' <span class="reaction-count">' + count + '</span></button>';
            }).join('');
            var pickerHtml = REACTION_EMOJIS.map(function(emoji) { return '<button onclick="toggleMessageReaction(\'' + escapeAttr(msgId) + '\', \'' + escapeAttr(emoji) + '\')">' + emoji + '</button>'; }).join('');
            var chatVoteBtn = (isRealId && !msg.drawing_data) ? '<div class="message-footer"><div class="vote-controls" data-chat-id="' + safeMsgId + '">' +
                '<button class="vote-btn upvote ' + (myVoteType === 1 ? 'active' : '') + ' ' + (isOwnMessage ? 'disabled' : '') + '" onclick="' + (isOwnMessage ? '' : "voteMessage('" + safeMsgId + "', 1)") + '" title="' + (isOwnMessage ? 'Cannot vote own' : 'Upvote') + '">‚ñ≤</button>' +
                '<span class="vote-score ' + scoreClass + '">' + chatVoteScore + '</span>' +
                '<button class="vote-btn downvote ' + (myVoteType === -1 ? 'active' : '') + ' ' + (isOwnMessage ? 'disabled' : '') + '" onclick="' + (isOwnMessage ? '' : "voteMessage('" + safeMsgId + "', -1)") + '" title="' + (isOwnMessage ? 'Cannot vote own' : 'Downvote') + '">‚ñº</button>' +
                '</div>' + ttsBtn + forkBtn + msgDnaBadge +
                '<div class="msg-reactions" id="msg-reactions-' + safeMsgId + '">' + msgReactionsHtml +
                '<div style="position:relative;display:inline-block;"><button class="add-reaction-btn" onclick="toggleMsgReactionPicker(\'' + safeMsgId + '\')">+üòÄ</button>' +
                '<div class="reaction-picker" id="msg-picker-' + safeMsgId + '">' + pickerHtml + '</div></div></div></div>' : '';

            var safeAvatarUrl = sanitizeUrl(msg.avatar_url || msg.avatarUrl);
            var avatarContent = safeAvatarUrl ? '<img src="' + safeAvatarUrl + '" alt="avatar" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">' : (msg.avatar || 'üë§');
            var deleteBtn = (isOwnMessage && isRealId) ? '<button class="msg-delete-btn" onclick="deleteMessage(\'' + safeMsgId + '\')" title="Delete">delete</button>' : '';
            div.innerHTML = '<div class="avatar">' + avatarContent + '</div><div class="message-bubble"><div class="message-header">' +
                '<span class="message-username username-clickable" onclick="handleUsernameClick(\'' + escapeAttr(msg.username || 'Anonymous') + '\')">' + escapeHtml(msg.username || 'Anonymous') + '</span>' +
                '<span class="message-time">' + time + '</span>' + deleteBtn + '</div>' + contentHTML + chatVoteBtn + '</div>';

            if (prepend) { container.insertBefore(div, container.firstChild); }
            else { container.appendChild(div); }
        }

        // === SEND MESSAGE ===
        window.sendMessage = async function() {
            var input = document.getElementById('messageInput');
            var rawContent = (input.value || '').trim();
            if (!rawContent && !selectedImage) return;
            if (checkForRalphCommand(rawContent)) { input.value = ''; return; }
            var content = rawContent ? sanitizeForStorage(rawContent, 5000) : null;
            var rateCheck = checkRateLimit('message');
            if (!rateCheck.allowed) { showToast(rateCheck.message, 'warning'); return; }
            recordAction('message');
            var tempId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            var hasImage = !!selectedImage;
            var localImageData = selectedImage;
            var msg = {
                id: tempId, username: profile.username, avatar: profile.avatar,
                avatarUrl: profile.avatarUrl || null, content: content,
                image_data: localImageData || null, drawing_data: null,
                message_type: hasImage ? 'image' : 'text',
                user_id: currentUser ? currentUser.id : null,
                created_at: new Date().toISOString()
            };
            input.value = ''; input.style.height = 'auto';
            removeImage();
            seenMessageIds.add(tempId);
            addMessageToUI(msg, true);
            broadcastMessage(msg);
            if (isEmbed) window.parent.postMessage({ type: 'new-message', username: profile.username, action: hasImage ? 'shared an image' : 'sent a message' }, '*');
            var finalImageData = null;
            if (localImageData) {
                var blob = dataURLtoBlob(localImageData);
                if (blob) { var url = await uploadToStorage(blob, 'chat'); finalImageData = url || localImageData; }
                else { finalImageData = localImageData; }
            }
            var result = await supabase.from('sloppygram_messages').insert({
                username: msg.username, avatar: msg.avatar, avatar_url: msg.avatarUrl,
                content: msg.content, image_data: finalImageData, drawing_data: null,
                message_type: msg.message_type, user_id: msg.user_id
            }).select('id').single();
            if (result.error) { console.error('Send error:', result.error); return; }
            if (result.data && result.data.id) {
                seenMessageIds.add(result.data.id);
                if (content) { persistMessageTags(result.data.id, content, msg.user_id); saveMentions(content, 'message', result.data.id); }
            }
        };

        // === DELETE MESSAGE ===
        window.deleteMessage = async function(messageId) {
            if (!currentUser) return;
            if (!confirm('Delete this message?')) return;
            var result = await supabase.from('sloppygram_messages').delete().eq('id', messageId).eq('user_id', currentUser.id);
            if (result.error) { console.error('Delete error:', result.error); return; }
            var container = document.getElementById('messagesContainer');
            container.querySelectorAll('.message').forEach(function(el) {
                if (el.querySelector('[data-chat-id="' + messageId + '"]') || el.querySelector('[data-doodle-id="' + messageId + '"]')) el.remove();
            });
        };

        // === SEND DRAWING (receives data from parent) ===
        async function handleDrawingData(dataUrl) {
            var rateCheck = checkRateLimit('drawing');
            if (!rateCheck.allowed) { showToast(rateCheck.message, 'warning'); return; }
            recordAction('drawing');
            var tempId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            var msg = {
                id: tempId, username: profile.username, avatar: profile.avatar,
                avatarUrl: profile.avatarUrl || null, content: null, image_data: null,
                drawing_data: dataUrl, message_type: 'drawing',
                user_id: currentUser ? currentUser.id : null, created_at: new Date().toISOString()
            };
            seenMessageIds.add(tempId);
            addMessageToUI(msg, true);
            broadcastMessage(msg);
            if (isEmbed) window.parent.postMessage({ type: 'new-message', username: profile.username, action: 'shared a drawing' }, '*');
            var blob = dataURLtoBlob(dataUrl);
            var storageUrl = blob ? await uploadToStorage(blob, 'doodles') : null;
            var finalData = storageUrl || dataUrl;
            var result = await supabase.from('sloppygram_messages').insert({
                username: msg.username, avatar: msg.avatar, avatar_url: msg.avatarUrl,
                content: null, image_data: null, drawing_data: finalData,
                message_type: 'drawing', user_id: msg.user_id
            }).select('id').single();
            if (result.data && result.data.id) seenMessageIds.add(result.data.id);
        }

        // === SEND GIF ===
        window.sendGif = async function(gifUrl) {
            if (!currentUser) { showToast('Sign in to send GIFs', 'warning'); return; }
            var rateCheck = checkRateLimit('message');
            if (!rateCheck.allowed) { showToast(rateCheck.message, 'warning'); return; }
            recordAction('message');
            var tempMsg = {
                id: 'temp_' + Date.now(), username: profile.username, avatar: profile.avatar,
                avatar_url: profile.avatarUrl, content: null, image_data: gifUrl, message_type: 'gif',
                created_at: new Date().toISOString(), user_id: currentUser.id
            };
            seenMessageIds.add(tempMsg.id);
            addMessageToUI(tempMsg, true);
            broadcastMessage(tempMsg);
            var result = await supabase.from('sloppygram_messages').insert({
                username: profile.username, avatar: profile.avatar, avatar_url: profile.avatarUrl,
                content: null, image_data: gifUrl, message_type: 'gif', user_id: currentUser.id
            });
            if (result.error) showToast('Failed to send GIF', 'error');
        };

        // === IMAGE HANDLING ===
        window.handleImageSelect = function(event) {
            var file = event.target.files[0];
            if (!file) return;
            if (file.size > 500000) { alert('FILE TOO LARGE. MAX 500KB.'); return; }
            var reader = new FileReader();
            reader.onload = function(e) {
                selectedImage = e.target.result;
                document.getElementById('previewImg').src = selectedImage;
                document.getElementById('imagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        };
        window.removeImage = function() {
            selectedImage = null;
            var preview = document.getElementById('imagePreview');
            if (preview) preview.style.display = 'none';
            var input = document.getElementById('imageInput');
            if (input) input.value = '';
        };

        // === RALPH WIGGUM BOT ===
        var RALPH_QUOTES = [
            "Me fail English? That's unpossible!", "I'm learnding!", "I bent my wookie.",
            "My cat's breath smells like cat food.", "I'm in danger!", "I found a moon rock in my nose!",
            "My knob tastes funny.", "I'm a unitard!", "I'm Idaho!",
            "When I grow up, I want to be a principal or a caterpillar.", "I sleep in a drawer!",
            "I dress myself!", "Go banana!", "Hi Super Nintendo Chalmers!", "I'm a brick!",
            "I eated the purple berries.", "I put the glue inside the computer now!"
        ];
        window.summonRalph = function() {
            var quote = RALPH_QUOTES[Math.floor(Math.random() * RALPH_QUOTES.length)];
            var msg = {
                id: 'ralph_' + Date.now(), username: 'üßí Ralph Wiggum', avatar: 'üßí',
                avatarUrl: null, content: quote, image_data: null, drawing_data: null,
                message_type: 'text', user_id: 'ralph_bot', created_at: new Date().toISOString()
            };
            addMessageToUI(msg, true);
            broadcastMessage(msg);
            showToast('üßí Ralph has spoken!', 'info');
        };
        function checkForRalphCommand(content) {
            if (content && content.toLowerCase().trim() === '/ralph') {
                setTimeout(function() { window.summonRalph(); }, 500);
                return true;
            }
            return false;
        }

        // === FORK ===
        window.forkMessage = function(msgId) {
            var msg = (window.cachedMessages || []).find(function(m) { return String(m.id) === String(msgId); });
            if (!msg || !msg.content) return;
            var input = document.getElementById('messageInput');
            if (input) {
                var dna = generateContentDNA(msg, 'msg');
                input.value = '[fork:' + dna.code + '] ' + msg.content;
                input.focus();
            }
        };
        window.forkDoodle = function(doodleId) {
            showToast('Doodle DNA copied! Draw your remix.', 'info');
            if (isEmbed) window.parent.postMessage({ type: 'open-drawing' }, '*');
        };

        // === TTS ===
        window.speakMessage = function(msgId) {
            var msg = (window.cachedMessages || []).find(function(m) { return String(m.id) === String(msgId); });
            if (!msg || !msg.content) return;
            var cleanText = msg.content.replace(/\[\w+\]|\[\/\w+\]/gi, '');
            if (currentSpeakingMsgId === msgId && window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
                var btn = document.getElementById('msg-tts-' + msgId);
                if (btn) btn.classList.remove('speaking');
                currentSpeakingMsgId = null;
                return;
            }
            if (window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
                if (currentSpeakingMsgId) { var old = document.getElementById('msg-tts-' + currentSpeakingMsgId); if (old) old.classList.remove('speaking'); }
            }
            var utterance = new SpeechSynthesisUtterance(cleanText);
            var btn = document.getElementById('msg-tts-' + msgId);
            if (btn) btn.classList.add('speaking');
            currentSpeakingMsgId = msgId;
            utterance.onend = function() { if (btn) btn.classList.remove('speaking'); currentSpeakingMsgId = null; };
            utterance.onerror = function() { if (btn) btn.classList.remove('speaking'); currentSpeakingMsgId = null; };
            window.speechSynthesis.speak(utterance);
        };

        // === MESSAGE VOTING ===
        async function loadMessageVotes() {
            var result = await supabase.from('sloppygram_message_votes').select('message_id, voter_username, vote_type');
            if (result.data) {
                messageVotes = {}; myMessageVotes = {};
                result.data.forEach(function(v) { messageVotes[v.message_id] = (messageVotes[v.message_id] || 0) + (v.vote_type || 1); });
                result.data.filter(function(v) { return v.voter_username === profile.username; }).forEach(function(v) { myMessageVotes[v.message_id] = v.vote_type || 1; });
            }
        }
        window.voteMessage = async function(messageId, voteType) {
            if (!currentUser) return;
            var rateCheck = checkRateLimit('vote');
            if (!rateCheck.allowed) { showToast(rateCheck.message, 'warning'); return; }
            recordAction('vote');
            var currentVote = myMessageVotes[messageId] || 0;
            if (currentVote === voteType) {
                await supabase.from('sloppygram_message_votes').delete().eq('message_id', messageId).eq('user_id', currentUser.id);
                myMessageVotes[messageId] = 0;
                messageVotes[messageId] = (messageVotes[messageId] || 0) - voteType;
            } else {
                if (currentVote !== 0) { await supabase.from('sloppygram_message_votes').delete().eq('message_id', messageId).eq('user_id', currentUser.id); messageVotes[messageId] = (messageVotes[messageId] || 0) - currentVote; }
                await supabase.from('sloppygram_message_votes').insert({ message_id: messageId, voter_username: profile.username, vote_type: voteType, user_id: currentUser.id });
                myMessageVotes[messageId] = voteType;
                messageVotes[messageId] = (messageVotes[messageId] || 0) + voteType;
            }
            logAiEvent('vote_cast', 'message', messageId, { vote_type: myMessageVotes[messageId] || 0, net_score: messageVotes[messageId] || 0 });
            updateMessageVoteUI(messageId);
        };
        function updateMessageVoteUI(messageId) {
            var score = messageVotes[messageId] || 0;
            var myVote = myMessageVotes[messageId] || 0;
            var scoreClass = score > 0 ? 'positive' : score < 0 ? 'negative' : 'neutral';
            document.querySelectorAll('[data-chat-id="' + messageId + '"]').forEach(function(c) {
                var s = c.querySelector('.vote-score'); if (s) { s.textContent = score; s.className = 'vote-score ' + scoreClass; }
                var u = c.querySelector('.vote-btn.upvote'); if (u) u.classList.toggle('active', myVote === 1);
                var d = c.querySelector('.vote-btn.downvote'); if (d) d.classList.toggle('active', myVote === -1);
            });
        }

        // === DOODLE VOTING (inline) ===
        async function loadDoodleVotes() {
            var result = await supabase.from('sloppygram_doodle_votes').select('message_id, voter_username, vote_type');
            if (result.data) {
                doodleVotes = {}; myDoodleVotes = {};
                result.data.forEach(function(v) { doodleVotes[v.message_id] = (doodleVotes[v.message_id] || 0) + (v.vote_type || 1); });
                result.data.filter(function(v) { return v.voter_username === profile.username; }).forEach(function(v) { myDoodleVotes[v.message_id] = v.vote_type || 1; });
            }
        }
        window.voteDoodle = async function(messageId, voteType, ownerUsername) {
            if (!currentUser) return;
            if (ownerUsername === profile.username) return;
            var rateCheck = checkRateLimit('vote');
            if (!rateCheck.allowed) { showToast(rateCheck.message, 'warning'); return; }
            recordAction('vote');
            var currentVote = myDoodleVotes[messageId] || 0;
            if (currentVote === voteType) {
                await supabase.from('sloppygram_doodle_votes').delete().eq('message_id', messageId).eq('user_id', currentUser.id);
                myDoodleVotes[messageId] = 0; doodleVotes[messageId] = (doodleVotes[messageId] || 0) - voteType;
            } else {
                if (currentVote !== 0) { await supabase.from('sloppygram_doodle_votes').delete().eq('message_id', messageId).eq('user_id', currentUser.id); doodleVotes[messageId] = (doodleVotes[messageId] || 0) - currentVote; }
                await supabase.from('sloppygram_doodle_votes').insert({ message_id: messageId, voter_username: profile.username, vote_type: voteType, user_id: currentUser.id });
                myDoodleVotes[messageId] = voteType; doodleVotes[messageId] = (doodleVotes[messageId] || 0) + voteType;
            }
            logAiEvent('vote_cast', 'doodle', messageId, { vote_type: myDoodleVotes[messageId] || 0, net_score: doodleVotes[messageId] || 0 });
            updateDoodleVoteUI(messageId);
        };
        function updateDoodleVoteUI(messageId) {
            var score = doodleVotes[messageId] || 0;
            var myVote = myDoodleVotes[messageId] || 0;
            var scoreClass = score > 0 ? 'positive' : score < 0 ? 'negative' : 'neutral';
            document.querySelectorAll('[data-doodle-id="' + messageId + '"]').forEach(function(c) {
                var s = c.querySelector('.vote-score'); if (s) { s.textContent = score; s.className = 'vote-score ' + scoreClass; }
                var u = c.querySelector('.vote-btn.upvote'); if (u) u.classList.toggle('active', myVote === 1);
                var d = c.querySelector('.vote-btn.downvote'); if (d) d.classList.toggle('active', myVote === -1);
            });
        }

        // === MESSAGE REACTIONS ===
        async function loadMessageReactions() {
            var result = await supabase.from('sloppygram_message_reactions').select('message_id, emoji, username');
            if (result.data) {
                messageReactions = {}; myMessageReactions = {};
                result.data.forEach(function(r) {
                    if (!messageReactions[r.message_id]) messageReactions[r.message_id] = {};
                    messageReactions[r.message_id][r.emoji] = (messageReactions[r.message_id][r.emoji] || 0) + 1;
                    if (r.username === profile.username) {
                        if (!myMessageReactions[r.message_id]) myMessageReactions[r.message_id] = new Set();
                        myMessageReactions[r.message_id].add(r.emoji);
                    }
                });
            }
        }
        window.toggleMsgReactionPicker = function(messageId) {
            var picker = document.getElementById('msg-picker-' + messageId);
            if (picker) picker.classList.toggle('active');
        };
        window.toggleMessageReaction = async function(messageId, emoji) {
            if (!currentUser) return;
            var rateCheck = checkRateLimit('vote');
            if (!rateCheck.allowed) { showToast(rateCheck.message, 'warning'); return; }
            recordAction('vote');
            var picker = document.getElementById('msg-picker-' + messageId);
            if (picker) picker.classList.remove('active');
            var myReacts = myMessageReactions[messageId] || new Set();
            var hasReaction = myReacts.has ? myReacts.has(emoji) : false;
            if (hasReaction) {
                await supabase.from('sloppygram_message_reactions').delete().eq('message_id', messageId).eq('emoji', emoji).eq('user_id', currentUser.id);
                if (myMessageReactions[messageId]) myMessageReactions[messageId].delete(emoji);
                if (messageReactions[messageId] && messageReactions[messageId][emoji]) { messageReactions[messageId][emoji]--; if (messageReactions[messageId][emoji] <= 0) delete messageReactions[messageId][emoji]; }
            } else {
                await supabase.from('sloppygram_message_reactions').insert({ message_id: messageId, emoji: emoji, username: profile.username, user_id: currentUser.id });
                if (!myMessageReactions[messageId]) myMessageReactions[messageId] = new Set();
                myMessageReactions[messageId].add(emoji);
                if (!messageReactions[messageId]) messageReactions[messageId] = {};
                messageReactions[messageId][emoji] = (messageReactions[messageId][emoji] || 0) + 1;
                triggerReactionConfetti(emoji);
            }
            updateMessageReactionsUI(messageId);
        };
        function triggerReactionConfetti(emoji) {
            if (typeof confetti !== 'function') return;
            var colorMap = {
                'üòÇ': ['#FFD700', '#FFA500', '#FFFF00'], 'üî•': ['#FF4500', '#FF6347', '#FFA500'],
                '‚ù§Ô∏è': ['#FF1493', '#FF69B4', '#DC143C'], 'üòÆ': ['#00CED1', '#20B2AA', '#48D1CC'],
                'üò¢': ['#4169E1', '#6495ED', '#87CEEB'], 'üëè': ['#9370DB', '#BA55D3', '#DDA0DD'],
                'üôå': ['#32CD32', '#00FA9A', '#98FB98'], 'üíÄ': ['#808080', '#A9A9A9', '#D3D3D3']
            };
            var colors = colorMap[emoji] || ['#7c9885', '#b8d4be', '#e8f0ea'];
            confetti({ particleCount: 50, spread: 60, startVelocity: 30, colors: colors, origin: { x: Math.random() * 0.4 + 0.3, y: Math.random() * 0.3 + 0.3 }, scalar: 0.8, gravity: 1.2, ticks: 150 });
            setTimeout(function() { confetti({ particleCount: 25, spread: 40, startVelocity: 20, colors: colors, origin: { x: Math.random() * 0.4 + 0.3, y: Math.random() * 0.3 + 0.4 }, scalar: 0.6, gravity: 1, ticks: 100 }); }, 150);
        }
        function updateMessageReactionsUI(messageId) {
            var container = document.getElementById('msg-reactions-' + messageId);
            if (!container) return;
            var reacts = messageReactions[messageId] || {};
            var myReacts = myMessageReactions[messageId] || new Set();
            var html = Object.entries(reacts).sort(function(a, b) { return b[1] - a[1]; }).map(function(e) {
                var isAct = myReacts.has ? myReacts.has(e[0]) : false;
                return '<button class="reaction-btn ' + (isAct ? 'active' : '') + '" onclick="toggleMessageReaction(\'' + escapeAttr(messageId) + '\', \'' + escapeAttr(e[0]) + '\')">' + escapeHtml(e[0]) + ' <span class="reaction-count">' + e[1] + '</span></button>';
            }).join('');
            var pickerHtml = REACTION_EMOJIS.map(function(em) { return '<button onclick="toggleMessageReaction(\'' + escapeAttr(messageId) + '\', \'' + escapeAttr(em) + '\')">' + em + '</button>'; }).join('');
            container.innerHTML = html + '<div style="position:relative;display:inline-block;"><button class="add-reaction-btn" onclick="toggleMsgReactionPicker(\'' + escapeAttr(messageId) + '\')">+üòÄ</button><div class="reaction-picker" id="msg-picker-' + escapeAttr(messageId) + '">' + pickerHtml + '</div></div>';
        }

        // Close reaction pickers on outside click
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.add-reaction-btn') && !e.target.closest('.reaction-picker')) {
                document.querySelectorAll('.reaction-picker.active').forEach(function(p) { p.classList.remove('active'); });
            }
        });

        // === MENTIONS & TAGS PERSISTENCE ===
        async function saveMentions(content, sourceType, sourceId) {
            if (!content || !currentUser) return;
            var regex = /@(\w+)/g;
            var mentions = [], match;
            while ((match = regex.exec(content)) !== null) {
                if (match[1] !== profile.username) mentions.push(match[1]);
            }
            if (mentions.length === 0) return;
            var rows = mentions.map(function(u) { return { mentioned_username: u, source_type: sourceType, source_id: sourceId, source_username: profile.username, seen: false, user_id: currentUser.id }; });
            try { await supabase.from('sloppygram_mentions').insert(rows); } catch (e) {}
        }

        function extractTags(text) {
            if (!text) return [];
            var tags = [], regex = /#(\w+(?:\/\w+)?)/g, match;
            while ((match = regex.exec(text)) !== null) {
                var parts = match[1].split('/');
                tags.push(parts.length === 2 ? { tag: parts[1], parent_tag: parts[0] } : { tag: parts[0], parent_tag: null });
            }
            return tags;
        }

        async function persistMessageTags(messageId, content, userId) {
            var tags = extractTags(content);
            if (tags.length === 0) return;
            var rows = tags.map(function(t) { return { message_id: messageId, tag: t.tag, parent_tag: t.parent_tag, user_id: userId }; });
            try { await supabase.from('sloppygram_message_tags').insert(rows); } catch (e) {}
        }

        // === REALTIME ===
        function broadcastMessage(msg) {
            if (realtimeChannel) {
                realtimeChannel.send({ type: 'broadcast', event: 'new_message', payload: msg });
            }
        }

        async function subscribeToMessages() {
            if (realtimeChannel) { realtimeChannel.unsubscribe(); supabase.removeChannel(realtimeChannel); }
            realtimeChannel = supabase.channel('sloppygram-global', { config: { broadcast: { self: false } } });

            realtimeChannel.on('broadcast', { event: 'new_message' }, function(payload) {
                var msg = payload.payload;
                if (!msg || seenMessageIds.has(msg.id)) return;
                seenMessageIds.add(msg.id);
                window.cachedMessages.unshift(msg);
                addMessageToUI(msg, true);
                if (isEmbed) {
                    var currentUserId = currentUser ? currentUser.id : null;
                    if (msg.user_id !== currentUserId) window.parent.postMessage({ type: 'play-notification' }, '*');
                }
            });

            realtimeChannel.on('broadcast', { event: 'global_background' }, function(payload) {
                var bgData = payload.payload;
                if (bgData && bgData.image_data) {
                    var now = Date.now();
                    if (now - lastVisualChangeTime < VISUAL_CHANGE_COOLDOWN) return;
                    lastVisualChangeTime = now;
                    var mc = document.getElementById('messagesContainer');
                    if (mc) {
                        mc.style.backgroundImage = 'url(' + bgData.image_data + ')';
                        mc.style.backgroundSize = 'cover';
                        mc.style.backgroundPosition = 'center';
                        mc.style.backgroundAttachment = 'fixed';
                        mc.style.backgroundRepeat = 'no-repeat';
                    }
                    if (isEmbed) window.parent.postMessage({ type: 'global-background', imageData: bgData.image_data, username: bgData.username }, '*');
                }
            });

            realtimeChannel.on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'sloppygram_messages' }, function(payload) {
                if (seenMessageIds.has(payload.new.id)) return;
                seenMessageIds.add(payload.new.id);
                window.cachedMessages.unshift(payload.new);
                addMessageToUI(payload.new, true);
                if (isEmbed) {
                    var currentUserId = currentUser ? currentUser.id : null;
                    if (payload.new.user_id !== currentUserId) window.parent.postMessage({ type: 'play-notification' }, '*');
                }
            });

            realtimeChannel.subscribe();
        }

        async function subscribeToVotesAndReactions() {
            chatVotesChannel = supabase.channel('sloppy-chat-votes');
            chatVotesChannel.on('postgres_changes', { event: '*', schema: 'public', table: 'sloppygram_message_votes' }, function() { loadMessageVotes(); });
            chatVotesChannel.on('postgres_changes', { event: '*', schema: 'public', table: 'sloppygram_message_reactions' }, function(payload) {
                var msgId = (payload.new && payload.new.message_id) || (payload.old && payload.old.message_id);
                if (msgId) loadMessageReactions().then(function() { updateMessageReactionsUI(msgId); });
            });
            chatVotesChannel.on('postgres_changes', { event: '*', schema: 'public', table: 'sloppygram_doodle_votes' }, function() { loadDoodleVotes(); });
            chatVotesChannel.subscribe();
        }

        // === INFINITE SCROLL ===
        document.getElementById('messagesContainer').addEventListener('scroll', function() {
            var container = this;
            if (container.scrollTop + container.clientHeight >= container.scrollHeight - 50) {
                loadMessages(true);
            }
        });

        // === POSTMESSAGE BRIDGE (embed mode) ===
        if (isEmbed) {
            window.addEventListener('message', function(e) {
                if (!e.data || !e.data.type) return;
                if (e.data.type === 'set-profile') {
                    if (e.data.profile) {
                        if (e.data.profile.username) profile.username = e.data.profile.username;
                        if (e.data.profile.avatar) profile.avatar = e.data.profile.avatar;
                        if (e.data.profile.avatarUrl) profile.avatarUrl = e.data.profile.avatarUrl;
                    }
                    if (e.data.userId && currentUser) currentUser.id = e.data.userId;
                }
                if (e.data.type === 'theme-update' && e.data.cssVars) {
                    var root = document.documentElement;
                    for (var key in e.data.cssVars) { root.style.setProperty(key, e.data.cssVars[key]); }
                }
                if (e.data.type === 'gif-selected' && e.data.url) { sendGif(e.data.url); }
                if (e.data.type === 'drawing-data' && e.data.dataUrl) { handleDrawingData(e.data.dataUrl); }
                if (e.data.type === 'background-update' && e.data.imageData) {
                    var mc = document.getElementById('messagesContainer');
                    if (mc) {
                        mc.style.backgroundImage = 'url(' + e.data.imageData + ')';
                        mc.style.backgroundSize = 'cover';
                        mc.style.backgroundPosition = 'center';
                        mc.style.backgroundAttachment = 'fixed';
                    }
                }
            });
        }

        // === HEADER SYNC (standalone mode) ===
        if (!isEmbed && window.sloppyBarOn) {
            // Apply theme changes from other tabs via header sync
            window.sloppyBarOn('theme-changed', function(e) {
                if (e.data && e.data.vars) {
                    var root = document.documentElement;
                    for (var key in e.data.vars) {
                        if (e.data.vars.hasOwnProperty(key)) root.style.setProperty(key, e.data.vars[key]);
                    }
                }
            });
        }

        // === INIT ===
        async function init() {
            await initAuth();
            await Promise.all([loadDoodleVotes(), loadMessageVotes(), loadMessageReactions()]);
            await loadMessages();
            await Promise.all([subscribeToMessages(), subscribeToVotesAndReactions()]);
            if (isEmbed) window.parent.postMessage({ type: 'chat-ready' }, '*');
        }
        init();
    </script>
</body>
</html>
