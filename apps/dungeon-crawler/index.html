<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dungeon Crawler - Classic Party RPG</title>
  <meta name="description" content="Recruit heroes, manage inventory, cast spells">
  <meta property="og:title" content="Dungeon Crawler">
  <meta property="og:description" content="Classic party RPG with spells and inventory">
  <meta property="og:url" content="https://sloppy.live/dungeon-crawler">
  <meta property="og:image" content="https://sloppy.live/dungeon-crawler/og-image.png">
  <link rel="icon" href="https://emojicdn.elk.sh/üó°Ô∏è">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { min-height: 100vh; background: #080810; font-family: monospace; color: #aaa; display: flex; flex-direction: column; align-items: center; padding: 8px; font-size: 11px; }
    .game { background: #111; border: 3px solid #333; border-radius: 6px; overflow: hidden; max-width: 100%; }
    .top-row { display: flex; }
    .viewport { width: 280px; height: 200px; position: relative; background: #000; flex-shrink: 0; }
    canvas { width: 100%; height: 100%; image-rendering: pixelated; }
    .scanlines { position: absolute; inset: 0; background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.15) 2px, rgba(0,0,0,0.15) 4px); pointer-events: none; }
    .compass { position: absolute; top: 6px; right: 6px; width: 28px; height: 28px; background: rgba(0,0,0,0.85); border: 1px solid #444; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; color: #f84; }
    .floor-info { position: absolute; top: 6px; left: 6px; padding: 3px 6px; background: rgba(0,0,0,0.85); border: 1px solid #444; font-size: 9px; }
    .msg { position: absolute; bottom: 6px; left: 6px; right: 6px; padding: 4px; background: rgba(0,0,0,0.9); border: 1px solid #444; font-size: 9px; color: #8f8; text-align: center; }
    .party-panel { width: 220px; background: #151518; border-left: 2px solid #333; padding: 6px; overflow-y: auto; max-height: 200px; }
    .panel-title { font-size: 9px; color: #666; text-transform: uppercase; letter-spacing: 1px; text-align: center; padding: 2px 0 4px; border-bottom: 1px solid #333; margin-bottom: 4px; }
    .member { background: #1a1a1e; border: 1px solid #333; border-radius: 3px; padding: 4px; margin-bottom: 4px; cursor: pointer; transition: all 0.1s; }
    .member:hover { border-color: #555; }
    .member.sel { border-color: #4af; box-shadow: 0 0 6px rgba(68,170,255,0.3); }
    .member.dead { opacity: 0.35; }
    .mem-top { display: flex; align-items: center; gap: 4px; margin-bottom: 2px; }
    .mem-icon { font-size: 14px; }
    .mem-name { font-size: 10px; font-weight: bold; color: #ddd; flex: 1; }
    .mem-lv { font-size: 9px; color: #4af; }
    .bars { display: flex; flex-direction: column; gap: 1px; }
    .bar-row { display: flex; align-items: center; gap: 3px; }
    .bar-lbl { font-size: 7px; width: 14px; color: #666; }
    .bar { flex: 1; height: 5px; background: #333; border-radius: 2px; overflow: hidden; }
    .bar-fill { height: 100%; }
    .hp-f { background: linear-gradient(90deg, #a00, #f44); }
    .mp-f { background: linear-gradient(90deg, #00a, #44f); }
    .xp-f { background: linear-gradient(90deg, #0a0, #4f4); }
    .bar-val { font-size: 7px; width: 28px; text-align: right; color: #888; }
    .bottom { display: flex; background: #151518; border-top: 2px solid #333; }
    .controls { display: grid; grid-template-columns: repeat(3, 32px); gap: 3px; padding: 6px; }
    .ctrl { width: 32px; height: 26px; background: #222; border: 1px solid #444; border-radius: 3px; color: #888; font-size: 12px; cursor: pointer; }
    .ctrl:hover { background: #333; }
    .ctrl:active { background: #444; }
    .actions { flex: 1; padding: 6px; display: flex; flex-wrap: wrap; gap: 4px; align-content: flex-start; }
    .act { padding: 4px 8px; background: #222; border: 1px solid #444; border-radius: 3px; color: #aaa; font-size: 9px; cursor: pointer; }
    .act:hover { background: #333; border-color: #666; }
    .act:disabled { opacity: 0.3; cursor: not-allowed; }
    .act.atk { background: #311; border-color: #633; color: #f88; }
    .act.mag { background: #113; border-color: #336; color: #88f; }
    .act.itm { background: #131; border-color: #363; color: #8f8; }
    .tabs { display: flex; border-bottom: 1px solid #333; }
    .tab { flex: 1; padding: 4px; text-align: center; font-size: 9px; cursor: pointer; background: #1a1a1e; border: none; color: #888; }
    .tab.active { background: #252530; color: #fff; border-bottom: 2px solid #4af; }
    .inv-panel { display: none; padding: 6px; }
    .inv-panel.show { display: block; }
    .spell-panel { display: none; padding: 6px; }
    .spell-panel.show { display: block; }
    .inv-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }
    .inv-slot { aspect-ratio: 1; background: #222; border: 1px solid #444; border-radius: 3px; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; position: relative; }
    .inv-slot:hover { border-color: #666; }
    .inv-slot.empty { opacity: 0.3; }
    .inv-qty { position: absolute; bottom: 1px; right: 2px; font-size: 8px; color: #fff; text-shadow: 0 0 2px #000; }
    .spell-list { display: flex; flex-direction: column; gap: 3px; max-height: 120px; overflow-y: auto; }
    .spell { padding: 4px 6px; background: #1a1a2e; border: 1px solid #336; border-radius: 3px; cursor: pointer; display: flex; justify-content: space-between; }
    .spell:hover { border-color: #558; background: #252540; }
    .spell.disabled { opacity: 0.4; cursor: not-allowed; }
    .spell-name { color: #aaf; font-size: 9px; }
    .spell-cost { color: #66a; font-size: 8px; }
    .overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; padding: 15px; }
    .overlay.show { display: flex; }
    .ovr-title { font-size: 16px; margin-bottom: 8px; }
    .ovr-title.win { color: #4f4; }
    .ovr-title.lose { color: #f44; }
    .ovr-title.start { color: #4af; }
    .ovr-text { font-size: 10px; text-align: center; line-height: 1.5; margin-bottom: 12px; }
    .ovr-btn { padding: 6px 18px; background: #333; border: 1px solid #666; color: #aaa; cursor: pointer; font-size: 10px; }
    .ovr-btn:hover { background: #444; }
    .combat-ovr { background: rgba(20,0,0,0.95); }
    .mon-sprite { font-size: 42px; animation: bob 0.5s ease infinite alternate; }
    @keyframes bob { from { transform: translateY(-2px); } to { transform: translateY(2px); } }
    .mon-name { color: #f66; font-size: 12px; margin: 4px 0; }
    .mon-hp-bar { width: 100px; height: 6px; background: #333; border: 1px solid #555; margin: 4px auto; }
    .mon-hp-fill { height: 100%; background: linear-gradient(90deg, #a00, #f44); }
    .combat-log { font-size: 9px; color: #8f8; min-height: 24px; text-align: center; }
    .recruit-ovr { background: rgba(0,20,0,0.95); }
    .recruit-info { text-align: center; margin: 10px 0; }
    .recruit-icon { font-size: 32px; }
    .recruit-name { color: #8f8; font-size: 14px; margin-top: 4px; }
    .recruit-class { color: #888; font-size: 10px; }
    .recruit-btns { display: flex; gap: 10px; margin-top: 10px; }
    .back-link { margin-top: 8px; color: #444; text-decoration: none; font-size: 9px; }
    .back-link:hover { color: #666; }
    @media (max-width: 520px) { .top-row { flex-direction: column; } .party-panel { width: 100%; max-height: 150px; border-left: none; border-top: 2px solid #333; } .viewport { width: 100%; height: 180px; } }
  </style>
</head>
<body>
  <div class="game">
    <div class="top-row">
      <div class="viewport">
        <canvas id="cv" width="280" height="200"></canvas>
        <div class="scanlines"></div>
        <div class="compass" id="compass">N</div>
        <div class="floor-info">Floor <span id="floor">1</span></div>
        <div class="msg" id="msg">WASD to move. Recruit heroes, find loot!</div>
        <div class="overlay combat-ovr" id="combatOvr">
          <div class="mon-sprite" id="monSprite">üëπ</div>
          <div class="mon-name" id="monName">Goblin</div>
          <div class="mon-hp-bar"><div class="mon-hp-fill" id="monHp"></div></div>
          <div class="combat-log" id="combatLog"></div>
        </div>
        <div class="overlay recruit-ovr" id="recruitOvr">
          <div class="ovr-title win">Hero Found!</div>
          <div class="recruit-info">
            <div class="recruit-icon" id="recruitIcon">üßô</div>
            <div class="recruit-name" id="recruitName">Aria</div>
            <div class="recruit-class" id="recruitClass">Mage</div>
          </div>
          <div class="recruit-btns">
            <button class="ovr-btn" onclick="recruitHero(true)">Recruit</button>
            <button class="ovr-btn" onclick="recruitHero(false)">Leave</button>
          </div>
        </div>
        <div class="overlay" id="gameOverOvr">
          <div class="ovr-title lose">Party Defeated</div>
          <div class="ovr-text">Reached floor <span id="finalFloor">1</span></div>
          <button class="ovr-btn" onclick="restart()">New Game</button>
        </div>
        <div class="overlay show" id="startOvr">
          <div class="ovr-title start">‚öîÔ∏è DUNGEON CRAWLER</div>
          <div class="ovr-text">Recruit up to 6 heroes!<br>Find items and cast spells.<br>Classic RPG adventure.</div>
          <button class="ovr-btn" onclick="startGame()">Begin Quest</button>
        </div>
      </div>
      <div class="party-panel">
        <div class="tabs">
          <button class="tab active" onclick="showTab('party')">Party</button>
          <button class="tab" onclick="showTab('inv')">Items</button>
          <button class="tab" onclick="showTab('spell')">Spells</button>
        </div>
        <div id="partyTab" class="inv-panel show"></div>
        <div id="invTab" class="inv-panel"></div>
        <div id="spellTab" class="spell-panel"></div>
      </div>
    </div>
    <div class="bottom">
      <div class="controls">
        <div></div><button class="ctrl" onclick="move('f')">‚Üë</button><div></div>
        <button class="ctrl" onclick="move('l')">‚Üê</button>
        <button class="ctrl" onclick="move('b')">‚Üì</button>
        <button class="ctrl" onclick="move('r')">‚Üí</button>
      </div>
      <div class="actions" id="acts">
        <button class="act atk" onclick="doAct('atk')">‚öîÔ∏èAttack</button>
        <button class="act mag" onclick="doAct('spell')">‚ú®Spell</button>
        <button class="act itm" onclick="doAct('item')">üéíItem</button>
        <button class="act" onclick="doAct('def')">üõ°Ô∏èDefend</button>
      </div>
    </div>
  </div>
  <a href="https://sloppy.live" class="back-link">sloppy.live</a>

<script>
const cv = document.getElementById('cv'), cx = cv.getContext('2d');
const classes = {
  warrior: { n: 'Warrior', i: 'üõ°Ô∏è', hp: 32, mp: 8, atk: 9, def: 7, mag: 2, spells: ['bash','taunt'] },
  mage: { n: 'Mage', i: 'üîÆ', hp: 18, mp: 30, atk: 3, def: 3, mag: 10, spells: ['fire','ice','bolt'] },
  rogue: { n: 'Rogue', i: 'üó°Ô∏è', hp: 24, mp: 12, atk: 8, def: 4, mag: 3, spells: ['poison','steal'] },
  cleric: { n: 'Cleric', i: '‚úùÔ∏è', hp: 26, mp: 25, atk: 5, def: 5, mag: 7, spells: ['heal','cure','smite'] },
  ranger: { n: 'Ranger', i: 'üèπ', hp: 22, mp: 15, atk: 7, def: 4, mag: 5, spells: ['arrow','trap'] },
  paladin: { n: 'Paladin', i: '‚öîÔ∏è', hp: 30, mp: 18, atk: 7, def: 6, mag: 5, spells: ['smite','heal'] }
};
const spells = {
  fire: { n: 'üî• Fireball', mp: 6, dmg: 18, type: 'atk' },
  ice: { n: '‚ùÑÔ∏è Ice Shard', mp: 5, dmg: 14, type: 'atk' },
  bolt: { n: '‚ö° Lightning', mp: 8, dmg: 24, type: 'atk' },
  heal: { n: 'üíö Heal', mp: 6, heal: 20, type: 'heal' },
  cure: { n: '‚ú® Cure All', mp: 12, heal: 12, type: 'healall' },
  smite: { n: '‚òÄÔ∏è Holy Smite', mp: 7, dmg: 16, type: 'atk' },
  poison: { n: '‚ò†Ô∏è Poison', mp: 4, dmg: 10, dot: 3, type: 'dot' },
  steal: { n: 'üí∞ Steal', mp: 3, type: 'steal' },
  bash: { n: 'üí• Shield Bash', mp: 5, dmg: 12, stun: true, type: 'atk' },
  taunt: { n: 'üò§ Taunt', mp: 4, type: 'taunt' },
  arrow: { n: 'üèπ Power Shot', mp: 5, dmg: 15, type: 'atk' },
  trap: { n: 'ü™§ Set Trap', mp: 6, dmg: 20, type: 'trap' }
};
const items = {
  hpot: { n: '‚ù§Ô∏è HP Potion', use: 'hp', val: 25, stack: true },
  mpot: { n: 'üíô MP Potion', use: 'mp', val: 15, stack: true },
  elixir: { n: 'üíú Elixir', use: 'both', val: 20, stack: true },
  sword: { n: 'üó°Ô∏è Steel Sword', eq: 'wep', atk: 3 },
  staff: { n: 'ü™Ñ Magic Staff', eq: 'wep', mag: 4 },
  shield: { n: 'üõ°Ô∏è Iron Shield', eq: 'arm', def: 3 },
  robe: { n: 'üß• Mage Robe', eq: 'arm', mag: 2, mp: 10 },
  ring: { n: 'üíç Power Ring', eq: 'acc', atk: 2, mag: 2 }
};
const mons = [
  { n: 'Rat', s: 'üêÄ', hp: 10, atk: 4, def: 1, xp: 10 },
  { n: 'Goblin', s: 'üë∫', hp: 18, atk: 6, def: 2, xp: 18 },
  { n: 'Skeleton', s: 'üíÄ', hp: 28, atk: 9, def: 3, xp: 28 },
  { n: 'Orc', s: 'üëπ', hp: 40, atk: 12, def: 5, xp: 40 },
  { n: 'Demon', s: 'üëø', hp: 55, atk: 16, def: 7, xp: 55 },
  { n: 'Dragon', s: 'üêâ', hp: 90, atk: 22, def: 10, xp: 120 }
];
const names = ['Aldric','Lyra','Theron','Mira','Kael','Zara','Finn','Nova','Rex','Luna','Dax','Ivy','Jax','Cleo'];

let party = [], sel = 0, inv = [], pos = {x:1,y:1,d:0}, floor = 1, combat = false, mon = null, started = false, pendingRecruit = null;
const dirs = ['N','E','S','W'], dx = [0,1,0,-1], dy = [-1,0,1,0];
let map = [], mapSz = 12;
const col = { ceil: '#1a1a2e', floor: '#2d2d44', wF: '#3d3d5c', wM: '#4d4d6c', wN: '#5d5d7c', wS: '#2d2d44' };

function mkChar(cls, name) {
  const c = classes[cls];
  return { name, cls, cd: c, lv: 1, xp: 0, hp: c.hp, mhp: c.hp, mp: c.mp, mmp: c.mp, atk: c.atk, def: c.def, mag: c.mag, dead: false, defending: false, eq: {} };
}
function initParty() {
  const sn = [...names].sort(() => Math.random() - 0.5);
  party = [mkChar('warrior', sn[0]), mkChar('cleric', sn[1])];
  sel = 0;
  inv = [{id:'hpot',q:3},{id:'mpot',q:2}];
}
function rndClass() { const k = Object.keys(classes); return k[Math.floor(Math.random()*k.length)]; }

function renderParty() {
  const t = document.getElementById('partyTab');
  t.innerHTML = '';
  party.forEach((m, i) => {
    const d = document.createElement('div');
    d.className = 'member' + (i === sel ? ' sel' : '') + (m.dead ? ' dead' : '');
    d.onclick = () => { if (!m.dead) { sel = i; renderParty(); } };
    const hp = (m.hp / m.mhp * 100).toFixed(0), mp = (m.mp / m.mmp * 100).toFixed(0), xpN = m.lv * 30, xp = (m.xp / xpN * 100).toFixed(0);
    d.innerHTML = `<div class="mem-top"><span class="mem-icon">${m.cd.i}</span><span class="mem-name">${m.name}</span><span class="mem-lv">Lv${m.lv}</span></div>
      <div class="bars"><div class="bar-row"><span class="bar-lbl">HP</span><div class="bar"><div class="bar-fill hp-f" style="width:${hp}%"></div></div><span class="bar-val">${m.hp}/${m.mhp}</span></div>
      <div class="bar-row"><span class="bar-lbl">MP</span><div class="bar"><div class="bar-fill mp-f" style="width:${mp}%"></div></div><span class="bar-val">${m.mp}/${m.mmp}</span></div>
      <div class="bar-row"><span class="bar-lbl">XP</span><div class="bar"><div class="bar-fill xp-f" style="width:${Math.min(100,xp)}%"></div></div><span class="bar-val">${m.xp}/${xpN}</span></div></div>`;
    t.appendChild(d);
  });
}
function renderInv() {
  const t = document.getElementById('invTab');
  t.innerHTML = '<div class="inv-grid">' + inv.map((it, i) => {
    const d = items[it.id];
    return `<div class="inv-slot" onclick="useItem(${i})" title="${d.n}">${d.n.split(' ')[0]}${it.q > 1 ? `<span class="inv-qty">${it.q}</span>` : ''}</div>`;
  }).join('') + Array(Math.max(0, 12 - inv.length)).fill('<div class="inv-slot empty"></div>').join('') + '</div>';
}
function renderSpells() {
  const t = document.getElementById('spellTab'), m = party[sel];
  if (!m) { t.innerHTML = ''; return; }
  t.innerHTML = '<div class="spell-list">' + m.cd.spells.map(sid => {
    const sp = spells[sid], canCast = m.mp >= sp.mp && !m.dead;
    return `<div class="spell${canCast ? '' : ' disabled'}" onclick="${canCast ? `castSpell('${sid}')` : ''}""><span class="spell-name">${sp.n}</span><span class="spell-cost">${sp.mp} MP</span></div>`;
  }).join('') + '</div>';
}
function showTab(tab) {
  document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', ['party','inv','spell'][i] === tab));
  document.getElementById('partyTab').classList.toggle('show', tab === 'party');
  document.getElementById('invTab').classList.toggle('show', tab === 'inv');
  document.getElementById('spellTab').classList.toggle('show', tab === 'spell');
  if (tab === 'inv') renderInv();
  if (tab === 'spell') renderSpells();
  if (tab === 'party') renderParty();
}

function genMap() {
  map = [];
  for (let y = 0; y < mapSz; y++) { map[y] = []; for (let x = 0; x < mapSz; x++) map[y][x] = (x === 0 || y === 0 || x === mapSz-1 || y === mapSz-1) ? 1 : (Math.random() > 0.72 ? 1 : 0); }
  map[1][1] = map[1][2] = map[2][1] = 0;
  let p = false;
  while (!p) { const x = 2 + Math.floor(Math.random()*(mapSz-4)), y = 2 + Math.floor(Math.random()*(mapSz-4)); if (map[y][x] === 0 && (x > 4 || y > 4)) { map[y][x] = 2; p = true; } }
  for (let i = 0; i < 4 + floor; i++) { p = false; while (!p) { const x = 1 + Math.floor(Math.random()*(mapSz-2)), y = 1 + Math.floor(Math.random()*(mapSz-2)); if (map[y][x] === 0 && (x > 2 || y > 2)) { map[y][x] = 3; p = true; } } }
  for (let i = 0; i < 2; i++) { p = false; while (!p) { const x = 1 + Math.floor(Math.random()*(mapSz-2)), y = 1 + Math.floor(Math.random()*(mapSz-2)); if (map[y][x] === 0) { map[y][x] = 4; p = true; } } }
  if (floor % 2 === 0 && party.length < 6) { p = false; while (!p) { const x = 1 + Math.floor(Math.random()*(mapSz-2)), y = 1 + Math.floor(Math.random()*(mapSz-2)); if (map[y][x] === 0) { map[y][x] = 5; p = true; } } }
  pos = {x:1,y:1,d:0};
}
function tile(x,y) { return (x < 0 || y < 0 || x >= mapSz || y >= mapSz) ? 1 : map[y][x]; }

function move(d) {
  if (combat || !started) return;
  let nx = pos.x, ny = pos.y;
  if (d === 'f') { nx += dx[pos.d]; ny += dy[pos.d]; }
  else if (d === 'b') { nx -= dx[pos.d]; ny -= dy[pos.d]; }
  else if (d === 'l') { pos.d = (pos.d + 3) % 4; updCompass(); render(); return; }
  else if (d === 'r') { pos.d = (pos.d + 1) % 4; updCompass(); render(); return; }
  if (tile(nx, ny) !== 1) {
    pos.x = nx; pos.y = ny;
    const t = tile(nx, ny);
    if (t === 2) { floor++; msg('Descending to floor ' + floor + '...'); document.getElementById('floor').textContent = floor; party.forEach(m => { if (!m.dead) m.mp = Math.min(m.mmp, m.mp + 5); }); genMap(); renderParty(); }
    else if (t === 3) startCombat();
    else if (t === 4) { findLoot(); map[ny][nx] = 0; }
    else if (t === 5) { showRecruit(); map[ny][nx] = 0; }
  } else msg("Can't go there.");
  render();
}
function findLoot() {
  const r = Math.random();
  if (r < 0.4) { addItem('hpot'); msg('Found HP Potion!'); }
  else if (r < 0.7) { addItem('mpot'); msg('Found MP Potion!'); }
  else if (r < 0.85) { const eq = ['sword','staff','shield','robe','ring'][Math.floor(Math.random()*5)]; addItem(eq); msg('Found ' + items[eq].n + '!'); }
  else { addItem('elixir'); msg('Found Elixir!'); }
  renderInv();
}
function addItem(id) {
  const d = items[id], ex = inv.find(i => i.id === id && d.stack);
  if (ex) ex.q++;
  else if (inv.length < 12) inv.push({id, q: 1});
}
function useItem(i) {
  if (!combat) { msg('Use items in combat!'); return; }
  const it = inv[i]; if (!it) return;
  const d = items[it.id], m = party[sel];
  if (!m || m.dead) return;
  if (d.use === 'hp') { m.hp = Math.min(m.mhp, m.hp + d.val); msg(`${m.name} uses ${d.n}! +${d.val} HP`); }
  else if (d.use === 'mp') { m.mp = Math.min(m.mmp, m.mp + d.val); msg(`${m.name} uses ${d.n}! +${d.val} MP`); }
  else if (d.use === 'both') { m.hp = Math.min(m.mhp, m.hp + d.val); m.mp = Math.min(m.mmp, m.mp + d.val); msg(`${m.name} uses ${d.n}!`); }
  it.q--; if (it.q <= 0) inv.splice(i, 1);
  renderParty(); renderInv(); monTurn();
}
function showRecruit() {
  const cls = rndClass(), nm = names[Math.floor(Math.random()*names.length)];
  pendingRecruit = mkChar(cls, nm);
  document.getElementById('recruitIcon').textContent = classes[cls].i;
  document.getElementById('recruitName').textContent = nm;
  document.getElementById('recruitClass').textContent = classes[cls].n;
  document.getElementById('recruitOvr').classList.add('show');
}
function recruitHero(yes) {
  document.getElementById('recruitOvr').classList.remove('show');
  if (yes && party.length < 6) { party.push(pendingRecruit); msg(pendingRecruit.name + ' joins!'); renderParty(); }
  else if (yes) msg('Party full!');
  pendingRecruit = null;
}

function startCombat() {
  combat = true;
  const ti = Math.min(Math.floor(floor / 2), mons.length - 1), mt = mons[ti], sc = 1 + floor * 0.15;
  mon = { ...mt, hp: Math.floor(mt.hp * sc), mhp: Math.floor(mt.hp * sc), atk: Math.floor(mt.atk * sc), def: Math.floor(mt.def * sc), poisoned: 0, stunned: false };
  document.getElementById('monSprite').textContent = mon.s;
  document.getElementById('monName').textContent = mon.n + ' Lv' + (floor + ti);
  document.getElementById('monHp').style.width = '100%';
  document.getElementById('combatLog').textContent = mon.n + ' appears!';
  document.getElementById('combatOvr').classList.add('show');
  party.forEach(m => m.defending = false);
}
function doAct(a) {
  if (!combat || !mon) return;
  const m = party[sel]; if (!m || m.dead) return;
  if (a === 'atk') {
    const dmg = Math.max(1, m.atk + (m.eq.wep ? items[m.eq.wep].atk || 0 : 0) - mon.def + Math.floor(Math.random()*4));
    mon.hp -= dmg; msg(`${m.name} attacks for ${dmg}!`);
  } else if (a === 'def') { m.defending = true; msg(`${m.name} defends!`); }
  else if (a === 'spell') { showTab('spell'); return; }
  else if (a === 'item') { showTab('inv'); return; }
  updMon(); if (mon.hp <= 0) endCombat(true); else monTurn();
}
function castSpell(sid) {
  if (!combat || !mon) return;
  const m = party[sel], sp = spells[sid];
  if (!m || m.dead || m.mp < sp.mp) return;
  m.mp -= sp.mp;
  const mgBonus = m.mag + (m.eq.wep && items[m.eq.wep].mag ? items[m.eq.wep].mag : 0);
  if (sp.type === 'atk') {
    const dmg = Math.floor(sp.dmg * (1 + mgBonus * 0.1)) + Math.floor(Math.random()*5);
    mon.hp -= dmg; msg(`${m.name} casts ${sp.n} for ${dmg}!`);
  } else if (sp.type === 'heal') {
    const alive = party.filter(p => !p.dead).sort((a,b) => a.hp/a.mhp - b.hp/b.mhp)[0];
    const heal = Math.floor(sp.heal * (1 + mgBonus * 0.08));
    alive.hp = Math.min(alive.mhp, alive.hp + heal);
    msg(`${m.name} heals ${alive.name} for ${heal}!`);
  } else if (sp.type === 'healall') {
    const heal = Math.floor(sp.heal * (1 + mgBonus * 0.05));
    party.forEach(p => { if (!p.dead) p.hp = Math.min(p.mhp, p.hp + heal); });
    msg(`${m.name} heals all for ${heal}!`);
  } else if (sp.type === 'dot') {
    mon.hp -= sp.dmg; mon.poisoned = sp.dot;
    msg(`${m.name} poisons for ${sp.dmg}!`);
  } else if (sp.type === 'steal') {
    if (Math.random() > 0.5) { addItem('hpot'); msg(`${m.name} steals an item!`); }
    else msg(`${m.name}'s steal failed!`);
  } else if (sp.type === 'taunt') {
    msg(`${m.name} taunts the enemy!`);
  } else if (sp.type === 'trap') {
    mon.hp -= sp.dmg; msg(`${m.name} sets trap for ${sp.dmg}!`);
  }
  renderParty(); renderSpells(); updMon();
  if (mon.hp <= 0) endCombat(true); else monTurn();
}
function monTurn() {
  if (!mon || mon.hp <= 0) return;
  if (mon.poisoned > 0) { mon.hp -= 5; mon.poisoned--; msg(`${mon.n} takes poison damage!`); updMon(); if (mon.hp <= 0) { endCombat(true); return; } }
  if (mon.stunned) { mon.stunned = false; msg(`${mon.n} is stunned!`); return; }
  setTimeout(() => {
    const alive = party.filter(p => !p.dead);
    if (!alive.length) { endCombat(false); return; }
    const tgt = alive[Math.floor(Math.random() * alive.length)];
    let dmg = Math.max(1, mon.atk - tgt.def - (tgt.eq.arm ? items[tgt.eq.arm].def || 0 : 0) + Math.floor(Math.random()*3));
    if (tgt.defending) dmg = Math.floor(dmg * 0.5);
    tgt.hp -= dmg;
    msg(`${mon.n} hits ${tgt.name} for ${dmg}!`);
    if (tgt.hp <= 0) { tgt.hp = 0; tgt.dead = true; msg(`${tgt.name} falls!`); const next = party.findIndex(p => !p.dead); if (next >= 0) sel = next; }
    renderParty();
    if (party.every(p => p.dead)) setTimeout(() => endCombat(false), 400);
  }, 500);
}
function updMon() { document.getElementById('monHp').style.width = Math.max(0, mon.hp / mon.mhp * 100) + '%'; }
function endCombat(win) {
  combat = false;
  document.getElementById('combatOvr').classList.remove('show');
  party.forEach(m => m.defending = false);
  if (win) {
    map[pos.y][pos.x] = 0;
    const xpG = mon.xp;
    party.forEach(m => { if (!m.dead) {
      m.xp += xpG;
      const need = m.lv * 30;
      if (m.xp >= need) { m.xp -= need; m.lv++; m.mhp += 5; m.hp = m.mhp; m.mmp += 3; m.mp = m.mmp; m.atk += 1; m.def += 1; m.mag += 1; msg(`${m.name} leveled up!`); }
    }});
    msg(`Victory! +${xpG} XP`); mon = null; renderParty(); render();
  } else {
    document.getElementById('finalFloor').textContent = floor;
    document.getElementById('gameOverOvr').classList.add('show');
  }
}

function msg(t) { document.getElementById('msg').textContent = t; document.getElementById('combatLog').textContent = t; }
function updCompass() { document.getElementById('compass').textContent = dirs[pos.d]; }
function render() {
  cx.fillStyle = col.ceil; cx.fillRect(0, 0, cv.width, cv.height / 2);
  cx.fillStyle = col.floor; cx.fillRect(0, cv.height / 2, cv.width, cv.height / 2);
  draw3D();
}
function draw3D() {
  const lx = pos.x + dx[pos.d], ly = pos.y + dy[pos.d];
  const l2x = pos.x + dx[pos.d]*2, l2y = pos.y + dy[pos.d]*2;
  const l3x = pos.x + dx[pos.d]*3, l3y = pos.y + dy[pos.d]*3;
  const ld = (pos.d + 3) % 4, rd = (pos.d + 1) % 4;
  [3,2,1].forEach(dist => {
    const lkx = pos.x + dx[pos.d]*dist, lky = pos.y + dy[pos.d]*dist;
    if (tile(lkx + dx[ld], lky + dy[ld]) === 1) drawW(0, dist);
    if (tile(lkx, lky) === 1) drawW(1, dist);
    else drawIcon(lkx, lky, dist);
    if (tile(lkx + dx[rd], lky + dy[rd]) === 1) drawW(2, dist);
  });
  if (tile(pos.x + dx[ld], pos.y + dy[ld]) === 1) drawSide('l');
  if (tile(pos.x + dx[rd], pos.y + dy[rd]) === 1) drawSide('r');
}
function drawW(p, d) {
  const dp = {3:{y:70,h:60,w:56},2:{y:50,h:100,w:84},1:{y:20,h:160,w:126}};
  const dt = dp[d], bx = p === 0 ? 14 : (p === 1 ? 98 : 182), x = bx + (3-d)*(p===0?14:(p===2?-14:0));
  cx.fillStyle = d===3?col.wF:d===2?col.wM:col.wN;
  cx.fillRect(x, dt.y, dt.w - (3-d)*14, dt.h);
}
function drawSide(s) {
  cx.fillStyle = col.wS; cx.beginPath();
  if (s === 'l') { cx.moveTo(0,0); cx.lineTo(28,35); cx.lineTo(28,165); cx.lineTo(0,200); }
  else { cx.moveTo(280,0); cx.lineTo(252,35); cx.lineTo(252,165); cx.lineTo(280,200); }
  cx.fill();
}
function drawIcon(x, y, d) {
  const t = tile(x, y); if (t < 2) return;
  const sz = {3:14,2:24,1:36}, yp = {3:95,2:88,1:80};
  let ic = t===2?'üö™':t===3?'üëπ':t===4?'üì¶':t===5?'üßô':'';
  cx.font = sz[d] + 'px serif'; cx.textAlign = 'center';
  cx.fillText(ic, 140, yp[d] + sz[d]/2);
}

document.addEventListener('keydown', e => {
  if (!started) return;
  if (e.key === 'ArrowUp' || e.key === 'w') { e.preventDefault(); move('f'); }
  else if (e.key === 'ArrowDown' || e.key === 's') { e.preventDefault(); move('b'); }
  else if (e.key === 'ArrowLeft' || e.key === 'a') { e.preventDefault(); move('l'); }
  else if (e.key === 'ArrowRight' || e.key === 'd') { e.preventDefault(); move('r'); }
  else if (e.key === ' ') { e.preventDefault(); doAct('atk'); }
  else if (e.key >= '1' && e.key <= '6') { const i = parseInt(e.key)-1; if (party[i] && !party[i].dead) { sel = i; renderParty(); renderSpells(); } }
});
function startGame() {
  document.getElementById('startOvr').classList.remove('show');
  started = true; initParty(); floor = 1;
  document.getElementById('floor').textContent = 1;
  genMap(); renderParty(); render();
  msg('Your quest begins!');
}
function restart() {
  document.getElementById('gameOverOvr').classList.remove('show');
  startGame();
}
render();
</script>
</body>
</html>
