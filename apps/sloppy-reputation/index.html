<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sloppy Reputation</title>
  <link rel="icon" href="https://emojicdn.elk.sh/üõ°Ô∏è" type="image/png">
  <meta property="og:title" content="Sloppy Reputation">
  <meta property="og:description" content="Live karma & trust dashboard ‚Äî see your reputation pulse in real time">
  <meta property="og:url" content="https://sloppy.live/sloppy-reputation">
  <meta property="og:image" content="https://sloppy.live/sloppy-reputation/og-image.png">
  <meta property="og:type" content="website">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lexend+Mega:wght@700;900&family=Red+Hat+Mono:wght@400;600&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #060d10;
      --surface: #0c1a20;
      --primary: #00e5cc;
      --secondary: #0099ff;
      --warning: #ff6b4a;
      --text: #c0dde8;
      --text-dim: #5a7a8a;
      --glow: 0 0 12px rgba(0,229,204,0.3);
      --glow-strong: 0 0 24px rgba(0,229,204,0.5);
    }

    body {
      font-family: 'Red Hat Mono', monospace;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Circuit board background */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      z-index: 0;
      background:
        radial-gradient(circle 1.5px at 40px 40px, #0d2a30 100%, transparent 100%),
        radial-gradient(circle 1.5px at 80px 80px, #0d2a30 100%, transparent 100%),
        linear-gradient(to right, #0a1a1f 1px, transparent 1px),
        linear-gradient(to bottom, #0a1a1f 1px, transparent 1px);
      background-size: 120px 120px, 120px 120px, 60px 60px, 60px 60px;
      opacity: 0.4;
      pointer-events: none;
    }

    .app-wrap {
      position: relative;
      z-index: 1;
      max-width: 720px;
      margin: 0 auto;
      padding: 24px 16px 80px;
    }

    /* Header */
    .app-title {
      font-family: 'Lexend Mega', sans-serif;
      font-weight: 900;
      font-size: 1.6rem;
      letter-spacing: 0.05em;
      color: var(--primary);
      text-shadow: var(--glow);
      margin-bottom: 6px;
    }

    .app-subtitle {
      font-size: 0.72rem;
      color: var(--text-dim);
      letter-spacing: 0.12em;
      text-transform: uppercase;
      margin-bottom: 24px;
    }

    /* Profile strip */
    .profile-strip {
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--surface);
      border: 1px solid #152830;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 20px;
    }

    .profile-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: 2px solid var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      background: var(--bg);
      overflow: hidden;
      flex-shrink: 0;
    }

    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-info {
      flex: 1;
      min-width: 0;
    }

    .profile-name {
      font-family: 'Lexend Mega', sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .profile-badges {
      display: flex;
      gap: 6px;
      margin-top: 3px;
    }

    .badge {
      font-size: 0.6rem;
      padding: 2px 6px;
      border-radius: 3px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 600;
    }

    .badge-auth {
      background: rgba(0,153,255,0.15);
      color: var(--secondary);
      border: 1px solid rgba(0,153,255,0.3);
    }

    .badge-premium {
      background: rgba(255,215,0,0.12);
      color: #ffd700;
      border: 1px solid rgba(255,215,0,0.3);
    }

    /* Dashboard grid */
    .dash-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 20px;
    }

    @media (max-width: 520px) {
      .dash-grid { grid-template-columns: 1fr; }
    }

    .card {
      background: var(--surface);
      border: 1px solid #152830;
      border-radius: 8px;
      padding: 20px;
    }

    .card-label {
      font-size: 0.6rem;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-bottom: 12px;
    }

    /* Trust Ring */
    .trust-ring-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .trust-svg {
      width: 160px;
      height: 160px;
    }

    .trust-track {
      fill: none;
      stroke: #152830;
      stroke-width: 10;
    }

    .trust-arc {
      fill: none;
      stroke-width: 10;
      stroke-linecap: round;
      transition: stroke-dashoffset 1s cubic-bezier(0.4,0,0.2,1), stroke 0.5s;
    }

    .trust-center-num {
      font-family: 'Lexend Mega', sans-serif;
      font-weight: 900;
      font-size: 28px;
      fill: #fff;
      text-anchor: middle;
    }

    .trust-center-label {
      font-family: 'Red Hat Mono', monospace;
      font-size: 9px;
      fill: var(--text-dim);
      text-anchor: middle;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    /* Karma Gauge */
    .karma-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .karma-num {
      font-family: 'Lexend Mega', sans-serif;
      font-weight: 900;
      font-size: 3rem;
      color: #fff;
      line-height: 1;
      position: relative;
    }

    .karma-label {
      font-size: 0.65rem;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      margin-top: 4px;
    }

    .karma-rank {
      margin-top: 8px;
      font-size: 0.72rem;
      color: var(--secondary);
      font-weight: 600;
    }

    .karma-delta {
      position: absolute;
      top: -12px;
      right: -32px;
      font-family: 'Red Hat Mono', monospace;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--primary);
      opacity: 0;
      pointer-events: none;
    }

    .karma-delta.pop {
      animation: deltaPop 1.4s ease-out forwards;
    }

    @keyframes deltaPop {
      0% { opacity: 1; transform: translateY(0); }
      70% { opacity: 1; }
      100% { opacity: 0; transform: translateY(-30px); }
    }

    /* Verification Badges */
    .verif-section {
      margin-bottom: 20px;
    }

    .verif-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .verif-card {
      background: var(--surface);
      border: 1px solid #152830;
      border-radius: 8px;
      padding: 14px 10px;
      text-align: center;
      transition: border-color 0.4s, box-shadow 0.4s;
    }

    .verif-card.verified {
      border-color: rgba(0,229,204,0.4);
      box-shadow: var(--glow);
    }

    .verif-icon {
      font-size: 1.4rem;
      margin-bottom: 6px;
    }

    .verif-card.verified .verif-icon { color: var(--primary); }
    .verif-card:not(.verified) .verif-icon { color: var(--text-dim); opacity: 0.4; }

    .verif-name {
      font-size: 0.62rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-dim);
      margin-bottom: 4px;
    }

    .verif-status {
      font-size: 0.58rem;
      font-weight: 600;
      letter-spacing: 0.08em;
    }

    .verif-card.verified .verif-status { color: var(--primary); }
    .verif-card:not(.verified) .verif-status { color: var(--text-dim); }

    /* Tier section */
    .tier-section {
      margin-bottom: 20px;
    }

    .tier-card {
      background: var(--surface);
      border: 1px solid #152830;
      border-radius: 8px;
      padding: 18px 20px;
    }

    .tier-top {
      display: flex;
      align-items: baseline;
      gap: 10px;
      margin-bottom: 10px;
    }

    .tier-level {
      font-family: 'Lexend Mega', sans-serif;
      font-weight: 900;
      font-size: 1.1rem;
      color: #fff;
    }

    .tier-name {
      font-size: 0.75rem;
      color: var(--primary);
      font-weight: 600;
    }

    .tier-bar-wrap {
      background: #152830;
      border-radius: 4px;
      height: 8px;
      overflow: hidden;
    }

    .tier-bar-fill {
      height: 100%;
      border-radius: 4px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      transition: width 0.8s cubic-bezier(0.4,0,0.2,1);
    }

    .tier-progress-label {
      font-size: 0.58rem;
      color: var(--text-dim);
      margin-top: 5px;
      text-align: right;
    }

    /* Live event feed */
    .feed-section { margin-bottom: 20px; }

    .feed-card {
      background: var(--surface);
      border: 1px solid #152830;
      border-radius: 8px;
      padding: 14px 16px;
      max-height: 260px;
      overflow-y: auto;
    }

    .feed-card::-webkit-scrollbar { width: 4px; }
    .feed-card::-webkit-scrollbar-thumb { background: #1a3040; border-radius: 2px; }

    .feed-empty {
      text-align: center;
      color: var(--text-dim);
      font-size: 0.72rem;
      padding: 20px 0;
    }

    .feed-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid #101e26;
      animation: feedSlide 0.4s ease-out;
    }

    .feed-item:last-child { border-bottom: none; }

    @keyframes feedSlide {
      0% { opacity: 0; transform: translateY(-10px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    .feed-icon {
      font-size: 0.9rem;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .feed-text {
      flex: 1;
      font-size: 0.7rem;
      color: var(--text);
      line-height: 1.4;
    }

    .feed-time {
      font-size: 0.58rem;
      color: var(--text-dim);
      flex-shrink: 0;
      white-space: nowrap;
      margin-top: 2px;
    }

    /* Waiting state */
    .waiting-overlay {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 40vh;
      text-align: center;
    }

    .waiting-pulse {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 2px solid var(--primary);
      animation: waitPulse 1.6s ease-in-out infinite;
      margin-bottom: 16px;
    }

    @keyframes waitPulse {
      0%, 100% { transform: scale(0.9); opacity: 0.4; }
      50% { transform: scale(1.1); opacity: 1; }
    }

    .waiting-text {
      font-size: 0.75rem;
      color: var(--text-dim);
      letter-spacing: 0.08em;
    }

    /* Footer */
    .footer-link {
      text-align: center;
      padding: 24px 0;
    }

    .footer-link a {
      font-size: 0.6rem;
      color: var(--text-dim);
      text-decoration: none;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      transition: color 0.3s;
    }

    .footer-link a:hover { color: var(--primary); }

    /* Section label shared */
    .section-label {
      font-size: 0.6rem;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-bottom: 10px;
    }

    /* Entrance animation */
    .fade-in {
      animation: fadeUp 0.5s ease-out both;
    }
    .fade-in-d1 { animation-delay: 0.1s; }
    .fade-in-d2 { animation-delay: 0.2s; }
    .fade-in-d3 { animation-delay: 0.3s; }
    .fade-in-d4 { animation-delay: 0.4s; }
    .fade-in-d5 { animation-delay: 0.5s; }

    @keyframes fadeUp {
      0% { opacity: 0; transform: translateY(12px); }
      100% { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="app-wrap">
    <!-- Waiting State -->
    <div id="waiting" class="waiting-overlay">
      <div class="waiting-pulse"></div>
      <div class="waiting-text">Waiting for sync hub...</div>
    </div>

    <!-- Dashboard (hidden until ready) -->
    <div id="dashboard" style="display:none;">
      <div class="app-title fade-in">SLOPPY REPUTATION</div>
      <div class="app-subtitle fade-in fade-in-d1">Live reputation dashboard</div>

      <!-- Profile Strip -->
      <div class="profile-strip fade-in fade-in-d1" id="profileStrip">
        <div class="profile-avatar" id="profileAvatar">?</div>
        <div class="profile-info">
          <div class="profile-name" id="profileName">---</div>
          <div class="profile-badges" id="profileBadges"></div>
        </div>
      </div>

      <!-- Trust Ring + Karma Gauge -->
      <div class="dash-grid fade-in fade-in-d2">
        <div class="card">
          <div class="card-label">Trust Score</div>
          <div class="trust-ring-wrap">
            <svg class="trust-svg" viewBox="0 0 160 160">
              <circle class="trust-track" cx="80" cy="80" r="62"/>
              <circle class="trust-arc" id="trustArc" cx="80" cy="80" r="62"
                stroke-dasharray="389.56" stroke-dashoffset="389.56"
                transform="rotate(-90 80 80)"/>
              <text class="trust-center-num" id="trustNum" x="80" y="78">0</text>
              <text class="trust-center-label" x="80" y="96">TRUST</text>
            </svg>
          </div>
        </div>
        <div class="card">
          <div class="card-label">Karma</div>
          <div class="karma-wrap">
            <div class="karma-num" id="karmaNum">
              0
              <span class="karma-delta" id="karmaDelta"></span>
            </div>
            <div class="karma-label">reputation</div>
            <div class="karma-rank" id="karmaRank"></div>
          </div>
        </div>
      </div>

      <!-- Verification Badges -->
      <div class="verif-section fade-in fade-in-d3">
        <div class="section-label">Verification</div>
        <div class="verif-grid" id="verifGrid">
          <div class="verif-card" data-provider="twitter">
            <div class="verif-icon">ùïè</div>
            <div class="verif-name">Twitter</div>
            <div class="verif-status">---</div>
          </div>
          <div class="verif-card" data-provider="email">
            <div class="verif-icon">‚úâ</div>
            <div class="verif-name">Email</div>
            <div class="verif-status">---</div>
          </div>
          <div class="verif-card" data-provider="github">
            <div class="verif-icon">&lt;/&gt;</div>
            <div class="verif-name">GitHub</div>
            <div class="verif-status">---</div>
          </div>
        </div>
      </div>

      <!-- Reputation Tier -->
      <div class="tier-section fade-in fade-in-d4">
        <div class="section-label">Reputation Tier</div>
        <div class="tier-card">
          <div class="tier-top">
            <span class="tier-level" id="tierLevel">Tier 1</span>
            <span class="tier-name" id="tierName">Newcomer</span>
          </div>
          <div class="tier-bar-wrap">
            <div class="tier-bar-fill" id="tierBar" style="width:0%"></div>
          </div>
          <div class="tier-progress-label" id="tierProgress"></div>
        </div>
      </div>

      <!-- Live Event Feed -->
      <div class="feed-section fade-in fade-in-d5">
        <div class="section-label">Live Events</div>
        <div class="feed-card" id="feedCard">
          <div class="feed-empty" id="feedEmpty">Listening for events...</div>
        </div>
      </div>

      <!-- Footer -->
      <div class="footer-link">
        <a href="https://sloppy.live">sloppy.live</a>
      </div>
    </div>
  </div>

  <!-- Sloppy Bar -->
  <script src="/sloppy-header/sloppy-bar.js" data-position="bottom"></script>
  <script>
  (function() {
    'use strict';

    // --- Tier definitions ---
    var TIERS = [
      { min: 0,    name: 'Newcomer',    level: 1 },
      { min: 50,   name: 'Contributor', level: 2 },
      { min: 200,  name: 'Regular',     level: 3 },
      { min: 500,  name: 'Trusted',     level: 4 },
      { min: 1000, name: 'Veteran',     level: 5 },
      { min: 2500, name: 'Legend',       level: 6 }
    ];

    // --- Event icons + labels ---
    var EVENT_MAP = {
      'karma-changed':        { icon: '‚ö°', label: 'Karma' },
      'identity-changed':     { icon: 'üë§', label: 'Identity' },
      'verification-changed': { icon: 'üõ°', label: 'Verification' },
      'auth-changed':         { icon: 'üîë', label: 'Auth' },
      'theme-changed':        { icon: 'üé®', label: 'Theme' },
      'context-ready':        { icon: '‚ú¶',  label: 'Context ready' },
      'unread-changed':       { icon: 'üîî', label: 'Notifications' }
    };

    var MAX_FEED = 20;
    var feedItems = [];
    var currentKarma = 0;

    // --- DOM refs ---
    var $waiting   = document.getElementById('waiting');
    var $dashboard = document.getElementById('dashboard');
    var $profileAvatar  = document.getElementById('profileAvatar');
    var $profileName    = document.getElementById('profileName');
    var $profileBadges  = document.getElementById('profileBadges');
    var $trustArc    = document.getElementById('trustArc');
    var $trustNum    = document.getElementById('trustNum');
    var $karmaNum    = document.getElementById('karmaNum');
    var $karmaDelta  = document.getElementById('karmaDelta');
    var $karmaRank   = document.getElementById('karmaRank');
    var $verifGrid   = document.getElementById('verifGrid');
    var $tierLevel   = document.getElementById('tierLevel');
    var $tierName    = document.getElementById('tierName');
    var $tierBar     = document.getElementById('tierBar');
    var $tierProgress = document.getElementById('tierProgress');
    var $feedCard    = document.getElementById('feedCard');
    var $feedEmpty   = document.getElementById('feedEmpty');

    // =========================================================
    //  Render functions
    // =========================================================

    function showDashboard() {
      $waiting.style.display = 'none';
      $dashboard.style.display = 'block';
    }

    function renderAll(ctx) {
      if (!ctx) return;
      showDashboard();
      renderProfile(ctx);
      renderTrust(ctx.trustScore || 0);
      renderKarma(ctx.karma || 0, ctx.rank);
      renderVerification(ctx.verifiedProviders || [], ctx.verificationLevel || 0);
      renderTier(ctx.karma || 0, ctx.verificationLevel || 0);
    }

    // --- Profile ---
    function renderProfile(ctx) {
      // Avatar
      if (ctx.avatarUrl) {
        $profileAvatar.innerHTML = '<img src="' + escHtml(ctx.avatarUrl) + '" alt="">';
      } else if (ctx.avatar) {
        $profileAvatar.textContent = ctx.avatar;
      } else {
        $profileAvatar.textContent = '?';
      }

      // Name
      $profileName.textContent = ctx.username || 'Anonymous';

      // Badges
      var html = '';
      if (ctx.authProvider === 'twitter' || ctx.isTwitter) {
        html += '<span class="badge badge-auth">Twitter</span>';
      } else if (ctx.authProvider === 'anonymous') {
        html += '<span class="badge badge-auth">Anon</span>';
      }
      if (ctx.premium) {
        html += '<span class="badge badge-premium">‚òÖ Premium</span>';
      }
      $profileBadges.innerHTML = html;
    }

    // --- Trust Ring ---
    function renderTrust(score) {
      var max = 450;
      var clamped = Math.max(0, Math.min(score, max));
      var circumference = 2 * Math.PI * 62; // ~389.56
      var offset = circumference - (clamped / max) * circumference;
      $trustArc.style.strokeDashoffset = offset;
      $trustArc.setAttribute('stroke', trustColor(clamped));
      $trustNum.textContent = Math.round(clamped);
    }

    function trustColor(score) {
      if (score < 100) return 'var(--warning)';
      if (score < 250) return '#f0c040';
      if (score < 350) return 'var(--primary)';
      return '#00ffea';
    }

    // --- Karma ---
    function renderKarma(karma, rank) {
      currentKarma = karma;
      // Only set the first text node (number), keep the delta span
      $karmaNum.firstChild.textContent = formatNum(karma);

      if (rank != null && rank > 0) {
        $karmaRank.textContent = '#' + rank + ' overall';
      } else {
        $karmaRank.textContent = '';
      }
    }

    function animateKarmaDelta(delta) {
      if (!delta || delta === 0) return;
      var sign = delta > 0 ? '+' : '';
      $karmaDelta.textContent = sign + delta;
      $karmaDelta.classList.remove('pop');
      // Force reflow
      void $karmaDelta.offsetWidth;
      $karmaDelta.classList.add('pop');
    }

    // --- Verification ---
    function renderVerification(providers, level) {
      var providerSet = {};
      if (Array.isArray(providers)) {
        providers.forEach(function(p) { providerSet[p.toLowerCase()] = true; });
      }
      var cards = $verifGrid.querySelectorAll('.verif-card');
      cards.forEach(function(card) {
        var prov = card.getAttribute('data-provider');
        var isVerified = !!providerSet[prov];
        card.classList.toggle('verified', isVerified);
        card.querySelector('.verif-status').textContent = isVerified ? '‚úì Verified' : 'Not verified';
      });
    }

    // --- Tier ---
    function renderTier(karma, verifLevel) {
      var effectiveKarma = karma;
      // Each verification level adds half a tier worth of bonus
      var bonus = (verifLevel || 0) * 100;
      effectiveKarma += bonus;

      var tier = TIERS[0];
      var nextTier = TIERS[1] || null;
      for (var i = TIERS.length - 1; i >= 0; i--) {
        if (effectiveKarma >= TIERS[i].min) {
          tier = TIERS[i];
          nextTier = TIERS[i + 1] || null;
          break;
        }
      }

      $tierLevel.textContent = 'Tier ' + tier.level;
      $tierName.textContent = tier.name;

      if (nextTier) {
        var range = nextTier.min - tier.min;
        var progress = effectiveKarma - tier.min;
        var pct = Math.min(100, Math.max(0, (progress / range) * 100));
        $tierBar.style.width = pct.toFixed(1) + '%';
        $tierProgress.textContent = formatNum(effectiveKarma) + ' / ' + formatNum(nextTier.min) + ' to ' + nextTier.name;
      } else {
        $tierBar.style.width = '100%';
        $tierProgress.textContent = 'Max tier reached';
      }
    }

    // --- Feed ---
    function addFeedEvent(eventName, data) {
      var info = EVENT_MAP[eventName];
      if (!info && !EVENT_MAP.hasOwnProperty(eventName)) {
        // Unknown event ‚Äî still show it
        info = { icon: '‚óè', label: eventName };
      }
      if (!info) return;

      var desc = info.label;
      if (eventName === 'karma-changed' && data) {
        if (data.delta) desc += ': ' + (data.delta > 0 ? '+' : '') + data.delta;
        if (data.karma != null) desc += ' (total: ' + formatNum(data.karma) + ')';
      }
      if (eventName === 'identity-changed' && data && data.username) {
        desc += ': ' + data.username;
      }
      if (eventName === 'verification-changed' && data && data.verificationLevel != null) {
        desc += ': level ' + data.verificationLevel;
      }

      var item = { icon: info.icon, text: desc, time: Date.now() };
      feedItems.unshift(item);
      if (feedItems.length > MAX_FEED) feedItems.pop();

      renderFeed();
    }

    function renderFeed() {
      if (feedItems.length === 0) return;
      $feedEmpty.style.display = 'none';

      var html = '';
      feedItems.forEach(function(it) {
        html += '<div class="feed-item">'
          + '<span class="feed-icon">' + it.icon + '</span>'
          + '<span class="feed-text">' + escHtml(it.text) + '</span>'
          + '<span class="feed-time">' + relativeTime(it.time) + '</span>'
          + '</div>';
      });
      $feedCard.innerHTML = html;
    }

    // Refresh relative times every 15s
    setInterval(function() {
      if (feedItems.length) renderFeed();
    }, 15000);

    // =========================================================
    //  Utilities
    // =========================================================

    function escHtml(s) {
      if (!s) return '';
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function formatNum(n) {
      if (n == null) return '0';
      return Number(n).toLocaleString();
    }

    function relativeTime(ts) {
      var diff = Math.max(0, Math.floor((Date.now() - ts) / 1000));
      if (diff < 5) return 'now';
      if (diff < 60) return diff + 's ago';
      var m = Math.floor(diff / 60);
      if (m < 60) return m + 'm ago';
      var h = Math.floor(m / 60);
      return h + 'h ago';
    }

    // =========================================================
    //  Init ‚Äî sync hub only
    // =========================================================

    function init() {
      // Try immediate context
      if (window.sloppyBarGetContext) {
        var ctx = window.sloppyBarGetContext(function(readyCtx) {
          if (readyCtx && readyCtx.ready) {
            renderAll(readyCtx);
            addFeedEvent('context-ready', readyCtx);
          }
        });
        if (ctx && ctx.ready) {
          renderAll(ctx);
          addFeedEvent('context-ready', ctx);
        }
      }

      // Event listeners
      if (window.sloppyBarOn) {
        window.sloppyBarOn('context-ready', function(e) {
          var ctx = window.sloppyBarGetContext ? window.sloppyBarGetContext() : (e && e.data);
          renderAll(ctx);
        });

        window.sloppyBarOn('karma-changed', function(e) {
          var d = e && e.data;
          if (!d) return;
          var newKarma = d.karma != null ? d.karma : currentKarma;
          var delta = d.delta || (newKarma - currentKarma);
          renderKarma(newKarma, d.rank || null);
          animateKarmaDelta(delta);
          renderTier(newKarma, (window.sloppyBarGetContext && window.sloppyBarGetContext().verificationLevel) || 0);
          addFeedEvent('karma-changed', d);
        });

        window.sloppyBarOn('verification-changed', function(e) {
          var d = e && e.data;
          if (!d) return;
          renderTrust(d.trustScore || 0);
          renderVerification(d.verifiedProviders || [], d.verificationLevel || 0);
          var ctx = window.sloppyBarGetContext ? window.sloppyBarGetContext() : {};
          renderTier(ctx.karma || 0, d.verificationLevel || 0);
          addFeedEvent('verification-changed', d);
        });

        window.sloppyBarOn('identity-changed', function(e) {
          var d = e && e.data;
          if (!d) return;
          var ctx = window.sloppyBarGetContext ? window.sloppyBarGetContext() : {};
          // Merge identity data into context for profile render
          var merged = Object.assign({}, ctx, d);
          renderProfile(merged);
          addFeedEvent('identity-changed', d);
        });

        window.sloppyBarOn('auth-changed', function(e) {
          addFeedEvent('auth-changed', e && e.data);
        });

        window.sloppyBarOn('theme-changed', function(e) {
          addFeedEvent('theme-changed', e && e.data);
        });

        window.sloppyBarOn('unread-changed', function(e) {
          addFeedEvent('unread-changed', e && e.data);
        });
      }

      // Fallback: if sync hub doesn't load within 8s, show a message
      setTimeout(function() {
        if ($dashboard.style.display === 'none') {
          var wt = document.querySelector('.waiting-text');
          if (wt) wt.textContent = 'Sync hub not detected ‚Äî try refreshing';
        }
      }, 8000);
    }

    // Start when DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

  })();
  </script>
</body>
</html>
