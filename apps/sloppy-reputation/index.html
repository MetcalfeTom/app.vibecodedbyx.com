<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sloppy Reputation</title>
  <link rel="icon" href="https://emojicdn.elk.sh/üõ°Ô∏è" type="image/png">
  <meta property="og:title" content="Sloppy Reputation">
  <meta property="og:description" content="Live karma & trust dashboard ‚Äî see your reputation pulse in real time">
  <meta property="og:url" content="https://sloppy.live/sloppy-reputation">
  <meta property="og:image" content="https://sloppy.live/sloppy-reputation/og-image.png">
  <meta property="og:type" content="website">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lexend+Mega:wght@700;900&family=Red+Hat+Mono:wght@400;600&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #060d10;
      --surface: #0c1a20;
      --primary: #00e5cc;
      --secondary: #0099ff;
      --warning: #ff6b4a;
      --text: #c0dde8;
      --text-dim: #5a7a8a;
      --glow: 0 0 12px rgba(0,229,204,0.3);
      --glow-strong: 0 0 24px rgba(0,229,204,0.5);
    }

    body {
      font-family: 'Red Hat Mono', monospace;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Circuit board background */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      z-index: 0;
      background:
        radial-gradient(circle 1.5px at 40px 40px, #0d2a30 100%, transparent 100%),
        radial-gradient(circle 1.5px at 80px 80px, #0d2a30 100%, transparent 100%),
        linear-gradient(to right, #0a1a1f 1px, transparent 1px),
        linear-gradient(to bottom, #0a1a1f 1px, transparent 1px);
      background-size: 120px 120px, 120px 120px, 60px 60px, 60px 60px;
      opacity: 0.4;
      pointer-events: none;
    }

    .app-wrap {
      position: relative;
      z-index: 1;
      max-width: 720px;
      margin: 0 auto;
      padding: 24px 16px 80px;
    }

    /* Header */
    .app-title {
      font-family: 'Lexend Mega', sans-serif;
      font-weight: 900;
      font-size: 1.6rem;
      letter-spacing: 0.05em;
      color: var(--primary);
      text-shadow: var(--glow);
      margin-bottom: 6px;
    }

    .app-subtitle {
      font-size: 0.72rem;
      color: var(--text-dim);
      letter-spacing: 0.12em;
      text-transform: uppercase;
      margin-bottom: 24px;
    }

    /* Profile strip */
    .profile-strip {
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--surface);
      border: 1px solid #152830;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 20px;
    }

    .profile-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: 2px solid var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      background: var(--bg);
      overflow: hidden;
      flex-shrink: 0;
    }

    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-info {
      flex: 1;
      min-width: 0;
    }

    .profile-name {
      font-family: 'Lexend Mega', sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .profile-badges {
      display: flex;
      gap: 6px;
      margin-top: 3px;
    }

    .badge {
      font-size: 0.6rem;
      padding: 2px 6px;
      border-radius: 3px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 600;
    }

    .badge-auth {
      background: rgba(0,153,255,0.15);
      color: var(--secondary);
      border: 1px solid rgba(0,153,255,0.3);
    }

    .badge-premium {
      background: rgba(255,215,0,0.12);
      color: #ffd700;
      border: 1px solid rgba(255,215,0,0.3);
    }

    /* Dashboard grid */
    .dash-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 20px;
    }

    @media (max-width: 520px) {
      .dash-grid { grid-template-columns: 1fr; }
    }

    .card {
      background: var(--surface);
      border: 1px solid #152830;
      border-radius: 8px;
      padding: 20px;
    }

    .card-label {
      font-size: 0.6rem;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-bottom: 12px;
    }

    /* Trust Ring */
    .trust-ring-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .trust-svg {
      width: 160px;
      height: 160px;
    }

    .trust-track {
      fill: none;
      stroke: #152830;
      stroke-width: 10;
    }

    .trust-arc {
      fill: none;
      stroke-width: 10;
      stroke-linecap: round;
      transition: stroke-dashoffset 1s cubic-bezier(0.4,0,0.2,1), stroke 0.5s;
    }

    .trust-center-num {
      font-family: 'Lexend Mega', sans-serif;
      font-weight: 900;
      font-size: 28px;
      fill: #fff;
      text-anchor: middle;
    }

    .trust-center-label {
      font-family: 'Red Hat Mono', monospace;
      font-size: 9px;
      fill: var(--text-dim);
      text-anchor: middle;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    /* Karma Gauge */
    .karma-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .karma-num {
      font-family: 'Lexend Mega', sans-serif;
      font-weight: 900;
      font-size: 3rem;
      color: #fff;
      line-height: 1;
      position: relative;
    }

    .karma-label {
      font-size: 0.65rem;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      margin-top: 4px;
    }

    .karma-rank {
      margin-top: 8px;
      font-size: 0.72rem;
      color: var(--secondary);
      font-weight: 600;
    }

    .karma-delta {
      position: absolute;
      top: -12px;
      right: -32px;
      font-family: 'Red Hat Mono', monospace;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--primary);
      opacity: 0;
      pointer-events: none;
    }

    .karma-delta.pop {
      animation: deltaPop 1.4s ease-out forwards;
    }

    @keyframes deltaPop {
      0% { opacity: 1; transform: translateY(0); }
      70% { opacity: 1; }
      100% { opacity: 0; transform: translateY(-30px); }
    }

    /* Verification Badges */
    .verif-section {
      margin-bottom: 20px;
    }

    .verif-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .verif-card {
      background: var(--surface);
      border: 1px solid #152830;
      border-radius: 8px;
      padding: 14px 10px;
      text-align: center;
      transition: border-color 0.4s, box-shadow 0.4s;
    }

    .verif-card.verified {
      border-color: rgba(0,229,204,0.4);
      box-shadow: var(--glow);
    }

    .verif-icon {
      font-size: 1.4rem;
      margin-bottom: 6px;
    }

    .verif-card.verified .verif-icon { color: var(--primary); }
    .verif-card:not(.verified) .verif-icon { color: var(--text-dim); opacity: 0.4; }

    .verif-name {
      font-size: 0.62rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-dim);
      margin-bottom: 4px;
    }

    .verif-status {
      font-size: 0.58rem;
      font-weight: 600;
      letter-spacing: 0.08em;
    }

    .verif-card.verified .verif-status { color: var(--primary); }
    .verif-card:not(.verified) .verif-status { color: var(--text-dim); }

    /* Tier section */
    .tier-section {
      margin-bottom: 20px;
    }

    .tier-card {
      background: var(--surface);
      border: 1px solid #152830;
      border-radius: 8px;
      padding: 18px 20px;
    }

    .tier-top {
      display: flex;
      align-items: baseline;
      gap: 10px;
      margin-bottom: 10px;
    }

    .tier-level {
      font-family: 'Lexend Mega', sans-serif;
      font-weight: 900;
      font-size: 1.1rem;
      color: #fff;
    }

    .tier-name {
      font-size: 0.75rem;
      color: var(--primary);
      font-weight: 600;
    }

    .tier-bar-wrap {
      background: #152830;
      border-radius: 4px;
      height: 8px;
      overflow: hidden;
    }

    .tier-bar-fill {
      height: 100%;
      border-radius: 4px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      transition: width 0.8s cubic-bezier(0.4,0,0.2,1);
    }

    .tier-progress-label {
      font-size: 0.58rem;
      color: var(--text-dim);
      margin-top: 5px;
      text-align: right;
    }

    /* Karma History Graph */
    .graph-section { margin-bottom: 20px; }

    .graph-card {
      background: var(--surface);
      border: 1px solid #152830;
      border-radius: 8px;
      padding: 16px;
    }

    .graph-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .graph-range-btns {
      display: flex;
      gap: 4px;
    }

    .graph-range-btn {
      background: none;
      border: 1px solid #1a3040;
      color: var(--text-dim);
      font-family: 'Red Hat Mono', monospace;
      font-size: 0.55rem;
      padding: 2px 7px;
      border-radius: 3px;
      cursor: pointer;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      transition: color 0.2s, border-color 0.2s, background 0.2s;
    }

    .graph-range-btn:hover {
      color: var(--primary);
      border-color: var(--primary);
    }

    .graph-range-btn.active {
      background: rgba(0,229,204,0.12);
      color: var(--primary);
      border-color: var(--primary);
    }

    .graph-canvas-wrap {
      position: relative;
      width: 100%;
      height: 180px;
      border-radius: 4px;
      overflow: hidden;
    }

    .graph-canvas-wrap canvas {
      display: block;
      width: 100%;
      height: 100%;
    }

    .graph-empty {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 180px;
      color: var(--text-dim);
      font-size: 0.7rem;
    }

    .graph-tooltip {
      position: absolute;
      background: #0e2028;
      border: 1px solid var(--primary);
      border-radius: 4px;
      padding: 5px 8px;
      font-size: 0.58rem;
      color: var(--text);
      pointer-events: none;
      z-index: 5;
      white-space: nowrap;
      display: none;
      box-shadow: 0 0 8px rgba(0,229,204,0.2);
    }

    /* Leaderboard */
    .lb-section { margin-bottom: 20px; }

    .lb-card {
      background: var(--surface);
      border: 1px solid #152830;
      border-radius: 8px;
      padding: 16px;
    }

    .lb-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
    }

    .lb-refresh {
      background: none;
      border: 1px solid #1a3040;
      color: var(--text-dim);
      font-family: 'Red Hat Mono', monospace;
      font-size: 0.58rem;
      padding: 3px 8px;
      border-radius: 4px;
      cursor: pointer;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      transition: color 0.3s, border-color 0.3s;
    }

    .lb-refresh:hover {
      color: var(--primary);
      border-color: var(--primary);
    }

    .lb-refresh.spinning {
      opacity: 0.5;
      pointer-events: none;
    }

    .lb-list {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .lb-row {
      display: grid;
      grid-template-columns: 28px 1fr auto;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 5px;
      transition: background 0.2s;
    }

    .lb-row:hover {
      background: rgba(0,229,204,0.04);
    }

    .lb-row.is-you {
      background: rgba(0,229,204,0.07);
      border: 1px solid rgba(0,229,204,0.15);
    }

    .lb-rank {
      font-family: 'Lexend Mega', sans-serif;
      font-weight: 900;
      font-size: 0.8rem;
      text-align: center;
    }

    .lb-row:nth-child(1) .lb-rank { color: #ffd700; }
    .lb-row:nth-child(2) .lb-rank { color: #c0c0c0; }
    .lb-row:nth-child(3) .lb-rank { color: #cd7f32; }
    .lb-row:nth-child(n+4) .lb-rank { color: var(--text-dim); }

    .lb-user {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .lb-name {
      font-size: 0.72rem;
      font-weight: 600;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .lb-bar-wrap {
      height: 4px;
      background: #101e26;
      border-radius: 2px;
      margin-top: 4px;
      overflow: hidden;
      display: flex;
    }

    .lb-bar-seg {
      height: 100%;
      transition: width 0.6s ease-out;
    }

    .lb-bar-content   { background: var(--primary); }
    .lb-bar-engage    { background: var(--secondary); }
    .lb-bar-social    { background: #a855f7; }
    .lb-bar-trust     { background: #f0c040; }

    .lb-karma {
      font-family: 'Lexend Mega', sans-serif;
      font-weight: 700;
      font-size: 0.85rem;
      color: var(--primary);
      text-align: right;
      white-space: nowrap;
    }

    .lb-empty {
      text-align: center;
      color: var(--text-dim);
      font-size: 0.72rem;
      padding: 20px 0;
    }

    .lb-legend {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .lb-legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.52rem;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .lb-legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 2px;
    }

    /* Live event feed */
    .feed-section { margin-bottom: 20px; }

    .feed-card {
      background: var(--surface);
      border: 1px solid #152830;
      border-radius: 8px;
      padding: 14px 16px;
      max-height: 260px;
      overflow-y: auto;
    }

    .feed-card::-webkit-scrollbar { width: 4px; }
    .feed-card::-webkit-scrollbar-thumb { background: #1a3040; border-radius: 2px; }

    .feed-empty {
      text-align: center;
      color: var(--text-dim);
      font-size: 0.72rem;
      padding: 20px 0;
    }

    .feed-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid #101e26;
      animation: feedSlide 0.4s ease-out;
    }

    .feed-item:last-child { border-bottom: none; }

    @keyframes feedSlide {
      0% { opacity: 0; transform: translateY(-10px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    .feed-icon {
      font-size: 0.9rem;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .feed-text {
      flex: 1;
      font-size: 0.7rem;
      color: var(--text);
      line-height: 1.4;
    }

    .feed-time {
      font-size: 0.58rem;
      color: var(--text-dim);
      flex-shrink: 0;
      white-space: nowrap;
      margin-top: 2px;
    }

    /* Waiting state */
    .waiting-overlay {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 40vh;
      text-align: center;
    }

    .waiting-pulse {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 2px solid var(--primary);
      animation: waitPulse 1.6s ease-in-out infinite;
      margin-bottom: 16px;
    }

    @keyframes waitPulse {
      0%, 100% { transform: scale(0.9); opacity: 0.4; }
      50% { transform: scale(1.1); opacity: 1; }
    }

    .waiting-text {
      font-size: 0.75rem;
      color: var(--text-dim);
      letter-spacing: 0.08em;
    }

    /* Footer */
    .footer-link {
      text-align: center;
      padding: 24px 0;
    }

    .footer-link a {
      font-size: 0.6rem;
      color: var(--text-dim);
      text-decoration: none;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      transition: color 0.3s;
    }

    .footer-link a:hover { color: var(--primary); }

    /* Section label shared */
    .section-label {
      font-size: 0.6rem;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-bottom: 10px;
    }

    /* Entrance animation */
    .fade-in {
      animation: fadeUp 0.5s ease-out both;
    }
    .fade-in-d1 { animation-delay: 0.1s; }
    .fade-in-d2 { animation-delay: 0.2s; }
    .fade-in-d3 { animation-delay: 0.3s; }
    .fade-in-d4 { animation-delay: 0.4s; }
    .fade-in-d5 { animation-delay: 0.5s; }

    @keyframes fadeUp {
      0% { opacity: 0; transform: translateY(12px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    /* ======================================================
       PREMIUM ‚Äî Neon Energy Mode
       ====================================================== */

    /* Animated border gradient on profile strip */
    body.premium-active .profile-strip {
      border: none;
      background: var(--surface);
      position: relative;
      overflow: visible;
    }
    body.premium-active .profile-strip::before {
      content: '';
      position: absolute;
      inset: -2px;
      border-radius: 10px;
      background: linear-gradient(90deg, #00e5cc, #0099ff, #a855f7, #ff6b4a, #f0c040, #00e5cc);
      background-size: 300% 100%;
      animation: neonBorderFlow 4s linear infinite;
      z-index: -1;
    }
    body.premium-active .profile-strip::after {
      content: '';
      position: absolute;
      inset: -2px;
      border-radius: 10px;
      background: linear-gradient(90deg, #00e5cc, #0099ff, #a855f7, #ff6b4a, #f0c040, #00e5cc);
      background-size: 300% 100%;
      animation: neonBorderFlow 4s linear infinite;
      filter: blur(12px);
      opacity: 0.35;
      z-index: -2;
    }

    @keyframes neonBorderFlow {
      0% { background-position: 0% 50%; }
      100% { background-position: 300% 50%; }
    }

    /* Avatar neon ring */
    body.premium-active .profile-avatar {
      border: 2px solid transparent;
      background-image: linear-gradient(var(--bg), var(--bg)), linear-gradient(135deg, #00e5cc, #a855f7, #ff6b4a);
      background-origin: border-box;
      background-clip: content-box, border-box;
      animation: avatarPulse 2s ease-in-out infinite;
    }

    @keyframes avatarPulse {
      0%, 100% { box-shadow: 0 0 8px rgba(0,229,204,0.4), 0 0 20px rgba(168,85,247,0.2); }
      50% { box-shadow: 0 0 16px rgba(0,229,204,0.7), 0 0 32px rgba(168,85,247,0.4); }
    }

    /* Premium name glow */
    body.premium-active .profile-name {
      background: linear-gradient(90deg, #fff, #00e5cc, #0099ff, #fff);
      background-size: 200% 100%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: nameShimmer 3s ease-in-out infinite;
    }

    @keyframes nameShimmer {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 200% 50%; }
    }

    /* Cards get subtle neon pulse border */
    body.premium-active .card,
    body.premium-active .tier-card,
    body.premium-active .graph-card,
    body.premium-active .lb-card {
      border-color: rgba(0,229,204,0.15);
      animation: cardPulse 3s ease-in-out infinite;
    }

    @keyframes cardPulse {
      0%, 100% { box-shadow: 0 0 0 rgba(0,229,204,0); border-color: rgba(0,229,204,0.15); }
      50% { box-shadow: 0 0 12px rgba(0,229,204,0.1); border-color: rgba(0,229,204,0.3); }
    }

    /* Trust ring gets rotating SVG filter glow */
    body.premium-active .trust-arc {
      filter: drop-shadow(0 0 6px rgba(0,229,204,0.6));
      animation: trustGlow 2s ease-in-out infinite;
    }

    @keyframes trustGlow {
      0%, 100% { filter: drop-shadow(0 0 4px rgba(0,229,204,0.4)); }
      50% { filter: drop-shadow(0 0 12px rgba(0,229,204,0.8)); }
    }

    /* Karma number neon text */
    body.premium-active .karma-num {
      text-shadow: 0 0 12px rgba(0,229,204,0.5), 0 0 30px rgba(0,153,255,0.3);
      animation: karmaGlow 2.5s ease-in-out infinite;
    }

    @keyframes karmaGlow {
      0%, 100% { text-shadow: 0 0 8px rgba(0,229,204,0.3), 0 0 20px rgba(0,153,255,0.15); }
      50% { text-shadow: 0 0 20px rgba(0,229,204,0.7), 0 0 40px rgba(0,153,255,0.4); }
    }

    /* Tier bar gets animated gradient */
    body.premium-active .tier-bar-fill {
      background: linear-gradient(90deg, #00e5cc, #0099ff, #a855f7, #00e5cc);
      background-size: 200% 100%;
      animation: tierBarFlow 2s linear infinite;
    }

    @keyframes tierBarFlow {
      0% { background-position: 0% 50%; }
      100% { background-position: 200% 50%; }
    }

    /* Premium tier label styling */
    body.premium-active .tier-name {
      background: linear-gradient(90deg, #00e5cc, #a855f7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Verified badges get extra energy */
    body.premium-active .verif-card.verified {
      box-shadow: 0 0 12px rgba(0,229,204,0.3), inset 0 0 12px rgba(0,229,204,0.05);
      animation: verifPulse 2s ease-in-out infinite;
    }

    @keyframes verifPulse {
      0%, 100% { box-shadow: 0 0 8px rgba(0,229,204,0.2), inset 0 0 8px rgba(0,229,204,0.03); }
      50% { box-shadow: 0 0 18px rgba(0,229,204,0.45), inset 0 0 18px rgba(0,229,204,0.08); }
    }

    /* Neon particle canvas */
    #premiumParticles {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      display: none;
    }

    body.premium-active #premiumParticles {
      display: block;
    }

    /* Premium badge upgrade */
    body.premium-active .badge-premium {
      background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(168,85,247,0.2));
      border: 1px solid rgba(255,215,0,0.5);
      box-shadow: 0 0 8px rgba(255,215,0,0.25);
      animation: premBadgePulse 2s ease-in-out infinite;
    }

    @keyframes premBadgePulse {
      0%, 100% { box-shadow: 0 0 6px rgba(255,215,0,0.2); }
      50% { box-shadow: 0 0 14px rgba(255,215,0,0.45); }
    }

    /* Leaderboard highlight for premium users */
    .lb-row.is-premium .lb-name {
      background: linear-gradient(90deg, #ffd700, #00e5cc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .lb-row.is-premium .lb-karma {
      color: #ffd700;
      text-shadow: 0 0 6px rgba(255,215,0,0.3);
    }
  </style>
</head>
<body>
  <canvas id="premiumParticles"></canvas>
  <div class="app-wrap">
    <!-- Waiting State -->
    <div id="waiting" class="waiting-overlay">
      <div class="waiting-pulse"></div>
      <div class="waiting-text">Waiting for sync hub...</div>
    </div>

    <!-- Dashboard (hidden until ready) -->
    <div id="dashboard" style="display:none;">
      <div class="app-title fade-in">SLOPPY REPUTATION</div>
      <div class="app-subtitle fade-in fade-in-d1">Live reputation dashboard</div>

      <!-- Profile Strip -->
      <div class="profile-strip fade-in fade-in-d1" id="profileStrip">
        <div class="profile-avatar" id="profileAvatar">?</div>
        <div class="profile-info">
          <div class="profile-name" id="profileName">---</div>
          <div class="profile-badges" id="profileBadges"></div>
        </div>
      </div>

      <!-- Trust Ring + Karma Gauge -->
      <div class="dash-grid fade-in fade-in-d2">
        <div class="card">
          <div class="card-label">Trust Score</div>
          <div class="trust-ring-wrap">
            <svg class="trust-svg" viewBox="0 0 160 160">
              <circle class="trust-track" cx="80" cy="80" r="62"/>
              <circle class="trust-arc" id="trustArc" cx="80" cy="80" r="62"
                stroke-dasharray="389.56" stroke-dashoffset="389.56"
                transform="rotate(-90 80 80)"/>
              <text class="trust-center-num" id="trustNum" x="80" y="78">0</text>
              <text class="trust-center-label" x="80" y="96">TRUST</text>
            </svg>
          </div>
        </div>
        <div class="card">
          <div class="card-label">Karma</div>
          <div class="karma-wrap">
            <div class="karma-num" id="karmaNum">
              0
              <span class="karma-delta" id="karmaDelta"></span>
            </div>
            <div class="karma-label">reputation</div>
            <div class="karma-rank" id="karmaRank"></div>
          </div>
        </div>
      </div>

      <!-- Verification Badges -->
      <div class="verif-section fade-in fade-in-d3">
        <div class="section-label">Verification</div>
        <div class="verif-grid" id="verifGrid">
          <div class="verif-card" data-provider="twitter">
            <div class="verif-icon">ùïè</div>
            <div class="verif-name">Twitter</div>
            <div class="verif-status">---</div>
          </div>
          <div class="verif-card" data-provider="email">
            <div class="verif-icon">‚úâ</div>
            <div class="verif-name">Email</div>
            <div class="verif-status">---</div>
          </div>
          <div class="verif-card" data-provider="github">
            <div class="verif-icon">&lt;/&gt;</div>
            <div class="verif-name">GitHub</div>
            <div class="verif-status">---</div>
          </div>
        </div>
      </div>

      <!-- Reputation Tier -->
      <div class="tier-section fade-in fade-in-d4">
        <div class="section-label">Reputation Tier</div>
        <div class="tier-card">
          <div class="tier-top">
            <span class="tier-level" id="tierLevel">Tier 1</span>
            <span class="tier-name" id="tierName">Newcomer</span>
          </div>
          <div class="tier-bar-wrap">
            <div class="tier-bar-fill" id="tierBar" style="width:0%"></div>
          </div>
          <div class="tier-progress-label" id="tierProgress"></div>
        </div>
      </div>

      <!-- Karma History Graph -->
      <div class="graph-section fade-in fade-in-d5">
        <div class="section-label">Karma History</div>
        <div class="graph-card">
          <div class="graph-header">
            <span style="font-size:0.58rem;color:var(--text-dim);letter-spacing:0.1em;text-transform:uppercase;">Your karma over time</span>
            <div class="graph-range-btns" id="graphRangeBtns">
              <button class="graph-range-btn active" data-range="24h">24H</button>
              <button class="graph-range-btn" data-range="7d">7D</button>
              <button class="graph-range-btn" data-range="30d">30D</button>
              <button class="graph-range-btn" data-range="all">All</button>
            </div>
          </div>
          <div class="graph-canvas-wrap" id="graphWrap">
            <canvas id="graphCanvas"></canvas>
            <div class="graph-tooltip" id="graphTooltip"></div>
            <div class="graph-empty" id="graphEmpty">Recording karma history...</div>
          </div>
        </div>
      </div>

      <!-- Community Leaderboard -->
      <div class="lb-section fade-in fade-in-d5">
        <div class="section-label">Community Leaderboard</div>
        <div class="lb-card">
          <div class="lb-header">
            <span style="font-size:0.58rem;color:var(--text-dim);letter-spacing:0.1em;text-transform:uppercase;">Top 15 Heavy Hitters</span>
            <button class="lb-refresh" id="lbRefresh" onclick="window._lbRefresh()">Refresh</button>
          </div>
          <div class="lb-list" id="lbList">
            <div class="lb-empty" id="lbEmpty">Loading leaderboard...</div>
          </div>
          <div class="lb-legend">
            <span class="lb-legend-item"><span class="lb-legend-dot" style="background:var(--primary)"></span> Content</span>
            <span class="lb-legend-item"><span class="lb-legend-dot" style="background:var(--secondary)"></span> Engagement</span>
            <span class="lb-legend-item"><span class="lb-legend-dot" style="background:#a855f7"></span> Social</span>
            <span class="lb-legend-item"><span class="lb-legend-dot" style="background:#f0c040"></span> Trust</span>
          </div>
        </div>
      </div>

      <!-- Live Event Feed -->
      <div class="feed-section fade-in fade-in-d5">
        <div class="section-label">Live Events</div>
        <div class="feed-card" id="feedCard">
          <div class="feed-empty" id="feedEmpty">Listening for events...</div>
        </div>
      </div>

      <!-- Footer -->
      <div class="footer-link">
        <a href="https://sloppy.live">sloppy.live</a>
      </div>
    </div>
  </div>

  <!-- Supabase for leaderboard query -->
  <script type="module">
    import { createBrowserClient } from "https://cdn.jsdelivr.net/npm/@supabase/ssr@0.7.0/+esm";
    var sb = createBrowserClient(
      'https://yjyxteqzhhmtrgcaekgz.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM8IS32IUYR2eenCCjdDdioiBU'
    );
    window._sbRep = sb;
    window.dispatchEvent(new Event('sb-rep-ready'));
  </script>

  <!-- Sloppy Bar -->
  <script src="/sloppy-header/sloppy-bar.js" data-position="bottom"></script>
  <script>
  (function() {
    'use strict';

    // --- Tier definitions ---
    var TIERS = [
      { min: 0,    name: 'Newcomer',    level: 1 },
      { min: 50,   name: 'Contributor', level: 2 },
      { min: 200,  name: 'Regular',     level: 3 },
      { min: 500,  name: 'Trusted',     level: 4 },
      { min: 1000, name: 'Veteran',     level: 5 },
      { min: 2500, name: 'Legend',       level: 6 }
    ];

    // --- Event icons + labels ---
    var EVENT_MAP = {
      'karma-changed':        { icon: '‚ö°', label: 'Karma' },
      'identity-changed':     { icon: 'üë§', label: 'Identity' },
      'verification-changed': { icon: 'üõ°', label: 'Verification' },
      'auth-changed':         { icon: 'üîë', label: 'Auth' },
      'theme-changed':        { icon: 'üé®', label: 'Theme' },
      'context-ready':        { icon: '‚ú¶',  label: 'Context ready' },
      'unread-changed':       { icon: 'üîî', label: 'Notifications' }
    };

    var MAX_FEED = 20;
    var feedItems = [];
    var currentKarma = 0;

    // --- DOM refs ---
    var $waiting   = document.getElementById('waiting');
    var $dashboard = document.getElementById('dashboard');
    var $profileAvatar  = document.getElementById('profileAvatar');
    var $profileName    = document.getElementById('profileName');
    var $profileBadges  = document.getElementById('profileBadges');
    var $trustArc    = document.getElementById('trustArc');
    var $trustNum    = document.getElementById('trustNum');
    var $karmaNum    = document.getElementById('karmaNum');
    var $karmaDelta  = document.getElementById('karmaDelta');
    var $karmaRank   = document.getElementById('karmaRank');
    var $verifGrid   = document.getElementById('verifGrid');
    var $tierLevel   = document.getElementById('tierLevel');
    var $tierName    = document.getElementById('tierName');
    var $tierBar     = document.getElementById('tierBar');
    var $tierProgress = document.getElementById('tierProgress');
    var $feedCard    = document.getElementById('feedCard');
    var $feedEmpty   = document.getElementById('feedEmpty');

    // =========================================================
    //  Render functions
    // =========================================================

    function showDashboard() {
      $waiting.style.display = 'none';
      $dashboard.style.display = 'block';
    }

    function renderAll(ctx) {
      if (!ctx) return;
      showDashboard();
      renderProfile(ctx);
      renderTrust(ctx.trustScore || 0);
      renderKarma(ctx.karma || 0, ctx.rank);
      renderVerification(ctx.verifiedProviders || [], ctx.verificationLevel || 0);
      // Activate premium before tier render (swaps tier names)
      if (ctx.premium) activatePremium();
      renderTier(ctx.karma || 0, ctx.verificationLevel || 0);
    }

    // --- Profile ---
    function renderProfile(ctx) {
      // Avatar
      if (ctx.avatarUrl) {
        $profileAvatar.innerHTML = '<img src="' + escHtml(ctx.avatarUrl) + '" alt="">';
      } else if (ctx.avatar) {
        $profileAvatar.textContent = ctx.avatar;
      } else {
        $profileAvatar.textContent = '?';
      }

      // Name
      $profileName.textContent = ctx.username || 'Anonymous';

      // Badges
      var html = '';
      if (ctx.authProvider === 'twitter' || ctx.isTwitter) {
        html += '<span class="badge badge-auth">Twitter</span>';
      } else if (ctx.authProvider === 'anonymous') {
        html += '<span class="badge badge-auth">Anon</span>';
      }
      if (ctx.premium) {
        html += '<span class="badge badge-premium">‚òÖ Premium</span>';
      }
      $profileBadges.innerHTML = html;
    }

    // --- Trust Ring ---
    function renderTrust(score) {
      var max = 450;
      var clamped = Math.max(0, Math.min(score, max));
      var circumference = 2 * Math.PI * 62; // ~389.56
      var offset = circumference - (clamped / max) * circumference;
      $trustArc.style.strokeDashoffset = offset;
      $trustArc.setAttribute('stroke', trustColor(clamped));
      $trustNum.textContent = Math.round(clamped);
    }

    function trustColor(score) {
      if (score < 100) return 'var(--warning)';
      if (score < 250) return '#f0c040';
      if (score < 350) return 'var(--primary)';
      return '#00ffea';
    }

    // --- Karma ---
    function renderKarma(karma, rank) {
      currentKarma = karma;
      // Only set the first text node (number), keep the delta span
      $karmaNum.firstChild.textContent = formatNum(karma);

      if (rank != null && rank > 0) {
        $karmaRank.textContent = '#' + rank + ' overall';
      } else {
        $karmaRank.textContent = '';
      }
    }

    function animateKarmaDelta(delta) {
      if (!delta || delta === 0) return;
      var sign = delta > 0 ? '+' : '';
      $karmaDelta.textContent = sign + delta;
      $karmaDelta.classList.remove('pop');
      // Force reflow
      void $karmaDelta.offsetWidth;
      $karmaDelta.classList.add('pop');
    }

    // --- Verification ---
    function renderVerification(providers, level) {
      var providerSet = {};
      if (Array.isArray(providers)) {
        providers.forEach(function(p) { providerSet[p.toLowerCase()] = true; });
      }
      var cards = $verifGrid.querySelectorAll('.verif-card');
      cards.forEach(function(card) {
        var prov = card.getAttribute('data-provider');
        var isVerified = !!providerSet[prov];
        card.classList.toggle('verified', isVerified);
        card.querySelector('.verif-status').textContent = isVerified ? '‚úì Verified' : 'Not verified';
      });
    }

    // --- Tier ---
    function renderTier(karma, verifLevel) {
      var effectiveKarma = karma;
      // Each verification level adds half a tier worth of bonus
      var bonus = (verifLevel || 0) * 100;
      effectiveKarma += bonus;

      var tier = TIERS[0];
      var nextTier = TIERS[1] || null;
      for (var i = TIERS.length - 1; i >= 0; i--) {
        if (effectiveKarma >= TIERS[i].min) {
          tier = TIERS[i];
          nextTier = TIERS[i + 1] || null;
          break;
        }
      }

      $tierLevel.textContent = 'Tier ' + tier.level;
      $tierName.textContent = tier.name;

      if (nextTier) {
        var range = nextTier.min - tier.min;
        var progress = effectiveKarma - tier.min;
        var pct = Math.min(100, Math.max(0, (progress / range) * 100));
        $tierBar.style.width = pct.toFixed(1) + '%';
        $tierProgress.textContent = formatNum(effectiveKarma) + ' / ' + formatNum(nextTier.min) + ' to ' + nextTier.name;
      } else {
        $tierBar.style.width = '100%';
        $tierProgress.textContent = 'Max tier reached';
      }
    }

    // --- Feed ---
    function addFeedEvent(eventName, data) {
      var info = EVENT_MAP[eventName];
      if (!info && !EVENT_MAP.hasOwnProperty(eventName)) {
        // Unknown event ‚Äî still show it
        info = { icon: '‚óè', label: eventName };
      }
      if (!info) return;

      var desc = info.label;
      if (eventName === 'karma-changed' && data) {
        if (data.delta) desc += ': ' + (data.delta > 0 ? '+' : '') + data.delta;
        if (data.karma != null) desc += ' (total: ' + formatNum(data.karma) + ')';
      }
      if (eventName === 'identity-changed' && data && data.username) {
        desc += ': ' + data.username;
      }
      if (eventName === 'verification-changed' && data && data.verificationLevel != null) {
        desc += ': level ' + data.verificationLevel;
      }

      var item = { icon: info.icon, text: desc, time: Date.now() };
      feedItems.unshift(item);
      if (feedItems.length > MAX_FEED) feedItems.pop();

      renderFeed();
    }

    function renderFeed() {
      if (feedItems.length === 0) return;
      $feedEmpty.style.display = 'none';

      var html = '';
      feedItems.forEach(function(it) {
        html += '<div class="feed-item">'
          + '<span class="feed-icon">' + it.icon + '</span>'
          + '<span class="feed-text">' + escHtml(it.text) + '</span>'
          + '<span class="feed-time">' + relativeTime(it.time) + '</span>'
          + '</div>';
      });
      $feedCard.innerHTML = html;
    }

    // Refresh relative times every 15s
    setInterval(function() {
      if (feedItems.length) renderFeed();
    }, 15000);

    // =========================================================
    //  Utilities
    // =========================================================

    function escHtml(s) {
      if (!s) return '';
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function formatNum(n) {
      if (n == null) return '0';
      return Number(n).toLocaleString();
    }

    function relativeTime(ts) {
      var diff = Math.max(0, Math.floor((Date.now() - ts) / 1000));
      if (diff < 5) return 'now';
      if (diff < 60) return diff + 's ago';
      var m = Math.floor(diff / 60);
      if (m < 60) return m + 'm ago';
      var h = Math.floor(m / 60);
      return h + 'h ago';
    }

    // =========================================================
    //  Leaderboard (DB query)
    // =========================================================

    var $lbList = document.getElementById('lbList');
    var $lbEmpty = document.getElementById('lbEmpty');
    var $lbRefresh = document.getElementById('lbRefresh');
    var lbLoading = false;

    function loadLeaderboard() {
      if (lbLoading) return;
      var sb = window._sbRep;
      if (!sb) {
        // Wait for Supabase module
        window.addEventListener('sb-rep-ready', function() { loadLeaderboard(); }, { once: true });
        return;
      }
      lbLoading = true;
      $lbRefresh.classList.add('spinning');
      $lbRefresh.textContent = '...';

      // Fetch karma + premium status in parallel
      Promise.all([
        sb.from('sloppygram_karma')
          .select('username, karma_total, karma_content, karma_engagement, karma_social, karma_trust, rank, user_id, streak_days, last_activity')
          .order('karma_total', { ascending: false })
          .limit(15),
        sb.from('users')
          .select('user_id, purchased_at')
          .not('purchased_at', 'is', null)
      ]).then(function(results) {
          var res = results[0];
          var premRes = results[1];

          lbLoading = false;
          $lbRefresh.classList.remove('spinning');
          $lbRefresh.textContent = 'Refresh';

          if (res.error) {
            $lbEmpty.textContent = 'Failed to load';
            $lbEmpty.style.display = 'block';
            return;
          }
          var rows = res.data || [];
          if (rows.length === 0) {
            $lbEmpty.textContent = 'No karma data yet';
            $lbEmpty.style.display = 'block';
            return;
          }

          // Build premium user set
          var premiumIds = {};
          if (premRes && premRes.data) {
            premRes.data.forEach(function(u) { premiumIds[u.user_id] = true; });
          }

          // Get current user_id from sync hub to highlight
          var myId = null;
          if (window.sloppyBarGetContext) {
            var ctx = window.sloppyBarGetContext();
            if (ctx) myId = ctx.userId;
          }

          var maxKarma = rows[0].karma_total || 1;

          var html = '';
          rows.forEach(function(row, i) {
            var isYou = myId && row.user_id === myId;
            var isPrem = !!premiumIds[row.user_id];
            var kt = row.karma_total || 0;
            var kc = row.karma_content || 0;
            var ke = row.karma_engagement || 0;
            var ks = row.karma_social || 0;
            var ktr = row.karma_trust || 0;
            var total = kc + ke + ks + ktr;
            if (total === 0) total = 1; // avoid /0

            // Bar segment widths as % of total
            var wContent = ((kc / total) * 100).toFixed(1);
            var wEngage  = ((ke / total) * 100).toFixed(1);
            var wSocial  = ((ks / total) * 100).toFixed(1);
            var wTrust   = ((ktr / total) * 100).toFixed(1);

            var rankNum = row.rank || (i + 1);
            var name = escHtml(row.username || 'Anon');
            var cls = 'lb-row' + (isYou ? ' is-you' : '') + (isPrem ? ' is-premium' : '');

            html += '<div class="' + cls + '">'
              + '<span class="lb-rank">' + rankNum + '</span>'
              + '<div class="lb-user">'
              +   '<span class="lb-name">' + (isPrem ? '‚òÖ ' : '') + name + (isYou ? ' <span style="color:var(--primary);font-size:0.55rem;">(you)</span>' : '') + '</span>'
              +   '<div class="lb-bar-wrap">'
              +     '<div class="lb-bar-seg lb-bar-content" style="width:' + wContent + '%"></div>'
              +     '<div class="lb-bar-seg lb-bar-engage" style="width:' + wEngage + '%"></div>'
              +     '<div class="lb-bar-seg lb-bar-social" style="width:' + wSocial + '%"></div>'
              +     '<div class="lb-bar-seg lb-bar-trust" style="width:' + wTrust + '%"></div>'
              +   '</div>'
              + '</div>'
              + '<span class="lb-karma">' + formatNum(kt) + '</span>'
              + '</div>';
          });

          $lbList.innerHTML = html;
        })
        .catch(function() {
          lbLoading = false;
          $lbRefresh.classList.remove('spinning');
          $lbRefresh.textContent = 'Refresh';
          $lbEmpty.textContent = 'Connection error';
          $lbEmpty.style.display = 'block';
        });
    }

    window._lbRefresh = function() { loadLeaderboard(); };

    // =========================================================
    //  Karma History Graph (canvas)
    // =========================================================

    var $graphCanvas = document.getElementById('graphCanvas');
    var $graphWrap   = document.getElementById('graphWrap');
    var $graphEmpty  = document.getElementById('graphEmpty');
    var $graphTooltip = document.getElementById('graphTooltip');
    var $graphRangeBtns = document.getElementById('graphRangeBtns');
    var graphCtx = $graphCanvas.getContext('2d');
    var graphData = [];
    var graphRange = '7d';
    var lastSnapshotTime = 0;
    var SNAPSHOT_INTERVAL = 5 * 60 * 1000; // min 5 min between snapshots

    // Range buttons
    $graphRangeBtns.addEventListener('click', function(e) {
      var btn = e.target.closest('.graph-range-btn');
      if (!btn) return;
      $graphRangeBtns.querySelectorAll('.graph-range-btn').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      graphRange = btn.getAttribute('data-range');
      drawGraph();
    });

    function rangeFilter(range) {
      var now = Date.now();
      if (range === '24h') return now - 24 * 60 * 60 * 1000;
      if (range === '7d')  return now - 7 * 24 * 60 * 60 * 1000;
      if (range === '30d') return now - 30 * 24 * 60 * 60 * 1000;
      return 0; // all
    }

    function loadHistory() {
      var sb = window._sbRep;
      if (!sb) {
        window.addEventListener('sb-rep-ready', function() { loadHistory(); }, { once: true });
        return;
      }

      var myId = null;
      if (window.sloppyBarGetContext) {
        var ctx = window.sloppyBarGetContext();
        if (ctx) myId = ctx.userId;
      }
      if (!myId) return;

      sb.from('karma_history')
        .select('karma_total, karma_content, karma_engagement, karma_social, karma_trust, recorded_at')
        .eq('user_id', myId)
        .order('recorded_at', { ascending: true })
        .limit(500)
        .then(function(res) {
          if (res.error || !res.data) return;
          graphData = res.data.map(function(r) {
            return {
              time: new Date(r.recorded_at).getTime(),
              total: r.karma_total || 0,
              content: r.karma_content || 0,
              engagement: r.karma_engagement || 0,
              social: r.karma_social || 0,
              trust: r.karma_trust || 0
            };
          });
          drawGraph();
        });
    }

    function recordSnapshot(karma, ctx) {
      var sb = window._sbRep;
      if (!sb) return;
      var now = Date.now();
      if (now - lastSnapshotTime < SNAPSHOT_INTERVAL) return;

      var myId = null;
      if (ctx && ctx.userId) myId = ctx.userId;
      else if (window.sloppyBarGetContext) {
        var c = window.sloppyBarGetContext();
        if (c) myId = c.userId;
      }
      if (!myId) return;

      lastSnapshotTime = now;
      var ts = new Date().toISOString();

      // Get component breakdown from leaderboard data or default
      sb.from('sloppygram_karma')
        .select('karma_total, karma_content, karma_engagement, karma_social, karma_trust, username')
        .eq('user_id', myId)
        .single()
        .then(function(res) {
          var row = (res.data) || {};
          var snapshot = {
            user_id: myId,
            karma_total: row.karma_total || karma || 0,
            karma_content: row.karma_content || 0,
            karma_engagement: row.karma_engagement || 0,
            karma_social: row.karma_social || 0,
            karma_trust: row.karma_trust || 0,
            username: row.username || (ctx && ctx.username) || '',
            recorded_at: ts
          };

          sb.from('karma_history').insert(snapshot).then(function(ins) {
            if (!ins.error) {
              graphData.push({
                time: now,
                total: snapshot.karma_total,
                content: snapshot.karma_content,
                engagement: snapshot.karma_engagement,
                social: snapshot.karma_social,
                trust: snapshot.karma_trust
              });
              drawGraph();
            }
          });
        });
    }

    function drawGraph() {
      var cutoff = rangeFilter(graphRange);
      var pts = graphData.filter(function(p) { return p.time >= cutoff; });

      var dpr = window.devicePixelRatio || 1;
      var rect = $graphWrap.getBoundingClientRect();
      var w = rect.width;
      var h = rect.height;
      $graphCanvas.width = w * dpr;
      $graphCanvas.height = h * dpr;
      graphCtx.setTransform(dpr, 0, 0, dpr, 0, 0);

      if (pts.length < 2) {
        $graphEmpty.style.display = 'flex';
        $graphCanvas.style.display = 'none';
        $graphEmpty.textContent = pts.length === 0 ? 'No history yet ‚Äî check back soon' : 'Need more data points...';
        return;
      }

      $graphEmpty.style.display = 'none';
      $graphCanvas.style.display = 'block';

      var PAD_L = 42, PAD_R = 12, PAD_T = 14, PAD_B = 24;
      var gw = w - PAD_L - PAD_R;
      var gh = h - PAD_T - PAD_B;

      var minT = pts[0].time, maxT = pts[pts.length - 1].time;
      var tSpan = maxT - minT || 1;

      var vals = pts.map(function(p) { return p.total; });
      var minV = Math.min.apply(null, vals);
      var maxV = Math.max.apply(null, vals);
      var vPad = Math.max(1, Math.ceil((maxV - minV) * 0.1));
      minV = Math.max(0, minV - vPad);
      maxV = maxV + vPad;
      var vSpan = maxV - minV || 1;

      function px(p) {
        return {
          x: PAD_L + ((p.time - minT) / tSpan) * gw,
          y: PAD_T + gh - ((p.total - minV) / vSpan) * gh
        };
      }

      // Background
      graphCtx.fillStyle = '#080f14';
      graphCtx.fillRect(0, 0, w, h);

      // Grid lines
      graphCtx.strokeStyle = '#101e26';
      graphCtx.lineWidth = 1;
      var gridLines = 4;
      for (var gi = 0; gi <= gridLines; gi++) {
        var gy = PAD_T + (gi / gridLines) * gh;
        graphCtx.beginPath();
        graphCtx.moveTo(PAD_L, gy);
        graphCtx.lineTo(w - PAD_R, gy);
        graphCtx.stroke();

        // Y-axis labels
        var yVal = maxV - (gi / gridLines) * vSpan;
        graphCtx.fillStyle = '#3a5a6a';
        graphCtx.font = '9px "Red Hat Mono", monospace';
        graphCtx.textAlign = 'right';
        graphCtx.fillText(Math.round(yVal).toLocaleString(), PAD_L - 6, gy + 3);
      }

      // X-axis labels
      graphCtx.fillStyle = '#3a5a6a';
      graphCtx.textAlign = 'center';
      var xLabels = Math.min(5, pts.length);
      for (var xi = 0; xi < xLabels; xi++) {
        var idx = Math.floor(xi * (pts.length - 1) / (xLabels - 1));
        var pt = pts[idx];
        var xp = px(pt);
        var d = new Date(pt.time);
        var label;
        if (graphRange === '24h') {
          label = d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
        } else {
          label = (d.getMonth()+1) + '/' + d.getDate();
        }
        graphCtx.fillText(label, xp.x, h - 4);
      }

      // Gradient fill under line
      var grad = graphCtx.createLinearGradient(0, PAD_T, 0, PAD_T + gh);
      grad.addColorStop(0, 'rgba(0,229,204,0.18)');
      grad.addColorStop(1, 'rgba(0,229,204,0)');

      graphCtx.beginPath();
      var first = px(pts[0]);
      graphCtx.moveTo(first.x, first.y);
      for (var fi = 1; fi < pts.length; fi++) {
        var fp = px(pts[fi]);
        graphCtx.lineTo(fp.x, fp.y);
      }
      var last = px(pts[pts.length - 1]);
      graphCtx.lineTo(last.x, PAD_T + gh);
      graphCtx.lineTo(first.x, PAD_T + gh);
      graphCtx.closePath();
      graphCtx.fillStyle = grad;
      graphCtx.fill();

      // Line
      graphCtx.beginPath();
      graphCtx.moveTo(first.x, first.y);
      for (var li = 1; li < pts.length; li++) {
        var lp = px(pts[li]);
        graphCtx.lineTo(lp.x, lp.y);
      }
      graphCtx.strokeStyle = '#00e5cc';
      graphCtx.lineWidth = 2;
      graphCtx.lineJoin = 'round';
      graphCtx.stroke();

      // Glow line
      graphCtx.shadowColor = 'rgba(0,229,204,0.5)';
      graphCtx.shadowBlur = 6;
      graphCtx.beginPath();
      graphCtx.moveTo(first.x, first.y);
      for (var si = 1; si < pts.length; si++) {
        var sp = px(pts[si]);
        graphCtx.lineTo(sp.x, sp.y);
      }
      graphCtx.strokeStyle = 'rgba(0,229,204,0.4)';
      graphCtx.lineWidth = 4;
      graphCtx.stroke();
      graphCtx.shadowBlur = 0;

      // Dots on data points (if not too many)
      if (pts.length <= 50) {
        for (var di = 0; di < pts.length; di++) {
          var dp = px(pts[di]);
          graphCtx.beginPath();
          graphCtx.arc(dp.x, dp.y, 3, 0, Math.PI * 2);
          graphCtx.fillStyle = '#00e5cc';
          graphCtx.fill();
          graphCtx.strokeStyle = '#060d10';
          graphCtx.lineWidth = 1.5;
          graphCtx.stroke();
        }
      }

      // Store pts for hover
      $graphCanvas._pts = pts;
      $graphCanvas._px = px;
    }

    // Tooltip on hover
    $graphCanvas.addEventListener('mousemove', function(e) {
      var pts = $graphCanvas._pts;
      var pxFn = $graphCanvas._px;
      if (!pts || pts.length < 2 || !pxFn) return;

      var rect = $graphCanvas.getBoundingClientRect();
      var mx = e.clientX - rect.left;

      var closest = null, closestDist = Infinity;
      for (var i = 0; i < pts.length; i++) {
        var p = pxFn(pts[i]);
        var dist = Math.abs(p.x - mx);
        if (dist < closestDist) {
          closestDist = dist;
          closest = { pt: pts[i], px: p };
        }
      }

      if (closest && closestDist < 30) {
        var d = new Date(closest.pt.time);
        var dateStr = d.toLocaleDateString() + ' ' + d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
        $graphTooltip.innerHTML = '<strong>' + formatNum(closest.pt.total) + '</strong> karma<br>' + dateStr;
        $graphTooltip.style.display = 'block';
        var tx = closest.px.x + 10;
        var ty = closest.px.y - 30;
        if (tx + 120 > rect.width) tx = closest.px.x - 120;
        if (ty < 0) ty = closest.px.y + 10;
        $graphTooltip.style.left = tx + 'px';
        $graphTooltip.style.top = ty + 'px';
      } else {
        $graphTooltip.style.display = 'none';
      }
    });

    $graphCanvas.addEventListener('mouseleave', function() {
      $graphTooltip.style.display = 'none';
    });

    // Redraw on resize
    window.addEventListener('resize', function() {
      if (graphData.length >= 2) drawGraph();
    });

    // =========================================================
    //  Premium ‚Äî Neon Energy Mode
    // =========================================================

    var PREMIUM_TIERS = [
      { min: 0,    name: 'Initiate',    level: 1 },
      { min: 50,   name: 'Conduit',     level: 2 },
      { min: 200,  name: 'Architect',   level: 3 },
      { min: 500,  name: 'Neon Oracle', level: 4 },
      { min: 1000, name: 'Voidwalker',  level: 5 },
      { min: 2500, name: 'Singularity', level: 6 }
    ];

    var premiumActive = false;
    var particles = [];
    var particleCanvas = document.getElementById('premiumParticles');
    var particleCtx = particleCanvas.getContext('2d');
    var particleRAF = null;

    function activatePremium() {
      if (premiumActive) return;
      premiumActive = true;
      document.body.classList.add('premium-active');
      // Swap tier names to premium versions
      TIERS = PREMIUM_TIERS;
      // Re-render tier with premium names
      var ctx = window.sloppyBarGetContext ? window.sloppyBarGetContext() : {};
      renderTier(ctx.karma || currentKarma || 0, ctx.verificationLevel || 0);
      // Start particle system
      initParticles();
    }

    function initParticles() {
      var dpr = window.devicePixelRatio || 1;
      function resize() {
        particleCanvas.width = window.innerWidth * dpr;
        particleCanvas.height = window.innerHeight * dpr;
        particleCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
      }
      resize();
      window.addEventListener('resize', resize);

      // Spawn particles
      var COLORS = ['#00e5cc', '#0099ff', '#a855f7', '#ffd700', '#ff6b4a'];
      var COUNT = 35;

      for (var i = 0; i < COUNT; i++) {
        particles.push({
          x: Math.random() * window.innerWidth,
          y: Math.random() * window.innerHeight,
          vx: (Math.random() - 0.5) * 0.3,
          vy: -0.15 - Math.random() * 0.4,
          size: 1 + Math.random() * 2,
          color: COLORS[Math.floor(Math.random() * COLORS.length)],
          alpha: 0.2 + Math.random() * 0.4,
          pulse: Math.random() * Math.PI * 2,
          pulseSpeed: 0.02 + Math.random() * 0.03
        });
      }

      function tick() {
        particleCtx.clearRect(0, 0, window.innerWidth, window.innerHeight);

        for (var i = 0; i < particles.length; i++) {
          var p = particles[i];
          p.x += p.vx;
          p.y += p.vy;
          p.pulse += p.pulseSpeed;

          // Wrap around
          if (p.y < -10) { p.y = window.innerHeight + 10; p.x = Math.random() * window.innerWidth; }
          if (p.x < -10) p.x = window.innerWidth + 10;
          if (p.x > window.innerWidth + 10) p.x = -10;

          var alpha = p.alpha * (0.5 + 0.5 * Math.sin(p.pulse));
          particleCtx.beginPath();
          particleCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
          particleCtx.fillStyle = p.color;
          particleCtx.globalAlpha = alpha;
          particleCtx.fill();

          // Glow
          particleCtx.beginPath();
          particleCtx.arc(p.x, p.y, p.size * 3, 0, Math.PI * 2);
          particleCtx.fillStyle = p.color;
          particleCtx.globalAlpha = alpha * 0.15;
          particleCtx.fill();
        }

        particleCtx.globalAlpha = 1;
        particleRAF = requestAnimationFrame(tick);
      }

      tick();
    }

    // =========================================================
    //  Init ‚Äî sync hub + leaderboard + graph
    // =========================================================

    function init() {
      // Try immediate context
      if (window.sloppyBarGetContext) {
        var ctx = window.sloppyBarGetContext(function(readyCtx) {
          if (readyCtx && readyCtx.ready) {
            renderAll(readyCtx);
            addFeedEvent('context-ready', readyCtx);
            // Record initial snapshot + load history
            recordSnapshot(readyCtx.karma || 0, readyCtx);
            loadHistory();
          }
        });
        if (ctx && ctx.ready) {
          renderAll(ctx);
          addFeedEvent('context-ready', ctx);
          recordSnapshot(ctx.karma || 0, ctx);
          loadHistory();
        }
      }

      // Event listeners
      if (window.sloppyBarOn) {
        window.sloppyBarOn('context-ready', function(e) {
          var ctx = window.sloppyBarGetContext ? window.sloppyBarGetContext() : (e && e.data);
          renderAll(ctx);
        });

        window.sloppyBarOn('karma-changed', function(e) {
          var d = e && e.data;
          if (!d) return;
          var newKarma = d.karma != null ? d.karma : currentKarma;
          var delta = d.delta || (newKarma - currentKarma);
          renderKarma(newKarma, d.rank || null);
          animateKarmaDelta(delta);
          renderTier(newKarma, (window.sloppyBarGetContext && window.sloppyBarGetContext().verificationLevel) || 0);
          addFeedEvent('karma-changed', d);
          // Record snapshot for graph
          recordSnapshot(newKarma, null);
        });

        window.sloppyBarOn('verification-changed', function(e) {
          var d = e && e.data;
          if (!d) return;
          renderTrust(d.trustScore || 0);
          renderVerification(d.verifiedProviders || [], d.verificationLevel || 0);
          var ctx = window.sloppyBarGetContext ? window.sloppyBarGetContext() : {};
          renderTier(ctx.karma || 0, d.verificationLevel || 0);
          addFeedEvent('verification-changed', d);
        });

        window.sloppyBarOn('identity-changed', function(e) {
          var d = e && e.data;
          if (!d) return;
          var ctx = window.sloppyBarGetContext ? window.sloppyBarGetContext() : {};
          // Merge identity data into context for profile render
          var merged = Object.assign({}, ctx, d);
          renderProfile(merged);
          addFeedEvent('identity-changed', d);
        });

        window.sloppyBarOn('auth-changed', function(e) {
          addFeedEvent('auth-changed', e && e.data);
        });

        window.sloppyBarOn('theme-changed', function(e) {
          addFeedEvent('theme-changed', e && e.data);
        });

        window.sloppyBarOn('unread-changed', function(e) {
          addFeedEvent('unread-changed', e && e.data);
        });
      }

      // Load leaderboard (DB query, independent of sync hub)
      loadLeaderboard();

      // Refresh leaderboard on karma changes (someone in community gained karma)
      if (window.sloppyBarOn) {
        window.sloppyBarOn('karma-changed', function() {
          // Debounce: don't refresh more than once per 30s
          if (!window._lbLastRefresh || Date.now() - window._lbLastRefresh > 30000) {
            window._lbLastRefresh = Date.now();
            loadLeaderboard();
          }
        });
      }

      // Fallback: if sync hub doesn't load within 8s, show a message
      setTimeout(function() {
        if ($dashboard.style.display === 'none') {
          var wt = document.querySelector('.waiting-text');
          if (wt) wt.textContent = 'Sync hub not detected ‚Äî try refreshing';
        }
      }, 8000);
    }

    // Start when DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

  })();
  </script>
</body>
</html>
