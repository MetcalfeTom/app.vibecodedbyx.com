<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows 95 Simulator - Nostalgic Desktop Experience</title>
    <link rel="icon" href="https://emojicdn.elk.sh/💻">

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Windows 95 Simulator - Nostalgic Desktop Experience">
    <meta property="og:description" content="Experience the classic Windows 95 desktop! Complete with Start menu, draggable windows, and retro applications.">
    <meta property="og:url" content="https://app.vibecodedbyx.com/windows-95">
    <meta property="og:image" content="https://app.vibecodedbyx.com/windows-95/win95-preview.png">
    <meta property="og:type" content="website">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "MS Sans Serif", sans-serif;
            font-size: 11px;
            overflow: hidden;
            background: #ffeb3b;
            user-select: none;
            cursor: default;
        }

        .desktop {
            width: 100vw;
            height: 100vh;
            background: #ffeb3b;
            position: relative;
            background-image:
                linear-gradient(45deg, #ffeb3b 25%, transparent 25%),
                linear-gradient(-45deg, #ffeb3b 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #ffeb3b 75%),
                linear-gradient(-45deg, transparent 75%, #ffeb3b 75%);
            background-size: 4px 4px;
            background-position: 0 0, 0 2px, 2px -2px, -2px 0px;
        }

        .taskbar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: #c0c0c0;
            border-top: 2px solid #ffffff;
            border-left: 1px solid #ffffff;
            border-right: 1px solid #808080;
            display: flex;
            align-items: center;
            z-index: 1000;
        }

        .start-button {
            height: 30px;
            margin: 2px 4px;
            padding: 0 20px 0 8px;
            background: #c0c0c0;
            border: 2px outset #c0c0c0;
            font-family: "MS Sans Serif", sans-serif;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            align-items: center;
            cursor: pointer;
            position: relative;
        }

        .start-button:active {
            border: 2px inset #c0c0c0;
        }

        .start-button::before {
            content: "🪟";
            margin-right: 6px;
        }

        .taskbar-systray {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 2px;
            padding-right: 4px;
        }

        .taskbar-button {
            padding: 2px 6px;
            border: 1px outset #c0c0c0;
            background: #c0c0c0;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            font-family: 'MS Sans Serif', sans-serif;
        }

        .taskbar-button:hover {
            background: #d4d0c8;
        }

        .taskbar-button:active {
            border: 1px inset #c0c0c0;
        }

        .taskbar-time {
            margin-right: 8px;
            padding: 4px 8px;
            border: 1px inset #c0c0c0;
            background: #c0c0c0;
            font-family: "MS Sans Serif", sans-serif;
            font-size: 11px;
        }

        .start-menu {
            position: absolute;
            bottom: 40px;
            left: 2px;
            width: 250px;
            background: #c0c0c0;
            border: 2px outset #c0c0c0;
            display: none;
            z-index: 1001;
        }

        .start-menu-header {
            background: linear-gradient(90deg, #000080, #0000ff);
            color: white;
            padding: 8px;
            font-weight: bold;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            width: 30px;
            float: left;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .start-menu-items {
            margin-left: 30px;
            padding: 4px 0;
        }

        .start-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .start-menu-item:hover {
            background: #0000ff;
            color: white;
        }

        .start-menu-item::before {
            margin-right: 8px;
            width: 16px;
            text-align: center;
        }

        .start-menu-item.has-submenu {
            position: relative;
        }

        .start-menu-item.has-submenu::after {
            content: '▶';
            position: absolute;
            right: 8px;
            font-size: 8px;
        }

        .start-submenu {
            position: absolute;
            left: 100%;
            top: -4px;
            width: 200px;
            background: #c0c0c0;
            border: 2px outset #c0c0c0;
            display: none;
            z-index: 1002;
        }

        .start-menu-item:hover .start-submenu {
            display: block;
        }

        .submenu-item {
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .submenu-item:hover {
            background: #0000ff;
            color: white;
        }

        .window {
            position: absolute;
            background: #c0c0c0;
            border: 2px outset #c0c0c0;
            min-width: 300px;
            min-height: 200px;
            z-index: 100;
        }

        .window.active {
            z-index: 200;
        }

        .window-header {
            background: linear-gradient(90deg, #000080, #0000ff);
            color: white;
            padding: 2px;
            display: flex;
            align-items: center;
            cursor: move;
            height: 20px;
        }

        .window.inactive .window-header {
            background: #808080;
        }

        .window-title {
            flex: 1;
            font-size: 11px;
            font-weight: bold;
            margin-left: 4px;
        }

        .window-controls {
            display: flex;
        }

        .window-control {
            width: 18px;
            height: 14px;
            background: #c0c0c0;
            border: 1px outset #c0c0c0;
            margin-left: 2px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: bold;
        }

        .window-control:active {
            border: 1px inset #c0c0c0;
        }

        .window-content {
            padding: 8px;
            background: white;
            height: calc(100% - 20px);
            overflow: auto;
        }

        .desktop-icon {
            position: absolute;
            width: 64px;
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 4px;
            color: white;
            text-shadow: 1px 1px 0px #000000;
        }

        .desktop-icon:hover {
            background: rgba(0, 0, 255, 0.3);
        }

        .desktop-icon-image {
            font-size: 32px;
            margin-bottom: 4px;
        }

        .desktop-icon-label {
            font-size: 11px;
            text-align: center;
            word-wrap: break-word;
        }

        .notepad {
            font-family: "Courier New", monospace;
            font-size: 12px;
        }

        .calculator {
            font-family: "MS Sans Serif", sans-serif;
            width: 280px;
            height: 380px;
        }

        .calc-display {
            background: #1a1a1a;
            color: #ff3300;
            padding: 16px 12px;
            text-align: right;
            font-size: 32px;
            margin: 8px;
            border: 3px inset #808080;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            letter-spacing: 2px;
            text-shadow: 0 0 8px #ff3300, 0 0 4px #ff3300;
            box-shadow: inset 0 0 12px rgba(0, 0, 0, 0.8);
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            padding: 8px;
        }

        .calc-button {
            height: 48px;
            background: linear-gradient(180deg, #d4d0c8 0%, #c0c0c0 100%);
            border: 2px outset #c0c0c0;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            font-family: "MS Sans Serif", sans-serif;
            transition: all 0.1s;
        }

        .calc-button:hover {
            background: linear-gradient(180deg, #e0dcd4 0%, #d0d0d0 100%);
        }

        .calc-button:active {
            border: 2px inset #c0c0c0;
            background: #a0a0a0;
            transform: translateY(1px);
        }

        .calc-button.operator {
            background: linear-gradient(180deg, #e8e4e0 0%, #d4d0c8 100%);
            color: #000080;
        }

        .calc-button.equals {
            background: linear-gradient(180deg, #0080ff 0%, #0060c0 100%);
            color: white;
        }

        .calc-button.equals:hover {
            background: linear-gradient(180deg, #0090ff 0%, #0070d0 100%);
        }

        /* Clippy */
        #clippy {
            position: fixed;
            bottom: 60px;
            right: 20px;
            width: 120px;
            background: #ffffe1;
            border: 2px outset #c0c0c0;
            padding: 10px;
            font-size: 10px;
            box-shadow: 4px 4px 8px rgba(0,0,0,0.3);
            display: none;
            z-index: 10000;
            animation: clippy-bounce 0.5s ease-out;
        }

        @keyframes clippy-bounce {
            0% { transform: translateY(100px); opacity: 0; }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0); opacity: 1; }
        }

        #clippy-character {
            font-size: 48px;
            text-align: center;
            margin-bottom: 8px;
            animation: clippy-blink 3s infinite;
        }

        @keyframes clippy-blink {
            0%, 48%, 52%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(0.1); }
        }

        #clippy-text {
            line-height: 1.4;
            color: #000;
        }

        #clippy-close {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 14px;
            height: 14px;
            border: 1px outset #c0c0c0;
            background: #c0c0c0;
            cursor: pointer;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #clippy-close:active {
            border: 1px inset #c0c0c0;
        }

        /* Screensaver */
        #screensaver {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 100000;
            display: none;
            cursor: none;
        }

        #screensaver canvas {
            width: 100%;
            height: 100%;
        }

        .paint-canvas {
            border: 1px inset #c0c0c0;
            cursor: crosshair;
        }

        .paint-toolbar {
            background: #c0c0c0;
            border-bottom: 1px solid #808080;
            padding: 4px;
            display: flex;
            gap: 4px;
        }

        .paint-tool {
            width: 24px;
            height: 24px;
            background: #c0c0c0;
            border: 1px outset #c0c0c0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .paint-tool:active, .paint-tool.active {
            border: 1px inset #c0c0c0;
        }

        /* Windows Dialog System */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .dialog-box {
            background: #c0c0c0;
            border: 2px outset #c0c0c0;
            min-width: 300px;
            max-width: 500px;
            font-family: 'MS Sans Serif', sans-serif;
            font-size: 11px;
        }

        .dialog-title {
            background: linear-gradient(90deg, #0000FF, #4080FF);
            color: white;
            padding: 2px 4px;
            font-weight: bold;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dialog-content {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .dialog-icon {
            font-size: 32px;
            flex-shrink: 0;
        }

        .dialog-message {
            flex-grow: 1;
            line-height: 1.4;
        }

        .dialog-buttons {
            padding: 10px 20px 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .dialog-button {
            background: #c0c0c0;
            border: 1px outset #c0c0c0;
            padding: 5px 20px;
            cursor: pointer;
            font-family: 'MS Sans Serif', sans-serif;
            font-size: 11px;
            min-width: 75px;
        }

        .dialog-button:active {
            border: 1px inset #c0c0c0;
        }

        .dialog-button:focus {
            outline: 1px dotted black;
            outline-offset: -3px;
        }

        @media (max-width: 768px) {
            .start-menu {
                width: 200px;
            }

            .window {
                min-width: 250px;
                min-height: 150px;
            }

            .desktop-icon {
                width: 54px;
                height: 70px;
            }

            .desktop-icon-image {
                font-size: 24px;
            }
        }
        /* Windows 95 Dialog Styles */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .dialog {
            background: #c0c0c0;
            border: 2px outset #c0c0c0;
            min-width: 300px;
            max-width: 500px;
            font-family: 'MS Sans Serif', sans-serif;
            font-size: 11px;
        }

        .dialog-header {
            background: linear-gradient(90deg, #0000ff, #0080ff);
            color: white;
            padding: 2px 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }

        .dialog-close {
            background: #c0c0c0;
            border: 1px outset #c0c0c0;
            width: 16px;
            height: 14px;
            font-size: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dialog-close:active {
            border: 1px inset #c0c0c0;
        }

        .dialog-body {
            padding: 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .dialog-icon {
            font-size: 32px;
            flex-shrink: 0;
        }

        .dialog-message {
            flex: 1;
            line-height: 1.4;
        }

        .dialog-buttons {
            padding: 8px 16px 16px;
            text-align: center;
        }

        .dialog-button {
            background: #c0c0c0;
            border: 2px outset #c0c0c0;
            padding: 4px 16px;
            margin: 0 4px;
            cursor: pointer;
            font-family: 'MS Sans Serif', sans-serif;
            font-size: 11px;
        }

        .dialog-button:active {
            border: 2px inset #c0c0c0;
        }

        .dialog-button:focus {
            outline: 1px dotted #000;
            outline-offset: -3px;
        }
    </style>
</head>
<body>
    <div class="desktop" id="desktop">
        <!-- Desktop Icons -->
        <div class="desktop-icon" style="top: 20px; left: 20px;" ondblclick="openWindow('mycomputer')">
            <div class="desktop-icon-image">🖥️</div>
            <div class="desktop-icon-label">My Computer</div>
        </div>

        <div class="desktop-icon" style="top: 120px; left: 20px;" ondblclick="openWindow('notepad')">
            <div class="desktop-icon-image">📝</div>
            <div class="desktop-icon-label">Notepad</div>
        </div>

        <div class="desktop-icon" style="top: 220px; left: 20px;" ondblclick="openWindow('paint')">
            <div class="desktop-icon-image">🎨</div>
            <div class="desktop-icon-label">Paint</div>
        </div>

        <div class="desktop-icon" style="top: 320px; left: 20px;" ondblclick="openWindow('calculator')">
            <div class="desktop-icon-image">🧮</div>
            <div class="desktop-icon-label">Calculator</div>
        </div>

        <div class="desktop-icon" style="top: 420px; left: 20px;" ondblclick="openWindow('browser')">
            <div class="desktop-icon-image">🌐</div>
            <div class="desktop-icon-label">Browser</div>
        </div>

        <div class="desktop-icon" style="top: 20px; left: 100px;" ondblclick="openWindow('minesweeper')">
            <div class="desktop-icon-image">💣</div>
            <div class="desktop-icon-label">Minesweeper</div>
        </div>

        <div class="desktop-icon" style="top: 120px; left: 100px;" ondblclick="openWindow('solitaire')">
            <div class="desktop-icon-image">🃏</div>
            <div class="desktop-icon-label">Solitaire</div>
        </div>

        <div class="desktop-icon" style="top: 220px; left: 100px;" ondblclick="openWindow('tetris')">
            <div class="desktop-icon-image">🧱</div>
            <div class="desktop-icon-label">Tetris</div>
        </div>

        <!-- Taskbar -->
        <div class="taskbar">
            <div class="start-button" onclick="toggleStartMenu()">Start</div>
            <div class="taskbar-systray">
                <div class="taskbar-button" id="muteButton" onclick="toggleMute()" title="Volume Control">
                    <span id="muteIcon">🔊</span>
                </div>
            </div>
            <div class="taskbar-time" id="taskbarTime">12:00 PM</div>
        </div>

        <!-- Start Menu -->
        <div class="start-menu" id="startMenu">
            <div class="start-menu-header">Windows 95</div>
            <div class="start-menu-items">
                <div class="start-menu-item" onclick="openWindow('notepad')">
                    <span style="margin-right: 8px;">📝</span>Notepad
                </div>
                <div class="start-menu-item" onclick="openWindow('calculator')">
                    <span style="margin-right: 8px;">🧮</span>Calculator
                </div>
                <div class="start-menu-item" onclick="openWindow('paint')">
                    <span style="margin-right: 8px;">🎨</span>Paint
                </div>
                <div class="start-menu-item" onclick="openWindow('browser')">
                    <span style="margin-right: 8px;">🌐</span>Browser
                </div>
                <div class="start-menu-item has-submenu">
                    <span style="margin-right: 8px;">🎮</span>Games
                    <div class="start-submenu">
                        <div class="submenu-item" onclick="openWindow('minesweeper'); event.stopPropagation();">
                            <span style="margin-right: 8px;">💣</span>Minesweeper
                        </div>
                        <div class="submenu-item" onclick="openWindow('solitaire'); event.stopPropagation();">
                            <span style="margin-right: 8px;">🃏</span>Solitaire
                        </div>
                        <div class="submenu-item" onclick="openWindow('tetris'); event.stopPropagation();">
                            <span style="margin-right: 8px;">🧱</span>Tetris
                        </div>
                    </div>
                </div>
                <div class="start-menu-item" onclick="openScreensaverSettings()">
                    <span style="margin-right: 8px;">🖥️</span>Screensaver...
                </div>
                <div class="start-menu-item" onclick="openWindow('about')">
                    <span style="margin-right: 8px;">ℹ️</span>About Windows
                </div>
                <hr style="margin: 4px 8px; border: 1px inset #c0c0c0;">
                <div class="start-menu-item" onclick="showShutdown()">
                    <span style="margin-right: 8px;">⏻</span>Shut Down...
                </div>
            </div>
        </div>
    </div>

    <!-- Backlink (hidden initially) -->
    <div id="backlink" style="position: fixed; bottom: 50px; right: 20px; background: rgba(192,192,192,0.9); padding: 10px; border: 2px outset #c0c0c0; font-size: 11px; display: none;">
        🎬 Built live at <a href="https://www.vibecodedbyx.com" target="_blank" style="color: #000080;">VibeCodedByX.com</a>
    </div>

    <!-- Clippy -->
    <div id="clippy">
        <div id="clippy-close" onclick="hideClippy()">×</div>
        <div id="clippy-character">📎</div>
        <div id="clippy-text"></div>
    </div>

    <!-- Screensaver -->
    <div id="screensaver">
        <canvas id="screensaver-canvas"></canvas>
    </div>

    <!-- Windows Dialog Overlay -->
    <div class="dialog-overlay" id="dialogOverlay">
        <div class="dialog-box" id="dialogBox">
            <div class="dialog-title" id="dialogTitle">Windows</div>
            <div class="dialog-content">
                <div class="dialog-icon" id="dialogIcon">ℹ️</div>
                <div class="dialog-message" id="dialogMessage"></div>
            </div>
            <div class="dialog-buttons" id="dialogButtons">
                <button class="dialog-button" onclick="closeDialog()">OK</button>
            </div>
        </div>
    </div>

    <!-- Import modular app files -->
    <script src="apps/calculator.js"></script>
    <script src="apps/paint.js"></script>
    <script src="apps/minesweeper.js"></script>
    <script src="apps/solitaire.js"></script>
    <script src="apps/tetris.js"></script>

    <script>
        let windowCounter = 0;
        let activeWindow = null;
        let zIndex = 100;
        let startMenuOpen = false;
        let soundMuted = false;

        // Sound System - Using Web Audio API to create authentic Windows 95 sounds
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            if (soundMuted) return; // Don't play sound if muted
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            let frequency, duration, volume;

            switch(type) {
                case 'startup':
                    // Classic Windows 95 startup chord
                    playStartupChord();
                    return;
                case 'click':
                    frequency = 800;
                    duration = 0.1;
                    volume = 0.1;
                    break;
                case 'open':
                    frequency = 523;
                    duration = 0.15;
                    volume = 0.15;
                    break;
                case 'close':
                    frequency = 392;
                    duration = 0.2;
                    volume = 0.12;
                    break;
                case 'error':
                    frequency = 200;
                    duration = 0.5;
                    volume = 0.2;
                    oscillator.type = 'sawtooth';
                    break;
                case 'minimize':
                    frequency = 659;
                    duration = 0.1;
                    volume = 0.1;
                    break;
                case 'maximize':
                    frequency = 880;
                    duration = 0.1;
                    volume = 0.1;
                    break;
                case 'shutdown':
                    playShutdownSound();
                    return;
            }

            oscillator.frequency.value = frequency;
            gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        function playStartupChord() {
            // Windows 95 startup chord - multiple frequencies
            const frequencies = [261.63, 329.63, 392.00, 523.25]; // C-E-G-C major chord

            frequencies.forEach((freq, index) => {
                setTimeout(() => {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();

                    osc.connect(gain);
                    gain.connect(audioContext.destination);

                    osc.frequency.value = freq;
                    osc.type = 'sine';
                    gain.gain.setValueAtTime(0.15, audioContext.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 2);

                    osc.start(audioContext.currentTime);
                    osc.stop(audioContext.currentTime + 2);
                }, index * 100);
            });
        }

        function playShutdownSound() {
            // Windows 95 shutdown sound - descending notes
            const frequencies = [523.25, 392.00, 329.63, 261.63]; // C-G-E-C descending

            frequencies.forEach((freq, index) => {
                setTimeout(() => {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();

                    osc.connect(gain);
                    gain.connect(audioContext.destination);

                    osc.frequency.value = freq;
                    osc.type = 'sine';
                    gain.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);

                    osc.start(audioContext.currentTime);
                    osc.stop(audioContext.currentTime + 0.8);
                }, index * 400);
            });
        }

        // Update time
        function updateTime() {
            const now = new Date();
            const time = now.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
            document.getElementById('taskbarTime').textContent = time;
        }

        setInterval(updateTime, 1000);
        updateTime();

        // Start menu toggle
        function toggleStartMenu() {
            playSound('click');
            const menu = document.getElementById('startMenu');
            startMenuOpen = !startMenuOpen;
            menu.style.display = startMenuOpen ? 'block' : 'none';
        }

        // Close start menu when clicking elsewhere
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.start-button') && !e.target.closest('.start-menu')) {
                document.getElementById('startMenu').style.display = 'none';
                startMenuOpen = false;
            }
        });

        // Window management
        function openWindow(type) {
            playSound('open');
            document.getElementById('startMenu').style.display = 'none';
            startMenuOpen = false;

            const windowId = `window-${++windowCounter}`;
            const window = document.createElement('div');
            window.className = 'window active';
            window.id = windowId;
            window.style.left = (50 + windowCounter * 30) + 'px';
            window.style.top = (50 + windowCounter * 30) + 'px';
            window.style.zIndex = ++zIndex;

            let title, content;

            switch(type) {
                case 'notepad':
                    title = 'Untitled - Notepad';
                    content = '<textarea class="notepad" style="width: 100%; height: 100%; border: none; outline: none; resize: none;" placeholder="Type your text here..."></textarea>';
                    window.style.width = '500px';
                    window.style.height = '400px';
                    break;

                case 'calculator':
                    title = 'Calculator';
                    content = createCalculatorContent();
                    window.style.width = '280px';
                    window.style.height = '410px'; // Increased to avoid scrollbar
                    break;

                case 'paint':
                    title = 'untitled - Paint';
                    content = createPaintContent();
                    window.style.width = '600px';
                    window.style.height = '450px';
                    break;

                case 'minesweeper':
                    title = 'Minesweeper';
                    content = '<div id="minesweeper-container" style="height: 100%; width: 100%;"></div>';
                    window.style.width = '420px';
                    window.style.height = '500px';
                    break;

                case 'solitaire':
                    title = 'Solitaire';
                    content = '<div id="solitaire-container" style="height: 100%; width: 100%; overflow: auto;"></div>';
                    window.style.width = '640px';
                    window.style.height = '520px';
                    break;

                case 'tetris':
                    title = 'Tetris';
                    content = '<div id="tetris-container" style="height: 100%; width: 100%;"></div>';
                    window.style.width = '580px';
                    window.style.height = '650px';
                    break;

                case 'browser':
                    title = 'Web Explorer';
                    content = createBrowserContent();
                    window.style.width = '560px';
                    window.style.height = '520px';
                    break;

                case 'mycomputer':
                    title = 'My Computer';
                    content = `<div style="padding: 20px;">
                        <div style="display: flex; align-items: center; margin: 10px 0; cursor: pointer;" onclick="playSound('error'); showWindowsDialog('3½ Floppy (A:)', 'Please insert a disk into drive A:', '💾')">
                            <span style="margin-right: 10px; font-size: 16px;">💾</span>3½ Floppy (A:)
                        </div>
                        <div style="display: flex; align-items: center; margin: 10px 0; cursor: pointer;" onclick="playSound('error'); showWindowsDialog('CD-ROM (D:)', 'Please insert a disc into drive D:', '💿')">
                            <span style="margin-right: 10px; font-size: 16px;">💿</span>CD-ROM (D:)
                        </div>
                        <div style="display: flex; align-items: center; margin: 10px 0; cursor: pointer;" onclick="playSound('click'); showWindowsDialog('Hard Disk (C:)', 'Total Size: 2.0 GB<br>Free Space: 1.2 GB', '🗂️')">
                            <span style="margin-right: 10px; font-size: 16px;">🗂️</span>Hard Disk (C:)
                        </div>
                    </div>`;
                    window.style.width = '400px';
                    window.style.height = '300px';
                    break;

                case 'about':
                    title = 'About Windows';
                    content = `<div style="text-align: center; padding: 30px;">
                        <div style="font-size: 24px; margin: 20px 0;">🪟</div>
                        <h2>Microsoft Windows 95</h2>
                        <p style="margin: 20px 0;">Version 4.00.950</p>
                        <p>Copyright © 1981-1995 Microsoft Corp.</p>
                        <br>
                        <p><strong>This is a nostalgic recreation!</strong></p>
                        <p style="margin-top: 20px; font-size: 10px; color: #666;">Built with ❤️ for retro computing fans</p>
                    </div>`;
                    window.style.width = '350px';
                    window.style.height = '340px'; // Increased to avoid scrollbar
                    break;

                default:
                    title = 'Unknown Application';
                    content = '<p>Application not found.</p>';
            }

            window.innerHTML = `
                <div class="window-header" onmousedown="startDrag(event, '${windowId}')">
                    <div class="window-title">${title}</div>
                    <div class="window-controls">
                        <div class="window-control" onclick="minimizeWindow('${windowId}')">_</div>
                        <div class="window-control" onclick="maximizeWindow('${windowId}')">□</div>
                        <div class="window-control" onclick="closeWindow('${windowId}')">×</div>
                    </div>
                </div>
                <div class="window-content">${content}</div>
            `;

            document.getElementById('desktop').appendChild(window);
            setActiveWindow(windowId);

            // Initialize calculator if needed
            if (type === 'calculator') {
                initCalculator();
            }

            // Initialize Minesweeper if needed
            if (type === 'minesweeper') {
                const container = document.getElementById('minesweeper-container');
                if (container && typeof Minesweeper !== 'undefined') {
                    minesweeper = new Minesweeper(container);
                }
            }
            // Initialize Solitaire if needed
            if (type === 'solitaire') {
                const container = document.getElementById('solitaire-container');
                if (container && typeof Solitaire !== 'undefined') {
                    solitaire = new Solitaire(container);
                }
            }
            // Initialize Tetris if needed
            if (type === 'tetris') {
                const container = document.getElementById('tetris-container');
                if (container && typeof Tetris !== 'undefined') {
                    tetris = new Tetris(container);
                }
            }
            // Initialize Paint app via module if available
            if (type === 'paint') {
                const container = window.querySelector('.window-content');
                if (container && typeof Paint !== 'undefined') {
                    // global instance is defined in apps/paint.js as 'paint'
                    paint = new Paint(container);
                } else {
                    console.error('Paint module not loaded or container missing');
                }
            }

            // Initialize Guestbook (Browser)
            if (type === 'browser') {
                const winEl = document.getElementById(windowId);
                const container = winEl ? winEl.querySelector('#guestbook-container') : null;
                if (container && globalThis.guestbook && typeof globalThis.guestbook.initGuestbook === 'function') {
                    globalThis.guestbook.initGuestbook(container);
                }
            }
        }

        function createCalculatorContent() {
            return `
                <div class="calc-display" id="calcDisplay">0</div>
                <div class="calc-buttons">
                    <div class="calc-button" onclick="calcClear()">C</div>
                    <div class="calc-button" onclick="calcBackspace()">⌫</div>
                    <div class="calc-button operator" onclick="calcOperation('÷')">÷</div>
                    <div class="calc-button operator" onclick="calcOperation('×')">×</div>
                    <div class="calc-button" onclick="calcNumber('7')">7</div>
                    <div class="calc-button" onclick="calcNumber('8')">8</div>
                    <div class="calc-button" onclick="calcNumber('9')">9</div>
                    <div class="calc-button operator" onclick="calcOperation('-')">−</div>
                    <div class="calc-button" onclick="calcNumber('4')">4</div>
                    <div class="calc-button" onclick="calcNumber('5')">5</div>
                    <div class="calc-button" onclick="calcNumber('6')">6</div>
                    <div class="calc-button operator" onclick="calcOperation('+')">+</div>
                    <div class="calc-button" onclick="calcNumber('1')">1</div>
                    <div class="calc-button" onclick="calcNumber('2')">2</div>
                    <div class="calc-button" onclick="calcNumber('3')">3</div>
                    <div class="calc-button equals" onclick="calcEquals()" style="grid-row: span 2;">=</div>
                    <div class="calc-button" onclick="calcNumber('0')" style="grid-column: span 2;">0</div>
                    <div class="calc-button" onclick="calcDecimal()">.</div>
                </div>
            `;
        }

        function createPaintContent() {
            // Let apps/paint.js render its own UI into this container
            return `<div id="paint-container" style="height: 100%;"></div>`;
        }

        function createBrowserContent() {
            return `
                <div class="retro-browser" style="display:flex;flex-direction:column;height:100%;background:#c0c0c0;">
                    <div style="display:flex;align-items:center;gap:6px;padding:6px;border-bottom:2px inset #c0c0c0;background:#d4d0c8;">
                        <div style="border:2px inset #c0c0c0;background:#fff;padding:2px 6px;font-family:'MS Sans Serif';font-size:11px;min-width:200px;max-width:100%;overflow:hidden;">http://guestbook.local/</div>
                        <div style="margin-left:auto;color:#000080;font-size:11px;">Guestbook 1.0</div>
                    </div>
                    <div id="guestbook-container" style="flex:1;padding:8px;overflow:auto;background:#ffffff;">
                        <div style="font-family:'MS Sans Serif';font-size:12px;color:#000;">Loading guestbook…</div>
                    </div>
                </div>
            `;
        }

        // Calculator functionality
        let calcState = { display: '0', operation: null, operand: null, waitingForOperand: false };

        function initCalculator() {
            calcState = { display: '0', operation: null, operand: null, waitingForOperand: false };
        }

        function calcNumber(num) {
            playSound('click');
            const display = document.getElementById('calcDisplay');
            if (calcState.waitingForOperand) {
                calcState.display = num;
                calcState.waitingForOperand = false;
            } else {
                calcState.display = calcState.display === '0' ? num : calcState.display + num;
            }
            display.textContent = calcState.display;
        }

        function calcDecimal() {
            playSound('click');
            if (calcState.waitingForOperand) {
                calcState.display = '0.';
                calcState.waitingForOperand = false;
            } else if (calcState.display.indexOf('.') === -1) {
                calcState.display += '.';
            }
            document.getElementById('calcDisplay').textContent = calcState.display;
        }

        function calcClear() {
            playSound('click');
            calcState = { display: '0', operation: null, operand: null, waitingForOperand: false };
            document.getElementById('calcDisplay').textContent = '0';
        }

        function calcBackspace() {
            playSound('click');
            if (calcState.waitingForOperand) return;

            if (calcState.display.length > 1) {
                calcState.display = calcState.display.slice(0, -1);
            } else {
                calcState.display = '0';
            }
            document.getElementById('calcDisplay').textContent = calcState.display;
        }

        function calcOperation(nextOperation) {
            playSound('click');
            const inputValue = parseFloat(calcState.display);

            if (calcState.operand === null) {
                calcState.operand = inputValue;
            } else if (calcState.operation) {
                const currentValue = calcState.operand || 0;
                const newValue = calculate(currentValue, inputValue, calcState.operation);

                calcState.display = String(newValue);
                calcState.operand = newValue;
                document.getElementById('calcDisplay').textContent = calcState.display;
            }

            calcState.waitingForOperand = true;
            calcState.operation = nextOperation;
        }

        function calcEquals() {
            playSound('click');
            const inputValue = parseFloat(calcState.display);

            if (calcState.operand !== null && calcState.operation) {
                const newValue = calculate(calcState.operand, inputValue, calcState.operation);
                calcState.display = String(newValue);
                calcState.operand = null;
                calcState.operation = null;
                calcState.waitingForOperand = true;
                document.getElementById('calcDisplay').textContent = calcState.display;
            }
        }

        function calculate(firstOperand, secondOperand, operation) {
            switch (operation) {
                case '+': return firstOperand + secondOperand;
                case '-': return firstOperand - secondOperand;
                case '×': return firstOperand * secondOperand;
                case '÷': return firstOperand / secondOperand;
                case '±': return -firstOperand;
                default: return secondOperand;
            }
        }

        // Paint functionality moved to apps/paint.js to avoid duplicate globals

        // Window management functions
        function setActiveWindow(windowId) {
            document.querySelectorAll('.window').forEach(w => {
                w.classList.remove('active');
                w.classList.add('inactive');
            });
            const window = document.getElementById(windowId);
            if (!window) return;
            window.classList.remove('inactive');
            window.classList.add('active');
            window.style.zIndex = ++zIndex;
            activeWindow = windowId;
        }

        function closeWindow(windowId) {
            playSound('close');
            document.getElementById(windowId).remove();
        }

        function minimizeWindow(windowId) {
            playSound('minimize');
            document.getElementById(windowId).style.display = 'none';
        }

        function maximizeWindow(windowId) {
            playSound('maximize');
            const window = document.getElementById(windowId);
            if (window.style.width === '100vw') {
                // Restore
                window.style.width = window.dataset.originalWidth || '400px';
                window.style.height = window.dataset.originalHeight || '300px';
                window.style.left = window.dataset.originalLeft || '100px';
                window.style.top = window.dataset.originalTop || '100px';
            } else {
                // Maximize
                window.dataset.originalWidth = window.style.width;
                window.dataset.originalHeight = window.style.height;
                window.dataset.originalLeft = window.style.left;
                window.dataset.originalTop = window.style.top;
                window.style.width = '100vw';
                window.style.height = 'calc(100vh - 40px)';
                window.style.left = '0';
                window.style.top = '0';
            }
        }

        // Drag functionality
        let isDragging = false;
        let currentWindow = null;
        let dragOffset = { x: 0, y: 0 };

        function startDrag(e, windowId) {
            isDragging = true;
            currentWindow = document.getElementById(windowId);
            setActiveWindow(windowId);

            const rect = currentWindow.getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;

            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
            e.preventDefault();
        }

        function drag(e) {
            if (!isDragging || !currentWindow) return;

            const x = e.clientX - dragOffset.x;
            const y = e.clientY - dragOffset.y;

            currentWindow.style.left = Math.max(0, Math.min(x, window.innerWidth - currentWindow.offsetWidth)) + 'px';
            currentWindow.style.top = Math.max(0, Math.min(y, window.innerHeight - currentWindow.offsetHeight - 40)) + 'px';
        }

        function stopDrag() {
            isDragging = false;
            currentWindow = null;
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', stopDrag);
        }

        // Click to focus windows
        document.addEventListener('click', (e) => {
            const window = e.target.closest('.window');
            if (window) {
                setActiveWindow(window.id);
            }
        });

        function showShutdown() {
            playSound('click');
            showWindowsDialog(
                'Shut Down Windows',
                'Are you sure you want to shut down Windows 95?',
                '⏻',
                [
                    { text: 'Cancel', callback: null },
                    { text: 'OK', callback: () => {
                        playSound('shutdown');
                        document.body.innerHTML = '<div style="background: #000; color: white; display: flex; align-items: center; justify-content: center; height: 100vh; font-family: MS Sans Serif;"><div style="text-align: center;"><div style="font-size: 24px; margin-bottom: 20px;">💻</div><div>It\'s now safe to turn off your computer.</div><div style="margin-top: 20px; font-size: 12px;"><a href="javascript:startPowerOn()" style="color: #87CEEB;">Click here to restart</a></div></div></div>';
                    } }
                ]
            );
        }

        // Fake startup sequence after pressing Power
        function startPowerOn() {
            // Stage 1: BIOS/POST style text
            document.body.innerHTML = '<div id="boot" style="background:#000; color:#0f0; font-family: \'Courier New\', monospace; padding:16px; height:100vh; white-space:pre-wrap;"></div>';
            const lines = [
                'PhoenixBIOS 4.0 Release 6.0',
                '(C) 1985-1998 Phoenix Technologies Ltd',
                'CPU: Intel(R) Pentium 166MHz',
                'Memory Test: 65536K OK',
                'Primary Master: ST310212A 10.2GB',
                'Secondary Master: ATAPI CDROM 24X',
                'Initializing Plug and Play cards...',
                'Press DEL to enter SETUP',
                'Boot from C:\\',
            ];

            const boot = document.getElementById('boot');
            let i = 0;
            const step = () => {
                if (!boot) return;
                if (i < lines.length) {
                    boot.innerHTML += lines[i++] + '\n';
                    setTimeout(step, 250);
                } else {
                    showWin95Splash();
                }
            };
            setTimeout(step, 500);

            function showWin95Splash() {
                document.body.innerHTML = `
                    <div id="splash" style="background:#008080; height:100vh; display:flex; align-items:center; justify-content:center; font-family:'MS Sans Serif', sans-serif;">
                      <div style="text-align:center; color:#ffffff;">
                        <div style="font-size:44px; margin-bottom:8px; text-shadow:2px 2px #000080;">🪟 Windows 95</div>
                        <div style="width:320px; height:12px; background:#c0c0c0; border:2px inset #808080; margin:16px auto; overflow:hidden; position:relative;">
                          <div id="progressBar" style="height:100%; width:0; background:#0000aa;"></div>
                        </div>
                        <div style="font-size:12px; opacity:0.9;">Starting up...</div>
                      </div>
                    </div>`;
                try { playSound('startup'); } catch (e) {}
                let w = 0;
                const bar = document.getElementById('progressBar');
                const iv = setInterval(() => {
                    w += Math.floor(Math.random()*7)+3; // jittery progress
                    if (w > 100) w = 100;
                    if (bar) bar.style.width = w + '%';
                    if (w >= 100) {
                        clearInterval(iv);
                        setTimeout(() => { location.reload(); }, 500);
                    }
                }, 120);
            }
        }

        // Show backlink after 5 seconds
        setTimeout(() => {
            document.getElementById('backlink').style.display = 'block';
        }, 5000);

        // Windows Dialog System
        function showWindowsDialog(title, message, icon = 'ℹ️', buttons = [{ text: 'OK', callback: null }]) {
            playSound('error'); // Play Windows error sound for dialogs

            const overlay = document.getElementById('dialogOverlay');
            const titleElement = document.getElementById('dialogTitle');
            const iconElement = document.getElementById('dialogIcon');
            const messageElement = document.getElementById('dialogMessage');
            const buttonsContainer = document.getElementById('dialogButtons');

            titleElement.textContent = title;
            iconElement.textContent = icon;
            messageElement.textContent = message;

            // Clear existing buttons and add new ones
            buttonsContainer.innerHTML = '';
            buttons.forEach(button => {
                const btn = document.createElement('button');
                btn.className = 'dialog-button';
                btn.textContent = button.text;
                btn.onclick = () => {
                    closeDialog();
                    if (button.callback) button.callback();
                };
                buttonsContainer.appendChild(btn);
            });

            overlay.style.display = 'flex';

            // Focus the first button
            setTimeout(() => {
                buttonsContainer.firstElementChild?.focus();
            }, 100);
        }

        function closeDialog() {
            document.getElementById('dialogOverlay').style.display = 'none';
        }

        // Close dialog when clicking overlay (but not the dialog box itself)
        document.getElementById('dialogOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDialog();
            }
        });

        // Handle Escape key to close dialog
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('dialogOverlay').style.display === 'flex') {
                closeDialog();
            }
        });

        // Mute functionality for system tray
        function toggleMute() {
            soundMuted = !soundMuted;
            const muteIcon = document.getElementById('muteIcon');
            const muteButton = document.getElementById('muteButton');

            if (soundMuted) {
                muteIcon.textContent = '🔇';
                muteButton.title = 'Volume Control - Muted';
            } else {
                muteIcon.textContent = '🔊';
                muteButton.title = 'Volume Control - Unmuted';
                // Play a test sound to indicate unmuting
                playSound('click');
            }

            // Save mute state to localStorage
            localStorage.setItem('windows95_muted', soundMuted.toString());
        }

        // Load mute state from localStorage on page load
        function loadMuteState() {
            const savedMuteState = localStorage.getItem('windows95_muted');
            if (savedMuteState === 'true') {
                soundMuted = true;
                document.getElementById('muteIcon').textContent = '🔇';
                document.getElementById('muteButton').title = 'Volume Control - Muted';
            }
        }

        // Play startup sound on page load
        window.addEventListener('load', () => {
            // Load mute state first
            loadMuteState();

            // Wait a moment for the page to fully render, then play startup sound
            setTimeout(() => {
                // Try to play startup sound, but handle browsers that require user interaction
                try {
                    playSound('startup');
                } catch (e) {
                    // If audio context is suspended, we'll play sound on first user interaction
                    document.addEventListener('click', function playStartupOnFirstClick() {
                        playSound('startup');
                        document.removeEventListener('click', playStartupOnFirstClick);
                    }, { once: true });
                }
            }, 500);
        });
        // Windows 95 Dialog System
        function showWindowsDialog(title, message, icon = '⚠️') {
            // Create dialog overlay if it doesn't exist
            let overlay = document.getElementById('dialog-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'dialog-overlay';
                overlay.className = 'dialog-overlay';
                document.body.appendChild(overlay);
            }

            // Create dialog HTML
            overlay.innerHTML = `
                <div class="dialog">
                    <div class="dialog-header">
                        <span>${title}</span>
                        <div class="dialog-close" onclick="hideWindowsDialog()">×</div>
                    </div>
                    <div class="dialog-body">
                        <div class="dialog-icon">${icon}</div>
                        <div class="dialog-message">${message}</div>
                    </div>
                    <div class="dialog-buttons">
                        <button class="dialog-button" onclick="hideWindowsDialog()" autofocus>OK</button>
                    </div>
                </div>
            `;

            // Show dialog
            overlay.style.display = 'flex';

            // Focus the OK button
            setTimeout(() => {
                const okButton = overlay.querySelector('.dialog-button');
                if (okButton) okButton.focus();
            }, 100);
        }

        function hideWindowsDialog() {
            const overlay = document.getElementById('dialog-overlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        // Close dialog on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                hideWindowsDialog();
            }
        });

        // Route native alerts through the Windows 95 dialog UI
        window.alert = function(message) {
            try {
                showWindowsDialog('Windows', String(message), 'ℹ️');
            } catch (e) {
                // Fallback (should rarely occur)
                console.log('Alert:', message);
            }
        };

        // Override shutdown to show a themed confirm and a power screen
        function showShutdown() {
            try { playSound('click'); } catch (e) {}
            const overlay = document.getElementById('dialogOverlay');
            const titleElement = document.getElementById('dialogTitle');
            const iconElement = document.getElementById('dialogIcon');
            const messageElement = document.getElementById('dialogMessage');
            const buttonsContainer = document.getElementById('dialogButtons');

            if (!overlay || !titleElement || !iconElement || !messageElement || !buttonsContainer) {
                // Fallback: simple reload confirm if themed dialog not found
                if (confirm('Shut down Windows 95?')) startPowerOn();
                return;
            }

            titleElement.textContent = 'Shut Down Windows';
            iconElement.textContent = '⏻';
            messageElement.textContent = 'Are you sure you want to shut down Windows 95?';

            buttonsContainer.innerHTML = '';
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'dialog-button';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.onclick = () => closeDialog();

            const okBtn = document.createElement('button');
            okBtn.className = 'dialog-button';
            okBtn.textContent = 'OK';
            okBtn.onclick = () => {
                closeDialog();
                try { playSound('shutdown'); } catch (e) {}
                document.body.innerHTML = `
                  <div style="background:#000; color:#d0d0d0; display:flex; align-items:center; justify-content:center; height:100vh; font-family:'MS Sans Serif', sans-serif;">
                    <div style="text-align:center;">
                      <div style="font-size:16px; margin-bottom:16px; color:#b0b0b0;">It's now safe to turn off your computer.</div>
                      <div style="display:inline-block; padding:20px; background:#101010; border:3px outset #333;">
                        <div style="width:260px; height:160px; background:#1c1c1c; border:2px inset #444; margin:0 auto 16px;"></div>
                        <div style="width:260px; height:40px; background:#0f3; border:2px inset #0a2; margin:0 auto 16px;"></div>
                        <button onclick="startPowerOn()" style="padding:8px 18px; background:#c0c0c0; border:2px outset #c0c0c0; cursor:pointer; font-weight:bold;">Power</button>
                      </div>
                    </div>
                  </div>`;
            };

            buttonsContainer.appendChild(cancelBtn);
            buttonsContainer.appendChild(okBtn);

            overlay.style.display = 'flex';
            setTimeout(() => { okBtn.focus(); }, 100);
        }
</script>

    <!-- Guestbook module for Browser (uses Supabase) -->
    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

        const SUPABASE_URL = 'https://yjyxteqzhhmtrgcaekgz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM8IS32IUYR2eenCCjdDdioiBU';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function supabaseSession() {
            const sessRes = await supabase.auth.getSession();
            let session = sessRes.data.session;
            if (!session) {
                const signRes = await supabase.auth.signInAnonymously();
                session = signRes.data.session;
                try {
                    if (session?.user?.id) {
                        await supabase.from('users').upsert({ user_id: session.user.id, updated_at: new Date().toISOString() });
                    }
                } catch(e) { /* non-fatal */ }
            }
            return { session: session, user: session.user };
        }

        function el(tag, attrs = {}, children = []) {
            const e = document.createElement(tag);
            Object.entries(attrs).forEach(([k,v]) => { if (k === 'class') e.className = v; else if (k === 'style') e.style.cssText = v; else e.setAttribute(k, v); });
            (Array.isArray(children) ? children : [children]).forEach(c => {
                if (c == null) return; if (typeof c === 'string') e.appendChild(document.createTextNode(c)); else e.appendChild(c);
            });
            return e;
        }

        async function loadEntries(container) {
            const list = container.querySelector('#gb-list');
            if (!list) return;
            list.innerHTML = '';
            const loading = el('div', { style: 'color:#000;font-family:MS Sans Serif;font-size:12px;margin:4px 0;' }, 'Loading entries…');
            list.appendChild(loading);
            try {
                const { data, error } = await supabase
                    .from('guestbook_entries')
                    .select('name, message, created_at')
                    .order('created_at', { ascending: false })
                    .limit(50);
                if (error) throw new Error(error.message);
                list.innerHTML = '';
                if (!data || !data.length) {
                    list.appendChild(el('div', { style:'color:#333;font-style:italic' }, 'No entries yet. Be the first!'));
                    return;
                }
                data.forEach(row => {
                    const item = el('div', { style:'border-bottom:1px dashed #b0b0b0;padding:6px 2px;font-family:MS Sans Serif;color:#000;'}, [
                        el('div', { style:'font-weight:bold;font-size:12px;color:#000080' }, (row.name || 'Anonymous') + ' ' + new Date(row.created_at).toLocaleString()),
                        el('div', { style:'white-space:pre-wrap;font-size:12px;margin-top:2px;color:#000' }, row.message || '')
                    ]);
                    list.appendChild(item);
                });
            } catch (e) {
                list.innerHTML = '';
                list.appendChild(el('div', { style:'color:#a00' }, 'Failed to load guestbook.'));
                if (window.showWindowsDialog) showWindowsDialog('Guestbook', 'Failed to load entries: ' + e.message, '⚠️');
            }
        }

        async function postEntry(container) {
            const err = container.querySelector('#gb-error');
            err.style.display = 'none'; err.textContent='';
            const name = container.querySelector('#gb-name').value.trim().slice(0, 40);
            const msg = container.querySelector('#gb-message').value.trim().slice(0, 500);
            if (!msg) { err.textContent = 'Please write a message.'; err.style.display = 'block'; return; }
            try {
                const { user } = await supabaseSession();
                const { error } = await supabase
                    .from('guestbook_entries')
                    .insert({ user_id: user.id, name: name || 'Anonymous', message: msg });
                if (error) throw new Error(error.message);
                container.querySelector('#gb-message').value = '';
                await loadEntries(container);
                if (window.playSound) playSound('click');
            } catch (e) {
                err.textContent = 'Post failed: ' + e.message;
                err.style.display = 'block';
                if (window.showWindowsDialog) showWindowsDialog('Guestbook', 'Post failed: ' + e.message, '⚠️');
            }
        }

        function renderGuestbook(container) {
            container.innerHTML = '';
            const header = el('div', { style:'font-family:MS Sans Serif;font-size:14px;margin-bottom:6px;color:#000' }, 'Guestbook — leave a friendly note');
            const form = el('div', { style:'border:2px inset #c0c0c0;background:#f8f8f8;padding:6px;margin-bottom:8px' }, [
                el('div', {}, [
                    el('label', { for:'gb-name', style:'font-size:12px;color:#000' }, 'Name:'),
                    el('input', { id:'gb-name', style:'margin-left:6px;width:160px;border:1px solid #808080;padding:2px;font-size:12px' })
                ]),
                el('div', { style:'margin-top:6px' }, [
                    el('label', { for:'gb-message', style:'font-size:12px;color:#000' }, 'Message:'),
                    el('textarea', { id:'gb-message', rows:'3', style:'display:block;width:100%;margin-top:4px;border:1px solid #808080;padding:4px;font-size:12px' })
                ]),
                el('div', { id:'gb-error', style:'display:none;color:#a00;margin-top:6px;font-size:12px' }),
                el('div', { style:'margin-top:6px;display:flex;gap:6px' }, [
                    el('button', { id:'gb-post', style:'border:2px outset #c0c0c0;background:#c0c0c0;padding:4px 8px;font-size:12px;cursor:pointer' }, 'Post Entry'),
                    el('button', { id:'gb-refresh', style:'border:2px outset #c0c0c0;background:#c0c0c0;padding:4px 8px;font-size:12px;cursor:pointer' }, 'Refresh')
                ])
            ]);
            const list = el('div', { id:'gb-list', style:'border:2px inset #c0c0c0;background:#fff;padding:6px;min-height:120px' });

            container.appendChild(header);
            container.appendChild(form);
            container.appendChild(list);

            container.querySelector('#gb-post').addEventListener('click', () => postEntry(container));
            container.querySelector('#gb-refresh').addEventListener('click', () => loadEntries(container));
            loadEntries(container);
        }

        window.guestbook = { initGuestbook(container) { renderGuestbook(container); } };
    </script>

    <!-- Clippy and Screensaver System -->
    <script>
        // Clippy System
        const clippyMessages = [
            "It looks like you're exploring Windows 95. Need help?",
            "Hi there! I'm Clippy, your helpful assistant!",
            "Did you know you can play games from the Start menu?",
            "Having fun? Try opening the Calculator!",
            "I see you're using Windows 95. Want some tips?",
            "Feeling nostalgic? Me too!",
            "Don't forget to try the Paint app!",
            "Remember to save your work!",
            "You can minimize windows to clean up your desktop.",
            "Try the Minesweeper game - it's classic!"
        ];

        function showClippy() {
            const clippy = document.getElementById('clippy');
            const text = document.getElementById('clippy-text');
            text.textContent = clippyMessages[Math.floor(Math.random() * clippyMessages.length)];
            clippy.style.display = 'block';

            // Auto-hide after 10 seconds
            setTimeout(() => {
                hideClippy();
            }, 10000);
        }

        function hideClippy() {
            document.getElementById('clippy').style.display = 'none';
        }

        // Show Clippy randomly (15-25% chance every 30-60 seconds)
        function scheduleClippy() {
            const delay = 30000 + Math.random() * 30000; // 30-60 seconds
            setTimeout(() => {
                if (Math.random() < 0.2) { // 20% chance
                    showClippy();
                }
                scheduleClippy();
            }, delay);
        }

        scheduleClippy();

        // Screensaver System
        const SCREENSAVERS = {
            starfield: { name: 'Starfield', file: 'screensavers/starfield.js' },
            matrix: { name: 'Matrix Rain', file: 'screensavers/matrix.js' },
            pipes: { name: 'Pipes', file: 'screensavers/pipes.js' },
            logo: { name: 'Bouncing Logo', file: 'screensavers/logo.js' },
            mystify: { name: 'Mystify', file: 'screensavers/mystify.js' },
            snow: { name: 'Snow', file: 'screensavers/snow.js' },
            bubbles: { name: 'Bubbles', file: 'screensavers/bubbles.js' },
            clock: { name: 'Clock', file: 'screensavers/clock.js' },
            'flying-objects': { name: 'Flying Objects', file: 'screensavers/flying-objects.js' }
        };

        let screensaverTimeout = null;
        let screensaverActive = false;
        let screensaverType = localStorage.getItem('screensaver_type') || 'starfield';
        let screensaverDelay = parseInt(localStorage.getItem('screensaver_delay') || '30') * 1000;
        let screensaverCanvas, screensaverCtx;
        let currentScreensaver = null;
        let loadedScreensavers = {};

        async function loadScreensaver(type) {
            if (loadedScreensavers[type]) return;

            const screensaver = SCREENSAVERS[type];
            if (!screensaver) return;

            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = screensaver.file;
                script.onload = () => {
                    loadedScreensavers[type] = true;
                    resolve();
                };
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        function initScreensaver() {
            screensaverCanvas = document.getElementById('screensaver-canvas');
            screensaverCtx = screensaverCanvas.getContext('2d');
            resetScreensaverTimeout();

            // Reset timeout on user activity
            // Exit screensaver only on click or key, not mouse move
            ['mousedown', 'keydown', 'touchstart'].forEach(event => {
                document.addEventListener(event, (e) => {
                    if (screensaverActive) {
                        e.preventDefault();
                        e.stopPropagation();
                        stopScreensaver();
                    } else {
                        resetScreensaverTimeout();
                    }
                }, true); // Use capture phase to catch before other handlers
            });

            // Mouse move only resets timeout when screensaver is not active
            ['mousemove', 'scroll'].forEach(event => {
                document.addEventListener(event, () => {
                    if (!screensaverActive) {
                        resetScreensaverTimeout();
                    }
                });
            });
        }

        function resetScreensaverTimeout() {
            clearTimeout(screensaverTimeout);
            screensaverTimeout = setTimeout(startScreensaver, screensaverDelay);
        }

        async function startScreensaver() {
            screensaverActive = true;
            const ss = document.getElementById('screensaver');
            ss.style.display = 'block';

            screensaverCanvas.width = window.innerWidth;
            screensaverCanvas.height = window.innerHeight;

            // Load screensaver if needed
            await loadScreensaver(screensaverType);

            // Get saved settings for this screensaver
            const savedSettings = JSON.parse(localStorage.getItem(`screensaver_settings_${screensaverType}`) || '{}');

            // Start the screensaver
            // Convert kebab-case to PascalCase (e.g., 'flying-objects' -> 'FlyingObjects')
            const className = screensaverType.split('-').map(word =>
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join('') + 'Screensaver';
            const ScreensaverClass = window[className];

            if (ScreensaverClass) {
                currentScreensaver = new ScreensaverClass(screensaverCanvas, screensaverCtx);
                currentScreensaver.start(savedSettings);
            }
        }

        function stopScreensaver() {
            screensaverActive = false;
            document.getElementById('screensaver').style.display = 'none';

            if (currentScreensaver && currentScreensaver.stop) {
                currentScreensaver.stop();
            }
            currentScreensaver = null;

            resetScreensaverTimeout();
        }

        // Screensaver Settings
        async function openScreensaverSettings() {
            if (!window.showWindowsDialog) return;

            const overlay = document.getElementById('dialogOverlay');
            const titleElement = document.getElementById('dialogTitle');
            const iconElement = document.getElementById('dialogIcon');
            const messageElement = document.getElementById('dialogMessage');
            const buttonsContainer = document.getElementById('dialogButtons');

            titleElement.textContent = 'Screensaver Settings';
            iconElement.textContent = '🖥️';

            // Build screensaver dropdown
            let optionsHTML = '';
            for (const [key, value] of Object.entries(SCREENSAVERS)) {
                optionsHTML += `<option value="${key}" ${screensaverType === key ? 'selected' : ''}>${value.name}</option>`;
            }

            messageElement.innerHTML = `
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-weight: bold;">Screensaver:</label>
                    <select id="ss-type" style="width: 100%; padding: 4px; border: 1px inset #808080; font-family: 'MS Sans Serif'; font-size: 11px;">
                        ${optionsHTML}
                    </select>
                </div>
                <div id="ss-options-container"></div>
                <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 4px; font-weight: bold;">Wait: <span id="ss-delay-label">${screensaverDelay/1000}</span> seconds</label>
                    <input type="range" id="ss-delay" min="10" max="120" value="${screensaverDelay/1000}" style="width: 100%;" oninput="document.getElementById('ss-delay-label').textContent = this.value">
                </div>
                <button id="ss-preview-btn" style="border: 2px outset #c0c0c0; background: #c0c0c0; padding: 4px 12px; cursor: pointer; font-size: 11px; width: 100%;">Preview</button>
            `;

            // Update options when screensaver changes
            const updateOptions = async () => {
                const type = document.getElementById('ss-type').value;
                await loadScreensaver(type);

                const className = type.split('-').map(word =>
                    word.charAt(0).toUpperCase() + word.slice(1)
                ).join('') + 'Screensaver';
                const ScreensaverClass = window[className];

                const optionsContainer = document.getElementById('ss-options-container');
                optionsContainer.innerHTML = '';

                if (ScreensaverClass && ScreensaverClass.prototype.getSettings) {
                    const tempInstance = new ScreensaverClass(screensaverCanvas, screensaverCtx);
                    const settings = tempInstance.getSettings();
                    const savedSettings = JSON.parse(localStorage.getItem(`screensaver_settings_${type}`) || '{}');

                    for (const [key, config] of Object.entries(settings)) {
                        const value = savedSettings[key] !== undefined ? savedSettings[key] : config.default;
                        const div = document.createElement('div');
                        div.style.marginBottom = '12px';

                        if (config.type === 'range') {
                            div.innerHTML = `
                                <label style="display: block; margin-bottom: 4px; font-weight: bold;">${config.label}: <span id="ss-opt-${key}-label">${value}</span></label>
                                <input type="range" id="ss-opt-${key}" min="${config.min}" max="${config.max}" step="${config.step || 1}" value="${value}" style="width: 100%;" oninput="document.getElementById('ss-opt-${key}-label').textContent = this.value">
                            `;
                        } else if (config.type === 'text') {
                            div.innerHTML = `
                                <label style="display: block; margin-bottom: 4px; font-weight: bold;">${config.label}:</label>
                                <input type="text" id="ss-opt-${key}" value="${value}" style="width: 100%; padding: 4px; border: 1px inset #808080; font-size: 11px;">
                            `;
                        } else if (config.type === 'checkbox') {
                            div.innerHTML = `
                                <label style="display: flex; align-items: center; font-weight: bold;">
                                    <input type="checkbox" id="ss-opt-${key}" ${value ? 'checked' : ''} style="margin-right: 6px;">
                                    ${config.label}
                                </label>
                            `;
                        } else if (config.type === 'color') {
                            let colorOptions = '';
                            config.options.forEach(c => {
                                colorOptions += `<option value="${c}" ${value === c ? 'selected' : ''}>${c}</option>`;
                            });
                            div.innerHTML = `
                                <label style="display: block; margin-bottom: 4px; font-weight: bold;">${config.label}:</label>
                                <select id="ss-opt-${key}" style="width: 100%; padding: 4px; border: 1px inset #808080; font-size: 11px;">
                                    ${colorOptions}
                                </select>
                            `;
                        }

                        optionsContainer.appendChild(div);
                    }
                }
            };

            document.getElementById('ss-type').addEventListener('change', updateOptions);
            await updateOptions();

            document.getElementById('ss-preview-btn').onclick = async () => {
                // Get the currently selected screensaver type from the dropdown
                const previewType = document.getElementById('ss-type').value;
                const originalType = screensaverType;

                // Temporarily set to preview type
                screensaverType = previewType;

                // Get the preview settings from the form
                const previewSettings = {};
                await loadScreensaver(previewType);
                const className = previewType.split('-').map(word =>
                    word.charAt(0).toUpperCase() + word.slice(1)
                ).join('') + 'Screensaver';
                const ScreensaverClass = window[className];

                if (ScreensaverClass && ScreensaverClass.prototype.getSettings) {
                    const tempInstance = new ScreensaverClass(screensaverCanvas, screensaverCtx);
                    const settings = tempInstance.getSettings();

                    for (const key of Object.keys(settings)) {
                        const el = document.getElementById(`ss-opt-${key}`);
                        if (el) {
                            if (el.type === 'checkbox') {
                                previewSettings[key] = el.checked;
                            } else if (el.type === 'range' || el.type === 'number') {
                                previewSettings[key] = parseFloat(el.value);
                            } else {
                                previewSettings[key] = el.value;
                            }
                        }
                    }
                }

                // Store preview settings temporarily
                const originalSettings = localStorage.getItem(`screensaver_settings_${previewType}`);
                localStorage.setItem(`screensaver_settings_${previewType}`, JSON.stringify(previewSettings));

                // Start screensaver with preview settings
                // No need to hide dialog - screensaver covers everything with z-index 100000
                await startScreensaver();

                // After screensaver stops, restore original settings
                const checkScreensaverStopped = setInterval(() => {
                    if (!screensaverActive) {
                        clearInterval(checkScreensaverStopped);

                        // Restore original settings
                        if (originalSettings) {
                            localStorage.setItem(`screensaver_settings_${previewType}`, originalSettings);
                        } else {
                            localStorage.removeItem(`screensaver_settings_${previewType}`);
                        }
                        screensaverType = originalType;
                    }
                }, 100);
            };

            buttonsContainer.innerHTML = '';
            const okBtn = document.createElement('button');
            okBtn.className = 'dialog-button';
            okBtn.textContent = 'OK';
            okBtn.onclick = async () => {
                const type = document.getElementById('ss-type').value;
                screensaverType = type;
                screensaverDelay = parseInt(document.getElementById('ss-delay').value) * 1000;

                // Save general settings
                localStorage.setItem('screensaver_type', screensaverType);
                localStorage.setItem('screensaver_delay', screensaverDelay / 1000);

                // Save screensaver-specific settings
                await loadScreensaver(type);
                const className = type.split('-').map(word =>
                    word.charAt(0).toUpperCase() + word.slice(1)
                ).join('') + 'Screensaver';
                const ScreensaverClass = window[className];

                if (ScreensaverClass && ScreensaverClass.prototype.getSettings) {
                    const tempInstance = new ScreensaverClass(screensaverCanvas, screensaverCtx);
                    const settings = tempInstance.getSettings();
                    const savedSettings = {};

                    for (const key of Object.keys(settings)) {
                        const el = document.getElementById(`ss-opt-${key}`);
                        if (el) {
                            if (el.type === 'checkbox') {
                                savedSettings[key] = el.checked;
                            } else if (el.type === 'range' || el.type === 'number') {
                                savedSettings[key] = parseFloat(el.value);
                            } else {
                                savedSettings[key] = el.value;
                            }
                        }
                    }

                    localStorage.setItem(`screensaver_settings_${type}`, JSON.stringify(savedSettings));
                }

                window.closeDialog();
            };

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'dialog-button';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.onclick = () => window.closeDialog();

            buttonsContainer.appendChild(okBtn);
            buttonsContainer.appendChild(cancelBtn);

            overlay.style.display = 'flex';
            setTimeout(() => okBtn.focus(), 100);
        }

        // Initialize on load
        window.addEventListener('load', () => {
            initScreensaver();
        });
    </script>

    <!-- Dialog overlay for secondary system removed (using primary overlay) -->
</body>
</html>
