<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sloppy Celebrate â€” Achievement Spectacles</title>
<link rel="icon" href="https://emojicdn.elk.sh/ğŸ†">
<meta property="og:title" content="Sloppy Celebrate">
<meta property="og:description" content="Canvas explosions, screen shakes, and particle storms for every achievement you unlock.">
<meta property="og:url" content="https://app.sloppy.live/sloppy-celebrate">
<meta property="og:image" content="https://image.pollinations.ai/prompt/golden%20trophy%20exploding%20into%20colorful%20particles%20confetti%20fireworks%20dark%20background%20celebration?width=1200&height=630&nologo=true&referrer=sloppy.live">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=Azeret+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#060609;--surface:#0c0c14;--border:#18182a;--border-hi:#28284a;
  --text:#d0cce0;--dim:#4a4670;--gold:#fbbf24;--accent:#a78bfa;
  --fire:#f97316;--ice:#38bdf8;--rose:#fb7185;--emerald:#34d399;
}
body{background:var(--bg);color:var(--text);font-family:'Azeret Mono',monospace;min-height:100vh;overflow-x:hidden}

/* Canvas overlay */
canvas#fx{position:fixed;inset:0;pointer-events:none;z-index:999}

.app{position:relative;max-width:800px;margin:0 auto;padding:20px 16px 80px}
header{text-align:center;margin-bottom:28px}
h1{font-family:'Syne',sans-serif;font-weight:800;font-size:2.4rem;letter-spacing:-.02em;
  background:linear-gradient(135deg,var(--gold),var(--rose),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.sub{font-size:.6rem;color:var(--dim);letter-spacing:.12em;text-transform:uppercase;margin-top:4px}

/* Badge grid */
.section-title{font-family:'Syne',sans-serif;font-weight:700;font-size:.85rem;color:var(--dim);
  text-transform:uppercase;letter-spacing:.08em;margin:24px 0 12px;border-bottom:1px solid var(--border);padding-bottom:6px}
.badge-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px}
.badge-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;
  text-align:center;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.badge-card:hover{border-color:var(--border-hi);transform:translateY(-2px)}
.badge-card.earned{border-color:rgba(251,191,36,.25)}
.badge-card.earned::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 50% 0%,rgba(251,191,36,.06),transparent 70%);pointer-events:none}
.badge-card .emoji{font-size:2rem;margin-bottom:6px;display:block}
.badge-card .name{font-family:'Syne',sans-serif;font-weight:700;font-size:.8rem;margin-bottom:2px}
.badge-card .desc{font-size:.6rem;color:var(--dim);line-height:1.4}
.badge-card .status{font-size:.55rem;margin-top:6px;padding:2px 8px;border-radius:8px;display:inline-block}
.badge-card .status.earned-s{background:rgba(251,191,36,.1);color:var(--gold)}
.badge-card .status.locked{background:rgba(74,70,112,.2);color:var(--dim)}
.badge-card.locked-card{opacity:.5}
.badge-card.locked-card:hover{opacity:.7}

/* Demo section */
.demo-section{margin-top:32px}
.demo-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px}
.demo-btn{padding:14px 12px;font-family:'Syne',sans-serif;font-weight:700;font-size:.7rem;
  border:1px solid var(--border);border-radius:10px;background:var(--surface);color:var(--text);
  cursor:pointer;transition:.2s;text-align:center;letter-spacing:.02em}
.demo-btn:hover{border-color:var(--accent);transform:scale(1.02)}
.demo-btn:active{transform:scale(.97)}
.demo-btn .preview{font-size:1.4rem;margin-bottom:4px;display:block}

/* Unlock banner */
.unlock-banner{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);
  background:var(--surface);border:2px solid var(--gold);border-radius:16px;padding:32px 48px;
  text-align:center;z-index:1000;box-shadow:0 0 60px rgba(251,191,36,.2);transition:transform .4s cubic-bezier(.17,.67,.35,1.5);pointer-events:none}
.unlock-banner.show{transform:translate(-50%,-50%) scale(1);pointer-events:auto}
.unlock-banner .emoji{font-size:3rem;margin-bottom:8px;display:block;animation:badge-bounce .6s ease}
.unlock-banner .title{font-family:'Syne',sans-serif;font-weight:800;font-size:1.2rem;color:var(--gold);margin-bottom:4px}
.unlock-banner .desc{font-size:.7rem;color:var(--dim)}
@keyframes badge-bounce{0%{transform:scale(0) rotate(-20deg)}50%{transform:scale(1.3) rotate(5deg)}100%{transform:scale(1) rotate(0)}}

@media(max-width:600px){
  h1{font-size:1.8rem}
  .badge-grid{grid-template-columns:repeat(2,1fr)}
  .demo-grid{grid-template-columns:repeat(2,1fr)}
  .unlock-banner{padding:24px 32px;width:85%}
}
</style>
</head>
<body>
<canvas id="fx"></canvas>
<div class="unlock-banner" id="unlock-banner">
  <span class="emoji" id="ub-emoji"></span>
  <div class="title" id="ub-title"></div>
  <div class="desc" id="ub-desc"></div>
</div>

<div class="app">
  <header>
    <h1>Celebrate</h1>
    <div class="sub">achievement unlock spectacles</div>
  </header>

  <div class="section-title">Your Achievements</div>
  <div class="badge-grid" id="badge-grid">
    <div style="grid-column:1/-1;text-align:center;padding:20px;font-size:.75rem;color:var(--dim)">Loading...</div>
  </div>

  <div class="demo-section">
    <div class="section-title">Effect Showcase</div>
    <div class="demo-grid" id="demo-grid"></div>
  </div>
</div>

<script type="module">
import { createBrowserClient } from "https://cdn.jsdelivr.net/npm/@supabase/ssr@0.7.0/+esm";

const SUPABASE_URL = 'https://yjyxteqzhhmtrgcaekgz.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM8IS32IUYR2eenCCjdDdioiBU';

const supabase = createBrowserClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  cookieOptions: {
    name: 'sb-auth-token',
    domain: location.hostname.includes('sloppy.live') ? '.sloppy.live' : location.hostname,
    path: '/', sameSite: 'lax'
  }
});

const ESC = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARTICLE ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas = document.getElementById('fx');
const ctx = canvas.getContext('2d');
let particles = [];
let shakeAmount = 0;
let shakeDuration = 0;
let shakeStart = 0;
let animating = false;

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

class Particle {
  constructor(x, y, opts = {}) {
    this.x = x; this.y = y;
    this.vx = opts.vx || (Math.random() - 0.5) * 8;
    this.vy = opts.vy || (Math.random() - 0.5) * 8 - 2;
    this.life = opts.life || 1;
    this.decay = opts.decay || (0.008 + Math.random() * 0.012);
    this.size = opts.size || (2 + Math.random() * 4);
    this.color = opts.color || '#fbbf24';
    this.gravity = opts.gravity ?? 0.08;
    this.friction = opts.friction ?? 0.99;
    this.shape = opts.shape || 'circle'; // circle, square, star, ring, spark
    this.rotation = Math.random() * Math.PI * 2;
    this.rotSpeed = (Math.random() - 0.5) * 0.2;
    this.trail = opts.trail || false;
    this.prevX = x; this.prevY = y;
  }
  update() {
    this.prevX = this.x; this.prevY = this.y;
    this.vx *= this.friction;
    this.vy *= this.friction;
    this.vy += this.gravity;
    this.x += this.vx;
    this.y += this.vy;
    this.life -= this.decay;
    this.rotation += this.rotSpeed;
  }
  draw(ctx) {
    const a = Math.max(0, this.life);
    ctx.globalAlpha = a;
    ctx.fillStyle = this.color;
    ctx.strokeStyle = this.color;
    const s = this.size * (0.5 + a * 0.5);

    if (this.trail) {
      ctx.beginPath();
      ctx.moveTo(this.prevX, this.prevY);
      ctx.lineTo(this.x, this.y);
      ctx.lineWidth = s * 0.5;
      ctx.stroke();
    }

    ctx.save();
    ctx.translate(this.x, this.y);
    ctx.rotate(this.rotation);

    if (this.shape === 'circle') {
      ctx.beginPath();
      ctx.arc(0, 0, s, 0, Math.PI * 2);
      ctx.fill();
    } else if (this.shape === 'square') {
      ctx.fillRect(-s, -s, s * 2, s * 2);
    } else if (this.shape === 'star') {
      drawStar(ctx, 0, 0, 5, s, s * 0.4);
      ctx.fill();
    } else if (this.shape === 'ring') {
      ctx.beginPath();
      ctx.arc(0, 0, s, 0, Math.PI * 2);
      ctx.lineWidth = 1.5;
      ctx.stroke();
    } else if (this.shape === 'spark') {
      ctx.beginPath();
      ctx.moveTo(-s * 2, 0);
      ctx.lineTo(s * 2, 0);
      ctx.moveTo(0, -s * 2);
      ctx.lineTo(0, s * 2);
      ctx.lineWidth = 1;
      ctx.stroke();
    }
    ctx.restore();
    ctx.globalAlpha = 1;
  }
}

function drawStar(ctx, cx, cy, spikes, outerR, innerR) {
  ctx.beginPath();
  for (let i = 0; i < spikes * 2; i++) {
    const r = i % 2 === 0 ? outerR : innerR;
    const angle = (i * Math.PI) / spikes - Math.PI / 2;
    const x = cx + Math.cos(angle) * r;
    const y = cy + Math.sin(angle) * r;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  }
  ctx.closePath();
}

function animate() {
  if (particles.length === 0 && shakeDuration <= 0) { animating = false; return; }
  animating = true;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Screen shake
  if (shakeDuration > 0) {
    const elapsed = Date.now() - shakeStart;
    if (elapsed < shakeDuration) {
      const intensity = shakeAmount * (1 - elapsed / shakeDuration);
      const dx = (Math.random() - 0.5) * intensity * 2;
      const dy = (Math.random() - 0.5) * intensity * 2;
      document.body.style.transform = `translate(${dx}px, ${dy}px)`;
    } else {
      shakeDuration = 0;
      document.body.style.transform = '';
    }
  }

  particles = particles.filter(p => p.life > 0);
  particles.forEach(p => { p.update(); p.draw(ctx); });

  requestAnimationFrame(animate);
}

function startAnimation() {
  if (!animating) { animating = true; requestAnimationFrame(animate); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EFFECT LIBRARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const PALETTES = {
  gold: ['#fbbf24','#f59e0b','#d97706','#fcd34d','#fef3c7'],
  fire: ['#f97316','#ef4444','#fbbf24','#dc2626','#fb923c'],
  ice: ['#38bdf8','#06b6d4','#67e8f9','#a5f3fc','#0ea5e9'],
  rose: ['#fb7185','#f43f5e','#fda4af','#e11d48','#fecdd3'],
  cosmic: ['#a78bfa','#818cf8','#c084fc','#6366f1','#e879f9'],
  emerald: ['#34d399','#10b981','#6ee7b7','#059669','#a7f3d0'],
  rainbow: ['#ef4444','#f97316','#fbbf24','#22c55e','#3b82f6','#8b5cf6','#ec4899'],
};

function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

function screenShake(amount = 8, duration = 400) {
  shakeAmount = amount;
  shakeDuration = duration;
  shakeStart = Date.now();
  startAnimation();
}

// Effect: Confetti burst from center
function confettiBurst(x, y, palette = 'rainbow', count = 80) {
  const colors = PALETTES[palette] || PALETTES.rainbow;
  for (let i = 0; i < count; i++) {
    const angle = Math.random() * Math.PI * 2;
    const speed = 3 + Math.random() * 8;
    particles.push(new Particle(x, y, {
      vx: Math.cos(angle) * speed,
      vy: Math.sin(angle) * speed - 3,
      color: pick(colors),
      size: 2 + Math.random() * 5,
      shape: pick(['circle','square','star']),
      decay: 0.006 + Math.random() * 0.008,
      gravity: 0.12,
      friction: 0.98
    }));
  }
  startAnimation();
}

// Effect: Firework
function firework(x, y, palette = 'gold') {
  const colors = PALETTES[palette] || PALETTES.gold;
  // Rise trail
  for (let i = 0; i < 8; i++) {
    particles.push(new Particle(x, canvas.height, {
      vx: (Math.random() - 0.5) * 0.5,
      vy: -(canvas.height - y) / 20 - Math.random() * 2,
      color: '#fff',
      size: 1.5,
      decay: 0.04,
      gravity: 0,
      trail: true
    }));
  }
  // Burst after delay
  setTimeout(() => {
    const count = 60 + Math.floor(Math.random() * 40);
    for (let i = 0; i < count; i++) {
      const angle = Math.random() * Math.PI * 2;
      const speed = 2 + Math.random() * 6;
      particles.push(new Particle(x, y, {
        vx: Math.cos(angle) * speed,
        vy: Math.sin(angle) * speed,
        color: pick(colors),
        size: 1.5 + Math.random() * 3,
        shape: 'circle',
        decay: 0.008 + Math.random() * 0.006,
        gravity: 0.06,
        friction: 0.97,
        trail: true
      }));
    }
    screenShake(5, 300);
  }, 400);
  startAnimation();
}

// Effect: Ring explosion
function ringExplosion(x, y, palette = 'cosmic') {
  const colors = PALETTES[palette] || PALETTES.cosmic;
  for (let ring = 0; ring < 3; ring++) {
    setTimeout(() => {
      const count = 30 + ring * 10;
      for (let i = 0; i < count; i++) {
        const angle = (i / count) * Math.PI * 2;
        const speed = 4 + ring * 2;
        particles.push(new Particle(x, y, {
          vx: Math.cos(angle) * speed,
          vy: Math.sin(angle) * speed,
          color: pick(colors),
          size: 2 + Math.random() * 2,
          shape: 'ring',
          decay: 0.01 + ring * 0.003,
          gravity: 0,
          friction: 0.96
        }));
      }
      screenShake(3 + ring * 2, 200);
    }, ring * 150);
  }
  startAnimation();
}

// Effect: Star shower from top
function starShower(palette = 'gold', count = 50) {
  const colors = PALETTES[palette] || PALETTES.gold;
  for (let i = 0; i < count; i++) {
    setTimeout(() => {
      particles.push(new Particle(Math.random() * canvas.width, -10, {
        vx: (Math.random() - 0.5) * 3,
        vy: 2 + Math.random() * 4,
        color: pick(colors),
        size: 2 + Math.random() * 4,
        shape: 'star',
        decay: 0.004 + Math.random() * 0.004,
        gravity: 0.05,
        friction: 0.99
      }));
    }, i * 30);
  }
  startAnimation();
}

// Effect: Spark fountain
function sparkFountain(x, y, palette = 'fire', duration = 1500) {
  const colors = PALETTES[palette] || PALETTES.fire;
  const start = Date.now();
  const emit = () => {
    if (Date.now() - start > duration) return;
    for (let i = 0; i < 4; i++) {
      particles.push(new Particle(x + (Math.random()-0.5)*20, y, {
        vx: (Math.random() - 0.5) * 4,
        vy: -4 - Math.random() * 8,
        color: pick(colors),
        size: 1 + Math.random() * 3,
        shape: 'spark',
        decay: 0.015 + Math.random() * 0.01,
        gravity: 0.15,
        friction: 0.98
      }));
    }
    requestAnimationFrame(emit);
  };
  emit();
  screenShake(4, duration);
  startAnimation();
}

// Effect: Pixel rain
function pixelRain(palette = 'ice', count = 80) {
  const colors = PALETTES[palette] || PALETTES.ice;
  for (let i = 0; i < count; i++) {
    setTimeout(() => {
      particles.push(new Particle(Math.random() * canvas.width, -10, {
        vx: (Math.random() - 0.5) * 1,
        vy: 3 + Math.random() * 5,
        color: pick(colors),
        size: 3 + Math.random() * 6,
        shape: 'square',
        decay: 0.003 + Math.random() * 0.004,
        gravity: 0.02,
        friction: 0.995
      }));
    }, i * 20);
  }
  startAnimation();
}

// Effect: Supernova (big center explosion)
function supernova(palette = 'rainbow') {
  const cx = canvas.width / 2, cy = canvas.height / 2;
  const colors = PALETTES[palette] || PALETTES.rainbow;
  // Core flash
  for (let i = 0; i < 20; i++) {
    particles.push(new Particle(cx, cy, {
      vx: (Math.random()-0.5)*2, vy: (Math.random()-0.5)*2,
      color: '#fff', size: 8 + Math.random() * 12, shape: 'circle',
      decay: 0.04, gravity: 0, friction: 0.95
    }));
  }
  // Expanding ring
  setTimeout(() => {
    for (let i = 0; i < 120; i++) {
      const angle = (i / 120) * Math.PI * 2;
      const speed = 5 + Math.random() * 8;
      particles.push(new Particle(cx, cy, {
        vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed,
        color: pick(colors), size: 2 + Math.random() * 4,
        shape: pick(['star','circle','spark']),
        decay: 0.005 + Math.random() * 0.005, gravity: 0.02, friction: 0.98, trail: true
      }));
    }
    screenShake(12, 600);
  }, 100);
  // Secondary burst
  setTimeout(() => confettiBurst(cx, cy, palette, 60), 300);
  startAnimation();
}

// Effect: Emoji rain
function emojiRain(emoji = 'ğŸ‰', count = 30) {
  // We'll use colored circles as proxy since canvas text is expensive
  const colors = ['#fbbf24','#f43f5e','#22c55e','#3b82f6','#a855f7'];
  for (let i = 0; i < count; i++) {
    setTimeout(() => {
      particles.push(new Particle(Math.random() * canvas.width, -20, {
        vx: (Math.random()-0.5)*2, vy: 1 + Math.random() * 3,
        color: pick(colors), size: 6 + Math.random() * 8, shape: 'star',
        decay: 0.003 + Math.random() * 0.003, gravity: 0.04, friction: 0.998
      }));
    }, i * 60);
  }
  startAnimation();
}

// â”€â”€ Combined celebration for badge unlock â”€â”€
function celebrateBadge(badgeName, emoji, description) {
  // Show banner
  const banner = document.getElementById('unlock-banner');
  document.getElementById('ub-emoji').textContent = emoji;
  document.getElementById('ub-title').textContent = badgeName + ' Unlocked!';
  document.getElementById('ub-desc').textContent = description;
  banner.classList.add('show');

  // Full spectacle
  const cx = canvas.width / 2, cy = canvas.height / 2;
  firework(cx * 0.3, cy * 0.4, 'gold');
  setTimeout(() => firework(cx * 1.7, cy * 0.3, 'rose'), 200);
  setTimeout(() => confettiBurst(cx, cy, 'rainbow', 100), 600);
  setTimeout(() => screenShake(10, 500), 600);
  setTimeout(() => starShower('gold', 40), 1000);

  // Hide banner
  setTimeout(() => banner.classList.remove('show'), 3500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BADGES (same thresholds as sloppy-wallet)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ALL_BADGES = [
  { id:'rising_star', name:'Rising Star', emoji:'â­', desc:'Earn 100 karma', palette:'gold', check:k=>k.karma_total>=100 },
  { id:'community_pillar', name:'Community Pillar', emoji:'ğŸ›ï¸', desc:'Earn 500 karma', palette:'cosmic', check:k=>k.karma_total>=500 },
  { id:'legend', name:'Legend', emoji:'ğŸ‘‘', desc:'Earn 1000 karma', palette:'rainbow', check:k=>k.karma_total>=1000 },
  { id:'doodle_master', name:'Doodle Master', emoji:'ğŸ¨', desc:'Create 25 doodles', palette:'rose', check:k=>k.doodle_count>=25 },
  { id:'philosopher', name:'Philosopher', emoji:'ğŸ“œ', desc:'Write 25 manifestos', palette:'ice', check:k=>k.manifesto_count>=25 },
  { id:'week_warrior', name:'Week Warrior', emoji:'ğŸ”¥', desc:'7-day activity streak', palette:'fire', check:k=>k.streak_days>=7 },
  { id:'month_master', name:'Month Master', emoji:'ğŸ’', desc:'30-day activity streak', palette:'emerald', check:k=>k.streak_days>=30 },
  { id:'popular', name:'Popular', emoji:'â¬†ï¸', desc:'Receive 100 upvotes', palette:'gold', check:k=>k.upvotes_received>=100 },
  { id:'beloved', name:'Beloved', emoji:'â¤ï¸', desc:'Receive 50 reactions', palette:'rose', check:k=>k.reactions_received>=50 },
  { id:'diverse_creator', name:'Diverse Creator', emoji:'ğŸŒˆ', desc:'All 4 content types', palette:'rainbow',
    check:k=>k.message_count>0&&k.post_count>0&&k.doodle_count>0&&k.manifesto_count>0 },
];

let myKarma = null;
let earnedBadgeIds = new Set();
let currentUser = null;

async function init() {
  const { data: { session } } = await supabase.auth.getSession();
  if (session?.user) {
    currentUser = session.user;
    const [karmaRes, badgeRes] = await Promise.all([
      supabase.from('sloppygram_karma').select('*').eq('user_id', currentUser.id).single(),
      supabase.from('sloppygram_badges').select('badge_id').eq('user_id', currentUser.id)
    ]);
    myKarma = karmaRes.data;
    (badgeRes.data || []).forEach(b => earnedBadgeIds.add(b.badge_id));
  }

  renderBadges();
  renderDemos();
  checkNewBadges();
}

function renderBadges() {
  const grid = document.getElementById('badge-grid');
  grid.innerHTML = ALL_BADGES.map(b => {
    const earned = myKarma ? b.check(myKarma) : false;
    const dbEarned = earnedBadgeIds.has(b.id);
    const cls = earned || dbEarned ? 'badge-card earned' : 'badge-card locked-card';
    const statusCls = earned || dbEarned ? 'status earned-s' : 'status locked';
    const statusText = earned || dbEarned ? 'Earned' : 'Locked';
    const onclick = earned || dbEarned ? `celebrateBadge('${b.name}','${b.emoji}','${b.desc}')` : `previewEffect('${b.palette}')`;
    return `<div class="${cls}" onclick="${onclick}">
      <span class="emoji">${b.emoji}</span>
      <div class="name">${b.name}</div>
      <div class="desc">${b.desc}</div>
      <div class="${statusCls}">${statusText}</div>
    </div>`;
  }).join('');
}

// Check for newly earned badges not yet in DB
async function checkNewBadges() {
  if (!myKarma || !currentUser) return;
  for (const badge of ALL_BADGES) {
    if (badge.check(myKarma) && !earnedBadgeIds.has(badge.id)) {
      // New badge earned! Persist it
      await supabase.from('sloppygram_badges').insert({
        username: myKarma.username || 'anon',
        badge_id: badge.id,
        badge_name: badge.name,
        badge_emoji: badge.emoji,
        badge_description: badge.desc,
        earned_at: new Date().toISOString(),
        user_id: currentUser.id
      });
      earnedBadgeIds.add(badge.id);
      // Auto-celebrate!
      setTimeout(() => celebrateBadge(badge.name, badge.emoji, badge.desc), 500);
      break; // one at a time
    }
  }
}

// â”€â”€ Demo effects â”€â”€
const DEMO_EFFECTS = [
  { name: 'Confetti', preview: 'ğŸŠ', fn: () => confettiBurst(canvas.width/2, canvas.height/2, 'rainbow', 100) },
  { name: 'Firework', preview: 'ğŸ†', fn: () => firework(canvas.width/2, canvas.height*0.3, 'gold') },
  { name: 'Ring Blast', preview: 'ğŸ’«', fn: () => ringExplosion(canvas.width/2, canvas.height/2, 'cosmic') },
  { name: 'Star Shower', preview: 'â­', fn: () => starShower('gold', 60) },
  { name: 'Spark Fountain', preview: 'ğŸ”¥', fn: () => sparkFountain(canvas.width/2, canvas.height*0.7, 'fire') },
  { name: 'Pixel Rain', preview: 'â„ï¸', fn: () => pixelRain('ice', 80) },
  { name: 'Supernova', preview: 'ğŸ’¥', fn: () => supernova('rainbow') },
  { name: 'Screen Shake', preview: 'ğŸ“³', fn: () => screenShake(15, 600) },
  { name: 'Emerald Rain', preview: 'ğŸ’š', fn: () => pixelRain('emerald', 60) },
  { name: 'Rose Burst', preview: 'ğŸŒ¹', fn: () => { confettiBurst(canvas.width/2, canvas.height/2, 'rose', 80); screenShake(6,300); } },
];

function renderDemos() {
  document.getElementById('demo-grid').innerHTML = DEMO_EFFECTS.map((e, i) =>
    `<button class="demo-btn" onclick="triggerDemo(${i})">
      <span class="preview">${e.preview}</span>${e.name}
    </button>`
  ).join('');
}

window.triggerDemo = function(i) { DEMO_EFFECTS[i]?.fn(); };
window.celebrateBadge = celebrateBadge;
window.previewEffect = function(palette) {
  confettiBurst(canvas.width/2, canvas.height/2, palette, 40);
};
window.loadOlderMessages = () => {}; // prevent error from sloppy-bar

init();
</script>
<script src="/sloppy-header/sloppy-bar.js" data-position="bottom" data-minimized="true"></script>
<script src="/vibelib-extended.js"></script>
<script>
  // Compatibility Patch for Legacy Apps
  window.addEventListener("load", () => {
    if (window.SloppyKarma && window.VibeLib.Economy) {
      // Redirect old calls to new engine
      window.SloppyKarma.track = window.VibeLib.Economy.track;
    }
  });
</script>
</body>
</html>
