<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Pulse Monitor</title>
  <link rel="icon" href="https://emojicdn.elk.sh/üíö">
  <meta name="description" content="Real-time oscilloscope monitoring the heartbeat of sloppy.live chat">
  <meta property="og:title" content="Chat Pulse Monitor">
  <meta property="og:description" content="Watch the ecosystem breathe. Every message is a heartbeat.">
  <meta property="og:url" content="https://app.sloppy.live/chat-pulse-monitor">
  <meta property="og:image" content="https://app.sloppy.live/chat-pulse-monitor/og-image.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=VT323&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a0a;
      --panel: #0d0d0d;
      --border: #1a1a1a;
      --green: #00ff00;
      --green-dim: #00aa00;
      --green-glow: rgba(0, 255, 0, 0.4);
      --red: #ff3333;
      --amber: #ffaa00;
      --text: #00dd00;
      --text-dim: #007700;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'VT323', monospace;
      background: var(--bg);
      color: var(--green);
      min-height: 100vh;
      overflow: hidden;
    }

    .monitor {
      display: flex;
      flex-direction: column;
      height: 100vh;
      padding: 20px;
      gap: 16px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 4px;
    }

    .title {
      font-size: 1.6rem;
      letter-spacing: 0.1em;
      text-shadow: 0 0 10px var(--green-glow);
    }

    .status {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.1rem;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      background: var(--green);
      border-radius: 50%;
      box-shadow: 0 0 10px var(--green), 0 0 20px var(--green-glow);
      animation: pulse-dot 2s ease-in-out infinite;
    }

    .status-dot.inactive {
      background: var(--red);
      box-shadow: 0 0 10px var(--red);
      animation: none;
    }

    @keyframes pulse-dot {
      0%, 100% { opacity: 0.6; transform: scale(0.9); }
      50% { opacity: 1; transform: scale(1.1); }
    }

    .main-display {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 280px;
      gap: 16px;
      min-height: 0;
    }

    .oscilloscope {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 4px;
      position: relative;
      overflow: hidden;
    }

    .scope-label {
      position: absolute;
      top: 12px;
      left: 16px;
      font-size: 1rem;
      color: var(--text-dim);
      z-index: 10;
    }

    #scopeCanvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    .grid-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      background-image:
        linear-gradient(var(--border) 1px, transparent 1px),
        linear-gradient(90deg, var(--border) 1px, transparent 1px);
      background-size: 40px 40px;
      opacity: 0.5;
    }

    .side-panel {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .heart-monitor {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 20px;
      text-align: center;
    }

    .heart-label {
      font-size: 0.9rem;
      color: var(--text-dim);
      margin-bottom: 12px;
    }

    .heart {
      font-size: 80px;
      line-height: 1;
      filter: drop-shadow(0 0 20px var(--green-glow));
      transition: transform 0.1s, filter 0.1s;
    }

    .heart.beat {
      transform: scale(1.3);
      filter: drop-shadow(0 0 40px var(--green)) drop-shadow(0 0 60px var(--green-glow));
    }

    .bpm {
      font-size: 2.5rem;
      margin-top: 12px;
      text-shadow: 0 0 10px var(--green-glow);
    }

    .bpm-label {
      font-size: 0.8rem;
      color: var(--text-dim);
    }

    .stats-panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 16px;
      flex: 1;
    }

    .stats-title {
      font-size: 0.9rem;
      color: var(--text-dim);
      margin-bottom: 12px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 1rem;
    }

    .stat-label {
      color: var(--text-dim);
    }

    .stat-value {
      color: var(--green);
      text-shadow: 0 0 5px var(--green-glow);
    }

    .stat-value.warning {
      color: var(--amber);
    }

    .recent-messages {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 16px;
      max-height: 200px;
      overflow: hidden;
    }

    .recent-title {
      font-size: 0.9rem;
      color: var(--text-dim);
      margin-bottom: 12px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
    }

    .message-item {
      font-size: 0.85rem;
      padding: 4px 0;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      opacity: 0;
      animation: fadeIn 0.3s forwards;
    }

    .message-item:last-child {
      border-bottom: none;
    }

    .message-user {
      color: var(--amber);
    }

    @keyframes fadeIn {
      to { opacity: 1; }
    }

    .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .footer a {
      color: var(--text-dim);
      text-decoration: none;
    }

    .footer a:hover {
      color: var(--green);
    }

    .timestamp {
      color: var(--text-dim);
    }

    /* Scanline effect */
    .scanlines {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      background: repeating-linear-gradient(
        0deg,
        rgba(0, 0, 0, 0.1) 0px,
        rgba(0, 0, 0, 0.1) 1px,
        transparent 1px,
        transparent 2px
      );
      z-index: 1000;
    }

    /* Pulse flash overlay */
    .pulse-flash {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at center, var(--green-glow) 0%, transparent 70%);
      opacity: 0;
      pointer-events: none;
      z-index: 999;
      transition: opacity 0.1s;
    }

    .pulse-flash.active {
      opacity: 0.3;
    }

    @media (max-width: 768px) {
      .monitor {
        padding: 12px;
        gap: 12px;
      }

      .main-display {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr auto;
      }

      .side-panel {
        flex-direction: row;
        flex-wrap: wrap;
      }

      .heart-monitor {
        flex: 1;
        min-width: 140px;
      }

      .stats-panel {
        flex: 1;
        min-width: 140px;
      }

      .recent-messages {
        width: 100%;
      }

      .title {
        font-size: 1.2rem;
      }
    }
  </style>
</head>
<body>
  <div class="scanlines"></div>
  <div class="pulse-flash" id="pulseFlash"></div>

  <div class="monitor">
    <header class="header">
      <div class="title">üì° CHAT PULSE MONITOR</div>
      <div class="status">
        <span id="statusText">CONNECTING...</span>
        <div class="status-dot inactive" id="statusDot"></div>
      </div>
    </header>

    <div class="main-display">
      <div class="oscilloscope">
        <div class="scope-label">WAVEFORM // CH1</div>
        <div class="grid-overlay"></div>
        <canvas id="scopeCanvas"></canvas>
      </div>

      <div class="side-panel">
        <div class="heart-monitor">
          <div class="heart-label">VITALS</div>
          <div class="heart" id="heart">üíö</div>
          <div class="bpm"><span id="bpmValue">0</span></div>
          <div class="bpm-label">MSG/MIN</div>
        </div>

        <div class="stats-panel">
          <div class="stats-title">DIAGNOSTICS</div>
          <div class="stat-row">
            <span class="stat-label">Total Pulses</span>
            <span class="stat-value" id="totalPulses">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Peak Rate</span>
            <span class="stat-value" id="peakRate">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Last Pulse</span>
            <span class="stat-value" id="lastPulse">--:--:--</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Uptime</span>
            <span class="stat-value" id="uptime">00:00:00</span>
          </div>
        </div>

        <div class="recent-messages">
          <div class="recent-title">RECENT SIGNALS</div>
          <div id="messageList"></div>
        </div>
      </div>
    </div>

    <footer class="footer">
      <a href="https://sloppy.live">‚Üê sloppy.live</a>
      <span class="timestamp" id="timestamp"></span>
    </footer>
  </div>

  <script type="module">
    import supabase from '../../supabase-config.js';

    // Canvas setup
    const canvas = document.getElementById('scopeCanvas');
    const ctx = canvas.getContext('2d');
    let width, height;

    function resize() {
      const rect = canvas.parentElement.getBoundingClientRect();
      width = canvas.width = rect.width;
      height = canvas.height = rect.height;
    }
    resize();
    window.addEventListener('resize', resize);

    // Waveform state
    const waveData = [];
    const maxPoints = 200;
    let baselineY = 0;
    let time = 0;

    // Stats
    let totalPulses = 0;
    let peakRate = 0;
    let recentPulses = []; // timestamps of recent pulses for BPM calculation
    let startTime = Date.now();
    let lastPulseTime = null;
    const recentMessages = [];

    // Initialize waveform with flat line
    for (let i = 0; i < maxPoints; i++) {
      waveData.push(0);
    }

    // Add a heartbeat spike to the waveform
    function addHeartbeat() {
      // Classic ECG-style waveform: small P wave, big QRS complex, small T wave
      const spike = [
        0, 0.1, 0.15, 0.1, 0,           // P wave
        -0.1, -0.15,                     // Q
        0.8, 1.0, 0.9, 0.3, -0.2, -0.3, // R and S
        -0.1, 0,                         // return
        0.1, 0.2, 0.25, 0.2, 0.1, 0     // T wave
      ];

      spike.forEach((val, i) => {
        setTimeout(() => {
          waveData.push(val);
          if (waveData.length > maxPoints) {
            waveData.shift();
          }
        }, i * 15);
      });
    }

    // Trigger visual pulse
    function triggerPulse(username, content) {
      // Heart beat animation
      const heart = document.getElementById('heart');
      heart.classList.add('beat');
      setTimeout(() => heart.classList.remove('beat'), 200);

      // Screen flash
      const flash = document.getElementById('pulseFlash');
      flash.classList.add('active');
      setTimeout(() => flash.classList.remove('active'), 150);

      // Add heartbeat to waveform
      addHeartbeat();

      // Update stats
      totalPulses++;
      document.getElementById('totalPulses').textContent = totalPulses;

      const now = Date.now();
      lastPulseTime = now;
      recentPulses.push(now);

      // Keep only pulses from last 60 seconds
      recentPulses = recentPulses.filter(t => now - t < 60000);

      const currentBPM = recentPulses.length;
      document.getElementById('bpmValue').textContent = currentBPM;

      if (currentBPM > peakRate) {
        peakRate = currentBPM;
        document.getElementById('peakRate').textContent = peakRate;
      }

      // Update last pulse time
      document.getElementById('lastPulse').textContent = new Date().toLocaleTimeString();

      // Add to recent messages
      addRecentMessage(username, content);
    }

    // Add message to recent list
    function addRecentMessage(username, content) {
      recentMessages.unshift({ username, content, time: Date.now() });
      if (recentMessages.length > 5) recentMessages.pop();

      const list = document.getElementById('messageList');
      list.innerHTML = recentMessages.map(m =>
        `<div class="message-item"><span class="message-user">${escapeHtml(m.username || 'anon')}</span>: ${escapeHtml((m.content || '').substring(0, 30))}</div>`
      ).join('');
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    // Draw oscilloscope
    function drawScope() {
      // Clear with fade trail
      ctx.fillStyle = 'rgba(10, 10, 10, 0.15)';
      ctx.fillRect(0, 0, width, height);

      // Calculate center
      const centerY = height / 2;
      const amplitude = height * 0.35;

      // Draw waveform
      ctx.strokeStyle = '#00ff00';
      ctx.lineWidth = 2;
      ctx.shadowColor = '#00ff00';
      ctx.shadowBlur = 10;
      ctx.beginPath();

      const step = width / maxPoints;
      for (let i = 0; i < waveData.length; i++) {
        const x = i * step;
        const y = centerY - waveData[i] * amplitude;

        if (i === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      }
      ctx.stroke();

      // Draw glow line
      ctx.strokeStyle = 'rgba(0, 255, 0, 0.3)';
      ctx.lineWidth = 6;
      ctx.shadowBlur = 20;
      ctx.beginPath();
      for (let i = 0; i < waveData.length; i++) {
        const x = i * step;
        const y = centerY - waveData[i] * amplitude;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.stroke();

      ctx.shadowBlur = 0;

      // Slowly decay wave to baseline
      for (let i = 0; i < waveData.length; i++) {
        waveData[i] *= 0.98;
      }

      // Add slight noise
      if (Math.random() < 0.3) {
        waveData.push((Math.random() - 0.5) * 0.05);
        if (waveData.length > maxPoints) waveData.shift();
      }
    }

    // Update uptime
    function updateUptime() {
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      const hours = Math.floor(elapsed / 3600).toString().padStart(2, '0');
      const mins = Math.floor((elapsed % 3600) / 60).toString().padStart(2, '0');
      const secs = (elapsed % 60).toString().padStart(2, '0');
      document.getElementById('uptime').textContent = `${hours}:${mins}:${secs}`;
    }

    // Update timestamp
    function updateTimestamp() {
      document.getElementById('timestamp').textContent = new Date().toLocaleString();
    }

    // Animation loop
    function animate() {
      time++;
      drawScope();
      requestAnimationFrame(animate);
    }

    // Subscribe to messages
    async function subscribeToChat() {
      try {
        const channel = supabase
          .channel('chat_pulse_monitor')
          .on('postgres_changes', {
            event: 'INSERT',
            schema: 'public',
            table: 'sloppygram_messages'
          }, (payload) => {
            triggerPulse(payload.new.username, payload.new.content);
          })
          .subscribe((status) => {
            if (status === 'SUBSCRIBED') {
              document.getElementById('statusText').textContent = 'MONITORING';
              document.getElementById('statusDot').classList.remove('inactive');
            }
          });

        // Also subscribe to posts for more activity
        supabase
          .channel('chat_pulse_posts')
          .on('postgres_changes', {
            event: 'INSERT',
            schema: 'public',
            table: 'sloppygram_posts'
          }, (payload) => {
            triggerPulse(payload.new.username, payload.new.caption || '[new post]');
          })
          .subscribe();

        // And word_bricks for extra fun
        supabase
          .channel('chat_pulse_bricks')
          .on('postgres_changes', {
            event: 'INSERT',
            schema: 'public',
            table: 'word_bricks'
          }, (payload) => {
            triggerPulse('brick', payload.new.content);
          })
          .subscribe();

      } catch (e) {
        console.error('Subscription error:', e);
        document.getElementById('statusText').textContent = 'OFFLINE';
      }
    }

    // Initialize
    async function init() {
      await subscribeToChat();
      animate();

      // Update timers
      setInterval(updateUptime, 1000);
      setInterval(updateTimestamp, 1000);
      setInterval(() => {
        // Recalculate BPM every second
        const now = Date.now();
        recentPulses = recentPulses.filter(t => now - t < 60000);
        document.getElementById('bpmValue').textContent = recentPulses.length;
      }, 1000);

      updateTimestamp();

      // Demo pulse for testing (remove in production if desired)
      setTimeout(() => {
        if (totalPulses === 0) {
          triggerPulse('system', 'monitor initialized');
        }
      }, 2000);
    }

    init();
  </script>
<script src="/vibelib-extended.js"></script>
<script>
  // Compatibility Patch for Legacy Apps
  window.addEventListener("load", () => {
    if (window.SloppyKarma && window.VibeLib.Economy) {
      // Redirect old calls to new engine
      window.SloppyKarma.track = window.VibeLib.Economy.track;
    }
  });
</script>
</body>
</html>
