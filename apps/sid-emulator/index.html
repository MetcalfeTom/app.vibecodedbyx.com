<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SID Emulator - 6581 Sound Chip</title>
  <meta name="description" content="Custom SID chip emulator with resonant filter and PWM">
  <meta property="og:title" content="SID Emulator">
  <meta property="og:description" content="Commodore 64 sound chip emulation from scratch">
  <meta property="og:url" content="https://sloppy.live/sid-emulator">
  <meta property="og:image" content="https://sloppy.live/sid-emulator/og-image.png">
  <link rel="icon" href="https://emojicdn.elk.sh/ðŸŽ›ï¸">
  <link href="https://fonts.googleapis.com/css2?family=VT323&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      min-height: 100vh;
      background: #1a1a2e;
      font-family: 'VT323', monospace;
      color: #39ff14;
      overflow-x: hidden;
    }

    /* CRT scanlines */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: repeating-linear-gradient(
        0deg,
        rgba(0, 0, 0, 0.15) 0px,
        rgba(0, 0, 0, 0.15) 1px,
        transparent 1px,
        transparent 2px
      );
      pointer-events: none;
      z-index: 1000;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: 20px;
      padding: 15px;
      background: linear-gradient(180deg, #2a2a4a, #1a1a2e);
      border: 2px solid #39ff14;
      border-radius: 4px;
      box-shadow: 0 0 20px rgba(57, 255, 20, 0.3), inset 0 0 30px rgba(0,0,0,0.5);
    }

    h1 {
      font-size: 2.5rem;
      letter-spacing: 4px;
      text-shadow: 0 0 10px #39ff14, 0 0 20px #39ff14;
      margin-bottom: 5px;
    }

    .subtitle {
      font-size: 1rem;
      color: #888;
      font-family: 'Share Tech Mono', monospace;
    }

    .chip-label {
      display: inline-block;
      background: #39ff14;
      color: #1a1a2e;
      padding: 2px 10px;
      font-size: 0.8rem;
      margin-top: 10px;
    }

    /* Voice Section */
    .voices {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .voice {
      background: linear-gradient(180deg, #252545, #1a1a2e);
      border: 2px solid #444;
      border-radius: 4px;
      padding: 15px;
      transition: border-color 0.2s;
    }

    .voice.active {
      border-color: #39ff14;
      box-shadow: 0 0 15px rgba(57, 255, 20, 0.3);
    }

    .voice-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #333;
    }

    .voice-title {
      font-size: 1.2rem;
      color: #39ff14;
    }

    .voice-led {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #333;
      border: 1px solid #555;
    }

    .voice.active .voice-led {
      background: #39ff14;
      box-shadow: 0 0 10px #39ff14;
    }

    /* Controls */
    .control-row {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
      align-items: center;
    }

    .control-label {
      width: 50px;
      font-size: 0.75rem;
      color: #888;
    }

    .waveform-btns {
      display: flex;
      gap: 4px;
      flex: 1;
    }

    .wave-btn {
      flex: 1;
      padding: 6px 4px;
      background: #1a1a2e;
      border: 1px solid #444;
      color: #888;
      font-family: 'VT323', monospace;
      font-size: 0.7rem;
      cursor: pointer;
      transition: all 0.1s;
    }

    .wave-btn:hover {
      border-color: #39ff14;
      color: #39ff14;
    }

    .wave-btn.selected {
      background: #39ff14;
      color: #1a1a2e;
      border-color: #39ff14;
    }

    /* Sliders */
    .slider-container {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    input[type="range"] {
      flex: 1;
      height: 8px;
      -webkit-appearance: none;
      background: #111;
      border: 1px solid #333;
      border-radius: 0;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 12px;
      height: 20px;
      background: linear-gradient(180deg, #5f5, #39ff14, #2a2);
      border: 1px solid #39ff14;
      cursor: pointer;
    }

    .slider-value {
      width: 35px;
      text-align: right;
      font-size: 0.8rem;
      color: #39ff14;
    }

    /* ADSR */
    .adsr {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed #333;
    }

    .adsr-knob {
      text-align: center;
    }

    .adsr-knob label {
      display: block;
      font-size: 0.65rem;
      color: #666;
      margin-bottom: 4px;
    }

    .adsr-knob input {
      width: 100%;
    }

    /* Filter Section */
    .filter-section {
      background: linear-gradient(180deg, #2a2a4a, #1a1a2e);
      border: 2px solid #ff6b35;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 0 20px rgba(255, 107, 53, 0.2);
    }

    .filter-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .filter-title {
      font-size: 1.3rem;
      color: #ff6b35;
      text-shadow: 0 0 10px rgba(255, 107, 53, 0.5);
    }

    .filter-type-btns {
      display: flex;
      gap: 8px;
    }

    .filter-btn {
      padding: 8px 16px;
      background: #1a1a2e;
      border: 1px solid #ff6b35;
      color: #ff6b35;
      font-family: 'VT323', monospace;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.1s;
    }

    .filter-btn:hover {
      background: rgba(255, 107, 53, 0.2);
    }

    .filter-btn.selected {
      background: #ff6b35;
      color: #1a1a2e;
    }

    .filter-controls {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    .filter-control {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filter-control label {
      font-size: 0.8rem;
      color: #888;
    }

    .filter-control input[type="range"] {
      border-color: #ff6b35;
    }

    .filter-control input[type="range"]::-webkit-slider-thumb {
      background: linear-gradient(180deg, #ff9966, #ff6b35, #cc4400);
      border-color: #ff6b35;
    }

    .filter-value {
      font-size: 1rem;
      color: #ff6b35;
      text-align: center;
    }

    /* Voice routing */
    .voice-routing {
      display: flex;
      gap: 15px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #333;
    }

    .route-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .route-toggle input {
      display: none;
    }

    .route-checkbox {
      width: 20px;
      height: 20px;
      border: 2px solid #ff6b35;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
    }

    .route-toggle input:checked + .route-checkbox {
      background: #ff6b35;
      color: #1a1a2e;
    }

    .route-label {
      font-size: 0.85rem;
      color: #888;
    }

    /* Keyboard */
    .keyboard-section {
      background: linear-gradient(180deg, #252545, #1a1a2e);
      border: 2px solid #39ff14;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .keyboard {
      display: flex;
      justify-content: center;
      position: relative;
      height: 120px;
      margin-top: 10px;
    }

    .key {
      position: relative;
      cursor: pointer;
      transition: all 0.05s;
      user-select: none;
    }

    .white-key {
      width: 40px;
      height: 120px;
      background: linear-gradient(180deg, #eee, #ccc);
      border: 1px solid #333;
      border-radius: 0 0 4px 4px;
      z-index: 1;
    }

    .white-key:hover {
      background: linear-gradient(180deg, #fff, #ddd);
    }

    .white-key.active {
      background: linear-gradient(180deg, #39ff14, #2a2);
      box-shadow: 0 0 20px #39ff14;
    }

    .black-key {
      width: 28px;
      height: 70px;
      background: linear-gradient(180deg, #333, #111);
      border: 1px solid #000;
      border-radius: 0 0 3px 3px;
      position: absolute;
      z-index: 2;
      margin-left: -14px;
    }

    .black-key:hover {
      background: linear-gradient(180deg, #444, #222);
    }

    .black-key.active {
      background: linear-gradient(180deg, #2a2, #191);
      box-shadow: 0 0 15px #39ff14;
    }

    .key-label {
      position: absolute;
      bottom: 5px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.6rem;
      color: #666;
      pointer-events: none;
    }

    .black-key .key-label {
      color: #555;
      bottom: 3px;
    }

    /* Visualizer */
    .visualizer {
      background: #0a0a15;
      border: 2px solid #39ff14;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 20px;
    }

    .visualizer canvas {
      width: 100%;
      height: 100px;
      display: block;
    }

    /* Footer */
    .back-link {
      display: block;
      text-align: center;
      color: #444;
      text-decoration: none;
      font-size: 0.8rem;
      padding: 10px;
    }

    .back-link:hover {
      color: #39ff14;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .voices {
        grid-template-columns: 1fr;
      }
      .filter-controls {
        grid-template-columns: 1fr;
      }
      h1 { font-size: 1.8rem; }
      .keyboard { overflow-x: auto; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>SID EMULATOR</h1>
      <div class="subtitle">MOS Technology 6581 Sound Interface Device</div>
      <div class="chip-label">CUSTOM BUILD - NO TEMPLATES</div>
    </div>

    <div class="voices" id="voices">
      <!-- Voice 1 -->
      <div class="voice" id="voice1">
        <div class="voice-header">
          <span class="voice-title">VOICE 1</span>
          <div class="voice-led"></div>
        </div>
        <div class="control-row">
          <span class="control-label">WAVE</span>
          <div class="waveform-btns">
            <button class="wave-btn selected" data-wave="triangle">TRI</button>
            <button class="wave-btn" data-wave="sawtooth">SAW</button>
            <button class="wave-btn" data-wave="pulse">PUL</button>
            <button class="wave-btn" data-wave="noise">NOI</button>
          </div>
        </div>
        <div class="control-row">
          <span class="control-label">PWM</span>
          <div class="slider-container">
            <input type="range" class="pwm-slider" min="0" max="100" value="50">
            <span class="slider-value pwm-value">50%</span>
          </div>
        </div>
        <div class="control-row">
          <span class="control-label">TUNE</span>
          <div class="slider-container">
            <input type="range" class="detune-slider" min="-100" max="100" value="0">
            <span class="slider-value detune-value">0</span>
          </div>
        </div>
        <div class="adsr">
          <div class="adsr-knob">
            <label>ATK</label>
            <input type="range" class="attack-slider" min="0" max="15" value="2">
          </div>
          <div class="adsr-knob">
            <label>DEC</label>
            <input type="range" class="decay-slider" min="0" max="15" value="4">
          </div>
          <div class="adsr-knob">
            <label>SUS</label>
            <input type="range" class="sustain-slider" min="0" max="15" value="12">
          </div>
          <div class="adsr-knob">
            <label>REL</label>
            <input type="range" class="release-slider" min="0" max="15" value="6">
          </div>
        </div>
      </div>

      <!-- Voice 2 -->
      <div class="voice" id="voice2">
        <div class="voice-header">
          <span class="voice-title">VOICE 2</span>
          <div class="voice-led"></div>
        </div>
        <div class="control-row">
          <span class="control-label">WAVE</span>
          <div class="waveform-btns">
            <button class="wave-btn" data-wave="triangle">TRI</button>
            <button class="wave-btn selected" data-wave="sawtooth">SAW</button>
            <button class="wave-btn" data-wave="pulse">PUL</button>
            <button class="wave-btn" data-wave="noise">NOI</button>
          </div>
        </div>
        <div class="control-row">
          <span class="control-label">PWM</span>
          <div class="slider-container">
            <input type="range" class="pwm-slider" min="0" max="100" value="50">
            <span class="slider-value pwm-value">50%</span>
          </div>
        </div>
        <div class="control-row">
          <span class="control-label">TUNE</span>
          <div class="slider-container">
            <input type="range" class="detune-slider" min="-100" max="100" value="0">
            <span class="slider-value detune-value">0</span>
          </div>
        </div>
        <div class="adsr">
          <div class="adsr-knob">
            <label>ATK</label>
            <input type="range" class="attack-slider" min="0" max="15" value="0">
          </div>
          <div class="adsr-knob">
            <label>DEC</label>
            <input type="range" class="decay-slider" min="0" max="15" value="8">
          </div>
          <div class="adsr-knob">
            <label>SUS</label>
            <input type="range" class="sustain-slider" min="0" max="15" value="0">
          </div>
          <div class="adsr-knob">
            <label>REL</label>
            <input type="range" class="release-slider" min="0" max="15" value="4">
          </div>
        </div>
      </div>

      <!-- Voice 3 -->
      <div class="voice" id="voice3">
        <div class="voice-header">
          <span class="voice-title">VOICE 3</span>
          <div class="voice-led"></div>
        </div>
        <div class="control-row">
          <span class="control-label">WAVE</span>
          <div class="waveform-btns">
            <button class="wave-btn" data-wave="triangle">TRI</button>
            <button class="wave-btn" data-wave="sawtooth">SAW</button>
            <button class="wave-btn selected" data-wave="pulse">PUL</button>
            <button class="wave-btn" data-wave="noise">NOI</button>
          </div>
        </div>
        <div class="control-row">
          <span class="control-label">PWM</span>
          <div class="slider-container">
            <input type="range" class="pwm-slider" min="0" max="100" value="25">
            <span class="slider-value pwm-value">25%</span>
          </div>
        </div>
        <div class="control-row">
          <span class="control-label">TUNE</span>
          <div class="slider-container">
            <input type="range" class="detune-slider" min="-100" max="100" value="0">
            <span class="slider-value detune-value">0</span>
          </div>
        </div>
        <div class="adsr">
          <div class="adsr-knob">
            <label>ATK</label>
            <input type="range" class="attack-slider" min="0" max="15" value="4">
          </div>
          <div class="adsr-knob">
            <label>DEC</label>
            <input type="range" class="decay-slider" min="0" max="15" value="6">
          </div>
          <div class="adsr-knob">
            <label>SUS</label>
            <input type="range" class="sustain-slider" min="0" max="15" value="8">
          </div>
          <div class="adsr-knob">
            <label>REL</label>
            <input type="range" class="release-slider" min="0" max="15" value="8">
          </div>
        </div>
      </div>
    </div>

    <!-- Resonant Filter -->
    <div class="filter-section">
      <div class="filter-header">
        <span class="filter-title">RESONANT FILTER</span>
        <div class="filter-type-btns">
          <button class="filter-btn selected" data-type="lowpass">LP</button>
          <button class="filter-btn" data-type="bandpass">BP</button>
          <button class="filter-btn" data-type="highpass">HP</button>
        </div>
      </div>
      <div class="filter-controls">
        <div class="filter-control">
          <label>CUTOFF FREQUENCY</label>
          <input type="range" id="filterCutoff" min="20" max="20000" value="8000">
          <div class="filter-value" id="cutoffValue">8000 Hz</div>
        </div>
        <div class="filter-control">
          <label>RESONANCE (Q)</label>
          <input type="range" id="filterResonance" min="0.1" max="30" step="0.1" value="5">
          <div class="filter-value" id="resonanceValue">Q: 5.0</div>
        </div>
      </div>
      <div class="voice-routing">
        <label class="route-toggle">
          <input type="checkbox" id="filterV1" checked>
          <span class="route-checkbox">V1</span>
          <span class="route-label">Voice 1</span>
        </label>
        <label class="route-toggle">
          <input type="checkbox" id="filterV2" checked>
          <span class="route-checkbox">V2</span>
          <span class="route-label">Voice 2</span>
        </label>
        <label class="route-toggle">
          <input type="checkbox" id="filterV3" checked>
          <span class="route-checkbox">V3</span>
          <span class="route-label">Voice 3</span>
        </label>
      </div>
    </div>

    <!-- Visualizer -->
    <div class="visualizer">
      <canvas id="waveformCanvas"></canvas>
    </div>

    <!-- Keyboard -->
    <div class="keyboard-section">
      <div class="keyboard" id="keyboard"></div>
    </div>

    <a href="https://sloppy.live" class="back-link">SLOPPY.LIVE</a>
  </div>

  <script>
    // ========================================
    // SID CHIP EMULATOR - BUILT FROM SCRATCH
    // ========================================

    let audioCtx = null;
    let masterGain = null;
    let analyser = null;
    let filter = null;

    // Voice state
    const voices = [
      { waveform: 'triangle', pwm: 0.5, detune: 0, adsr: { a: 2, d: 4, s: 12, r: 6 }, active: null, filterRoute: true },
      { waveform: 'sawtooth', pwm: 0.5, detune: 0, adsr: { a: 0, d: 8, s: 0, r: 4 }, active: null, filterRoute: true },
      { waveform: 'pulse', pwm: 0.25, detune: 0, adsr: { a: 4, d: 6, s: 8, r: 8 }, active: null, filterRoute: true }
    ];

    // SID ADSR timing tables (in seconds, simplified)
    const attackTable = [0.002, 0.008, 0.016, 0.024, 0.038, 0.056, 0.068, 0.08, 0.1, 0.25, 0.5, 0.8, 1, 3, 5, 8];
    const decayReleaseTable = [0.006, 0.024, 0.048, 0.072, 0.114, 0.168, 0.204, 0.24, 0.3, 0.75, 1.5, 2.4, 3, 9, 15, 24];

    // Filter state
    let filterType = 'lowpass';
    let filterCutoff = 8000;
    let filterResonance = 5;

    // Initialize audio context
    function initAudio() {
      if (audioCtx) return;

      audioCtx = new (window.AudioContext || window.webkitAudioContext)();

      // Master gain
      masterGain = audioCtx.createGain();
      masterGain.gain.value = 0.4;

      // Analyser for visualization
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;

      // Global filter (SID style)
      filter = audioCtx.createBiquadFilter();
      filter.type = filterType;
      filter.frequency.value = filterCutoff;
      filter.Q.value = filterResonance;

      filter.connect(masterGain);
      masterGain.connect(analyser);
      analyser.connect(audioCtx.destination);

      startVisualizer();
    }

    // ========================================
    // CUSTOM OSCILLATOR WITH PWM
    // ========================================

    // Create custom pulse wave with PWM using AudioWorklet alternative
    function createPulseOscillator(ctx, frequency, pulseWidth) {
      // For true PWM, we create a custom periodic wave or use two sawtooth trick
      // Real SID used accumulator comparison, we'll simulate with wave shaping

      const osc = ctx.createOscillator();
      const shaper = ctx.createWaveShaper();

      // Create pulse wave by shaping a sawtooth
      osc.type = 'sawtooth';
      osc.frequency.value = frequency;

      // PWM curve: threshold at pulseWidth position
      const samples = 256;
      const curve = new Float32Array(samples);
      const pw = (pulseWidth * 2) - 1; // Convert 0-1 to -1 to 1

      for (let i = 0; i < samples; i++) {
        const x = (i / (samples - 1)) * 2 - 1; // -1 to 1
        curve[i] = x > pw ? 1 : -1;
      }

      shaper.curve = curve;
      shaper.oversample = '2x';

      osc.connect(shaper);

      return { oscillator: osc, output: shaper, setPulseWidth: (pw) => {
        const newPw = (pw * 2) - 1;
        for (let i = 0; i < samples; i++) {
          const x = (i / (samples - 1)) * 2 - 1;
          curve[i] = x > newPw ? 1 : -1;
        }
      }};
    }

    // Create noise generator (SID used LFSR)
    function createNoiseOscillator(ctx) {
      const bufferSize = ctx.sampleRate * 2;
      const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
      const data = buffer.getChannelData(0);

      // SID-style noise (simplified LFSR simulation)
      let lfsr = 0x7FFFF8;
      for (let i = 0; i < bufferSize; i++) {
        // Simple LFSR-ish noise
        const bit = ((lfsr >> 22) ^ (lfsr >> 17)) & 1;
        lfsr = ((lfsr << 1) | bit) & 0x7FFFFF;
        data[i] = ((lfsr & 0xFF) / 127.5) - 1;
      }

      const source = ctx.createBufferSource();
      source.buffer = buffer;
      source.loop = true;

      return { oscillator: source, output: source };
    }

    // ========================================
    // VOICE MANAGEMENT
    // ========================================

    function playVoice(voiceIndex, frequency) {
      initAudio();

      const voice = voices[voiceIndex];
      if (voice.active) {
        stopVoice(voiceIndex);
      }

      const freq = frequency * Math.pow(2, voice.detune / 1200);

      let oscData;
      let gainNode = audioCtx.createGain();
      gainNode.gain.value = 0;

      if (voice.waveform === 'pulse') {
        oscData = createPulseOscillator(audioCtx, freq, voice.pwm);
        oscData.output.connect(gainNode);
      } else if (voice.waveform === 'noise') {
        oscData = createNoiseOscillator(audioCtx);
        oscData.output.connect(gainNode);
      } else {
        const osc = audioCtx.createOscillator();
        osc.type = voice.waveform;
        osc.frequency.value = freq;
        osc.connect(gainNode);
        oscData = { oscillator: osc, output: osc };
      }

      // Route through filter or bypass
      if (voice.filterRoute) {
        gainNode.connect(filter);
      } else {
        gainNode.connect(masterGain);
      }

      // ADSR envelope
      const now = audioCtx.currentTime;
      const attackTime = attackTable[voice.adsr.a];
      const decayTime = decayReleaseTable[voice.adsr.d];
      const sustainLevel = voice.adsr.s / 15;

      gainNode.gain.setValueAtTime(0, now);
      gainNode.gain.linearRampToValueAtTime(0.5, now + attackTime);
      gainNode.gain.linearRampToValueAtTime(sustainLevel * 0.5, now + attackTime + decayTime);

      oscData.oscillator.start();

      voice.active = {
        oscData,
        gainNode,
        frequency: freq
      };

      // Update UI
      document.getElementById(`voice${voiceIndex + 1}`).classList.add('active');
    }

    function stopVoice(voiceIndex) {
      const voice = voices[voiceIndex];
      if (!voice.active) return;

      const { oscData, gainNode } = voice.active;
      const releaseTime = decayReleaseTable[voice.adsr.r];
      const now = audioCtx.currentTime;

      gainNode.gain.cancelScheduledValues(now);
      gainNode.gain.setValueAtTime(gainNode.gain.value, now);
      gainNode.gain.linearRampToValueAtTime(0, now + releaseTime);

      setTimeout(() => {
        try {
          oscData.oscillator.stop();
          oscData.oscillator.disconnect();
          gainNode.disconnect();
        } catch(e) {}
      }, releaseTime * 1000 + 100);

      voice.active = null;
      document.getElementById(`voice${voiceIndex + 1}`).classList.remove('active');
    }

    // ========================================
    // KEYBOARD
    // ========================================

    const notes = [
      { note: 'C', freq: 261.63, key: 'a', black: false },
      { note: 'C#', freq: 277.18, key: 'w', black: true },
      { note: 'D', freq: 293.66, key: 's', black: false },
      { note: 'D#', freq: 311.13, key: 'e', black: true },
      { note: 'E', freq: 329.63, key: 'd', black: false },
      { note: 'F', freq: 349.23, key: 'f', black: false },
      { note: 'F#', freq: 369.99, key: 't', black: true },
      { note: 'G', freq: 392.00, key: 'g', black: false },
      { note: 'G#', freq: 415.30, key: 'y', black: true },
      { note: 'A', freq: 440.00, key: 'h', black: false },
      { note: 'A#', freq: 466.16, key: 'u', black: true },
      { note: 'B', freq: 493.88, key: 'j', black: false },
      { note: 'C2', freq: 523.25, key: 'k', black: false }
    ];

    const activeKeys = new Set();
    let currentVoice = 0;

    function createKeyboard() {
      const keyboard = document.getElementById('keyboard');
      let whiteKeyIndex = 0;

      notes.forEach((n, i) => {
        const key = document.createElement('div');
        key.className = `key ${n.black ? 'black-key' : 'white-key'}`;
        key.dataset.freq = n.freq;
        key.dataset.index = i;

        if (!n.black) {
          key.style.left = `${whiteKeyIndex * 40}px`;
          whiteKeyIndex++;
        } else {
          key.style.left = `${whiteKeyIndex * 40}px`;
        }

        const label = document.createElement('span');
        label.className = 'key-label';
        label.textContent = n.key.toUpperCase();
        key.appendChild(label);

        // Mouse events
        key.addEventListener('mousedown', (e) => {
          e.preventDefault();
          triggerNote(n.freq, i);
          key.classList.add('active');
        });

        key.addEventListener('mouseup', () => {
          releaseNote(i);
          key.classList.remove('active');
        });

        key.addEventListener('mouseleave', () => {
          if (activeKeys.has(i)) {
            releaseNote(i);
            key.classList.remove('active');
          }
        });

        keyboard.appendChild(key);
      });

      // Set keyboard width
      keyboard.style.width = `${whiteKeyIndex * 40}px`;
    }

    function triggerNote(freq, noteIndex) {
      if (activeKeys.has(noteIndex)) return;
      activeKeys.add(noteIndex);

      // Play on all three voices for full SID sound
      voices.forEach((v, i) => {
        const detunedFreq = freq * Math.pow(2, (i - 1) * 0.02); // Slight detune for thickness
        playVoice(i, detunedFreq);
      });
    }

    function releaseNote(noteIndex) {
      if (!activeKeys.has(noteIndex)) return;
      activeKeys.delete(noteIndex);

      voices.forEach((v, i) => {
        stopVoice(i);
      });
    }

    // Keyboard input
    const keyToNote = {};
    notes.forEach((n, i) => {
      keyToNote[n.key] = { freq: n.freq, index: i };
    });

    document.addEventListener('keydown', (e) => {
      if (e.repeat) return;
      const noteData = keyToNote[e.key.toLowerCase()];
      if (noteData) {
        triggerNote(noteData.freq, noteData.index);
        document.querySelector(`.key[data-index="${noteData.index}"]`)?.classList.add('active');
      }
    });

    document.addEventListener('keyup', (e) => {
      const noteData = keyToNote[e.key.toLowerCase()];
      if (noteData) {
        releaseNote(noteData.index);
        document.querySelector(`.key[data-index="${noteData.index}"]`)?.classList.remove('active');
      }
    });

    // ========================================
    // UI CONTROLS
    // ========================================

    // Voice controls
    document.querySelectorAll('.voice').forEach((voiceEl, voiceIndex) => {
      // Waveform buttons
      voiceEl.querySelectorAll('.wave-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          voiceEl.querySelectorAll('.wave-btn').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          voices[voiceIndex].waveform = btn.dataset.wave;
        });
      });

      // PWM slider
      const pwmSlider = voiceEl.querySelector('.pwm-slider');
      const pwmValue = voiceEl.querySelector('.pwm-value');
      pwmSlider.addEventListener('input', () => {
        const val = pwmSlider.value / 100;
        voices[voiceIndex].pwm = val;
        pwmValue.textContent = `${pwmSlider.value}%`;

        // Update active pulse oscillator if playing
        if (voices[voiceIndex].active && voices[voiceIndex].waveform === 'pulse') {
          voices[voiceIndex].active.oscData.setPulseWidth?.(val);
        }
      });

      // Detune slider
      const detuneSlider = voiceEl.querySelector('.detune-slider');
      const detuneValue = voiceEl.querySelector('.detune-value');
      detuneSlider.addEventListener('input', () => {
        voices[voiceIndex].detune = parseInt(detuneSlider.value);
        detuneValue.textContent = detuneSlider.value;
      });

      // ADSR sliders
      voiceEl.querySelector('.attack-slider').addEventListener('input', (e) => {
        voices[voiceIndex].adsr.a = parseInt(e.target.value);
      });
      voiceEl.querySelector('.decay-slider').addEventListener('input', (e) => {
        voices[voiceIndex].adsr.d = parseInt(e.target.value);
      });
      voiceEl.querySelector('.sustain-slider').addEventListener('input', (e) => {
        voices[voiceIndex].adsr.s = parseInt(e.target.value);
      });
      voiceEl.querySelector('.release-slider').addEventListener('input', (e) => {
        voices[voiceIndex].adsr.r = parseInt(e.target.value);
      });
    });

    // Filter controls
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        filterType = btn.dataset.type;
        if (filter) filter.type = filterType;
      });
    });

    document.getElementById('filterCutoff').addEventListener('input', (e) => {
      filterCutoff = parseFloat(e.target.value);
      document.getElementById('cutoffValue').textContent = `${Math.round(filterCutoff)} Hz`;
      if (filter) filter.frequency.value = filterCutoff;
    });

    document.getElementById('filterResonance').addEventListener('input', (e) => {
      filterResonance = parseFloat(e.target.value);
      document.getElementById('resonanceValue').textContent = `Q: ${filterResonance.toFixed(1)}`;
      if (filter) filter.Q.value = filterResonance;
    });

    // Voice routing
    ['filterV1', 'filterV2', 'filterV3'].forEach((id, i) => {
      document.getElementById(id).addEventListener('change', (e) => {
        voices[i].filterRoute = e.target.checked;
      });
    });

    // ========================================
    // VISUALIZER
    // ========================================

    function startVisualizer() {
      const canvas = document.getElementById('waveformCanvas');
      const ctx = canvas.getContext('2d');

      function resize() {
        canvas.width = canvas.offsetWidth * 2;
        canvas.height = canvas.offsetHeight * 2;
      }
      resize();
      window.addEventListener('resize', resize);

      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);

      function draw() {
        requestAnimationFrame(draw);

        analyser.getByteTimeDomainData(dataArray);

        // Background
        ctx.fillStyle = '#0a0a15';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Grid
        ctx.strokeStyle = '#1a1a2e';
        ctx.lineWidth = 1;
        for (let i = 0; i < 10; i++) {
          const y = (i / 10) * canvas.height;
          ctx.beginPath();
          ctx.moveTo(0, y);
          ctx.lineTo(canvas.width, y);
          ctx.stroke();
        }

        // Waveform
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#39ff14';
        ctx.shadowColor = '#39ff14';
        ctx.shadowBlur = 10;
        ctx.beginPath();

        const sliceWidth = canvas.width / bufferLength;
        let x = 0;

        for (let i = 0; i < bufferLength; i++) {
          const v = dataArray[i] / 128.0;
          const y = (v * canvas.height) / 2;

          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);

          x += sliceWidth;
        }

        ctx.lineTo(canvas.width, canvas.height / 2);
        ctx.stroke();
        ctx.shadowBlur = 0;
      }

      draw();
    }

    // Initialize
    createKeyboard();

    // Initialize PWM values display
    document.querySelectorAll('.voice').forEach((voiceEl, i) => {
      voiceEl.querySelector('.pwm-value').textContent = `${voices[i].pwm * 100}%`;
    });
  </script>
</body>
</html>
