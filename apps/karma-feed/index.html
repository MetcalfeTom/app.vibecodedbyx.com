<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karma Feed</title>
    <link rel="icon" href="https://emojicdn.elk.sh/%E2%9C%A8">
    <meta property="og:title" content="Karma Feed">
    <meta property="og:description" content="Top content from the sloppy.live ecosystem, ranked by karma and engagement">
    <meta property="og:url" content="https://app.sloppy.live/karma-feed">
    <meta property="og:image" content="https://emojicdn.elk.sh/%E2%9C%A8?style=apple&size=512">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #08080e;
            --surface: #0e0e18;
            --surface2: #141420;
            --border: #1a1a2a;
            --text: #d0d0dd;
            --dim: #555568;
            --accent: #e04050;
            --cyan: #40d8e0;
            --gold: #f0c040;
            --green: #40e070;
            --purple: #a050e0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'IBM Plex Mono', monospace;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            background: var(--bg);
            z-index: 10;
        }
        .logo {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8rem;
            letter-spacing: 0.12em;
            color: var(--cyan);
        }
        .logo span { color: var(--dim); font-size: 0.9rem; letter-spacing: 0.05em; }
        .backlink {
            color: var(--dim);
            text-decoration: none;
            font-size: 0.7rem;
        }
        .backlink:hover { color: var(--text); }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 0.3rem;
            padding: 0.7rem 1rem;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            position: sticky;
            top: 56px;
            background: var(--bg);
            z-index: 9;
        }
        .tab {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--dim);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.6rem;
            padding: 0.35rem 0.7rem;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .tab:hover { color: var(--text); }
        .tab.active { color: var(--cyan); border-color: var(--cyan); background: rgba(64,216,224,0.06); }

        .sort-bar {
            display: flex;
            justify-content: center;
            gap: 0.3rem;
            padding: 0.5rem;
            flex-wrap: wrap;
        }
        .sbtn {
            background: none;
            border: none;
            color: var(--dim);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.55rem;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .sbtn:hover { color: var(--text); }
        .sbtn.active { color: var(--gold); border-bottom-color: var(--gold); }

        .feed {
            max-width: 620px;
            margin: 0 auto;
            padding: 0 1rem 3rem;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 0.75rem;
            overflow: hidden;
            transition: border-color 0.2s;
        }
        .card:hover { border-color: rgba(255,255,255,0.08); }
        .card.featured { border-color: rgba(240,192,64,0.2); }

        .card-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 0.8rem;
        }
        .card-avatar {
            width: 24px; height: 24px;
            background: var(--surface2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            flex-shrink: 0;
        }
        .card-user {
            font-weight: 600;
            font-size: 0.75rem;
        }
        .card-meta {
            font-size: 0.55rem;
            color: var(--dim);
            margin-left: auto;
        }
        .card-type {
            font-size: 0.5rem;
            padding: 0.15rem 0.4rem;
            border-radius: 2px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }
        .type-post { background: rgba(64,216,224,0.1); color: var(--cyan); }
        .type-manifesto { background: rgba(160,80,224,0.1); color: var(--purple); }
        .type-doodle { background: rgba(64,224,112,0.1); color: var(--green); }
        .type-message { background: rgba(224,64,80,0.1); color: var(--accent); }

        .card-body {
            padding: 0 0.8rem 0.6rem;
        }
        .card-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.1rem;
            letter-spacing: 0.05em;
            margin-bottom: 0.3rem;
            color: var(--text);
        }
        .card-text {
            font-size: 0.7rem;
            color: #999;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .card-image {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            display: block;
        }

        .card-footer {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem 0.8rem;
            border-top: 1px solid rgba(255,255,255,0.03);
            font-size: 0.6rem;
            color: var(--dim);
        }
        .card-stat { display: flex; align-items: center; gap: 0.25rem; }
        .card-score {
            margin-left: auto;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 0.9rem;
            color: var(--gold);
        }
        .card-tags {
            padding: 0 0.8rem 0.5rem;
            display: flex;
            gap: 0.3rem;
            flex-wrap: wrap;
        }
        .tag {
            font-size: 0.5rem;
            padding: 0.1rem 0.35rem;
            background: rgba(255,255,255,0.04);
            border-radius: 2px;
            color: var(--dim);
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--dim);
            font-size: 0.75rem;
        }
        .loading .spinner {
            display: inline-block;
            width: 20px; height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--cyan);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 0.5rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .empty {
            text-align: center;
            padding: 3rem;
            color: var(--dim);
            font-size: 0.7rem;
        }

        @media (max-width: 500px) {
            .top-bar { padding: 0.8rem 1rem; }
            .card-body { padding: 0 0.6rem 0.5rem; }
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="logo">KARMA FEED <span>// discovery</span></div>
        <a href="https://sloppy.live" class="backlink">&larr; sloppy.live</a>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="setTab('all')">All</button>
        <button class="tab" onclick="setTab('posts')">Posts</button>
        <button class="tab" onclick="setTab('manifestos')">Manifestos</button>
        <button class="tab" onclick="setTab('doodles')">Doodles</button>
        <button class="tab" onclick="setTab('messages')">Messages</button>
    </div>

    <div class="sort-bar">
        <button class="sbtn active" onclick="setSort('hot')">Hot</button>
        <button class="sbtn" onclick="setSort('top')">Top</button>
        <button class="sbtn" onclick="setSort('new')">New</button>
        <button class="sbtn" onclick="setSort('controversial')">Controversial</button>
    </div>

    <div class="feed" id="feed">
        <div class="loading"><div class="spinner"></div><br>Aggregating content from the ecosystem...</div>
    </div>

    <script type="module">
    import { createBrowserClient } from "https://cdn.jsdelivr.net/npm/@supabase/ssr@0.7.0/+esm";

    const SUPABASE_URL = 'https://yjyxteqzhhmtrgcaekgz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM8IS32IUYR2eenCCjdDdioiBU';

    const getCookieDomain = () => {
        const h = window.location.hostname;
        if (h.includes('sloppy.live')) return '.sloppy.live';
        if (h.includes('vibecodedbyx.com')) return '.vibecodedbyx.com';
        return '.youreabsolutelyright.xyz';
    };

    const supabase = createBrowserClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        cookieOptions: { name: 'sb-auth-token', domain: getCookieDomain(), path: '/', sameSite: 'lax' }
    });

    // --- STATE ---
    let currentTab = 'all';
    let currentSort = 'hot';
    let allContent = [];

    function escapeHtml(t) {
        if (!t) return '';
        const d = document.createElement('div');
        d.textContent = t;
        return d.innerHTML;
    }

    function timeAgo(dateStr) {
        const diff = Date.now() - new Date(dateStr).getTime();
        const mins = Math.floor(diff / 60000);
        if (mins < 1) return 'now';
        if (mins < 60) return mins + 'm';
        const hrs = Math.floor(mins / 60);
        if (hrs < 24) return hrs + 'h';
        const days = Math.floor(hrs / 24);
        return days + 'd';
    }

    function hotScore(upvotes, downvotes, comments, reactions, createdAt) {
        const net = upvotes - downvotes;
        const engagement = net + comments * 2 + reactions;
        const ageHours = Math.max(1, (Date.now() - new Date(createdAt).getTime()) / 3600000);
        // Decay: engagement / (age + 2)^1.5 -- similar to HN/Reddit
        return engagement / Math.pow(ageHours + 2, 1.3);
    }

    // --- LOAD ALL CONTENT ---
    async function loadContent() {
        document.getElementById('feed').innerHTML = '<div class="loading"><div class="spinner"></div><br>Aggregating content from the ecosystem...</div>';

        const [posts, manifestos, doodles, topMessages] = await Promise.all([
            supabase.from('sloppygram_posts').select('*').order('created_at', { ascending: false }).limit(100),
            supabase.from('sloppygram_manifestos').select('*').order('created_at', { ascending: false }).limit(100),
            supabase.from('sloppygram_messages').select('*').eq('message_type', 'drawing').order('created_at', { ascending: false }).limit(50),
            supabase.from('sloppygram_messages').select('*').eq('message_type', 'text').order('created_at', { ascending: false }).limit(50)
        ]);

        // Get engagement data for posts
        const postIds = (posts.data || []).map(p => p.id);
        const manifIds = (manifestos.data || []).map(m => m.id);
        const doodleIds = (doodles.data || []).map(d => d.id);
        const msgIds = (topMessages.data || []).map(m => m.id);

        const [postVotes, postReactions, postComments, postTags,
               manifVotes, manifReactions, manifComments,
               doodleVotes, msgVotes, msgReactions] = await Promise.all([
            postIds.length ? supabase.from('sloppygram_post_likes').select('post_id,vote_type').in('post_id', postIds) : { data: [] },
            postIds.length ? supabase.from('sloppygram_post_reactions').select('post_id').in('post_id', postIds) : { data: [] },
            postIds.length ? supabase.from('sloppygram_post_comments').select('post_id').in('post_id', postIds) : { data: [] },
            postIds.length ? supabase.from('sloppygram_post_tags').select('post_id,tag').in('post_id', postIds) : { data: [] },
            manifIds.length ? supabase.from('sloppygram_manifesto_votes').select('manifesto_id,vote_type').in('manifesto_id', manifIds) : { data: [] },
            manifIds.length ? supabase.from('sloppygram_manifesto_reactions').select('manifesto_id').in('manifesto_id', manifIds) : { data: [] },
            manifIds.length ? supabase.from('sloppygram_manifesto_comments').select('manifesto_id').in('manifesto_id', manifIds) : { data: [] },
            doodleIds.length ? supabase.from('sloppygram_doodle_votes').select('message_id').in('message_id', doodleIds) : { data: [] },
            msgIds.length ? supabase.from('sloppygram_message_votes').select('message_id').in('message_id', msgIds) : { data: [] },
            msgIds.length ? supabase.from('sloppygram_message_reactions').select('message_id').in('message_id', msgIds) : { data: [] }
        ]);

        // Tally engagement per item
        function tally(arr, key) {
            const m = {};
            (arr.data || []).forEach(r => { m[r[key]] = (m[r[key]] || 0) + 1; });
            return m;
        }
        function tallyVotes(arr, key) {
            const up = {}, down = {};
            (arr.data || []).forEach(r => {
                if (r.vote_type === 1) up[r[key]] = (up[r[key]] || 0) + 1;
                else if (r.vote_type === -1) down[r[key]] = (down[r[key]] || 0) + 1;
            });
            return { up, down };
        }

        const pvt = tallyVotes(postVotes, 'post_id');
        const prc = tally(postReactions, 'post_id');
        const pcc = tally(postComments, 'post_id');
        const mvt = tallyVotes(manifVotes, 'manifesto_id');
        const mrc = tally(manifReactions, 'manifesto_id');
        const mcc = tally(manifComments, 'manifesto_id');
        const dvc = tally(doodleVotes, 'message_id');
        const msgvc = tally(msgVotes, 'message_id');
        const msgrx = tally(msgReactions, 'message_id');

        // Tags per post
        const tagMap = {};
        (postTags.data || []).forEach(t => {
            if (!tagMap[t.post_id]) tagMap[t.post_id] = [];
            tagMap[t.post_id].push(t.tag);
        });

        // Normalize into unified content items
        allContent = [];

        (posts.data || []).forEach(p => {
            const up = pvt.up[p.id] || 0;
            const down = pvt.down[p.id] || 0;
            const reactions = prc[p.id] || 0;
            const comments = pcc[p.id] || 0;
            allContent.push({
                type: 'post', id: p.id,
                username: p.username, avatar: p.avatar,
                title: null,
                text: p.caption,
                image: p.image_url || p.image_data,
                createdAt: p.created_at,
                upvotes: up, downvotes: down, reactions, comments,
                tags: tagMap[p.id] || [],
                score: hotScore(up, down, comments, reactions, p.created_at)
            });
        });

        (manifestos.data || []).forEach(m => {
            const up = (mvt.up[m.id] || 0);
            const down = (mvt.down[m.id] || 0);
            const reactions = mrc[m.id] || 0;
            const comments = mcc[m.id] || 0;
            allContent.push({
                type: 'manifesto', id: m.id,
                username: m.username, avatar: m.avatar,
                title: m.title,
                text: m.content,
                image: null,
                createdAt: m.created_at,
                upvotes: up + (m.upvotes || 0), downvotes: down, reactions, comments,
                tags: [],
                score: hotScore(up + (m.upvotes || 0), down, comments, reactions, m.created_at)
            });
        });

        (doodles.data || []).forEach(d => {
            const votes = dvc[d.id] || 0;
            allContent.push({
                type: 'doodle', id: d.id,
                username: d.username, avatar: d.avatar,
                title: null,
                text: null,
                image: d.drawing_data,
                createdAt: d.created_at,
                upvotes: votes, downvotes: 0, reactions: 0, comments: 0,
                tags: [],
                score: hotScore(votes, 0, 0, 0, d.created_at)
            });
        });

        (topMessages.data || []).forEach(m => {
            const votes = msgvc[m.id] || 0;
            const reactions = msgrx[m.id] || 0;
            if (votes + reactions < 1 && currentSort !== 'new') return; // skip unengaged messages
            allContent.push({
                type: 'message', id: m.id,
                username: m.username, avatar: m.avatar,
                title: null,
                text: m.content,
                image: m.image_data,
                createdAt: m.created_at,
                upvotes: votes, downvotes: 0, reactions, comments: 0,
                tags: [],
                score: hotScore(votes, 0, 0, reactions, m.created_at)
            });
        });

        renderFeed();
    }

    function sortContent(items, sort) {
        const sorted = [...items];
        switch (sort) {
            case 'hot': sorted.sort((a, b) => b.score - a.score); break;
            case 'top': sorted.sort((a, b) => (b.upvotes - b.downvotes) - (a.upvotes - a.downvotes)); break;
            case 'new': sorted.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); break;
            case 'controversial':
                sorted.sort((a, b) => {
                    const aC = Math.min(a.upvotes, a.downvotes) / (Math.max(a.upvotes, a.downvotes) || 1) * (a.upvotes + a.downvotes);
                    const bC = Math.min(b.upvotes, b.downvotes) / (Math.max(b.upvotes, b.downvotes) || 1) * (b.upvotes + b.downvotes);
                    return bC - aC;
                });
                break;
        }
        return sorted;
    }

    function renderFeed() {
        const feed = document.getElementById('feed');
        let items = allContent;

        if (currentTab !== 'all') {
            const typeMap = { posts: 'post', manifestos: 'manifesto', doodles: 'doodle', messages: 'message' };
            items = items.filter(i => i.type === typeMap[currentTab]);
        }

        items = sortContent(items, currentSort);

        if (items.length === 0) {
            feed.innerHTML = '<div class="empty">No content found for this filter</div>';
            return;
        }

        feed.innerHTML = items.slice(0, 80).map((item, i) => {
            const net = item.upvotes - item.downvotes;
            const featured = i < 3 && currentSort === 'hot' ? 'featured' : '';
            const typeClass = 'type-' + item.type;
            const typeLabel = item.type.charAt(0).toUpperCase() + item.type.slice(1);

            let imageHtml = '';
            if (item.image && !item.image.startsWith('data:') && item.image.startsWith('http')) {
                imageHtml = `<img class="card-image" src="${escapeHtml(item.image)}" loading="lazy" alt="">`;
            } else if (item.image && item.image.startsWith('data:image')) {
                imageHtml = `<img class="card-image" src="${item.image}" loading="lazy" alt="">`;
            }

            let bodyHtml = '';
            if (item.title) {
                bodyHtml += `<div class="card-title">${escapeHtml(item.title)}</div>`;
            }
            if (item.text) {
                bodyHtml += `<div class="card-text">${escapeHtml(item.text)}</div>`;
            }

            let tagsHtml = '';
            if (item.tags.length > 0) {
                tagsHtml = `<div class="card-tags">${item.tags.map(t => `<span class="tag">#${escapeHtml(t)}</span>`).join('')}</div>`;
            }

            return `<div class="card ${featured}">
                <div class="card-header">
                    <div class="card-avatar">${item.avatar || item.username.slice(0,1).toUpperCase()}</div>
                    <div class="card-user">${escapeHtml(item.username)}</div>
                    <span class="card-type ${typeClass}">${typeLabel}</span>
                    <div class="card-meta">${timeAgo(item.createdAt)}</div>
                </div>
                ${imageHtml}
                ${bodyHtml ? `<div class="card-body">${bodyHtml}</div>` : ''}
                ${tagsHtml}
                <div class="card-footer">
                    <div class="card-stat">â–² ${item.upvotes}</div>
                    ${item.downvotes > 0 ? `<div class="card-stat">â–¼ ${item.downvotes}</div>` : ''}
                    ${item.reactions > 0 ? `<div class="card-stat">ðŸ˜€ ${item.reactions}</div>` : ''}
                    ${item.comments > 0 ? `<div class="card-stat">ðŸ’¬ ${item.comments}</div>` : ''}
                    <div class="card-score">${net >= 0 ? '+' : ''}${net}</div>
                </div>
            </div>`;
        }).join('');
    }

    // --- TABS & SORTING ---
    window.setTab = function(t) {
        currentTab = t;
        document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        renderFeed();
    };

    window.setSort = function(s) {
        currentSort = s;
        document.querySelectorAll('.sbtn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        renderFeed();
    };

    // Init
    async function init() {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) await supabase.auth.signInAnonymously();
        await loadContent();
    }

    init();
    </script>
</body>
</html>