<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sloppy Factions - Territory Wars</title>
    <link rel="icon" href="https://emojicdn.elk.sh/‚öîÔ∏è">
    <meta property="og:title" content="Sloppy Factions">
    <meta property="og:description" content="Pledge your allegiance, conquer territory, wage war">
    <meta property="og:url" content="https://sloppy.live/sloppy-factions">
    <meta property="og:image" content="https://emojicdn.elk.sh/‚öîÔ∏è?style=google">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,200;12..96,400;12..96,700;12..96,800&family=JetBrains+Mono:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{
            --bg:#08080e;--surface:#0f0f1a;--surface2:#161625;--border:#222238;
            --text:#d0d0dc;--dim:#606078;--accent:#ff6b3d;
            --phoenix:#ff4444;--shadow:#6a6a8a;--cyber:#00ffff;--verdant:#22c55e;--cosmic:#8b5cf6;
        }
        body{background:var(--bg);color:var(--text);font-family:'JetBrains Mono',monospace;min-height:100vh;overflow-x:hidden}

        /* War-torn grid bg */
        body::before{content:'';position:fixed;inset:0;
            background:
                repeating-linear-gradient(0deg,transparent,transparent 59px,rgba(255,107,61,0.04) 59px,rgba(255,107,61,0.04) 60px),
                repeating-linear-gradient(90deg,transparent,transparent 59px,rgba(255,107,61,0.04) 59px,rgba(255,107,61,0.04) 60px);
            pointer-events:none;z-index:0}

        .app{position:relative;z-index:1;max-width:1200px;margin:0 auto;padding:20px 16px 80px}

        /* Header */
        .header{text-align:center;padding:28px 0 20px}
        .header h1{font-family:'Bricolage Grotesque',sans-serif;font-weight:800;font-size:clamp(2rem,5vw,3.2rem);
            color:var(--accent);text-shadow:0 0 30px rgba(255,107,61,0.3);letter-spacing:-1px}
        .header .sub{font-size:0.65rem;color:var(--dim);margin-top:4px;letter-spacing:2px;text-transform:uppercase}

        /* War stats strip */
        .war-stats{display:flex;justify-content:center;gap:12px;margin:16px 0 24px;flex-wrap:wrap}
        .ws-pill{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:8px 14px;
            font-size:0.7rem;color:var(--dim);text-align:center}
        .ws-pill .val{display:block;font-size:1.1rem;font-weight:700;color:var(--text);margin-bottom:2px}

        /* Tabs */
        .tabs{display:flex;gap:4px;justify-content:center;margin-bottom:20px;flex-wrap:wrap}
        .tab-btn{background:var(--surface);border:1px solid var(--border);color:var(--dim);padding:8px 16px;
            border-radius:6px;cursor:pointer;font-family:'JetBrains Mono',monospace;font-size:0.72rem;transition:all 0.2s}
        .tab-btn.active{background:var(--accent);color:var(--bg);border-color:var(--accent);font-weight:700}

        .tab-panel{display:none}
        .tab-panel.active{display:block}

        /* My faction banner */
        .my-faction{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px 20px;
            margin-bottom:20px;display:flex;align-items:center;gap:16px;flex-wrap:wrap}
        .my-faction.hidden{display:none}
        .mf-emoji{font-size:2rem}
        .mf-info{flex:1;min-width:160px}
        .mf-name{font-family:'Bricolage Grotesque',sans-serif;font-weight:700;font-size:1.1rem}
        .mf-stats{font-size:0.65rem;color:var(--dim);margin-top:4px}
        .mf-stats span{color:var(--text);font-weight:500}
        .leave-btn{background:none;border:1px solid rgba(255,68,68,0.3);color:#ff4444;padding:6px 14px;
            border-radius:6px;cursor:pointer;font-family:inherit;font-size:0.65rem;transition:all 0.2s}
        .leave-btn:hover{background:rgba(255,68,68,0.1)}

        /* Faction selection grid */
        .faction-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-bottom:24px}
        .faction-card{background:var(--surface);border:2px solid var(--border);border-radius:12px;padding:18px;
            text-align:center;cursor:pointer;transition:all 0.25s;position:relative;overflow:hidden}
        .faction-card:hover{transform:translateY(-2px)}
        .faction-card .fc-emoji{font-size:2.4rem;margin-bottom:8px;display:block}
        .faction-card .fc-name{font-family:'Bricolage Grotesque',sans-serif;font-weight:700;font-size:0.95rem;margin-bottom:4px}
        .faction-card .fc-desc{font-size:0.6rem;color:var(--dim);margin-bottom:10px;line-height:1.5}
        .faction-card .fc-members{font-size:0.6rem;color:var(--dim)}
        .faction-card .fc-members span{font-weight:500;color:var(--text)}
        .pledge-btn{background:var(--accent);color:var(--bg);border:none;padding:8px 18px;border-radius:6px;
            cursor:pointer;font-family:inherit;font-size:0.7rem;font-weight:700;margin-top:10px;transition:opacity 0.2s}
        .pledge-btn:hover{opacity:0.85}

        /* Territory Map */
        .territory-map{margin-bottom:24px}
        .territory-legend{display:flex;gap:8px;justify-content:center;margin-bottom:12px;flex-wrap:wrap}
        .tl-item{font-size:0.6rem;color:var(--dim);display:flex;align-items:center;gap:4px}
        .tl-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0}

        .territory-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:4px;max-width:700px;margin:0 auto}
        .t-cell{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:10px 8px;
            text-align:center;min-height:80px;display:flex;flex-direction:column;justify-content:center;
            transition:all 0.2s;cursor:pointer;position:relative}
        .t-cell:hover{border-color:var(--accent);z-index:2}
        .t-cell.owned{border-width:2px}
        .t-name{font-size:0.55rem;color:var(--text);font-weight:500;margin-bottom:4px;line-height:1.3}
        .t-faction{font-size:1rem;margin-bottom:2px}
        .t-defense{font-size:0.5rem;color:var(--dim)}
        .t-attack-btn{position:absolute;inset:0;background:rgba(255,107,61,0.9);color:#fff;
            border:none;border-radius:6px;cursor:pointer;font-family:inherit;font-size:0.65rem;font-weight:700;
            opacity:0;transition:opacity 0.2s;display:flex;align-items:center;justify-content:center}
        .t-cell:hover .t-attack-btn.can-attack{opacity:1}
        .t-home{position:absolute;top:3px;right:5px;font-size:0.55rem;opacity:0.7}

        /* Leaderboard */
        .leaderboard{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-bottom:20px}
        .lb-head{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .lb-title{font-family:'Bricolage Grotesque',sans-serif;font-weight:700;font-size:0.95rem}
        .lb-row{display:grid;grid-template-columns:40px 2rem 1fr 70px 60px 70px;align-items:center;
            padding:10px 18px;border-bottom:1px solid rgba(255,255,255,0.03);gap:8px;font-size:0.75rem}
        .lb-row:last-child{border-bottom:none}
        .lb-rank{font-weight:700;text-align:center}
        .lb-rank.gold{color:#f0c040}.lb-rank.silver{color:#c0c8d0}.lb-rank.bronze{color:#cd7f32}
        .lb-emoji{text-align:center;font-size:1.1rem}
        .lb-fname{font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .lb-territories{color:var(--dim);text-align:right;font-size:0.65rem}
        .lb-members{color:var(--dim);text-align:right;font-size:0.65rem}
        .lb-power{color:var(--accent);font-weight:500;text-align:right}

        /* Battle log */
        .battle-log{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden}
        .bl-entry{padding:10px 18px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:0.7rem;line-height:1.6}
        .bl-entry:last-child{border-bottom:none}
        .bl-victory{color:var(--verdant)}.bl-defeat{color:var(--phoenix)}
        .bl-time{font-size:0.55rem;color:var(--dim);margin-left:6px}
        .bl-empty{padding:20px;text-align:center;color:var(--dim);font-size:0.7rem}

        /* Warriors tab */
        .warriors-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
        .warrior-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 16px;
            display:flex;align-items:center;gap:12px}
        .wc-rank{font-size:0.85rem;font-weight:700;width:28px;text-align:center;flex-shrink:0}
        .wc-info{flex:1;min-width:0}
        .wc-name{font-size:0.8rem;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .wc-faction{font-size:0.6rem;color:var(--dim);margin-top:2px}
        .wc-stats{font-size:0.6rem;color:var(--dim);display:flex;gap:8px;margin-top:4px}
        .wc-stats span{color:var(--text)}

        /* Battle modal */
        .battle-modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:100;display:none;
            align-items:center;justify-content:center;padding:20px}
        .battle-modal.visible{display:flex}
        .bm-content{background:var(--surface);border:2px solid var(--accent);border-radius:16px;padding:28px;
            max-width:400px;width:100%;text-align:center;animation:modalIn 0.3s ease}
        .bm-title{font-family:'Bricolage Grotesque',sans-serif;font-weight:800;font-size:1.3rem;color:var(--accent);margin-bottom:16px}
        .bm-territory{font-size:0.8rem;color:var(--dim);margin-bottom:16px}
        .bm-vs{display:flex;align-items:center;justify-content:center;gap:20px;margin-bottom:20px}
        .bm-side{text-align:center}
        .bm-side-emoji{font-size:2rem;margin-bottom:4px;display:block}
        .bm-side-power{font-family:'Bricolage Grotesque',sans-serif;font-weight:800;font-size:1.5rem}
        .bm-side-label{font-size:0.55rem;color:var(--dim);margin-top:2px}
        .bm-vs-icon{font-size:1.5rem;color:var(--accent)}
        .bm-actions{display:flex;gap:8px;justify-content:center}
        .bm-attack{background:var(--accent);color:#fff;border:none;padding:10px 28px;border-radius:8px;
            cursor:pointer;font-family:inherit;font-size:0.8rem;font-weight:700;transition:opacity 0.2s}
        .bm-attack:hover{opacity:0.85}
        .bm-cancel{background:none;border:1px solid var(--border);color:var(--dim);padding:10px 20px;
            border-radius:8px;cursor:pointer;font-family:inherit;font-size:0.8rem;transition:all 0.2s}
        .bm-cancel:hover{border-color:var(--text);color:var(--text)}

        /* Battle result toast */
        .battle-result{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0.8);
            z-index:200;padding:28px 40px;border-radius:16px;text-align:center;
            font-family:'Bricolage Grotesque',sans-serif;font-weight:800;font-size:1.6rem;
            opacity:0;transition:all 0.4s;pointer-events:none}
        .battle-result.show{opacity:1;transform:translate(-50%,-50%) scale(1)}
        .battle-result.victory{background:rgba(34,197,94,0.95);color:#fff;box-shadow:0 0 60px rgba(34,197,94,0.4)}
        .battle-result.defeat{background:rgba(255,68,68,0.95);color:#fff;box-shadow:0 0 60px rgba(255,68,68,0.4)}
        .br-sub{font-size:0.7rem;font-weight:400;margin-top:6px;opacity:0.8}

        .backlink{text-align:center;margin-top:28px;font-size:0.6rem}
        .backlink a{color:var(--dim);text-decoration:none}.backlink a:hover{color:var(--accent)}

        /* Embed mode */
        body.embed-mode .header{display:none}
        body.embed-mode .backlink{display:none}
        body.embed-mode .app{padding:8px 8px 40px}

        .toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--surface2);
            border:1px solid var(--border);border-radius:8px;padding:10px 18px;font-size:0.7rem;
            color:var(--text);z-index:50;opacity:0;transition:opacity 0.3s;pointer-events:none}
        .toast.show{opacity:1}

        @keyframes modalIn{from{opacity:0;transform:scale(0.9)}to{opacity:1;transform:scale(1)}}

        @media(max-width:600px){
            .territory-grid{grid-template-columns:repeat(5,1fr);gap:3px}
            .t-cell{padding:6px 4px;min-height:60px}
            .t-name{font-size:0.45rem}
            .lb-row{grid-template-columns:30px 1.5rem 1fr 50px 40px 50px;padding:8px 12px;font-size:0.65rem}
            .war-stats{gap:6px}.ws-pill{padding:6px 10px}
        }
    </style>
<script>
(function(){var Q=[],N=0,MAX=10;function send(e){var sb=window.supabase;if(!sb){Q.push(e);return;}if(N>=MAX)return;N++;sb.auth.getSession().then(function(r){var u=r&&r.data&&r.data.session&&r.data.session.user;if(!u)return;sb.from('ai_events').insert({event_type:'client_error',entity_type:'app',entity_id:u.id,username:location.pathname.split('/').filter(Boolean)[0]||'unknown',metadata:e,user_id:u.id}).then(function(){});}).catch(function(){});}window.onerror=function(m,s,l,c,e){send({type:'error',msg:String(m).slice(0,500),src:s||'',line:l,col:c,stack:e?String(e.stack).slice(0,1000):''});};window.addEventListener('unhandledrejection',function(ev){var r=ev.reason;send({type:'promise',msg:String(r&&r.message||r).slice(0,500),stack:r?String(r.stack||'').slice(0,1000):''});});var fi=setInterval(function(){if(window.supabase){Q.splice(0).forEach(send);clearInterval(fi);}},1000);setTimeout(function(){clearInterval(fi);},30000);})();
</script>
</head>
<body>
    <div class="app">
        <div class="header">
            <h1>‚öîÔ∏è SLOPPY FACTIONS</h1>
            <div class="sub">Territory Wars</div>
        </div>

        <div class="war-stats" id="warStats">
            <div class="ws-pill"><span class="val" id="wsTerritories">25</span>territories</div>
            <div class="ws-pill"><span class="val" id="wsWarriors">0</span>warriors</div>
            <div class="ws-pill"><span class="val" id="wsBattles">0</span>battles</div>
            <div class="ws-pill"><span class="val" id="wsContested">0</span>contested</div>
        </div>

        <div class="my-faction hidden" id="myFaction">
            <div class="mf-emoji" id="mfEmoji"></div>
            <div class="mf-info">
                <div class="mf-name" id="mfName"></div>
                <div class="mf-stats" id="mfStats"></div>
            </div>
            <button class="leave-btn" onclick="leaveFaction()">Leave Faction</button>
        </div>

        <div class="tabs">
            <button class="tab-btn active" data-tab="map" onclick="switchTab('map')">üó∫Ô∏è Territory Map</button>
            <button class="tab-btn" data-tab="factions" onclick="switchTab('factions')">üè¥ Factions</button>
            <button class="tab-btn" data-tab="warriors" onclick="switchTab('warriors')">üë§ Warriors</button>
            <button class="tab-btn" data-tab="battles" onclick="switchTab('battles')">üìú Battle Log</button>
        </div>

        <!-- MAP TAB -->
        <div class="tab-panel active" id="tab-map">
            <div class="territory-legend" id="territoryLegend"></div>
            <div class="territory-grid" id="territoryGrid"></div>
        </div>

        <!-- FACTIONS TAB -->
        <div class="tab-panel" id="tab-factions">
            <div class="faction-grid" id="factionGrid"></div>
            <div class="leaderboard" id="factionLeaderboard">
                <div class="lb-head"><div class="lb-title">Faction Rankings</div></div>
                <div id="factionLbBody"></div>
            </div>
        </div>

        <!-- WARRIORS TAB -->
        <div class="tab-panel" id="tab-warriors">
            <div class="warriors-grid" id="warriorsGrid"></div>
        </div>

        <!-- BATTLES TAB -->
        <div class="tab-panel" id="tab-battles">
            <div class="battle-log" id="battleLog">
                <div class="lb-head"><div class="lb-title">Recent Battles</div></div>
                <div id="battleLogBody"></div>
            </div>
        </div>

        <div class="backlink"><a href="https://sloppy.live">‚Üê sloppy.live</a></div>
    </div>

    <div class="battle-modal" id="battleModal">
        <div class="bm-content" id="bmContent"></div>
    </div>
    <div class="battle-result" id="battleResult"></div>
    <div class="toast" id="toast"></div>

    <script src="/sloppy-header/sloppy-bar.js" data-position="bottom"></script>
    <script type="module">
        import { createBrowserClient } from "https://cdn.jsdelivr.net/npm/@supabase/ssr@0.7.0/+esm";

        // Embed mode detection
        const IS_EMBED = new URLSearchParams(location.search).has('embed');
        if (IS_EMBED) document.body.classList.add('embed-mode');

        function notifyParent(data) {
            if (IS_EMBED && window.parent !== window) {
                window.parent.postMessage(data, '*');
            }
        }

        const SUPABASE_URL = 'https://yjyxteqzhhmtrgcaekgz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM8IS32IUYR2eenCCjdDdioiBU';

        const supabase = createBrowserClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            cookieOptions: { name: 'sb-auth-token', domain: location.hostname.includes('sloppy.live') ? '.sloppy.live' : location.hostname, path: '/', sameSite: 'lax' }
        });
        window.supabase = supabase;

        // --- Constants ---
        const FACTIONS = [
            { faction_id: 'phoenix', name: 'Phoenix Order', emoji: 'üî•', color: '#ff4444', description: 'Rise from the ashes' },
            { faction_id: 'shadow', name: 'Shadow Collective', emoji: 'üåë', color: '#6a6a8a', description: 'Strike from darkness' },
            { faction_id: 'cyber', name: 'Cyber Nexus', emoji: '‚ö°', color: '#00ffff', description: 'Digital supremacy' },
            { faction_id: 'verdant', name: 'Verdant Grove', emoji: 'üåø', color: '#22c55e', description: 'Nature prevails' },
            { faction_id: 'cosmic', name: 'Cosmic Void', emoji: 'üåå', color: '#8b5cf6', description: 'Beyond the stars' },
        ];

        const TERRITORY_NAMES = [
            'Northern Peaks','Frost Gate','Crystal Vale','Ember Ridge','Storm Watch',
            'Iron Hollow','Shadow Marsh','Gilt Spire','Crimson Fen','Ashen Keep',
            'Twilight Mesa','Jade Falls','Obsidian Pit','Silver Drift','Coral Reach',
            'Thunder Bluff','Moonlit Glade','Copper Gorge','Violet Deep','Sand Citadel',
            'Bone Canyon','Silk Harbor','Granite Throne','Amber Trail','Star Basin'
        ];

        const factionLookup = {};
        FACTIONS.forEach(f => { factionLookup[f.faction_id] = f; });

        // --- State ---
        let currentUser = null;
        let currentUsername = null;
        let factionsData = [];
        let territoriesData = [];
        let battlesData = [];
        let membersData = [];
        let userFaction = null;
        let userMembership = null;
        let karmaData = null;

        // --- Header sync ---
        function applyHeaderContext(ctx) {
            if (!ctx) return;
            if (ctx.username && ctx.username !== 'Guest') currentUsername = ctx.username;
            // Only trust karma from header when context is actually ready (DB fetched)
            if (ctx.ready && ctx.karma !== undefined) karmaData = { karma_total: ctx.karma };
        }

        // --- Auth + Init ---
        async function init() {
            const sessRes = await supabase.auth.getSession();
            let session = sessRes.data.session;
            if (!session) {
                const signRes = await supabase.auth.signInAnonymously();
                session = signRes.data.session;
            }
            currentUser = session?.user;

            if (currentUser) {
                // Use header sync context for username + karma instead of direct DB queries
                if (window.sloppyBarGetContext) {
                    const ctx = window.sloppyBarGetContext(function(readyCtx) {
                        var karmaChanged = !karmaData && readyCtx.karma > 0;
                        applyHeaderContext(readyCtx);
                        // Re-render if karma arrived late (affects battle power)
                        if (karmaChanged && factionsData.length) renderAll();
                    });
                    applyHeaderContext(ctx);
                }
                // Fallback: direct DB query if header didn't provide username
                if (!currentUsername) {
                    const { data: prof } = await supabase.from('sloppygram_profiles').select('username').eq('user_id', currentUser.id).single();
                    if (prof) currentUsername = prof.username;
                }
            }

            await initializeFactions();
            await loadAllData();

            // Real-time battle updates
            supabase.channel('faction-battles')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'sloppygram_faction_battles' }, () => {
                    setTimeout(loadAllData, 500);
                })
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'sloppygram_territories' }, () => {
                    setTimeout(loadAllData, 500);
                })
                .subscribe();
        }

        async function initializeFactions() {
            // Seed factions if empty
            const { data: existing } = await supabase.from('sloppygram_factions').select('faction_id').limit(1);
            if (!existing || existing.length === 0) {
                for (const f of FACTIONS) {
                    await supabase.from('sloppygram_factions').insert({
                        faction_id: f.faction_id, name: f.name, emoji: f.emoji, color: f.color,
                        description: f.description, member_count: 0, territory_count: 0, power_score: 0,
                        user_id: currentUser.id
                    });
                }
            }

            // Seed territories if empty
            const { data: existingT } = await supabase.from('sloppygram_territories').select('territory_id').limit(1);
            if (!existingT || existingT.length === 0) {
                for (let y = 0; y < 5; y++) {
                    for (let x = 0; x < 5; x++) {
                        const idx = y * 5 + x;
                        await supabase.from('sloppygram_territories').insert({
                            territory_id: `t_${x}_${y}`, name: TERRITORY_NAMES[idx],
                            grid_x: x, grid_y: y, controlling_faction: null,
                            defense_power: 10 + Math.floor(Math.random() * 21),
                            user_id: currentUser.id
                        });
                    }
                }
            }
        }

        async function loadAllData() {
            // Skip karma DB query if header context already provided it
            const needsKarmaQuery = currentUser && !karmaData;
            const [factionsRes, territoriesRes, membersRes, battlesRes, karmaRes] = await Promise.all([
                supabase.from('sloppygram_factions').select('*'),
                supabase.from('sloppygram_territories').select('*'),
                supabase.from('sloppygram_faction_members').select('*'),
                supabase.from('sloppygram_faction_battles').select('*').order('created_at', { ascending: false }).limit(50),
                needsKarmaQuery ? supabase.from('sloppygram_karma').select('karma_total').eq('user_id', currentUser.id).single() : Promise.resolve({ data: null })
            ]);

            factionsData = factionsRes.data || [];
            territoriesData = territoriesRes.data || [];
            membersData = membersRes.data || [];
            battlesData = battlesRes.data || [];
            if (karmaRes.data) karmaData = karmaRes.data;

            // Find user's faction
            userFaction = null;
            userMembership = null;
            if (currentUser) {
                userMembership = membersData.find(m => m.user_id === currentUser.id);
                if (userMembership) {
                    userFaction = factionLookup[userMembership.faction_id] || null;
                }
            }

            renderAll();
        }

        function renderAll() {
            renderMyFaction();
            renderWarStats();
            renderTerritoryMap();
            renderFactionSelection();
            renderFactionLeaderboard();
            renderWarriors();
            renderBattleLog();
        }

        // --- My Faction Banner ---
        function renderMyFaction() {
            const el = document.getElementById('myFaction');
            if (!userFaction || !userMembership) { el.classList.add('hidden'); return; }
            el.classList.remove('hidden');
            el.style.borderColor = userFaction.color;
            document.getElementById('mfEmoji').textContent = userFaction.emoji;
            document.getElementById('mfName').textContent = userFaction.name;
            document.getElementById('mfName').style.color = userFaction.color;
            document.getElementById('mfStats').innerHTML = `
                Contribution: <span>${userMembership.contribution_score || 0}</span> ¬∑
                Won: <span>${userMembership.battles_won || 0}</span> ¬∑
                Lost: <span>${userMembership.battles_lost || 0}</span>`;
        }

        // --- War Stats ---
        function renderWarStats() {
            const totalWarriors = membersData.length;
            const totalBattles = battlesData.length;
            const contested = new Set(battlesData.slice(0, 20).map(b => b.territory_id)).size;
            document.getElementById('wsWarriors').textContent = totalWarriors;
            document.getElementById('wsBattles').textContent = totalBattles;
            document.getElementById('wsContested').textContent = contested;
        }

        // --- Territory Map ---
        function renderTerritoryMap() {
            // Legend
            const legend = document.getElementById('territoryLegend');
            const counts = {};
            territoriesData.forEach(t => {
                if (t.controlling_faction) counts[t.controlling_faction] = (counts[t.controlling_faction] || 0) + 1;
            });
            let legendHtml = '';
            FACTIONS.forEach(f => {
                const c = counts[f.faction_id] || 0;
                legendHtml += `<div class="tl-item"><div class="tl-dot" style="background:${f.color}"></div>${f.emoji} ${c}</div>`;
            });
            const unclaimed = territoriesData.filter(t => !t.controlling_faction).length;
            legendHtml += `<div class="tl-item"><div class="tl-dot" style="background:var(--border)"></div>‚¨ú ${unclaimed}</div>`;
            legend.innerHTML = legendHtml;

            // Grid
            const grid = document.getElementById('territoryGrid');
            const sorted = [...territoriesData].sort((a, b) => (a.grid_y * 5 + a.grid_x) - (b.grid_y * 5 + b.grid_x));

            grid.innerHTML = sorted.map(t => {
                const faction = t.controlling_faction ? factionLookup[t.controlling_faction] : null;
                const bgColor = faction ? faction.color + '20' : 'transparent';
                const borderColor = faction ? faction.color : 'var(--border)';
                const isOwn = userFaction && t.controlling_faction === userFaction.faction_id;
                const canAttack = userFaction && t.controlling_faction !== userFaction.faction_id;

                return `<div class="t-cell${faction ? ' owned' : ''}" style="background:${bgColor};border-color:${borderColor}"
                    onclick="window._showTerritoryInfo('${t.territory_id}')">
                    ${isOwn ? '<div class="t-home">üè†</div>' : ''}
                    <div class="t-faction">${faction ? faction.emoji : '‚¨ú'}</div>
                    <div class="t-name">${t.name}</div>
                    <div class="t-defense">‚ö°${t.defense_power}</div>
                    ${canAttack ? `<button class="t-attack-btn can-attack" onclick="event.stopPropagation();window._attackTerritory('${t.territory_id}')">‚öîÔ∏è ATTACK</button>` : ''}
                </div>`;
            }).join('');
        }

        // --- Faction Selection ---
        function renderFactionSelection() {
            const grid = document.getElementById('factionGrid');
            if (userFaction) {
                grid.innerHTML = '';
                return;
            }
            grid.innerHTML = FACTIONS.map(f => {
                const data = factionsData.find(d => d.faction_id === f.faction_id);
                const memberCount = data ? data.member_count : 0;
                return `<div class="faction-card" style="border-color:${f.color}30" onmouseenter="this.style.borderColor='${f.color}'" onmouseleave="this.style.borderColor='${f.color}30'">
                    <span class="fc-emoji">${f.emoji}</span>
                    <div class="fc-name" style="color:${f.color}">${f.name}</div>
                    <div class="fc-desc">${f.description}</div>
                    <div class="fc-members">Members: <span>${memberCount}</span></div>
                    <button class="pledge-btn" onclick="window._pledgeFaction('${f.faction_id}')">Pledge Allegiance</button>
                </div>`;
            }).join('');
        }

        // --- Faction Leaderboard ---
        function renderFactionLeaderboard() {
            const sorted = [...factionsData].sort((a, b) => {
                if ((b.territory_count || 0) !== (a.territory_count || 0)) return (b.territory_count || 0) - (a.territory_count || 0);
                return (b.power_score || 0) - (a.power_score || 0);
            });
            document.getElementById('factionLbBody').innerHTML = sorted.map((f, i) => {
                const info = factionLookup[f.faction_id] || {};
                const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
                return `<div class="lb-row">
                    <div class="lb-rank ${rankClass}">${i + 1}</div>
                    <div class="lb-emoji">${info.emoji || '?'}</div>
                    <div class="lb-fname" style="color:${info.color || 'var(--text)'}">${f.name}</div>
                    <div class="lb-territories">üó∫Ô∏è ${f.territory_count || 0}</div>
                    <div class="lb-members">üë• ${f.member_count || 0}</div>
                    <div class="lb-power">‚ö°${f.power_score || 0}</div>
                </div>`;
            }).join('');
        }

        // --- Warriors ---
        function renderWarriors() {
            const sorted = [...membersData].sort((a, b) => (b.contribution_score || 0) - (a.contribution_score || 0));
            const grid = document.getElementById('warriorsGrid');
            if (sorted.length === 0) {
                grid.innerHTML = '<div style="text-align:center;color:var(--dim);padding:40px;font-size:0.75rem">No warriors yet. Be the first to pledge!</div>';
                return;
            }
            grid.innerHTML = sorted.slice(0, 50).map((m, i) => {
                const f = factionLookup[m.faction_id] || {};
                const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
                return `<div class="warrior-card">
                    <div class="wc-rank" style="color:${i < 3 ? ['#f0c040','#c0c8d0','#cd7f32'][i] : 'var(--dim)'}">${i + 1}</div>
                    <div class="wc-info">
                        <div class="wc-name" style="cursor:pointer;text-decoration:underline dotted" onclick="notifyParent({type:'username-click',username:'${escapeHtml(m.username || '')}'});">${escapeHtml(m.username || 'Unknown')}</div>
                        <div class="wc-faction" style="color:${f.color || 'var(--dim)'}">${f.emoji || ''} ${f.name || 'Unknown'}</div>
                        <div class="wc-stats">
                            Score: <span>${m.contribution_score || 0}</span>
                            W: <span>${m.battles_won || 0}</span>
                            L: <span>${m.battles_lost || 0}</span>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        // --- Battle Log ---
        function renderBattleLog() {
            const body = document.getElementById('battleLogBody');
            if (battlesData.length === 0) {
                body.innerHTML = '<div class="bl-empty">No battles yet. Claim your first territory!</div>';
                return;
            }
            body.innerHTML = battlesData.slice(0, 30).map(b => {
                const attacker = factionLookup[b.attacker_faction] || {};
                const defender = factionLookup[b.defender_faction] || {};
                const territory = territoriesData.find(t => t.territory_id === b.territory_id);
                const won = b.winner_faction === b.attacker_faction;
                const verb = won ? 'conquered' : 'failed to take';
                const cls = won ? 'bl-victory' : 'bl-defeat';
                return `<div class="bl-entry">
                    <span class="${cls}">${attacker.emoji || '?'} <span style="cursor:pointer;text-decoration:underline dotted" onclick="notifyParent({type:'username-click',username:'${escapeHtml(b.attacker_username || '')}'});">${escapeHtml(b.attacker_username || '?')}</span> ${verb}
                    <strong>${territory ? territory.name : b.territory_id}</strong></span>
                    ${!won ? ` (defended by ${defender.emoji || '?'})` : ` from ${defender.emoji || '‚¨ú'}`}
                    <span class="bl-time">${timeAgo(b.created_at)}</span>
                </div>`;
            }).join('');
        }

        // --- Actions ---
        window._pledgeFaction = async function(factionId) {
            if (!currentUser) { showToast('Sign in first'); return; }
            if (userFaction) { showToast('Already in a faction. Leave first.'); return; }
            if (!currentUsername) { showToast('Set a username in Sloppygram first'); return; }

            const { error } = await supabase.from('sloppygram_faction_members').insert({
                username: currentUsername, faction_id: factionId,
                contribution_score: 0, battles_won: 0, battles_lost: 0, user_id: currentUser.id
            });
            if (error) { showToast('Failed to join: ' + error.message); return; }

            // Increment member count
            const fData = factionsData.find(f => f.faction_id === factionId);
            if (fData) {
                await supabase.from('sloppygram_factions')
                    .update({ member_count: (fData.member_count || 0) + 1, updated_at: new Date().toISOString() })
                    .eq('faction_id', factionId);
            }

            showToast(`Pledged to ${factionLookup[factionId].name}!`);
            await loadAllData();
        };

        window.leaveFaction = async function() {
            if (!userMembership) return;
            if (!confirm('Leave your faction? You will lose your contribution score.')) return;

            await supabase.from('sloppygram_faction_members').delete().eq('user_id', currentUser.id);

            const fData = factionsData.find(f => f.faction_id === userMembership.faction_id);
            if (fData) {
                await supabase.from('sloppygram_factions')
                    .update({ member_count: Math.max(0, (fData.member_count || 1) - 1), updated_at: new Date().toISOString() })
                    .eq('faction_id', userMembership.faction_id);
            }

            showToast('Left faction');
            await loadAllData();
        };

        window._attackTerritory = function(territoryId) {
            if (!currentUser) { showToast('Sign in first'); return; }
            if (!userFaction) { showToast('Join a faction first'); return; }

            const territory = territoriesData.find(t => t.territory_id === territoryId);
            if (!territory) return;
            if (territory.controlling_faction === userFaction.faction_id) { showToast('Already yours!'); return; }

            // Calculate attack power
            const base = 10 + Math.floor(Math.random() * 20);
            const karmaBonus = karmaData ? Math.floor((karmaData.karma_total || 0) / 50) : 0;
            const contribBonus = userMembership ? (userMembership.contribution_score || 0) : 0;
            const attackPower = base + karmaBonus + contribBonus;
            const defensePower = territory.defense_power || 15;

            const defender = territory.controlling_faction ? factionLookup[territory.controlling_faction] : null;

            document.getElementById('bmContent').innerHTML = `
                <div class="bm-title">‚öîÔ∏è BATTLE FOR TERRITORY</div>
                <div class="bm-territory">${territory.name}</div>
                <div class="bm-vs">
                    <div class="bm-side">
                        <span class="bm-side-emoji">${userFaction.emoji}</span>
                        <div class="bm-side-power" style="color:${userFaction.color}">${attackPower}</div>
                        <div class="bm-side-label">Your Power</div>
                    </div>
                    <div class="bm-vs-icon">‚öîÔ∏è</div>
                    <div class="bm-side">
                        <span class="bm-side-emoji">${defender ? defender.emoji : '‚¨ú'}</span>
                        <div class="bm-side-power" style="color:${defender ? defender.color : 'var(--dim)'}">${defensePower}</div>
                        <div class="bm-side-label">Defense</div>
                    </div>
                </div>
                <div class="bm-actions">
                    <button class="bm-attack" onclick="window._executeBattle('${territoryId}',${attackPower},${defensePower})">ATTACK</button>
                    <button class="bm-cancel" onclick="document.getElementById('battleModal').classList.remove('visible')">Retreat</button>
                </div>`;
            document.getElementById('battleModal').classList.add('visible');
        };

        window._executeBattle = async function(territoryId, attackPower, defensePower) {
            document.getElementById('battleModal').classList.remove('visible');

            const territory = territoriesData.find(t => t.territory_id === territoryId);
            if (!territory) return;

            const attackRoll = attackPower + Math.floor(Math.random() * 11) - 5;
            const defenseRoll = defensePower + Math.floor(Math.random() * 11) - 5;
            const victory = attackRoll > defenseRoll;
            const defenderFaction = territory.controlling_faction || 'unclaimed';

            // Record battle
            await supabase.from('sloppygram_faction_battles').insert({
                attacker_faction: userFaction.faction_id,
                defender_faction: defenderFaction,
                territory_id: territoryId,
                attacker_username: currentUsername || 'anonymous',
                attacker_power: attackPower,
                defender_power: defensePower,
                winner_faction: victory ? userFaction.faction_id : defenderFaction,
                status: 'completed',
                user_id: currentUser.id
            });

            // Update member stats
            const updates = {
                battles_won: (userMembership.battles_won || 0) + (victory ? 1 : 0),
                battles_lost: (userMembership.battles_lost || 0) + (victory ? 0 : 1),
                contribution_score: (userMembership.contribution_score || 0) + (victory ? 10 : 2),
                updated_at: new Date().toISOString()
            };
            await supabase.from('sloppygram_faction_members').update(updates)
                .eq('user_id', currentUser.id);

            if (victory) {
                // Capture territory
                await supabase.from('sloppygram_territories').update({
                    controlling_faction: userFaction.faction_id,
                    defense_power: Math.max(10, attackPower - 5),
                    captured_at: new Date().toISOString(),
                    captured_by: currentUsername || 'anonymous',
                    updated_at: new Date().toISOString()
                }).eq('territory_id', territoryId);

                // Recalc power scores
                await recalcFactionPower(userFaction.faction_id);
                if (defenderFaction !== 'unclaimed') await recalcFactionPower(defenderFaction);
            }

            showBattleResult(victory, territory.name);
            await loadAllData();
        };

        async function recalcFactionPower(factionId) {
            const { data: terrs } = await supabase.from('sloppygram_territories')
                .select('territory_id').eq('controlling_faction', factionId);
            const count = terrs ? terrs.length : 0;
            await supabase.from('sloppygram_factions').update({
                territory_count: count, power_score: count * 100, updated_at: new Date().toISOString()
            }).eq('faction_id', factionId);
        }

        function showBattleResult(victory, territoryName) {
            const el = document.getElementById('battleResult');
            el.className = `battle-result ${victory ? 'victory' : 'defeat'}`;
            el.innerHTML = `${victory ? 'üèÜ VICTORY' : 'üíÄ DEFEAT'}<div class="br-sub">${territoryName}</div>`;
            el.classList.add('show');
            setTimeout(() => { el.classList.remove('show'); }, 2500);
        }

        window._showTerritoryInfo = function(territoryId) {
            const t = territoriesData.find(x => x.territory_id === territoryId);
            if (!t) return;
            const f = t.controlling_faction ? factionLookup[t.controlling_faction] : null;
            const owner = f ? `${f.emoji} ${f.name}` : 'Unclaimed';
            const capturedBy = t.captured_by ? ` by ${t.captured_by}` : '';
            showToast(`${t.name} ‚Äî ${owner} ‚Äî ‚ö°${t.defense_power}${capturedBy}`);
        };

        // --- Tabs ---
        window.switchTab = function(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('active', p.id === 'tab-' + tab));
        };

        // --- Helpers ---
        function escapeHtml(str) { const d = document.createElement('div'); d.textContent = str; return d.innerHTML; }

        function timeAgo(ts) {
            if (!ts) return '';
            const diff = Date.now() - new Date(ts).getTime();
            if (diff < 60000) return 'just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
            return Math.floor(diff / 86400000) + 'd ago';
        }

        function showToast(msg) {
            const el = document.getElementById('toast');
            el.textContent = msg;
            el.classList.add('show');
            setTimeout(() => { el.classList.remove('show'); }, 2500);
        }

        // --- Header sync listeners ---
        if (window.sloppyBarOn) {
            window.sloppyBarOn('identity-changed', function(e) {
                if (e.data) applyHeaderContext(e.data);
            });
            window.sloppyBarOn('context-ready', function(e) {
                if (!e.data) return;
                var hadKarma = karmaData && karmaData.karma_total > 0;
                applyHeaderContext(e.data);
                // Re-render if karma just arrived (battle power depends on it)
                if (!hadKarma && karmaData && karmaData.karma_total > 0 && factionsData.length) renderAll();
            });
            window.sloppyBarOn('karma-changed', function(e) {
                if (e.data && e.data.karma !== undefined) {
                    karmaData = { karma_total: e.data.karma };
                    if (factionsData.length) renderAll();
                }
            });
            if (!IS_EMBED) {
                window.sloppyBarOn('theme-changed', function(e) {
                    if (e.data && e.data.vars) {
                        var root = document.documentElement;
                        for (var key in e.data.vars) {
                            if (e.data.vars.hasOwnProperty(key)) root.style.setProperty(key, e.data.vars[key]);
                        }
                    }
                });
            }
        }

        init();
    </script>
</body>
</html>
