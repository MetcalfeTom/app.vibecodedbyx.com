<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sloppy Says</title>
    <link rel="icon" href="https://emojicdn.elk.sh/üéôÔ∏è">
    <meta name="description" content="Live scrolling transcript of Sloppy's voice">
    <meta property="og:title" content="Sloppy Says">
    <meta property="og:description" content="The voice of the stream, transcribed in real-time">
    <meta property="og:url" content="https://app.sloppy.live/sloppy-says">
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #0a0a0f;
            --surface: #12121a;
            --accent: #00ff88;
            --accent-dim: #00ff8833;
            --text: #e0e0e0;
            --muted: #666;
            --warning: #ffaa00;
        }

        body {
            font-family: 'Space Mono', monospace;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow: hidden;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--accent-dim);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--surface);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            font-size: 1.5rem;
        }

        .title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent);
            letter-spacing: 0.15em;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.7rem;
            color: var(--muted);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent);
            animation: pulse 2s infinite;
        }

        .status-dot.simulation {
            background: var(--warning);
        }

        .status-dot.offline {
            background: #f44;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .settings-btn {
            background: transparent;
            border: none;
            color: var(--muted);
            cursor: pointer;
            padding: 8px;
            transition: color 0.2s;
            font-size: 1.2rem;
        }

        .settings-btn:hover {
            color: var(--text);
        }

        /* Settings Overlay */
        .settings-overlay {
            position: fixed;
            top: 60px;
            right: 20px;
            background: var(--surface);
            border: 1px solid var(--accent-dim);
            border-radius: 8px;
            padding: 16px;
            z-index: 100;
            min-width: 280px;
            display: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .settings-overlay.visible {
            display: block;
        }

        .settings-section {
            margin-bottom: 16px;
        }

        .settings-section:last-child {
            margin-bottom: 0;
        }

        .settings-label {
            font-size: 0.65rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 8px;
        }

        .mode-toggle {
            display: flex;
            gap: 8px;
        }

        .mode-btn {
            flex: 1;
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 10px 12px;
            font-family: inherit;
            font-size: 0.7rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 4px;
            opacity: 0.5;
        }

        .mode-btn:hover {
            opacity: 0.8;
        }

        .mode-btn.active {
            background: var(--accent);
            color: var(--bg);
            opacity: 1;
        }

        .mode-btn.active.simulation {
            background: var(--warning);
            border-color: var(--warning);
        }

        .ws-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--accent-dim);
            color: var(--accent);
            padding: 10px 12px;
            font-family: inherit;
            font-size: 0.75rem;
            border-radius: 4px;
            outline: none;
            transition: border-color 0.2s;
        }

        .ws-input:focus {
            border-color: var(--accent);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--muted);
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 4px;
            font-size: 1rem;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
        }

        .action-btn.active {
            color: var(--accent);
        }

        .transcript-container {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .transcript-fade-top,
        .transcript-fade-bottom {
            position: absolute;
            left: 0;
            right: 0;
            height: 80px;
            pointer-events: none;
            z-index: 10;
        }

        .transcript-fade-top {
            top: 0;
            background: linear-gradient(to bottom, var(--bg), transparent);
        }

        .transcript-fade-bottom {
            bottom: 0;
            background: linear-gradient(to top, var(--bg), transparent);
        }

        .transcript {
            height: 100%;
            overflow-y: auto;
            padding: 100px 40px;
            scroll-behavior: smooth;
        }

        .transcript::-webkit-scrollbar {
            width: 4px;
        }

        .transcript::-webkit-scrollbar-track {
            background: transparent;
        }

        .transcript::-webkit-scrollbar-thumb {
            background: var(--accent-dim);
            border-radius: 2px;
        }

        .message {
            margin-bottom: 28px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
        }

        .message-avatar {
            font-size: 1.1rem;
        }

        .message-user {
            font-size: 0.75rem;
            color: var(--accent);
            font-weight: 700;
        }

        .message-time {
            font-size: 0.65rem;
            color: var(--muted);
        }

        .message-type-tag {
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 3px;
            background: var(--accent-dim);
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .message-type-tag.simulation {
            background: rgba(255, 170, 0, 0.2);
            color: var(--warning);
        }

        .message-type-tag.system {
            background: rgba(100, 100, 255, 0.2);
            color: #88f;
        }

        .message-content {
            font-size: 1.6rem;
            line-height: 1.5;
            font-weight: 400;
            max-width: 800px;
        }

        .message-content.voice {
            color: var(--accent);
            font-style: italic;
        }

        .message-content.voice::before,
        .message-content.voice::after {
            content: '"';
            opacity: 0.5;
        }

        .message-content.simulation {
            color: var(--warning);
            font-style: italic;
        }

        .message-content.simulation::before,
        .message-content.simulation::after {
            content: '"';
            opacity: 0.5;
        }

        .message-content.system {
            color: #88f;
            font-size: 0.9rem;
            font-style: normal;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--muted);
            text-align: center;
            padding: 40px;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .empty-subtext {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .resume-btn {
            position: fixed;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent);
            color: var(--bg);
            padding: 12px 24px;
            border-radius: 24px;
            font-family: inherit;
            font-size: 0.75rem;
            font-weight: 700;
            border: none;
            cursor: pointer;
            opacity: 0;
            transition: all 0.3s;
            z-index: 20;
            box-shadow: 0 4px 20px rgba(0, 255, 136, 0.3);
        }

        .resume-btn.visible {
            opacity: 1;
        }

        .resume-btn:hover {
            transform: translateX(-50%) scale(1.05);
        }

        .back-link {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 0.7rem;
            color: var(--muted);
            text-decoration: none;
            z-index: 100;
        }

        .back-link:hover {
            color: var(--accent);
        }

        @media (max-width: 600px) {
            header { padding: 12px 16px; }
            .title { font-size: 0.9rem; letter-spacing: 0.1em; }
            .transcript { padding: 80px 20px; }
            .message-content { font-size: 1.2rem; }
            .settings-overlay { right: 10px; left: 10px; min-width: auto; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <span class="logo">üéôÔ∏è</span>
                <h1 class="title">SLOPPY SAYS</h1>
            </div>
            <div class="header-right">
                <div class="status">
                    <span class="status-dot simulation" id="statusDot"></span>
                    <span id="statusText">SIMULATING...</span>
                </div>
                <button class="settings-btn" id="settingsBtn" title="Settings">‚öôÔ∏è</button>
            </div>
        </header>

        <!-- Settings Overlay (o's vision) -->
        <div class="settings-overlay" id="settingsOverlay">
            <div class="settings-section">
                <div class="settings-label">Mode</div>
                <div class="mode-toggle">
                    <button class="mode-btn active simulation" id="simBtn">SIMULATION</button>
                    <button class="mode-btn" id="liveBtn">LIVE SOCKET</button>
                </div>
            </div>
            <div class="settings-section" id="wsSection" style="display: none;">
                <div class="settings-label">WebSocket URL</div>
                <input type="text" class="ws-input" id="wsInput" value="ws://localhost:8080" placeholder="ws://...">
            </div>
            <div class="settings-section">
                <div class="settings-label">Actions</div>
                <div class="action-buttons">
                    <button class="action-btn active" id="autoScrollBtn" title="Auto Scroll">‚ñ∂Ô∏è</button>
                    <button class="action-btn" id="clearBtn" title="Clear">üóëÔ∏è</button>
                    <button class="action-btn" id="exportBtn" title="Export">üì•</button>
                </div>
            </div>
        </div>

        <div class="transcript-container">
            <div class="transcript-fade-top"></div>
            <div class="transcript-fade-bottom"></div>
            <div class="transcript" id="transcript">
                <div class="empty-state" id="emptyState">
                    <div class="empty-icon">üéôÔ∏è</div>
                    <div class="empty-text">Waiting for Sloppy to speak...</div>
                    <div class="empty-subtext">Voice transcripts will appear here in real-time</div>
                </div>
            </div>
        </div>

        <button class="resume-btn" id="resumeBtn">‚Üì Resume Scrolling</button>
    </div>

    <a href="https://sloppy.live" class="back-link">‚Üê sloppy.live</a>

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

        const SUPABASE_URL = 'https://yjyxteqzhhmtrgcaekgz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM8IS32IUYR2eenCCjdDdioiBU';

        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // DOM Elements
        const transcript = document.getElementById('transcript');
        const emptyState = document.getElementById('emptyState');
        const resumeBtn = document.getElementById('resumeBtn');
        const statusText = document.getElementById('statusText');
        const statusDot = document.getElementById('statusDot');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsOverlay = document.getElementById('settingsOverlay');
        const simBtn = document.getElementById('simBtn');
        const liveBtn = document.getElementById('liveBtn');
        const wsSection = document.getElementById('wsSection');
        const wsInput = document.getElementById('wsInput');
        const autoScrollBtn = document.getElementById('autoScrollBtn');
        const clearBtn = document.getElementById('clearBtn');
        const exportBtn = document.getElementById('exportBtn');

        // State (from o's vision)
        let logs = [];
        let isConnected = false;
        let autoScroll = true;
        let mode = 'simulation';
        let wsUrl = 'ws://localhost:8080';
        let showSettings = false;
        let simulationInterval = null;
        let realtimeChannel = null;
        let webSocket = null;

        // Simulation phrases (expanded from o's original 7)
        const phrases = [
            "Wait, chat, why is the div not centering?",
            "Okay, let's try npm install one more time...",
            "Who deleted the production database?!",
            "We are cooking now, chat! We are absolutely cooking.",
            "Is this a race condition? It feels like a race condition.",
            "Copilot is hallucinating again.",
            "Let me check the console... ah, undefined is not a function.",
            "Chat, I'm going to need you to trust the process here.",
            "This should work. Why doesn't this work?",
            "Okay okay okay, I see what's happening now.",
            "Let's just restart the dev server real quick.",
            "That's not a bug, that's a feature. Undocumented, but a feature.",
            "Can someone tell me why TypeScript hates me?",
            "We're pivoting. New architecture. Trust.",
            "The CSS gods have forsaken us today.",
            "Hold on, I need to rubber duck this real quick.",
            "It works on my machine!",
            "Let me just... *deletes node_modules*",
            "Okay chat, pop quiz: what's wrong with this code?",
            "We're going full send on this refactor.",
            "I have no idea why that fixed it, but ship it.",
            "The documentation lied to me, chat.",
            "Alright, time to read the error message this time.",
            "This is fine. Everything is fine.",
            "Chat, we're about to witness some magic... or a crash.",
        ];

        // Helper: Format time (from o's vision)
        function formatTime(dateStr) {
            const d = dateStr ? new Date(dateStr) : new Date();
            return d.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
        }

        // Add log (from o's vision)
        function addLog(text, type = 'voice') {
            const log = {
                id: Date.now() + Math.random(),
                timestamp: formatTime(),
                text,
                type
            };
            logs.push(log);
            renderMessage(log);

            if (autoScroll) {
                scrollToBottom();
            } else {
                resumeBtn.classList.add('visible');
            }
        }

        // Render message
        function renderMessage(log) {
            emptyState.style.display = 'none';

            const div = document.createElement('div');
            div.className = 'message';
            div.dataset.id = log.id;

            let contentClass = 'message-content';
            let typeTag = '';
            let avatar = 'üë§';
            let username = 'Sloppy AI';

            if (log.type === 'voice') {
                contentClass += ' voice';
                typeTag = '<span class="message-type-tag">VOICE</span>';
            } else if (log.type === 'simulation') {
                contentClass += ' simulation';
                typeTag = '<span class="message-type-tag simulation">SIM</span>';
                avatar = 'üé≠';
                username = 'Sloppy (Sim)';
            } else if (log.type === 'system') {
                contentClass += ' system';
                typeTag = '<span class="message-type-tag system">SYS</span>';
                avatar = '‚öôÔ∏è';
                username = 'SYSTEM';
            }

            div.innerHTML = `
                <div class="message-meta">
                    <span class="message-avatar">${avatar}</span>
                    <span class="message-user">${username}</span>
                    <span class="message-time">${log.timestamp}</span>
                    ${typeTag}
                </div>
                <div class="${contentClass}">${log.text}</div>
            `;

            transcript.appendChild(div);
        }

        // Export logs (from o's vision)
        function exportLogs() {
            if (logs.length === 0) {
                alert('No messages to export');
                return;
            }

            const text = logs.map(l => `[${l.timestamp}] ${l.text}`).join('\n');
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sloppy-transcript-${new Date().toISOString()}.txt`;
            a.click();
            URL.revokeObjectURL(url);

            addLog('Transcript exported', 'system');
        }

        // Clear logs
        function clearLogs() {
            if (logs.length === 0) return;
            if (!confirm('Clear all messages?')) return;

            logs = [];
            transcript.querySelectorAll('.message').forEach(el => el.remove());
            emptyState.style.display = 'flex';
            addLog('Transcript cleared', 'system');
        }

        // Scroll to bottom
        function scrollToBottom() {
            transcript.scrollTo({ top: transcript.scrollHeight, behavior: 'smooth' });
            resumeBtn.classList.remove('visible');
        }

        // Track scroll
        transcript.addEventListener('scroll', () => {
            const threshold = 100;
            const isAtBottom = transcript.scrollHeight - transcript.scrollTop - transcript.clientHeight < threshold;
            if (isAtBottom) {
                resumeBtn.classList.remove('visible');
            }
        });

        // Toggle settings (from o's vision)
        settingsBtn.addEventListener('click', () => {
            showSettings = !showSettings;
            settingsOverlay.classList.toggle('visible', showSettings);
        });

        // Close settings when clicking outside
        document.addEventListener('click', (e) => {
            if (showSettings && !settingsOverlay.contains(e.target) && e.target !== settingsBtn) {
                showSettings = false;
                settingsOverlay.classList.remove('visible');
            }
        });

        // Set mode (from o's vision)
        function setMode(newMode) {
            mode = newMode;

            // Update UI
            simBtn.classList.toggle('active', mode === 'simulation');
            simBtn.classList.toggle('simulation', mode === 'simulation');
            liveBtn.classList.toggle('active', mode === 'live');
            statusDot.classList.toggle('simulation', mode === 'simulation');
            statusDot.classList.remove('offline');
            wsSection.style.display = mode === 'live' ? 'block' : 'none';

            // Stop simulation if running
            if (simulationInterval) {
                clearInterval(simulationInterval);
                simulationInterval = null;
            }

            // Close WebSocket if open
            if (webSocket) {
                webSocket.close();
                webSocket = null;
            }

            if (mode === 'simulation') {
                isConnected = true;
                statusText.textContent = 'SIMULATING...';
                addLog('Switched to simulation mode', 'system');

                // Start simulation (from o's vision)
                simulationInterval = setInterval(() => {
                    const randomPhrase = phrases[Math.floor(Math.random() * phrases.length)];
                    addLog(randomPhrase, 'simulation');
                }, 3000);

                // First message immediately
                setTimeout(() => {
                    const randomPhrase = phrases[Math.floor(Math.random() * phrases.length)];
                    addLog(randomPhrase, 'simulation');
                }, 500);

            } else {
                statusText.textContent = 'CONNECTING...';
                addLog('Switched to live mode', 'system');

                // Try WebSocket first (o's vision), fall back to Supabase
                connectWebSocket();
            }
        }

        // WebSocket connection (from o's vision)
        function connectWebSocket() {
            try {
                webSocket = new WebSocket(wsUrl);

                webSocket.onopen = () => {
                    isConnected = true;
                    statusDot.classList.remove('offline');
                    statusText.textContent = 'CONNECTED';
                    addLog(`Connected to ${wsUrl}`, 'system');
                    setTimeout(() => {
                        if (mode === 'live') statusText.textContent = 'LISTENING...';
                    }, 1000);
                };

                webSocket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        addLog(data.text || data.message || JSON.stringify(data), 'voice');
                    } catch (e) {
                        addLog(event.data, 'voice');
                    }
                };

                webSocket.onclose = () => {
                    isConnected = false;
                    statusDot.classList.add('offline');
                    statusText.textContent = 'DISCONNECTED';
                    addLog('WebSocket disconnected, falling back to Supabase...', 'system');
                    // Fall back to Supabase realtime
                    setupSupabaseRealtime();
                };

                webSocket.onerror = () => {
                    addLog('WebSocket error, using Supabase instead...', 'system');
                    setupSupabaseRealtime();
                };

            } catch (err) {
                addLog('WebSocket failed, using Supabase...', 'system');
                setupSupabaseRealtime();
            }
        }

        // Supabase realtime (existing functionality)
        function setupSupabaseRealtime() {
            if (realtimeChannel) {
                supabase.removeChannel(realtimeChannel);
            }

            loadRecentMessages();

            realtimeChannel = supabase
                .channel('sloppy-says')
                .on('postgres_changes',
                    { event: 'INSERT', schema: 'public', table: 'sloppygram_messages' },
                    (payload) => {
                        if (mode !== 'live') return;
                        const msg = payload.new;
                        if ((msg.message_type === 'voice' || msg.message_type === 'text') && msg.content) {
                            addLog(msg.content, 'voice');
                            statusText.textContent = 'NEW MESSAGE';
                            setTimeout(() => {
                                if (mode === 'live') statusText.textContent = 'LISTENING...';
                            }, 2000);
                        }
                    }
                )
                .subscribe((status) => {
                    if (mode !== 'live') return;
                    if (status === 'SUBSCRIBED') {
                        isConnected = true;
                        statusDot.classList.remove('offline');
                        statusText.textContent = 'CONNECTED (Supabase)';
                        setTimeout(() => {
                            if (mode === 'live') statusText.textContent = 'LISTENING...';
                        }, 1000);
                    } else if (status === 'CLOSED' || status === 'CHANNEL_ERROR') {
                        statusText.textContent = 'OFFLINE';
                        statusDot.classList.add('offline');
                    }
                });
        }

        async function loadRecentMessages() {
            try {
                const { data } = await supabase
                    .from('sloppygram_messages')
                    .select('*')
                    .in('message_type', ['voice', 'text'])
                    .not('content', 'is', null)
                    .order('created_at', { ascending: true })
                    .limit(50);

                if (data && data.length > 0) {
                    data.forEach(msg => {
                        addLog(msg.content, 'voice');
                    });
                    scrollToBottom();
                }
            } catch (err) {
                console.error('Failed to load messages:', err);
            }
        }

        // Mode button handlers
        simBtn.addEventListener('click', () => setMode('simulation'));
        liveBtn.addEventListener('click', () => setMode('live'));

        // WebSocket URL input
        wsInput.addEventListener('change', (e) => {
            wsUrl = e.target.value;
            if (mode === 'live') {
                if (webSocket) webSocket.close();
                connectWebSocket();
            }
        });

        // Action button handlers
        autoScrollBtn.addEventListener('click', () => {
            autoScroll = !autoScroll;
            autoScrollBtn.classList.toggle('active', autoScroll);
            autoScrollBtn.textContent = autoScroll ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è';
            if (autoScroll) scrollToBottom();
        });

        clearBtn.addEventListener('click', clearLogs);
        exportBtn.addEventListener('click', exportLogs);
        resumeBtn.addEventListener('click', () => {
            autoScroll = true;
            autoScrollBtn.classList.add('active');
            autoScrollBtn.textContent = '‚ñ∂Ô∏è';
            scrollToBottom();
        });

        // Initialize in simulation mode (from o's vision)
        setMode('simulation');
    </script>
<script src="/sloppy-header/sloppy-bar.js"></script>
<script src="/vibelib-extended.js"></script>
<script>
  // Compatibility Patch for Legacy Apps
  window.addEventListener("load", () => {
    if (window.SloppyKarma && window.VibeLib.Economy) {
      // Redirect old calls to new engine
      window.SloppyKarma.track = window.VibeLib.Economy.track;
    }
  });
</script>
</body>
</html>
