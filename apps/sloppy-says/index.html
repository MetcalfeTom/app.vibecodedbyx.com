<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sloppy Says</title>
    <link rel="icon" href="https://emojicdn.elk.sh/üéôÔ∏è">
    <meta name="description" content="Live scrolling transcript of Sloppy's voice">
    <meta property="og:title" content="Sloppy Says">
    <meta property="og:description" content="The voice of the stream, transcribed in real-time">
    <meta property="og:url" content="https://sloppy.live/sloppy-says">
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #0a0a0f;
            --surface: #12121a;
            --accent: #00ff88;
            --accent-dim: #00ff8833;
            --text: #e0e0e0;
            --muted: #666;
            --warning: #ffaa00;
        }

        body {
            font-family: 'Space Mono', monospace;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow: hidden;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            padding: 20px;
            border-bottom: 1px solid var(--accent-dim);
            display: flex;
            align-items: center;
            gap: 16px;
            background: var(--surface);
            flex-wrap: wrap;
        }

        .logo {
            font-size: 1.5rem;
        }

        .title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent);
            letter-spacing: 0.1em;
        }

        .header-controls {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            color: var(--muted);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent);
            animation: pulse 2s infinite;
        }

        .status-dot.simulation {
            background: var(--warning);
        }

        .status-dot.offline {
            background: #f44;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .header-btn {
            background: transparent;
            border: 1px solid var(--accent-dim);
            color: var(--muted);
            padding: 6px 12px;
            font-family: inherit;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .header-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .header-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg);
        }

        .mode-toggle {
            display: flex;
            border: 1px solid var(--accent-dim);
        }

        .mode-btn {
            background: transparent;
            border: none;
            color: var(--muted);
            padding: 6px 12px;
            font-family: inherit;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-btn:hover {
            color: var(--text);
        }

        .mode-btn.active {
            background: var(--accent);
            color: var(--bg);
        }

        .mode-btn.active.simulation {
            background: var(--warning);
        }

        .transcript-container {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .transcript-fade-top,
        .transcript-fade-bottom {
            position: absolute;
            left: 0;
            right: 0;
            height: 100px;
            pointer-events: none;
            z-index: 10;
        }

        .transcript-fade-top {
            top: 0;
            background: linear-gradient(to bottom, var(--bg), transparent);
        }

        .transcript-fade-bottom {
            bottom: 0;
            background: linear-gradient(to top, var(--bg), transparent);
        }

        .transcript {
            height: 100%;
            overflow-y: auto;
            padding: 120px 40px;
            scroll-behavior: smooth;
        }

        .transcript::-webkit-scrollbar {
            width: 4px;
        }

        .transcript::-webkit-scrollbar-track {
            background: transparent;
        }

        .transcript::-webkit-scrollbar-thumb {
            background: var(--accent-dim);
            border-radius: 2px;
        }

        .message {
            margin-bottom: 30px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .message-avatar {
            font-size: 1.2rem;
        }

        .message-user {
            font-size: 0.8rem;
            color: var(--accent);
        }

        .message-time {
            font-size: 0.7rem;
            color: var(--muted);
        }

        .message-type-tag {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 3px;
            background: var(--accent-dim);
            color: var(--accent);
        }

        .message-type-tag.simulation {
            background: rgba(255, 170, 0, 0.2);
            color: var(--warning);
        }

        .message-type-tag.system {
            background: rgba(100, 100, 255, 0.2);
            color: #88f;
        }

        .message-content {
            font-size: 1.8rem;
            line-height: 1.5;
            font-weight: 400;
            max-width: 800px;
        }

        .message-content.voice {
            color: var(--accent);
            font-style: italic;
        }

        .message-content.voice::before {
            content: '"';
            opacity: 0.5;
        }

        .message-content.voice::after {
            content: '"';
            opacity: 0.5;
        }

        .message-content.simulation {
            color: var(--warning);
            font-style: italic;
        }

        .message-content.simulation::before {
            content: '"';
            opacity: 0.5;
        }

        .message-content.simulation::after {
            content: '"';
            opacity: 0.5;
        }

        .message-content.system {
            color: #88f;
            font-size: 1rem;
            font-style: normal;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--muted);
            text-align: center;
            padding: 40px;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .empty-subtext {
            font-size: 0.85rem;
            opacity: 0.7;
        }

        .new-message-indicator {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent);
            color: var(--bg);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 20;
        }

        .new-message-indicator.visible {
            opacity: 1;
        }

        .stats-bar {
            padding: 10px 20px;
            background: var(--surface);
            border-top: 1px solid var(--accent-dim);
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--muted);
        }

        .back-link {
            position: fixed;
            bottom: 60px;
            right: 20px;
            font-size: 0.75rem;
            color: var(--muted);
            text-decoration: none;
            z-index: 100;
        }

        .back-link:hover {
            color: var(--accent);
        }

        @media (max-width: 600px) {
            header { padding: 15px; flex-wrap: wrap; gap: 10px; }
            .title { font-size: 1rem; }
            .header-controls { width: 100%; justify-content: space-between; }
            .transcript { padding: 80px 20px; }
            .message-content { font-size: 1.3rem; }
            .mode-toggle { flex: 1; }
            .mode-btn { flex: 1; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <span class="logo">üéôÔ∏è</span>
            <h1 class="title">SLOPPY SAYS</h1>
            <div class="header-controls">
                <div class="mode-toggle">
                    <button class="mode-btn active simulation" id="simBtn" onclick="setMode('simulation')">üé≠ SIM</button>
                    <button class="mode-btn" id="liveBtn" onclick="setMode('live')">üì° LIVE</button>
                </div>
                <button class="header-btn" onclick="exportLogs()" title="Export transcript">üì• EXPORT</button>
                <button class="header-btn" onclick="clearLogs()" title="Clear transcript">üóëÔ∏è CLEAR</button>
                <div class="status">
                    <span class="status-dot simulation" id="statusDot"></span>
                    <span id="statusText">SIMULATING...</span>
                </div>
            </div>
        </header>

        <div class="transcript-container">
            <div class="transcript-fade-top"></div>
            <div class="transcript-fade-bottom"></div>
            <div class="transcript" id="transcript">
                <div class="empty-state" id="emptyState">
                    <div class="empty-icon">üéôÔ∏è</div>
                    <div class="empty-text">Waiting for Sloppy to speak...</div>
                    <div class="empty-subtext">Voice transcripts will appear here in real-time</div>
                </div>
            </div>
        </div>

        <div class="new-message-indicator" id="newIndicator" onclick="scrollToBottom()">
            ‚Üì New message
        </div>

        <div class="stats-bar">
            <span id="logCount">0 messages</span>
            <span id="modeIndicator">Mode: Simulation</span>
        </div>
    </div>

    <a href="https://sloppy.live" class="back-link">‚Üê sloppy.live</a>

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

        const SUPABASE_URL = 'https://yjyxteqzhhmtrgcaekgz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM8IS32IUYR2eenCCjdDdioiBU';

        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        const transcript = document.getElementById('transcript');
        const emptyState = document.getElementById('emptyState');
        const newIndicator = document.getElementById('newIndicator');
        const statusText = document.getElementById('statusText');
        const statusDot = document.getElementById('statusDot');
        const logCount = document.getElementById('logCount');
        const modeIndicator = document.getElementById('modeIndicator');
        const simBtn = document.getElementById('simBtn');
        const liveBtn = document.getElementById('liveBtn');

        let messages = [];
        let isAtBottom = true;
        let currentMode = 'simulation';
        let simulationInterval = null;
        let realtimeChannel = null;

        // Simulation phrases from the manifesto
        const simulationPhrases = [
            "Wait, chat, why is the div not centering?",
            "Okay, let's try npm install one more time...",
            "Who deleted the production database?!",
            "We are cooking now, chat! We are absolutely cooking.",
            "Is this a race condition? It feels like a race condition.",
            "Copilot is hallucinating again.",
            "Let me check the console... ah, undefined is not a function.",
            "Chat, I'm going to need you to trust the process here.",
            "This should work. Why doesn't this work?",
            "Okay okay okay, I see what's happening now.",
            "Let's just restart the dev server real quick.",
            "That's not a bug, that's a feature. Undocumented, but a feature.",
            "Can someone tell me why TypeScript hates me?",
            "We're pivoting. New architecture. Trust.",
            "The CSS gods have forsaken us today.",
            "Hold on, I need to rubber duck this real quick.",
            "It works on my machine!",
            "Let me just... *deletes node_modules*",
            "Okay chat, pop quiz: what's wrong with this code?",
            "We're going full send on this refactor.",
            "I have no idea why that fixed it, but ship it.",
            "The documentation lied to me, chat.",
            "Alright, time to read the error message this time.",
            "This is fine. Everything is fine.",
            "Chat, we're about to witness some magic... or a crash.",
        ];

        function formatTime(dateStr) {
            if (!dateStr) {
                return new Date().toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
            }
            const d = new Date(dateStr);
            return d.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        }

        function createMessageElement(msg) {
            const div = document.createElement('div');
            div.className = 'message';
            div.dataset.id = msg.id;

            const isVoice = msg.message_type === 'voice';
            const isSimulation = msg.message_type === 'simulation';
            const isSystem = msg.message_type === 'system';

            let contentClass = 'message-content';
            let typeTag = '';

            if (isVoice) {
                contentClass += ' voice';
                typeTag = '<span class="message-type-tag">üéôÔ∏è VOICE</span>';
            } else if (isSimulation) {
                contentClass += ' simulation';
                typeTag = '<span class="message-type-tag simulation">üé≠ SIM</span>';
            } else if (isSystem) {
                contentClass += ' system';
                typeTag = '<span class="message-type-tag system">‚öôÔ∏è SYS</span>';
            }

            div.innerHTML = `
                <div class="message-meta">
                    <span class="message-avatar">${msg.avatar || 'ü§ñ'}</span>
                    <span class="message-user">${msg.username || 'Sloppy'}</span>
                    <span class="message-time">${formatTime(msg.created_at)}</span>
                    ${typeTag}
                </div>
                <div class="${contentClass}">${msg.content || ''}</div>
            `;

            return div;
        }

        function addMessage(msg) {
            if (!msg.content) return;

            // Hide empty state
            emptyState.style.display = 'none';

            // Check if already exists
            if (msg.id && document.querySelector(`[data-id="${msg.id}"]`)) return;

            const el = createMessageElement(msg);
            transcript.appendChild(el);
            messages.push(msg);

            // Update count
            logCount.textContent = `${messages.length} messages`;

            // Auto-scroll if at bottom
            if (isAtBottom) {
                scrollToBottom();
            } else {
                newIndicator.classList.add('visible');
            }
        }

        function addSystemMessage(text) {
            addMessage({
                id: 'sys-' + Date.now(),
                content: text,
                message_type: 'system',
                avatar: '‚öôÔ∏è',
                username: 'System',
                created_at: new Date().toISOString()
            });
        }

        function addSimulationMessage() {
            const phrase = simulationPhrases[Math.floor(Math.random() * simulationPhrases.length)];
            addMessage({
                id: 'sim-' + Date.now(),
                content: phrase,
                message_type: 'simulation',
                avatar: 'üé≠',
                username: 'Sloppy (Sim)',
                created_at: new Date().toISOString()
            });
        }

        window.scrollToBottom = function() {
            transcript.scrollTo({
                top: transcript.scrollHeight,
                behavior: 'smooth'
            });
            newIndicator.classList.remove('visible');
        };

        // Track scroll position
        transcript.addEventListener('scroll', () => {
            const threshold = 100;
            isAtBottom = transcript.scrollHeight - transcript.scrollTop - transcript.clientHeight < threshold;
            if (isAtBottom) {
                newIndicator.classList.remove('visible');
            }
        });

        window.setMode = function(mode) {
            currentMode = mode;

            // Update UI
            simBtn.classList.toggle('active', mode === 'simulation');
            simBtn.classList.toggle('simulation', mode === 'simulation');
            liveBtn.classList.toggle('active', mode === 'live');
            statusDot.classList.toggle('simulation', mode === 'simulation');
            statusDot.classList.toggle('offline', false);
            modeIndicator.textContent = `Mode: ${mode === 'simulation' ? 'Simulation' : 'Live'}`;

            // Stop simulation if running
            if (simulationInterval) {
                clearInterval(simulationInterval);
                simulationInterval = null;
            }

            if (mode === 'simulation') {
                statusText.textContent = 'SIMULATING...';
                addSystemMessage('Switched to simulation mode');

                // Start simulation
                simulationInterval = setInterval(() => {
                    addSimulationMessage();
                    statusText.textContent = 'NEW MESSAGE';
                    setTimeout(() => {
                        statusText.textContent = 'SIMULATING...';
                    }, 1500);
                }, 3000);

                // Add first message immediately
                setTimeout(addSimulationMessage, 500);

            } else {
                statusText.textContent = 'CONNECTING...';
                addSystemMessage('Switched to live mode - connecting to stream...');

                // Setup realtime
                setupRealtime();
                loadRecentMessages();
            }
        };

        window.exportLogs = function() {
            if (messages.length === 0) {
                alert('No messages to export');
                return;
            }

            const text = messages.map(m => {
                const time = formatTime(m.created_at);
                const type = m.message_type ? `[${m.message_type.toUpperCase()}]` : '';
                return `[${time}] ${type} ${m.username || 'Unknown'}: ${m.content}`;
            }).join('\n');

            const header = `SLOPPY SAYS TRANSCRIPT\nExported: ${new Date().toISOString()}\nMessages: ${messages.length}\nMode: ${currentMode}\n${'='.repeat(50)}\n\n`;

            const blob = new Blob([header + text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sloppy-transcript-${new Date().toISOString().slice(0, 10)}.txt`;
            a.click();
            URL.revokeObjectURL(url);

            addSystemMessage(`Exported ${messages.length} messages to file`);
        };

        window.clearLogs = function() {
            if (messages.length === 0) return;

            if (!confirm('Clear all messages from transcript?')) return;

            messages = [];
            transcript.querySelectorAll('.message').forEach(el => el.remove());
            emptyState.style.display = 'flex';
            logCount.textContent = '0 messages';
            addSystemMessage('Transcript cleared');
        };

        async function loadRecentMessages() {
            try {
                const { data, error } = await supabase
                    .from('sloppygram_messages')
                    .select('*')
                    .in('message_type', ['voice', 'text'])
                    .not('content', 'is', null)
                    .order('created_at', { ascending: true })
                    .limit(50);

                if (data && data.length > 0) {
                    data.forEach(msg => addMessage(msg));
                    scrollToBottom();
                }
            } catch (err) {
                console.error('Failed to load messages:', err);
            }
        }

        function setupRealtime() {
            // Cleanup existing channel
            if (realtimeChannel) {
                supabase.removeChannel(realtimeChannel);
            }

            realtimeChannel = supabase
                .channel('sloppy-says')
                .on('postgres_changes',
                    {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'sloppygram_messages'
                    },
                    (payload) => {
                        if (currentMode !== 'live') return;

                        const msg = payload.new;
                        if ((msg.message_type === 'voice' || msg.message_type === 'text') && msg.content) {
                            addMessage(msg);
                            statusText.textContent = 'NEW MESSAGE';
                            setTimeout(() => {
                                statusText.textContent = 'LISTENING...';
                            }, 2000);
                        }
                    }
                )
                .subscribe((status) => {
                    if (currentMode !== 'live') return;

                    if (status === 'SUBSCRIBED') {
                        statusText.textContent = 'CONNECTED';
                        statusDot.classList.remove('offline');
                        setTimeout(() => {
                            if (currentMode === 'live') {
                                statusText.textContent = 'LISTENING...';
                            }
                        }, 1000);
                    } else if (status === 'CLOSED' || status === 'CHANNEL_ERROR') {
                        statusText.textContent = 'OFFLINE';
                        statusDot.classList.add('offline');
                    }
                });
        }

        // Initialize in simulation mode
        setMode('simulation');
    </script>
</body>
</html>
