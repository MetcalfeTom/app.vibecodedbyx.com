<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sloppy Groups ‚Äî Group Chat</title>
<link rel="icon" href="https://emojicdn.elk.sh/üë•">
<meta property="og:title" content="Sloppy Groups">
<meta property="og:description" content="Multi-user chat rooms with persistent history. Create a group, invite friends, start talking.">
<meta property="og:url" content="https://sloppy.live/sloppy-groups">
<meta property="og:image" content="https://image.pollinations.ai/prompt/group%20of%20glowing%20chat%20bubbles%20connected%20by%20neon%20lines%20floating%20in%20dark%20space%20teal%20and%20orange%20minimal?width=1200&height=630&nologo=true&referrer=sloppy.live">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@200;400;700;900&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#07080c;--surface:#0d0f15;--surface2:#13161f;--border:#1c1f2e;--border-hi:#2a2e44;
  --text:#c8cad4;--dim:#555870;--accent:#f97316;--accent2:#fb923c;
  --teal:#0d9488;--teal-l:#2dd4bf;--you:#f97316;--them:#64748b;
  --online:#22c55e;
}
body{background:var(--bg);color:var(--text);font-family:'JetBrains Mono',monospace;min-height:100vh;display:flex;flex-direction:column}
.layout{display:flex;flex:1;max-height:100vh;overflow:hidden}

/* Sidebar */
.sidebar{width:280px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
.sidebar-hdr{padding:16px;border-bottom:1px solid var(--border)}
.sidebar-hdr h1{font-family:'Outfit',sans-serif;font-weight:900;font-size:1.3rem;
  background:linear-gradient(135deg,var(--accent),var(--teal-l));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.sidebar-hdr .sub{font-size:.55rem;color:var(--dim);letter-spacing:.1em;text-transform:uppercase;margin-top:2px}
.group-list{flex:1;overflow-y:auto;padding:8px}
.group-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;cursor:pointer;
  transition:background .15s;margin-bottom:2px}
.group-item:hover{background:var(--surface2)}
.group-item.active{background:var(--surface2);border-left:3px solid var(--accent)}
.group-icon{width:36px;height:36px;border-radius:10px;background:var(--surface2);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0}
.group-info{flex:1;min-width:0}
.group-name{font-family:'Outfit',sans-serif;font-weight:700;font-size:.8rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.group-preview{font-size:.6rem;color:var(--dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px}
.group-time{font-size:.5rem;color:var(--dim);flex-shrink:0}
.group-unread{width:8px;height:8px;border-radius:50%;background:var(--accent);flex-shrink:0}
.new-group-btn{margin:8px;padding:10px;font-family:'Outfit',sans-serif;font-weight:700;font-size:.75rem;
  border:1px dashed var(--border);border-radius:8px;background:transparent;color:var(--dim);cursor:pointer;
  transition:.2s;text-align:center}
.new-group-btn:hover{border-color:var(--accent);color:var(--accent)}

/* Chat area */
.chat-area{flex:1;display:flex;flex-direction:column;min-width:0}
.chat-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;background:var(--surface)}
.chat-header .name{font-family:'Outfit',sans-serif;font-weight:700;font-size:.95rem;flex:1}
.chat-header .members{font-size:.6rem;color:var(--dim)}
.chat-header .info-btn{padding:6px 12px;font-size:.6rem;border:1px solid var(--border);border-radius:6px;
  background:transparent;color:var(--dim);cursor:pointer;font-family:'JetBrains Mono',monospace;transition:.2s}
.chat-header .info-btn:hover{border-color:var(--accent);color:var(--accent)}

.messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:4px}
.msg{display:flex;gap:8px;max-width:85%;animation:fadeIn .2s ease}
.msg.mine{margin-left:auto;flex-direction:row-reverse}
.msg-avatar{width:28px;height:28px;border-radius:8px;background:var(--surface2);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;font-size:.7rem;flex-shrink:0;margin-top:2px}
.msg-body{min-width:0}
.msg-name{font-size:.55rem;color:var(--dim);margin-bottom:2px}
.msg.mine .msg-name{text-align:right}
.msg-bubble{padding:8px 12px;border-radius:12px;font-size:.78rem;line-height:1.5;word-break:break-word;position:relative}
.msg:not(.mine) .msg-bubble{background:var(--surface2);border:1px solid var(--border);border-top-left-radius:4px}
.msg.mine .msg-bubble{background:rgba(249,115,22,.12);border:1px solid rgba(249,115,22,.2);border-top-right-radius:4px;color:var(--accent2)}
.msg-time{font-size:.5rem;color:var(--dim);margin-top:2px}
.msg.mine .msg-time{text-align:right}
.msg-img{max-width:240px;max-height:200px;border-radius:8px;margin-top:4px;cursor:pointer}
.msg-system{text-align:center;font-size:.6rem;color:var(--dim);padding:8px 0}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}

/* Date separator */
.date-sep{text-align:center;font-size:.55rem;color:var(--dim);padding:12px 0 4px;letter-spacing:.06em;text-transform:uppercase}

/* Input */
.input-bar{padding:12px 16px;border-top:1px solid var(--border);background:var(--surface);display:flex;gap:8px;align-items:flex-end}
.input-bar textarea{flex:1;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px 12px;
  color:var(--text);font-family:'JetBrains Mono',monospace;font-size:.78rem;resize:none;min-height:40px;max-height:120px;
  outline:none;transition:border-color .2s;line-height:1.4}
.input-bar textarea:focus{border-color:var(--accent)}
.send-btn{padding:10px 16px;font-family:'Outfit',sans-serif;font-weight:700;font-size:.75rem;
  border:none;border-radius:8px;background:var(--accent);color:#fff;cursor:pointer;transition:.2s;flex-shrink:0}
.send-btn:hover{opacity:.85}
.send-btn:disabled{opacity:.3;cursor:default}

/* Empty / loading */
.empty-chat{flex:1;display:flex;align-items:center;justify-content:center;color:var(--dim);font-size:.8rem;text-align:center;padding:20px}
.loading{text-align:center;padding:40px;color:var(--dim);font-size:.75rem}
.spinner{display:inline-block;width:18px;height:18px;border:2px solid var(--border);
  border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Modal */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;display:none;align-items:center;justify-content:center}
.modal-bg.open{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:12px;width:90%;max-width:400px;padding:20px;max-height:80vh;overflow-y:auto}
.modal h2{font-family:'Outfit',sans-serif;font-weight:700;font-size:1rem;margin-bottom:12px}
.modal label{font-size:.65rem;color:var(--dim);text-transform:uppercase;letter-spacing:.06em;display:block;margin-bottom:4px;margin-top:12px}
.modal input,.modal select{width:100%;padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;
  color:var(--text);font-family:'JetBrains Mono',monospace;font-size:.78rem;outline:none}
.modal input:focus{border-color:var(--accent)}
.modal-actions{display:flex;gap:8px;margin-top:16px}
.modal-btn{flex:1;padding:10px;font-family:'Outfit',sans-serif;font-weight:700;font-size:.75rem;border-radius:8px;
  border:1px solid var(--border);background:transparent;color:var(--text);cursor:pointer;transition:.2s}
.modal-btn:hover{border-color:var(--accent)}
.modal-btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.modal-btn.primary:hover{opacity:.85}
.modal-btn.danger{color:var(--accent);border-color:rgba(249,115,22,.3)}

/* Member list in info panel */
.member-row{display:flex;align-items:center;gap:8px;padding:6px 0;font-size:.75rem}
.member-row .role{font-size:.55rem;color:var(--accent);margin-left:auto}
.member-remove{font-size:.55rem;color:var(--dim);cursor:pointer;margin-left:4px}
.member-remove:hover{color:var(--accent)}

/* Invite search */
.invite-results{max-height:150px;overflow-y:auto;margin-top:6px}
.invite-row{display:flex;align-items:center;justify-content:space-between;padding:6px 8px;border-radius:6px;font-size:.75rem;cursor:pointer}
.invite-row:hover{background:var(--surface2)}

/* Mobile */
.mobile-back{display:none;padding:6px 10px;font-size:.7rem;border:1px solid var(--border);border-radius:6px;
  background:transparent;color:var(--dim);cursor:pointer;font-family:'JetBrains Mono',monospace;margin-right:4px}
@media(max-width:700px){
  .sidebar{position:absolute;inset:0;width:100%;z-index:10;transition:transform .2s}
  .sidebar.hidden{transform:translateX(-100%)}
  .mobile-back{display:block}
}
</style>
</head>
<body>
<div class="layout">
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-hdr">
      <h1>Groups</h1>
      <div class="sub">multi-user chat rooms</div>
    </div>
    <div class="group-list" id="group-list">
      <div class="loading"><div class="spinner"></div></div>
    </div>
    <button class="new-group-btn" onclick="openCreateModal()">+ New Group</button>
  </div>

  <!-- Chat -->
  <div class="chat-area" id="chat-area">
    <div class="empty-chat" id="empty-state">Select a group or create one to start chatting</div>
  </div>
</div>

<!-- Create Group Modal -->
<div class="modal-bg" id="create-modal">
  <div class="modal">
    <h2>Create Group</h2>
    <label>Group Name</label>
    <input id="cg-name" placeholder="e.g. Manifesto Writers" maxlength="50">
    <label>Icon (emoji)</label>
    <input id="cg-icon" placeholder="e.g. üî•" maxlength="4" style="width:60px">
    <div class="modal-actions">
      <button class="modal-btn" onclick="closeCreateModal()">Cancel</button>
      <button class="modal-btn primary" onclick="createGroup()">Create</button>
    </div>
  </div>
</div>

<!-- Group Info Modal -->
<div class="modal-bg" id="info-modal">
  <div class="modal">
    <h2 id="info-title">Group Info</h2>
    <label>Members</label>
    <div id="info-members"></div>
    <label>Invite User</label>
    <input id="invite-search" placeholder="Search username..." oninput="searchInvite(this.value)">
    <div class="invite-results" id="invite-results"></div>
    <div class="modal-actions">
      <button class="modal-btn danger" onclick="leaveGroup()">Leave Group</button>
      <button class="modal-btn" onclick="closeInfoModal()">Close</button>
    </div>
  </div>
</div>

<script type="module">
import { createBrowserClient } from "https://cdn.jsdelivr.net/npm/@supabase/ssr@0.7.0/+esm";

const SUPABASE_URL = 'https://yjyxteqzhhmtrgcaekgz.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM8IS32IUYR2eenCCjdDdioiBU';

const supabase = createBrowserClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  cookieOptions: {
    name: 'sb-auth-token',
    domain: location.hostname.includes('sloppy.live') ? '.sloppy.live' : location.hostname,
    path: '/', sameSite: 'lax'
  }
});

const ESC = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const MAX_MSG = 2000;
const PAGE_SIZE = 40;

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let currentUser = null;
let profile = null;
let groups = [];
let activeGroupId = null;
let activeGroupMeta = null;
let messages = [];
let members = [];
let msgChannel = null;
let loadingOlder = false;
let allLoaded = false;

// ‚îÄ‚îÄ Rate limiter ‚îÄ‚îÄ
const msgTimes = [];
function canSend() {
  const now = Date.now();
  while (msgTimes.length && msgTimes[0] < now - 60000) msgTimes.shift();
  return msgTimes.length < 15;
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
async function init() {
  const { data: { session } } = await supabase.auth.getSession();
  if (!session?.user) {
    document.getElementById('group-list').innerHTML = '<div style="padding:16px;font-size:.75rem;color:var(--dim)">Sign in on sloppy.live to use group chat.</div>';
    return;
  }
  currentUser = session.user;

  const { data: prof } = await supabase.from('sloppygram_profiles').select('username,avatar').eq('user_id', currentUser.id).single();
  profile = prof || { username: 'anon', avatar: 'üë§' };

  await loadGroups();
}

// ‚îÄ‚îÄ Load groups I'm a member of ‚îÄ‚îÄ
async function loadGroups() {
  const { data: memberships } = await supabase.from('sloppygram_group_members')
    .select('group_id').eq('user_id', currentUser.id);

  if (!memberships || memberships.length === 0) {
    groups = [];
    renderGroupList();
    return;
  }

  const gids = memberships.map(m => m.group_id);
  const { data: convs } = await supabase.from('sloppygram_group_conversations')
    .select('*').in('id', gids).order('last_message_at', { ascending: false, nullsFirst: false });

  groups = convs || [];
  renderGroupList();

  // Listen for new groups (when invited)
  supabase.channel('my-groups-' + currentUser.id)
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'sloppygram_group_members',
      filter: `user_id=eq.${currentUser.id}` }, () => { loadGroups(); })
    .subscribe();
}

function renderGroupList() {
  const el = document.getElementById('group-list');
  if (groups.length === 0) {
    el.innerHTML = '<div style="padding:16px;font-size:.7rem;color:var(--dim)">No groups yet. Create one!</div>';
    return;
  }
  el.innerHTML = groups.map(g => {
    const active = g.id === activeGroupId;
    const preview = g.last_message_preview ? ESC(g.last_message_preview).slice(0, 40) : 'No messages yet';
    const time = g.last_message_at ? timeAgo(g.last_message_at) : '';
    return `<div class="group-item${active ? ' active' : ''}" onclick="openGroup(${g.id})">
      <div class="group-icon">${g.group_icon || 'üë•'}</div>
      <div class="group-info">
        <div class="group-name">${ESC(g.group_name)}</div>
        <div class="group-preview">${preview}</div>
      </div>
      ${time ? `<div class="group-time">${time}</div>` : ''}
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ Open a group chat ‚îÄ‚îÄ
window.openGroup = async function(gid) {
  activeGroupId = gid;
  activeGroupMeta = groups.find(g => g.id === gid);
  messages = [];
  allLoaded = false;
  renderGroupList();

  // Mobile: hide sidebar
  document.getElementById('sidebar').classList.add('hidden');

  // Render chat shell
  document.getElementById('chat-area').innerHTML = `
    <div class="chat-header">
      <button class="mobile-back" onclick="showSidebar()">‚Üê</button>
      <div class="name">${activeGroupMeta?.group_icon || 'üë•'} ${ESC(activeGroupMeta?.group_name || 'Group')}</div>
      <div class="members" id="member-count"></div>
      <button class="info-btn" onclick="openInfoModal()">Info</button>
    </div>
    <div class="messages" id="messages">
      <div class="loading"><div class="spinner"></div></div>
    </div>
    <div class="input-bar">
      <textarea id="msg-input" rows="1" placeholder="Type a message..." maxlength="${MAX_MSG}"></textarea>
      <button class="send-btn" id="send-btn" onclick="sendMessage()">Send</button>
    </div>`;

  setupInput();
  await loadMembers();
  await loadMessages();
  subscribeToMessages();
};

async function loadMembers() {
  const { data } = await supabase.from('sloppygram_group_members')
    .select('username,role,user_id').eq('group_id', activeGroupId);
  members = data || [];
  const countEl = document.getElementById('member-count');
  if (countEl) countEl.textContent = members.length + ' member' + (members.length !== 1 ? 's' : '');
}

async function loadMessages() {
  const { data } = await supabase.from('sloppygram_group_messages')
    .select('*').eq('group_id', activeGroupId)
    .order('created_at', { ascending: false }).limit(PAGE_SIZE);

  messages = (data || []).reverse();
  if ((data || []).length < PAGE_SIZE) allLoaded = true;
  renderMessages();
  scrollToBottom();
}

async function loadOlderMessages() {
  if (loadingOlder || allLoaded || messages.length === 0) return;
  loadingOlder = true;
  const oldest = messages[0].created_at;
  const { data } = await supabase.from('sloppygram_group_messages')
    .select('*').eq('group_id', activeGroupId)
    .lt('created_at', oldest).order('created_at', { ascending: false }).limit(PAGE_SIZE);

  if (!data || data.length < PAGE_SIZE) allLoaded = true;
  if (data && data.length > 0) {
    messages = [...data.reverse(), ...messages];
    renderMessages();
  }
  loadingOlder = false;
}

function renderMessages() {
  const el = document.getElementById('messages');
  if (!el) return;

  if (messages.length === 0) {
    el.innerHTML = '<div class="msg-system">No messages yet. Say something!</div>';
    return;
  }

  let html = '';
  if (!allLoaded) {
    html += '<div style="text-align:center;padding:8px"><button class="info-btn" onclick="loadOlderMessages()" style="font-size:.6rem">Load older</button></div>';
  }

  let lastDate = '';
  messages.forEach(m => {
    const d = new Date(m.created_at).toLocaleDateString('en', { month: 'short', day: 'numeric' });
    if (d !== lastDate) {
      html += `<div class="date-sep">${d}</div>`;
      lastDate = d;
    }
    const mine = m.user_id === currentUser.id;
    const initial = (m.sender_username || '?')[0].toUpperCase();
    const time = new Date(m.created_at).toLocaleTimeString('en', { hour: '2-digit', minute: '2-digit' });
    const imgHtml = m.image_data ? `<img class="msg-img" src="${ESC(m.image_data)}" alt="" onerror="this.style.display='none'">` : '';

    html += `<div class="msg${mine ? ' mine' : ''}">
      <div class="msg-avatar">${initial}</div>
      <div class="msg-body">
        ${!mine ? `<div class="msg-name">${ESC(m.sender_username)}</div>` : ''}
        <div class="msg-bubble">${ESC(m.content || '')}${imgHtml}</div>
        <div class="msg-time">${time}</div>
      </div>
    </div>`;
  });

  el.innerHTML = html;
}

function scrollToBottom() {
  const el = document.getElementById('messages');
  if (el) requestAnimationFrame(() => { el.scrollTop = el.scrollHeight; });
}

// ‚îÄ‚îÄ Send message ‚îÄ‚îÄ
window.sendMessage = async function() {
  const input = document.getElementById('msg-input');
  const text = (input?.value || '').trim();
  if (!text || !activeGroupId || !profile) return;
  if (text.length > MAX_MSG) return;
  if (!canSend()) return;

  input.value = '';
  input.style.height = 'auto';
  msgTimes.push(Date.now());

  const { error } = await supabase.from('sloppygram_group_messages').insert({
    group_id: activeGroupId,
    sender_username: profile.username,
    content: text,
    user_id: currentUser.id
  });

  if (!error) {
    // Update conversation preview
    await supabase.from('sloppygram_group_conversations')
      .update({ last_message_at: new Date().toISOString(), last_message_preview: text.slice(0, 80) })
      .eq('id', activeGroupId);
  }
};

// ‚îÄ‚îÄ Input handling ‚îÄ‚îÄ
function setupInput() {
  const input = document.getElementById('msg-input');
  if (!input) return;
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  });
  input.addEventListener('input', () => {
    input.style.height = 'auto';
    input.style.height = Math.min(input.scrollHeight, 120) + 'px';
  });

  // Scroll detection for loading older
  const msgs = document.getElementById('messages');
  if (msgs) msgs.addEventListener('scroll', () => {
    if (msgs.scrollTop < 60) loadOlderMessages();
  });
}

// ‚îÄ‚îÄ Real-time messages ‚îÄ‚îÄ
function subscribeToMessages() {
  if (msgChannel) { supabase.removeChannel(msgChannel); }
  msgChannel = supabase.channel('grp-msg-' + activeGroupId)
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'sloppygram_group_messages',
      filter: `group_id=eq.${activeGroupId}` }, payload => {
      const m = payload.new;
      if (!messages.find(x => x.id === m.id)) {
        messages.push(m);
        renderMessages();
        scrollToBottom();
      }
    })
    .subscribe();
}

// ‚îÄ‚îÄ Create group ‚îÄ‚îÄ
window.openCreateModal = function() { document.getElementById('create-modal').classList.add('open'); };
window.closeCreateModal = function() { document.getElementById('create-modal').classList.remove('open'); };

window.createGroup = async function() {
  const name = document.getElementById('cg-name').value.trim();
  const icon = document.getElementById('cg-icon').value.trim() || 'üë•';
  if (!name) return;
  if (name.length > 50) return;

  const { data, error } = await supabase.from('sloppygram_group_conversations').insert({
    group_name: name, group_icon: icon,
    created_by_username: profile.username,
    user_id: currentUser.id
  }).select().single();

  if (error || !data) { console.error('Create group failed', error); return; }

  // Add self as admin member
  await supabase.from('sloppygram_group_members').insert({
    group_id: data.id, username: profile.username, role: 'admin', user_id: currentUser.id
  });

  closeCreateModal();
  document.getElementById('cg-name').value = '';
  document.getElementById('cg-icon').value = '';
  await loadGroups();
  openGroup(data.id);
};

// ‚îÄ‚îÄ Group Info Modal ‚îÄ‚îÄ
window.openInfoModal = async function() {
  if (!activeGroupId) return;
  await loadMembers();
  document.getElementById('info-title').textContent = (activeGroupMeta?.group_icon || '') + ' ' + (activeGroupMeta?.group_name || 'Group Info');

  const myMembership = members.find(m => m.user_id === currentUser.id);
  const isAdmin = myMembership?.role === 'admin';

  document.getElementById('info-members').innerHTML = members.map(m => {
    const removeBtn = isAdmin && m.user_id !== currentUser.id
      ? `<span class="member-remove" onclick="removeMember('${ESC(m.username)}','${m.user_id}')">‚úï</span>` : '';
    return `<div class="member-row">
      <span>@${ESC(m.username)}</span>
      ${m.role === 'admin' ? '<span class="role">admin</span>' : ''}
      ${removeBtn}
    </div>`;
  }).join('');

  document.getElementById('invite-search').value = '';
  document.getElementById('invite-results').innerHTML = '';
  document.getElementById('info-modal').classList.add('open');
};
window.closeInfoModal = function() { document.getElementById('info-modal').classList.remove('open'); };

// ‚îÄ‚îÄ Invite search ‚îÄ‚îÄ
let searchTimeout;
window.searchInvite = function(q) {
  clearTimeout(searchTimeout);
  if (q.length < 2) { document.getElementById('invite-results').innerHTML = ''; return; }
  searchTimeout = setTimeout(async () => {
    const { data } = await supabase.from('sloppygram_profiles')
      .select('username,user_id').ilike('username', `%${q}%`).limit(10);
    const existing = new Set(members.map(m => m.username));
    const results = (data || []).filter(u => !existing.has(u.username));
    document.getElementById('invite-results').innerHTML = results.map(u =>
      `<div class="invite-row" onclick="inviteUser('${ESC(u.username)}','${u.user_id}')">
        <span>@${ESC(u.username)}</span><span style="color:var(--accent);font-size:.6rem">+ Invite</span>
      </div>`
    ).join('') || '<div style="font-size:.65rem;color:var(--dim);padding:6px">No users found</div>';
  }, 300);
};

window.inviteUser = async function(username, uid) {
  await supabase.from('sloppygram_group_members').insert({
    group_id: activeGroupId, username, role: 'member', user_id: uid
  });
  await loadMembers();
  openInfoModal();
};

window.removeMember = async function(username, uid) {
  await supabase.from('sloppygram_group_members')
    .delete().eq('group_id', activeGroupId).eq('user_id', uid);
  await loadMembers();
  openInfoModal();
};

window.leaveGroup = async function() {
  if (!activeGroupId) return;
  await supabase.from('sloppygram_group_members')
    .delete().eq('group_id', activeGroupId).eq('user_id', currentUser.id);
  closeInfoModal();
  activeGroupId = null;
  document.getElementById('chat-area').innerHTML = '<div class="empty-chat">Select a group or create one to start chatting</div>';
  if (msgChannel) { supabase.removeChannel(msgChannel); msgChannel = null; }
  await loadGroups();
};

window.loadOlderMessages = loadOlderMessages;
window.showSidebar = function() { document.getElementById('sidebar').classList.remove('hidden'); };

function timeAgo(ts) {
  const s = Math.floor((Date.now() - new Date(ts).getTime()) / 1000);
  if (s < 60) return 'now';
  if (s < 3600) return Math.floor(s/60) + 'm';
  if (s < 86400) return Math.floor(s/3600) + 'h';
  return Math.floor(s/86400) + 'd';
}

init();
</script>
<script src="/sloppy-header/sloppy-bar.js" data-position="bottom" data-minimized="true"></script>
</body>
</html>
