<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sloppy Radio - Community Radio</title>
    <link rel="icon" href="https://emojicdn.elk.sh/üìª">
    <meta property="og:title" content="Sloppy Radio">
    <meta property="og:description" content="Synchronized community radio ‚Äî everyone hears the same beat">
    <meta property="og:url" content="https://app.sloppy.live/sloppy-radio">
    <meta property="og:image" content="https://emojicdn.elk.sh/üìª?style=google">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Anybody:wght@100;400;700;900&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{
            --bg:#050508;--surface:#0a0f0a;--surface2:#0f170f;--border:#1a2a1a;
            --text:#c8d8c8;--dim:#4a6a4a;--green:#00ff41;--green2:#22c55e;
            --amber:#fbbf24;--red:#ef4444;
        }
        body{background:var(--bg);color:var(--text);font-family:'JetBrains Mono',monospace;
            min-height:100vh;display:flex;align-items:center;justify-content:center;overflow:hidden}

        /* CRT scanlines */
        body::after{content:'';position:fixed;inset:0;
            background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,255,65,0.015) 2px,rgba(0,255,65,0.015) 4px);
            pointer-events:none;z-index:100}

        .radio{width:100%;max-width:520px;margin:20px;position:relative}

        /* Header */
        .radio-header{text-align:center;margin-bottom:20px}
        .radio-header h1{font-family:'Anybody',sans-serif;font-weight:900;font-size:clamp(1.8rem,5vw,2.8rem);
            color:var(--green);text-shadow:0 0 30px rgba(0,255,65,0.3);letter-spacing:-1px}
        .radio-header .freq{font-size:0.6rem;color:var(--dim);letter-spacing:3px;margin-top:2px}

        /* Now playing */
        .now-playing{background:var(--surface);border:1px solid var(--border);border-radius:12px;
            padding:20px;margin-bottom:16px;position:relative;overflow:hidden}
        .now-playing::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;
            background:linear-gradient(90deg,transparent,var(--green),transparent);animation:scan 3s linear infinite}

        .np-label{font-size:0.55rem;color:var(--dim);text-transform:uppercase;letter-spacing:2px;margin-bottom:8px}
        .np-title{font-family:'Anybody',sans-serif;font-weight:700;font-size:1.2rem;color:var(--green);
            margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .np-artist{font-size:0.75rem;color:var(--dim);margin-bottom:12px}
        .np-time{font-size:0.7rem;color:var(--amber);font-variant-numeric:tabular-nums}

        /* Visualizer */
        .visualizer{margin:14px 0;border-radius:8px;overflow:hidden;background:#080808;
            border:1px solid var(--border)}
        #vizCanvas{display:block;width:100%;height:60px}

        /* Controls */
        .controls{display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:16px}
        .ctrl-btn{background:var(--surface);border:1px solid var(--border);color:var(--dim);
            width:40px;height:40px;border-radius:8px;cursor:pointer;font-size:1rem;
            display:flex;align-items:center;justify-content:center;transition:all 0.15s}
        .ctrl-btn:hover{border-color:var(--green);color:var(--green)}
        .ctrl-btn.play{width:52px;height:52px;border-radius:50%;font-size:1.3rem;
            border-color:var(--green);color:var(--green)}
        .ctrl-btn.play:hover{background:rgba(0,255,65,0.1);box-shadow:0 0 20px rgba(0,255,65,0.2)}
        .ctrl-btn.active{background:rgba(0,255,65,0.1);border-color:var(--green);color:var(--green)}

        /* Volume */
        .volume-row{display:flex;align-items:center;gap:8px;justify-content:center;margin-bottom:16px}
        .volume-row label{font-size:0.65rem;color:var(--dim)}
        .volume-row input[type=range]{width:120px;accent-color:var(--green);height:4px}
        .volume-val{font-size:0.6rem;color:var(--green);width:28px;text-align:right}

        /* Add track */
        .add-track{display:flex;gap:6px;margin-bottom:16px}
        .add-track input{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:6px;
            padding:8px 12px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:0.7rem;outline:none}
        .add-track input:focus{border-color:var(--green)}
        .add-track input::placeholder{color:var(--dim)}
        .add-track button{background:var(--green);color:var(--bg);border:none;border-radius:6px;
            padding:8px 14px;font-family:'JetBrains Mono',monospace;font-size:0.65rem;font-weight:700;
            cursor:pointer;white-space:nowrap}
        .add-track button:hover{opacity:0.85}

        /* Playlist */
        .playlist{background:var(--surface);border:1px solid var(--border);border-radius:12px;
            overflow:hidden;margin-bottom:16px}
        .pl-head{display:flex;align-items:center;justify-content:space-between;
            padding:10px 16px;border-bottom:1px solid var(--border)}
        .pl-title{font-size:0.7rem;color:var(--dim);text-transform:uppercase;letter-spacing:1px}
        .pl-count{font-size:0.6rem;color:var(--dim)}
        .pl-list{max-height:280px;overflow-y:auto}
        .pl-track{display:flex;align-items:center;gap:10px;padding:8px 16px;
            cursor:pointer;transition:background 0.15s;border-bottom:1px solid rgba(255,255,255,0.02)}
        .pl-track:hover{background:rgba(0,255,65,0.04)}
        .pl-track:last-child{border-bottom:none}
        .pl-track.active{background:rgba(0,255,65,0.08)}
        .pl-track.active .pl-num{color:var(--green)}
        .pl-num{font-size:0.6rem;color:var(--dim);width:20px;text-align:right;flex-shrink:0}
        .pl-info{flex:1;min-width:0;overflow:hidden}
        .pl-track-title{font-size:0.7rem;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .pl-track-artist{font-size:0.55rem;color:var(--dim);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .pl-added{font-size:0.5rem;color:var(--dim);flex-shrink:0}
        .pl-playing-icon{color:var(--green);font-size:0.7rem;flex-shrink:0;animation:pulse 1s infinite}

        /* Listeners */
        .listeners{text-align:center;margin-bottom:12px}
        .listeners-pill{display:inline-block;background:var(--surface);border:1px solid var(--border);
            border-radius:20px;padding:4px 14px;font-size:0.6rem;color:var(--dim)}
        .listeners-pill span{color:var(--green);font-weight:500}

        .backlink{text-align:center;font-size:0.55rem}
        .backlink a{color:var(--dim);text-decoration:none}.backlink a:hover{color:var(--green)}

        /* Embed mode */
        body.embed-mode{min-height:auto;overflow-y:auto;align-items:flex-start}
        body.embed-mode::after{display:none}
        body.embed-mode .radio-header{display:none}
        body.embed-mode .listeners{display:none}
        body.embed-mode .backlink{display:none}
        body.embed-mode .radio{margin:0;max-width:100%;padding:6px}
        body.embed-mode .now-playing{margin-bottom:10px;padding:12px}
        body.embed-mode .controls{margin-bottom:10px}
        body.embed-mode .volume-row{margin-bottom:10px}
        body.embed-mode .add-track{margin-bottom:10px}
        body.embed-mode .playlist{margin-bottom:0}
        body.embed-mode .pl-list{max-height:120px}

        /* Hidden YT player */
        #ytPlayer{position:absolute;top:-9999px;left:-9999px;width:1px;height:1px;overflow:hidden}

        .toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--surface2);
            border:1px solid var(--border);border-radius:8px;padding:8px 18px;font-size:0.7rem;
            color:var(--text);z-index:50;opacity:0;transition:opacity 0.3s;pointer-events:none}
        .toast.show{opacity:1}

        @keyframes scan{0%{opacity:1}50%{opacity:0.3}100%{opacity:1}}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}

        @media(max-width:560px){
            body{align-items:flex-start;padding-top:16px}
            .radio{margin:10px}
            .pl-list{max-height:200px}
        }
    </style>
<script>
(function(){var Q=[],N=0,MAX=10;function send(e){var sb=window.supabase;if(!sb){Q.push(e);return;}if(N>=MAX)return;N++;sb.auth.getSession().then(function(r){var u=r&&r.data&&r.data.session&&r.data.session.user;if(!u)return;sb.from('ai_events').insert({event_type:'client_error',entity_type:'app',entity_id:u.id,username:location.pathname.split('/').filter(Boolean)[0]||'unknown',metadata:e,user_id:u.id}).then(function(){});}).catch(function(){});}window.onerror=function(m,s,l,c,e){send({type:'error',msg:String(m).slice(0,500),src:s||'',line:l,col:c,stack:e?String(e.stack).slice(0,1000):''});};window.addEventListener('unhandledrejection',function(ev){var r=ev.reason;send({type:'promise',msg:String(r&&r.message||r).slice(0,500),stack:r?String(r.stack||'').slice(0,1000):''});});var fi=setInterval(function(){if(window.supabase){Q.splice(0).forEach(send);clearInterval(fi);}},1000);setTimeout(function(){clearInterval(fi);},30000);})();
</script>
</head>
<body>
    <script>
        var IS_EMBED = new URLSearchParams(location.search).has('embed');
        if (IS_EMBED) document.body.classList.add('embed-mode');
    </script>
    <div class="radio">
        <div class="radio-header">
            <h1>üìª SLOPPY RADIO</h1>
            <div class="freq">FM 103.7 ¬∑ COMMUNITY RADIO ¬∑ SYNCED</div>
        </div>

        <div class="listeners">
            <span class="listeners-pill">üì° <span id="listenerCount">1</span> listening</span>
        </div>

        <div class="now-playing">
            <div class="np-label">Now Playing</div>
            <div class="np-title" id="npTitle">Loading...</div>
            <div class="np-artist" id="npArtist">‚Äî</div>
            <div class="np-time" id="npTime">0:00</div>
        </div>

        <div class="visualizer">
            <canvas id="vizCanvas" width="520" height="60"></canvas>
        </div>

        <div class="controls">
            <button class="ctrl-btn" onclick="prevTrack()" title="Previous">‚èÆ</button>
            <button class="ctrl-btn" onclick="stopTrack()" title="Stop">‚èπ</button>
            <button class="ctrl-btn play" id="playBtn" onclick="togglePlay()" title="Play/Pause">‚ñ∂</button>
            <button class="ctrl-btn" onclick="nextTrack()" title="Next">‚è≠</button>
            <button class="ctrl-btn" onclick="shuffleTrack()" title="Shuffle">üîÄ</button>
            <button class="ctrl-btn" onclick="resync()" title="Re-sync">üîÑ</button>
        </div>

        <div class="volume-row">
            <label>üîä</label>
            <input type="range" id="volumeSlider" min="0" max="100" value="70" oninput="setVolume(this.value)">
            <span class="volume-val" id="volumeVal">70</span>
        </div>

        <div class="add-track">
            <input type="text" id="addTrackInput" placeholder="YouTube URL or video ID" maxlength="200"
                onkeydown="if(event.key==='Enter')addTrack()">
            <button onclick="addTrack()">+ Add</button>
        </div>

        <div class="playlist">
            <div class="pl-head">
                <div class="pl-title">Playlist</div>
                <div class="pl-count" id="plCount">0 tracks</div>
            </div>
            <div class="pl-list" id="plList"></div>
        </div>

        <div class="backlink"><a href="https://sloppy.live">‚Üê sloppy.live</a></div>
    </div>

    <div id="ytPlayer"></div>
    <div class="toast" id="toast"></div>

    <script src="/sloppy-header/sloppy-bar.js" data-position="bottom" data-minimized="true"></script>
    <script type="module">
        import { createBrowserClient } from "https://cdn.jsdelivr.net/npm/@supabase/ssr@0.7.0/+esm";

        const SUPABASE_URL = 'https://yjyxteqzhhmtrgcaekgz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM4IS32IUYR2eenCCjdDdioiBU';
        const supabase = createBrowserClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            cookieOptions: { name: 'sb-auth-token', domain: location.hostname.includes('sloppy.live') ? '.sloppy.live' : location.hostname, path: '/', sameSite: 'lax' }
        });

        const DEFAULT_TRACKS = [
            { youtube_id: 'jfKfPfyJRdk', title: 'lofi hip hop radio', artist: 'Lofi Girl', duration: 0 },
            { youtube_id: '5qap5aO4i9A', title: 'chillhop radio', artist: 'Chillhop Music', duration: 0 },
            { youtube_id: 'rUxyKA_-grg', title: 'synthwave radio', artist: 'Synthwave', duration: 0 },
            { youtube_id: 'kgx4WGK0oNU', title: 'jazz vibes', artist: 'Cafe Music BGM', duration: 0 }
        ];

        let currentUser = null;
        let username = 'Anonymous';
        let player = null;
        let playerReady = false;
        let isPlaying = false;
        let currentTrack = null;
        let queue = [];
        let volume = 70;
        let channel = null;
        let syncLock = false;
        let syncLockTimeout = null;
        let vizRAF = null;
        let vizBars = new Array(32).fill(0);
        let vizPeaks = new Array(32).fill(0);
        let timeInterval = null;

        // Auth
        async function initAuth() {
            const sessRes = await supabase.auth.getSession();
            let session = sessRes.data.session;
            if (!session) {
                // Auth delegation: skip if header already has auth
                let headerHasAuth = false;
                if (window.sloppyBarGetContext) {
                    const ctx = window.sloppyBarGetContext();
                    if (ctx && ctx.isAuthenticated && ctx.userId) headerHasAuth = true;
                }
                if (!headerHasAuth) session = (await supabase.auth.signInAnonymously()).data.session;
                else session = (await supabase.auth.getSession()).data.session;
            }
            currentUser = session?.user;
            if (currentUser) {
                // Fast path: header context
                if (window.sloppyBarGetContext) {
                    const ctx = window.sloppyBarGetContext();
                    if (ctx && ctx.ready && ctx.username) { username = ctx.username; return; }
                }
                // Fallback: DB query
                const { data } = await supabase.from('sloppygram_profiles').select('username').eq('user_id', currentUser.id).single();
                if (data?.username) username = data.username;
            }
        }

        // YouTube API
        function loadYouTubeAPI() {
            return new Promise(resolve => {
                if (window.YT && window.YT.Player) { resolve(); return; }
                const tag = document.createElement('script');
                tag.src = 'https://www.youtube.com/iframe_api';
                document.head.appendChild(tag);
                window.onYouTubeIframeAPIReady = resolve;
            });
        }

        function initPlayer() {
            player = new YT.Player('ytPlayer', {
                height: '1', width: '1',
                playerVars: { autoplay: 0, controls: 0, disablekb: 1, playsinline: 1, origin: location.origin },
                events: {
                    onReady: () => { playerReady = true; player.setVolume(volume); syncState(); },
                    onStateChange: onStateChange,
                    onError: () => { setTimeout(nextTrack, 1000); }
                }
            });
        }

        function onStateChange(e) {
            if (e.data === YT.PlayerState.PLAYING) {
                isPlaying = true;
                startVisualizer();
                startTimeUpdate();
                updatePlayBtn();
            } else if (e.data === YT.PlayerState.PAUSED) {
                isPlaying = false;
                updatePlayBtn();
            } else if (e.data === YT.PlayerState.ENDED) {
                nextTrack();
            }
        }

        // Queue
        async function loadQueue() {
            const { data } = await supabase.from('sloppygram_radio')
                .select('*').order('created_at', { ascending: true }).limit(100);

            if (data && data.length > 0) {
                // Deduplicate by youtube_id
                const seen = new Set();
                queue = data.filter(t => { if (seen.has(t.youtube_id)) return false; seen.add(t.youtube_id); return true; });
            } else {
                queue = [...DEFAULT_TRACKS];
            }

            renderPlaylist();
            document.getElementById('plCount').textContent = queue.length + ' tracks';
        }

        function renderPlaylist() {
            const el = document.getElementById('plList');
            el.innerHTML = queue.map((t, i) => {
                const active = currentTrack && currentTrack.youtube_id === t.youtube_id;
                return `<div class="pl-track${active ? ' active' : ''}" onclick="window._selectTrack(${i})">
                    <div class="pl-num">${active ? '<span class="pl-playing-icon">‚ô™</span>' : (i + 1)}</div>
                    <div class="pl-info">
                        <div class="pl-track-title">${esc(t.title || 'Unknown')}</div>
                        <div class="pl-track-artist">${esc(t.artist || t.added_by || '')}</div>
                    </div>
                    ${t.added_by ? `<div class="pl-added">${esc(t.added_by)}</div>` : ''}
                </div>`;
            }).join('');
        }

        // Playback
        window._selectTrack = function(idx) {
            if (!playerReady || idx < 0 || idx >= queue.length) return;
            currentTrack = queue[idx];
            player.loadVideoById(currentTrack.youtube_id);
            isPlaying = true;
            updateNowPlaying();
            renderPlaylist();
            updatePlayBtn();
            broadcastTrack();
        };

        window.togglePlay = function() {
            if (!playerReady) return;
            if (!currentTrack && queue.length > 0) { window._selectTrack(0); return; }
            if (isPlaying) { player.pauseVideo(); stopVisualizer(); }
            else { player.playVideo(); }
        };

        window.stopTrack = function() {
            if (!playerReady) return;
            player.stopVideo();
            isPlaying = false;
            stopVisualizer();
            stopTimeUpdate();
            updatePlayBtn();
        };

        window.nextTrack = function() {
            if (queue.length === 0) return;
            const idx = currentTrack ? queue.findIndex(t => t.youtube_id === currentTrack.youtube_id) : -1;
            window._selectTrack((idx + 1) % queue.length);
        };

        window.prevTrack = function() {
            if (queue.length === 0) return;
            const idx = currentTrack ? queue.findIndex(t => t.youtube_id === currentTrack.youtube_id) : 0;
            window._selectTrack(idx <= 0 ? queue.length - 1 : idx - 1);
        };

        window.shuffleTrack = function() {
            if (queue.length === 0) return;
            window._selectTrack(Math.floor(Math.random() * queue.length));
        };

        window.setVolume = function(val) {
            volume = parseInt(val);
            if (playerReady) player.setVolume(volume);
            document.getElementById('volumeVal').textContent = volume;
        };

        window.resync = function() {
            syncState();
            showToast('Re-syncing...');
        };

        function updateNowPlaying() {
            document.getElementById('npTitle').textContent = currentTrack ? currentTrack.title : 'No track';
            document.getElementById('npArtist').textContent = currentTrack ? (currentTrack.artist || currentTrack.added_by || '‚Äî') : '‚Äî';
        }

        function updatePlayBtn() {
            document.getElementById('playBtn').textContent = isPlaying ? '‚è∏' : '‚ñ∂';
        }

        // Sync
        async function broadcastTrack() {
            if (!currentTrack || !currentUser) return;
            syncLock = true;
            clearTimeout(syncLockTimeout);
            syncLockTimeout = setTimeout(() => { syncLock = false; }, 5000);

            const startedAt = new Date().toISOString();

            // Clear all is_playing
            await supabase.from('sloppygram_radio').update({ is_playing: false, updated_at: new Date().toISOString() })
                .eq('is_playing', true);

            // Set current track as playing
            await supabase.from('sloppygram_radio').update({
                is_playing: true, started_at: startedAt, updated_at: new Date().toISOString()
            }).eq('youtube_id', currentTrack.youtube_id);

            // Broadcast to all listeners
            if (channel) {
                channel.send({ type: 'broadcast', event: 'track_change', payload: {
                    youtube_id: currentTrack.youtube_id, title: currentTrack.title,
                    artist: currentTrack.artist, started_at: startedAt
                }});
            }
        }

        async function syncState() {
            if (!playerReady) return;
            const { data } = await supabase.from('sloppygram_radio')
                .select('*').eq('is_playing', true)
                .order('started_at', { ascending: false }).limit(1);

            if (data && data[0]) {
                const track = data[0];
                currentTrack = queue.find(t => t.youtube_id === track.youtube_id) || track;
                const elapsed = (Date.now() - new Date(track.started_at).getTime()) / 1000;
                player.loadVideoById({ videoId: track.youtube_id, startSeconds: Math.max(0, elapsed) });
                isPlaying = true;
                updateNowPlaying();
                renderPlaylist();
                updatePlayBtn();
            } else if (queue.length > 0) {
                // Nothing playing, start first track
                window._selectTrack(0);
            }
        }

        function setupRealtime() {
            channel = supabase.channel('sloppyfm-radio', { config: { broadcast: { self: false } } });

            channel.on('broadcast', { event: 'track_change' }, ({ payload }) => {
                if (!payload || syncLock) return;
                syncLock = true;
                clearTimeout(syncLockTimeout);
                syncLockTimeout = setTimeout(() => { syncLock = false; }, 5000);

                // Check if already playing this track
                if (playerReady && currentTrack && currentTrack.youtube_id === payload.youtube_id) return;

                currentTrack = queue.find(t => t.youtube_id === payload.youtube_id) || {
                    youtube_id: payload.youtube_id, title: payload.title, artist: payload.artist
                };

                const elapsed = (Date.now() - new Date(payload.started_at).getTime()) / 1000;
                if (playerReady) {
                    player.loadVideoById({ videoId: payload.youtube_id, startSeconds: Math.max(0, elapsed) });
                }
                isPlaying = true;
                updateNowPlaying();
                renderPlaylist();
                updatePlayBtn();
            });

            channel.on('broadcast', { event: 'queue_update' }, () => {
                loadQueue();
            });

            channel.on('presence', { event: 'sync' }, () => {
                const count = Object.keys(channel.presenceState()).length;
                document.getElementById('listenerCount').textContent = Math.max(1, count);
            });

            channel.subscribe(async (status) => {
                if (status === 'SUBSCRIBED') {
                    await channel.track({ username, app: 'sloppy-radio' });
                }
            });
        }

        // Add track
        window.addTrack = async function() {
            const input = document.getElementById('addTrackInput');
            const val = input.value.trim();
            if (!val || !currentUser) { showToast('Enter a YouTube URL'); return; }

            // Extract youtube ID
            const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/v\/)([a-zA-Z0-9_-]{11})/,
                /^([a-zA-Z0-9_-]{11})$/
            ];
            let ytId = null;
            for (const p of patterns) {
                const m = val.match(p);
                if (m) { ytId = m[1]; break; }
            }
            if (!ytId) { showToast('Invalid YouTube URL or ID'); return; }

            // Check duplicate
            if (queue.some(t => t.youtube_id === ytId)) { showToast('Already in playlist'); return; }

            // Fetch title via oEmbed
            let title = 'Unknown Track', artist = username;
            try {
                const resp = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${ytId}&format=json`);
                if (resp.ok) {
                    const data = await resp.json();
                    title = data.title || title;
                    artist = data.author_name || artist;
                }
            } catch {}

            const { error } = await supabase.from('sloppygram_radio').insert({
                youtube_id: ytId, title, artist, duration: 0,
                added_by: username, is_playing: false, user_id: currentUser.id
            });

            if (error) { showToast('Failed to add track'); return; }

            input.value = '';
            showToast('Track added: ' + title);
            await loadQueue();

            // Notify others
            if (channel) channel.send({ type: 'broadcast', event: 'queue_update', payload: {} });
        };

        // Visualizer (simulated)
        const vizCanvas = document.getElementById('vizCanvas');
        const vizCtx = vizCanvas.getContext('2d');
        const NUM_BARS = 32;

        function startVisualizer() {
            if (vizRAF) return;
            function frame() {
                const w = vizCanvas.width, h = vizCanvas.height;
                vizCtx.fillStyle = '#080808';
                vizCtx.fillRect(0, 0, w, h);

                const barW = (w / NUM_BARS) - 1;
                for (let i = 0; i < NUM_BARS; i++) {
                    // Simulated frequency
                    let target = Math.random() * h * 0.85;
                    if (i < NUM_BARS * 0.25) target *= 1.2;         // Bass boost
                    if (i > NUM_BARS * 0.75) target *= 0.6 + Math.random() * 0.4; // Treble variation

                    vizBars[i] += (target - vizBars[i]) * 0.28;
                    if (vizBars[i] > vizPeaks[i]) vizPeaks[i] = vizBars[i];
                    else vizPeaks[i] -= 0.5;

                    const barH = vizBars[i];
                    const x = i * (barW + 1);
                    const y = h - barH;

                    // Color gradient
                    const ratio = barH / h;
                    let color;
                    if (ratio > 0.8) color = '#ef4444';
                    else if (ratio > 0.5) color = '#fbbf24';
                    else color = '#00ff41';

                    vizCtx.fillStyle = color;
                    vizCtx.fillRect(x, y, barW, barH);

                    // Peak line
                    if (vizPeaks[i] > 2) {
                        vizCtx.fillStyle = 'rgba(255,255,255,0.6)';
                        vizCtx.fillRect(x, h - vizPeaks[i], barW, 1.5);
                    }
                }
                vizRAF = requestAnimationFrame(frame);
            }
            frame();
        }

        function stopVisualizer() {
            if (vizRAF) { cancelAnimationFrame(vizRAF); vizRAF = null; }
            vizCtx.fillStyle = '#080808';
            vizCtx.fillRect(0, 0, vizCanvas.width, vizCanvas.height);
            vizBars.fill(0);
            vizPeaks.fill(0);
        }

        // Time update
        function startTimeUpdate() {
            stopTimeUpdate();
            timeInterval = setInterval(() => {
                if (!playerReady || !isPlaying) return;
                try {
                    const t = player.getCurrentTime() || 0;
                    const m = Math.floor(t / 60);
                    const s = Math.floor(t % 60);
                    document.getElementById('npTime').textContent = m + ':' + String(s).padStart(2, '0');
                } catch {}
            }, 1000);
        }
        function stopTimeUpdate() { clearInterval(timeInterval); }

        // Helpers
        function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        // Init
        async function init() {
            await initAuth();
            await loadQueue();
            await loadYouTubeAPI();
            initPlayer();
            setupRealtime();
        }
        init();

        // Sync hub listeners
        if (window.sloppyBarOn) {
            window.sloppyBarOn('identity-changed', function(data) {
                if (data && data.username) username = data.username;
            });
            window.sloppyBarOn('context-ready', function() {
                if (window.sloppyBarGetContext) {
                    var ctx = window.sloppyBarGetContext();
                    if (ctx && ctx.ready && ctx.username) username = ctx.username;
                }
            });
        }
    </script>
</body>
</html>
