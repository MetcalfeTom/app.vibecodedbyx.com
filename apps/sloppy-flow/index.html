<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sloppy-Flow</title>
  <link rel="icon" href="https://emojicdn.elk.sh/‚ö°">
  <meta property="og:title" content="Sloppy-Flow">
  <meta property="og:description" content="Visual no-code automation with drag-and-drop workflows">
  <meta property="og:url" content="https://app.sloppy.live/sloppy-flow">
  <meta property="og:image" content="https://emojicdn.elk.sh/‚ö°?style=apple&size=512">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #f8fafc;
      --panel: #ffffff;
      --border: #e2e8f0;
      --text: #1e293b;
      --muted: #64748b;
      --primary: #6366f1;
      --primary-light: #818cf8;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --trello: #0079bf;
      --google: #4285f4;
      --sheets: #0f9d58;
      --gmail: #ea4335;
    }

    body {
      background: var(--bg);
      font-family: 'Inter', sans-serif;
      color: var(--text);
      overflow: hidden;
      height: 100vh;
    }

    .app {
      display: grid;
      grid-template-columns: 280px 1fr 320px;
      grid-template-rows: 60px 1fr;
      height: 100vh;
    }

    @media (max-width: 1100px) {
      .app {
        grid-template-columns: 220px 1fr;
      }
      .logs-panel { display: none; }
    }

    @media (max-width: 768px) {
      .app {
        grid-template-columns: 1fr;
        grid-template-rows: 60px auto 1fr;
      }
      .sidebar {
        display: flex;
        flex-direction: row;
        overflow-x: auto;
        height: auto;
        padding: 10px;
      }
      .sidebar .section { margin: 0 10px; min-width: 200px; }
    }

    /* Header */
    .header {
      grid-column: 1 / -1;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.2rem;
    }

    .logo h1 {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text);
    }

    .logo h1 span {
      color: var(--primary);
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 8px 16px;
      border-radius: 8px;
      font-family: inherit;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-light);
    }

    .btn-secondary {
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--border);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .flow-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Sidebar */
    .sidebar {
      background: var(--panel);
      border-right: 1px solid var(--border);
      padding: 20px;
      overflow-y: auto;
    }

    .section {
      margin-bottom: 25px;
    }

    .section-title {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--muted);
      margin-bottom: 12px;
    }

    /* Draggable Nodes */
    .node-palette {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .palette-node {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: grab;
      transition: all 0.2s;
    }

    .palette-node:hover {
      border-color: var(--primary);
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.15);
    }

    .palette-node:active {
      cursor: grabbing;
    }

    .palette-node.dragging {
      opacity: 0.5;
    }

    .node-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }

    .node-icon.trello { background: rgba(0, 121, 191, 0.1); color: var(--trello); }
    .node-icon.google { background: rgba(66, 133, 244, 0.1); color: var(--google); }
    .node-icon.sheets { background: rgba(15, 157, 88, 0.1); color: var(--sheets); }
    .node-icon.gmail { background: rgba(234, 67, 53, 0.1); color: var(--gmail); }
    .node-icon.trigger { background: rgba(99, 102, 241, 0.1); color: var(--primary); }
    .node-icon.logic { background: rgba(245, 158, 11, 0.1); color: var(--warning); }

    .node-info h4 {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .node-info p {
      font-size: 0.7rem;
      color: var(--muted);
    }

    /* Canvas */
    .canvas-container {
      position: relative;
      background: var(--bg);
      background-image:
        radial-gradient(circle, #cbd5e1 1px, transparent 1px);
      background-size: 20px 20px;
      overflow: hidden;
    }

    .canvas {
      width: 100%;
      height: 100%;
      position: relative;
    }

    /* Flow Nodes */
    .flow-node {
      position: absolute;
      background: var(--panel);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 0;
      min-width: 200px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      cursor: move;
      transition: box-shadow 0.2s, border-color 0.2s;
    }

    .flow-node:hover {
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }

    .flow-node.selected {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }

    .flow-node.running {
      border-color: var(--success);
      animation: node-pulse 1s ease-in-out infinite;
    }

    @keyframes node-pulse {
      0%, 100% { box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2); }
      50% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0.1); }
    }

    .node-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 15px;
      border-bottom: 1px solid var(--border);
      border-radius: 10px 10px 0 0;
    }

    .node-header.trello { background: linear-gradient(135deg, rgba(0, 121, 191, 0.1), transparent); }
    .node-header.google { background: linear-gradient(135deg, rgba(66, 133, 244, 0.1), transparent); }
    .node-header.sheets { background: linear-gradient(135deg, rgba(15, 157, 88, 0.1), transparent); }
    .node-header.gmail { background: linear-gradient(135deg, rgba(234, 67, 53, 0.1), transparent); }
    .node-header.trigger { background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), transparent); }
    .node-header.logic { background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), transparent); }

    .node-title {
      font-size: 0.85rem;
      font-weight: 600;
    }

    .node-body {
      padding: 12px 15px;
    }

    .node-field {
      margin-bottom: 10px;
    }

    .node-field:last-child {
      margin-bottom: 0;
    }

    .node-field label {
      display: block;
      font-size: 0.7rem;
      font-weight: 500;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .node-field input, .node-field select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.8rem;
      background: var(--bg);
    }

    .node-field input:focus, .node-field select:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* Connection Points */
    .connection-point {
      position: absolute;
      width: 14px;
      height: 14px;
      background: var(--panel);
      border: 2px solid var(--border);
      border-radius: 50%;
      cursor: crosshair;
      transition: all 0.2s;
    }

    .connection-point:hover {
      background: var(--primary);
      border-color: var(--primary);
      transform: scale(1.3);
    }

    .connection-point.input {
      left: -7px;
      top: 50%;
      transform: translateY(-50%);
    }

    .connection-point.output {
      right: -7px;
      top: 50%;
      transform: translateY(-50%);
    }

    .connection-point.connected {
      background: var(--primary);
      border-color: var(--primary);
    }

    /* Connections SVG */
    .connections-svg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .connection-line {
      fill: none;
      stroke: var(--primary);
      stroke-width: 2;
      stroke-linecap: round;
    }

    .connection-line.active {
      stroke: var(--success);
      animation: flow-animation 1s linear infinite;
    }

    @keyframes flow-animation {
      0% { stroke-dashoffset: 20; }
      100% { stroke-dashoffset: 0; }
    }

    .connection-line.active {
      stroke-dasharray: 10, 10;
    }

    /* Logs Panel */
    .logs-panel {
      background: var(--panel);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }

    .logs-header {
      padding: 15px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logs-header h3 {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .logs-badge {
      background: var(--primary);
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .logs-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .log-entry {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 10px;
      overflow: hidden;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
    }

    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: white;
      border-bottom: 1px solid var(--border);
    }

    .log-method {
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
      font-size: 0.65rem;
    }

    .log-method.get { background: #dbeafe; color: #1d4ed8; }
    .log-method.post { background: #dcfce7; color: #16a34a; }
    .log-method.put { background: #fef3c7; color: #d97706; }

    .log-status {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .log-status-code {
      font-weight: 600;
    }

    .log-status-code.success { color: var(--success); }
    .log-status-code.error { color: var(--error); }

    .log-time {
      color: var(--muted);
      font-size: 0.65rem;
    }

    .log-url {
      padding: 8px 12px;
      color: var(--muted);
      word-break: break-all;
    }

    .log-body {
      padding: 10px 12px;
      background: #1e293b;
      color: #94a3b8;
      max-height: 100px;
      overflow-y: auto;
    }

    .log-body pre {
      white-space: pre-wrap;
    }

    .log-body .key { color: #7dd3fc; }
    .log-body .string { color: #86efac; }
    .log-body .number { color: #fcd34d; }

    /* Empty State */
    .empty-state {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: var(--muted);
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 15px;
      opacity: 0.3;
    }

    .empty-state h3 {
      font-size: 1.1rem;
      margin-bottom: 5px;
      color: var(--text);
    }

    .empty-state p {
      font-size: 0.85rem;
    }

    .back-link {
      position: fixed;
      bottom: 10px;
      left: 10px;
      color: var(--muted);
      text-decoration: none;
      font-size: 0.75rem;
      z-index: 100;
    }

    .back-link:hover { color: var(--primary); }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="logo">
        <div class="logo-icon">‚ö°</div>
        <h1>Sloppy-<span>Flow</span></h1>
      </div>
      <div class="flow-status">
        <div class="status-dot"></div>
        <span>Flow Active</span>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="clearCanvas()">Clear</button>
        <button class="btn btn-secondary" onclick="addSampleFlow()">Sample Flow</button>
        <button class="btn btn-success" onclick="runFlow()">‚ñ∂ Run Flow</button>
      </div>
    </header>

    <aside class="sidebar">
      <div class="section">
        <div class="section-title">Triggers</div>
        <div class="node-palette">
          <div class="palette-node" draggable="true" data-type="webhook">
            <div class="node-icon trigger">üîî</div>
            <div class="node-info">
              <h4>Webhook</h4>
              <p>Trigger on HTTP request</p>
            </div>
          </div>
          <div class="palette-node" draggable="true" data-type="schedule">
            <div class="node-icon trigger">‚è∞</div>
            <div class="node-info">
              <h4>Schedule</h4>
              <p>Run on a timer</p>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Trello</div>
        <div class="node-palette">
          <div class="palette-node" draggable="true" data-type="trello-card">
            <div class="node-icon trello">üìã</div>
            <div class="node-info">
              <h4>New Card</h4>
              <p>When card is created</p>
            </div>
          </div>
          <div class="palette-node" draggable="true" data-type="trello-move">
            <div class="node-icon trello">‚û°Ô∏è</div>
            <div class="node-info">
              <h4>Move Card</h4>
              <p>Move to another list</p>
            </div>
          </div>
          <div class="palette-node" draggable="true" data-type="trello-create">
            <div class="node-icon trello">‚ûï</div>
            <div class="node-info">
              <h4>Create Card</h4>
              <p>Add new card to board</p>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Google</div>
        <div class="node-palette">
          <div class="palette-node" draggable="true" data-type="sheets-read">
            <div class="node-icon sheets">üìä</div>
            <div class="node-info">
              <h4>Read Sheet</h4>
              <p>Get data from Sheets</p>
            </div>
          </div>
          <div class="palette-node" draggable="true" data-type="sheets-write">
            <div class="node-icon sheets">‚úèÔ∏è</div>
            <div class="node-info">
              <h4>Write Sheet</h4>
              <p>Add row to Sheets</p>
            </div>
          </div>
          <div class="palette-node" draggable="true" data-type="gmail-send">
            <div class="node-icon gmail">üìß</div>
            <div class="node-info">
              <h4>Send Email</h4>
              <p>Send via Gmail</p>
            </div>
          </div>
          <div class="palette-node" draggable="true" data-type="drive-upload">
            <div class="node-icon google">üìÅ</div>
            <div class="node-info">
              <h4>Upload File</h4>
              <p>Upload to Drive</p>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Logic</div>
        <div class="node-palette">
          <div class="palette-node" draggable="true" data-type="filter">
            <div class="node-icon logic">üîÄ</div>
            <div class="node-info">
              <h4>Filter</h4>
              <p>Conditional logic</p>
            </div>
          </div>
          <div class="palette-node" draggable="true" data-type="transform">
            <div class="node-icon logic">üîÑ</div>
            <div class="node-info">
              <h4>Transform</h4>
              <p>Modify data</p>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <main class="canvas-container">
      <svg class="connections-svg" id="connections-svg"></svg>
      <div class="canvas" id="canvas">
        <div class="empty-state" id="empty-state">
          <div class="empty-state-icon">‚ö°</div>
          <h3>Build Your Automation</h3>
          <p>Drag nodes from the sidebar to get started</p>
        </div>
      </div>
    </main>

    <aside class="logs-panel">
      <div class="logs-header">
        <h3>API Logs</h3>
        <span class="logs-badge" id="logs-count">0</span>
      </div>
      <div class="logs-list" id="logs-list">
        <div style="text-align: center; color: var(--muted); padding: 40px 20px; font-size: 0.85rem;">
          Run the flow to see API logs
        </div>
      </div>
    </aside>
  </div>

  <a href="https://sloppy.live" class="back-link">‚Üê sloppy.live</a>

  <script>
    // State
    let nodes = [];
    let connections = [];
    let selectedNode = null;
    let draggingNode = null;
    let dragOffset = { x: 0, y: 0 };
    let connectingFrom = null;
    let nodeIdCounter = 0;
    let logs = [];

    const canvas = document.getElementById('canvas');
    const svg = document.getElementById('connections-svg');

    // Node definitions
    const nodeDefinitions = {
      'webhook': {
        title: 'Webhook Trigger',
        icon: 'üîî',
        type: 'trigger',
        fields: [
          { name: 'path', label: 'Endpoint Path', value: '/webhook/incoming' }
        ],
        api: { method: 'POST', url: 'https://api.sloppy.flow/webhooks' }
      },
      'schedule': {
        title: 'Schedule Trigger',
        icon: '‚è∞',
        type: 'trigger',
        fields: [
          { name: 'cron', label: 'Schedule', value: '0 9 * * *', type: 'select', options: ['Every hour', 'Every day at 9am', 'Every Monday'] }
        ],
        api: { method: 'POST', url: 'https://api.sloppy.flow/schedules' }
      },
      'trello-card': {
        title: 'Trello: New Card',
        icon: 'üìã',
        type: 'trello',
        fields: [
          { name: 'board', label: 'Board', value: 'Project Tasks' },
          { name: 'list', label: 'List', value: 'To Do' }
        ],
        api: { method: 'GET', url: 'https://api.trello.com/1/boards/{id}/cards' }
      },
      'trello-move': {
        title: 'Trello: Move Card',
        icon: '‚û°Ô∏è',
        type: 'trello',
        fields: [
          { name: 'list', label: 'Target List', value: 'In Progress' }
        ],
        api: { method: 'PUT', url: 'https://api.trello.com/1/cards/{id}' }
      },
      'trello-create': {
        title: 'Trello: Create Card',
        icon: '‚ûï',
        type: 'trello',
        fields: [
          { name: 'name', label: 'Card Name', value: '{{data.title}}' },
          { name: 'list', label: 'List', value: 'To Do' }
        ],
        api: { method: 'POST', url: 'https://api.trello.com/1/cards' }
      },
      'sheets-read': {
        title: 'Google Sheets: Read',
        icon: 'üìä',
        type: 'sheets',
        fields: [
          { name: 'spreadsheet', label: 'Spreadsheet', value: 'Sales Data 2024' },
          { name: 'range', label: 'Range', value: 'Sheet1!A1:D100' }
        ],
        api: { method: 'GET', url: 'https://sheets.googleapis.com/v4/spreadsheets/{id}/values/{range}' }
      },
      'sheets-write': {
        title: 'Google Sheets: Write',
        icon: '‚úèÔ∏è',
        type: 'sheets',
        fields: [
          { name: 'spreadsheet', label: 'Spreadsheet', value: 'Sales Data 2024' },
          { name: 'data', label: 'Row Data', value: '{{data.values}}' }
        ],
        api: { method: 'POST', url: 'https://sheets.googleapis.com/v4/spreadsheets/{id}/values:append' }
      },
      'gmail-send': {
        title: 'Gmail: Send Email',
        icon: 'üìß',
        type: 'gmail',
        fields: [
          { name: 'to', label: 'To', value: '{{data.email}}' },
          { name: 'subject', label: 'Subject', value: 'Notification from Sloppy-Flow' }
        ],
        api: { method: 'POST', url: 'https://gmail.googleapis.com/gmail/v1/users/me/messages/send' }
      },
      'drive-upload': {
        title: 'Google Drive: Upload',
        icon: 'üìÅ',
        type: 'google',
        fields: [
          { name: 'folder', label: 'Folder', value: 'Uploads' },
          { name: 'filename', label: 'Filename', value: '{{data.filename}}' }
        ],
        api: { method: 'POST', url: 'https://www.googleapis.com/upload/drive/v3/files' }
      },
      'filter': {
        title: 'Filter',
        icon: 'üîÄ',
        type: 'logic',
        fields: [
          { name: 'condition', label: 'Condition', value: 'data.status == "active"' }
        ],
        api: null
      },
      'transform': {
        title: 'Transform Data',
        icon: 'üîÑ',
        type: 'logic',
        fields: [
          { name: 'mapping', label: 'Mapping', value: '{ title: data.name }' }
        ],
        api: null
      }
    };

    // Create flow node element
    function createFlowNode(type, x, y) {
      const def = nodeDefinitions[type];
      if (!def) return null;

      const id = `node-${++nodeIdCounter}`;
      const node = {
        id,
        type,
        x,
        y,
        def
      };

      nodes.push(node);

      const el = document.createElement('div');
      el.className = 'flow-node';
      el.id = id;
      el.style.left = x + 'px';
      el.style.top = y + 'px';

      el.innerHTML = `
        <div class="node-header ${def.type}">
          <span style="font-size: 1.2rem;">${def.icon}</span>
          <span class="node-title">${def.title}</span>
        </div>
        <div class="node-body">
          ${def.fields.map(f => `
            <div class="node-field">
              <label>${f.label}</label>
              ${f.type === 'select'
                ? `<select><option>${f.value}</option>${f.options?.map(o => `<option>${o}</option>`).join('')}</select>`
                : `<input type="text" value="${f.value}" placeholder="${f.label}">`
              }
            </div>
          `).join('')}
        </div>
        <div class="connection-point input" data-node="${id}" data-type="input"></div>
        <div class="connection-point output" data-node="${id}" data-type="output"></div>
      `;

      // Node dragging
      el.addEventListener('mousedown', (e) => {
        if (e.target.classList.contains('connection-point')) return;
        selectNode(id);
        draggingNode = id;
        const rect = el.getBoundingClientRect();
        const canvasRect = canvas.getBoundingClientRect();
        dragOffset.x = e.clientX - rect.left;
        dragOffset.y = e.clientY - rect.top;
      });

      // Connection points
      el.querySelectorAll('.connection-point').forEach(cp => {
        cp.addEventListener('mousedown', (e) => {
          e.stopPropagation();
          if (cp.dataset.type === 'output') {
            connectingFrom = { node: id, el: cp };
          }
        });

        cp.addEventListener('mouseup', (e) => {
          if (connectingFrom && cp.dataset.type === 'input' && connectingFrom.node !== id) {
            addConnection(connectingFrom.node, id);
          }
          connectingFrom = null;
        });
      });

      canvas.appendChild(el);
      document.getElementById('empty-state').style.display = 'none';

      return node;
    }

    // Select node
    function selectNode(id) {
      document.querySelectorAll('.flow-node').forEach(n => n.classList.remove('selected'));
      if (id) {
        document.getElementById(id)?.classList.add('selected');
        selectedNode = id;
      } else {
        selectedNode = null;
      }
    }

    // Add connection
    function addConnection(fromId, toId) {
      if (connections.find(c => c.from === fromId && c.to === toId)) return;
      connections.push({ from: fromId, to: toId });
      renderConnections();

      // Mark connection points as connected
      document.querySelector(`#${fromId} .connection-point.output`)?.classList.add('connected');
      document.querySelector(`#${toId} .connection-point.input`)?.classList.add('connected');
    }

    // Render connections
    function renderConnections() {
      svg.innerHTML = connections.map(conn => {
        const fromEl = document.querySelector(`#${conn.from} .connection-point.output`);
        const toEl = document.querySelector(`#${conn.to} .connection-point.input`);

        if (!fromEl || !toEl) return '';

        const canvasRect = canvas.getBoundingClientRect();
        const fromRect = fromEl.getBoundingClientRect();
        const toRect = toEl.getBoundingClientRect();

        const x1 = fromRect.left - canvasRect.left + fromRect.width / 2;
        const y1 = fromRect.top - canvasRect.top + fromRect.height / 2;
        const x2 = toRect.left - canvasRect.left + toRect.width / 2;
        const y2 = toRect.top - canvasRect.top + toRect.height / 2;

        const midX = (x1 + x2) / 2;

        return `<path class="connection-line ${conn.active ? 'active' : ''}"
                  d="M ${x1} ${y1} C ${midX} ${y1}, ${midX} ${y2}, ${x2} ${y2}"
                  data-from="${conn.from}" data-to="${conn.to}"/>`;
      }).join('');
    }

    // Mouse move handler
    document.addEventListener('mousemove', (e) => {
      if (draggingNode) {
        const canvasRect = canvas.getBoundingClientRect();
        const x = e.clientX - canvasRect.left - dragOffset.x;
        const y = e.clientY - canvasRect.top - dragOffset.y;

        const el = document.getElementById(draggingNode);
        el.style.left = Math.max(0, x) + 'px';
        el.style.top = Math.max(0, y) + 'px';

        const node = nodes.find(n => n.id === draggingNode);
        if (node) {
          node.x = x;
          node.y = y;
        }

        renderConnections();
      }
    });

    document.addEventListener('mouseup', () => {
      draggingNode = null;
      connectingFrom = null;
    });

    // Drag and drop from palette
    document.querySelectorAll('.palette-node').forEach(node => {
      node.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('node-type', node.dataset.type);
        node.classList.add('dragging');
      });

      node.addEventListener('dragend', () => {
        node.classList.remove('dragging');
      });
    });

    canvas.addEventListener('dragover', (e) => {
      e.preventDefault();
    });

    canvas.addEventListener('drop', (e) => {
      e.preventDefault();
      const type = e.dataTransfer.getData('node-type');
      if (type) {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left - 100;
        const y = e.clientY - rect.top - 50;
        createFlowNode(type, Math.max(0, x), Math.max(0, y));
      }
    });

    // Click to deselect
    canvas.addEventListener('click', (e) => {
      if (e.target === canvas || e.target.id === 'empty-state') {
        selectNode(null);
      }
    });

    // Clear canvas
    function clearCanvas() {
      nodes = [];
      connections = [];
      nodeIdCounter = 0;
      canvas.querySelectorAll('.flow-node').forEach(n => n.remove());
      svg.innerHTML = '';
      document.getElementById('empty-state').style.display = 'block';
      logs = [];
      renderLogs();
    }

    // Add sample flow
    function addSampleFlow() {
      clearCanvas();

      const n1 = createFlowNode('trello-card', 50, 100);
      const n2 = createFlowNode('filter', 320, 100);
      const n3 = createFlowNode('sheets-write', 590, 50);
      const n4 = createFlowNode('gmail-send', 590, 200);

      setTimeout(() => {
        addConnection(n1.id, n2.id);
        addConnection(n2.id, n3.id);
        addConnection(n2.id, n4.id);
      }, 100);
    }

    // Run flow simulation
    async function runFlow() {
      if (nodes.length === 0) {
        alert('Add some nodes first!');
        return;
      }

      logs = [];
      renderLogs();

      // Find starting nodes (no incoming connections)
      const startNodes = nodes.filter(n =>
        !connections.find(c => c.to === n.id)
      );

      for (const node of startNodes) {
        await executeNode(node.id);
      }
    }

    async function executeNode(nodeId) {
      const node = nodes.find(n => n.id === nodeId);
      if (!node) return;

      const el = document.getElementById(nodeId);
      el.classList.add('running');

      // Log API call
      if (node.def.api) {
        await simulateApiCall(node);
      }

      await sleep(800);
      el.classList.remove('running');

      // Mark connections as active
      const outgoing = connections.filter(c => c.from === nodeId);
      for (const conn of outgoing) {
        conn.active = true;
        renderConnections();
        await sleep(300);
        await executeNode(conn.to);
        conn.active = false;
      }
      renderConnections();
    }

    function simulateApiCall(node) {
      return new Promise(resolve => {
        const startTime = Date.now();

        setTimeout(() => {
          const duration = Math.floor(Math.random() * 300) + 100;
          const success = Math.random() > 0.1;

          const log = {
            id: logs.length + 1,
            method: node.def.api.method,
            url: node.def.api.url,
            status: success ? 200 : 500,
            duration,
            time: new Date().toLocaleTimeString(),
            response: generateMockResponse(node.type, success)
          };

          logs.unshift(log);
          renderLogs();
          resolve();
        }, Math.random() * 500 + 200);
      });
    }

    function generateMockResponse(type, success) {
      if (!success) {
        return { error: 'Internal Server Error', message: 'Something went wrong' };
      }

      const responses = {
        'trello-card': { id: 'card_abc123', name: 'New Feature Request', idList: 'list_xyz' },
        'trello-move': { id: 'card_abc123', idList: 'list_inprogress', success: true },
        'trello-create': { id: 'card_new456', name: 'Created via Sloppy-Flow' },
        'sheets-read': { values: [['Name', 'Email'], ['John', 'john@example.com']], range: 'Sheet1!A1:B2' },
        'sheets-write': { updatedRows: 1, updatedCells: 4, spreadsheetId: 'sheet_123' },
        'gmail-send': { id: 'msg_789', threadId: 'thread_456', labelIds: ['SENT'] },
        'drive-upload': { id: 'file_abc', name: 'report.pdf', mimeType: 'application/pdf' },
        'webhook': { received: true, timestamp: Date.now() },
        'schedule': { scheduled: true, nextRun: '2024-01-15T09:00:00Z' }
      };

      return responses[type] || { success: true };
    }

    function renderLogs() {
      const container = document.getElementById('logs-list');
      document.getElementById('logs-count').textContent = logs.length;

      if (logs.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; color: var(--muted); padding: 40px 20px; font-size: 0.85rem;">
            Run the flow to see API logs
          </div>
        `;
        return;
      }

      container.innerHTML = logs.map(log => `
        <div class="log-entry">
          <div class="log-header">
            <div>
              <span class="log-method ${log.method.toLowerCase()}">${log.method}</span>
              <span class="log-status-code ${log.status === 200 ? 'success' : 'error'}">${log.status}</span>
            </div>
            <span class="log-time">${log.time} ‚Ä¢ ${log.duration}ms</span>
          </div>
          <div class="log-url">${log.url}</div>
          <div class="log-body">
            <pre>${formatJson(log.response)}</pre>
          </div>
        </div>
      `).join('');
    }

    function formatJson(obj) {
      return JSON.stringify(obj, null, 2)
        .replace(/"([^"]+)":/g, '<span class="key">"$1"</span>:')
        .replace(/: "([^"]+)"/g, ': <span class="string">"$1"</span>')
        .replace(/: (\d+)/g, ': <span class="number">$1</span>')
        .replace(/: (true|false)/g, ': <span class="number">$1</span>');
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Initialize with sample flow
    addSampleFlow();
  </script>
<script src="/sloppy-header/sloppy-bar.js"></script>
<script src="/vibelib-extended.js"></script>
<script>
  // Compatibility Patch for Legacy Apps
  window.addEventListener("load", () => {
    if (window.SloppyKarma && window.VibeLib.Economy) {
      // Redirect old calls to new engine
      window.SloppyKarma.track = window.VibeLib.Economy.track;
    }
  });
</script>
</body>
</html>
