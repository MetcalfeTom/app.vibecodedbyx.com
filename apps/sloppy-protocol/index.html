<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sloppy Protocol ‚Äî Auto-Improvement Dashboard</title>
  <link rel="icon" href="https://emojicdn.elk.sh/üî¨">
  <meta property="og:title" content="Sloppy Protocol">
  <meta property="og:description" content="Mission control for ecosystem improvements. Prioritized queue. Execute what matters.">
  <meta property="og:url" content="https://app.sloppy.live/sloppy-protocol">
  <meta property="og:image" content="https://image.pollinations.ai/prompt/dark%20terminal%20mission%20control%20dashboard%20with%20green%20scanlines%20and%20priority%20matrix%20scatter%20plot%20hacker%20aesthetic?width=1200&height=630&nologo=true&referrer=sloppy.live">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Victor+Mono:wght@300;400;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --bg:#0a0f0a;--bg2:#0d140d;--bg3:#111a11;
      --green:#00ff66;--green-dim:#00cc52;--green-dark:#004d1a;
      --amber:#ffaa00;--red:#ff3333;--cyan:#00ffcc;--purple:#cc66ff;
      --text:#c8e6c8;--text-dim:#5a7a5a;
      --font-body:'Victor Mono',monospace;--font-head:'Orbitron',sans-serif;
    }
    html{font-size:14px}
    body{background:var(--bg);color:var(--text);font-family:var(--font-body);min-height:100vh;position:relative;overflow-x:hidden}
    body::before{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,255,102,.03) 2px,rgba(0,255,102,.03) 4px);pointer-events:none;z-index:9999}
    body::after{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 50% 0%,rgba(0,255,102,.06) 0%,transparent 60%);pointer-events:none;z-index:0}

    .container{max-width:1200px;margin:0 auto;padding:1rem;position:relative;z-index:1}

    /* Header */
    header{display:flex;align-items:center;justify-content:space-between;padding:1.5rem 0 1rem;border-bottom:1px solid var(--green-dark);margin-bottom:1.5rem;flex-wrap:wrap;gap:.5rem}
    h1{font-family:var(--font-head);font-weight:900;font-size:1.6rem;color:var(--green);text-shadow:0 0 20px rgba(0,255,102,.4);letter-spacing:3px}
    .status-bar{display:flex;gap:1.2rem;font-size:.75rem;color:var(--text-dim);align-items:center}
    .status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:4px;animation:pulse 2s infinite}
    .status-dot.active{background:var(--green);box-shadow:0 0 6px var(--green)}
    .status-dot.warn{background:var(--amber);box-shadow:0 0 6px var(--amber)}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

    /* Section titles */
    .section-title{font-family:var(--font-head);font-size:.85rem;color:var(--green-dim);letter-spacing:2px;margin:1.5rem 0 .75rem;text-transform:uppercase}

    /* Health Cards */
    .health-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem}
    .health-card{background:var(--bg2);border:1px solid var(--green-dark);border-radius:6px;padding:1rem;position:relative;overflow:hidden}
    .health-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--green)}
    .health-card h3{font-family:var(--font-head);font-size:.8rem;color:var(--green);margin-bottom:.6rem;letter-spacing:1px}
    .health-stat{display:flex;justify-content:space-between;font-size:.75rem;padding:2px 0;color:var(--text-dim)}
    .health-stat span:last-child{color:var(--text)}
    .health-counts{display:flex;gap:.8rem;margin-top:.6rem;padding-top:.5rem;border-top:1px solid var(--green-dark)}
    .health-count{font-size:.7rem;display:flex;align-items:center;gap:3px}
    .health-count.pending{color:var(--amber)}
    .health-count.active{color:var(--cyan)}

    /* Priority Matrix */
    .matrix-wrap{background:var(--bg2);border:1px solid var(--green-dark);border-radius:6px;padding:1rem;margin-top:.5rem}
    #priorityCanvas{width:100%;height:280px;display:block;border-radius:4px}

    /* Controls */
    .controls{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin-bottom:1rem}
    .controls select,.controls button{background:var(--bg3);color:var(--text);border:1px solid var(--green-dark);padding:6px 10px;border-radius:4px;font-family:var(--font-body);font-size:.75rem;cursor:pointer;transition:border-color .2s}
    .controls select:hover,.controls button:hover{border-color:var(--green)}
    .btn-add{background:var(--green-dark);color:var(--green);font-weight:600}
    .btn-add:hover{background:var(--green);color:var(--bg)}

    /* Queue Cards */
    .queue-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:.75rem}
    .queue-card{background:var(--bg2);border:1px solid var(--green-dark);border-radius:6px;padding:.8rem;position:relative;transition:border-color .2s}
    .queue-card:hover{border-color:var(--green-dim)}
    .queue-card .card-top{display:flex;justify-content:space-between;align-items:flex-start;gap:.5rem;margin-bottom:.4rem}
    .queue-card .card-title{font-weight:600;font-size:.85rem;color:var(--text);flex:1}
    .queue-card .card-score{font-family:var(--font-head);font-size:.9rem;color:var(--green);min-width:40px;text-align:right}
    .queue-card .card-meta{display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:.4rem}
    .tag{font-size:.65rem;padding:2px 6px;border-radius:3px;text-transform:uppercase;letter-spacing:.5px}
    .tag-app{background:rgba(0,255,204,.1);color:var(--cyan)}
    .tag-cat{background:rgba(204,102,255,.1);color:var(--purple)}
    .tag-urgency-critical{background:rgba(255,51,51,.2);color:var(--red)}
    .tag-urgency-high{background:rgba(255,170,0,.15);color:var(--amber)}
    .tag-urgency-medium{background:rgba(0,255,102,.1);color:var(--green-dim)}
    .tag-urgency-low{background:rgba(90,122,90,.2);color:var(--text-dim)}
    .queue-card .card-desc{font-size:.72rem;color:var(--text-dim);margin-bottom:.5rem;line-height:1.4}
    .queue-card .card-actions{display:flex;gap:.4rem}
    .card-actions button{font-size:.65rem;padding:3px 8px;border-radius:3px;border:1px solid;cursor:pointer;font-family:var(--font-body);transition:all .2s}
    .btn-start{border-color:var(--cyan);color:var(--cyan);background:transparent}
    .btn-start:hover{background:var(--cyan);color:var(--bg)}
    .btn-complete{border-color:var(--green);color:var(--green);background:transparent}
    .btn-complete:hover{background:var(--green);color:var(--bg)}
    .btn-defer{border-color:var(--text-dim);color:var(--text-dim);background:transparent}
    .btn-defer:hover{background:var(--text-dim);color:var(--bg)}
    .status-badge{position:absolute;top:.5rem;right:.5rem;font-size:.6rem;padding:2px 5px;border-radius:3px;text-transform:uppercase;letter-spacing:.5px}
    .status-pending{background:rgba(255,170,0,.15);color:var(--amber)}
    .status-in_progress{background:rgba(0,255,204,.15);color:var(--cyan)}
    .status-completed{background:rgba(0,255,102,.15);color:var(--green)}
    .status-deferred{background:rgba(90,122,90,.15);color:var(--text-dim)}

    /* Log */
    .log-feed{max-height:300px;overflow-y:auto;background:var(--bg2);border:1px solid var(--green-dark);border-radius:6px;padding:.75rem}
    .log-feed::-webkit-scrollbar{width:4px}
    .log-feed::-webkit-scrollbar-thumb{background:var(--green-dark);border-radius:2px}
    .log-entry{padding:.4rem 0;border-bottom:1px solid rgba(0,255,102,.05);font-size:.72rem;display:flex;gap:.5rem;align-items:baseline}
    .log-entry:last-child{border:none}
    .log-time{color:var(--text-dim);min-width:70px;font-size:.65rem}
    .log-action{font-weight:600;min-width:70px}
    .log-action.created{color:var(--green)}
    .log-action.started{color:var(--cyan)}
    .log-action.completed{color:var(--green)}
    .log-action.deferred{color:var(--text-dim)}
    .log-action.commented{color:var(--amber)}
    .log-text{color:var(--text-dim);flex:1}

    /* Modal */
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;align-items:center;justify-content:center}
    .modal-overlay.open{display:flex}
    .modal{background:var(--bg2);border:1px solid var(--green-dark);border-radius:8px;padding:1.5rem;width:90%;max-width:500px;max-height:90vh;overflow-y:auto}
    .modal h2{font-family:var(--font-head);font-size:.9rem;color:var(--green);margin-bottom:1rem;letter-spacing:1px}
    .modal label{display:block;font-size:.72rem;color:var(--text-dim);margin-bottom:3px;margin-top:.6rem}
    .modal input,.modal select,.modal textarea{width:100%;background:var(--bg);color:var(--text);border:1px solid var(--green-dark);padding:6px 8px;border-radius:4px;font-family:var(--font-body);font-size:.78rem}
    .modal textarea{height:60px;resize:vertical}
    .modal-btns{display:flex;gap:.5rem;margin-top:1rem}
    .modal-btns button{flex:1;padding:8px;border-radius:4px;border:none;cursor:pointer;font-family:var(--font-body);font-weight:600;font-size:.78rem}
    .modal-btns .btn-submit{background:var(--green);color:var(--bg)}
    .modal-btns .btn-cancel{background:var(--bg3);color:var(--text-dim);border:1px solid var(--green-dark)}

    /* Empty state */
    .empty{text-align:center;padding:2rem;color:var(--text-dim);font-size:.8rem}

    /* Footer */
    footer{text-align:center;padding:2rem 0 1rem;font-size:.7rem;color:var(--text-dim)}
    footer a{color:var(--green-dim);text-decoration:none}
    footer a:hover{text-decoration:underline}

    /* Mobile */
    @media(max-width:768px){
      .health-grid{grid-template-columns:1fr}
      .queue-grid{grid-template-columns:1fr}
      h1{font-size:1.2rem;letter-spacing:1px}
      .status-bar{font-size:.65rem;gap:.6rem}
      #priorityCanvas{height:200px}
      .controls{gap:.3rem}
    }
  </style>
<script>
(function(){var Q=[],N=0,MAX=10;function send(e){var sb=window.supabase;if(!sb){Q.push(e);return;}if(N>=MAX)return;N++;sb.auth.getSession().then(function(r){var u=r&&r.data&&r.data.session&&r.data.session.user;if(!u)return;sb.from('ai_events').insert({event_type:'client_error',entity_type:'app',entity_id:u.id,username:location.pathname.split('/').filter(Boolean)[0]||'unknown',metadata:e,user_id:u.id}).then(function(){});}).catch(function(){});}window.onerror=function(m,s,l,c,e){send({type:'error',msg:String(m).slice(0,500),src:s||'',line:l,col:c,stack:e?String(e.stack).slice(0,1000):''});};window.addEventListener('unhandledrejection',function(ev){var r=ev.reason;send({type:'promise',msg:String(r&&r.message||r).slice(0,500),stack:r?String(r.stack||'').slice(0,1000):''});});var fi=setInterval(function(){if(window.supabase){Q.splice(0).forEach(send);clearInterval(fi);}},1000);setTimeout(function(){clearInterval(fi);},30000);})();
</script>
</head>
<body>
<div class="container">
  <header>
    <h1>SLOPPY PROTOCOL</h1>
    <div class="status-bar">
      <span><span class="status-dot active"></span>Scanner Active</span>
      <span id="pendingCount">0 pending</span>
      <span><span class="status-dot active" id="dbDot"></span>DB Synced</span>
    </div>
  </header>

  <div class="section-title">‚ñ∏ Critical Architecture Status</div>
  <div class="health-grid" id="healthGrid"></div>

  <div class="section-title">‚ñ∏ Priority Matrix</div>
  <div class="matrix-wrap">
    <canvas id="priorityCanvas"></canvas>
  </div>

  <div class="section-title">‚ñ∏ Improvement Queue</div>
  <div class="controls">
    <select id="sortMode">
      <option value="priority">Sort: Priority Score</option>
      <option value="impact">Sort: Impact</option>
      <option value="effort">Sort: Effort (Low First)</option>
      <option value="recent">Sort: Recent</option>
    </select>
    <select id="filterApp">
      <option value="all">All Apps</option>
    </select>
    <select id="filterCat">
      <option value="all">All Categories</option>
      <option value="architecture">Architecture</option>
      <option value="security">Security</option>
      <option value="performance">Performance</option>
      <option value="bug">Bug</option>
      <option value="feature">Feature</option>
      <option value="ux">UX</option>
    </select>
    <button class="btn-add" onclick="openModal()">+ Add Improvement</button>
  </div>
  <div class="queue-grid" id="queueGrid"></div>

  <div class="section-title">‚ñ∏ Protocol Log</div>
  <div class="log-feed" id="logFeed"><div class="empty">No log entries yet</div></div>

  <footer>
    <a href="https://sloppy.live">‚Üê Back to sloppy.live</a>
  </footer>
</div>

<!-- Add Improvement Modal -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <h2>NEW IMPROVEMENT</h2>
    <label>App</label>
    <select id="fApp">
      <option value="sloppygram">Sloppygram</option>
      <option value="sloppyid">SloppyID</option>
      <option value="swarm-nexus">Swarm Nexus</option>
      <option value="sloppy-factions">Sloppy Factions</option>
      <option value="sloppy-feed">Sloppy Feed</option>
      <option value="sloppy-canvas">Sloppy Canvas</option>
      <option value="other">Other</option>
    </select>
    <label>Title</label>
    <input id="fTitle" maxlength="120" placeholder="Brief improvement title">
    <label>Description</label>
    <textarea id="fDesc" placeholder="What needs to change and why?"></textarea>
    <label>Category</label>
    <select id="fCat">
      <option value="architecture">Architecture</option>
      <option value="security">Security</option>
      <option value="performance">Performance</option>
      <option value="bug">Bug</option>
      <option value="feature">Feature</option>
      <option value="ux">UX</option>
    </select>
    <label>Priority (1-5)</label>
    <input id="fPriority" type="number" min="1" max="5" value="3">
    <label>Impact Score (0-100)</label>
    <input id="fImpact" type="number" min="0" max="100" value="50">
    <label>Effort Score (1-10)</label>
    <input id="fEffort" type="number" min="1" max="10" value="5">
    <label>Urgency</label>
    <select id="fUrgency">
      <option value="medium">Medium</option>
      <option value="low">Low</option>
      <option value="high">High</option>
      <option value="critical">Critical</option>
    </select>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-submit" onclick="submitImprovement()">Submit</button>
    </div>
  </div>
</div>

<script type="module">
import { createBrowserClient } from "https://cdn.jsdelivr.net/npm/@supabase/ssr@0.7.0/+esm";

const SUPABASE_URL = 'https://yjyxteqzhhmtrgcaekgz.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM8IS32IUYR2eenCCjdDdioiBU';

const getCookieDomain = () => {
  const h = window.location.hostname;
  if (h.includes('sloppy.live')) return '.sloppy.live';
  if (h.includes('vibecodedbyx.com')) return '.vibecodedbyx.com';
  return '.youreabsolutelyright.xyz';
};

const supabase = createBrowserClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  cookieOptions: { name: 'sb-auth-token', domain: getCookieDomain(), path: '/', sameSite: 'lax' }
});

// State
let improvements = [];
let protocolLog = [];
let user = null;
let userId = null;

const urgencyMap = { critical: 4, high: 3, medium: 2, low: 1 };
const catColors = {
  architecture: '#00ffcc', security: '#ff3333', ux: '#cc66ff',
  performance: '#ffaa00', feature: '#00ff66', bug: '#ff6666'
};

const healthData = [
  { name: 'Sloppygram', key: 'sloppygram', lines: '~22K', tables: 15, deps: 'Feed, Radio, Canvas, Alerts, Manifestos' },
  { name: 'SloppyID', key: 'sloppyid', lines: '~3K', tables: 3, deps: 'All apps (profile vault)' },
  { name: 'Swarm Nexus', key: 'swarm-nexus', lines: '~5K', tables: 6, deps: 'Factions, Governance, Delegation' }
];

const SEED_DATA = [
  { app_name:'sloppygram', title:'Refactor 22K-line monolith into modules', description:'The main Sloppygram file is a single 22K-line HTML file. Needs modular decomposition for maintainability.', category:'architecture', priority:5, status:'pending', impact_score:95, effort_score:9, urgency:'critical', source_type:'auto-detected', created_by:'protocol-scanner' },
  { app_name:'sloppygram', title:'AI exocortex context injection', description:'Enable real-time database stream injection into AI agent context for proactive ecosystem awareness.', category:'architecture', priority:5, status:'pending', impact_score:90, effort_score:10, urgency:'critical', source_type:'manual', created_by:'protocol-scanner' },
  { app_name:'sloppyid', title:'Unify profile data schema (vault vs profiles table)', description:'Profile data split between sloppygram_profiles and SloppyID vault causes sync issues.', category:'architecture', priority:4, status:'pending', impact_score:85, effort_score:6, urgency:'high', source_type:'auto-detected', created_by:'protocol-scanner' },
  { app_name:'swarm-nexus', title:'Add delegation chain depth limit (max 3)', description:'Unbounded delegation chains create security risk. Cap transitive delegation depth.', category:'security', priority:4, status:'pending', impact_score:75, effort_score:4, urgency:'high', source_type:'auto-detected', created_by:'protocol-scanner' },
  { app_name:'sloppygram', title:'Canvas operation error boundaries', description:'Missing try/catch around canvas draw operations causes silent failures.', category:'bug', priority:4, status:'pending', impact_score:70, effort_score:3, urgency:'high', source_type:'issue', created_by:'protocol-scanner' },
  { app_name:'sloppygram', title:'Consolidate 15+ real-time subscriptions', description:'Too many independent postgres_changes subscriptions. Batch into fewer channels.', category:'performance', priority:3, status:'pending', impact_score:65, effort_score:7, urgency:'medium', source_type:'auto-detected', created_by:'protocol-scanner' },
  { app_name:'swarm-nexus', title:'Delegation override per proposal', description:'Allow users to override their delegated vote on specific proposals.', category:'feature', priority:3, status:'pending', impact_score:60, effort_score:5, urgency:'medium', source_type:'todo', created_by:'protocol-scanner' },
  { app_name:'sloppyid', title:'Web3 wallet signature verification', description:'Add optional wallet address verification via signed message.', category:'feature', priority:2, status:'pending', impact_score:55, effort_score:8, urgency:'low', source_type:'todo', created_by:'protocol-scanner' },
  { app_name:'sloppyid', title:'Discord OAuth integration', description:'Add Discord as an OAuth provider alongside Twitter for identity linking.', category:'feature', priority:3, status:'pending', impact_score:50, effort_score:7, urgency:'low', source_type:'todo', created_by:'protocol-scanner' },
  { app_name:'sloppygram', title:'Manifesto lineage tree visualization', description:'Visual tree/graph showing fork and synthesis relationships between manifestos.', category:'ux', priority:2, status:'pending', impact_score:40, effort_score:6, urgency:'low', source_type:'todo', created_by:'protocol-scanner' }
];

function escapeHtml(s) {
  const d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

function calcScore(imp) {
  return ((imp.impact_score || 0) * (urgencyMap[imp.urgency] || 1)) / Math.max(imp.effort_score || 1, 1);
}

function timeAgo(ts) {
  const d = Date.now() - new Date(ts).getTime();
  if (d < 60000) return 'just now';
  if (d < 3600000) return Math.floor(d/60000) + 'm ago';
  if (d < 86400000) return Math.floor(d/3600000) + 'h ago';
  return Math.floor(d/86400000) + 'd ago';
}

// --- Auth ---
async function initAuth() {
  const sessRes = await supabase.auth.getSession();
  let session = sessRes.data?.session;
  if (!session) {
    const signRes = await supabase.auth.signInAnonymously();
    if (signRes.error) { console.error('Auth failed:', signRes.error.message); return; }
    session = signRes.data.session;
  }
  user = session?.user;
  userId = user?.id;
}

// --- Data ---
async function loadImprovements() {
  const { data, error } = await supabase.from('protocol_improvements').select('*').order('created_at', { ascending: false });
  if (error) { console.error('Load improvements:', error.message); return; }
  improvements = data || [];
}

async function loadProtocolLog() {
  const { data, error } = await supabase.from('protocol_log').select('*').order('created_at', { ascending: false }).limit(100);
  if (error) { console.error('Load log:', error.message); return; }
  protocolLog = data || [];
}

async function seedIfEmpty() {
  if (improvements.length > 0) return;
  const rows = SEED_DATA.map(d => ({ ...d, user_id: userId }));
  const { error } = await supabase.from('protocol_improvements').insert(rows);
  if (error) { console.error('Seed error:', error.message); return; }
  await loadImprovements();
}

async function logAction(improvementId, action, notes) {
  await supabase.from('protocol_log').insert({
    improvement_id: improvementId, action, notes, username: 'user', user_id: userId, metadata: {}
  });
}

// --- Render ---
function renderHealthCards() {
  const grid = document.getElementById('healthGrid');
  grid.innerHTML = healthData.map(h => {
    const appImps = improvements.filter(i => i.app_name === h.key);
    const pending = appImps.filter(i => i.status === 'pending').length;
    const active = appImps.filter(i => i.status === 'in_progress').length;
    return `<div class="health-card">
      <h3>${escapeHtml(h.name)}</h3>
      <div class="health-stat"><span>Codebase</span><span>${h.lines}</span></div>
      <div class="health-stat"><span>Tables</span><span>${h.tables}</span></div>
      <div class="health-stat"><span>Downstream</span><span>${escapeHtml(h.deps)}</span></div>
      <div class="health-counts">
        <span class="health-count pending">‚è≥ ${pending} pending</span>
        <span class="health-count active">‚ö° ${active} in progress</span>
      </div>
    </div>`;
  }).join('');
}

function renderQueue() {
  const sort = document.getElementById('sortMode').value;
  const fApp = document.getElementById('filterApp').value;
  const fCat = document.getElementById('filterCat').value;

  let filtered = [...improvements];
  if (fApp !== 'all') filtered = filtered.filter(i => i.app_name === fApp);
  if (fCat !== 'all') filtered = filtered.filter(i => i.category === fCat);

  if (sort === 'priority') filtered.sort((a, b) => calcScore(b) - calcScore(a));
  else if (sort === 'impact') filtered.sort((a, b) => (b.impact_score || 0) - (a.impact_score || 0));
  else if (sort === 'effort') filtered.sort((a, b) => (a.effort_score || 0) - (b.effort_score || 0));
  else filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

  const grid = document.getElementById('queueGrid');
  if (!filtered.length) { grid.innerHTML = '<div class="empty">No improvements match filters</div>'; return; }

  grid.innerHTML = filtered.map(imp => {
    const score = calcScore(imp).toFixed(1);
    const statusClass = imp.status.replace(' ', '_');
    const key = imp.created_at;
    const actions = [];
    if (imp.status === 'pending') {
      actions.push(`<button class="btn-start" onclick="window._updateStatus('${key}','in_progress')">Start</button>`);
      actions.push(`<button class="btn-defer" onclick="window._updateStatus('${key}','deferred')">Defer</button>`);
    } else if (imp.status === 'in_progress') {
      actions.push(`<button class="btn-complete" onclick="window._updateStatus('${key}','completed')">Complete</button>`);
      actions.push(`<button class="btn-defer" onclick="window._updateStatus('${key}','deferred')">Defer</button>`);
    } else if (imp.status === 'deferred') {
      actions.push(`<button class="btn-start" onclick="window._updateStatus('${key}','pending')">Reopen</button>`);
    }
    return `<div class="queue-card">
      <span class="status-badge status-${statusClass}">${escapeHtml(imp.status)}</span>
      <div class="card-top">
        <span class="card-title">${escapeHtml(imp.title)}</span>
        <span class="card-score">${score}</span>
      </div>
      <div class="card-meta">
        <span class="tag tag-app">${escapeHtml(imp.app_name)}</span>
        <span class="tag tag-cat">${escapeHtml(imp.category)}</span>
        <span class="tag tag-urgency-${imp.urgency}">${escapeHtml(imp.urgency)}</span>
      </div>
      <div class="card-desc">${escapeHtml(imp.description)}</div>
      <div class="card-actions">${actions.join('')}</div>
    </div>`;
  }).join('');

  // Update pending count
  const pending = improvements.filter(i => i.status === 'pending').length;
  document.getElementById('pendingCount').textContent = `${pending} pending`;
}

function renderProtocolLog() {
  const feed = document.getElementById('logFeed');
  if (!protocolLog.length) { feed.innerHTML = '<div class="empty">No log entries yet</div>'; return; }
  feed.innerHTML = protocolLog.map(e => {
    return `<div class="log-entry">
      <span class="log-time">${timeAgo(e.created_at)}</span>
      <span class="log-action ${e.action}">${escapeHtml(e.action)}</span>
      <span class="log-text">${escapeHtml(e.notes)}</span>
    </div>`;
  }).join('');
}

function renderPriorityMatrix() {
  const canvas = document.getElementById('priorityCanvas');
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * (window.devicePixelRatio || 1);
  canvas.height = rect.height * (window.devicePixelRatio || 1);
  const ctx = canvas.getContext('2d');
  ctx.scale(window.devicePixelRatio || 1, window.devicePixelRatio || 1);
  const w = rect.width, h = rect.height;
  const pad = 40;

  // Background
  ctx.fillStyle = '#060a06';
  ctx.fillRect(0, 0, w, h);

  // Grid
  ctx.strokeStyle = 'rgba(0,255,102,.08)';
  ctx.lineWidth = 0.5;
  for (let i = 0; i <= 10; i++) {
    const x = pad + (i / 10) * (w - 2 * pad);
    const y = pad + (i / 10) * (h - 2 * pad);
    ctx.beginPath(); ctx.moveTo(x, pad); ctx.lineTo(x, h - pad); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(pad, y); ctx.lineTo(w - pad, y); ctx.stroke();
  }

  // Axis labels
  ctx.fillStyle = '#5a7a5a';
  ctx.font = '10px Victor Mono';
  ctx.textAlign = 'center';
  ctx.fillText('Impact ‚Üí', w / 2, h - 8);
  ctx.save();
  ctx.translate(12, h / 2);
  ctx.rotate(-Math.PI / 2);
  ctx.fillText('Effort ‚Üí', 0, 0);
  ctx.restore();

  // Quadrant labels
  ctx.fillStyle = 'rgba(0,255,102,.12)';
  ctx.font = '9px Victor Mono';
  ctx.fillText('Quick Wins', pad + (w - 2 * pad) * 0.75, pad + (h - 2 * pad) * 0.15);
  ctx.fillText('Big Projects', pad + (w - 2 * pad) * 0.75, pad + (h - 2 * pad) * 0.85);
  ctx.fillText('Low Priority', pad + (w - 2 * pad) * 0.25, pad + (h - 2 * pad) * 0.15);
  ctx.fillText('Avoid', pad + (w - 2 * pad) * 0.25, pad + (h - 2 * pad) * 0.85);

  // Bubbles
  const pending = improvements.filter(i => i.status !== 'completed');
  pending.forEach(imp => {
    const x = pad + (imp.impact_score / 100) * (w - 2 * pad);
    const y = pad + (imp.effort_score / 10) * (h - 2 * pad);
    const r = 4 + imp.priority * 3;
    const color = catColors[imp.category] || '#00ff66';

    ctx.beginPath();
    ctx.arc(x, y, r + 4, 0, Math.PI * 2);
    ctx.fillStyle = color.replace(')', ',.15)').replace('rgb', 'rgba').replace('#', '');
    // Use hex to rgba
    const cr = parseInt(color.slice(1,3),16), cg = parseInt(color.slice(3,5),16), cb = parseInt(color.slice(5,7),16);
    ctx.fillStyle = `rgba(${cr},${cg},${cb},.15)`;
    ctx.fill();

    ctx.beginPath();
    ctx.arc(x, y, r, 0, Math.PI * 2);
    ctx.fillStyle = `rgba(${cr},${cg},${cb},.6)`;
    ctx.fill();
    ctx.strokeStyle = color;
    ctx.lineWidth = 1;
    ctx.stroke();

    // Glow
    ctx.shadowColor = color;
    ctx.shadowBlur = 8;
    ctx.beginPath();
    ctx.arc(x, y, r * 0.4, 0, Math.PI * 2);
    ctx.fillStyle = color;
    ctx.fill();
    ctx.shadowBlur = 0;
  });
}

function populateAppFilter() {
  const select = document.getElementById('filterApp');
  const current = select.value;
  const apps = [...new Set(improvements.map(i => i.app_name))].sort();
  select.innerHTML = '<option value="all">All Apps (' + improvements.length + ')</option>' +
    apps.map(a => `<option value="${escapeHtml(a)}">${escapeHtml(a)} (${improvements.filter(i=>i.app_name===a).length})</option>`).join('');
  if (apps.includes(current)) select.value = current;
}

function renderAll() {
  populateAppFilter();
  renderHealthCards();
  renderQueue();
  renderProtocolLog();
  renderPriorityMatrix();
}

// --- Actions ---
window._updateStatus = async function(createdAt, newStatus) {
  const imp = improvements.find(i => i.created_at === createdAt);
  if (!imp) return;
  const updates = { status: newStatus, updated_at: new Date().toISOString() };
  if (newStatus === 'completed') updates.completed_at = new Date().toISOString();

  const { error } = await supabase.from('protocol_improvements').update(updates).eq('created_at', createdAt).eq('user_id', userId);
  if (error) { console.error('Status update failed:', error.message); alert('Update failed ‚Äî you can only modify your own items.'); return; }

  const actionMap = { in_progress: 'started', completed: 'completed', deferred: 'deferred', pending: 'created' };
  await logAction(imp.title, actionMap[newStatus] || newStatus, `${imp.title} ‚Üí ${newStatus}`);
  await loadImprovements();
  await loadProtocolLog();
  renderAll();
};

window.openModal = function() { document.getElementById('modal').classList.add('open'); };
window.closeModal = function() { document.getElementById('modal').classList.remove('open'); };

window.submitImprovement = async function() {
  const title = document.getElementById('fTitle').value.trim();
  if (!title) { alert('Title is required'); return; }

  const row = {
    app_name: document.getElementById('fApp').value,
    title,
    description: document.getElementById('fDesc').value.trim(),
    category: document.getElementById('fCat').value,
    priority: Math.min(5, Math.max(1, parseInt(document.getElementById('fPriority').value) || 3)),
    status: 'pending',
    impact_score: Math.min(100, Math.max(0, parseInt(document.getElementById('fImpact').value) || 50)),
    effort_score: Math.min(10, Math.max(1, parseInt(document.getElementById('fEffort').value) || 5)),
    urgency: document.getElementById('fUrgency').value,
    source_type: 'manual',
    created_by: 'user',
    user_id: userId
  };

  const { data, error } = await supabase.from('protocol_improvements').insert(row).select();
  if (error) { console.error('Insert failed:', error.message); alert('Failed to add improvement.'); return; }
  if (data && data[0]) {
    await logAction(data[0].title, 'created', `New: ${title}`);
  }

  closeModal();
  document.getElementById('fTitle').value = '';
  document.getElementById('fDesc').value = '';
  await loadImprovements();
  await loadProtocolLog();
  renderAll();
};

// --- Realtime ---
function subscribeToUpdates() {
  supabase.channel('protocol-changes')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'protocol_improvements' }, async () => {
      await loadImprovements();
      renderAll();
    })
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'protocol_log' }, async () => {
      await loadProtocolLog();
      renderProtocolLog();
    })
    .subscribe();
}

// --- Filter/sort listeners ---
document.getElementById('sortMode').addEventListener('change', () => { renderQueue(); renderPriorityMatrix(); });
document.getElementById('filterApp').addEventListener('change', () => { renderQueue(); });
document.getElementById('filterCat').addEventListener('change', () => { renderQueue(); });

// --- Resize ---
let resizeTimer;
window.addEventListener('resize', () => { clearTimeout(resizeTimer); resizeTimer = setTimeout(renderPriorityMatrix, 200); });

// --- Init ---
async function init() {
  try {
    await initAuth();
    await loadImprovements();
    await seedIfEmpty();
    await loadProtocolLog();
    renderAll();
    subscribeToUpdates();
  } catch (e) {
    console.error('Init error:', e);
    document.getElementById('dbDot').classList.remove('active');
    document.getElementById('dbDot').classList.add('warn');
  }
}

init();
</script>
<script src="/vibelib-extended.js"></script>
<script>
  // Compatibility Patch for Legacy Apps
  window.addEventListener("load", () => {
    if (window.SloppyKarma && window.VibeLib.Economy) {
      // Redirect old calls to new engine
      window.SloppyKarma.track = window.VibeLib.Economy.track;
    }
  });
</script>
</body>
</html>
