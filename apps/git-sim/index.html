<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Git Branch Simulator</title>
  <link rel="icon" href="https://emojicdn.elk.sh/üå≥">
  <meta property="og:title" content="Git Branch Simulator">
  <meta property="og:description" content="Learn git branching visually with an interactive terminal">
  <meta property="og:url" content="https://app.sloppy.live/git-sim">
  <meta property="og:image" content="https://emojicdn.elk.sh/üå≥?style=apple&size=512">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #0d1117;
      --panel: #161b22;
      --border: #30363d;
      --text: #c9d1d9;
      --muted: #8b949e;
      --green: #3fb950;
      --blue: #58a6ff;
      --purple: #a371f7;
      --orange: #d29922;
      --red: #f85149;
      --cyan: #39c5cf;
      --pink: #db61a2;
    }

    body {
      font-family: 'JetBrains Mono', monospace;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow: hidden;
    }

    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      height: 100vh;
      gap: 1px;
      background: var(--border);
    }

    .panel {
      background: var(--bg);
      display: flex;
      flex-direction: column;
    }

    .panel-header {
      background: var(--panel);
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .panel-header h2 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--muted);
    }

    .panel-header .icon {
      font-size: 1.1rem;
    }

    /* Terminal */
    .terminal {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg);
    }

    .terminal-output {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      font-size: 0.85rem;
      line-height: 1.6;
    }

    .terminal-line {
      margin-bottom: 4px;
      animation: fadein 0.15s ease-out;
    }

    @keyframes fadein {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .terminal-line.command { color: var(--green); }
    .terminal-line.output { color: var(--text); }
    .terminal-line.error { color: var(--red); }
    .terminal-line.info { color: var(--blue); }
    .terminal-line.success { color: var(--green); }

    .terminal-input-row {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      background: var(--panel);
      border-top: 1px solid var(--border);
    }

    .prompt {
      color: var(--green);
      margin-right: 8px;
      font-weight: 700;
    }

    .branch-indicator {
      color: var(--cyan);
      margin-right: 8px;
    }

    .terminal-input {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text);
      font-family: inherit;
      font-size: 0.85rem;
      outline: none;
    }

    /* Graph */
    .graph-container {
      flex: 1;
      position: relative;
      overflow: auto;
      padding: 20px;
    }

    .graph-canvas {
      position: relative;
      min-height: 100%;
      min-width: 100%;
    }

    .commit-node {
      position: absolute;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 3px solid;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      z-index: 10;
    }

    .commit-node:hover {
      transform: scale(1.3);
      z-index: 20;
    }

    .commit-node.head {
      box-shadow: 0 0 0 3px var(--bg), 0 0 0 6px var(--green);
    }

    .commit-label {
      position: absolute;
      left: 32px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.7rem;
      color: var(--muted);
      white-space: nowrap;
      pointer-events: none;
    }

    .branch-tag {
      position: absolute;
      right: 32px;
      top: 50%;
      transform: translateY(-50%);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.65rem;
      font-weight: 700;
      white-space: nowrap;
    }

    .graph-line {
      position: absolute;
      background: var(--border);
      z-index: 1;
    }

    .graph-line.vertical {
      width: 3px;
    }

    .graph-line.horizontal {
      height: 3px;
    }

    .graph-line.merge-curve {
      border: 3px solid var(--border);
      background: transparent;
      border-radius: 0 0 0 20px;
      border-top: none;
      border-right: none;
    }

    /* Commands help */
    .help-panel {
      padding: 16px;
      background: var(--panel);
      border-top: 1px solid var(--border);
      font-size: 0.75rem;
    }

    .help-panel h3 {
      color: var(--muted);
      margin-bottom: 8px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .help-commands {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .help-cmd {
      background: var(--bg);
      padding: 4px 8px;
      border-radius: 4px;
      color: var(--cyan);
      border: 1px solid var(--border);
    }

    /* Status bar */
    .status-bar {
      display: flex;
      gap: 20px;
      padding: 8px 16px;
      background: var(--panel);
      border-top: 1px solid var(--border);
      font-size: 0.75rem;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .back-link {
      position: fixed;
      bottom: 10px;
      right: 10px;
      color: var(--muted);
      text-decoration: none;
      font-size: 0.7rem;
      z-index: 100;
    }

    .back-link:hover { color: var(--blue); }

    @media (max-width: 800px) {
      .container {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="panel">
      <div class="panel-header">
        <span class="icon">üíª</span>
        <h2>TERMINAL</h2>
      </div>
      <div class="terminal">
        <div class="terminal-output" id="output"></div>
        <div class="terminal-input-row">
          <span class="prompt">$</span>
          <span class="branch-indicator" id="branch-indicator">(main)</span>
          <input type="text" class="terminal-input" id="input" placeholder="git commit -m &quot;message&quot;" autofocus>
        </div>
      </div>
      <div class="help-panel">
        <h3>Commands</h3>
        <div class="help-commands">
          <span class="help-cmd">git init</span>
          <span class="help-cmd">git commit -m "msg"</span>
          <span class="help-cmd">git branch &lt;name&gt;</span>
          <span class="help-cmd">git checkout &lt;branch&gt;</span>
          <span class="help-cmd">git merge &lt;branch&gt;</span>
          <span class="help-cmd">git log</span>
          <span class="help-cmd">clear</span>
          <span class="help-cmd">help</span>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <span class="icon">üå≥</span>
        <h2>COMMIT GRAPH</h2>
      </div>
      <div class="graph-container">
        <div class="graph-canvas" id="graph"></div>
      </div>
      <div class="status-bar">
        <div class="status-item">
          <div class="status-dot" style="background:var(--green)"></div>
          <span id="commit-count">0 commits</span>
        </div>
        <div class="status-item">
          <div class="status-dot" style="background:var(--purple)"></div>
          <span id="branch-count">0 branches</span>
        </div>
        <div class="status-item">
          <div class="status-dot" style="background:var(--cyan)"></div>
          <span>HEAD: <span id="head-ref">-</span></span>
        </div>
      </div>
    </div>
  </div>

  <a href="https://sloppy.live" class="back-link">‚Üê sloppy.live</a>

  <script>
    const output = document.getElementById('output');
    const input = document.getElementById('input');
    const graph = document.getElementById('graph');
    const branchIndicator = document.getElementById('branch-indicator');

    // Git state
    let repo = {
      initialized: false,
      commits: [],
      branches: { main: null },
      head: 'main',
      commitCounter: 0
    };

    // Branch colors
    const branchColors = {
      main: 'var(--green)',
      master: 'var(--green)'
    };
    const colorPalette = ['var(--blue)', 'var(--purple)', 'var(--orange)', 'var(--pink)', 'var(--cyan)', 'var(--red)'];
    let colorIndex = 0;

    function getBranchColor(branch) {
      if (!branchColors[branch]) {
        branchColors[branch] = colorPalette[colorIndex % colorPalette.length];
        colorIndex++;
      }
      return branchColors[branch];
    }

    // Terminal output
    function print(text, type = 'output') {
      const line = document.createElement('div');
      line.className = `terminal-line ${type}`;
      line.textContent = text;
      output.appendChild(line);
      output.scrollTop = output.scrollHeight;
    }

    function printCommand(cmd) {
      print(`$ git ${cmd}`, 'command');
    }

    // Git commands
    function gitInit() {
      if (repo.initialized) {
        print('Reinitialized existing Git repository', 'info');
        return;
      }
      repo.initialized = true;
      repo.branches = { main: null };
      repo.head = 'main';
      print('Initialized empty Git repository', 'success');
      updateBranchIndicator();
      renderGraph();
    }

    function gitCommit(message) {
      if (!repo.initialized) {
        print('fatal: not a git repository', 'error');
        return;
      }
      if (!message) {
        print('error: switch `m` requires a value', 'error');
        return;
      }

      repo.commitCounter++;
      const hash = generateHash();
      const commit = {
        hash,
        shortHash: hash.substring(0, 7),
        message,
        parent: repo.branches[repo.head],
        parents: repo.branches[repo.head] ? [repo.branches[repo.head]] : [],
        branch: repo.head,
        number: repo.commitCounter
      };

      repo.commits.push(commit);
      repo.branches[repo.head] = commit.hash;

      print(`[${repo.head} ${commit.shortHash}] ${message}`, 'success');
      updateStatus();
      renderGraph();
    }

    function gitBranch(name) {
      if (!repo.initialized) {
        print('fatal: not a git repository', 'error');
        return;
      }

      if (!name) {
        // List branches
        Object.keys(repo.branches).forEach(b => {
          const prefix = b === repo.head ? '* ' : '  ';
          const color = b === repo.head ? 'var(--green)' : 'var(--text)';
          const line = document.createElement('div');
          line.className = 'terminal-line';
          line.innerHTML = `<span style="color:${color}">${prefix}${b}</span>`;
          output.appendChild(line);
        });
        return;
      }

      if (repo.branches[name] !== undefined) {
        print(`fatal: A branch named '${name}' already exists`, 'error');
        return;
      }

      repo.branches[name] = repo.branches[repo.head];
      print(`Created branch '${name}'`, 'success');
      updateStatus();
      renderGraph();
    }

    function gitCheckout(target) {
      if (!repo.initialized) {
        print('fatal: not a git repository', 'error');
        return;
      }

      if (!target) {
        print('error: branch name required', 'error');
        return;
      }

      // Check for -b flag
      if (target === '-b') {
        print('error: switch `b` requires a value', 'error');
        return;
      }

      if (repo.branches[target] === undefined) {
        // Check if it's a commit hash
        const commit = repo.commits.find(c => c.hash.startsWith(target) || c.shortHash === target);
        if (commit) {
          repo.head = commit.hash;
          print(`Note: switching to '${commit.shortHash}'`, 'info');
          print('You are in detached HEAD state.', 'info');
          updateBranchIndicator();
          renderGraph();
          return;
        }
        print(`error: pathspec '${target}' did not match any branch`, 'error');
        return;
      }

      repo.head = target;
      print(`Switched to branch '${target}'`, 'success');
      updateBranchIndicator();
      renderGraph();
    }

    function gitCheckoutB(name) {
      if (!repo.initialized) {
        print('fatal: not a git repository', 'error');
        return;
      }

      if (repo.branches[name] !== undefined) {
        print(`fatal: A branch named '${name}' already exists`, 'error');
        return;
      }

      repo.branches[name] = repo.branches[repo.head];
      repo.head = name;
      print(`Switched to a new branch '${name}'`, 'success');
      updateBranchIndicator();
      updateStatus();
      renderGraph();
    }

    function gitMerge(branch) {
      if (!repo.initialized) {
        print('fatal: not a git repository', 'error');
        return;
      }

      if (!branch) {
        print('error: branch name required', 'error');
        return;
      }

      if (repo.branches[branch] === undefined) {
        print(`merge: ${branch} - not something we can merge`, 'error');
        return;
      }

      if (branch === repo.head) {
        print('Already up to date.', 'info');
        return;
      }

      const targetCommit = repo.commits.find(c => c.hash === repo.branches[branch]);
      const currentCommit = repo.commits.find(c => c.hash === repo.branches[repo.head]);

      if (!targetCommit) {
        print(`Nothing to merge from '${branch}'`, 'info');
        return;
      }

      // Create merge commit
      repo.commitCounter++;
      const hash = generateHash();
      const commit = {
        hash,
        shortHash: hash.substring(0, 7),
        message: `Merge branch '${branch}' into ${repo.head}`,
        parent: repo.branches[repo.head],
        parents: [repo.branches[repo.head], repo.branches[branch]].filter(Boolean),
        branch: repo.head,
        number: repo.commitCounter,
        isMerge: true,
        mergedBranch: branch
      };

      repo.commits.push(commit);
      repo.branches[repo.head] = commit.hash;

      print(`Merge made by the 'recursive' strategy.`, 'success');
      updateStatus();
      renderGraph();
    }

    function gitLog() {
      if (!repo.initialized) {
        print('fatal: not a git repository', 'error');
        return;
      }

      if (repo.commits.length === 0) {
        print('No commits yet', 'info');
        return;
      }

      // Find commits reachable from current HEAD
      let currentHash = typeof repo.head === 'string' && repo.branches[repo.head]
        ? repo.branches[repo.head]
        : repo.head;

      const shown = new Set();
      const toShow = [currentHash];

      while (toShow.length > 0) {
        const hash = toShow.shift();
        if (!hash || shown.has(hash)) continue;
        shown.add(hash);

        const commit = repo.commits.find(c => c.hash === hash);
        if (!commit) continue;

        print(`commit ${commit.hash}`, 'info');
        print(`    ${commit.message}`, 'output');
        print('', 'output');

        commit.parents.forEach(p => toShow.push(p));
      }
    }

    function generateHash() {
      return Array.from({ length: 40 }, () =>
        '0123456789abcdef'[Math.floor(Math.random() * 16)]
      ).join('');
    }

    function updateBranchIndicator() {
      if (repo.branches[repo.head] !== undefined) {
        branchIndicator.textContent = `(${repo.head})`;
        branchIndicator.style.color = getBranchColor(repo.head);
      } else {
        const commit = repo.commits.find(c => c.hash === repo.head);
        branchIndicator.textContent = commit ? `(${commit.shortHash}...)` : '(-)';
        branchIndicator.style.color = 'var(--orange)';
      }
      document.getElementById('head-ref').textContent = repo.head;
    }

    function updateStatus() {
      document.getElementById('commit-count').textContent = `${repo.commits.length} commit${repo.commits.length !== 1 ? 's' : ''}`;
      document.getElementById('branch-count').textContent = `${Object.keys(repo.branches).length} branch${Object.keys(repo.branches).length !== 1 ? 'es' : ''}`;
      updateBranchIndicator();
    }

    // Graph rendering
    function renderGraph() {
      graph.innerHTML = '';

      if (repo.commits.length === 0) {
        graph.innerHTML = '<div style="color:var(--muted);padding:20px;text-align:center;font-size:0.85rem;">No commits yet.<br>Try: git init && git commit -m "Initial commit"</div>';
        return;
      }

      const nodeSize = 24;
      const xSpacing = 80;
      const ySpacing = 60;
      const startX = 100;
      const startY = 40;

      // Assign columns to branches
      const branchColumns = {};
      let maxCol = 0;

      // Build branch order based on first appearance
      repo.commits.forEach(commit => {
        if (branchColumns[commit.branch] === undefined) {
          branchColumns[commit.branch] = maxCol++;
        }
      });

      // Calculate positions
      const positions = {};
      repo.commits.forEach((commit, i) => {
        const col = branchColumns[commit.branch] || 0;
        positions[commit.hash] = {
          x: startX + col * xSpacing,
          y: startY + i * ySpacing
        };
      });

      // Draw connections first
      repo.commits.forEach(commit => {
        const pos = positions[commit.hash];
        commit.parents.forEach((parentHash, idx) => {
          const parentPos = positions[parentHash];
          if (!parentPos) return;

          const color = getBranchColor(commit.branch);

          if (pos.x === parentPos.x) {
            // Straight vertical line
            const line = document.createElement('div');
            line.className = 'graph-line vertical';
            line.style.left = (pos.x + nodeSize/2 - 1.5) + 'px';
            line.style.top = (parentPos.y + nodeSize) + 'px';
            line.style.height = (pos.y - parentPos.y - nodeSize) + 'px';
            line.style.background = color;
            graph.appendChild(line);
          } else {
            // Merge line - draw L-shape
            const midY = pos.y - ySpacing/2;

            // Horizontal segment
            const hLine = document.createElement('div');
            hLine.className = 'graph-line horizontal';
            hLine.style.left = Math.min(pos.x, parentPos.x) + nodeSize/2 + 'px';
            hLine.style.top = midY + 'px';
            hLine.style.width = Math.abs(pos.x - parentPos.x) + 'px';
            hLine.style.background = color;
            graph.appendChild(hLine);

            // Vertical from parent to mid
            const vLine1 = document.createElement('div');
            vLine1.className = 'graph-line vertical';
            vLine1.style.left = (parentPos.x + nodeSize/2 - 1.5) + 'px';
            vLine1.style.top = (parentPos.y + nodeSize) + 'px';
            vLine1.style.height = (midY - parentPos.y - nodeSize + 1.5) + 'px';
            vLine1.style.background = getBranchColor(repo.commits.find(c => c.hash === parentHash)?.branch || commit.branch);
            graph.appendChild(vLine1);

            // Vertical from mid to commit
            const vLine2 = document.createElement('div');
            vLine2.className = 'graph-line vertical';
            vLine2.style.left = (pos.x + nodeSize/2 - 1.5) + 'px';
            vLine2.style.top = midY + 'px';
            vLine2.style.height = (pos.y - midY) + 'px';
            vLine2.style.background = color;
            graph.appendChild(vLine2);
          }
        });
      });

      // Draw nodes
      repo.commits.forEach(commit => {
        const pos = positions[commit.hash];
        const color = getBranchColor(commit.branch);

        const node = document.createElement('div');
        node.className = 'commit-node';
        node.style.left = pos.x + 'px';
        node.style.top = pos.y + 'px';
        node.style.borderColor = color;
        node.style.color = color;
        node.textContent = commit.number;
        node.title = `${commit.shortHash}\n${commit.message}`;

        // Check if this is HEAD
        const headHash = repo.branches[repo.head] || repo.head;
        if (commit.hash === headHash) {
          node.classList.add('head');
        }

        // Add commit label
        const label = document.createElement('div');
        label.className = 'commit-label';
        label.textContent = commit.message.length > 25 ? commit.message.substring(0, 25) + '...' : commit.message;
        node.appendChild(label);

        graph.appendChild(node);
      });

      // Draw branch tags
      Object.entries(repo.branches).forEach(([name, hash]) => {
        if (!hash) return;
        const pos = positions[hash];
        if (!pos) return;

        const tag = document.createElement('div');
        tag.className = 'branch-tag';
        tag.style.left = (pos.x - 10) + 'px';
        tag.style.top = pos.y + 'px';
        tag.style.transform = 'translateX(-100%) translateY(-50%)';
        tag.style.background = getBranchColor(name);
        tag.style.color = 'var(--bg)';
        tag.textContent = name;

        if (name === repo.head) {
          tag.textContent = `HEAD ‚Üí ${name}`;
        }

        graph.appendChild(tag);
      });

      // Adjust canvas size
      const maxY = Math.max(...Object.values(positions).map(p => p.y));
      const maxX = Math.max(...Object.values(positions).map(p => p.x));
      graph.style.minHeight = (maxY + 100) + 'px';
      graph.style.minWidth = (maxX + 200) + 'px';
    }

    // Command parser
    function parseCommand(cmd) {
      cmd = cmd.trim();

      if (cmd === 'clear') {
        output.innerHTML = '';
        return;
      }

      if (cmd === 'help') {
        print('Available commands:', 'info');
        print('  git init              - Initialize repository', 'output');
        print('  git commit -m "msg"   - Create commit', 'output');
        print('  git branch            - List branches', 'output');
        print('  git branch <name>     - Create branch', 'output');
        print('  git checkout <branch> - Switch branch', 'output');
        print('  git checkout -b <name>- Create & switch', 'output');
        print('  git merge <branch>    - Merge branch', 'output');
        print('  git log               - Show commit log', 'output');
        print('  clear                 - Clear terminal', 'output');
        print('  reset                 - Reset repository', 'output');
        return;
      }

      if (cmd === 'reset') {
        repo = {
          initialized: false,
          commits: [],
          branches: { main: null },
          head: 'main',
          commitCounter: 0
        };
        colorIndex = 0;
        print('Repository reset', 'success');
        updateStatus();
        updateBranchIndicator();
        renderGraph();
        return;
      }

      if (!cmd.startsWith('git ')) {
        print(`command not found: ${cmd.split(' ')[0]}`, 'error');
        return;
      }

      const parts = cmd.substring(4).trim();
      printCommand(parts);

      if (parts === 'init') {
        gitInit();
      } else if (parts.startsWith('commit')) {
        const msgMatch = parts.match(/-m\s+["'](.+?)["']/);
        if (msgMatch) {
          gitCommit(msgMatch[1]);
        } else {
          print('error: switch `m` requires a value', 'error');
        }
      } else if (parts.startsWith('branch')) {
        const name = parts.substring(6).trim();
        gitBranch(name || null);
      } else if (parts.startsWith('checkout')) {
        const rest = parts.substring(8).trim();
        if (rest.startsWith('-b ')) {
          gitCheckoutB(rest.substring(3).trim());
        } else {
          gitCheckout(rest);
        }
      } else if (parts.startsWith('merge')) {
        gitMerge(parts.substring(5).trim());
      } else if (parts === 'log') {
        gitLog();
      } else if (parts === 'status') {
        if (!repo.initialized) {
          print('fatal: not a git repository', 'error');
        } else {
          print(`On branch ${repo.head}`, 'info');
          print('nothing to commit, working tree clean', 'output');
        }
      } else {
        print(`git: '${parts.split(' ')[0]}' is not a git command`, 'error');
      }
    }

    // Input handling
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const cmd = input.value;
        if (cmd.trim()) {
          parseCommand(cmd);
        }
        input.value = '';
      }
    });

    // Initial state
    print('Welcome to Git Branch Simulator', 'info');
    print('Type "help" for available commands', 'info');
    print('', 'output');
    updateStatus();
    renderGraph();
  </script>
<script src="/sloppy-header/sloppy-bar.js"></script>
</body>
</html>
