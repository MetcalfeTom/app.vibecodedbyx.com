<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SloppyGov - The Town Hall</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <script src="/vibelib-extended.js"></script>
  <script src="/apps/sloppy-header/sloppy-bar.js"></script>
  <script src="/apps/app-data.js"></script>

  <style>
    :root {
      --bg: #0f0e13;
      --card-bg: #1a1921;
      --primary: #d4af37; /* Gold */
      --secondary: #a855f7; /* Purple */
      --text: #e2e2e2;
      --text-dim: #888;
      --border: rgba(255, 255, 255, 0.1);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 60px; /* Header space */
    }

    .container {
      width: 100%;
      max-width: 1000px;
      padding: 20px;
    }

    header {
      text-align: center;
      margin-bottom: 40px;
    }

    h1 {
      font-family: 'Uncial Antiqua', serif;
      font-size: 3rem;
      color: var(--primary);
      text-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
      margin-bottom: 10px;
    }

    .subtitle {
      color: var(--text-dim);
      font-size: 1.1rem;
    }

    .balance-display {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-bottom: 30px;
      background: var(--card-bg);
      padding: 15px;
      border-radius: 50px;
      border: 1px solid var(--border);
      display: inline-flex;
    }

    .balance-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .balance-label { font-size: 0.8rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
    .balance-val { font-size: 1.5rem; font-weight: bold; color: var(--text); }
    .balance-val.rep { color: var(--secondary); }
    .balance-val.cur { color: var(--primary); }

    .voting-booth {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }

    .candidate-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 25px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .candidate-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      border-color: var(--primary);
    }

    .app-icon {
      font-size: 3rem;
      margin-bottom: 15px;
    }

    .app-name {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 10px;
      color: #fff;
    }

    .app-cat {
      background: rgba(255,255,255,0.05);
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.8rem;
      color: var(--text-dim);
      margin-bottom: 20px;
    }

    .vote-btn {
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
    }

    .vote-btn:hover {
      background: var(--primary);
      color: #000;
    }

    .vote-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      border-color: var(--text-dim);
      color: var(--text-dim);
    }

    .cost-hint {
      font-size: 0.8rem;
      margin-top: 8px;
      color: var(--text-dim);
    }

    .message {
      text-align: center;
      margin-top: 20px;
      min-height: 24px;
      font-weight: bold;
    }
    .message.error { color: #ff4444; }
    .message.success { color: #00ff88; }

  </style>
</head>
<body>

  <div class="container">
    <header>
      <h1>The Town Hall</h1>
      <p class="subtitle">Spend Reputation to Govern the Ecosystem</p>
    </header>

    <div style="text-align:center;">
        <div class="balance-display">
            <div class="balance-item">
                <span class="balance-label">Reputation (Spendable)</span>
                <span class="balance-val rep" id="rep-bal">--</span>
            </div>
            <div class="balance-item">
                <span class="balance-label">Curation (Power)</span>
                <span class="balance-val cur" id="cur-bal">--</span>
            </div>
        </div>
    </div>

    <div id="booth" class="voting-booth">
      <!-- Cards go here -->
      <div style="grid-column: 1/-1; text-align:center; padding: 40px;">
        Loading candidates...
      </div>
    </div>

    <div id="msg-area" class="message"></div>
  </div>

  <script>
    let currentUser = null;
    let reputation = 0;
    let curation = 0;

    async function init() {
        if (!window.VibeLib || !window.supabase || !window.AppData) {
            setTimeout(init, 200);
            return;
        }

        currentUser = await window.VibeLib.Auth.getUser();

        if (!currentUser) {
            document.getElementById('booth').innerHTML = `
                <div style="grid-column: 1/-1; text-align:center; padding: 40px; color: #888;">
                    Please login to participate in governance.
                </div>
            `;
            return;
        }

        await fetchBalances();
        renderCandidates();
    }

    async function fetchBalances() {
        const { data, error } = await window.supabase
            .from('economy_balances')
            .select('reputation_score, curation_score')
            .eq('user_id', currentUser.id)
            .single();

        if (data) {
            reputation = data.reputation_score || 0;
            curation = data.curation_score || 0;
            updateBalanceUI();
        }
    }

    function updateBalanceUI() {
        document.getElementById('rep-bal').innerText = reputation;
        document.getElementById('cur-bal').innerText = curation;
    }

    function renderCandidates() {
        const apps = window.AppData.apps;
        const candidates = [];
        // Pick 3 random unique apps
        while (candidates.length < 3) {
            const random = apps[Math.floor(Math.random() * apps.length)];
            if (!candidates.includes(random)) candidates.push(random);
        }

        const container = document.getElementById('booth');
        container.innerHTML = candidates.map(app => {
            const catKey = window.AppData.categorizeApp(app);
            const category = window.AppData.taxonomy[catKey] || { name: 'Misc', icon: 'ðŸ“¦' };

            return `
                <div class="candidate-card">
                    <div class="app-icon">${category.icon}</div>
                    <div class="app-name">${app}</div>
                    <div class="app-cat">${category.name}</div>
                    <button class="vote-btn" onclick="vote('${app}')">
                        Vote to Feature
                    </button>
                    <div class="cost-hint">Cost: 10 Rep | Reward: +5 Curation</div>
                </div>
            `;
        }).join('');
    }

    window.vote = async function(appName) {
        const msg = document.getElementById('msg-area');
        msg.className = 'message';
        msg.innerText = 'Voting...';

        if (reputation < 10) {
            msg.className = 'message error';
            msg.innerText = 'Insufficient Reputation! You need 10 Points.';
            return;
        }

        try {
            // 1. Deduct Reputation
            const newRep = reputation - 10;

            // 2. Add Curation
            const newCur = curation + 5;

            // Update Balances
            const { error: balError } = await window.supabase
                .from('economy_balances')
                .update({
                    reputation_score: newRep,
                    curation_score: newCur,
                    updated_at: new Date().toISOString()
                })
                .eq('user_id', currentUser.id);

            if (balError) throw balError;

            // 3. Insert Vote
            const { error: voteError } = await window.supabase
                .from('governance_votes')
                .insert({
                    user_id: currentUser.id,
                    app_name: appName,
                    weight: 10
                });

            if (voteError) throw voteError;

            // 4. Ledger Entries
            // We do explicit inserts for clarity in the ledger since we are manipulating different scores.
             await window.supabase.from('economy_ledger').insert([
                 { user_id: currentUser.id, domain: 'governance', amount: -10, reason: `Reputation spent on vote: ${appName}` },
                 { user_id: currentUser.id, domain: 'governance', amount: 5, reason: `Curation reward for voting: ${appName}` }
             ]);

            // Success
            reputation = newRep;
            curation = newCur;
            updateBalanceUI();

            msg.className = 'message success';
            msg.innerText = `Vote Cast! You earned 5 Curation Power.`;

            // Reroll candidates? Or disable button?
            // Let's just disable buttons for this round or refresh candidates?
            // "Voting successfully grants +5 Curation Score."
            // Let's reroll candidates to encourage more voting.
            setTimeout(() => {
                msg.innerText = '';
                renderCandidates();
            }, 2000);

        } catch (e) {
            console.error(e);
            msg.className = 'message error';
            msg.innerText = 'Voting failed: ' + e.message;
        }
    };

    window.addEventListener('load', init);

  </script>
</body>
</html>
