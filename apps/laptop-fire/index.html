<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laptop Fire Fighter - Put Out the Flames!</title>
    <link rel="icon" href="https://emojicdn.elk.sh/🔥" type="image/png">

    <!-- Open Graph tags -->
    <meta property="og:title" content="Laptop Fire Fighter - Put Out the Flames!">
    <meta property="og:description" content="Quick! Click to extinguish burning laptops before they're destroyed!">
    <meta property="og:url" content="https://app.vibecodedbyx.com/laptop-fire">
    <meta property="og:image" content="https://app.vibecodedbyx.com/laptop-fire/preview.png">
    <meta name="description" content="Quick! Click to extinguish burning laptops before they're destroyed! Compete on the global leaderboard.">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 50% 50%, rgba(255, 50, 50, 0.1) 0%, transparent 70%);
            animation: pulse-danger 2s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes pulse-danger {
            0%, 100% {
                opacity: 0.3;
                transform: scale(1);
            }
            50% {
                opacity: 0.6;
                transform: scale(1.05);
            }
        }

        .danger-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1;
        }

        .smoke-particle {
            position: absolute;
            font-size: 40px;
            opacity: 0.3;
            animation: float-smoke 8s linear infinite;
            pointer-events: none;
        }

        @keyframes float-smoke {
            0% {
                transform: translateY(100vh) translateX(0) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.4;
            }
            90% {
                opacity: 0.4;
            }
            100% {
                transform: translateY(-100px) translateX(50px) rotate(180deg);
                opacity: 0;
            }
        }

        .spark {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #ff6b00;
            border-radius: 50%;
            animation: spark-rise 3s ease-out infinite;
            pointer-events: none;
            box-shadow: 0 0 6px #ff6b00;
        }

        @keyframes spark-rise {
            0% {
                transform: translateY(0) translateX(0);
                opacity: 1;
            }
            100% {
                transform: translateY(-200px) translateX(var(--spark-drift));
                opacity: 0;
            }
        }

        body.low-health {
            animation: screen-shake 0.5s ease-in-out infinite;
        }

        @keyframes screen-shake {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-2px, 2px); }
            20% { transform: translate(2px, -2px); }
            30% { transform: translate(-2px, -2px); }
            40% { transform: translate(2px, 2px); }
            50% { transform: translate(-2px, 2px); }
            60% { transform: translate(2px, -2px); }
            70% { transform: translate(-2px, -2px); }
            80% { transform: translate(2px, 2px); }
            90% { transform: translate(-2px, 2px); }
        }

        .header {
            padding: 20px;
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 2px solid #ff6b6b;
            position: relative;
            z-index: 10;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .stat {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .score {
            color: #51cf66;
        }

        .health {
            color: #ff6b6b;
        }

        .game-area {
            flex: 1;
            position: relative;
            overflow: hidden;
            z-index: 5;
        }

        .top-actions {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 20;
        }

        .small-btn {
            padding: 8px 14px;
            font-size: 0.9rem;
            background: #364fc7;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .small-btn:hover { background: #3b5bdb; }

        .laptop {
            position: absolute;
            width: 100px;
            height: 80px;
            cursor: pointer;
            transition: transform 0.1s;
            user-select: none;
        }

        .laptop:hover {
            transform: scale(1.1);
        }

        .laptop-body {
            font-size: 60px;
            text-align: center;
            position: relative;
        }

        .fire {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 50px;
            animation: flicker 0.2s infinite alternate;
            filter: drop-shadow(0 0 10px rgba(255, 100, 0, 0.8));
        }

        .fire::before,
        .fire::after {
            content: '🔥';
            position: absolute;
            font-size: 30px;
            animation: flicker-small 0.3s infinite alternate;
        }

        .fire::before {
            left: -25px;
            top: 5px;
            animation-delay: 0.1s;
        }

        .fire::after {
            right: -25px;
            top: 5px;
            animation-delay: 0.2s;
        }

        @keyframes flicker {
            0% {
                opacity: 0.8;
                transform: translateX(-50%) scale(1) rotate(-5deg);
                filter: drop-shadow(0 0 10px rgba(255, 100, 0, 0.8)) hue-rotate(0deg);
            }
            25% {
                opacity: 1;
                transform: translateX(-50%) scale(1.15) rotate(5deg);
            }
            50% {
                opacity: 0.9;
                transform: translateX(-50%) scale(1.05) rotate(-3deg);
            }
            75% {
                opacity: 1;
                transform: translateX(-50%) scale(1.2) rotate(3deg);
            }
            100% {
                opacity: 0.95;
                transform: translateX(-50%) scale(1.1) rotate(-5deg);
                filter: drop-shadow(0 0 15px rgba(255, 50, 0, 1)) hue-rotate(10deg);
            }
        }

        @keyframes flicker-small {
            0% {
                opacity: 0.6;
                transform: scale(0.8) translateY(0);
            }
            100% {
                opacity: 1;
                transform: scale(1.1) translateY(-5px);
            }
        }

        .water-splash {
            position: absolute;
            font-size: 30px;
            pointer-events: none;
            animation: splash 0.5s ease-out forwards;
        }

        @keyframes splash {
            0% {
                opacity: 1;
                transform: scale(0.5);
            }
            100% {
                opacity: 0;
                transform: scale(2);
            }
        }

        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(0, 0, 0, 0.9);
            padding: 40px;
            border-radius: 20px;
            border: 3px solid #ff6b6b;
            display: none;
        }

        .game-over.show {
            display: block;
        }

        .game-over h2 {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #ff6b6b;
        }

        .game-over p {
            font-size: 1.5rem;
            margin-bottom: 30px;
        }

        .btn {
            padding: 15px 40px;
            font-size: 1.2rem;
            background: #51cf66;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #40c057;
            transform: scale(1.05);
        }

        .save-row {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .input {
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid #444;
            background: #111;
            color: #fff;
            min-width: 220px;
        }

        .error { color: #ff8787; margin-top: 6px; font-size: 0.95rem; }
        .success { color: #69db7c; margin-top: 6px; font-size: 0.95rem; }

        .leaderboard-panel {
            position: absolute;
            top: 0; right: 0;
            width: min(360px, 90vw);
            height: 100%;
            background: rgba(0,0,0,0.92);
            border-left: 2px solid #ff6b6b;
            transform: translateX(100%);
            transition: transform 0.25s ease-out;
            z-index: 30;
            display: flex;
            flex-direction: column;
        }
        .leaderboard-panel.show { transform: translateX(0); }
        .lb-header { display:flex; align-items:center; justify-content:space-between; padding:16px; border-bottom:1px solid #333; }
        .lb-title { font-weight: 800; font-size: 1.1rem; }
        .lb-close { background:#222; color:#fff; border:1px solid #333; border-radius:8px; padding:6px 10px; cursor:pointer; }
        .lb-list { padding: 14px 18px; overflow:auto; }
        .lb-item { display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px dashed #333; }
        .lb-rank { font-weight:800; color:#ffd43b; width: 28px; }
        .lb-name { flex:1; margin-left: 8px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .lb-score { color:#69db7c; font-weight:700; }
        .lb-empty { padding: 16px; color:#aaa; }

        .footer {
            padding: 15px;
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            border-top: 2px solid #ff6b6b;
            position: relative;
            z-index: 10;
        }

        .footer a {
            color: #51cf66;
            text-decoration: none;
            font-weight: bold;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .stats {
                gap: 15px;
            }

            .stat {
                font-size: 1rem;
            }

            .laptop {
                width: 80px;
                height: 64px;
            }

            .laptop-body {
                font-size: 48px;
            }

            .fire {
                font-size: 32px;
                top: -24px;
            }

            .game-over h2 {
                font-size: 2rem;
            }

            .game-over p {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <div class="danger-overlay" id="dangerOverlay"></div>

    <div class="header">
        <h1>🔥 Laptop Fire Fighter 💧</h1>
        <div class="stats">
            <div class="stat">Score: <span class="score" id="score">0</span></div>
            <div class="stat">Health: <span class="health" id="health">100</span></div>
            <div class="stat">Level: <span id="level">1</span></div>
            <div class="stat">Timer: <span id="timer">45</span>s</div>
        </div>
    </div>

    <div class="game-area" id="gameArea">
        <div class="top-actions">
            <button class="small-btn" id="leaderboardBtn">🏆 Leaderboard</button>
        </div>
    </div>

    <div class="game-over" id="gameOver">
        <h2>🔥 Game Over! 🔥</h2>
        <p>Your score: <span id="finalScore">0</span></p>
        <div class="save-row">
            <input id="displayName" class="input" placeholder="Your name or handle" maxlength="24" />
            <button class="btn" id="saveScoreBtn">Save Score</button>
        </div>
        <div id="saveMsg" class="error" style="display:none"></div>
        <div style="margin-top:16px">
            <button class="btn" onclick="restartGame()">Try Again</button>
        </div>
    </div>

    <div class="footer">
        <a href="https://www.vibecodedbyx.com" target="_blank">← Back to VibeCodedByX.com</a>
    </div>

    <!-- Leaderboard side panel -->
    <aside class="leaderboard-panel" id="leaderboardPanel" aria-hidden="true">
        <div class="lb-header">
            <div class="lb-title">🏆 Top Fire Fighters</div>
            <button class="lb-close" id="lbClose">Close</button>
        </div>
        <div class="lb-list" id="leaderboardList">
            <div class="lb-empty">No scores yet. Be the first!</div>
        </div>
        <div style="padding: 12px; border-top:1px solid #333; font-size:0.95rem; color:#aaa">
            Your best: <span id="yourBest">–</span>
        </div>
    </aside>

    <!-- Elements referenced by shared supabase-config.js -->
    <div id="premium-content" style="display:none"></div>
    <button id="upgrade-button" style="display:none"></button>

    <script type="module">
        import supabase, { supabaseSession, isUserPremium } from "./supabase-config.js";

        let score = 0;
        let health = 100;
        let level = 1;
        let gameActive = true;
        let laptops = [];
        let spawnRate = 1600; // faster to make rounds shorter
        let damageRate = 1200; // faster tick for more tension
        let laptopId = 0;
        let timeLeft = 45; // seconds
        let spawnTimeout = null;
        let damageTimeout = null;
        let powerupTimeout = null;
        let multiplier = 1; // premium users get a boost
        let user = null;
        let saving = false;

        const gameArea = document.getElementById('gameArea');
        const scoreEl = document.getElementById('score');
        const healthEl = document.getElementById('health');
        const levelEl = document.getElementById('level');
        const gameOverEl = document.getElementById('gameOver');
        const finalScoreEl = document.getElementById('finalScore');
        const dangerOverlay = document.getElementById('dangerOverlay');
        const timerEl = document.getElementById('timer');
        const leaderboardBtn = document.getElementById('leaderboardBtn');
        const leaderboardPanel = document.getElementById('leaderboardPanel');
        const leaderboardList = document.getElementById('leaderboardList');
        const lbClose = document.getElementById('lbClose');
        const saveScoreBtn = document.getElementById('saveScoreBtn');
        const saveMsg = document.getElementById('saveMsg');
        const displayNameInput = document.getElementById('displayName');

        // Create background effects
        function createSmokeParticle() {
            const smoke = document.createElement('div');
            smoke.className = 'smoke-particle';
            smoke.textContent = '💨';
            smoke.style.left = Math.random() * window.innerWidth + 'px';
            smoke.style.bottom = '0px';
            smoke.style.animationDelay = Math.random() * 2 + 's';
            dangerOverlay.appendChild(smoke);

            setTimeout(() => smoke.remove(), 8000);
        }

        function createSpark(x, y) {
            const spark = document.createElement('div');
            spark.className = 'spark';
            spark.style.left = x + 'px';
            spark.style.top = y + 'px';
            spark.style.setProperty('--spark-drift', (Math.random() * 40 - 20) + 'px');
            spark.style.animationDelay = Math.random() * 0.5 + 's';
            dangerOverlay.appendChild(spark);

            setTimeout(() => spark.remove(), 3000);
        }

        // Spawn background effects periodically
        setInterval(() => {
            if (gameActive) {
                createSmokeParticle();
            }
        }, 2000);

        // Create sparks from burning laptops
        setInterval(() => {
            if (gameActive && laptops.length > 0) {
                laptops.forEach(laptop => {
                    if (Math.random() > 0.7) {
                        const rect = laptop.element.getBoundingClientRect();
                        createSpark(rect.left + rect.width / 2, rect.top);
                    }
                });
            }
        }, 500);

        function spawnLaptop() {
            if (!gameActive) return;

            const laptop = document.createElement('div');
            laptop.className = 'laptop';
            laptop.id = 'laptop-' + laptopId++;

            const maxX = gameArea.clientWidth - 100;
            const maxY = gameArea.clientHeight - 80;

            laptop.style.left = Math.random() * maxX + 'px';
            laptop.style.top = Math.random() * maxY + 'px';

            laptop.innerHTML = `
                <div class="fire">🔥</div>
                <div class="laptop-body">💻</div>
            `;

            const laptopData = {
                element: laptop,
                id: laptop.id,
                spawnTime: Date.now()
            };

            laptop.addEventListener('click', () => extinguish(laptopData));

            gameArea.appendChild(laptop);
            laptops.push(laptopData);
        }

        function extinguish(laptopData) {
            if (!gameActive) return;

            const laptop = laptopData.element;

            // Create water splash effect
            const splash = document.createElement('div');
            splash.className = 'water-splash';
            splash.textContent = '💧';
            splash.style.left = laptop.offsetLeft + 50 + 'px';
            splash.style.top = laptop.offsetTop + 40 + 'px';
            gameArea.appendChild(splash);

            setTimeout(() => splash.remove(), 500);

            // Update score (premium multiplier, level scaling)
            score += Math.round(10 * level * multiplier);
            scoreEl.textContent = score;

            // Remove laptop
            laptop.remove();
            laptops = laptops.filter(l => l.id !== laptopData.id);

            // Level up every 80 points for faster pacing
            if (score > 0 && score % 80 === 0) {
                levelUp();
            }
        }

        function levelUp() {
            level++;
            levelEl.textContent = level;
            spawnRate = Math.max(600, spawnRate - 180);
            damageRate = Math.max(900, damageRate - 90);
            // Reschedule loops to apply new rates
            scheduleSpawn();
            scheduleDamage();
        }

        function damageHealth() {
            if (!gameActive) return;

            // Damage health based on number of burning laptops
            const damage = Math.max(1, Math.ceil(laptops.length * 2.5));
            health = Math.max(0, health - damage);
            healthEl.textContent = health;

            // Add screen shake when health is low
            if (health <= 30 && health > 0) {
                document.body.classList.add('low-health');
            } else {
                document.body.classList.remove('low-health');
            }

            if (health <= 0) {
                endGame();
            }
        }

        function endGame() {
            gameActive = false;
            finalScoreEl.textContent = score;
            gameOverEl.classList.add('show');

            // Remove all laptops
            laptops.forEach(l => l.element.remove());
            laptops = [];

            // Clear scheduled timeouts
            clearTimeout(spawnTimeout);
            clearTimeout(damageTimeout);
            clearTimeout(powerupTimeout);
        }

        window.restartGame = function restartGame() {
            score = 0;
            health = 100;
            level = 1;
            gameActive = true;
            spawnRate = 1600;
            damageRate = 1200;
            laptops = [];
            timeLeft = 45;
            timerEl.textContent = timeLeft;

            scoreEl.textContent = score;
            healthEl.textContent = health;
            levelEl.textContent = level;
            gameOverEl.classList.remove('show');
            document.body.classList.remove('low-health');

            startGame();
        }

        function scheduleSpawn() {
            clearTimeout(spawnTimeout);
            if (!gameActive) return;
            spawnTimeout = setTimeout(() => {
                spawnLaptop();
                scheduleSpawn();
            }, spawnRate);
        }

        function scheduleDamage() {
            clearTimeout(damageTimeout);
            if (!gameActive) return;
            damageTimeout = setTimeout(() => {
                damageHealth();
                scheduleDamage();
            }, damageRate);
        }

        function spawnPowerup() {
            if (!gameActive) return;
            const chance = Math.random();
            if (chance < 0.45) { // fairly frequent to add excitement
                const p = document.createElement('div');
                p.className = 'laptop';
                p.style.width = '72px';
                p.style.height = '58px';
                p.style.filter = 'hue-rotate(180deg)';
                p.innerHTML = `<div class=\"laptop-body\">🧯</div>`;
                const maxX = gameArea.clientWidth - 72;
                const maxY = gameArea.clientHeight - 58;
                p.style.left = Math.random() * maxX + 'px';
                p.style.top = Math.random() * maxY + 'px';
                const cleanup = () => { try { p.remove(); } catch(e){} };
                p.addEventListener('click', () => {
                    // Clear all fires and grant bonus
                    laptops.forEach(l => l.element.remove());
                    laptops = [];
                    score += Math.round(30 * multiplier);
                    scoreEl.textContent = score;
                    cleanup();
                });
                gameArea.appendChild(p);
                setTimeout(cleanup, 3500);
            }
            powerupTimeout = setTimeout(spawnPowerup, 7000);
        }

        function startTimer() {
            const tick = () => {
                if (!gameActive) return;
                timeLeft -= 1;
                timerEl.textContent = timeLeft;
                if (timeLeft <= 0) {
                    endGame();
                } else {
                    setTimeout(tick, 1000);
                }
            };
            setTimeout(tick, 1000);
        }

        async function startGame() {
            // Ensure auth session exists
            try {
                const s = await supabaseSession();
                user = s.user;
            } catch (e) {
                console.error('Auth/session error:', e);
            }

            // Premium multiplier
            try {
                if (await isUserPremium()) {
                    multiplier = 1.5;
                }
            } catch (e) {
                // ignore premium check errors
            }

            scheduleSpawn();
            scheduleDamage();
            setTimeout(spawnPowerup, 4000);
            startTimer();
        }

        async function fetchLeaderboard() {
            try {
                const { data, error } = await supabase
                    .from('laptop_fire_scores')
                    .select('display_name, score, created_at')
                    .order('score', { ascending: false })
                    .limit(10);
                if (error) throw error;

                leaderboardList.innerHTML = '';
                if (!data || data.length === 0) {
                    const div = document.createElement('div');
                    div.className = 'lb-empty';
                    div.textContent = 'No scores yet. Be the first!';
                    leaderboardList.appendChild(div);
                } else {
                    data.forEach((row, i) => {
                        const item = document.createElement('div');
                        item.className = 'lb-item';
                        const name = row.display_name || 'Anonymous';
                        item.innerHTML = `<div class=\"lb-rank\">${i+1}</div><div class=\"lb-name\">${name}</div><div class=\"lb-score\">${row.score}</div>`;
                        leaderboardList.appendChild(item);
                    });
                }

                // Fetch your best
                if (user?.id) {
                    const { data: best, error: bestErr } = await supabase
                        .from('laptop_fire_scores')
                        .select('score')
                        .eq('user_id', user.id)
                        .order('score', { ascending: false })
                        .limit(1)
                        .maybeSingle();
                    if (!bestErr && best?.score != null) {
                        document.getElementById('yourBest').textContent = best.score;
                    } else {
                        document.getElementById('yourBest').textContent = '–';
                    }
                }
            } catch (e) {
                console.error('Leaderboard load failed:', e);
                leaderboardList.innerHTML = '<div class="lb-empty">Failed to load leaderboard. Please try again later.</div>';
            }
        }

        async function saveScore() {
            if (saving) return;
            saving = true;
            saveMsg.style.display = 'none';
            saveMsg.className = 'error';
            try {
                const name = (displayNameInput.value || '').trim().slice(0, 24) || 'Anonymous';
                if (!user?.id) {
                    const s = await supabaseSession();
                    user = s.user;
                }
                const { error } = await supabase
                    .from('laptop_fire_scores')
                    .insert({
                        user_id: user?.id,
                        display_name: name,
                        score: score,
                        elapsed_ms: (45 - timeLeft) * 1000,
                        level_reached: level
                    });
                if (error) throw error;
                saveMsg.textContent = 'Score saved!';
                saveMsg.className = 'success';
                saveMsg.style.display = 'block';
                fetchLeaderboard();
            } catch (e) {
                console.error('Save failed:', e);
                saveMsg.textContent = 'Could not save score. Please try again.';
                saveMsg.className = 'error';
                saveMsg.style.display = 'block';
            } finally {
                saving = false;
            }
        }

        // Wire up UI actions
        leaderboardBtn.addEventListener('click', async () => {
            leaderboardPanel.classList.add('show');
            leaderboardPanel.setAttribute('aria-hidden', 'false');
            await fetchLeaderboard();
        });
        lbClose.addEventListener('click', () => {
            leaderboardPanel.classList.remove('show');
            leaderboardPanel.setAttribute('aria-hidden', 'true');
        });
        saveScoreBtn.addEventListener('click', saveScore);

        // Start the game
        startGame();
    </script>
</body>
</html>
