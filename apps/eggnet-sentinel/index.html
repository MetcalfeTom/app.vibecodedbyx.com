<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Eggnet Sentinel — Sonic Counter Surveillance</title>
    <meta
      name="description"
      content="Man the Eggnet Sentinel desk, scan identities from Sonic's world, and decide who gets clearance or detention."
    />
    <meta property="og:title" content="Eggnet Sentinel — Sonic Counter Surveillance" />
    <meta
      property="og:description"
      content="Balance Eggman loyalty and Sonic infiltration intel in this live security desk sim." />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://app.vibecodedbyx.com/eggnet-sentinel/" />
    <meta property="og:image" content="./og-image.svg" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Eggnet Sentinel — Sonic Counter Surveillance" />
    <meta
      name="twitter:description"
      content="Intercept Resistance infiltrators, process Eggman troopers, and keep the command deck secure." />
    <meta name="twitter:image" content="./og-image.svg" />
    <link rel="icon" href="./favicon.svg" type="image/svg+xml" />
    <meta name="theme-color" content="#0b0f2c" />
    <style>
      :root {
        color-scheme: dark;
        font-family: "Chakra Petch", "Inter", "Segoe UI", sans-serif;
        --bg-grad: radial-gradient(circle at 14% -10%, rgba(95, 162, 255, 0.28), transparent 60%),
          radial-gradient(circle at 80% 120%, rgba(255, 103, 164, 0.28), transparent 68%),
          #040619;
        --terminal: rgba(12, 18, 50, 0.92);
        --panel: rgba(15, 22, 58, 0.88);
        --panel-alt: rgba(10, 18, 44, 0.8);
        --accent: #ffd54f;
        --accent-soft: rgba(255, 213, 79, 0.2);
        --accent-bright: #ff5e9b;
        --success: #7cf6d2;
        --danger: #ff6580;
        --warning: #ffc266;
        --text: #f5f6ff;
        --text-muted: rgba(245, 246, 255, 0.7);
        --border: rgba(255, 255, 255, 0.14);
        --glow: rgba(110, 177, 255, 0.35);
        --shadow-strong: 0 22px 42px rgba(4, 10, 32, 0.6);
        --shadow-soft: 0 16px 26px rgba(6, 14, 42, 0.46);
      }

      *, *::before, *::after {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: var(--bg-grad);
        color: var(--text);
        display: flex;
        justify-content: center;
        align-items: stretch;
        padding: clamp(18px, 4vw, 56px);
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 200 200'%3E%3Cg fill='rgba(76,128,255,0.18)'%3E%3Ccircle cx='20' cy='30' r='1.5'/%3E%3Ccircle cx='160' cy='18' r='1.2'/%3E%3Ccircle cx='60' cy='110' r='1.3'/%3E%3Ccircle cx='120' cy='176' r='1.1'/%3E%3Ccircle cx='24' cy='170' r='1.1'/%3E%3Ccircle cx='188' cy='128' r='1.4'/%3E%3Ccircle cx='96' cy='40' r='1.4'/%3E%3Ccircle cx='150' cy='86' r='1.2'/%3E%3Ccircle cx='84' cy='150' r='1.3'/%3E%3C/g%3E%3C/svg%3E");
        pointer-events: none;
        opacity: 0.36;
        mix-blend-mode: screen;
      }

      .app-shell {
        width: min(1200px, 100%);
        display: grid;
        gap: clamp(20px, 4vw, 34px);
        position: relative;
        z-index: 1;
      }

      header {
        background: var(--terminal);
        border-radius: 28px;
        padding: clamp(20px, 4vw, 38px);
        border: 1px solid var(--border);
        display: grid;
        gap: 18px;
        box-shadow: var(--shadow-strong);
      }

      .hero-top {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        justify-content: space-between;
        align-items: flex-start;
      }

      .hero-copy {
        max-width: 640px;
        display: grid;
        gap: 8px;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(255, 255, 255, 0.08);
        letter-spacing: 0.16em;
        text-transform: uppercase;
        font-size: 0.82rem;
        color: var(--text-muted);
      }

      h1 {
        margin: 0;
        font-size: clamp(2.5rem, 6vw, 3.6rem);
        letter-spacing: 0.1em;
        text-transform: uppercase;
        text-shadow: 0 0 36px var(--glow);
      }

      header p {
        margin: 0;
        color: var(--text-muted);
        line-height: 1.6;
      }

      .hero-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .backlink {
        justify-self: start;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: rgba(255, 255, 255, 0.08);
        color: var(--text);
        text-decoration: none;
        transition: transform 0.2s ease, background 0.2s ease;
      }

      .backlink:hover,
      .backlink:focus-visible {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-1px);
        outline: none;
      }

      .btn {
        appearance: none;
        border-radius: 16px;
        border: 1px solid transparent;
        padding: 12px 20px;
        font-size: 0.95rem;
        font-weight: 600;
        font-family: inherit;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease;
        color: #05060d;
        background: var(--accent);
        box-shadow: 0 14px 26px rgba(255, 213, 79, 0.32);
      }

      .btn:hover:enabled,
      .btn:focus-visible:enabled {
        transform: translateY(-1px);
        box-shadow: 0 18px 30px rgba(255, 213, 79, 0.4);
        outline: none;
      }

      .btn:disabled {
        opacity: 0.45;
        cursor: not-allowed;
        box-shadow: none;
      }

      .btn.secondary {
        color: var(--text);
        background: transparent;
        border-color: rgba(255, 255, 255, 0.18);
        box-shadow: none;
      }

      .btn.secondary:hover:enabled,
      .btn.secondary:focus-visible:enabled {
        background: rgba(255, 255, 255, 0.12);
      }

      .btn.danger {
        color: #20030e;
        background: var(--danger);
        box-shadow: 0 14px 26px rgba(255, 101, 128, 0.38);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: clamp(14px, 3vw, 22px);
      }

      .stat {
        background: var(--panel);
        border-radius: 22px;
        padding: 16px 18px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        position: relative;
        display: grid;
        gap: 6px;
        overflow: hidden;
        box-shadow: var(--shadow-soft);
      }

      .stat::after {
        content: "";
        position: absolute;
        inset: -35% -25% auto -25%;
        height: 80%;
        background: linear-gradient(120deg, rgba(255, 255, 255, 0.12), transparent 70%);
        pointer-events: none;
        opacity: 0.5;
      }

      .stat-label {
        letter-spacing: 0.16em;
        font-size: 0.7rem;
        text-transform: uppercase;
        color: var(--text-muted);
      }

      .stat-value {
        font-size: clamp(1.5rem, 2.7vw, 2rem);
        font-weight: 600;
      }

      .stat-small {
        font-size: clamp(1rem, 2.5vw, 1.3rem);
      }

      .status-line {
        margin: 0;
        padding: 14px 18px;
        border-radius: 18px;
        background: var(--panel-alt);
        border: 1px solid rgba(255, 255, 255, 0.14);
        color: var(--text-muted);
        box-shadow: var(--shadow-soft);
      }

      .terminal {
        display: grid;
        gap: clamp(18px, 3vw, 28px);
        grid-template-columns: minmax(0, 3fr) minmax(0, 2fr);
        align-items: stretch;
      }

      .subject-card {
        background: var(--panel);
        border-radius: 28px;
        padding: clamp(20px, 3vw, 30px);
        border: 1px solid rgba(255, 255, 255, 0.14);
        display: grid;
        gap: 18px;
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow-strong);
      }

      .subject-card::before {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at 18% 18%, rgba(255, 255, 255, 0.08), transparent 65%);
        opacity: 0.6;
        pointer-events: none;
      }

      .subject-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 12px;
        position: relative;
        z-index: 1;
      }

      .subject-header span {
        letter-spacing: 0.18em;
        color: var(--text-muted);
        font-size: 0.85rem;
        text-transform: uppercase;
      }

      .portrait-frame {
        border-radius: 24px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: linear-gradient(160deg, rgba(255, 255, 255, 0.1), transparent 70%);
        min-height: 240px;
        display: grid;
        place-items: center;
        padding: clamp(18px, 3vw, 28px);
        position: relative;
        overflow: hidden;
      }

      .portrait-frame svg {
        width: min(240px, 100%);
        height: auto;
        filter: drop-shadow(0 14px 20px rgba(0, 0, 0, 0.36));
      }

      .portrait-placeholder {
        font-size: clamp(2.2rem, 8vw, 3.2rem);
        color: var(--text-muted);
      }

      .subject-meta {
        display: grid;
        gap: 6px;
        position: relative;
        z-index: 1;
      }

      .subject-meta h2 {
        margin: 0;
        font-size: clamp(1.8rem, 5vw, 2.3rem);
      }

      .subject-meta p {
        margin: 0;
        color: var(--text-muted);
      }

      .spec-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 12px;
        position: relative;
        z-index: 1;
      }

      .spec {
        padding: 12px 14px;
        border-radius: 16px;
        background: rgba(6, 12, 32, 0.42);
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: grid;
        gap: 4px;
      }

      .spec dt {
        margin: 0;
        font-size: 0.72rem;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        color: var(--text-muted);
      }

      .spec dd {
        margin: 0;
        font-family: "IBM Plex Mono", monospace;
        font-size: 0.92rem;
      }

      .intel-chip {
        padding: 14px 16px;
        border-radius: 18px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.16);
        color: var(--text-muted);
        line-height: 1.5;
        position: relative;
        z-index: 1;
      }

      .decision-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        position: relative;
        z-index: 1;
      }

      .intel-panel {
        display: grid;
        gap: 18px;
        background: var(--panel-alt);
        border-radius: 28px;
        padding: clamp(20px, 3vw, 30px);
        border: 1px solid rgba(255, 255, 255, 0.16);
        box-shadow: var(--shadow-soft);
      }

      .panel-title {
        margin: 0 0 8px;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        font-size: 1.05rem;
      }

      .rules-list {
        margin: 0;
        padding-left: 18px;
        display: grid;
        gap: 8px;
        color: var(--text-muted);
      }

      .intel-output {
        min-height: 90px;
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: rgba(6, 12, 32, 0.42);
        padding: 12px 14px;
        font-size: 0.92rem;
        line-height: 1.5;
        color: var(--text-muted);
      }

      .intel-output div {
        padding: 6px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }

      .intel-output div:last-child {
        border-bottom: none;
      }

      .logs-grid {
        display: grid;
        gap: clamp(16px, 3vw, 26px);
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }

      .log-card,
      .notes-card {
        background: var(--panel);
        border-radius: 24px;
        padding: clamp(18px, 3vw, 28px);
        border: 1px solid rgba(255, 255, 255, 0.14);
        box-shadow: var(--shadow-soft);
        display: grid;
        gap: 12px;
      }

      .log-stream {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 240px;
        overflow-y: auto;
        font-family: "IBM Plex Mono", monospace;
        font-size: 0.86rem;
      }

      .log-stream span {
        padding: 10px 12px;
        border-radius: 12px;
        background: rgba(6, 12, 32, 0.58);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .notes-list {
        margin: 0;
        display: grid;
        gap: 10px;
      }

      .notes-list dt {
        font-size: 0.76rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: var(--text-muted);
      }

      .notes-list dd {
        margin: 0;
        font-size: 0.95rem;
        line-height: 1.5;
      }

      .premium-card,
      .upgrade-card {
        background: var(--panel-alt);
        border-radius: 26px;
        padding: clamp(18px, 3vw, 28px);
        border: 1px solid rgba(255, 255, 255, 0.14);
        box-shadow: var(--shadow-soft);
        display: grid;
        gap: 16px;
      }

      .picker-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 12px;
      }

      label span {
        display: block;
        margin-bottom: 6px;
        color: var(--text-muted);
        font-size: 0.88rem;
      }

      input[type="color"] {
        width: 100%;
        height: 48px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        border-radius: 14px;
        background: transparent;
        cursor: pointer;
      }

      .toggle {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        color: var(--text-muted);
        font-size: 0.95rem;
      }

      .toggle input {
        width: 18px;
        height: 18px;
      }

      footer {
        text-align: center;
        color: var(--text-muted);
        font-size: 0.92rem;
      }

      .hidden {
        display: none !important;
      }

      @media (max-width: 1024px) {
        .terminal {
          grid-template-columns: 1fr;
        }

        .hero-top {
          flex-direction: column;
          align-items: flex-start;
        }
      }

      @media (max-width: 640px) {
        body {
          padding: 16px;
        }

        .hero-actions {
          flex-direction: column;
          width: 100%;
        }

        .btn,
        .btn.secondary,
        .btn.danger {
          width: 100%;
          justify-content: center;
        }

        .stats-grid {
          grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
        }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <header>
        <div class="hero-top">
          <div class="hero-copy">
            <span class="badge">Eggnet Sentinel Desk</span>
            <h1>Eggman Counter Ops</h1>
            <p>
              Monitor the command deck, process Eggman personnel, and intercept Sonic's Resistance agents before they breach
              the fleet.
            </p>
          </div>
          <div class="hero-actions">
            <button class="btn" id="start-btn" type="button">Start shift</button>
            <button class="btn secondary" id="reset-btn" type="button" disabled>Reset console</button>
            <button class="btn secondary" id="skip-btn" type="button" disabled>Skip dossier</button>
          </div>
        </div>
        <a class="backlink" href="https://www.vibecodedbyx.com" target="_blank" rel="noreferrer noopener"
          >⬅ Back to the livestream</a
        >
      </header>

      <section class="stats-grid" aria-label="Shift stats">
        <div class="stat">
          <span class="stat-label">Ring score</span>
          <span class="stat-value" id="score-value">0</span>
        </div>
        <div class="stat">
          <span class="stat-label">Profiles processed</span>
          <span class="stat-value stat-small" id="cases-value">0 / 0</span>
        </div>
        <div class="stat">
          <span class="stat-label">Accuracy</span>
          <span class="stat-value stat-small" id="accuracy-value">—</span>
        </div>
        <div class="stat">
          <span class="stat-label">Alerts remaining</span>
          <span class="stat-value stat-small" id="alerts-value">3</span>
        </div>
        <div class="stat">
          <span class="stat-label">Shift timer</span>
          <span class="stat-value stat-small" id="timer-value">70.0s</span>
        </div>
        <div class="stat">
          <span class="stat-label">Personal best</span>
          <span class="stat-value stat-small" id="highscore-value">0</span>
        </div>
      </section>

      <p class="status-line" id="status-message">Console idle. Spin up the scanners when ready.</p>

      <section class="terminal">
        <article class="subject-card">
          <div class="subject-header">
            <span id="case-banner">Awaiting identity...</span>
            <span id="subject-id">EGG-0000</span>
          </div>
          <div class="portrait-frame" id="portrait" aria-hidden="true">
            <div class="portrait-placeholder">🛰️</div>
          </div>
          <div class="subject-meta">
            <h2 id="subject-name">No subject loaded</h2>
            <p id="subject-role">Connect to Eggnet to receive dossiers.</p>
          </div>
          <div class="spec-grid" aria-label="Subject readout">
            <dl class="spec">
              <dt>Affiliation</dt>
              <dd id="subject-affiliation">—</dd>
            </dl>
            <dl class="spec">
              <dt>Clearance</dt>
              <dd id="subject-clearance">—</dd>
            </dl>
            <dl class="spec">
              <dt>Mission</dt>
              <dd id="subject-mission">—</dd>
            </dl>
            <dl class="spec">
              <dt>Chaos flux</dt>
              <dd id="subject-chaos">—</dd>
            </dl>
            <dl class="spec">
              <dt>Ring signature</dt>
              <dd id="subject-rings">—</dd>
            </dl>
            <dl class="spec">
              <dt>Gear</dt>
              <dd id="subject-gear">—</dd>
            </dl>
            <dl class="spec">
              <dt>Passcode</dt>
              <dd id="subject-passcode">—</dd>
            </dl>
          </div>
          <div class="intel-chip" id="intel-chip">Briefings arrive once a shift is active.</div>
          <div class="decision-row">
            <button class="btn" id="approve-btn" type="button" disabled>Grant clearance</button>
            <button class="btn danger" id="deny-btn" type="button" disabled>Detain subject</button>
          </div>
        </article>

        <aside class="intel-panel">
          <div>
            <h3 class="panel-title">Security doctrine</h3>
            <ol class="rules-list">
              <li>Only <strong>Eggman Empire</strong> loyalists may pass.</li>
              <li>Passcodes must begin with <strong>EGG-</strong> and be current generation.</li>
              <li>Chaos flux over <strong>75 units</strong> triggers detention.</li>
              <li>Banned gear: <strong>Freedom Fighter tech</strong>, <strong>fake Chaos Emeralds</strong>, <strong>ring bombs</strong>.</li>
              <li>Mission clearance must match the assignment whitelist.</li>
            </ol>
          </div>
          <div>
            <h3 class="panel-title">Intel overlays</h3>
            <div class="intel-output" id="intel-output">Enable Intel Mode (premium) to surface likely violations.</div>
          </div>
          <div>
            <h3 class="panel-title">Command chatter</h3>
            <p class="status-line" id="chatter-line">No broadcasts yet.</p>
          </div>
        </aside>
      </section>

      <section class="logs-grid">
        <div class="log-card">
          <h3 class="panel-title">Security log</h3>
          <div class="log-stream" id="log-stream">
            <span>No transmissions recorded yet.</span>
          </div>
        </div>
        <div class="notes-card">
          <h3 class="panel-title">Field notes</h3>
          <dl class="notes-list">
            <div>
              <dt>Agent quirks</dt>
              <dd id="notes-quirk">—</dd>
            </div>
            <div>
              <dt>Patrol intel</dt>
              <dd id="notes-intel">—</dd>
            </div>
            <div>
              <dt>Support memo</dt>
              <dd id="notes-support">—</dd>
            </div>
          </dl>
        </div>
      </section>

      <section class="premium-card hidden" id="premium-content">
        <h3 class="panel-title">Premium command skin</h3>
        <p class="status-line">
          Premium Sentinels unlock Eggnet color tuning and automated Intel overlays that flag Resistance sabotage instantly.
        </p>
        <form id="premium-form">
          <div class="picker-row">
            <label>
              <span>Deck base</span>
              <input type="color" id="deck-color" name="desk" value="#111a3d" />
            </label>
            <label>
              <span>Accent neon</span>
              <input type="color" id="accent-color" name="accent" value="#ffd54f" />
            </label>
          </div>
          <label class="toggle">
            <input type="checkbox" id="intel-toggle" />
            Engage Intel Mode (auto violations)
          </label>
          <button class="btn" type="submit">Apply desk theme</button>
        </form>
      </section>

      <section class="upgrade-card" id="upgrade-button">
        <h3 class="panel-title">Upgrade for Intel Mode</h3>
        <p class="status-line">
          Resistance intel overlays and custom theming are premium only. Tap upgrade in your profile panel to enlist.
        </p>
      </section>

      <footer>Built live on stream — report your highest detention streak @VibeCodedByX 🛰️🥚</footer>
    </div>

    <script type="module">
      import supabase, { supabaseSession, isUserPremium } from "./supabase-config.js";

      const SHIFT_DURATION = 70_000;
      const CASES_PER_SHIFT = 9;
      const MAX_ALERTS = 3;
      const BANNED_GEAR = ["Freedom Fighter toolkit", "Fake Chaos Emerald", "Ring bomb satchel", "Chili dog dispenser"];

      const MISSION_CLEARANCE = {
        "Airship Patrol": ["Gamma", "Omega"],
        "Prison Control": ["Delta", "Gamma"],
        "Data Vault": ["Omega"],
        "Outer Rim Recon": ["Beta", "Gamma"],
        "Forge Maintenance": ["Alpha", "Beta"],
        "Resistance Sweep": ["Gamma", "Omega"],
      };

      const CHATTER_FEED = [
        "Rouge spotted near Launch Base — double scan badges.",
        "Sonic registered a blue blur on dock nine. Brace for breach.",
        "Egg Pawns report delayed reboots after Resistance EMP pulse.",
        "Metal Sonic requests chaos circuit integrity checks by 1800.",
        "Orbot warns of Resistance spyware disguised as Flicky GIFs.",
      ];

      const SUPPORT_MEMOS = [
        "Reminder: Detain anyone humming the Green Hill theme.",
        "Deploy ring dampeners when chaos flux exceeds 70 units.",
        "Eggnet shields recalibrate in 30 minutes — expect scanner lag.",
        "Premium Sentinels can auto-flag Flux anomalies."
      ];

      const BIG_CAMEO = {
        id: "big",
        name: "Big the Cat",
        role: "Fishing Wanderer",
        baseAffiliation: "Chaotix Freelance",
        symbol: "big",
        palette: { bg: "#1a1d46", glow: "#7c96ff", accent: "#ffd54f", stroke: "#b8c1ff" },
        quirk: "Keeps asking if you've seen Froggy.",
        cameoIntel: "Massive lifeform lumbering through Cargo Bay — Big the Cat confirmed on sensors.",
        cameoSupport: "If you spot Froggy, log it so Big doesn't camp the briefing room all night.",
        cameoGear: "Fishing rod & Froggy locator",
      };

      const KNUCKLES_CAMEO = {
        id: "knuckles",
        name: "Knuckles the Echidna",
        role: "Guardian Envoy",
        baseAffiliation: "Angel Island Patrol",
        symbol: "knuckles",
        palette: { bg: "#300910", glow: "#ff5b5b", accent: "#ffd54f", stroke: "#ffa3a3" },
        quirk: "Demands proof you aren't touching the Master Emerald.",
        cameoIntel: "Guardian class energy spike detected. Knuckles just glided into Hangar 3.",
        cameoSupport: "Reminder: present all Master Emerald handling logs before he punches a hole in the bulkhead.",
        cameoGear: "Spiked gloves & emerald tracker",
      };

      const SUBJECT_BANK = [
        {
          id: "eggman",
          name: "Dr. Eggman",
          role: "Eggnet Architect",
          baseAffiliation: "Eggman Empire",
          symbol: "eggman",
          palette: { bg: "#2c0818", glow: "#ff6c8d", accent: "#ffd54f", stroke: "#ff88b4" },
          quirk: "Demands the lighting match his moustache hue.",
        },
        {
          id: "metal",
          name: "Metal Sonic",
          role: "Enforcer Android",
          baseAffiliation: "Eggman Empire",
          symbol: "metal",
          palette: { bg: "#071238", glow: "#6f89ff", accent: "#ff5d97", stroke: "#8ea6ff" },
          quirk: "Records every eye blink for micro-expression analysis.",
        },
        {
          id: "egg-pawn",
          name: "Egg Pawn",
          role: "Security Trooper",
          baseAffiliation: "Eggman Empire",
          symbol: "pawn",
          palette: { bg: "#1a1e30", glow: "#ffd54f", accent: "#ff758f", stroke: "#ffe27a" },
          quirk: "Requires firmware patch after every chili-dog exposure.",
        },
        {
          id: "sonic",
          name: "Sonic the Hedgehog",
          role: "Resistance Speedster",
          baseAffiliation: "Resistance",
          symbol: "sonic",
          palette: { bg: "#021f4a", glow: "#57a6ff", accent: "#ff5d8b", stroke: "#7cc4ff" },
          quirk: "Leaves faint ozone churn that smells like wind and trouble.",
        },
        {
          id: "tails",
          name: "Miles 'Tails' Prower",
          role: "Resistance Mechanic",
          baseAffiliation: "Resistance",
          symbol: "tails",
          palette: { bg: "#2a1400", glow: "#ffb347", accent: "#4de0ff", stroke: "#ffd27a" },
          quirk: "Carries more gadgets than Eggnet's entire R&D wing.",
        },
        {
          id: "rouge",
          name: "Rouge the Bat",
          role: "Double Agent",
          baseAffiliation: "Chaotix Freelance",
          symbol: "rouge",
          palette: { bg: "#1d0825", glow: "#ff9bd6", accent: "#ffd54f", stroke: "#ffc2f0" },
          quirk: "May accept bribes in jewels or gossip.",
        },
        {
          id: "orbot",
          name: "Orbot & Cubot",
          role: "Command Support",
          baseAffiliation: "Eggman Empire",
          symbol: "orbot",
          palette: { bg: "#081f2c", glow: "#6de0ff", accent: "#ffd54f", stroke: "#99ecff" },
          quirk: "Sarcasm monitor misfires 18 times per shift.",
        },
        {
          id: "shadow",
          name: "Shadow the Hedgehog",
          role: "Ultimate Lifeform",
          baseAffiliation: "Chaotix Freelance",
          symbol: "shadow",
          palette: { bg: "#040204", glow: "#ff4d6f", accent: "#ffd54f", stroke: "#ff7b95" },
          quirk: "Demands perfect latte art for entry.",
        },
      ];

      const RULES = [
        {
          id: "affiliation",
          predicate: (entry) => entry.affiliation === "Eggman Empire",
          message: (entry) => `${entry.name} reports affiliation as ${entry.affiliation}. Eggman loyalty required.`,
        },
        {
          id: "passcode",
          predicate: (entry) => /^EGG-[0-9X]{4}$/.test(entry.passcode),
          message: (entry) => `Passcode ${entry.passcode} fails current Eggnet pattern.`,
        },
        {
          id: "chaos",
          predicate: (entry) => entry.chaosFlux <= 75,
          message: (entry) => `Chaos flux ${entry.chaosFlux} exceeds safe 75 units.`,
        },
        {
          id: "gear",
          predicate: (entry) => !BANNED_GEAR.includes(entry.gear),
          message: (entry) => `${entry.gear} flagged in banned gear manifest.`,
        },
        {
          id: "mission",
          predicate: (entry) => (MISSION_CLEARANCE[entry.mission] || []).includes(entry.clearance),
          message: (entry) => `${entry.clearance} clearance not approved for ${entry.mission}.`,
        },
      ];

      const elements = {
        startBtn: document.getElementById("start-btn"),
        resetBtn: document.getElementById("reset-btn"),
        skipBtn: document.getElementById("skip-btn"),
        approveBtn: document.getElementById("approve-btn"),
        denyBtn: document.getElementById("deny-btn"),
        score: document.getElementById("score-value"),
        cases: document.getElementById("cases-value"),
        accuracy: document.getElementById("accuracy-value"),
        alerts: document.getElementById("alerts-value"),
        timer: document.getElementById("timer-value"),
        highscore: document.getElementById("highscore-value"),
        status: document.getElementById("status-message"),
        banner: document.getElementById("case-banner"),
        subjectId: document.getElementById("subject-id"),
        portrait: document.getElementById("portrait"),
        name: document.getElementById("subject-name"),
        role: document.getElementById("subject-role"),
        affiliation: document.getElementById("subject-affiliation"),
        clearance: document.getElementById("subject-clearance"),
        mission: document.getElementById("subject-mission"),
        chaos: document.getElementById("subject-chaos"),
        rings: document.getElementById("subject-rings"),
        gear: document.getElementById("subject-gear"),
        passcode: document.getElementById("subject-passcode"),
        intelChip: document.getElementById("intel-chip"),
        intelOutput: document.getElementById("intel-output"),
        chatterLine: document.getElementById("chatter-line"),
        logStream: document.getElementById("log-stream"),
        notesQuirk: document.getElementById("notes-quirk"),
        notesIntel: document.getElementById("notes-intel"),
        notesSupport: document.getElementById("notes-support"),
        premiumCard: document.getElementById("premium-content"),
        upgradeCard: document.getElementById("upgrade-button"),
        premiumForm: document.getElementById("premium-form"),
        intelToggle: document.getElementById("intel-toggle"),
        deckColor: document.getElementById("deck-color"),
        accentColor: document.getElementById("accent-color"),
      };

      const state = {
        queue: [],
        index: 0,
        score: 0,
        reviewed: 0,
        correct: 0,
        alerts: 0,
        highScore: 0,
        running: false,
        shiftEndsAt: 0,
        timeLeft: SHIFT_DURATION,
        raf: null,
        premium: false,
        intelMode: false,
      };

      function pad(value, size = 4) {
        return value.toString().padStart(size, "0");
      }

      function randomItem(list) {
        return list[Math.floor(Math.random() * list.length)];
      }

      function randomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }

      function nowStamp() {
        return new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
      }

      const SYMBOL_ART = {
        eggman: (palette) => `
          <ellipse cx="130" cy="120" rx="70" ry="60" fill="${palette.accent}" opacity="0.18" />
          <circle cx="102" cy="118" r="16" fill="rgba(5,10,26,0.55)" stroke="${palette.stroke}" stroke-width="3" />
          <circle cx="158" cy="118" r="16" fill="rgba(5,10,26,0.55)" stroke="${palette.stroke}" stroke-width="3" />
          <rect x="102" y="114" width="56" height="8" rx="4" fill="${palette.stroke}" opacity="0.6" />
          <path d="M70 150 Q110 116 130 142 Q150 116 190 150 Q150 164 130 150 Q110 164 70 150Z" fill="${palette.stroke}" opacity="0.82" />
        `,
        metal: (palette) => `
          <polygon points="130,60 188,128 130,200 72,128" fill="${palette.accent}" opacity="0.58" stroke="${palette.stroke}" stroke-width="4" />
          <path d="M108 92 L130 46 L152 92" fill="${palette.stroke}" opacity="0.65" />
          <path d="M102 136 L130 158 L158 136" stroke="${palette.stroke}" stroke-width="6" fill="none" stroke-linecap="round" />
          <circle cx="130" cy="130" r="16" fill="rgba(0,0,0,0.42)" stroke="${palette.stroke}" stroke-width="3" />
          <circle cx="130" cy="130" r="6" fill="${palette.glow}" />
        `,
        pawn: (palette) => `
          <circle cx="130" cy="120" r="64" fill="${palette.accent}" opacity="0.22" stroke="${palette.stroke}" stroke-width="4" />
          <circle cx="130" cy="120" r="36" fill="rgba(5,10,26,0.6)" stroke="${palette.stroke}" stroke-width="3" />
          <path d="M130 72 V168" stroke="${palette.stroke}" stroke-width="6" stroke-linecap="round" />
          <path d="M82 120 H178" stroke="${palette.stroke}" stroke-width="6" stroke-linecap="round" />
          <circle cx="130" cy="120" r="14" fill="${palette.glow}" opacity="0.7" />
        `,
        sonic: (palette) => `
          <path d="M74 142 Q94 78 150 86 Q176 54 198 74 Q172 104 194 142 Q150 130 124 168 Q98 140 74 142Z" fill="${palette.glow}" opacity="0.35" />
          <path d="M92 118 Q124 80 174 108" stroke="${palette.stroke}" stroke-width="6" stroke-linecap="round" />
          <circle cx="130" cy="136" r="22" fill="rgba(5,10,26,0.55)" stroke="${palette.accent}" stroke-width="4" />
          <path d="M112 132 Q130 120 148 132" stroke="${palette.accent}" stroke-width="4" stroke-linecap="round" />
        `,
        tails: (palette) => `
          <path d="M82 160 Q100 120 132 142 T182 160 Q160 188 132 178 Q104 188 82 160Z" fill="${palette.accent}" opacity="0.3" />
          <path d="M92 124 Q126 96 156 124" stroke="${palette.stroke}" stroke-width="5" stroke-linecap="round" />
          <path d="M110 150 Q130 170 150 150" stroke="${palette.stroke}" stroke-width="5" stroke-linecap="round" />
          <circle cx="130" cy="126" r="18" fill="rgba(5,10,26,0.55)" stroke="${palette.accent}" stroke-width="4" />
        `,
        rouge: (palette) => `
          <path d="M70 150 L110 90 L130 130 L150 90 L190 150 Z" fill="${palette.glow}" opacity="0.4" />
          <path d="M92 132 Q130 100 168 132" stroke="${palette.stroke}" stroke-width="5" stroke-linecap="round" />
          <circle cx="130" cy="140" r="28" fill="rgba(5,10,26,0.55)" stroke="${palette.accent}" stroke-width="4" />
          <path d="M116 140 Q130 148 144 140" stroke="${palette.accent}" stroke-width="4" stroke-linecap="round" />
        `,
        orbot: (palette) => `
          <rect x="86" y="92" width="88" height="60" rx="16" fill="${palette.accent}" opacity="0.24" stroke="${palette.stroke}" stroke-width="4" />
          <rect x="98" y="106" width="24" height="26" rx="6" fill="rgba(5,10,26,0.6)" stroke="${palette.stroke}" stroke-width="3" />
          <rect x="138" y="106" width="24" height="26" rx="6" fill="rgba(5,10,26,0.6)" stroke="${palette.stroke}" stroke-width="3" />
          <path d="M86 130 H70" stroke="${palette.stroke}" stroke-width="5" stroke-linecap="round" />
          <path d="M174 130 H190" stroke="${palette.stroke}" stroke-width="5" stroke-linecap="round" />
          <circle cx="110" cy="118" r="6" fill="${palette.glow}" />
          <circle cx="150" cy="118" r="6" fill="${palette.glow}" />
        `,
        shadow: (palette) => `
          <path d="M74 148 Q110 78 150 94 Q166 70 192 78 Q170 116 194 150 Q150 134 132 178 Q114 134 74 148Z" fill="${palette.glow}" opacity="0.32" />
          <path d="M98 126 Q130 104 162 126" stroke="${palette.stroke}" stroke-width="6" stroke-linecap="round" />
          <path d="M112 150 Q130 164 148 150" stroke="${palette.accent}" stroke-width="5" stroke-linecap="round" />
          <circle cx="130" cy="134" r="20" fill="rgba(5,10,26,0.6)" stroke="${palette.accent}" stroke-width="4" />
        `,
        big: (palette) => `
          <path d="M70 156 Q102 80 134 108 T198 156 Q160 190 134 178 Q108 190 70 156Z" fill="${palette.glow}" opacity="0.38" />
          <path d="M88 120 Q132 84 176 120" stroke="${palette.stroke}" stroke-width="6" stroke-linecap="round" />
          <circle cx="110" cy="136" r="14" fill="rgba(5,10,26,0.55)" stroke="${palette.accent}" stroke-width="4" />
          <circle cx="150" cy="136" r="14" fill="rgba(5,10,26,0.55)" stroke="${palette.accent}" stroke-width="4" />
          <path d="M108 152 Q130 168 152 152" stroke="${palette.stroke}" stroke-width="5" stroke-linecap="round" />
        `,
        knuckles: (palette) => `
          <path d="M80 150 Q110 80 150 96 Q170 70 194 96 Q176 140 194 164 Q146 150 130 190 Q114 150 80 150Z" fill="${palette.glow}" opacity="0.38" />
          <path d="M96 128 Q130 108 164 128" stroke="${palette.stroke}" stroke-width="6" stroke-linecap="round" />
          <rect x="108" y="136" width="20" height="26" rx="6" fill="rgba(5,10,26,0.55)" stroke="${palette.accent}" stroke-width="4" />
          <rect x="142" y="136" width="20" height="26" rx="6" fill="rgba(5,10,26,0.55)" stroke="${palette.accent}" stroke-width="4" />
          <path d="M112 152 Q130 170 148 152" stroke="${palette.stroke}" stroke-width="5" stroke-linecap="round" />
          <path d="M126 100 L130 80 L134 100" stroke="${palette.accent}" stroke-width="6" stroke-linecap="round" />
        `,
        default: (palette) => `
          <circle cx="130" cy="120" r="70" fill="${palette.accent}" opacity="0.18" />
          <circle cx="130" cy="120" r="34" fill="rgba(5,10,26,0.6)" stroke="${palette.stroke}" stroke-width="4" />
          <path d="M110 110 Q130 98 150 110" stroke="${palette.stroke}" stroke-width="5" stroke-linecap="round" />
        `,
      };

      function drawPortrait(entry) {
        const { palette, symbol } = entry;
        const art = (SYMBOL_ART[symbol] || SYMBOL_ART.default)(palette);
        const svg = `
          <svg viewBox="0 0 260 260" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <radialGradient id="glow-${entry.id}" cx="50%" cy="50%" r="72%">
                <stop offset="0%" stop-color="${palette.glow}" stop-opacity="0.8" />
                <stop offset="100%" stop-color="${palette.bg}" stop-opacity="0.2" />
              </radialGradient>
            </defs>
            <rect width="260" height="260" rx="28" fill="${palette.bg}" />
            <g>
              <circle cx="130" cy="120" r="108" fill="url(#glow-${entry.id})" />
              <circle cx="130" cy="120" r="78" fill="rgba(5,10,26,0.6)" stroke="${palette.accent}" stroke-width="4" />
              ${art}
              <text x="130" y="180" text-anchor="middle" font-size="14" fill="${palette.accent}" font-family="'Chakra Petch', sans-serif">${entry.mission}</text>
            </g>
            <g font-family="'IBM Plex Mono', monospace" font-size="12" fill="${palette.stroke}">
              <text x="22" y="210">Chaos ${entry.chaosFlux}</text>
              <text x="22" y="228">Rings ${entry.ringSignature}</text>
              <text x="22" y="246">Clear ${entry.clearance}</text>
            </g>
          </svg>
        `;
        elements.portrait.innerHTML = svg;
      }

      function logEvent(message) {
        const entry = document.createElement("span");
        entry.textContent = `[${nowStamp()}] ${message}`;
        elements.logStream.prepend(entry);
        while (elements.logStream.children.length > 30) {
          elements.logStream.removeChild(elements.logStream.lastElementChild);
        }
      }

      function updateStats() {
        const total = state.queue.length || CASES_PER_SHIFT;
        elements.score.textContent = state.score.toString();
        elements.cases.textContent = `${state.reviewed} / ${total}`;
        const accuracy = state.reviewed ? Math.round((state.correct / state.reviewed) * 100) : null;
        elements.accuracy.textContent = accuracy === null ? "—" : `${accuracy}%`;
        elements.alerts.textContent = Math.max(0, MAX_ALERTS - state.alerts).toString();
        elements.timer.textContent = `${(state.timeLeft / 1000).toFixed(1)}s`;
        elements.highscore.textContent = state.highScore.toString();
      }

      function resetSubjectView() {
        elements.banner.textContent = "Awaiting identity...";
        elements.subjectId.textContent = "EGG-0000";
        elements.name.textContent = "No subject loaded";
        elements.role.textContent = "Connect to Eggnet to receive dossiers.";
        elements.affiliation.textContent = "—";
        elements.clearance.textContent = "—";
        elements.mission.textContent = "—";
        elements.chaos.textContent = "—";
        elements.rings.textContent = "—";
        elements.gear.textContent = "—";
        elements.passcode.textContent = "—";
        elements.intelChip.textContent = "Briefings arrive once a shift is active.";
        elements.notesQuirk.textContent = "—";
        elements.notesIntel.textContent = "—";
        elements.notesSupport.textContent = "—";
        elements.chatterLine.textContent = "No broadcasts yet.";
        elements.portrait.innerHTML = '<div class="portrait-placeholder">EGGNET</div>';
        updateIntel();
      }

      function buildEntry(index) {
        let subject = randomItem(SUBJECT_BANK);
        let cameo = null;
        const cameoRoll = Math.random();
        if (cameoRoll < 0.06) {
          cameo = BIG_CAMEO;
        } else if (cameoRoll < 0.11) {
          cameo = KNUCKLES_CAMEO;
        }
        if (cameo) {
          subject = cameo;
        }
        const mission = randomItem(Object.keys(MISSION_CLEARANCE));
        const clearance = randomItem(MISSION_CLEARANCE[mission] || ["Alpha", "Beta", "Gamma"]);
        const entry = {
          id: `${subject.id}-${Date.now()}-${index}`,
          name: subject.name,
          role: subject.role,
          symbol: subject.symbol,
          palette: subject.palette,
          baseAffiliation: subject.baseAffiliation,
          affiliation: subject.baseAffiliation,
          clearance,
          mission,
          chaosFlux: cameo?.id === "big" ? randomInt(12, 58) : cameo?.id === "knuckles" ? randomInt(55, 95) : randomInt(40, 90),
          ringSignature: cameo?.id === "big" ? randomInt(60, 180) : cameo?.id === "knuckles" ? randomInt(80, 220) : randomInt(20, 120),
          gear: cameo
            ? cameo.cameoGear
            : randomItem([
                "Shock baton",
                "Drone uplink",
                "Freedom Fighter toolkit",
                "Eggmobile repair kit",
                "Fake Chaos Emerald",
                "Ring bomb satchel",
                "G.U.N. scramble disk",
                "Command tablet",
              ]),
          passcode: cameo?.id === "big" ? `BIG-${pad(randomInt(0, 9999))}` : cameo?.id === "knuckles" ? `KNUX-${pad(randomInt(0, 9999))}` : `EGG-${pad(randomInt(0, 9999))}`,
          quirk: subject.quirk,
          intel: cameo ? cameo.cameoIntel : randomItem(CHATTER_FEED),
          support: cameo ? cameo.cameoSupport : randomItem(SUPPORT_MEMOS),
          cameoTag: cameo?.id ?? null,
          cameoLogged: false,
        };

        const sabotage = Math.random();
        if (!entry.cameoTag && sabotage < 0.4) {
          randomItem([
            (e) => (e.affiliation = randomItem(["Resistance", "Chaotix Freelance"])),
            (e) => (e.passcode = `RGG-${pad(randomInt(0, 9999))}`),
            (e) => (e.chaosFlux = randomInt(76, 110)),
            (e) => (e.gear = randomItem(BANNED_GEAR)),
            (e) => {
              const missions = Object.keys(MISSION_CLEARANCE);
              e.mission = randomItem(missions);
              e.clearance = randomItem(["Alpha", "Beta", "Delta"]);
            },
            (e) => (e.ringSignature = randomInt(0, 18)),
          ])(entry);
        }

        const failures = RULES.filter((rule) => !rule.predicate(entry));
        return { entry, failures };
      }

      function buildQueue() {
        return Array.from({ length: CASES_PER_SHIFT }, (_, idx) => buildEntry(idx));
      }

      function updateIntel(failures = []) {
        if (!state.premium || !state.intelMode) {
          elements.intelOutput.textContent = state.premium
            ? "Intel Mode disabled. Flip the toggle to auto-flag violations."
            : "Enable Intel Mode (premium) to surface likely violations.";
          return;
        }

        const dossier = state.queue[state.index];
        if (!dossier) {
          elements.intelOutput.textContent = "Intel overlays standing by. Start the shift to receive highlights.";
          return;
        }

        if (!failures.length) {
          elements.intelOutput.textContent = "No violations detected. Subject passes current doctrine.";
          return;
        }

        elements.intelOutput.innerHTML = failures.map((fail) => `<div>${fail.message(dossier.entry)}</div>`).join("");
      }

      function renderEntry() {
        const dossier = state.queue[state.index];
        if (!dossier) {
          resetSubjectView();
          return;
        }

        const { entry, failures } = dossier;
        elements.banner.textContent = `Dossier ${state.index + 1} / ${state.queue.length}`;
        elements.subjectId.textContent = entry.passcode;
        elements.name.textContent = entry.name;
        elements.role.textContent = entry.role;
        elements.affiliation.textContent = entry.affiliation;
        elements.clearance.textContent = entry.clearance;
        elements.mission.textContent = entry.mission;
        elements.chaos.textContent = `${entry.chaosFlux} flux`;
        elements.rings.textContent = `${entry.ringSignature} rings`;
        elements.gear.textContent = entry.gear;
        elements.passcode.textContent = entry.passcode;
        elements.intelChip.textContent = entry.intel;
        elements.notesQuirk.textContent = entry.quirk;
        elements.notesIntel.textContent = randomItem(CHATTER_FEED);
        elements.notesSupport.textContent = entry.support;
        elements.chatterLine.textContent = (() => {
          if (entry.cameoTag === "big") {
            return "Command note: escort Big the Cat away from the engine coolant pools.";
          }
          if (entry.cameoTag === "knuckles") {
            return "Guardian in the hangar — do not mention the Master Emerald.";
          }
          return randomItem(CHATTER_FEED);
        })();
        drawPortrait(entry);
        if (entry.cameoTag && !entry.cameoLogged) {
          if (entry.cameoTag === "big") {
            logEvent("Big the Cat wandered past the console muttering about Froggy.");
          } else if (entry.cameoTag === "knuckles") {
            logEvent("Knuckles glared at the staff and asked who touched the Master Emerald.");
          }
          entry.cameoLogged = true;
        }
        const disabled = !state.running;
        elements.approveBtn.disabled = disabled;
        elements.denyBtn.disabled = disabled;
        elements.skipBtn.disabled = disabled;
        updateIntel(failures);
      }

      function scoreDecision(correct, failures) {
        if (correct) {
          const bonus = Math.max(1, failures.length);
          state.score += 160 + bonus * 35;
          state.correct += 1;
        } else {
          state.score = Math.max(0, state.score - 130);
          state.alerts += 1;
        }
      }

      function advanceEntry() {
        state.index += 1;
        if (state.index >= state.queue.length) {
          endShift("queue");
        } else {
          renderEntry();
          updateStats();
        }
      }

      function handleDecision(decision) {
        if (!state.running) return;
        const dossier = state.queue[state.index];
        if (!dossier) return;

        const passes = dossier.failures.length === 0;
        const correct = (decision === "approve" && passes) || (decision === "deny" && !passes);
        scoreDecision(correct, dossier.failures);
        state.reviewed += 1;
        updateStats();

        if (correct) {
          elements.status.textContent = "Clearance logged. Eggnet streaming the next dossier.";
          logEvent(`✔ ${dossier.entry.name} processed. Score +${160 + Math.max(1, dossier.failures.length) * 35}.`);
        } else {
          const issue = dossier.failures[0]?.message(dossier.entry) ?? "Incorrect decision.";
          elements.status.textContent = `Alert issued: ${issue}`;
          logEvent(`✖ ${dossier.entry.name} misprocessed. Reason: ${issue}`);
        }

        if (state.alerts >= MAX_ALERTS) {
          endShift("alerts");
          return;
        }

        advanceEntry();
      }

      function skipEntry() {
        if (!state.running) return;
        const dossier = state.queue[state.index];
        if (!dossier) return;
        state.score = Math.max(0, state.score - 70);
        state.reviewed += 1;
        elements.status.textContent = "Dossier skipped. Eggman expects justification.";
        logEvent(`↷ ${dossier.entry.name} skipped. Penalty applied.`);
        advanceEntry();
      }

      function shiftLoop(timestamp) {
        if (!state.running) return;
        if (!state.shiftEndsAt) {
          state.shiftEndsAt = timestamp + SHIFT_DURATION;
        }
        state.timeLeft = Math.max(0, state.shiftEndsAt - timestamp);
        updateStats();
        if (state.timeLeft <= 0) {
          endShift("time");
          return;
        }
        state.raf = requestAnimationFrame(shiftLoop);
      }

      function startShift() {
        Object.assign(state, {
          queue: buildQueue(),
          index: 0,
          score: 0,
          reviewed: 0,
          correct: 0,
          alerts: 0,
          running: true,
          shiftEndsAt: 0,
          timeLeft: SHIFT_DURATION,
        });
        elements.startBtn.disabled = true;
        elements.resetBtn.disabled = false;
        elements.skipBtn.disabled = false;
        elements.approveBtn.disabled = false;
        elements.denyBtn.disabled = false;
        elements.status.textContent = "Shift live. Cross-reference every Sonic trace.";
        elements.logStream.innerHTML = "";
        logEvent("Eggnet Sentinel shift initiated. Dr. Eggman requires 98% accuracy.");
        renderEntry();
        updateStats();
        cancelAnimationFrame(state.raf);
        state.raf = requestAnimationFrame(shiftLoop);
      }

      function endShift(reason) {
        state.running = false;
        cancelAnimationFrame(state.raf);
        elements.startBtn.disabled = false;
        elements.approveBtn.disabled = true;
        elements.denyBtn.disabled = true;
        elements.skipBtn.disabled = true;
        elements.resetBtn.disabled = false;

        let summary = "Shift complete.";
        if (reason === "time") summary = "Timer expired. Sonic slid past security!";
        if (reason === "alerts") summary = "Too many alerts. Eggnet locked you out.";
        if (reason === "queue") summary = "All dossiers cleared. Eggman nods approvingly.";

        elements.status.textContent = `${summary} Final score ${state.score}.`;
        logEvent(`Shift ended (${reason}). Final score ${state.score}. Accuracy ${elements.accuracy.textContent}.`);

        if (state.score > state.highScore) {
          state.highScore = state.score;
          logEvent(`🏆 New personal best: ${state.highScore} ring credits.`);
        }

        updateStats();
      }

      function hardReset() {
        cancelAnimationFrame(state.raf);
        Object.assign(state, {
          queue: [],
          index: 0,
          score: 0,
          reviewed: 0,
          correct: 0,
          alerts: 0,
          running: false,
          shiftEndsAt: 0,
          timeLeft: SHIFT_DURATION,
        });
        elements.startBtn.disabled = false;
        elements.resetBtn.disabled = true;
        elements.skipBtn.disabled = true;
        elements.approveBtn.disabled = true;
        elements.denyBtn.disabled = true;
        elements.logStream.innerHTML = '<span>No transmissions recorded yet.</span>';
        elements.status.textContent = "Console idle. Spin up the scanners when ready.";
        resetSubjectView();
        updateStats();
      }

      function hexToRgba(hex, alpha = 0.2) {
        let normalized = hex.replace("#", "");
        if (normalized.length === 3) {
          normalized = normalized
            .split("")
            .map((char) => char + char)
            .join("");
        }
        const value = parseInt(normalized, 16);
        const r = (value >> 16) & 255;
        const g = (value >> 8) & 255;
        const b = value & 255;
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      }

      function applyPremiumTheme(event) {
        event.preventDefault();
        if (!state.premium) {
          elements.status.textContent = "Premium required to recolor the command deck.";
          return;
        }
        const deck = elements.deckColor.value;
        const accent = elements.accentColor.value;
        document.documentElement.style.setProperty("--terminal", `${deck}f0`);
        document.documentElement.style.setProperty("--panel", `${deck}e6`);
        document.documentElement.style.setProperty("--panel-alt", `${deck}d9`);
        document.documentElement.style.setProperty("--accent", accent);
        document.documentElement.style.setProperty("--accent-soft", hexToRgba(accent, 0.18));
        elements.status.textContent = "Desk theme updated.";
        logEvent(`Desk palette shifted to ${deck}, accent ${accent}.`);
        updateIntel(state.queue[state.index]?.failures ?? []);
      }

      function toggleIntelMode(event) {
        if (!state.premium) {
          event.target.checked = false;
          elements.status.textContent = "Premium required for Intel Mode.";
          return;
        }
        state.intelMode = event.target.checked;
        logEvent(state.intelMode ? "Intel Mode engaged." : "Intel Mode disengaged.");
        updateIntel(state.queue[state.index]?.failures ?? []);
      }

      async function initAuth() {
        try {
          await supabaseSession();
        } catch (error) {
          console.error("Session error", error);
          elements.status.textContent = "Auth hiccup — refresh if Intel Mode fails.";
        }
        try {
          state.premium = await isUserPremium();
        } catch (error) {
          console.error("Premium lookup failed", error);
          state.premium = false;
        }

        if (state.premium) {
          elements.premiumCard.classList.remove("hidden");
          elements.upgradeCard.classList.add("hidden");
          elements.premiumCard.style.display = "block";
          elements.upgradeCard.style.display = "none";
          elements.status.textContent = "Premium systems online. Customize the deck or engage Intel Mode.";
        } else {
          elements.premiumCard.classList.add("hidden");
          elements.upgradeCard.classList.remove("hidden");
          elements.premiumCard.style.display = "none";
          elements.upgradeCard.style.display = "block";
        }
      }

      function bindEvents() {
        elements.startBtn.addEventListener("click", startShift);
        elements.resetBtn.addEventListener("click", hardReset);
        elements.skipBtn.addEventListener("click", skipEntry);
        elements.approveBtn.addEventListener("click", () => handleDecision("approve"));
        elements.denyBtn.addEventListener("click", () => handleDecision("deny"));
        elements.premiumForm.addEventListener("submit", applyPremiumTheme);
        elements.intelToggle.addEventListener("change", toggleIntelMode);
        window.addEventListener("blur", () => {
          if (state.running) {
            endShift("focus");
            logEvent("Shift auto-paused — focus lost.");
          }
        });
      }

      bindEvents();
      initAuth();
      resetSubjectView();
      updateStats();
    </script>
  </body>
</html>
