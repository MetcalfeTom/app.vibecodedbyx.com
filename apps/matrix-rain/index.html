<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Matrix Rain — Neon Code Stream</title>

    <!-- Social / SEO -->
    <meta name="description" content="Hypnotic green code rain. Tweak speed, density, and color with premium flair. Built live on VibeCodedByX." />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Matrix Rain — Neon Code Stream" />
    <meta property="og:description" content="Hypnotic green code rain. Tweak speed, density, and color with premium flair." />
    <meta property="og:url" content="https://app.vibecodedbyx.com/matrix-rain/" />
    <meta property="og:image" content="https://app.vibecodedbyx.com/matrix-rain/og.png" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Matrix Rain — Neon Code Stream" />
    <meta name="twitter:description" content="Hypnotic green code rain. Tweak speed, density, and color with premium flair." />
    <meta name="twitter:image" content="https://app.vibecodedbyx.com/matrix-rain/og.png" />
    <link rel="canonical" href="https://app.vibecodedbyx.com/matrix-rain/" />
    <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="0.9em" font-size="90">💚</text></svg>' />

    <style>
      :root {
        --bg: #050607;
        --ink: #cfe9d0;
        --muted: #a0b3a4;
        --accent: #22c55e;
        --accent-2: #84cc16;
      }
      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        background: radial-gradient(1000px 700px at 50% -10%, #0a0d0b 0%, transparent 55%), linear-gradient(180deg, #060908, var(--bg));
        color: var(--ink);
        display: grid; grid-template-rows: auto 1fr auto; min-height: 100svh;
      }
      header, footer { padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; position: relative; z-index: 2; }
      header .brand { display: flex; align-items: center; gap: 10px; font-weight: 900; letter-spacing: .2px; }
      header .logo { width: 28px; height: 28px; border-radius: 6px; background: linear-gradient(135deg, #22c55e, #16a34a); box-shadow: 0 8px 18px rgba(34,197,94,.35), inset 0 1px 0 rgba(255,255,255,.2); }
      .wrap { position: fixed; inset: 0; z-index: 1; }
      canvas { display: block; width: 100%; height: 100%; }
      .overlay {
        position: absolute; inset: 0; display: grid; align-content: start; padding: 16px;
        pointer-events: none; /* allow canvas drag/scroll */
      }
      .panel {
        pointer-events: auto; user-select: none;
        display: inline-flex; flex-wrap: wrap; gap: 8px; align-items: center;
        background: rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(6px);
        border-radius: 12px; padding: 10px; box-shadow: 0 10px 30px rgba(0,0,0,.35);
      }
      .btn, select, input[type="range"] {
        appearance: none; border: 1px solid #1f2a24; background: linear-gradient(180deg, #0b1210, #0a0f0d);
        color: var(--ink); border-radius: 10px; padding: 8px 12px; font-weight: 700; cursor: pointer;
        box-shadow: 0 6px 16px rgba(0,0,0,.25); transition: transform 120ms ease, filter 120ms ease, box-shadow 120ms ease;
      }
      .btn:hover { transform: translateY(-1px); filter: brightness(1.05); }
      .btn:active { transform: translateY(0); filter: brightness(.98); }
      .btn.primary { border-color: rgba(34,197,94,.5); background: linear-gradient(180deg, #22c55e, #16a34a); color: #001b0b; text-shadow: 0 1px 0 rgba(255,255,255,.25); }
      .pill { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.06); border-radius: 999px; padding: 6px 10px; font-weight: 800; letter-spacing: .2px; }
      .muted { color: var(--muted); }
      footer { font-size: 14px; color: var(--muted); justify-content: center; gap: 8px; flex-wrap: wrap; }
      a.link { color: var(--accent); text-decoration: none; font-weight: 700; }
      .error {
        position: absolute; inset: 0; display: grid; place-items: center; text-align: center; padding: 24px;
      }
      @media (max-width: 640px) { .panel { gap: 6px; } .btn { padding: 10px 12px; } }
      @supports (padding: max(0px)) { body { padding-bottom: max(env(safe-area-inset-bottom), 0px); } }
    </style>
  </head>
  <body>
    <header>
      <div class="brand"><div class="logo"></div><div>Matrix Rain</div></div>
      <div class="hud" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
        <div id="auth" class="muted">Loading…</div>
        <button id="signin" class="btn" style="display:none">Sign in with Twitter</button>
        <button id="signout" class="btn" style="display:none">Sign out</button>
      </div>
    </header>

    <main class="wrap">
      <canvas id="matrix"></canvas>
      <div class="error" id="error" style="display:none">
        <div>
          <h3>Canvas failed to initialize</h3>
          <p class="muted">Your browser might not support HTML canvas, or hardware acceleration is disabled.</p>
        </div>
      </div>
      <div class="overlay">
        <div class="panel">
          <span class="pill">Mode:</span>
          <select id="scheme">
            <option value="matrix">Matrix</option>
            <option value="aqua">Aqua</option>
            <option value="violet">Violet</option>
            <option value="amber">Amber</option>
          </select>
          <span class="pill">Speed</span>
          <input id="speed" type="range" min="0.2" max="1.5" step="0.05" value="0.6" />
          <span class="pill">Density</span>
          <input id="density" type="range" min="0.6" max="2.0" step="0.1" value="1" />
          <button id="pause" class="btn">Pause</button>
          <button id="clear" class="btn">Clear</button>
          <button id="premium" class="btn primary" title="Premium users unlock extra effects">Premium+ FX</button>
        </div>
      </div>
    </main>

    <footer>
      <span>Made live on</span>
      <a class="link" href="https://www.vibecodedbyx.com" target="_blank" rel="noopener">VibeCodedByX</a>
    </footer>

    <!-- Dummy nodes for supabase-config.js example -->
    <div id="premium-content" style="display:none"></div>
    <div id="upgrade-button" style="display:none"></div>

    <script type="module">
      import supabase, { supabaseSession, isUserPremium } from './supabase-config.js';

      const els = {
        canvas: document.getElementById('matrix'),
        err: document.getElementById('error'),
        auth: document.getElementById('auth'),
        signin: document.getElementById('signin'),
        signout: document.getElementById('signout'),
        scheme: document.getElementById('scheme'),
        speed: document.getElementById('speed'),
        density: document.getElementById('density'),
        pause: document.getElementById('pause'),
        clear: document.getElementById('clear'),
        premium: document.getElementById('premium'),
      };

      const themes = {
        matrix: { fg: '#22c55e', trail: '#0ea54a', fade: 0.08 },
        aqua:   { fg: '#38bdf8', trail: '#0ea5e9', fade: 0.1 },
        violet: { fg: '#a78bfa', trail: '#8b5cf6', fade: 0.1 },
        amber:  { fg: '#f59e0b', trail: '#d97706', fade: 0.08 },
        premiumPulse: { fg: '#22c55e', trail: '#84cc16', fade: 0.06 },
      };

      let ctx, w, h, columns, drops, rafId, running = true, premiumFX = false, charW = 12, charH = 16, fontSize = 16;
      const chars = 'アカサタナハマヤラワ0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ#$%&@';
      const rand = (a,b)=>a+Math.random()*(b-a);

      function resize() {
        const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        w = Math.floor(window.innerWidth * dpr);
        h = Math.floor(window.innerHeight * dpr);
        els.canvas.width = w; els.canvas.height = h;
        ctx.setTransform(1,0,0,1,0,0);
        fontSize = Math.max(12, Math.floor(16 * dpr));
        ctx.font = `${fontSize}px monospace`;
        // Character cell size tied to font size for consistent coverage
        charW = Math.max(10, Math.floor(fontSize * 0.8));
        charH = Math.max(12, Math.floor(fontSize * 1.0));
        columns = Math.max(1, Math.floor(w / charW));
        drops = new Array(columns).fill(0).map(()=>Math.floor(rand(-20, h/charH)));
      }

      function clearHard() { ctx.fillStyle = 'rgba(0,0,0,1)'; ctx.fillRect(0,0,w,h); }

      function loop() {
        const base = themes[els.scheme.value] || themes.matrix;
        const fade = Math.max(0.04, base.fade) / parseFloat(els.density.value);
        ctx.fillStyle = `rgba(0,0,0,${fade})`;
        ctx.fillRect(0,0,w,h);

        const speedScale = parseFloat(els.speed.value);
        ctx.fillStyle = base.fg;

        for (let i=0;i<columns;i++) {
          const x = i * charW;
          const y = drops[i] * charH;
          const ch = chars[Math.floor(Math.random()*chars.length)];
          if (premiumFX && Math.random() < 0.02) {
            ctx.shadowColor = base.trail; ctx.shadowBlur = 12;
          } else { ctx.shadowBlur = 0; }
          ctx.fillText(ch, x, y);

          if (y > h && Math.random() < 0.02) drops[i] = 0;
          // Slower default descent; scaled by user control
          drops[i] += (0.45 * speedScale);
        }
        if (running) rafId = requestAnimationFrame(loop);
      }

      function start() { running = true; cancelAnimationFrame(rafId); rafId = requestAnimationFrame(loop); }
      function pause() { running = false; cancelAnimationFrame(rafId); }

      async function init() {
        try {
          const { user } = await supabaseSession();
          els.auth.textContent = `Signed in: …${String(user.id).slice(-6)}`;
          els.signout.style.display = 'inline-block';
          els.signout.onclick = async ()=>{ await supabase.auth.signOut(); location.reload(); };
        } catch (err) {
          console.error(err);
          els.auth.textContent = 'Auth error';
        }

        ctx = els.canvas.getContext('2d');
        if (!ctx) { els.err.style.display = ''; return; }

        window.addEventListener('resize', ()=>{ resize(); clearHard(); });
        resize();
        clearHard();
        start();

        els.pause.onclick = () => { running ? (pause(), els.pause.textContent='Resume') : (start(), els.pause.textContent='Pause'); };
        els.clear.onclick = () => { clearHard(); };
        els.scheme.onchange = () => { clearHard(); };
        els.speed.oninput = () => {};
        els.density.oninput = () => {};

        els.premium.onclick = async () => {
          try {
            const isPremium = await isUserPremium();
            premiumFX = !!isPremium;
            if (!isPremium) {
              alert('Premium only ✨ — support the stream to unlock extra glow and pulse effects.');
            } else {
              // small celebratory pulse
              for (let i=0;i<12;i++) setTimeout(()=>{ctx.globalCompositeOperation='lighter';}, i*16);
              setTimeout(()=>{ctx.globalCompositeOperation='source-over';}, 220);
            }
          } catch (e) { console.error(e); }
        };
      }

      init();
    </script>
  </body>
  </html>
