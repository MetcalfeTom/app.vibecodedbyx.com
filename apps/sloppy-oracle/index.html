<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sloppy Oracle - Ask the Void</title>
    <link rel="icon" href="https://emojicdn.elk.sh/ðŸ”®">
    <meta property="og:title" content="Sloppy Oracle">
    <meta property="og:description" content="Ask defining questions into the void. The oracle listens.">
    <meta property="og:url" content="https://app.sloppy.live/sloppy-oracle">
    <meta property="og:image" content="https://emojicdn.elk.sh/ðŸ”®?style=google">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,300;0,500;0,700;1,300&family=JetBrains+Mono:wght@300;400&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{
            --bg:#0d0a12;--surface:#1a1520;--surface2:#231e2d;
            --border:rgba(155,89,182,0.3);--border2:rgba(155,89,182,0.15);
            --text:#e8d8f0;--dim:#7a6a8a;--purple:#9b59b6;--purple2:#7b3a96;
            --green:#27ae60;
        }
        body{background:var(--bg);color:var(--text);font-family:'Crimson Pro',Georgia,serif;
            min-height:100vh;display:flex;flex-direction:column;align-items:center}

        /* Mystic glow overlay */
        body::before{content:'';position:fixed;inset:0;
            background:radial-gradient(ellipse at 50% 0%,rgba(155,89,182,0.06) 0%,transparent 60%);
            pointer-events:none;z-index:0}

        .oracle{width:100%;max-width:540px;margin:40px 20px;position:relative;z-index:1}

        .oracle-header{text-align:center;margin-bottom:32px}
        .oracle-header h1{font-weight:700;font-size:clamp(1.6rem,4vw,2.4rem);
            color:var(--purple);text-shadow:0 0 40px rgba(155,89,182,0.3);letter-spacing:1px}
        .oracle-header .sub{font-size:0.7rem;color:var(--dim);letter-spacing:3px;
            text-transform:uppercase;margin-top:4px;font-family:'JetBrains Mono',monospace}

        /* Ask form */
        .ask-form{display:flex;gap:8px;margin-bottom:24px}
        .ask-form input{flex:1;background:var(--surface);border:1px solid var(--border);
            border-radius:10px;padding:12px 16px;font-size:0.95rem;color:var(--text);
            font-family:'Crimson Pro',Georgia,serif;outline:none;transition:border-color 0.2s}
        .ask-form input:focus{border-color:var(--purple)}
        .ask-form input::placeholder{color:var(--dim);font-style:italic}
        .ask-form button{background:linear-gradient(135deg,var(--purple),var(--purple2));
            border:none;border-radius:10px;padding:12px 20px;font-size:0.8rem;font-weight:700;
            color:#fff;cursor:pointer;font-family:'JetBrains Mono',monospace;
            letter-spacing:1px;transition:transform 0.15s}
        .ask-form button:hover{transform:scale(1.05)}

        /* Stats bar */
        .stats{display:flex;justify-content:center;gap:20px;margin-bottom:20px;
            font-size:0.65rem;color:var(--dim);font-family:'JetBrains Mono',monospace}
        .stats span{color:var(--purple)}

        /* Questions list */
        .questions{display:flex;flex-direction:column;gap:10px}
        .q-card{background:var(--surface);border:1px solid var(--border2);border-left:3px solid var(--purple);
            border-radius:0 12px 12px 0;padding:14px 16px;transition:all 0.2s}
        .q-card:hover{background:var(--surface2);border-left-color:var(--purple)}
        .q-card.answered{border-left-color:var(--green)}
        .q-card.answered .q-text{color:#a8c8b0}
        .q-text{font-size:1rem;line-height:1.6;margin-bottom:8px;color:var(--text)}
        .q-answer{font-size:0.85rem;line-height:1.5;color:#a8c8b0;padding:8px 12px;
            background:rgba(39,174,96,0.08);border-radius:8px;margin-bottom:8px;
            border-left:2px solid var(--green);font-style:italic}
        .q-meta{display:flex;justify-content:space-between;align-items:center;
            font-size:0.6rem;color:var(--dim);font-family:'JetBrains Mono',monospace}
        .q-stars{display:flex;gap:2px}
        .q-stars .star{color:var(--purple);opacity:0.25;font-size:0.7rem}
        .q-stars .star.filled{opacity:1}

        .empty{text-align:center;padding:40px 20px;color:var(--dim);font-style:italic;font-size:1rem}

        .backlink{text-align:center;margin-top:24px;font-size:0.6rem;font-family:'JetBrains Mono',monospace}
        .backlink a{color:var(--dim);text-decoration:none}.backlink a:hover{color:var(--purple)}

        .toast{position:fixed;bottom:60px;left:50%;transform:translateX(-50%);
            background:var(--surface2);border:1px solid var(--border);border-radius:10px;
            padding:10px 20px;font-size:0.8rem;color:var(--text);z-index:50;
            opacity:0;transition:opacity 0.3s;pointer-events:none}
        .toast.show{opacity:1}

        /* Embed mode */
        body.embed-mode{min-height:auto}
        body.embed-mode::before{display:none}
        body.embed-mode .oracle-header{display:none}
        body.embed-mode .backlink{display:none}
        body.embed-mode .oracle{margin:0;max-width:100%;padding:6px}
        body.embed-mode .ask-form{margin-bottom:12px}
        body.embed-mode .stats{margin-bottom:10px}
        body.embed-mode .q-card{padding:10px 12px}

        @media(max-width:560px){
            .oracle{margin:20px 12px}
            .ask-form{flex-direction:column}
            .ask-form button{width:100%}
        }
    </style>
<script>
(function(){var Q=[],N=0,MAX=10;function send(e){var sb=window.supabase;if(!sb){Q.push(e);return;}if(N>=MAX)return;N++;sb.auth.getSession().then(function(r){var u=r&&r.data&&r.data.session&&r.data.session.user;if(!u)return;sb.from('ai_events').insert({event_type:'client_error',entity_type:'app',entity_id:u.id,username:location.pathname.split('/').filter(Boolean)[0]||'unknown',metadata:e,user_id:u.id}).then(function(){});}).catch(function(){});}window.onerror=function(m,s,l,c,e){send({type:'error',msg:String(m).slice(0,500),src:s||'',line:l,col:c,stack:e?String(e.stack).slice(0,1000):''});};window.addEventListener('unhandledrejection',function(ev){var r=ev.reason;send({type:'promise',msg:String(r&&r.message||r).slice(0,500),stack:r?String(r.stack||'').slice(0,1000):''});});var fi=setInterval(function(){if(window.supabase){Q.splice(0).forEach(send);clearInterval(fi);}},1000);setTimeout(function(){clearInterval(fi);},30000);})();
</script>
</head>
<body>
    <script>
        var IS_EMBED = new URLSearchParams(location.search).has('embed');
        if (IS_EMBED) document.body.classList.add('embed-mode');
    </script>
    <div class="oracle">
        <div class="oracle-header">
            <h1>ðŸ”® SLOPPY ORACLE</h1>
            <div class="sub">Ask the Void &middot; Defining Questions</div>
        </div>

        <div class="ask-form">
            <input type="text" id="questionInput" placeholder="Ask a defining question..." maxlength="500"
                onkeydown="if(event.key==='Enter')window.submitQuestion()">
            <button onclick="window.submitQuestion()">ASK</button>
        </div>

        <div class="stats">
            <div><span id="totalCount">0</span> questions</div>
            <div><span id="answeredCount">0</span> answered</div>
        </div>

        <div class="questions" id="questionsList">
            <div class="empty">No questions yet. Ask the void...</div>
        </div>

        <div class="backlink"><a href="https://sloppy.live">&larr; sloppy.live</a></div>
    </div>

    <div class="toast" id="toast"></div>

    <script src="/sloppy-header/sloppy-bar.js" data-position="bottom" data-minimized="true"></script>
    <script type="module">
        import { createBrowserClient } from "https://cdn.jsdelivr.net/npm/@supabase/ssr@0.7.0/+esm";

        const SUPABASE_URL = 'https://yjyxteqzhhmtrgcaekgz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM4IS32IUYR2eenCCjdDdioiBU';
        const supabase = createBrowserClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            cookieOptions: { name: 'sb-auth-token', domain: location.hostname.includes('sloppy.live') ? '.sloppy.live' : location.hostname, path: '/', sameSite: 'lax' }
        });
        window.supabase = supabase;

        const IS_EMBED = new URLSearchParams(location.search).has('embed');

        let currentUser = null;
        let questions = [];

        // Auth
        async function initAuth() {
            const sessRes = await supabase.auth.getSession();
            let session = sessRes.data.session;
            if (!session) session = (await supabase.auth.signInAnonymously()).data.session;
            currentUser = session?.user || null;
        }

        // Load questions
        async function loadQuestions() {
            try {
                const { data, error } = await supabase
                    .from('oracle_log')
                    .select('id, question, context, answered, answer, importance, created_at')
                    .order('created_at', { ascending: false })
                    .limit(100);

                if (error) { console.error('[Oracle] Load error:', error); return; }
                questions = data || [];
                render();
            } catch (err) {
                console.error('[Oracle] Exception:', err);
            }
        }

        // Render
        function render() {
            const list = document.getElementById('questionsList');
            const totalEl = document.getElementById('totalCount');
            const answeredEl = document.getElementById('answeredCount');

            totalEl.textContent = questions.length;
            answeredEl.textContent = questions.filter(q => q.answered).length;

            if (questions.length === 0) {
                list.innerHTML = '<div class="empty">No questions yet. Ask the void...</div>';
                return;
            }

            list.innerHTML = questions.map(q => {
                const importance = q.importance || 1;
                let stars = '';
                for (let i = 1; i <= 5; i++) {
                    stars += `<span class="star ${i <= importance ? 'filled' : ''}">â˜…</span>`;
                }
                const date = new Date(q.created_at).toLocaleDateString();
                const answeredClass = q.answered ? ' answered' : '';
                const answerHtml = q.answer
                    ? `<div class="q-answer">${esc(q.answer)}</div>`
                    : '';

                return `<div class="q-card${answeredClass}">
                    <div class="q-text">${esc(q.question)}</div>
                    ${answerHtml}
                    <div class="q-meta">
                        <span>${date}</span>
                        <div class="q-stars">${stars}</div>
                    </div>
                </div>`;
            }).join('');
        }

        // Submit
        window.submitQuestion = async function() {
            const input = document.getElementById('questionInput');
            const question = input.value.trim();

            if (!question) { showToast('Enter a question first'); return; }
            if (question.length < 5) { showToast('Question too short'); return; }

            try {
                const { data, error } = await supabase
                    .from('oracle_log')
                    .insert({
                        question: esc(question),
                        user_id: currentUser ? currentUser.id : null,
                        importance: 1,
                        answered: false
                    })
                    .select()
                    .single();

                if (error) { showToast('Failed to save question'); return; }

                input.value = '';
                questions.unshift(data);
                render();
                showToast('ðŸ”® Question recorded');

                if (IS_EMBED) {
                    window.parent.postMessage({ type: 'oracle-question-added', question: data.question }, '*');
                }
            } catch (err) {
                console.error('[Oracle] Submit error:', err);
                showToast('Error saving question');
            }
        };

        // Realtime
        function setupRealtime() {
            const channel = supabase
                .channel('oracle_log_changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'oracle_log' }, payload => {
                    if (payload.eventType === 'INSERT') {
                        if (!questions.some(q => q.id === payload.new.id)) {
                            questions.unshift(payload.new);
                            render();
                        }
                    } else if (payload.eventType === 'UPDATE') {
                        const idx = questions.findIndex(q => q.id === payload.new.id);
                        if (idx !== -1) { questions[idx] = payload.new; render(); }
                    } else if (payload.eventType === 'DELETE') {
                        questions = questions.filter(q => q.id !== payload.old.id);
                        render();
                    }
                });
            channel.subscribe();
        }

        // Helpers
        function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        // Init
        async function init() {
            await initAuth();
            await loadQuestions();
            setupRealtime();
        }
        init();
    </script>
</body>
</html>
