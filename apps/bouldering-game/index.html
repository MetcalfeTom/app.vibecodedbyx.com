<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bouldering Game ‚Äî Climb the Route</title>

    <!-- Social Sharing -->
    <meta property="og:title" content="Bouldering Game ‚Äî Climb the Route" />
    <meta property="og:description" content="Reach the top fast. Beat the global leaderboard!" />
    <meta property="og:image" content="./og.png" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Bouldering Game ‚Äî Climb the Route" />
    <meta name="twitter:description" content="Reach the top fast. Beat the global leaderboard!" />
    <meta name="twitter:image" content="./og.png" />
    <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="0.9em" font-size="90">üßó</text></svg>' />

    <style>
      :root {
        --bg: #0c0c0f;
        --card: #141419;
        --ink: #f3f3f6;
        --muted: #b9b9c2;
        --accent: #5eead4;
        --accent-2: #f59e0b;
        --danger: #ef4444;
        --ok: #22c55e;
      }
      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        background: radial-gradient(1200px 800px at 50% -20%, #1b1b25 0%, var(--bg) 55%);
        color: var(--ink);
        display: flex; align-items: center; justify-content: center;
      }
      .wrap { width: min(1100px, 96vw); padding: 20px; }
      header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
      .brand { display: flex; align-items: center; gap: 10px; font-weight: 800; }
      .brand .logo { width: 28px; height: 28px; border-radius: 6px; background: linear-gradient(135deg, #1f2937, #0ea5e9); }
      .row { display: grid; grid-template-columns: 1fr; gap: 16px; }
      @media (min-width: 940px) { .row { grid-template-columns: 1.2fr 1fr; } }
      .card { background: var(--card); border: 1px solid #23232c; border-radius: 14px; padding: 16px; box-shadow: 0 8px 28px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.03); }
      .btn { border: 1px solid #2f2f3a; background: linear-gradient(180deg, #282834, #1b1b23); color: var(--ink); padding: 12px 16px; border-radius: 12px; cursor: pointer; touch-action: manipulation; }
      .btn.primary { border-color: #0b766d; background: linear-gradient(180deg, #0ea5e9, #0284c7); color: #001018; font-weight: 800; }
      .muted { color: var(--muted); }
      .link { color: var(--accent); text-decoration: none; }
      .hud { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
      .pill { background: #0f0f15; border: 1px solid #2a2a33; border-radius: 999px; padding: 8px 12px; font-weight: 600; }

      /* Board */
      .board-wrap { display: grid; place-items: center; }
      .board { position: relative; width: min(520px, 96vw); aspect-ratio: 3/4; background: linear-gradient(180deg, #13131a, #0e0e13); border: 1px solid #23232c; border-radius: 14px; overflow: hidden; }
      .grid { position: absolute; inset: 0; background-image: radial-gradient(circle at 1px 1px, #2a2a33 1px, transparent 0); background-size: calc(100%/8) calc(100%/12); opacity: 0.35; }
      .hold { position: absolute; width: 32px; height: 32px; margin: -16px 0 0 -16px; border-radius: 50%; display: grid; place-items: center; color: #000; font-size: 14px; font-weight: 900; text-shadow: 0 1px 0 rgba(255,255,255,0.5); box-shadow: 0 8px 18px rgba(0,0,0,0.45); transition: transform 160ms ease, box-shadow 160ms ease; }
      .type-start { background: #22c55e; }
      .type-top { background: #f59e0b; }
      .type-mid { background: #a78bfa; }
      .type-bad { background: #ef4444; }
      .hold.on-limb { box-shadow: 0 0 0 3px rgba(94,234,212,0.5), 0 12px 24px rgba(0,0,0,0.5); }
      .hold.available { box-shadow: 0 0 0 2px rgba(94,234,212,0.4), 0 10px 22px rgba(0,0,0,0.45); transform: translateY(-2px) scale(1.05); }
      .climber { position: absolute; width: 26px; height: 26px; margin: -13px 0 0 -13px; border-radius: 50%; background: linear-gradient(180deg, #e5e7eb, #9ca3af); border: 2px solid #0d0d0f; box-shadow: 0 10px 20px rgba(0,0,0,0.4); }
      .pulse { animation: pulse 1s ease-out; }
      @keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.15);} 100%{transform:scale(1);} }

      /* D-Pad for mobile */
      .dpad { display: grid; grid-template-columns: 60px 60px 60px; grid-template-rows: 60px 60px 60px; gap: 8px; justify-content: center; align-items: center; }
      .dpad .spacer { visibility: hidden; }
      .dpad .btn { width: 60px; height: 60px; border-radius: 14px; font-size: 20px; display: grid; place-items: center; }
      @media (max-width: 640px) {
        .btn { padding: 14px 18px; border-radius: 14px; }
        .hold { width: 36px; height: 36px; margin: -18px 0 0 -18px; font-size: 16px; }
        .climber { width: 28px; height: 28px; margin: -14px 0 0 -14px; }
        .dpad { grid-template-columns: 64px 64px 64px; grid-template-rows: 64px 64px 64px; gap: 10px; }
        .dpad .btn { width: 64px; height: 64px; font-size: 22px; }
      }
      @supports (padding: max(0px)) {
        body { padding-bottom: max(env(safe-area-inset-bottom), 0px); }
      }

      .leaderboard ol { margin: 0; padding-left: 18px; }
      .leaderboard li { padding: 4px 0; }
      footer { margin-top: 16px; text-align: center; font-size: 14px; color: var(--muted); }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div class="brand"><div class="logo"></div><div>Bouldering Game</div></div>
        <div class="hud">
          <div id="auth" class="muted">Loading‚Ä¶</div>
          <button id="signin" class="btn" style="display:none">Sign in with Twitter</button>
          <button id="signout" class="btn" style="display:none">Sign out</button>
        </div>
      </header>

      <div class="row">
        <section class="card">
          <div class="hud" style="margin-bottom:10px; flex-wrap:wrap">
            <div class="pill">Route: <span id="routeName">Classic V2</span></div>
            <div class="pill">Time: <span id="time">0.00</span>s</div>
            <div class="pill">Best: <span id="best">‚Äî</span></div>
            <button id="start" class="btn primary">Start</button>
          </div>
          <div class="hud" style="margin-bottom:10px; flex-wrap:wrap">
            <div class="pill">Limb:</div>
            <button id="btn-LH" class="btn">Left Hand (1)</button>
            <button id="btn-RH" class="btn">Right Hand (2)</button>
            <button id="btn-LF" class="btn">Left Foot (3)</button>
            <button id="btn-RF" class="btn">Right Foot (4)</button>
          </div>
          <div class="board-wrap">
            <div class="board" id="board">
              <div class="grid"></div>
              <!-- Holds and limbs will be injected here -->
              <div id="limb-LH" class="climber" style="display:none; background: linear-gradient(180deg,#fef08a,#f59e0b)"></div>
              <div id="limb-RH" class="climber" style="display:none; background: linear-gradient(180deg,#bbf7d0,#22c55e)"></div>
              <div id="limb-LF" class="climber" style="display:none; background: linear-gradient(180deg,#c7d2fe,#818cf8)"></div>
              <div id="limb-RF" class="climber" style="display:none; background: linear-gradient(180deg,#fecaca,#ef4444)"></div>
            </div>
          </div>
          <div class="hud" style="justify-content:center; margin-top:12px">
            <div class="dpad" aria-label="Directional pad">
              <div class="spacer"></div>
              <button id="btn-up" class="btn" aria-label="Move Up">‚¨ÜÔ∏è</button>
              <div class="spacer"></div>
              <button id="btn-left" class="btn" aria-label="Move Left">‚¨ÖÔ∏è</button>
              <button id="btn-down" class="btn" aria-label="Move Down">‚¨áÔ∏è</button>
              <button id="btn-right" class="btn" aria-label="Move Right">‚û°Ô∏è</button>
            </div>
          </div>
          <p class="muted">Controls: select a limb (buttons or keys 1‚Äì4) and click any glowing hold to move that limb. Arrow keys or the D-pad bump the selected limb to the nearest glowing option. The timer starts on your first move‚Äîstick both hands on the Top (T) to finish.</p>
        </section>

        <aside class="card leaderboard">
          <h3>Top Climbers (fastest)</h3>
          <ol id="leaders"></ol>
          <p class="muted">Your best run saves automatically.</p>
        </aside>
      </div>

      <footer>
        <a class="link" href="https://www.vibecodedbyx.com" target="_blank" rel="noopener">Back to the livestream</a>
      </footer>
    </div>

    <!-- Dummy nodes to satisfy global example code in supabase-config.js -->
    <div id="premium-content" style="display:none"></div>
    <div id="upgrade-button" style="display:none"></div>

    <script type="module">
      import supabase, { supabaseSession } from './supabase-config.js';

      const els = {
        board: document.getElementById('board'),
        limbLH: document.getElementById('limb-LH'),
        limbRH: document.getElementById('limb-RH'),
        limbLF: document.getElementById('limb-LF'),
        limbRF: document.getElementById('limb-RF'),
        start: document.getElementById('start'),
        time: document.getElementById('time'),
        best: document.getElementById('best'),
        leaders: document.getElementById('leaders'),
        auth: document.getElementById('auth'),
        signin: document.getElementById('signin'),
        signout: document.getElementById('signout'),
        btnLH: document.getElementById('btn-LH'),
        btnRH: document.getElementById('btn-RH'),
        btnLF: document.getElementById('btn-LF'),
        btnRF: document.getElementById('btn-RF'),
        btnUp: document.getElementById('btn-up'),
        btnDown: document.getElementById('btn-down'),
        btnLeft: document.getElementById('btn-left'),
        btnRight: document.getElementById('btn-right'),
      };

      const route = {
        name: 'Classic V2',
        // grid 8 x 12, positions as [col,row] in 0..1 normalized
        holds: [
          { x: 0.1, y: 0.95, type: 'start' },
          { x: 0.3, y: 0.82, type: 'mid' },
          { x: 0.52, y: 0.78, type: 'mid' },
          { x: 0.68, y: 0.64, type: 'mid' },
          { x: 0.42, y: 0.58, type: 'mid' },
          { x: 0.23, y: 0.47, type: 'mid' },
          { x: 0.44, y: 0.39, type: 'mid' },
          { x: 0.64, y: 0.31, type: 'mid' },
          { x: 0.48, y: 0.18, type: 'mid' },
          { x: 0.52, y: 0.06, type: 'top' },
        ],
      };

      const MAX_REACH = 0.27;

      let state = {
        session: null, user: null,
        startedAt: 0, timerId: null, finished: false,
        bestMs: null,
        nodes: [],
        limbs: { LH: 0, RH: 0, LF: 0, RF: 0 },
        selected: 'LH',
      };

      function formatMs(ms) { return (ms/1000).toFixed(2); }
      function escapeHtml(text) {
        return String(text ?? '').replace(/[&<>'"]/g, (ch) => {
          switch (ch) {
            case '&': return '&amp;';
            case '<': return '&lt;';
            case '>': return '&gt;';
            case '"': return '&quot;';
            case "'": return '&#39;';
            default: return ch;
          }
        });
      }
      function dist(a, b) { const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx, dy); }

      function placeHolds() {
        const rect = els.board.getBoundingClientRect();
        els.board.querySelectorAll('.hold').forEach(n=>n.remove());
        state.nodes = route.holds.map((h, i) => {
          const el = document.createElement('div');
          el.className = `hold type-${h.type || 'mid'}`;
          el.style.left = `${h.x*100}%`;
          el.style.top = `${h.y*100}%`;
          el.textContent = i === 0 ? 'S' : (i === route.holds.length-1 ? 'T' : '');
          el.dataset.index = String(i);
          els.board.appendChild(el);
          el.addEventListener('click', () => tryMoveSelectedTo(i));
          return { ...h, el };
        });
      }

      function updateLimbPositions(pulseKey=null) {
        const offset = { LH: [-10,-10], RH: [10,-10], LF: [-10,10], RF: [10,10] };
        for (const key of ['LH','RH','LF','RF']) {
          const idx = state.limbs[key];
          const n = state.nodes[idx]; if (!n) continue;
          const el = key==='LH'?els.limbLH:key==='RH'?els.limbRH:key==='LF'?els.limbLF:els.limbRF;
          el.style.left = `calc(${n.x*100}% + ${offset[key][0]}px)`;
          el.style.top = `calc(${n.y*100}% + ${offset[key][1]}px)`;
          el.style.display = '';
          if (pulseKey===key) { el.classList.remove('pulse'); void el.offsetWidth; el.classList.add('pulse'); }
          el.style.boxShadow = state.selected===key ? '0 0 0 3px rgba(94,234,212,0.9), 0 10px 20px rgba(0,0,0,0.4)' : '0 10px 20px rgba(0,0,0,0.4)';
        }
        highlightOptions();
      }

      function highlightOptions() {
        if (!state.nodes?.length) return;
        const current = state.limbs[state.selected];
        state.nodes.forEach((node, idx) => {
          const el = node?.el; if (!el) return;
          if (idx === current) {
            el.classList.add('on-limb');
          } else {
            el.classList.remove('on-limb');
          }
          if (!state.finished && idx !== current && isAdjacent(current, idx)) {
            el.classList.add('available');
          } else {
            el.classList.remove('available');
          }
        });
      }

      function resetRun() {
        state.finished = false;
        clearInterval(state.timerId);
        state.timerId = null;
        state.startedAt = 0;
        els.time.textContent = '0.00';
        state.limbs = { LH: 0, RH: 0, LF: 0, RF: 0 };
        updateLimbPositions();
      }

      function beginTimer() {
        clearInterval(state.timerId);
        state.finished = false;
        state.startedAt = performance.now();
        els.time.textContent = '0.00';
        state.timerId = setInterval(()=>{
          const elapsed = performance.now() - state.startedAt;
          els.time.textContent = formatMs(elapsed);
        }, 50);
      }

      function startRun() {
        resetRun();
        beginTimer();
      }

      function isAdjacent(i, j) {
        const a = route.holds[i], b = route.holds[j];
        if (!a || !b) return false;
        return dist(a, b) <= MAX_REACH; // roughly two grid steps of reach
      }

      async function finishRun() {
        clearInterval(state.timerId);
        state.timerId = null;
        state.finished = true;
        highlightOptions();
        const ms = Math.round(performance.now() - state.startedAt);
        els.time.textContent = formatMs(ms);
        vibrate([30,50,30]);
        await saveBest(ms);
      }

      function vibrate(pattern=15) {
        try { if (navigator.vibrate) navigator.vibrate(pattern); } catch {}
      }

      function tryMoveSelectedTo(nextIndex) {
        if (state.finished) return;
        const key = state.selected;
        const cur = state.limbs[key];
        if (!isAdjacent(cur, nextIndex)) return;
        if (!state.startedAt) beginTimer();
        state.limbs[key] = nextIndex;
        updateLimbPositions(key);
        vibrate(12);
        const last = route.holds.length - 1;
        if (state.limbs.LH === last && state.limbs.RH === last) finishRun();
      }

      function nearestAdjacent(direction) {
        // direction: 'up' | 'down' | 'left' | 'right'
        const cur = route.holds[state.limbs[state.selected]];
        const candidates = route.holds.map((h, i) => ({...h, i}))
          .filter(o => o.i !== state.limbs[state.selected] && isAdjacent(state.limbs[state.selected], o.i));
        if (!candidates.length) return state.limbs[state.selected];

        const directional = candidates.filter(({x,y}) =>
          direction==='up' ? y < cur.y :
          direction==='down' ? y > cur.y :
          direction==='left' ? x < cur.x : x > cur.x
        );

        const pool = directional.length ? directional : candidates;
        const best = pool
          .map((candidate) => {
            const dx = candidate.x - cur.x;
            const dy = candidate.y - cur.y;
            const weight = direction==='up' || direction==='down'
              ? Math.abs(dx) * 0.7 + Math.abs(dy)
              : Math.abs(dy) * 0.7 + Math.abs(dx);
            return { candidate, weight };
          })
          .sort((a, b) => a.weight - b.weight)[0];

        return best ? best.candidate.i : state.limbs[state.selected];
      }

      function onKey(e) {
        if (state.finished) return;
        const selectMap = { '1':'LH', '2':'RH', '3':'LF', '4':'RF' };
        if (selectMap[e.key]) { selectLimb(selectMap[e.key]); e.preventDefault(); return; }
        const map = { ArrowUp:'up', ArrowDown:'down', ArrowLeft:'left', ArrowRight:'right' };
        const dir = map[e.key]; if (!dir) return;
        e.preventDefault();
        const next = nearestAdjacent(dir);
        if (next !== state.limbs[state.selected]) tryMoveSelectedTo(next);
      }

      function selectLimb(key) {
        state.selected = key;
        updateLimbPositions();
        // Button active styles
        for (const k of ['LH','RH','LF','RF']) {
          const b = k==='LH'?els.btnLH:k==='RH'?els.btnRH:k==='LF'?els.btnLF:els.btnRF;
          b.style.outline = state.selected===k ? '3px solid #5eead4' : 'none';
          b.style.filter = state.selected===k ? 'brightness(1.1)' : 'none';
        }
      }

      async function loadBest() {
        if (!state.user) return null;
        const { data, error } = await supabase
          .from('bouldering_scores')
          .select('time_ms')
          .eq('user_id', state.user.id)
          .eq('route', route.name)
          .single();
        if (error && error.code !== 'PGRST116') console.error('Best load error:', error.message);
        return data?.time_ms ?? null;
      }

      async function saveBest(ms) {
        if (!state.user) return;
        const { data: existingRows, error: readError } = await supabase
          .from('bouldering_scores')
          .select('time_ms')
          .eq('user_id', state.user.id)
          .eq('route', route.name)
          .limit(1);

        if (readError && readError.code !== 'PGRST116') {
          console.error('Score read error:', readError.message);
          return;
        }

        const existing = existingRows?.[0];
        const nextBest = existing?.time_ms != null ? Math.min(existing.time_ms, ms) : ms;

        if (!existing) {
          const { error: insertError } = await supabase
            .from('bouldering_scores')
            .insert({ user_id: state.user.id, route: route.name, time_ms: nextBest });
          if (insertError) {
            console.error('Save insert error:', insertError.message);
            return;
          }
        } else if (nextBest < existing.time_ms) {
          const { error: updateError } = await supabase
            .from('bouldering_scores')
            .update({ time_ms: nextBest })
            .eq('user_id', state.user.id)
            .eq('route', route.name);
          if (updateError) {
            console.error('Save update error:', updateError.message);
            return;
          }
        }

        state.bestMs = state.bestMs == null ? nextBest : Math.min(state.bestMs, nextBest);
        els.best.textContent = `${formatMs(state.bestMs)}s`;
        refreshLeaders();
      }

      async function refreshLeaders() {
        const { data, error } = await supabase
          .from('bouldering_scores')
          .select('time_ms, user_id')
          .eq('route', route.name)
          .order('time_ms', { ascending: true })
          .limit(10);
        if (error) { console.error('Leaders error:', error.message); return; }
        const rows = data || [];
        const ids = rows.map((r) => r.user_id).filter(Boolean);
        const nameLookup = {};

        if (ids.length) {
          const { data: profiles, error: profileError } = await supabase
            .from('users')
            .select('user_id, display_name, twitter_handle')
            .in('user_id', ids);
          if (profileError) {
            console.error('Leader profile error:', profileError.message);
          } else {
            for (const profile of profiles) {
              const displayName = profile.display_name?.trim();
              const twitter = profile.twitter_handle?.trim();
              const handle = twitter ? (twitter.startsWith('@') ? twitter : `@${twitter}`) : '';
              const label = displayName || handle;
              if (label) nameLookup[profile.user_id] = label;
            }
          }
        }

        els.leaders.innerHTML = rows
          .map((r, i) => {
            const fallback = `‚Ä¶${String(r.user_id ?? '').slice(-6)}`;
            const label = nameLookup[r.user_id] || fallback;
            const timeLabel = r.time_ms == null ? '‚Äî' : `${formatMs(r.time_ms)}s`;
            return `<li>#${i + 1} <strong>${escapeHtml(timeLabel)}</strong> ‚Äî ${escapeHtml(label)}</li>`;
          })
          .join('');
      }

      async function init() {
        window.addEventListener('resize', () => {
          placeHolds();
          updateLimbPositions();
        });
        document.addEventListener('keydown', onKey);
        els.start.addEventListener('click', startRun);
        placeHolds();
        updateLimbPositions();
        selectLimb('LH');

        const { session, user } = await supabaseSession();
        state.session = session; state.user = user;
        els.auth.textContent = `Signed in: ‚Ä¶${String(user.id).slice(-6)}`;
        els.signout.style.display = 'inline-block';
        els.signout.onclick = async ()=>{ await supabase.auth.signOut(); location.reload(); };
        els.btnLH.onclick = () => selectLimb('LH');
        els.btnRH.onclick = () => selectLimb('RH');
        els.btnLF.onclick = () => selectLimb('LF');
        els.btnRF.onclick = () => selectLimb('RF');
        const dpad = [
          ['up', els.btnUp],
          ['down', els.btnDown],
          ['left', els.btnLeft],
          ['right', els.btnRight],
        ];
        for (const [dir, btn] of dpad) {
          const handler = (e) => {
            e.preventDefault();
            e.stopPropagation();
            const next = nearestAdjacent(dir);
            if (next !== state.limbs[state.selected]) tryMoveSelectedTo(next);
          };
          btn.addEventListener('click', handler);
          btn.addEventListener('touchstart', handler, { passive: false });
        }
        els.signin.style.display = 'none';

        state.bestMs = await loadBest();
        els.best.textContent = state.bestMs == null ? '‚Äî' : `${formatMs(state.bestMs)}s`;
        refreshLeaders();

        supabase
          .channel('bouldering_scores')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'bouldering_scores' }, refreshLeaders)
          .subscribe();
      }

      init().catch(err => { console.error(err); els.auth.textContent = 'Auth error'; });
    </script>
  </body>
</html>
