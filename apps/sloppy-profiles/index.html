<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sloppy Profiles</title>
    <link rel="icon" href="https://emojicdn.elk.sh/üë§">
    <meta property="og:title" content="Sloppy Profiles">
    <meta property="og:description" content="Look up any user's profile, stats, karma, and game scores">
    <meta property="og:url" content="https://app.sloppy.live/sloppy-profiles">
    <meta property="og:image" content="https://image.pollinations.ai/prompt/retro%20terminal%20user%20profile%20card%20neon%20green%20dark%20background%20hacker%20aesthetic%20pixel%20avatar?width=1200&height=630&nologo=true&referrer=sloppy.live">
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}

        :root {
            --accent: #7c9885;
            --accent-light: #a8c4b0;
            --accent-dim: #5a7060;
            --highlight: #c9a87c;
            --dark-bg: #0a0a0f;
            --panel-bg: #12121a;
            --border-color: #2a2a35;
            --text-dim: #6a6a75;
        }

        body {
            font-family: 'VT323', monospace;
            background: var(--dark-bg);
            min-height: 100vh;
            color: var(--accent);
        }

        /* === EMBED MODE: transparent overlay === */
        body.embed-mode {
            background: transparent;
            min-height: 0;
            overflow: hidden;
        }

        /* === PROFILE CARD (shared between modes) === */
        .profile-card {
            position: fixed;
            z-index: 10000;
            background: var(--dark-bg);
            border: 1px solid var(--accent);
            border-radius: 8px;
            padding: 16px;
            min-width: 220px;
            max-width: 280px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            display: none;
            animation: profileCardIn 0.15s ease-out;
            pointer-events: auto;
        }

        @keyframes profileCardIn {
            from { opacity: 0; transform: translateY(-8px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .profile-card.visible {
            display: block;
        }

        .profile-trust-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 10px;
            padding: 6px 10px;
            background: rgba(168, 85, 247, 0.1);
            border: 1px solid rgba(168, 85, 247, 0.25);
            border-radius: 6px;
            font-size: 11px;
        }
        .profile-trust-score {
            font-weight: 600;
            color: #a855f7;
        }
        .profile-trust-label {
            color: #8a7a9a;
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .profile-verify-badges {
            display: flex;
            gap: 4px;
            margin-left: auto;
        }
        .verify-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .verify-badge.twitter { background: rgba(29, 161, 242, 0.2); color: #1da1f2; }
        .verify-badge.email { background: rgba(0, 212, 255, 0.2); color: #00d4ff; }
        .verify-badge.github { background: rgba(255, 255, 255, 0.1); color: #ccc; }
        .sloppyid-link {
            display: block;
            text-align: center;
            margin-top: 10px;
            padding: 10px;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(168, 85, 247, 0.1));
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 6px;
            color: #00d4ff;
            font-size: 12px;
            text-decoration: none;
            transition: all 0.2s;
        }
        .sloppyid-link:hover {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(168, 85, 247, 0.2));
            border-color: #00d4ff;
        }

        .profile-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .profile-card-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            background: var(--panel-bg);
            border: 2px solid var(--accent);
            overflow: hidden;
        }

        .profile-card-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-card-name {
            font-size: 1.2rem;
            color: var(--accent-light);
            font-weight: bold;
        }

        .profile-card-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
            text-align: center;
        }

        .profile-card-stat {
            background: var(--panel-bg);
            padding: 8px 4px;
            border-radius: 4px;
        }

        .profile-card-stat-value {
            font-size: 1.1rem;
            color: var(--highlight);
            font-weight: bold;
        }

        .profile-card-stat-label {
            font-size: 0.7rem;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .profile-card-loading {
            text-align: center;
            padding: 20px;
            color: var(--text-dim);
        }

        .profile-karma-section {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(59, 130, 246, 0.15));
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 12px;
        }

        .profile-karma-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .profile-karma-total {
            font-size: 1.3rem;
            font-weight: bold;
            color: #fbbf24;
            text-shadow: 0 0 8px rgba(251, 191, 36, 0.5);
        }

        .profile-karma-badges {
            display: flex;
            gap: 4px;
        }

        .profile-karma-badge {
            font-size: 1rem;
            filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.3));
        }

        .profile-karma-breakdown {
            display: flex;
            gap: 12px;
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .profile-karma-breakdown span {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .profile-follow-stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .profile-follow-stat {
            text-align: center;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .profile-follow-stat:hover {
            opacity: 0.8;
        }

        .profile-follow-stat-value {
            font-size: 1.1rem;
            color: var(--highlight);
            font-weight: bold;
        }

        .profile-follow-stat-label {
            font-size: 0.65rem;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .follow-btn {
            padding: 6px 16px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid;
            font-family: inherit;
        }

        .follow-btn.follow {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            border-color: #8b5cf6;
            color: white;
        }

        .follow-btn.follow:hover {
            background: linear-gradient(135deg, #9f7afa, #818cf8);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.4);
        }

        .follow-btn.following {
            background: transparent;
            border-color: var(--text-dim);
            color: var(--text-dim);
        }

        .follow-btn.following:hover {
            border-color: #ef4444;
            color: #ef4444;
        }

        /* Cross-app Profile Stats */
        .profile-crossapp {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }

        .profile-crossapp-title {
            font-size: 0.7rem;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .profile-game-scores {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .profile-game-score {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            padding: 4px 8px;
            font-size: 0.7rem;
        }

        .profile-game-score .game-name {
            color: var(--text-dim);
        }

        .profile-game-score .game-score {
            color: #a78bfa;
            font-weight: bold;
            margin-left: 4px;
        }

        .profile-card-actions {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .profile-card-actions a,
        .profile-card-actions button {
            font-family: 'VT323', monospace;
        }

        /* === STANDALONE MODE === */
        .standalone-container {
            max-width: 480px;
            margin: 0 auto;
            padding: 24px 16px;
        }

        .standalone-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .standalone-header h1 {
            font-size: 1.8rem;
            color: var(--accent-light);
            margin-bottom: 4px;
        }

        .standalone-header p {
            color: var(--text-dim);
            font-size: 1rem;
        }

        .search-row {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        .search-row input {
            flex: 1;
            padding: 10px 14px;
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            color: var(--accent-light);
            font-family: inherit;
            font-size: 1.1rem;
            border-radius: 6px;
            outline: none;
        }

        .search-row input:focus {
            border-color: var(--accent);
        }

        .search-row button {
            padding: 10px 20px;
            background: var(--accent-dim);
            border: 1px solid var(--accent);
            color: var(--dark-bg);
            font-family: inherit;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .search-row button:hover {
            background: var(--accent);
        }

        .standalone-card {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
        }

        .standalone-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-dim);
        }

        .back-link {
            display: block;
            text-align: center;
            margin-top: 20px;
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        .back-link a {
            color: var(--accent);
            text-decoration: none;
        }

        .back-link a:hover {
            text-decoration: underline;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--panel-bg);
            border: 1px solid var(--accent);
            color: var(--accent-light);
            padding: 10px 20px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9rem;
            z-index: 99999;
            transition: transform 0.3s ease;
            pointer-events: none;
        }

        .toast.visible {
            transform: translateX(-50%) translateY(0);
        }

        .toast.warning { border-color: #fbbf24; color: #fbbf24; }
        .toast.error { border-color: #ef4444; color: #ef4444; }
        .toast.success { border-color: #22c55e; color: #22c55e; }
    </style>
<script>
(function(){var Q=[],N=0,MAX=10;function send(e){var sb=window.supabase;if(!sb){Q.push(e);return;}if(N>=MAX)return;N++;sb.auth.getSession().then(function(r){var u=r&&r.data&&r.data.session&&r.data.session.user;if(!u)return;sb.from('ai_events').insert({event_type:'client_error',entity_type:'app',entity_id:u.id,username:location.pathname.split('/').filter(Boolean)[0]||'unknown',metadata:e,user_id:u.id}).then(function(){});}).catch(function(){});}window.onerror=function(m,s,l,c,e){send({type:'error',msg:String(m).slice(0,500),src:s||'',line:l,col:c,stack:e?String(e.stack).slice(0,1000):''});};window.addEventListener('unhandledrejection',function(ev){var r=ev.reason;send({type:'promise',msg:String(r&&r.message||r).slice(0,500),stack:r?String(r.stack||'').slice(0,1000):''});});var fi=setInterval(function(){if(window.supabase){Q.splice(0).forEach(send);clearInterval(fi);}},1000);setTimeout(function(){clearInterval(fi);},30000);})();
</script>
</head>
<body>
    <div class="profile-card" id="profileCard">
        <div class="profile-card-loading">Loading...</div>
    </div>

    <div class="standalone-container" id="standaloneUI">
        <div class="standalone-header">
            <h1>üë§ Sloppy Profiles</h1>
            <p>Look up any user's stats and karma</p>
        </div>
        <div class="search-row">
            <input type="text" id="searchInput" placeholder="Enter username..." autocomplete="off">
            <button onclick="searchProfile()">Search</button>
        </div>
        <div id="standaloneResult">
            <div class="standalone-empty">Search for a username to see their profile</div>
        </div>
        <div class="back-link"><a href="https://sloppy.live">sloppy.live</a></div>
    </div>

    <div class="toast" id="toast"></div>

<script type="module">
import { createBrowserClient } from "https://cdn.jsdelivr.net/npm/@supabase/ssr@0.7.0/+esm";

const SUPABASE_URL = 'https://yjyxteqzhhmtrgcaekgz.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM8IS32IUYR2eenCCjdDdioiBU';

const getCookieDomain = () => {
    const h = window.location.hostname;
    if (h.includes('sloppy.live')) return '.sloppy.live';
    if (h.includes('vibecodedbyx.com')) return '.vibecodedbyx.com';
    return '.youreabsolutelyright.xyz';
};

const supabase = createBrowserClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    cookieOptions: { name: 'sb-auth-token', domain: getCookieDomain(), path: '/', sameSite: 'lax' }
});
window.supabase = supabase;

// === AUTH ===
let currentUser = null;
let currentUsername = null;

async function initAuth() {
    try {
        const sessRes = await supabase.auth.getSession();
        let session = sessRes.data?.session;
        if (!session) {
            const signRes = await supabase.auth.signInAnonymously();
            session = signRes.data?.session;
        }
        if (session?.user) {
            currentUser = session.user;
            // Try to get username from profiles
            const { data } = await supabase.from('sloppygram_profiles').select('username').eq('user_id', currentUser.id).limit(1);
            if (data && data[0]) currentUsername = data[0].username;
        }
    } catch (e) {
        console.warn('[Profiles] Auth init failed:', e);
    }
}

// === UTILITIES ===
function escapeHtml(text) {
    if (!text) return '';
    return String(text).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

function escapeAttr(str) {
    return String(str || '').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#039;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function sanitizeUrl(url) {
    if (!url) return null;
    try {
        var u = new URL(url);
        if (u.protocol === 'https:' || u.protocol === 'http:') return u.href;
    } catch(e) {}
    return null;
}

function showToast(msg, type) {
    var t = document.getElementById('toast');
    if (!t) return;
    t.textContent = msg;
    t.className = 'toast' + (type ? ' ' + type : '');
    t.classList.add('visible');
    setTimeout(function() { t.classList.remove('visible'); }, 2500);
}

// Simple rate limiting
var _rateLimits = {};
function checkRateLimit(action) {
    var now = Date.now();
    var limits = { follow: { max: 10, window: 60000 } };
    var cfg = limits[action] || { max: 20, window: 60000 };
    if (!_rateLimits[action]) _rateLimits[action] = [];
    _rateLimits[action] = _rateLimits[action].filter(function(t) { return now - t < cfg.window; });
    if (_rateLimits[action].length >= cfg.max) {
        return { allowed: false, message: 'Too many actions, slow down' };
    }
    return { allowed: true };
}
function recordAction(action) {
    if (!_rateLimits[action]) _rateLimits[action] = [];
    _rateLimits[action].push(Date.now());
}

// === STATS CACHE ===
const USER_STATS_CACHE_TTL = 30 * 60 * 1000;
const userStatsMemoryCache = new Map();

async function getUserStats(username) {
    var memCached = userStatsMemoryCache.get(username);
    if (memCached && Date.now() - memCached.cachedAt < 60000) {
        return memCached.stats;
    }

    try {
        var cached = localStorage.getItem('userStats_' + username);
        if (cached) {
            var parsed = JSON.parse(cached);
            if (Date.now() - parsed.cachedAt < USER_STATS_CACHE_TTL) {
                userStatsMemoryCache.set(username, parsed);
                return parsed.stats;
            }
        }
    } catch (e) {}

    try {
        var [messagesRes, postsRes, doodlesRes, manifestosRes, avatarMsgRes, avatarPostRes] = await Promise.all([
            supabase.from('sloppygram_messages').select('id', { count: 'exact', head: true }).eq('username', username),
            supabase.from('sloppygram_posts').select('id, likes_count', { count: 'exact' }).eq('username', username),
            supabase.from('sloppygram_messages').select('id', { count: 'exact', head: true }).eq('username', username).eq('message_type', 'drawing'),
            supabase.from('sloppygram_manifestos').select('id', { count: 'exact', head: true }).eq('username', username),
            supabase.from('sloppygram_messages').select('avatar, avatar_url').eq('username', username).order('created_at', { ascending: false }).limit(1),
            supabase.from('sloppygram_posts').select('avatar, avatar_url').eq('username', username).order('created_at', { ascending: false }).limit(1)
        ]);

        var totalPosts = postsRes.count || 0;
        var totalMessages = messagesRes.count || 0;
        var totalDoodles = doodlesRes.count || 0;
        var totalManifestos = manifestosRes.count || 0;
        var totalLikes = (postsRes.data || []).reduce(function(sum, p) { return sum + (p.likes_count || 0); }, 0);

        var totalUpvotes = 0;
        var totalDownvotes = 0;
        var userPostIds = (postsRes.data || []).map(function(p) { return p.id; });
        if (userPostIds.length > 0) {
            var votesResult = await supabase.from('sloppygram_post_likes').select('vote_type').in('post_id', userPostIds);
            (votesResult.data || []).forEach(function(v) {
                if (v.vote_type > 0) totalUpvotes += v.vote_type;
                else if (v.vote_type < 0) totalDownvotes += Math.abs(v.vote_type);
            });
        }

        var avatar = 'üë§';
        var avatarUrl = null;
        var latestMsg = (avatarMsgRes.data && avatarMsgRes.data[0]) ? avatarMsgRes.data[0] : null;
        var latestPost = (avatarPostRes.data && avatarPostRes.data[0]) ? avatarPostRes.data[0] : null;
        if (latestMsg) { avatar = latestMsg.avatar || avatar; avatarUrl = latestMsg.avatar_url || avatarUrl; }
        if (latestPost) { avatar = latestPost.avatar || avatar; avatarUrl = latestPost.avatar_url || avatarUrl; }

        var stats = {
            messages: totalMessages, posts: totalPosts, doodles: totalDoodles,
            manifestos: totalManifestos, likes: totalLikes,
            upvotes: totalUpvotes, downvotes: totalDownvotes,
            avatar: avatar, avatarUrl: avatarUrl
        };

        var cacheEntry = { stats: stats, cachedAt: Date.now() };
        userStatsMemoryCache.set(username, cacheEntry);
        try { localStorage.setItem('userStats_' + username, JSON.stringify(cacheEntry)); } catch (e) {}

        return stats;
    } catch (err) {
        console.error('Error fetching user stats:', err);
        return { messages: 0, posts: 0, doodles: 0, manifestos: 0, likes: 0, upvotes: 0, downvotes: 0, avatar: 'üë§', avatarUrl: null };
    }
}

// === VERIFICATIONS ===
var verificationCache = {};

async function getUserVerifications(username) {
    var cached = verificationCache[username];
    if (cached && Date.now() - cached.fetchedAt < 120000) return cached.data;

    try {
        var result = await supabase.from('sloppyid_verifications').select('verification_type, is_verified, verification_value').eq('username', username).eq('is_verified', true);
        if (result.error || !result.data) {
            verificationCache[username] = { data: { verifications: [], trustScore: 0 }, fetchedAt: Date.now() };
            return verificationCache[username].data;
        }

        var trustScore = 0;
        var verifications = [];
        result.data.forEach(function(v) {
            if (v.verification_type === 'twitter') { trustScore += 100; verifications.push({ type: 'twitter', label: 'ùïè' }); }
            else if (v.verification_type === 'email') { trustScore += 150; verifications.push({ type: 'email', label: 'üìß' }); }
            else if (v.verification_type === 'github') { trustScore += 200; verifications.push({ type: 'github', label: '@' + (v.verification_value || '') }); }
        });

        var data = { verifications: verifications, trustScore: trustScore };
        verificationCache[username] = { data: data, fetchedAt: Date.now() };
        return data;
    } catch (e) {
        console.warn('[Profiles] Verification lookup failed:', e);
        return { verifications: [], trustScore: 0 };
    }
}

// === CROSS-APP STATS ===
async function getCrossAppStats(username) {
    var gameScores = [];
    try {
        var [breakout, icyTower, tetris, starCatcher] = await Promise.all([
            supabase.from('breakout_terminal_scores').select('score, display_name').eq('display_name', username).order('score', { ascending: false }).limit(1),
            supabase.from('icy_tower_scores').select('score, display_name').eq('display_name', username).order('score', { ascending: false }).limit(1),
            supabase.from('tetris_leaderboard').select('score, display_name').eq('display_name', username).order('score', { ascending: false }).limit(1),
            supabase.from('star_catcher_leaderboard').select('score, display_name').eq('display_name', username).order('score', { ascending: false }).limit(1)
        ]);

        if (breakout.data && breakout.data[0]) gameScores.push({ game: 'Breakout', score: breakout.data[0].score });
        if (icyTower.data && icyTower.data[0]) gameScores.push({ game: 'Icy Tower', score: icyTower.data[0].score });
        if (tetris.data && tetris.data[0]) gameScores.push({ game: 'Tetris', score: tetris.data[0].score });
        if (starCatcher.data && starCatcher.data[0]) gameScores.push({ game: 'Star Catcher', score: starCatcher.data[0].score });
    } catch (err) {
        console.error('[CrossApp] Error fetching scores:', err);
    }
    return gameScores;
}

// === FOLLOW SYSTEM ===
async function getFollowCounts(username) {
    try {
        var [followersRes, followingRes] = await Promise.all([
            supabase.from('sloppygram_follows').select('id', { count: 'exact', head: true }).eq('followed_username', username),
            supabase.from('sloppygram_follows').select('id', { count: 'exact', head: true }).eq('follower_username', username)
        ]);
        return { followers: followersRes.count || 0, following: followingRes.count || 0 };
    } catch (err) {
        console.error('Error getting follow counts:', err);
        return { followers: 0, following: 0 };
    }
}

async function isFollowing(username) {
    if (!currentUser || !currentUsername) return false;
    if (currentUsername === username) return false;
    try {
        var result = await supabase.from('sloppygram_follows').select('id').eq('follower_username', currentUsername).eq('followed_username', username).limit(1);
        return result.data && result.data.length > 0;
    } catch (err) {
        console.error('Error checking follow status:', err);
        return false;
    }
}

async function followUser(username) {
    if (!currentUser || !currentUsername) { showToast('Sign in to follow users', 'warning'); return false; }
    if (currentUsername === username) { showToast("You can't follow yourself", 'warning'); return false; }

    var rateCheck = checkRateLimit('follow');
    if (!rateCheck.allowed) { showToast(rateCheck.message, 'warning'); return false; }
    recordAction('follow');

    try {
        var result = await supabase.from('sloppygram_follows').insert({
            follower_username: currentUsername,
            followed_username: username,
            follower_id: currentUser.id,
            followed_id: null,
            user_id: currentUser.id
        });

        if (result.error) {
            if (result.error.code === '23505') { showToast('Already following ' + username, 'info'); return true; }
            throw result.error;
        }

        showToast('Now following @' + username, 'success');

        // Log to ai_events
        supabase.from('ai_events').insert({
            event_type: 'follow', entity_type: 'user', entity_id: username,
            username: currentUsername, metadata: { followed_username: username }, user_id: currentUser.id
        }).then(function(){}).catch(function(){});

        return true;
    } catch (err) {
        console.error('Error following user:', err);
        showToast('Could not follow user', 'error');
        return false;
    }
}

async function unfollowUser(username) {
    if (!currentUser || !currentUsername) return false;
    try {
        var result = await supabase.from('sloppygram_follows').delete().eq('follower_username', currentUsername).eq('followed_username', username);
        if (result.error) throw result.error;
        showToast('Unfollowed @' + username, 'info');
        return true;
    } catch (err) {
        console.error('Error unfollowing user:', err);
        showToast('Could not unfollow user', 'error');
        return false;
    }
}

async function toggleFollow(username, btn) {
    if (!btn) return;
    var wasFollowing = btn.classList.contains('following');
    btn.disabled = true;
    btn.textContent = '...';

    var success = wasFollowing ? await unfollowUser(username) : await followUser(username);

    if (success) {
        btn.classList.toggle('following', !wasFollowing);
        btn.classList.toggle('follow', wasFollowing);
        btn.textContent = wasFollowing ? '+ Follow' : 'Following';

        var countEl = document.querySelector('.profile-follow-stat-value[data-type="followers"]');
        if (countEl) {
            var current = parseInt(countEl.textContent) || 0;
            countEl.textContent = wasFollowing ? Math.max(0, current - 1) : current + 1;
        }

        // Notify parent of follow change
        if (isEmbedMode) {
            window.parent.postMessage({ type: 'follow-changed', username: username, following: !wasFollowing }, '*');
        }
    } else {
        btn.textContent = wasFollowing ? 'Following' : '+ Follow';
    }
    btn.disabled = false;
}
window.toggleFollow = toggleFollow;

// === KARMA (request from parent or calculate locally) ===
var _karmaRequestId = 0;
var _karmaCallbacks = {};

function requestKarmaFromParent(username) {
    if (!isEmbedMode) return Promise.resolve(null);
    return new Promise(function(resolve) {
        var id = ++_karmaRequestId;
        var timer = setTimeout(function() { delete _karmaCallbacks[id]; resolve(null); }, 5000);
        _karmaCallbacks[id] = function(result) { clearTimeout(timer); resolve(result); };
        window.parent.postMessage({ type: 'request-karma', username: username, requestId: id }, '*');
    });
}

function getEarnedBadges(karmaData) {
    if (!karmaData) return [];
    var badges = [];
    if (karmaData.total >= 1000) badges.push({ emoji: 'üëë', name: 'Legend' });
    else if (karmaData.total >= 500) badges.push({ emoji: 'üèÜ', name: 'Community Pillar' });
    else if (karmaData.total >= 100) badges.push({ emoji: '‚≠ê', name: 'Rising Star' });
    if (karmaData.doodles >= 25) badges.push({ emoji: 'üé®', name: 'Doodle Master' });
    if (karmaData.manifestos >= 25) badges.push({ emoji: 'üèõÔ∏è', name: 'Philosopher' });
    if (karmaData.upvotes >= 100) badges.push({ emoji: 'üî•', name: 'Popular' });
    if (karmaData.reactions >= 50) badges.push({ emoji: '‚ù§Ô∏è', name: 'Beloved' });
    if (karmaData.diversity >= 4) badges.push({ emoji: 'üåà', name: 'Diverse Creator' });
    return badges;
}

// === RENDER PROFILE CARD ===
async function renderProfileCard(username, x, y) {
    var card = document.getElementById('profileCard');
    if (!card) return;

    // Position
    var cardWidth = 280;
    var cardHeight = 260;
    var left = x || 100;
    var top = (y || 100) + 8;

    if (left + cardWidth > window.innerWidth) left = window.innerWidth - cardWidth - 16;
    if (top + cardHeight > window.innerHeight) top = Math.max(8, (y || 100) - cardHeight - 8);

    card.style.left = Math.max(8, left) + 'px';
    card.style.top = Math.max(8, top) + 'px';

    card.innerHTML = '<div class="profile-card-loading">Loading...</div>';
    card.classList.add('visible');

    try {
        var [stats, gameScores, karmaData, followCounts, following, verifyData] = await Promise.all([
            getUserStats(username),
            getCrossAppStats(username),
            requestKarmaFromParent(username),
            getFollowCounts(username),
            isFollowing(username),
            getUserVerifications(username)
        ]);

        var safeAvatarUrl = sanitizeUrl(stats.avatarUrl);
        var avatarContent = safeAvatarUrl
            ? '<img src="' + escapeAttr(safeAvatarUrl) + '" alt="' + escapeHtml(username) + '" width="48" height="48">'
            : (stats.avatar || 'üë§');

        // Game scores HTML
        var gameScoresHtml = '';
        if (gameScores && gameScores.length > 0) {
            var scoresHtml = gameScores.map(function(g) {
                return '<div class="profile-game-score"><span class="game-name">' + escapeHtml(g.game) + ':</span><span class="game-score">' + g.score.toLocaleString() + '</span></div>';
            }).join('');
            gameScoresHtml = '<div class="profile-crossapp"><div class="profile-crossapp-title">üéÆ Game High Scores</div><div class="profile-game-scores">' + scoresHtml + '</div></div>';
        }

        // Karma HTML
        var karmaHtml = '';
        if (karmaData && karmaData.total > 0) {
            var badges = getEarnedBadges(karmaData);
            var badgesHtml = badges.slice(0, 4).map(function(b) { return '<span class="profile-karma-badge" title="' + escapeAttr(b.name) + '">' + b.emoji + '</span>'; }).join('');
            karmaHtml = '<div class="profile-karma-section">' +
                '<div class="profile-karma-header">' +
                '<span class="profile-karma-total">‚ö°' + karmaData.total + '</span>' +
                '<span class="profile-karma-badges">' + badgesHtml + '</span>' +
                '</div>' +
                '<div class="profile-karma-breakdown">' +
                '<span title="Content">üìù' + karmaData.content + '</span>' +
                '<span title="Engagement">üëç' + karmaData.engagement + '</span>' +
                '<span title="Social">üí¨' + karmaData.social + '</span>' +
                '</div></div>';
        }

        // Follow stats
        var isSelf = currentUsername === username;
        var followStatsHtml = '<div class="profile-follow-stats">' +
            '<div class="profile-follow-stat" title="People following this user">' +
            '<div class="profile-follow-stat-value" data-type="followers">' + followCounts.followers + '</div>' +
            '<div class="profile-follow-stat-label">Followers</div></div>' +
            '<div class="profile-follow-stat" title="People this user follows">' +
            '<div class="profile-follow-stat-value" data-type="following">' + followCounts.following + '</div>' +
            '<div class="profile-follow-stat-label">Following</div></div></div>';

        // Follow button
        var followBtnHtml = !isSelf ? '<button class="follow-btn ' + (following ? 'following' : 'follow') + '" onclick="toggleFollow(\'' + escapeAttr(username) + '\', this)">' + (following ? 'Following' : '+ Follow') + '</button>' : '';

        // Trust/verification row
        var trustHtml = '';
        if (verifyData && (verifyData.trustScore > 0 || verifyData.verifications.length > 0)) {
            var badgeChips = verifyData.verifications.map(function(v) {
                return '<span class="verify-badge ' + v.type + '">' + escapeHtml(v.label) + '</span>';
            }).join('');
            trustHtml = '<div class="profile-trust-row">' +
                '<span class="profile-trust-score">‚ö°' + verifyData.trustScore + '</span>' +
                '<span class="profile-trust-label">Trust</span>' +
                '<div class="profile-verify-badges">' + badgeChips + '</div></div>';
        }

        // DM button onclick
        var dmOnclick = isEmbedMode
            ? 'window.parent.postMessage({type:&quot;start-dm&quot;,username:&quot;' + escapeAttr(username) + '&quot;},&quot;*&quot;);hideProfileCard();'
            : '';

        card.innerHTML =
            '<div class="profile-card-header">' +
            '<div class="profile-card-avatar">' + avatarContent + '</div>' +
            '<div class="profile-card-name">' + escapeHtml(username) + '</div>' +
            '</div>' +
            trustHtml +
            followStatsHtml +
            karmaHtml +
            '<div class="profile-card-stats">' +
            '<div class="profile-card-stat"><div class="profile-card-stat-value">' + stats.messages + '</div><div class="profile-card-stat-label">Messages</div></div>' +
            '<div class="profile-card-stat"><div class="profile-card-stat-value">' + stats.posts + '</div><div class="profile-card-stat-label">Posts</div></div>' +
            '<div class="profile-card-stat"><div class="profile-card-stat-value">' + stats.doodles + '</div><div class="profile-card-stat-label">Doodles</div></div>' +
            '</div>' +
            '<div class="profile-card-stats" style="margin-bottom:0;">' +
            '<div class="profile-card-stat"><div class="profile-card-stat-value">' + stats.manifestos + '</div><div class="profile-card-stat-label">Manifestos</div></div>' +
            '<div class="profile-card-stat"><div class="profile-card-stat-value" style="color:#4a9">‚ñ≤' + (stats.upvotes || 0) + '</div><div class="profile-card-stat-label">Upvotes</div></div>' +
            '<div class="profile-card-stat"><div class="profile-card-stat-value" style="color:#c66">‚ñº' + (stats.downvotes || 0) + '</div><div class="profile-card-stat-label">Downvotes</div></div>' +
            '</div>' +
            gameScoresHtml +
            '<div class="profile-card-actions">' +
            followBtnHtml +
            '<a href="/sloppy-id?search=' + encodeURIComponent(username) + '" target="_blank" style="font-size:0.75rem;color:var(--accent);text-decoration:none;padding:6px 12px;border:1px solid var(--accent);border-radius:4px;">ü™™ SloppyID</a>' +
            (dmOnclick ? '<button onclick="' + dmOnclick + '" style="font-size:0.75rem;color:#00d4ff;background:none;border:1px solid #00d4ff;border-radius:4px;padding:6px 12px;cursor:pointer;font-family:inherit;">‚úâÔ∏è DM</button>' : '') +
            '</div>';
    } catch (err) {
        console.error('Error loading profile:', err);
        card.innerHTML = '<div class="profile-card-loading">Could not load profile</div>';
    }
}

function hideProfileCard() {
    var card = document.getElementById('profileCard');
    if (card) card.classList.remove('visible');
    if (isEmbedMode) {
        window.parent.postMessage({ type: 'profile-hidden' }, '*');
    }
}
window.hideProfileCard = hideProfileCard;

// Click outside to dismiss
document.addEventListener('click', function(e) {
    var card = document.getElementById('profileCard');
    if (card && card.classList.contains('visible') && !card.contains(e.target)) {
        hideProfileCard();
    }
});

// === MODE DETECTION ===
var isEmbedMode = new URLSearchParams(window.location.search).get('embed') === 'true';

if (isEmbedMode) {
    document.body.classList.add('embed-mode');
    var standaloneUI = document.getElementById('standaloneUI');
    if (standaloneUI) standaloneUI.style.display = 'none';
    var toastEl = document.getElementById('toast');
    if (toastEl) toastEl.style.display = 'none';
}

// === EMBED: postMessage listener ===
window.addEventListener('message', function(e) {
    if (!e.data || !e.data.type) return;

    if (e.data.type === 'show-profile') {
        renderProfileCard(e.data.username, e.data.x || 100, e.data.y || 100);
    }
    if (e.data.type === 'hide-profile') {
        hideProfileCard();
    }
    // Karma result forwarded from parent
    if (e.data.type === 'karma-result-for-profile' && e.data.requestId && _karmaCallbacks[e.data.requestId]) {
        _karmaCallbacks[e.data.requestId](e.data.karma || null);
        delete _karmaCallbacks[e.data.requestId];
    }
});

// === STANDALONE: search ===
window.searchProfile = async function() {
    var input = document.getElementById('searchInput');
    var username = (input.value || '').trim();
    if (!username) return;

    var resultDiv = document.getElementById('standaloneResult');
    resultDiv.innerHTML = '<div class="profile-card-loading">Loading...</div>';

    // Re-use the card render but position it inside the standalone container
    var card = document.getElementById('profileCard');
    if (card) {
        card.style.position = 'relative';
        card.style.left = 'auto';
        card.style.top = 'auto';
        card.style.maxWidth = '100%';
        card.style.minWidth = '0';
        card.style.width = '100%';
        card.style.display = 'block';
        card.style.animation = 'none';
        card.classList.add('visible');
        resultDiv.innerHTML = '';
        resultDiv.appendChild(card);
    }

    await renderProfileCard(username, 0, 0);

    // Override position for standalone
    if (card) {
        card.style.position = 'relative';
        card.style.left = 'auto';
        card.style.top = 'auto';
    }
};

// Enter to search
document.getElementById('searchInput')?.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') window.searchProfile();
});

// URL search param
var urlSearch = new URLSearchParams(window.location.search).get('search');
if (urlSearch && !isEmbedMode) {
    document.getElementById('searchInput').value = urlSearch;
    // Wait for auth then search
    initAuth().then(function() { window.searchProfile(); });
} else {
    initAuth();
}
</script>
</body>
</html>
