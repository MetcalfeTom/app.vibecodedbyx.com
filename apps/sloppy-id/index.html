<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SloppyID - Identity Hub</title>
  <link rel="icon" href="https://emojicdn.elk.sh/ðŸªª">
  <script src="/vibelib-extended.js"></script>
  <script src="/sloppy-header/sloppy-bar.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #0a0a12;
      --panel: #12121c;
      --border: #2a2a3a;
      --cyan: #00d4ff;
      --purple: #a855f7;
      --green: #00ff88;
      --gold: #ffd700;
      --text: #e0e0e8;
      --text-dim: #6a6a7a;
      --gradient: linear-gradient(135deg, var(--cyan), var(--purple));
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'IBM Plex Mono', monospace; background: var(--bg); color: var(--text); min-height: 100vh; }

    .container { max-width: 900px; margin: 0 auto; padding: 40px 20px; }
    .header { text-align: center; margin-bottom: 40px; }
    .logo { font-family: 'Orbitron', sans-serif; font-size: 2.5rem; background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px; }

    .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border); }
    .nav-tab { padding: 10px 20px; cursor: pointer; color: var(--text-dim); border-bottom: 2px solid transparent; }
    .nav-tab.active { color: var(--cyan); border-color: var(--cyan); }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Profile Styles */
    .profile-card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 24px; }
    .form-group { margin-bottom: 15px; }
    .form-label { display: block; margin-bottom: 5px; color: var(--text-dim); }
    .form-input { width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: var(--text); border-radius: 5px; }
    .btn { padding: 10px 20px; background: var(--gradient); border: none; border-radius: 5px; color: #000; font-weight: bold; cursor: pointer; }

    /* Marketplace Styles */
    .balance-card { background: linear-gradient(135deg, rgba(0,212,255,0.1), rgba(168,85,247,0.1)); border: 1px solid var(--cyan); padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
    .balance-amount { font-size: 2rem; font-family: 'Orbitron', sans-serif; color: var(--gold); }

    .items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
    .market-item { background: var(--panel); border: 1px solid var(--border); padding: 15px; border-radius: 10px; text-align: center; }
    .item-icon { font-size: 3rem; margin-bottom: 10px; }
    .item-name { font-weight: bold; margin-bottom: 5px; }
    .item-cost { color: var(--gold); margin-bottom: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1 class="logo">SloppyID</h1>
      <p>Sovereign Identity Manager</p>
    </header>

    <div class="nav-tabs">
      <div class="nav-tab active" onclick="switchTab('profile')">Profile</div>
      <div class="nav-tab" onclick="switchTab('market')">Marketplace</div>
    </div>

    <!-- Profile Tab -->
    <div id="tab-profile" class="tab-content active">
      <div class="profile-card">
        <div class="form-group">
            <label class="form-label">Username</label>
            <input type="text" id="p-username" class="form-input" disabled>
        </div>
        <div class="form-group">
            <label class="form-label">Bio</label>
            <textarea id="p-bio" class="form-input" rows="3"></textarea>
        </div>
        <div class="form-group">
            <label class="form-label">Avatar URL</label>
            <input type="text" id="p-avatar" class="form-input" placeholder="https://...">
        </div>
        <div class="form-group">
            <label class="form-label">Theme Background URL</label>
            <input type="text" id="p-bg" class="form-input" placeholder="https://...">
        </div>
        <button class="btn" onclick="saveProfile()">Save Changes</button>
      </div>
    </div>

    <!-- Marketplace Tab -->
    <div id="tab-market" class="tab-content">
      <div class="balance-card">
        <div>Your Balance</div>
        <div class="balance-amount" id="m-balance">0</div>
        <div>Karma</div>
      </div>

      <div class="items-grid">
        <div class="market-item">
            <div class="item-icon">ðŸ‘‘</div>
            <div class="item-name">Gold Crown</div>
            <div class="item-cost">10,000 Karma</div>
            <button class="btn" onclick="buyItem('gold_crown', 10000)">Buy</button>
        </div>
        <div class="market-item">
            <div class="item-icon">ðŸŒŒ</div>
            <div class="item-name">Blue Neon Theme</div>
            <div class="item-cost">500 Karma</div>
            <button class="btn" onclick="buyItem('blue_neon_theme', 500)">Buy</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let currentProfile = {};
    let currentBalance = 0;

    // Tab Switcher
    window.switchTab = function(tab) {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector(`.nav-tab[onclick="switchTab('${tab}')"]`).classList.add('active');
        document.getElementById(`tab-${tab}`).classList.add('active');
    };

    // Check URL params for tab
    const urlParams = new URLSearchParams(window.location.search);
    if(urlParams.get('tab') === 'market') switchTab('market');

    async function init() {
        // Wait for VibeLib
        if (!window.VibeLib) { setTimeout(init, 100); return; }

        currentUser = await window.VibeLib.Auth.getUser();
        if (!currentUser) {
            // Wait for SloppyBar to handle login UI
            return;
        }

        await loadProfile();
        await loadEconomy();
    }

    async function loadProfile() {
        currentProfile = await window.VibeLib.Identity.get(currentUser.id);

        document.getElementById('p-username').value = currentProfile.username || 'Anonymous';
        document.getElementById('p-bio').value = currentProfile.bio || '';
        document.getElementById('p-avatar').value = currentProfile.avatar_url || '';
        document.getElementById('p-bg').value = (currentProfile.theme_colors && currentProfile.theme_colors.bgUrl) || '';
    }

    async function saveProfile() {
        const bio = document.getElementById('p-bio').value;
        const avatar_url = document.getElementById('p-avatar').value;
        const bgUrl = document.getElementById('p-bg').value;

        const theme_colors = currentProfile.theme_colors || {};
        theme_colors.bgUrl = bgUrl;

        try {
            await window.VibeLib.Identity.update({
                bio,
                avatar_url,
                theme_colors
            });
            alert('Profile saved!');
        } catch (e) {
            alert('Error saving profile: ' + e.message);
        }
    }

    async function loadEconomy() {
        // Fetch balance from economy_balances
        const { data } = await window.supabase
            .from('economy_balances')
            .select('participation_score, inventory')
            .eq('user_id', currentUser.id)
            .single();

        if (data) {
            currentBalance = data.participation_score || 0;
            document.getElementById('m-balance').innerText = currentBalance.toLocaleString();
            // TODO: check inventory to disable buy buttons if already owned?
        }
    }

    window.buyItem = async function(itemId, cost) {
        if (currentBalance < cost) {
            alert('Insufficient Karma!');
            return;
        }

        if (!confirm(`Buy ${itemId} for ${cost} Karma?`)) return;

        // Deduct balance and add to inventory
        // Note: In a real app this should be an RPC or server-side transaction.
        // For this task, we'll do client-side update (optimistic)

        // 1. Fetch current inventory
        const { data: userData } = await window.supabase
            .from('economy_balances')
            .select('inventory')
            .eq('user_id', currentUser.id)
            .single();

        const inventory = userData?.inventory || [];
        if (inventory.includes(itemId)) {
            alert('You already own this item!');
            return;
        }

        inventory.push(itemId);
        const newBalance = currentBalance - cost;

        const { error } = await window.supabase
            .from('economy_balances')
            .update({
                participation_score: newBalance,
                inventory: inventory
            })
            .eq('user_id', currentUser.id);

        if (error) {
            alert('Transaction failed: ' + error.message);
        } else {
            alert('Purchase successful!');
            loadEconomy();
        }
    };

    window.addEventListener('load', init);
  </script>
</body>
</html>
