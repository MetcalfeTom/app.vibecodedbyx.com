<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sea Scourge - Pirate Ship Combat</title>
<link rel="icon" href="https://emojicdn.elk.sh/üè¥‚Äç‚ò†Ô∏è">
<meta property="og:title" content="Sea Scourge - Pirate Ship Combat">
<meta property="og:description" content="Battle the legendary Kraken boss! Command yer vessel and blast enemies to Davy Jones' locker!">
<meta property="og:url" content="https://app.sloppy.live/asteroids">
<meta property="og:image" content="https://emojicdn.elk.sh/üè¥‚Äç‚ò†Ô∏è?style=apple&size=512">
<link href="https://fonts.googleapis.com/css2?family=Pirata+One&family=IM+Fell+English+SC&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'IM Fell English SC',serif;background:#0a0d12;color:#d4a84b;overflow:hidden;height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center}
#gameCanvas{border:4px solid #5c3a1e;box-shadow:0 0 30px rgba(139,90,43,.4);background:#0d1a2a}
.ui{position:fixed;top:20px;left:20px;right:20px;display:flex;justify-content:space-between;align-items:flex-start;pointer-events:none;z-index:100}
.stat-panel{background:rgba(10,13,18,.95);border:3px solid #5c3a1e;padding:15px 20px;border-radius:8px;box-shadow:0 0 15px rgba(212,168,75,.3);min-width:150px}
.stat-label{font-size:12px;opacity:.7;text-transform:uppercase;font-family:'Pirata One',cursive;letter-spacing:1px}
.stat-value{font-size:24px;font-weight:bold;margin-top:5px;text-shadow:0 0 10px rgba(212,168,75,.5);font-family:'Pirata One',cursive}
.lives{display:flex;gap:8px;margin-top:5px}
.life-icon{font-size:20px;text-shadow:0 0 8px rgba(212,168,75,.5)}
.boss-bar{position:fixed;top:100px;left:50%;transform:translateX(-50%);width:400px;max-width:90%;display:none;z-index:150}
.boss-bar.show{display:block;animation:bossAppear .5s}
@keyframes bossAppear{from{opacity:0;transform:translateX(-50%) scale(0.8)}to{opacity:1;transform:translateX(-50%) scale(1)}}
.boss-name{font-family:'Pirata One',cursive;font-size:24px;text-align:center;color:#ff4444;text-shadow:0 0 20px #ff0000;margin-bottom:8px;letter-spacing:2px}
.boss-health-bg{background:rgba(50,0,0,.8);border:3px solid #8b0000;border-radius:10px;height:25px;overflow:hidden}
.boss-health-fill{height:100%;background:linear-gradient(90deg,#8b0000,#ff0000,#ff4444);transition:width .3s;box-shadow:0 0 20px #ff0000}
.game-over-screen{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(10,13,18,.98);border:4px solid #5c3a1e;padding:40px;border-radius:15px;text-align:center;display:none;z-index:200;box-shadow:0 0 40px rgba(139,90,43,.6);min-width:400px;max-width:90%}
.game-over-screen.show{display:block;animation:slideIn .5s}
@keyframes slideIn{from{transform:translate(-50%,-60%);opacity:0}to{transform:translate(-50%,-50%);opacity:1}}
.game-over-screen h1{font-size:36px;margin-bottom:20px;text-shadow:0 0 20px rgba(212,168,75,.5);font-family:'Pirata One',cursive}
.final-stats{margin:20px 0;display:flex;flex-direction:column;gap:10px}
.stat-row{display:flex;justify-content:space-between;font-size:16px}
.leaderboard-section{margin-top:20px;border-top:2px solid #5c3a1e;padding-top:20px}
.leaderboard-section h3{font-family:'Pirata One',cursive;margin-bottom:15px;color:#d4a84b}
.score-input{display:flex;gap:10px;margin-bottom:15px}
.score-input input{flex:1;background:rgba(92,58,30,.3);border:2px solid #5c3a1e;color:#d4a84b;padding:10px;font-family:'IM Fell English SC',serif;font-size:16px;border-radius:5px}
.score-input input::placeholder{color:#8b7355}
.leaderboard{max-height:200px;overflow-y:auto}
.leaderboard-entry{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(92,58,30,.5);font-size:14px}
.leaderboard-entry.highlight{background:rgba(212,168,75,.2);padding:8px;border-radius:5px}
.rank{color:#8b7355;width:30px}
.btn{background:linear-gradient(135deg,#5c3a1e,#8b5a2b);border:3px solid #d4a84b;color:#d4a84b;padding:12px 30px;font-size:16px;font-family:'Pirata One',cursive;cursor:pointer;margin:5px;border-radius:5px;transition:all .3s;pointer-events:all}
.btn:hover{background:linear-gradient(135deg,#8b5a2b,#d4a84b);color:#1a0f0a;box-shadow:0 0 25px rgba(212,168,75,.5);transform:scale(1.05)}
.btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
.btn-small{padding:8px 20px;font-size:14px}
.controls{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(10,13,18,.9);border:2px solid #5c3a1e;padding:15px 25px;border-radius:8px;text-align:center;font-size:14px;box-shadow:0 0 15px rgba(139,90,43,.3);color:#8b7355}
.level-up{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:48px;font-weight:bold;color:#d4a84b;text-shadow:0 0 30px rgba(212,168,75,.8);pointer-events:none;z-index:150;display:none;font-family:'Pirata One',cursive}
.level-up.show{display:block;animation:levelUpAnim 2s}
.boss-warning{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:42px;color:#ff0000;text-shadow:0 0 40px #ff0000;pointer-events:none;z-index:150;display:none;font-family:'Pirata One',cursive}
.boss-warning.show{display:block;animation:bossWarn 3s}
@keyframes bossWarn{0%,100%{opacity:0;transform:translate(-50%,-50%) scale(0.5)}10%,90%{opacity:1;transform:translate(-50%,-50%) scale(1)}50%{transform:translate(-50%,-50%) scale(1.1)}}
@keyframes levelUpAnim{0%{opacity:0;transform:translate(-50%,-50%) scale(.5)}20%{opacity:1;transform:translate(-50%,-50%) scale(1.2)}80%{opacity:1;transform:translate(-50%,-50%) scale(1)}100%{opacity:0;transform:translate(-50%,-50%) scale(.8)}}
@media (max-width:768px){
.controls{display:none}
.stat-panel{padding:10px;min-width:80px}
.stat-value{font-size:16px}
.game-over-screen{min-width:300px;padding:25px 15px}
.boss-bar{width:90%}
.mobile-controls{display:flex}
}
.mobile-controls{display:none;position:fixed;bottom:20px;left:0;right:0;justify-content:space-between;padding:0 20px;z-index:100;pointer-events:none}
.mobile-left,.mobile-right{display:flex;gap:10px;pointer-events:all}
.touch-btn{width:70px;height:70px;border-radius:50%;background:rgba(212,168,75,0.2);border:3px solid rgba(212,168,75,0.5);color:#d4a84b;font-size:24px;display:flex;align-items:center;justify-content:center;user-select:none;-webkit-user-select:none;touch-action:none}
.touch-btn:active{background:rgba(212,168,75,0.4);transform:scale(0.95)}
.touch-btn.fire{background:rgba(255,100,0,0.3);border-color:rgba(255,100,0,0.6);color:#ff6600;width:80px;height:80px;font-size:28px}
</style>
</head>
<body>
<div class="ui">
<div class="stat-panel">
<div class="stat-label">Doubloons</div>
<div class="stat-value" id="score">0</div>
</div>
<div class="stat-panel">
<div class="stat-label">Wave</div>
<div class="stat-value" id="level">1</div>
</div>
<div class="stat-panel">
<div class="stat-label">Fleet</div>
<div class="lives" id="lives">
<span class="life-icon">‚õµ</span>
<span class="life-icon">‚õµ</span>
<span class="life-icon">‚õµ</span>
</div>
</div>
</div>

<div class="boss-bar" id="bossBar">
<div class="boss-name" id="bossName">THE LEVIATHAN</div>
<div class="boss-health-bg">
<div class="boss-health-fill" id="bossHealth" style="width:100%"></div>
</div>
</div>

<canvas id="gameCanvas"></canvas>
<div class="level-up" id="levelUp">WAVE CLEARED!</div>
<div class="boss-warning" id="bossWarning">‚öì THE KRAKEN AWAKENS! ‚öì</div>

<div class="game-over-screen" id="gameOverScreen">
<h1>YE WALKED THE PLANK!</h1>
<div class="final-stats">
<div class="stat-row"><span>Booty Plundered:</span><span id="finalScore">0</span></div>
<div class="stat-row"><span>Waves Survived:</span><span id="finalLevel">1</span></div>
<div class="stat-row"><span>Ships Sunk:</span><span id="shipsDestroyed">0</span></div>
<div class="stat-row"><span>Krakens Slain:</span><span id="krakensSlain">0</span></div>
</div>
<div class="leaderboard-section">
<h3>üè¥‚Äç‚ò†Ô∏è Hall of Pirates üè¥‚Äç‚ò†Ô∏è</h3>
<div class="score-input" id="scoreInput">
<input type="text" id="playerName" placeholder="Enter yer name, Captain..." maxlength="20">
<button class="btn btn-small" id="submitScore">Submit</button>
</div>
<div class="leaderboard" id="leaderboard">Loading...</div>
</div>
<button class="btn" onclick="startGame()">SET SAIL AGAIN!</button>
<div style="margin-top:15px;font-size:12px;opacity:.7">
<a href="https://sloppy.live" style="color:#d4a84b;text-decoration:none">sloppy.live</a>
</div>
</div>
<div class="controls"><strong>HELM:</strong> ARROWS to steer & sail | SPACE to fire cannons | P to pause</div>

<div class="mobile-controls" id="mobileControls">
<div class="mobile-left">
<button class="touch-btn" id="touchLeft">‚óÄ</button>
<button class="touch-btn" id="touchRight">‚ñ∂</button>
</div>
<div class="mobile-right">
<button class="touch-btn" id="touchThrust">‚ñ≤</button>
<button class="touch-btn fire" id="touchFire">üí•</button>
</div>
</div>

<script src="/supabase-config.js"></script>
<script>
const c=document.getElementById('gameCanvas'),ctx=c.getContext('2d');
const resizeCanvas=()=>{c.width=Math.min(window.innerWidth-40,1200);c.height=Math.min(window.innerHeight-40,800)};
resizeCanvas();
window.addEventListener('resize',resizeCanvas);

let gameRunning=false,paused=false,score=0,level=1,lives=3,shipsDestroyed=0,krakensSlain=0;
let ship=null,cannonballs=[],enemies=[],particles=[],waves=[],keys={},inkShots=[],boss=null;
let currentUser=null;

// Auth init
async function initAuth(){
const{data:{user}}=await supabase.auth.getUser();
if(user){currentUser=user}
else{const{data}=await supabase.auth.signInAnonymously();if(data?.user)currentUser=data.user}
}
initAuth();

class Wave{
constructor(y){this.y=y;this.offset=Math.random()*Math.PI*2;this.speed=0.02+Math.random()*0.01;this.amplitude=3+Math.random()*3}
draw(){
ctx.strokeStyle='rgba(30,80,120,0.3)';ctx.lineWidth=1;ctx.beginPath();
for(let x=0;x<c.width;x+=10){const waveY=this.y+Math.sin(x*0.02+this.offset)*this.amplitude;if(x===0)ctx.moveTo(x,waveY);else ctx.lineTo(x,waveY)}
ctx.stroke();this.offset+=this.speed
}}

class Ship{
constructor(){this.x=c.width/2;this.y=c.height/2;this.angle=-Math.PI/2;this.velocity={x:0,y:0};this.size=20;this.rotationSpeed=.08;this.thrust=.12;this.friction=.985;this.invincible=false;this.invincibleTime=0;this.sailAngle=0}
update(){
if(keys['ArrowLeft'])this.angle-=this.rotationSpeed;
if(keys['ArrowRight'])this.angle+=this.rotationSpeed;
if(keys['ArrowUp']){
this.velocity.x+=Math.cos(this.angle)*this.thrust;this.velocity.y+=Math.sin(this.angle)*this.thrust;
this.sailAngle=Math.sin(Date.now()*0.01)*0.2;
for(let i=0;i<2;i++)particles.push(new Particle(this.x-Math.cos(this.angle)*this.size,this.y-Math.sin(this.angle)*this.size,'#4a90a4',3,'wake'))}
this.velocity.x*=this.friction;this.velocity.y*=this.friction;
this.x+=this.velocity.x;this.y+=this.velocity.y;
if(this.x<0)this.x=c.width;if(this.x>c.width)this.x=0;
if(this.y<0)this.y=c.height;if(this.y>c.height)this.y=0;
if(this.invincible){this.invincibleTime--;if(this.invincibleTime<=0)this.invincible=false}}
draw(){
ctx.save();ctx.translate(this.x,this.y);ctx.rotate(this.angle+Math.PI/2);
if(!this.invincible||Math.floor(Date.now()/100)%2===0){
ctx.fillStyle='#5c3a1e';ctx.strokeStyle='#8b5a2b';ctx.lineWidth=2;
ctx.beginPath();ctx.moveTo(0,-this.size);ctx.lineTo(this.size*0.6,this.size*0.3);ctx.lineTo(this.size*0.3,this.size);ctx.lineTo(-this.size*0.3,this.size);ctx.lineTo(-this.size*0.6,this.size*0.3);ctx.closePath();ctx.fill();ctx.stroke();
ctx.strokeStyle='#3d2512';ctx.lineWidth=3;ctx.beginPath();ctx.moveTo(0,this.size*0.5);ctx.lineTo(0,-this.size*0.5);ctx.stroke();
ctx.save();ctx.rotate(this.sailAngle);ctx.fillStyle='#e8dcc8';ctx.strokeStyle='#8b7355';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(-this.size*0.5,-this.size*0.4);ctx.quadraticCurveTo(0,-this.size*0.1,this.size*0.5,-this.size*0.4);ctx.lineTo(this.size*0.4,this.size*0.2);ctx.quadraticCurveTo(0,this.size*0.4,-this.size*0.4,this.size*0.2);ctx.closePath();ctx.fill();ctx.stroke();ctx.restore();
ctx.fillStyle='#111';ctx.beginPath();ctx.arc(0,-this.size*0.3,4,0,Math.PI*2);ctx.fill();
ctx.fillStyle='#333';ctx.fillRect(-this.size*0.7,-this.size*0.1,6,4);ctx.fillRect(this.size*0.5,-this.size*0.1,6,4)}
ctx.restore()}
makeInvincible(){this.invincible=true;this.invincibleTime=120}}

class Cannonball{
constructor(x,y,angle){this.x=x;this.y=y;this.velocity={x:Math.cos(angle)*10,y:Math.sin(angle)*10};this.life=50;this.size=5}
update(){this.x+=this.velocity.x;this.y+=this.velocity.y;this.life--;
if(this.x<0)this.x=c.width;if(this.x>c.width)this.x=0;if(this.y<0)this.y=c.height;if(this.y>c.height)this.y=0;
if(Math.random()>0.7)particles.push(new Particle(this.x,this.y,'#555',2,'smoke'))}
draw(){ctx.fillStyle='#222';ctx.shadowBlur=8;ctx.shadowColor='rgba(255,100,0,0.5)';ctx.beginPath();ctx.arc(this.x,this.y,this.size,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0}
isDead(){return this.life<=0}}

class InkShot{
constructor(x,y,angle,speed=5){this.x=x;this.y=y;this.velocity={x:Math.cos(angle)*speed,y:Math.sin(angle)*speed};this.life=80;this.size=10}
update(){this.x+=this.velocity.x;this.y+=this.velocity.y;this.life--;
if(Math.random()>0.5)particles.push(new Particle(this.x,this.y,'#1a0a2e',4,'ink'))}
draw(){ctx.fillStyle='#2a1a4e';ctx.shadowBlur=15;ctx.shadowColor='#4a2a8e';ctx.beginPath();ctx.arc(this.x,this.y,this.size,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0}
isDead(){return this.life<=0||this.x<-50||this.x>c.width+50||this.y<-50||this.y>c.height+50}
collidesWith(obj){const dx=this.x-obj.x,dy=this.y-obj.y;return Math.sqrt(dx*dx+dy*dy)<this.size+(obj.size||20)}}

class EnemyShip{
constructor(x,y,size){
this.x=x||Math.random()*c.width;this.y=y||Math.random()*c.height;this.size=size||45;
const speed=0.8+Math.random()*1.5,angle=Math.random()*Math.PI*2;
this.velocity={x:Math.cos(angle)*speed,y:Math.sin(angle)*speed};
this.rotation=Math.random()*Math.PI*2;this.rotationSpeed=(Math.random()-.5)*.03;
this.type=Math.random()>0.7?'kraken':'ship';this.bobOffset=Math.random()*Math.PI*2}
update(){
this.x+=this.velocity.x;this.y+=this.velocity.y;this.rotation+=this.rotationSpeed;this.bobOffset+=0.05;
if(this.x<-this.size)this.x=c.width+this.size;if(this.x>c.width+this.size)this.x=-this.size;
if(this.y<-this.size)this.y=c.height+this.size;if(this.y>c.height+this.size)this.y=-this.size}
draw(){
ctx.save();ctx.translate(this.x,this.y);const bob=Math.sin(this.bobOffset)*3;ctx.translate(0,bob);
if(this.type==='kraken'){
ctx.rotate(this.rotation);ctx.strokeStyle='#2d5a3a';ctx.fillStyle='#1a3a2a';ctx.lineWidth=3;
for(let i=0;i<6;i++){const angle=(i/6)*Math.PI*2;const len=this.size*(0.6+Math.sin(Date.now()*0.005+i)*0.2);
ctx.save();ctx.rotate(angle);ctx.beginPath();ctx.moveTo(0,0);ctx.quadraticCurveTo(len*0.5,len*0.3,len*0.3,len);ctx.quadraticCurveTo(0,len*0.8,-len*0.3,len);ctx.quadraticCurveTo(-len*0.5,len*0.3,0,0);ctx.fill();ctx.stroke();ctx.restore()}
ctx.fillStyle='#ff0';ctx.shadowColor='#ff0';ctx.shadowBlur=10;ctx.beginPath();ctx.arc(0,0,this.size*0.15,0,Math.PI*2);ctx.fill();
ctx.fillStyle='#000';ctx.beginPath();ctx.arc(0,0,this.size*0.08,0,Math.PI*2);ctx.fill()}
else{ctx.rotate(this.rotation);ctx.fillStyle='#4a2a1a';ctx.strokeStyle='#6b3a2a';ctx.lineWidth=2;
ctx.beginPath();ctx.moveTo(0,-this.size*0.8);ctx.lineTo(this.size*0.4,this.size*0.4);ctx.lineTo(-this.size*0.4,this.size*0.4);ctx.closePath();ctx.fill();ctx.stroke();
ctx.fillStyle='#8b0000';ctx.beginPath();ctx.moveTo(-this.size*0.3,-this.size*0.3);ctx.lineTo(this.size*0.3,-this.size*0.3);ctx.lineTo(0,this.size*0.2);ctx.closePath();ctx.fill()}
ctx.restore()}
collidesWith(obj){const dx=this.x-obj.x,dy=this.y-obj.y;return Math.sqrt(dx*dx+dy*dy)<this.size*0.7+(obj.size||0)}}

// BOSS KRAKEN
class BossKraken{
constructor(){
this.x=c.width/2;this.y=-150;this.targetY=150;
this.size=100;this.maxHp=200+level*50;this.hp=this.maxHp;
this.phase=0;this.time=0;this.attackTimer=0;
this.tentacles=[];this.entering=true;
for(let i=0;i<8;i++)this.tentacles.push({angle:(i/8)*Math.PI*2,len:this.size,wave:Math.random()*Math.PI*2});
this.name=['THE LEVIATHAN','DEPTHS TERROR','ABYSSAL HORROR'][Math.floor(level/5)%3];
document.getElementById('bossName').textContent=this.name}
update(){
this.time+=0.016;
if(this.entering){this.y+=2;if(this.y>=this.targetY)this.entering=false;return}
// Movement
this.x+=Math.sin(this.time*0.5)*2;
this.y=this.targetY+Math.sin(this.time*0.3)*30;
// Tentacle animation
this.tentacles.forEach((t,i)=>{t.wave+=0.08;t.len=this.size*(0.8+Math.sin(t.wave)*0.3)});
// Attacks
this.attackTimer+=0.016;
const attackInterval=this.hp<this.maxHp*0.3?1.5:this.hp<this.maxHp*0.6?2:3;
if(this.attackTimer>attackInterval){
this.attackTimer=0;
const attack=Math.random();
if(attack<0.4)this.inkSpray();
else if(attack<0.7)this.spawnMinions();
else this.tentacleSwipe()}}
inkSpray(){
const angles=this.hp<this.maxHp*0.5?12:8;
for(let i=0;i<angles;i++){const angle=(i/angles)*Math.PI*2;inkShots.push(new InkShot(this.x,this.y,angle,4+Math.random()*2))}}
spawnMinions(){
for(let i=0;i<2;i++){const e=new EnemyShip(this.x+(Math.random()-0.5)*100,this.y+50,25);e.type='kraken';enemies.push(e)}}
tentacleSwipe(){
for(let i=0;i<20;i++)particles.push(new Particle(this.x+(Math.random()-0.5)*200,this.y+(Math.random()-0.5)*100,'#2d5a3a',8,'debris'))}
draw(){
ctx.save();ctx.translate(this.x,this.y);
// Tentacles
this.tentacles.forEach((t,i)=>{
ctx.save();ctx.rotate(t.angle);
ctx.strokeStyle='#1a4a2a';ctx.fillStyle='#0d2a1a';ctx.lineWidth=8;
ctx.beginPath();ctx.moveTo(0,0);
const wave=Math.sin(t.wave)*20;
ctx.quadraticCurveTo(t.len*0.3+wave,t.len*0.4,t.len*0.2,t.len);
ctx.quadraticCurveTo(0,t.len*0.9,-t.len*0.2,t.len);
ctx.quadraticCurveTo(-t.len*0.3+wave,t.len*0.4,0,0);
ctx.fill();ctx.stroke();
// Suckers
ctx.fillStyle='#3d6a4a';
for(let j=1;j<4;j++){const dist=t.len*(j/4);ctx.beginPath();ctx.arc(wave*(j/4)*0.3,dist,5,0,Math.PI*2);ctx.fill()}
ctx.restore()});
// Body
ctx.fillStyle='#0d2a1a';ctx.strokeStyle='#1a4a2a';ctx.lineWidth=5;
ctx.beginPath();ctx.arc(0,0,this.size*0.5,0,Math.PI*2);ctx.fill();ctx.stroke();
// Eyes
ctx.fillStyle='#ff0';ctx.shadowColor='#ff0';ctx.shadowBlur=20;
ctx.beginPath();ctx.ellipse(-20,-10,12,18,0,0,Math.PI*2);ctx.fill();
ctx.beginPath();ctx.ellipse(20,-10,12,18,0,0,Math.PI*2);ctx.fill();
ctx.fillStyle='#000';ctx.shadowBlur=0;
const eyeTrack=ship?Math.atan2(ship.y-this.y,ship.x-this.x):0;
ctx.beginPath();ctx.arc(-20+Math.cos(eyeTrack)*5,-10+Math.sin(eyeTrack)*5,6,0,Math.PI*2);ctx.fill();
ctx.beginPath();ctx.arc(20+Math.cos(eyeTrack)*5,-10+Math.sin(eyeTrack)*5,6,0,Math.PI*2);ctx.fill();
// Crown/spikes
ctx.fillStyle='#2d5a3a';
for(let i=0;i<5;i++){const angle=-Math.PI/2+(i-2)*0.3;const x=Math.cos(angle)*this.size*0.5;const y=Math.sin(angle)*this.size*0.5;
ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(x+Math.cos(angle)*20,y+Math.sin(angle)*20);ctx.lineTo(x+Math.cos(angle+0.3)*15,y+Math.sin(angle+0.3)*15);ctx.closePath();ctx.fill()}
ctx.restore()}
takeDamage(dmg){
this.hp-=dmg;
document.getElementById('bossHealth').style.width=(this.hp/this.maxHp*100)+'%';
if(this.hp<=0)return true;return false}
collidesWith(obj){const dx=this.x-obj.x,dy=this.y-obj.y;return Math.sqrt(dx*dx+dy*dy)<this.size*0.6+(obj.size||5)}}

class Particle{
constructor(x,y,color,size,type){
this.x=x;this.y=y;this.color=color;this.size=size||3;this.type=type||'debris';
const angle=Math.random()*Math.PI*2,speed=type==='wake'?0.5:type==='ink'?1:2+Math.random()*3;
this.velocity={x:Math.cos(angle)*speed,y:Math.sin(angle)*speed};
this.life=type==='smoke'?20:type==='ink'?30:40+Math.random()*30;this.maxLife=this.life}
update(){this.x+=this.velocity.x;this.y+=this.velocity.y;this.velocity.x*=.96;this.velocity.y*=.96;if(this.type==='smoke')this.velocity.y-=0.05;this.life--}
draw(){const alpha=this.life/this.maxLife;ctx.fillStyle=this.color;ctx.globalAlpha=alpha;ctx.shadowBlur=this.type==='debris'?5:0;ctx.shadowColor=this.color;ctx.beginPath();ctx.arc(this.x,this.y,this.size*(this.type==='smoke'?1.5-alpha*0.5:1),0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;ctx.shadowBlur=0}
isDead(){return this.life<=0}}

const initWaves=()=>{waves=[];for(let i=0;i<15;i++)waves.push(new Wave(i*(c.height/15)))};
const spawnEnemies=count=>{for(let i=0;i<count;i++){let x,y;do{x=Math.random()*c.width;y=Math.random()*c.height}while(ship&&Math.hypot(x-ship.x,y-ship.y)<150);enemies.push(new EnemyShip(x,y,40+Math.random()*20))}};

const destroyEnemy=e=>{
shipsDestroyed++;if(e.type==='kraken')krakensSlain++;
if(e.size>20){const newSize=e.size*0.6;for(let i=0;i<2;i++){const ne=new EnemyShip(e.x,e.y,newSize);ne.type=e.type;enemies.push(ne)}score+=e.type==='kraken'?75:50}
else{score+=e.type==='kraken'?150:100}
const colors=e.type==='kraken'?['#2d5a3a','#1a3a2a','#4a8a5a']:['#5c3a1e','#8b5a2b','#f80'];
for(let i=0;i<25;i++)particles.push(new Particle(e.x,e.y,colors[Math.floor(Math.random()*colors.length)],4,'debris'))};

const defeatBoss=()=>{
score+=5000+level*1000;krakensSlain++;
for(let i=0;i<100;i++)particles.push(new Particle(boss.x+(Math.random()-0.5)*200,boss.y+(Math.random()-0.5)*200,['#2d5a3a','#ff0','#d4a84b'][Math.floor(Math.random()*3)],6,'debris'));
document.getElementById('bossBar').classList.remove('show');
boss=null;level++;showLevelUp();spawnEnemies(3+level);updateUI()};

let lastShot=0;
const shoot=()=>{const now=Date.now();if(now-lastShot>300){cannonballs.push(new Cannonball(ship.x+Math.cos(ship.angle)*ship.size,ship.y+Math.sin(ship.angle)*ship.size,ship.angle));lastShot=now;for(let i=0;i<5;i++)particles.push(new Particle(ship.x,ship.y,'#ff6600',2,'debris'))}};

const update=()=>{
if(!gameRunning||paused)return;
ship.update();
cannonballs=cannonballs.filter(b=>{b.update();return!b.isDead()});
enemies.forEach(e=>e.update());
particles=particles.filter(p=>{p.update();return!p.isDead()});
inkShots=inkShots.filter(i=>{i.update();return!i.isDead()});

if(boss){
boss.update();
// Cannonballs hit boss
for(let i=cannonballs.length-1;i>=0;i--){
if(boss.collidesWith(cannonballs[i])){
cannonballs.splice(i,1);
for(let j=0;j<5;j++)particles.push(new Particle(boss.x,boss.y,'#4a8a5a',3,'debris'));
if(boss.takeDamage(5))defeatBoss()}}
// Boss hits player
if(!ship.invincible&&boss.collidesWith(ship)){
lives--;ship.makeInvincible();
for(let j=0;j<30;j++)particles.push(new Particle(ship.x,ship.y,'#d4a84b',3,'debris'));
if(lives<=0)endGame();updateUI()}}

// Ink hits player
if(!ship.invincible){
for(let i=inkShots.length-1;i>=0;i--){
if(inkShots[i].collidesWith(ship)){
inkShots.splice(i,1);lives--;ship.makeInvincible();
for(let j=0;j<20;j++)particles.push(new Particle(ship.x,ship.y,'#4a2a8e',3,'debris'));
if(lives<=0)endGame();updateUI();break}}}

for(let i=cannonballs.length-1;i>=0;i--){
for(let j=enemies.length-1;j>=0;j--){
if(enemies[j].collidesWith(cannonballs[i])){destroyEnemy(enemies[j]);enemies.splice(j,1);cannonballs.splice(i,1);break}}}

if(!ship.invincible){
for(let i=enemies.length-1;i>=0;i--){
if(enemies[i].collidesWith(ship)){destroyEnemy(enemies[i]);enemies.splice(i,1);lives--;ship.makeInvincible();
for(let j=0;j<30;j++)particles.push(new Particle(ship.x,ship.y,'#d4a84b',3,'debris'));
if(lives<=0)endGame();updateUI();break}}}

if(enemies.length===0&&!boss){
level++;
if(level%5===0){showBossWarning();setTimeout(()=>{boss=new BossKraken();document.getElementById('bossBar').classList.add('show')},3000)}
else{showLevelUp();spawnEnemies(3+level)}
updateUI()}
updateUI()};

const draw=()=>{
const gradient=ctx.createLinearGradient(0,0,0,c.height);
gradient.addColorStop(0,'#0a1628');gradient.addColorStop(0.5,'#0d1a2a');gradient.addColorStop(1,'#051015');
ctx.fillStyle=gradient;ctx.fillRect(0,0,c.width,c.height);
waves.forEach(w=>w.draw());
ctx.fillStyle='#c9b896';ctx.shadowColor='#c9b896';ctx.shadowBlur=30;ctx.beginPath();ctx.arc(c.width-80,60,25,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
ctx.fillStyle='#fff';for(let i=0;i<50;i++){const x=(i*137)%c.width,y=(i*97)%c.height;ctx.globalAlpha=0.3+Math.sin(Date.now()*0.002+i)*0.2;ctx.fillRect(x,y,1,1)}ctx.globalAlpha=1;
particles.forEach(p=>p.draw());
enemies.forEach(e=>e.draw());
if(boss)boss.draw();
inkShots.forEach(i=>i.draw());
cannonballs.forEach(b=>b.draw());
if(ship)ship.draw();
if(paused){ctx.fillStyle='#d4a84b';ctx.font='48px "Pirata One"';ctx.textAlign='center';ctx.textBaseline='middle';ctx.shadowBlur=20;ctx.shadowColor='#d4a84b';ctx.fillText('ANCHORS AWEIGH!',c.width/2,c.height/2);ctx.shadowBlur=0}};

const gameLoop=()=>{update();draw();if(gameRunning)requestAnimationFrame(gameLoop)};

const startGame=()=>{
gameRunning=true;paused=false;score=0;level=1;lives=3;shipsDestroyed=0;krakensSlain=0;
ship=new Ship();cannonballs=[];enemies=[];particles=[];inkShots=[];boss=null;
initWaves();spawnEnemies(3);
document.getElementById('gameOverScreen').classList.remove('show');
document.getElementById('bossBar').classList.remove('show');
document.getElementById('scoreInput').style.display='flex';
updateUI();gameLoop()};

const endGame=()=>{
gameRunning=false;
document.getElementById('finalScore').textContent=score;
document.getElementById('finalLevel').textContent=level;
document.getElementById('shipsDestroyed').textContent=shipsDestroyed;
document.getElementById('krakensSlain').textContent=krakensSlain;
document.getElementById('bossBar').classList.remove('show');
document.getElementById('gameOverScreen').classList.add('show');
loadLeaderboard()};

const updateUI=()=>{
document.getElementById('score').textContent=score;document.getElementById('level').textContent=level;
const livesContainer=document.getElementById('lives');livesContainer.innerHTML='';
for(let i=0;i<lives;i++){const lifeIcon=document.createElement('span');lifeIcon.className='life-icon';lifeIcon.textContent='‚õµ';livesContainer.appendChild(lifeIcon)}};

const showLevelUp=()=>{const el=document.getElementById('levelUp');el.textContent=`WAVE ${level} CLEARED!`;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),2e3)};
const showBossWarning=()=>{const el=document.getElementById('bossWarning');el.classList.add('show');setTimeout(()=>el.classList.remove('show'),3e3)};

// Leaderboard
async function loadLeaderboard(){
try{
const{data,error}=await supabase.from('sea_scourge_leaderboard').select('*').order('score',{ascending:false}).limit(10);
if(error)throw error;
const container=document.getElementById('leaderboard');
if(!data||data.length===0){container.innerHTML='<p style="text-align:center;opacity:.7">No scores yet. Be the first!</p>';return}
container.innerHTML=data.map((e,i)=>`<div class="leaderboard-entry"><span class="rank">#${i+1}</span><span>${escapeHtml(e.name||'Anonymous')}</span><span>${e.score} doubloons</span></div>`).join('')}
catch(err){console.error(err);document.getElementById('leaderboard').innerHTML='<p>Could not load scores</p>'}}

document.getElementById('submitScore').addEventListener('click',async()=>{
if(!currentUser){alert('Please wait...');return}
const name=document.getElementById('playerName').value.trim()||'Anonymous';
const btn=document.getElementById('submitScore');
btn.disabled=true;btn.textContent='Saving...';
try{
await supabase.from('sea_scourge_leaderboard').insert({name,score,wave:level,ships_sunk:shipsDestroyed,krakens_slain:krakensSlain,user_id:currentUser.id});
document.getElementById('scoreInput').style.display='none';
loadLeaderboard()}
catch(err){console.error(err);alert('Could not save score')}
finally{btn.disabled=false;btn.textContent='Submit'}});

function escapeHtml(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML}

document.addEventListener('keydown',e=>{
keys[e.key]=true;
if(e.key===' '&&gameRunning&&!paused){e.preventDefault();shoot()}
if(e.key==='p'||e.key==='P'){e.preventDefault();if(gameRunning){paused=!paused;if(!paused)gameLoop()}}});
document.addEventListener('keyup',e=>keys[e.key]=false);

// Mobile touch controls
function setupTouchBtn(id,keyName,isFireBtn=false){
const btn=document.getElementById(id);
if(!btn)return;
btn.addEventListener('touchstart',e=>{e.preventDefault();if(isFireBtn){shoot()}else{keys[keyName]=true}},{passive:false});
btn.addEventListener('touchend',e=>{e.preventDefault();if(!isFireBtn)keys[keyName]=false},{passive:false});
btn.addEventListener('touchcancel',e=>{if(!isFireBtn)keys[keyName]=false});
// Also support mouse for testing
btn.addEventListener('mousedown',e=>{e.preventDefault();if(isFireBtn){shoot()}else{keys[keyName]=true}});
btn.addEventListener('mouseup',e=>{if(!isFireBtn)keys[keyName]=false});
btn.addEventListener('mouseleave',e=>{if(!isFireBtn)keys[keyName]=false})}

setupTouchBtn('touchLeft','ArrowLeft');
setupTouchBtn('touchRight','ArrowRight');
setupTouchBtn('touchThrust','ArrowUp');
setupTouchBtn('touchFire','',true);

// Auto-fire on touch hold for fire button
let fireInterval=null;
const fireBtn=document.getElementById('touchFire');
if(fireBtn){
fireBtn.addEventListener('touchstart',e=>{e.preventDefault();shoot();fireInterval=setInterval(shoot,300)},{passive:false});
fireBtn.addEventListener('touchend',e=>{e.preventDefault();if(fireInterval){clearInterval(fireInterval);fireInterval=null}},{passive:false});
fireBtn.addEventListener('touchcancel',()=>{if(fireInterval){clearInterval(fireInterval);fireInterval=null}})}

// Canvas touch for quick fire (tap anywhere on canvas)
c.addEventListener('touchstart',e=>{
if(!gameRunning||paused)return;
e.preventDefault();
const rect=c.getBoundingClientRect();
const touch=e.touches[0];
const x=touch.clientX-rect.left;
const y=touch.clientY-rect.top;
// Tap on canvas fires
shoot()},{passive:false});

loadLeaderboard();
startGame();
</script>
<script src="/apps/sloppy-header/sloppy-bar.js"></script>
<script src="/vibelib-extended.js"></script>
<script>
  // Compatibility Patch for Legacy Apps
  window.addEventListener("load", () => {
    if (window.SloppyKarma && window.VibeLib.Economy) {
      // Redirect old calls to new engine
      window.SloppyKarma.track = window.VibeLib.Economy.track;
    }
  });
</script>
</body>
</html>
