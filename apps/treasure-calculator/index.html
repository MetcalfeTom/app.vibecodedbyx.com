<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Treasure Calculator 3D - Pirate Math Adventure</title>
  <link rel="icon" href="https://emojicdn.elk.sh/üè¥‚Äç‚ò†Ô∏è">
  <meta property="og:title" content="Treasure Calculator 3D">
  <meta property="og:description" content="Solve pirate math in full 3D to uncover buried treasure!">
  <meta property="og:url" content="https://app.sloppy.live/treasure-calculator">
  <meta property="og:image" content="https://emojicdn.elk.sh/üí∞?style=apple&size=512">
  <link href="https://fonts.googleapis.com/css2?family=Pirata+One&family=IM+Fell+English+SC&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --gold: #d4a84b;
      --dark-gold: #8b6914;
      --ocean: #0d1a2a;
      --wood: #5c3a1e;
      --wood-light: #8b5a2b;
      --parchment: #f4e4bc;
    }

    body {
      font-family: 'IM Fell English SC', serif;
      overflow: hidden;
      background: #000;
      color: var(--parchment);
    }

    #canvas-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
    }

    .ui-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
    }

    .ui-overlay > * {
      pointer-events: auto;
    }

    header {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
    }

    h1 {
      font-family: 'Pirata One', cursive;
      font-size: 2.2rem;
      color: var(--gold);
      text-shadow: 2px 2px 4px #000, 0 0 20px rgba(212, 168, 75, 0.5);
    }

    .level-select {
      position: absolute;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
    }

    .level-btn {
      font-family: 'Pirata One', cursive;
      font-size: 1rem;
      padding: 8px 16px;
      border: 2px solid var(--gold);
      background: rgba(92, 58, 30, 0.9);
      color: var(--gold);
      cursor: pointer;
      transition: all 0.3s;
    }

    .level-btn:hover, .level-btn.active {
      background: var(--gold);
      color: var(--ocean);
      box-shadow: 0 0 15px rgba(212, 168, 75, 0.7);
    }

    .stats {
      position: absolute;
      top: 110px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 40px;
      text-align: center;
    }

    .stat-value {
      font-family: 'Pirata One', cursive;
      font-size: 1.8rem;
      color: var(--gold);
      text-shadow: 0 0 10px rgba(212, 168, 75, 0.5);
    }

    .stat-label {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .progress-bar {
      position: absolute;
      top: 170px;
      left: 50%;
      transform: translateX(-50%);
      width: 300px;
      height: 12px;
      background: rgba(92, 58, 30, 0.8);
      border: 2px solid var(--gold);
      border-radius: 6px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--gold) 0%, #ffd700 100%);
      transition: width 0.5s;
      box-shadow: 0 0 10px var(--gold);
    }

    .problem-card {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, rgba(244, 228, 188, 0.95) 0%, rgba(232, 212, 168, 0.95) 100%);
      border: 4px solid var(--wood);
      border-radius: 8px;
      padding: 20px 40px;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }

    .problem {
      font-family: 'Pirata One', cursive;
      font-size: 2.5rem;
      color: var(--ocean);
      margin-bottom: 15px;
    }

    .answer-input {
      font-family: 'Pirata One', cursive;
      font-size: 1.8rem;
      width: 120px;
      padding: 8px;
      text-align: center;
      border: 3px solid var(--wood);
      background: #fff;
      color: var(--ocean);
      border-radius: 5px;
    }

    .answer-input:focus {
      outline: none;
      border-color: var(--gold);
      box-shadow: 0 0 10px rgba(212, 168, 75, 0.5);
    }

    .submit-btn {
      font-family: 'Pirata One', cursive;
      font-size: 1.3rem;
      padding: 10px 30px;
      background: linear-gradient(180deg, var(--gold) 0%, var(--dark-gold) 100%);
      border: 3px solid var(--wood);
      color: var(--ocean);
      cursor: pointer;
      margin-left: 10px;
      transition: all 0.3s;
    }

    .submit-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(212, 168, 75, 0.7);
    }

    .lore-panel {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(13, 26, 42, 0.95);
      border: 3px solid var(--gold);
      border-radius: 10px;
      padding: 30px;
      text-align: center;
      max-width: 400px;
      animation: fadeIn 0.5s;
      display: none;
    }

    .lore-panel.show { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, -40%); }
      to { opacity: 1; transform: translate(-50%, -50%); }
    }

    .lore-title {
      font-family: 'Pirata One', cursive;
      font-size: 1.8rem;
      color: var(--gold);
      margin-bottom: 15px;
    }

    .lore-text {
      font-size: 1.1rem;
      line-height: 1.6;
    }

    .level-complete-panel {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(13, 26, 42, 0.95);
      border: 3px solid var(--gold);
      border-radius: 10px;
      padding: 40px;
      text-align: center;
      display: none;
    }

    .level-complete-panel.show { display: block; }

    .level-complete-panel h2 {
      font-family: 'Pirata One', cursive;
      font-size: 2.5rem;
      color: var(--gold);
      margin-bottom: 20px;
    }

    .backlink {
      position: absolute;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0.7;
    }

    .backlink a {
      color: var(--gold);
      text-decoration: none;
    }

    /* Leaderboard */
    .leaderboard-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      font-family: 'Pirata One', cursive;
      font-size: 1rem;
      padding: 8px 16px;
      border: 2px solid var(--gold);
      background: rgba(92, 58, 30, 0.9);
      color: var(--gold);
      cursor: pointer;
      transition: all 0.3s;
    }

    .leaderboard-toggle:hover {
      background: var(--gold);
      color: var(--ocean);
    }

    .leaderboard-panel {
      position: absolute;
      top: 60px;
      right: 10px;
      width: 280px;
      max-height: 400px;
      background: rgba(13, 26, 42, 0.95);
      border: 3px solid var(--gold);
      border-radius: 10px;
      padding: 15px;
      display: none;
      overflow-y: auto;
    }

    .leaderboard-panel.show { display: block; }

    .leaderboard-title {
      font-family: 'Pirata One', cursive;
      font-size: 1.5rem;
      color: var(--gold);
      text-align: center;
      margin-bottom: 15px;
    }

    .leaderboard-list {
      list-style: none;
    }

    .leaderboard-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      border-bottom: 1px solid rgba(212, 168, 75, 0.3);
    }

    .leaderboard-item:last-child { border-bottom: none; }

    .leaderboard-rank {
      font-family: 'Pirata One', cursive;
      font-size: 1.2rem;
      color: var(--gold);
      width: 30px;
    }

    .leaderboard-rank.gold { color: #ffd700; }
    .leaderboard-rank.silver { color: #c0c0c0; }
    .leaderboard-rank.bronze { color: #cd7f32; }

    .leaderboard-name {
      flex: 1;
      margin: 0 10px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .leaderboard-score {
      font-family: 'Pirata One', cursive;
      color: var(--gold);
    }

    .leaderboard-empty {
      text-align: center;
      opacity: 0.7;
      padding: 20px;
    }

    /* Score submit form */
    .score-submit {
      margin-top: 20px;
      text-align: center;
    }

    .score-submit input {
      font-family: 'IM Fell English SC', serif;
      font-size: 1rem;
      padding: 8px 12px;
      border: 2px solid var(--gold);
      background: rgba(255,255,255,0.9);
      color: var(--ocean);
      border-radius: 5px;
      width: 150px;
      margin-right: 10px;
    }

    .score-submit input:focus {
      outline: none;
      box-shadow: 0 0 10px rgba(212, 168, 75, 0.5);
    }

    .score-submit button {
      font-family: 'Pirata One', cursive;
      font-size: 1rem;
      padding: 8px 16px;
      background: linear-gradient(180deg, var(--gold) 0%, var(--dark-gold) 100%);
      border: 2px solid var(--wood);
      color: var(--ocean);
      cursor: pointer;
      transition: all 0.3s;
    }

    .score-submit button:hover {
      transform: scale(1.05);
    }

    .score-submitted {
      color: var(--gold);
      margin-top: 10px;
    }

    .shake { animation: shake 0.5s; }

    @keyframes shake {
      0%, 100% { transform: translateX(-50%); }
      25% { transform: translateX(calc(-50% - 10px)); }
      75% { transform: translateX(calc(-50% + 10px)); }
    }

    .hidden { display: none !important; }

    @media (max-width: 600px) {
      h1 { font-size: 1.6rem; }
      .problem { font-size: 1.8rem; }
      .problem-card { padding: 15px 25px; bottom: 60px; }
      .level-btn { padding: 6px 12px; font-size: 0.9rem; }
      .stats { gap: 25px; }
      .stat-value { font-size: 1.4rem; }
    }
  </style>
</head>
<body>
  <div id="canvas-container"></div>

  <div class="ui-overlay">
    <header>
      <h1>Treasure Calculator 3D</h1>
    </header>

    <div class="level-select">
      <button class="level-btn active" data-level="1">‚öì Cabin Boy</button>
      <button class="level-btn" data-level="2">‚öì‚öì First Mate</button>
      <button class="level-btn" data-level="3">‚öì‚öì‚öì Captain</button>
    </div>

    <div class="stats">
      <div class="stat">
        <div class="stat-value" id="gold-count">0</div>
        <div class="stat-label">Doubloons</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="streak">0</div>
        <div class="stat-label">Streak</div>
      </div>
    </div>

    <div class="progress-bar">
      <div class="progress-fill" id="progress" style="width: 0%"></div>
    </div>

    <div class="problem-card" id="problem-card">
      <div class="problem" id="problem">12 + 7 = ?</div>
      <input type="number" class="answer-input" id="answer" placeholder="?" autofocus>
      <button class="submit-btn" id="submit">Plunder!</button>
    </div>

    <div class="lore-panel" id="lore-panel">
      <div class="lore-title" id="lore-title">Treasure Found!</div>
      <div class="lore-text" id="lore-text"></div>
    </div>

    <div class="level-complete-panel" id="level-complete">
      <h2>Level Complete!</h2>
      <p>Ye've proven yerself worthy, sailor!</p>
      <div class="score-submit" id="score-submit">
        <p>Final Score: <span id="final-score">0</span> doubloons</p>
        <input type="text" id="player-name" placeholder="Yer pirate name" maxlength="20">
        <button id="submit-score">Join Crew!</button>
        <div class="score-submitted hidden" id="score-submitted">Score recorded, Captain!</div>
      </div>
      <button class="submit-btn" id="next-level">Next Adventure</button>
    </div>

    <button class="leaderboard-toggle" id="leaderboard-toggle">üè¥‚Äç‚ò†Ô∏è Crew Ranks</button>
    <div class="leaderboard-panel" id="leaderboard-panel">
      <div class="leaderboard-title">Top Pirates</div>
      <ul class="leaderboard-list" id="leaderboard-list">
        <li class="leaderboard-empty">Loading crew...</li>
      </ul>
    </div>

    <div class="backlink">
      <a href="https://sloppy.live">‚öì Back to sloppy.live</a>
    </div>
  </div>

  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
      "@supabase/supabase-js": "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm"
    }
  }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { Water } from 'three/addons/objects/Water.js';
    import { Sky } from 'three/addons/objects/Sky.js';
    import { createClient } from '@supabase/supabase-js';

    // Supabase setup
    const SUPABASE_URL = 'https://yjyxteqzhhmtrgcaekgz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM8IS32IUYR2eenCCjdDdioiBU';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUserId = null;

    // Initialize auth
    async function initAuth() {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        currentUserId = session.user.id;
      } else {
        const { data, error } = await supabase.auth.signInAnonymously();
        if (!error && data.session) {
          currentUserId = data.session.user.id;
        }
      }
    }

    // Fetch leaderboard
    async function fetchLeaderboard() {
      const { data, error } = await supabase
        .from('treasure_calculator_scores')
        .select('player_name, score, level_reached')
        .order('score', { ascending: false })
        .limit(10);

      const listEl = document.getElementById('leaderboard-list');

      if (error || !data || data.length === 0) {
        listEl.innerHTML = '<li class="leaderboard-empty">No pirates yet! Be the first!</li>';
        return;
      }

      listEl.innerHTML = data.map((entry, i) => {
        const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
        return `
          <li class="leaderboard-item">
            <span class="leaderboard-rank ${rankClass}">#${i + 1}</span>
            <span class="leaderboard-name">${escapeHtml(entry.player_name)}</span>
            <span class="leaderboard-score">${entry.score}</span>
          </li>
        `;
      }).join('');
    }

    // Submit score
    async function submitScore(playerName, score, levelReached, bestStreak) {
      if (!currentUserId) await initAuth();

      const { error } = await supabase
        .from('treasure_calculator_scores')
        .insert({
          user_id: currentUserId,
          player_name: playerName.trim() || 'Anonymous Pirate',
          score: score,
          level_reached: levelReached,
          streak_best: bestStreak
        });

      if (!error) {
        fetchLeaderboard();
        return true;
      }
      console.error('Submit error:', error);
      return false;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initialize
    initAuth();
    fetchLeaderboard();

    // Leaderboard toggle
    const leaderboardToggle = document.getElementById('leaderboard-toggle');
    const leaderboardPanel = document.getElementById('leaderboard-panel');
    leaderboardToggle.addEventListener('click', () => {
      leaderboardPanel.classList.toggle('show');
      if (leaderboardPanel.classList.contains('show')) {
        fetchLeaderboard();
      }
    });

    // Score submit
    const submitScoreBtn = document.getElementById('submit-score');
    const playerNameInput = document.getElementById('player-name');
    const scoreSubmittedEl = document.getElementById('score-submitted');
    const finalScoreEl = document.getElementById('final-score');

    // Scene setup
    const container = document.getElementById('canvas-container');
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 2000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 0.5;
    container.appendChild(renderer.domElement);

    camera.position.set(0, 8, 15);
    camera.lookAt(0, 2, 0);

    // Lighting
    const ambientLight = new THREE.AmbientLight(0xffeedd, 0.4);
    scene.add(ambientLight);

    const sunLight = new THREE.DirectionalLight(0xffd599, 1.5);
    sunLight.position.set(50, 50, 50);
    sunLight.castShadow = true;
    scene.add(sunLight);

    const torchLight1 = new THREE.PointLight(0xff6600, 2, 15);
    torchLight1.position.set(-4, 4, 0);
    scene.add(torchLight1);

    const torchLight2 = new THREE.PointLight(0xff6600, 2, 15);
    torchLight2.position.set(4, 4, 0);
    scene.add(torchLight2);

    // Sky
    const sky = new Sky();
    sky.scale.setScalar(10000);
    scene.add(sky);

    const skyUniforms = sky.material.uniforms;
    skyUniforms['turbidity'].value = 10;
    skyUniforms['rayleigh'].value = 2;
    skyUniforms['mieCoefficient'].value = 0.005;
    skyUniforms['mieDirectionalG'].value = 0.8;

    const sun = new THREE.Vector3();
    const phi = THREE.MathUtils.degToRad(88);
    const theta = THREE.MathUtils.degToRad(180);
    sun.setFromSphericalCoords(1, phi, theta);
    skyUniforms['sunPosition'].value.copy(sun);

    // Water
    const waterGeometry = new THREE.PlaneGeometry(10000, 10000);
    const water = new Water(waterGeometry, {
      textureWidth: 512,
      textureHeight: 512,
      waterNormals: new THREE.TextureLoader().load(
        'https://threejs.org/examples/textures/waternormals.jpg',
        (texture) => {
          texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
        }
      ),
      sunDirection: new THREE.Vector3(),
      sunColor: 0xffffff,
      waterColor: 0x001e0f,
      distortionScale: 3.7,
      fog: scene.fog !== undefined
    });
    water.rotation.x = -Math.PI / 2;
    water.position.y = -2;
    scene.add(water);

    // Sand Island
    const sandGeometry = new THREE.CylinderGeometry(6, 8, 3, 32);
    const sandMaterial = new THREE.MeshStandardMaterial({
      color: 0xc2b280,
      roughness: 1,
      metalness: 0
    });
    const island = new THREE.Mesh(sandGeometry, sandMaterial);
    island.position.y = -1;
    scene.add(island);

    // Treasure Chest Group
    const chestGroup = new THREE.Group();
    chestGroup.position.set(0, 0.8, 0);

    // Chest body
    const chestBodyGeom = new THREE.BoxGeometry(3, 1.5, 2);
    const woodMaterial = new THREE.MeshStandardMaterial({
      color: 0x5c3a1e,
      roughness: 0.8,
      metalness: 0.1
    });
    const chestBody = new THREE.Mesh(chestBodyGeom, woodMaterial);
    chestBody.position.y = 0.75;
    chestGroup.add(chestBody);

    // Wood planks on body
    const plankMaterial = new THREE.MeshStandardMaterial({ color: 0x8b5a2b, roughness: 0.9 });
    for (let i = -1; i <= 1; i += 0.5) {
      const plank = new THREE.Mesh(new THREE.BoxGeometry(0.1, 1.5, 2.1), plankMaterial);
      plank.position.set(i, 0.75, 0);
      chestGroup.add(plank);
    }

    // Gold bands
    const goldMaterial = new THREE.MeshStandardMaterial({
      color: 0xd4a84b,
      roughness: 0.3,
      metalness: 0.8
    });

    const band1 = new THREE.Mesh(new THREE.BoxGeometry(3.1, 0.15, 2.1), goldMaterial);
    band1.position.y = 0.3;
    chestGroup.add(band1);

    const band2 = new THREE.Mesh(new THREE.BoxGeometry(3.1, 0.15, 2.1), goldMaterial);
    band2.position.y = 1.2;
    chestGroup.add(band2);

    // Chest lid (pivots open)
    const lidGroup = new THREE.Group();
    lidGroup.position.set(0, 1.5, -1);

    const lidGeom = new THREE.BoxGeometry(3, 0.8, 2);
    const lid = new THREE.Mesh(lidGeom, woodMaterial);
    lid.position.set(0, 0.4, 1);
    lidGroup.add(lid);

    // Curved top of lid
    const curveGeom = new THREE.CylinderGeometry(1, 1, 3, 16, 1, false, 0, Math.PI);
    curveGeom.rotateZ(Math.PI / 2);
    const lidCurve = new THREE.Mesh(curveGeom, woodMaterial);
    lidCurve.position.set(0, 0.8, 1);
    lidGroup.add(lidCurve);

    // Gold band on lid
    const lidBand = new THREE.Mesh(new THREE.BoxGeometry(3.1, 0.15, 2.1), goldMaterial);
    lidBand.position.set(0, 0.4, 1);
    lidGroup.add(lidBand);

    chestGroup.add(lidGroup);

    // Lock
    const lockGeom = new THREE.CylinderGeometry(0.2, 0.2, 0.1, 16);
    const lock = new THREE.Mesh(lockGeom, goldMaterial);
    lock.rotation.x = Math.PI / 2;
    lock.position.set(0, 1.5, 1.05);
    chestGroup.add(lock);

    scene.add(chestGroup);

    // Treasure inside chest (gold glow)
    const glowGeom = new THREE.SphereGeometry(1, 16, 16);
    const glowMaterial = new THREE.MeshBasicMaterial({
      color: 0xffd700,
      transparent: true,
      opacity: 0
    });
    const treasureGlow = new THREE.Mesh(glowGeom, glowMaterial);
    treasureGlow.position.set(0, 1.5, 0);
    chestGroup.add(treasureGlow);

    // Coins for animation
    const coins = [];
    const coinGeom = new THREE.CylinderGeometry(0.15, 0.15, 0.03, 16);
    const coinMaterial = new THREE.MeshStandardMaterial({
      color: 0xffd700,
      roughness: 0.2,
      metalness: 0.9
    });

    function spawnCoins() {
      for (let i = 0; i < 20; i++) {
        const coin = new THREE.Mesh(coinGeom, coinMaterial);
        coin.position.set(
          chestGroup.position.x + (Math.random() - 0.5) * 2,
          chestGroup.position.y + 2,
          chestGroup.position.z + (Math.random() - 0.5) * 2
        );
        coin.rotation.x = Math.random() * Math.PI;
        coin.rotation.z = Math.random() * Math.PI;
        coin.userData.velocity = new THREE.Vector3(
          (Math.random() - 0.5) * 0.3,
          Math.random() * 0.3 + 0.2,
          (Math.random() - 0.5) * 0.3
        );
        coin.userData.spin = Math.random() * 0.3;
        coin.userData.life = 2;
        scene.add(coin);
        coins.push(coin);
      }
    }

    // Palm trees
    function createPalmTree(x, z) {
      const trunkGeom = new THREE.CylinderGeometry(0.15, 0.25, 4, 8);
      const trunkMat = new THREE.MeshStandardMaterial({ color: 0x4a3520, roughness: 0.9 });
      const trunk = new THREE.Mesh(trunkGeom, trunkMat);
      trunk.position.set(x, 2, z);

      const leafMat = new THREE.MeshStandardMaterial({ color: 0x228b22, roughness: 0.8, side: THREE.DoubleSide });

      for (let i = 0; i < 6; i++) {
        const leafGeom = new THREE.ConeGeometry(0.8, 2, 4);
        const leaf = new THREE.Mesh(leafGeom, leafMat);
        leaf.rotation.z = Math.PI / 3;
        leaf.rotation.y = (i / 6) * Math.PI * 2;
        leaf.position.set(x + Math.cos(leaf.rotation.y) * 0.5, 4.5, z + Math.sin(leaf.rotation.y) * 0.5);
        scene.add(leaf);
      }

      scene.add(trunk);
    }

    createPalmTree(-4, -3);
    createPalmTree(4.5, -2);

    // Torches
    function createTorch(x, z) {
      const poleGeom = new THREE.CylinderGeometry(0.08, 0.08, 3, 8);
      const poleMat = new THREE.MeshStandardMaterial({ color: 0x3d2817 });
      const pole = new THREE.Mesh(poleGeom, poleMat);
      pole.position.set(x, 1.5, z);
      scene.add(pole);

      const flameGeom = new THREE.ConeGeometry(0.15, 0.4, 8);
      const flameMat = new THREE.MeshBasicMaterial({ color: 0xff6600 });
      const flame = new THREE.Mesh(flameGeom, flameMat);
      flame.position.set(x, 3.2, z);
      flame.userData.baseY = 3.2;
      scene.add(flame);
      return flame;
    }

    const flame1 = createTorch(-3, 2);
    const flame2 = createTorch(3, 2);

    // Animation state
    let chestOpen = false;
    let targetLidRotation = 0;

    function openChest() {
      chestOpen = true;
      targetLidRotation = -Math.PI * 0.6;
      glowMaterial.opacity = 0.8;
      spawnCoins();
    }

    function closeChest() {
      chestOpen = false;
      targetLidRotation = 0;
      glowMaterial.opacity = 0;
    }

    // Game Logic
    const levels = {
      1: { name: 'Cabin Boy', ops: ['+', '-'], range: [1, 20], problems: 5 },
      2: { name: 'First Mate', ops: ['+', '-', '√ó'], range: [1, 12], problems: 7 },
      3: { name: 'Captain', ops: ['+', '-', '√ó', '√∑'], range: [2, 15], problems: 10 }
    };

    const lore = [
      "The Kraken sleeps beneath these waters, awaiting the call of the ancient horn.",
      "Davy Jones' Locker holds the souls of a thousand sailors who dared challenge the sea.",
      "The Flying Dutchman can never make port, doomed to sail the seas forever.",
      "X marks the spot, but only those pure of heart can see the true treasure.",
      "A pirate's life be free, but the sea demands her toll in salt and blood.",
      "The compass points not north, but to what ye desire most in this world.",
      "Blackbeard lit fuses in his beard to appear as a demon from hell itself.",
      "The Jolly Roger strikes fear into merchant hearts across the seven seas.",
      "Dead men tell no tales, unless ye know the words to wake them.",
      "The sea be a cruel mistress, but she rewards the bold and punishes the meek.",
      "Neptune's trident commands the waves - respect it or be swallowed whole.",
      "Pieces of eight were Spanish dollars cut into eight bits for trade.",
      "Walking the plank was rare - most pirates simply threw enemies overboard.",
      "The golden age of piracy lasted only from 1650 to 1730.",
      "Port Royal was called the 'wickedest city on Earth' before the sea claimed it.",
      "A ship's cat was considered good luck and protected stores from rats.",
      "Grog was rum mixed with water to prevent sailors from hoarding alcohol.",
      "The Barbary pirates of North Africa terrorized seas for over 300 years.",
      "Marooning was the cruelest punishment - left alone on a deserted island.",
      "The black spot was a death threat delivered on a piece of paper."
    ];

    const treasureNames = ['Gold Doubloons', 'Sapphire Gem', 'Royal Crown', 'Cutlass', 'Trident', 'Ancient Map', 'Treasure Urn', 'Golden Anchor', 'Parrot Companion', 'Enchanted Compass'];

    let currentLevel = 1;
    let gold = 0;
    let streak = 0;
    let bestStreak = 0;
    let solved = 0;
    let currentAnswer = 0;
    let usedLore = [];
    let isShowingLore = false;
    let scoreSubmitted = false;

    const problemEl = document.getElementById('problem');
    const answerEl = document.getElementById('answer');
    const submitBtn = document.getElementById('submit');
    const lorePanel = document.getElementById('lore-panel');
    const loreTitleEl = document.getElementById('lore-title');
    const loreTextEl = document.getElementById('lore-text');
    const progressEl = document.getElementById('progress');
    const goldCountEl = document.getElementById('gold-count');
    const streakEl = document.getElementById('streak');
    const levelCompleteEl = document.getElementById('level-complete');
    const problemCardEl = document.getElementById('problem-card');
    const levelBtns = document.querySelectorAll('.level-btn');

    function generateProblem() {
      const level = levels[currentLevel];
      const op = level.ops[Math.floor(Math.random() * level.ops.length)];
      let a, b, answer;

      if (op === '+') {
        a = Math.floor(Math.random() * level.range[1]) + level.range[0];
        b = Math.floor(Math.random() * level.range[1]) + level.range[0];
        answer = a + b;
      } else if (op === '-') {
        a = Math.floor(Math.random() * level.range[1]) + level.range[0];
        b = Math.floor(Math.random() * a) + 1;
        answer = a - b;
      } else if (op === '√ó') {
        a = Math.floor(Math.random() * level.range[1]) + level.range[0];
        b = Math.floor(Math.random() * 10) + 2;
        answer = a * b;
      } else if (op === '√∑') {
        b = Math.floor(Math.random() * 10) + 2;
        answer = Math.floor(Math.random() * 10) + 2;
        a = b * answer;
      }

      currentAnswer = answer;
      problemEl.textContent = `${a} ${op} ${b} = ?`;
    }

    function showLore() {
      const treasure = treasureNames[Math.floor(Math.random() * treasureNames.length)];
      let loreText;

      if (usedLore.length >= lore.length) usedLore = [];
      do {
        loreText = lore[Math.floor(Math.random() * lore.length)];
      } while (usedLore.includes(loreText));
      usedLore.push(loreText);

      loreTitleEl.textContent = `${treasure} Found!`;
      loreTextEl.textContent = loreText;
      lorePanel.classList.add('show');
      isShowingLore = true;

      setTimeout(() => {
        lorePanel.classList.remove('show');
        closeChest();
        isShowingLore = false;

        if (solved >= levels[currentLevel].problems) {
          problemCardEl.classList.add('hidden');
          levelCompleteEl.classList.add('show');
          finalScoreEl.textContent = gold;
          scoreSubmitted = false;
          scoreSubmittedEl.classList.add('hidden');
          submitScoreBtn.disabled = false;
          playerNameInput.value = '';
        } else {
          generateProblem();
          answerEl.value = '';
          answerEl.focus();
        }
      }, 3500);
    }

    function checkAnswer() {
      if (isShowingLore) return;
      const userAnswer = parseInt(answerEl.value);
      if (isNaN(userAnswer)) return;

      if (userAnswer === currentAnswer) {
        openChest();
        streak++;
        if (streak > bestStreak) bestStreak = streak;
        solved++;
        gold += 10 * currentLevel * (1 + Math.floor(streak / 3));

        goldCountEl.textContent = gold;
        streakEl.textContent = streak;
        progressEl.style.width = (solved / levels[currentLevel].problems * 100) + '%';

        setTimeout(showLore, 1000);
      } else {
        streak = 0;
        streakEl.textContent = streak;
        problemCardEl.classList.add('shake');
        setTimeout(() => problemCardEl.classList.remove('shake'), 500);
        answerEl.value = '';
        answerEl.focus();
      }
    }

    function setLevel(level) {
      currentLevel = level;
      solved = 0;
      progressEl.style.width = '0%';

      levelBtns.forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.level) === level);
      });

      problemCardEl.classList.remove('hidden');
      levelCompleteEl.classList.remove('show');
      lorePanel.classList.remove('show');
      closeChest();

      generateProblem();
      answerEl.value = '';
      answerEl.focus();
    }

    submitBtn.addEventListener('click', checkAnswer);
    answerEl.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') checkAnswer();
    });

    levelBtns.forEach(btn => {
      btn.addEventListener('click', () => setLevel(parseInt(btn.dataset.level)));
    });

    document.getElementById('next-level').addEventListener('click', () => {
      if (currentLevel < 3) {
        setLevel(currentLevel + 1);
      } else {
        setLevel(1);
      }
    });

    // Score submission handler
    submitScoreBtn.addEventListener('click', async () => {
      if (scoreSubmitted) return;
      submitScoreBtn.disabled = true;
      const success = await submitScore(playerNameInput.value, gold, currentLevel, bestStreak);
      if (success) {
        scoreSubmitted = true;
        scoreSubmittedEl.classList.remove('hidden');
      } else {
        submitScoreBtn.disabled = false;
      }
    });

    generateProblem();

    // Animation loop
    const clock = new THREE.Clock();

    function animate() {
      requestAnimationFrame(animate);
      const delta = clock.getDelta();
      const time = clock.getElapsedTime();

      // Water animation
      water.material.uniforms['time'].value += delta * 0.5;

      // Lid animation
      lidGroup.rotation.x = THREE.MathUtils.lerp(lidGroup.rotation.x, targetLidRotation, 0.1);

      // Coin physics
      for (let i = coins.length - 1; i >= 0; i--) {
        const coin = coins[i];
        coin.userData.velocity.y -= 0.02; // gravity
        coin.position.add(coin.userData.velocity);
        coin.rotation.x += coin.userData.spin;
        coin.rotation.z += coin.userData.spin * 0.5;
        coin.userData.life -= delta;

        if (coin.userData.life <= 0 || coin.position.y < -2) {
          scene.remove(coin);
          coins.splice(i, 1);
        }
      }

      // Flame flicker
      flame1.position.y = flame1.userData.baseY + Math.sin(time * 10) * 0.05;
      flame2.position.y = flame2.userData.baseY + Math.sin(time * 10 + 1) * 0.05;
      flame1.scale.setScalar(0.9 + Math.random() * 0.2);
      flame2.scale.setScalar(0.9 + Math.random() * 0.2);

      // Torch light flicker
      torchLight1.intensity = 2 + Math.random() * 0.5;
      torchLight2.intensity = 2 + Math.random() * 0.5;

      // Gentle camera bob
      camera.position.y = 8 + Math.sin(time * 0.5) * 0.2;

      // Chest gentle rotation
      chestGroup.rotation.y = Math.sin(time * 0.3) * 0.05;

      renderer.render(scene, camera);
    }

    animate();

    // Resize handler
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
<script src="/sloppy-header/sloppy-bar.js"></script>
</body>
</html>
