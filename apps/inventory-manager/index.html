<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stock Manager</title>
  <link rel="icon" href="https://emojicdn.elk.sh/ðŸ“¦">
  <meta property="og:title" content="Stock Manager">
  <meta property="og:description" content="Simple stock levels and transfer tracking">
  <meta property="og:image" content="https://sloppy.live/inventory-manager/og-image.png">
  <meta property="og:url" content="https://sloppy.live/inventory-manager">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --cyan: #0ff;
      --green: #0f0;
      --yellow: #ff0;
      --red: #f44;
      --orange: #f80;
      --bg: #0a0a12;
      --card: #12121f;
      --border: #2a2a3e;
    }

    body {
      background: var(--bg);
      min-height: 100vh;
      font-family: 'Inter', sans-serif;
      color: #e0e0e0;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }

    h1 {
      font-size: 1.8em;
      color: var(--cyan);
      text-shadow: 0 0 15px var(--cyan);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .tabs {
      display: flex;
      gap: 5px;
      background: var(--card);
      padding: 5px;
      border-radius: 10px;
    }

    .tab {
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      color: #888;
      transition: all 0.2s;
      font-weight: 500;
    }

    .tab:hover { color: #fff; }
    .tab.active {
      background: var(--cyan);
      color: #000;
    }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }

    .stat-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }

    .stat-card .value {
      font-size: 2.2em;
      font-weight: 700;
      color: var(--cyan);
      text-shadow: 0 0 10px var(--cyan);
    }

    .stat-card .value.warning { color: var(--yellow); text-shadow: 0 0 10px var(--yellow); }
    .stat-card .value.danger { color: var(--red); text-shadow: 0 0 10px var(--red); }
    .stat-card .value.success { color: var(--green); text-shadow: 0 0 10px var(--green); }

    .stat-card .label {
      color: #666;
      font-size: 0.85em;
      margin-top: 5px;
    }

    .toolbar {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    input, select, textarea {
      background: var(--card);
      border: 1px solid var(--border);
      color: #fff;
      padding: 10px 14px;
      border-radius: 8px;
      font-family: inherit;
      font-size: 0.9em;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--cyan);
      box-shadow: 0 0 10px rgba(0,255,255,0.2);
    }

    .search-box { flex: 1; min-width: 200px; }

    button {
      background: var(--card);
      border: 1px solid var(--cyan);
      color: var(--cyan);
      padding: 10px 18px;
      border-radius: 8px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }

    button:hover {
      background: var(--cyan);
      color: #000;
    }

    button.primary {
      background: var(--cyan);
      color: #000;
    }

    button.sm {
      padding: 6px 12px;
      font-size: 0.85em;
    }

    button.danger { border-color: var(--red); color: var(--red); }
    button.danger:hover { background: var(--red); color: #fff; }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9em;
    }

    th {
      background: rgba(0,255,255,0.08);
      color: var(--cyan);
      text-align: left;
      padding: 14px;
      font-weight: 600;
    }

    td {
      padding: 14px;
      border-top: 1px solid var(--border);
      vertical-align: top;
    }

    tr:hover td { background: rgba(0,255,255,0.02); }

    .stock-bar {
      height: 8px;
      background: #222;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 5px;
    }

    .stock-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75em;
      font-weight: 600;
    }

    .badge.low { background: rgba(255,68,68,0.2); color: var(--red); }
    .badge.ok { background: rgba(0,255,0,0.2); color: var(--green); }
    .badge.on-order { background: rgba(255,136,0,0.2); color: var(--orange); }
    .badge.transfer-in { background: rgba(0,255,0,0.2); color: var(--green); }
    .badge.transfer-out { background: rgba(255,68,68,0.2); color: var(--red); }

    .product-name {
      font-weight: 600;
      color: #fff;
    }

    .product-sku {
      font-size: 0.8em;
      color: #666;
      font-family: monospace;
    }

    .product-desc {
      font-size: 0.8em;
      color: #888;
      margin-top: 4px;
      max-width: 300px;
    }

    .qty-cell {
      text-align: center;
    }

    .qty-main {
      font-size: 1.4em;
      font-weight: 700;
    }

    .qty-sub {
      font-size: 0.75em;
      color: #666;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-overlay.hidden { display: none; }

    .modal {
      background: var(--card);
      border: 1px solid var(--cyan);
      border-radius: 12px;
      padding: 25px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal h3 {
      color: var(--cyan);
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      font-size: 0.85em;
      color: #888;
      margin-bottom: 6px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .form-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid var(--border);
    }

    .empty {
      text-align: center;
      padding: 50px;
      color: #555;
    }

    .empty-icon {
      font-size: 3em;
      margin-bottom: 10px;
    }

    .section { display: none; }
    .section.active { display: block; }

    .transfer-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .transfer-item:last-child { border-bottom: none; }

    .transfer-icon {
      font-size: 1.5em;
    }

    .transfer-info { flex: 1; }
    .transfer-info .name { font-weight: 600; }
    .transfer-info .detail { font-size: 0.85em; color: #888; }
    .transfer-qty { font-size: 1.2em; font-weight: 600; }
    .transfer-date { font-size: 0.8em; color: #666; }

    .backlink {
      position: fixed;
      bottom: 5px;
      right: 10px;
      color: #333;
      text-decoration: none;
      font-size: 0.7em;
    }

    @media (max-width: 600px) {
      .form-row { grid-template-columns: 1fr; }
      h1 { font-size: 1.4em; }
      .stat-card .value { font-size: 1.8em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ðŸ“¦ Stock Manager</h1>
      <div class="tabs">
        <div class="tab active" onclick="showSection('stock', this)">Stock Levels</div>
        <div class="tab" onclick="showSection('transfers', this)">Transfer Log</div>
      </div>
    </header>

    <div class="stats-row">
      <div class="stat-card">
        <div class="value" id="totalItems">0</div>
        <div class="label">Total Items</div>
      </div>
      <div class="stat-card">
        <div class="value warning" id="lowStock">0</div>
        <div class="label">Low Stock</div>
      </div>
      <div class="stat-card">
        <div class="value" id="onOrder">0</div>
        <div class="label">On Order</div>
      </div>
      <div class="stat-card">
        <div class="value success" id="totalUnits">0</div>
        <div class="label">Total Units</div>
      </div>
    </div>

    <!-- Stock Levels Section -->
    <section id="stock-section" class="section active">
      <div class="toolbar">
        <input type="text" class="search-box" placeholder="Search by name or SKU..." id="stockSearch" oninput="renderStock()">
        <select id="stockFilter" onchange="renderStock()">
          <option value="all">All Items</option>
          <option value="low">Low Stock</option>
          <option value="on-order">On Order</option>
        </select>
        <button class="primary" onclick="openStockModal()">+ Add Item</button>
      </div>

      <div class="card">
        <table>
          <thead>
            <tr>
              <th>Product</th>
              <th>In Stock</th>
              <th>On Order</th>
              <th>Min Level</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="stockTable">
            <tr><td colspan="6" class="empty"><div class="empty-icon">ðŸ“¦</div>Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Transfers Section -->
    <section id="transfers-section" class="section">
      <div class="toolbar">
        <input type="text" class="search-box" placeholder="Search transfers..." id="transferSearch" oninput="renderTransfers()">
        <select id="transferFilter" onchange="renderTransfers()">
          <option value="all">All Transfers</option>
          <option value="in">Stock In</option>
          <option value="out">Stock Out</option>
          <option value="transfer">Transfers</option>
        </select>
        <button class="primary" onclick="openTransferModal()">+ Log Transfer</button>
      </div>

      <div class="card" style="padding:15px">
        <div id="transfersList">
          <div class="empty"><div class="empty-icon">ðŸ“‹</div>Loading...</div>
        </div>
      </div>
    </section>
  </div>

  <!-- Stock Modal -->
  <div class="modal-overlay hidden" id="stockModal">
    <div class="modal">
      <h3 id="stockModalTitle">Add Stock Item</h3>
      <form id="stockForm" onsubmit="saveStock(event)">
        <input type="hidden" id="stockId">
        <div class="form-row">
          <div class="form-group">
            <label>SKU *</label>
            <input type="text" id="stockSku" required placeholder="SKU-001">
          </div>
          <div class="form-group">
            <label>Name *</label>
            <input type="text" id="stockName" required placeholder="Product name">
          </div>
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="stockDesc" rows="2" placeholder="Detailed product description..."></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Current Stock</label>
            <input type="number" id="stockQty" value="0" min="0">
          </div>
          <div class="form-group">
            <label>On Order</label>
            <input type="number" id="stockOnOrder" value="0" min="0">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Min Stock Level</label>
            <input type="number" id="stockMin" value="10" min="0">
          </div>
          <div class="form-group">
            <label>Location</label>
            <input type="text" id="stockLocation" placeholder="Warehouse A">
          </div>
        </div>
        <div class="form-actions">
          <button type="button" onclick="closeModal('stockModal')">Cancel</button>
          <button type="submit" class="primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Transfer Modal -->
  <div class="modal-overlay hidden" id="transferModal">
    <div class="modal">
      <h3>Log Transfer</h3>
      <form id="transferForm" onsubmit="saveTransfer(event)">
        <div class="form-group">
          <label>Transfer Type *</label>
          <select id="transferType" required onchange="updateTransferFields()">
            <option value="in">Stock In (Receiving)</option>
            <option value="out">Stock Out (Shipping)</option>
            <option value="transfer">Internal Transfer</option>
            <option value="adjustment">Adjustment</option>
          </select>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>SKU</label>
            <input type="text" id="transferSku" placeholder="SKU-001">
          </div>
          <div class="form-group">
            <label>Product Name *</label>
            <input type="text" id="transferProduct" required placeholder="Product name">
          </div>
        </div>
        <div class="form-group">
          <label>Quantity *</label>
          <input type="number" id="transferQty" required min="1" value="1">
        </div>
        <div class="form-row" id="locationFields">
          <div class="form-group">
            <label>From Location</label>
            <input type="text" id="transferFrom" placeholder="Source">
          </div>
          <div class="form-group">
            <label>To Location</label>
            <input type="text" id="transferTo" placeholder="Destination">
          </div>
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea id="transferNotes" rows="2" placeholder="Additional details..."></textarea>
        </div>
        <div class="form-actions">
          <button type="button" onclick="closeModal('transferModal')">Cancel</button>
          <button type="submit" class="primary">Log Transfer</button>
        </div>
      </form>
    </div>
  </div>

  <a href="https://sloppy.live" class="backlink">sloppy.live</a>

  <script src="../supabase-config.js"></script>
  <script>
    let stockItems = [];
    let transfers = [];
    let userId = null;

    async function init() {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        userId = session.user.id;
      } else {
        const { data } = await supabase.auth.signInAnonymously();
        if (data?.user) userId = data.user.id;
      }
      loadData();
    }

    async function loadData() {
      await Promise.all([loadStock(), loadTransfers()]);
      updateStats();
    }

    async function loadStock() {
      const { data } = await supabase
        .from('inventory_products')
        .select('*')
        .order('created_at', { ascending: false });
      stockItems = data || [];
      renderStock();
    }

    async function loadTransfers() {
      const { data } = await supabase
        .from('inventory_transfers')
        .select('*')
        .order('created_at', { ascending: false });
      transfers = data || [];
      renderTransfers();
    }

    function updateStats() {
      document.getElementById('totalItems').textContent = stockItems.length;
      document.getElementById('lowStock').textContent = stockItems.filter(s => s.quantity <= (s.min_stock || 10)).length;
      document.getElementById('onOrder').textContent = stockItems.filter(s => s.sell_price > 0).length; // Using sell_price as on_order temp
      document.getElementById('totalUnits').textContent = stockItems.reduce((sum, s) => sum + (s.quantity || 0), 0);
    }

    function renderStock() {
      const search = document.getElementById('stockSearch').value.toLowerCase();
      const filter = document.getElementById('stockFilter').value;

      let filtered = stockItems.filter(s => {
        const matchSearch = !search || s.name?.toLowerCase().includes(search) || s.sku?.toLowerCase().includes(search);
        if (!matchSearch) return false;

        if (filter === 'low') return s.quantity <= (s.min_stock || 10);
        if (filter === 'on-order') return (s.sell_price || 0) > 0; // Using sell_price as on_order
        return true;
      });

      const tbody = document.getElementById('stockTable');

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty"><div class="empty-icon">ðŸ“¦</div>No items found</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map(s => {
        const isLow = s.quantity <= (s.min_stock || 10);
        const onOrder = s.sell_price || 0; // Using sell_price as on_order temp
        const pct = Math.min(100, (s.quantity / Math.max(s.min_stock || 10, 1)) * 50);
        const barColor = isLow ? 'var(--red)' : 'var(--green)';

        return `
          <tr>
            <td>
              <div class="product-name">${s.name || '-'}</div>
              <div class="product-sku">${s.sku || '-'}</div>
              ${s.description ? `<div class="product-desc">${s.description}</div>` : ''}
            </td>
            <td class="qty-cell">
              <div class="qty-main">${s.quantity || 0}</div>
              <div class="stock-bar"><div class="stock-bar-fill" style="width:${pct}%;background:${barColor}"></div></div>
            </td>
            <td class="qty-cell">
              ${onOrder > 0 ? `<span class="badge on-order">+${onOrder}</span>` : '-'}
            </td>
            <td class="qty-cell">
              <div class="qty-sub">Min: ${s.min_stock || 10}</div>
            </td>
            <td>
              ${isLow ? '<span class="badge low">Low Stock</span>' : '<span class="badge ok">OK</span>'}
            </td>
            <td>
              <button class="sm" onclick="openStockModal('${s.id}')">Edit</button>
              <button class="sm" onclick="quickTransfer('${s.sku}', '${s.name}')">Transfer</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderTransfers() {
      const search = document.getElementById('transferSearch').value.toLowerCase();
      const filter = document.getElementById('transferFilter').value;

      let filtered = transfers.filter(t => {
        const matchSearch = !search || t.product_name?.toLowerCase().includes(search) || t.sku?.toLowerCase().includes(search);
        if (!matchSearch) return false;

        if (filter === 'in') return t.transfer_type === 'in';
        if (filter === 'out') return t.transfer_type === 'out';
        if (filter === 'transfer') return t.transfer_type === 'transfer';
        return true;
      });

      const container = document.getElementById('transfersList');

      if (filtered.length === 0) {
        container.innerHTML = '<div class="empty"><div class="empty-icon">ðŸ“‹</div>No transfers logged</div>';
        return;
      }

      container.innerHTML = filtered.map(t => {
        const icon = t.transfer_type === 'in' ? 'ðŸ“¥' : t.transfer_type === 'out' ? 'ðŸ“¤' : 'ðŸ”„';
        const badge = t.transfer_type === 'in' ? 'transfer-in' : t.transfer_type === 'out' ? 'transfer-out' : 'on-order';
        const sign = t.transfer_type === 'in' ? '+' : t.transfer_type === 'out' ? '-' : 'â†”';
        const date = new Date(t.created_at).toLocaleString();
        const locations = t.from_location || t.to_location ?
          `${t.from_location || '?'} â†’ ${t.to_location || '?'}` : '';

        return `
          <div class="transfer-item">
            <div class="transfer-icon">${icon}</div>
            <div class="transfer-info">
              <div class="name">${t.product_name || t.sku || 'Unknown'}</div>
              <div class="detail">${locations} ${t.notes ? 'â€¢ ' + t.notes : ''}</div>
            </div>
            <div class="transfer-qty">
              <span class="badge ${badge}">${sign}${t.quantity}</span>
            </div>
            <div class="transfer-date">${date}</div>
          </div>
        `;
      }).join('');
    }

    function showSection(section, tab) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(section + '-section').classList.add('active');
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
    }

    function openStockModal(id = null) {
      document.getElementById('stockModalTitle').textContent = id ? 'Edit Item' : 'Add Stock Item';
      document.getElementById('stockForm').reset();
      document.getElementById('stockId').value = id || '';

      if (id) {
        const s = stockItems.find(x => x.id === id);
        if (s) {
          document.getElementById('stockSku').value = s.sku || '';
          document.getElementById('stockName').value = s.name || '';
          document.getElementById('stockDesc').value = s.description || '';
          document.getElementById('stockQty').value = s.quantity || 0;
          document.getElementById('stockOnOrder').value = s.sell_price || 0; // Using sell_price as on_order
          document.getElementById('stockMin').value = s.min_stock || 10;
          document.getElementById('stockLocation').value = s.location || '';
        }
      }

      document.getElementById('stockModal').classList.remove('hidden');
    }

    function openTransferModal() {
      document.getElementById('transferForm').reset();
      document.getElementById('transferModal').classList.remove('hidden');
    }

    function quickTransfer(sku, name) {
      document.getElementById('transferForm').reset();
      document.getElementById('transferSku').value = sku;
      document.getElementById('transferProduct').value = name;
      document.getElementById('transferModal').classList.remove('hidden');
    }

    function updateTransferFields() {
      // Could show/hide location fields based on type
    }

    function closeModal(id) {
      document.getElementById(id).classList.add('hidden');
    }

    async function saveStock(e) {
      e.preventDefault();
      const id = document.getElementById('stockId').value;
      const data = {
        sku: document.getElementById('stockSku').value,
        name: document.getElementById('stockName').value,
        description: document.getElementById('stockDesc').value,
        quantity: parseInt(document.getElementById('stockQty').value) || 0,
        sell_price: parseInt(document.getElementById('stockOnOrder').value) || 0, // Using sell_price as on_order
        min_stock: parseInt(document.getElementById('stockMin').value) || 10,
        location: document.getElementById('stockLocation').value,
        user_id: userId
      };

      if (id) {
        await supabase.from('inventory_products').update(data).eq('id', id);
      } else {
        await supabase.from('inventory_products').insert(data);
      }

      closeModal('stockModal');
      loadStock();
      updateStats();
    }

    async function saveTransfer(e) {
      e.preventDefault();
      const data = {
        transfer_type: document.getElementById('transferType').value,
        sku: document.getElementById('transferSku').value,
        product_name: document.getElementById('transferProduct').value,
        quantity: parseInt(document.getElementById('transferQty').value) || 1,
        from_location: document.getElementById('transferFrom').value,
        to_location: document.getElementById('transferTo').value,
        notes: document.getElementById('transferNotes').value,
        user_id: userId
      };

      await supabase.from('inventory_transfers').insert(data);
      closeModal('transferModal');
      loadTransfers();
    }

    document.querySelectorAll('.modal-overlay').forEach(o => {
      o.addEventListener('click', e => {
        if (e.target === o) o.classList.add('hidden');
      });
    });

    init();
  </script>
</body>
</html>
