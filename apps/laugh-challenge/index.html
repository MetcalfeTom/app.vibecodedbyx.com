<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LAUGH.EXE ‚Äî Try Not to Laugh</title>
  <link rel="icon" href="https://emojicdn.elk.sh/ü§ñ">
  <meta property="og:title" content="LAUGH.EXE ‚Äî Try Not to Laugh">
  <meta property="og:description" content="Submit jokes to break the robot. Survive without laughing. How long can you last?">
  <meta property="og:url" content="https://app.sloppy.live/laugh-challenge">
  <meta property="og:image" content="https://emojicdn.elk.sh/ü§ñ?style=google&size=512">
  <meta property="og:type" content="website">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400;700&family=Martian+Mono:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0e0a;
      --green: #39ff14;
      --green-dim: #1a7a0a;
      --red: #ff3333;
      --red-dim: #7a1a1a;
      --amber: #ffaa00;
      --panel: #0d120d;
      --border: #1a2a1a;
      --text: #c0d4c0;
      --text-dim: #5a7a5a;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Martian Mono', monospace;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    /* Circuit board background */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        linear-gradient(90deg, var(--border) 1px, transparent 1px) 0 0 / 40px 40px,
        linear-gradient(0deg, var(--border) 1px, transparent 1px) 0 0 / 40px 40px;
      opacity: 0.3;
      pointer-events: none;
      z-index: 0;
    }

    /* Scanline overlay */
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0, 0, 0, 0.08) 2px,
        rgba(0, 0, 0, 0.08) 4px
      );
      pointer-events: none;
      z-index: 9999;
    }

    .app-container {
      position: relative;
      z-index: 1;
      max-width: 560px;
      margin: 0 auto;
      padding: 20px 16px 100px;
      min-height: 100vh;
    }

    /* Glitch title */
    .title {
      font-family: 'Pixelify Sans', cursive;
      font-size: 3rem;
      font-weight: 700;
      color: var(--green);
      text-align: center;
      margin-bottom: 4px;
      text-shadow: 0 0 20px rgba(57, 255, 20, 0.4);
      animation: glitch 3s infinite;
      letter-spacing: 2px;
    }

    @keyframes glitch {
      0%, 90%, 100% { text-shadow: 0 0 20px rgba(57, 255, 20, 0.4); transform: none; }
      92% { text-shadow: -2px 0 var(--red), 2px 0 cyan; transform: translateX(-1px); }
      94% { text-shadow: 2px 0 var(--red), -2px 0 cyan; transform: translateX(1px); }
      96% { text-shadow: 0 0 20px rgba(57, 255, 20, 0.4); transform: none; }
    }

    .subtitle {
      text-align: center;
      font-size: 0.65rem;
      font-weight: 300;
      color: var(--text-dim);
      margin-bottom: 28px;
      letter-spacing: 3px;
      text-transform: uppercase;
    }

    /* Robot face */
    .robot-container {
      display: flex;
      justify-content: center;
      margin-bottom: 24px;
    }

    .robot {
      width: 120px;
      height: 120px;
      position: relative;
      transition: all 0.3s;
    }

    .robot-head {
      width: 100%;
      height: 100%;
      background: var(--panel);
      border: 2px solid var(--green);
      border-radius: 12px;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 15px rgba(57, 255, 20, 0.15), inset 0 0 20px rgba(0,0,0,0.5);
      overflow: hidden;
    }

    .robot-eyes {
      display: flex;
      gap: 20px;
      position: absolute;
      top: 32px;
    }

    .robot-eye {
      width: 18px;
      height: 18px;
      background: var(--green);
      border-radius: 50%;
      box-shadow: 0 0 8px var(--green);
      transition: all 0.3s;
    }

    .robot-mouth {
      position: absolute;
      bottom: 28px;
      width: 40px;
      height: 3px;
      background: var(--green);
      border-radius: 2px;
      transition: all 0.3s;
      box-shadow: 0 0 6px var(--green);
    }

    .robot-antenna {
      position: absolute;
      top: -16px;
      left: 50%;
      transform: translateX(-50%);
      width: 2px;
      height: 16px;
      background: var(--green);
    }

    .robot-antenna::after {
      content: '';
      position: absolute;
      top: -6px;
      left: -4px;
      width: 10px;
      height: 10px;
      background: var(--green);
      border-radius: 50%;
      box-shadow: 0 0 8px var(--green);
    }

    /* Robot stress states */
    .robot.stress-1 .robot-eye { background: var(--amber); box-shadow: 0 0 8px var(--amber); }
    .robot.stress-1 .robot-mouth { width: 30px; height: 6px; border-radius: 0 0 15px 15px; background: var(--amber); box-shadow: 0 0 6px var(--amber); }
    .robot.stress-1 .robot-head { border-color: var(--amber); box-shadow: 0 0 15px rgba(255,170,0,0.15), inset 0 0 20px rgba(0,0,0,0.5); }

    .robot.stress-2 .robot-eye { background: #ff6633; box-shadow: 0 0 12px #ff6633; width: 22px; height: 22px; }
    .robot.stress-2 .robot-mouth { width: 35px; height: 12px; border-radius: 0 0 18px 18px; background: #ff6633; box-shadow: 0 0 8px #ff6633; }
    .robot.stress-2 .robot-head { border-color: #ff6633; box-shadow: 0 0 20px rgba(255,102,51,0.2), inset 0 0 20px rgba(0,0,0,0.5); }
    .robot.stress-2 { animation: shake 0.3s infinite; }

    .robot.stress-3 .robot-eye { background: var(--red); box-shadow: 0 0 16px var(--red); width: 24px; height: 24px; border-radius: 4px; }
    .robot.stress-3 .robot-mouth { width: 44px; height: 18px; border-radius: 0 0 22px 22px; background: var(--red); box-shadow: 0 0 12px var(--red); }
    .robot.stress-3 .robot-head { border-color: var(--red); box-shadow: 0 0 30px rgba(255,51,51,0.3), inset 0 0 20px rgba(0,0,0,0.5); }
    .robot.stress-3 { animation: shake 0.15s infinite; }

    .robot.broken .robot-eye { background: var(--red); width: 20px; height: 4px; border-radius: 0; transform: rotate(45deg); }
    .robot.broken .robot-eye:last-child { transform: rotate(-45deg); }
    .robot.broken .robot-mouth { width: 36px; height: 20px; border-radius: 50%; background: transparent; border: 3px solid var(--red); box-shadow: 0 0 12px var(--red); }
    .robot.broken .robot-head { border-color: var(--red); box-shadow: 0 0 40px rgba(255,51,51,0.4), inset 0 0 20px rgba(0,0,0,0.5); }
    .robot.broken .robot-antenna::after { background: var(--red-dim); box-shadow: none; }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-2px) rotate(-1deg); }
      75% { transform: translateX(2px) rotate(1deg); }
    }

    /* Buttons */
    .btn {
      font-family: 'Pixelify Sans', cursive;
      font-size: 1.1rem;
      padding: 12px 28px;
      border: 2px solid var(--green);
      background: transparent;
      color: var(--green);
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
      letter-spacing: 1px;
      position: relative;
      overflow: hidden;
    }

    .btn:hover:not(:disabled) {
      background: var(--green);
      color: var(--bg);
      box-shadow: 0 0 20px rgba(57, 255, 20, 0.3);
    }

    .btn:active:not(:disabled) { transform: scale(0.97); }
    .btn:disabled { opacity: 0.3; cursor: not-allowed; }

    .btn-red {
      border-color: var(--red);
      color: var(--red);
    }
    .btn-red:hover:not(:disabled) {
      background: var(--red);
      color: var(--bg);
      box-shadow: 0 0 20px rgba(255, 51, 51, 0.3);
    }

    .btn-amber {
      border-color: var(--amber);
      color: var(--amber);
    }
    .btn-amber:hover:not(:disabled) {
      background: var(--amber);
      color: var(--bg);
      box-shadow: 0 0 20px rgba(255, 170, 0, 0.3);
    }

    .btn-row {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    /* Panels */
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .panel-header {
      font-family: 'Pixelify Sans', cursive;
      font-size: 1rem;
      color: var(--green);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Screens */
    .screen { display: none; }
    .screen.active { display: block; }

    /* Landing */
    .landing-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 28px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0;
      margin-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .tab {
      font-family: 'Martian Mono', monospace;
      font-size: 0.6rem;
      font-weight: 400;
      padding: 8px 14px;
      background: transparent;
      border: none;
      color: var(--text-dim);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      letter-spacing: 1px;
    }

    .tab:hover { color: var(--text); }
    .tab.active { color: var(--green); border-bottom-color: var(--green); }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Leaderboard items */
    .lb-item {
      display: flex;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
      gap: 10px;
      font-size: 0.75rem;
    }

    .lb-item:last-child { border-bottom: none; }

    .lb-rank {
      font-family: 'Pixelify Sans', cursive;
      font-size: 1rem;
      width: 28px;
      text-align: center;
      color: var(--green);
      flex-shrink: 0;
    }

    .lb-rank.gold { color: #ffd700; }
    .lb-rank.silver { color: #c0c0c0; }
    .lb-rank.bronze { color: #cd7f32; }

    .lb-info { flex: 1; min-width: 0; }
    .lb-name { font-weight: 700; color: var(--text); margin-bottom: 2px; }
    .lb-detail { font-size: 0.6rem; color: var(--text-dim); font-weight: 300; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .lb-stat { font-family: 'Pixelify Sans', cursive; font-size: 1.1rem; color: var(--green); flex-shrink: 0; }
    .lb-empty { text-align: center; color: var(--text-dim); font-size: 0.7rem; padding: 20px; font-weight: 300; }

    /* Submit screen */
    .joke-textarea {
      width: 100%;
      min-height: 100px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-family: 'Martian Mono', monospace;
      font-size: 0.8rem;
      padding: 12px;
      resize: vertical;
      outline: none;
      transition: border-color 0.2s;
    }

    .joke-textarea:focus { border-color: var(--green); }

    .char-count {
      text-align: right;
      font-size: 0.6rem;
      color: var(--text-dim);
      margin-top: 4px;
      margin-bottom: 12px;
      font-weight: 300;
    }

    .char-count.warn { color: var(--amber); }
    .char-count.over { color: var(--red); }

    .my-joke {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
      gap: 10px;
    }

    .my-joke:last-child { border-bottom: none; }

    .my-joke-text {
      font-size: 0.75rem;
      flex: 1;
      line-height: 1.5;
      font-weight: 300;
    }

    .my-joke-delete {
      background: none;
      border: 1px solid var(--red-dim);
      color: var(--red);
      font-size: 0.6rem;
      font-family: 'Martian Mono', monospace;
      padding: 3px 8px;
      cursor: pointer;
      border-radius: 3px;
      flex-shrink: 0;
      transition: all 0.2s;
    }

    .my-joke-delete:hover { background: var(--red); color: var(--bg); }

    /* Challenge screen */
    .streak-display {
      text-align: center;
      margin-bottom: 20px;
    }

    .streak-label {
      font-size: 0.6rem;
      color: var(--text-dim);
      letter-spacing: 3px;
      text-transform: uppercase;
      font-weight: 300;
    }

    .streak-num {
      font-family: 'Pixelify Sans', cursive;
      font-size: 4rem;
      color: var(--green);
      text-shadow: 0 0 30px rgba(57, 255, 20, 0.3);
      line-height: 1;
    }

    .joke-card {
      background: var(--bg);
      border: 1px solid var(--green-dim);
      border-radius: 6px;
      padding: 24px 20px;
      margin-bottom: 20px;
      font-size: 0.85rem;
      line-height: 1.7;
      text-align: center;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 300;
      position: relative;
    }

    .joke-card::before {
      content: '>';
      position: absolute;
      top: 8px;
      left: 12px;
      font-family: 'Pixelify Sans', cursive;
      color: var(--green-dim);
      font-size: 0.7rem;
    }

    .joke-counter {
      text-align: center;
      font-size: 0.6rem;
      color: var(--text-dim);
      margin-bottom: 16px;
      font-weight: 300;
    }

    .challenge-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    /* Game over */
    .gameover-streak {
      font-family: 'Pixelify Sans', cursive;
      font-size: 5rem;
      color: var(--green);
      text-align: center;
      text-shadow: 0 0 40px rgba(57, 255, 20, 0.3);
      line-height: 1;
      margin: 12px 0 4px;
    }

    .gameover-label {
      text-align: center;
      font-size: 0.65rem;
      color: var(--text-dim);
      letter-spacing: 3px;
      text-transform: uppercase;
      margin-bottom: 20px;
      font-weight: 300;
    }

    .breaking-joke {
      background: var(--red-dim);
      border: 1px solid var(--red);
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 20px;
      font-size: 0.8rem;
      text-align: center;
      line-height: 1.6;
      font-weight: 300;
    }

    .breaking-joke-label {
      font-family: 'Pixelify Sans', cursive;
      font-size: 0.8rem;
      color: var(--red);
      margin-bottom: 8px;
    }

    /* Victory */
    .victory-text {
      font-family: 'Pixelify Sans', cursive;
      font-size: 1.6rem;
      color: var(--green);
      text-align: center;
      margin-bottom: 8px;
      text-shadow: 0 0 20px rgba(57, 255, 20, 0.4);
    }

    /* Back link */
    .backlink {
      text-align: center;
      margin-top: 32px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    .backlink a {
      color: var(--text-dim);
      font-size: 0.6rem;
      text-decoration: none;
      font-weight: 300;
      letter-spacing: 1px;
      transition: color 0.2s;
    }

    .backlink a:hover { color: var(--green); }

    /* Utility */
    .mb-12 { margin-bottom: 12px; }
    .mb-16 { margin-bottom: 16px; }
    .text-center { text-align: center; }
    .hidden { display: none !important; }

    /* Loading */
    .loading {
      text-align: center;
      padding: 30px;
      color: var(--text-dim);
      font-size: 0.7rem;
      font-weight: 300;
    }

    .loading::after {
      content: '';
      animation: dots 1.5s infinite;
    }

    @keyframes dots {
      0% { content: '.'; }
      33% { content: '..'; }
      66% { content: '...'; }
    }

    /* Error */
    .error-msg {
      background: var(--red-dim);
      border: 1px solid var(--red);
      border-radius: 4px;
      padding: 10px 14px;
      font-size: 0.7rem;
      color: var(--red);
      margin-bottom: 12px;
      font-weight: 300;
    }

    /* Nav back */
    .nav-back {
      background: none;
      border: none;
      color: var(--text-dim);
      font-family: 'Martian Mono', monospace;
      font-size: 0.65rem;
      cursor: pointer;
      margin-bottom: 16px;
      padding: 4px 0;
      transition: color 0.2s;
      font-weight: 300;
    }

    .nav-back:hover { color: var(--green); }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--green);
      color: var(--bg);
      font-family: 'Martian Mono', monospace;
      font-size: 0.7rem;
      font-weight: 700;
      padding: 10px 20px;
      border-radius: 4px;
      z-index: 10000;
      transition: transform 0.3s ease;
      box-shadow: 0 0 20px rgba(57, 255, 20, 0.3);
    }

    .toast.show { transform: translateX(-50%) translateY(0); }
    .toast.error { background: var(--red); box-shadow: 0 0 20px rgba(255, 51, 51, 0.3); }

    @media (max-width: 480px) {
      .title { font-size: 2.2rem; }
      .app-container { padding: 16px 12px 80px; }
      .btn { padding: 10px 18px; font-size: 1rem; }
      .gameover-streak { font-size: 4rem; }
      .streak-num { font-size: 3rem; }
    }
  </style>
</head>
<body>
  <div class="app-container">

    <!-- ===== LANDING ===== -->
    <div id="screen-landing" class="screen active">
      <h1 class="title">LAUGH.EXE</h1>
      <p class="subtitle">try not to laugh challenge</p>

      <div class="robot-container">
        <div class="robot" id="landing-robot">
          <div class="robot-antenna"></div>
          <div class="robot-head">
            <div class="robot-eyes">
              <div class="robot-eye"></div>
              <div class="robot-eye"></div>
            </div>
            <div class="robot-mouth"></div>
          </div>
        </div>
      </div>

      <div class="landing-actions">
        <button class="btn" onclick="showScreen('submit')">Submit Joke</button>
        <button class="btn btn-amber" onclick="startChallenge()">Challenge</button>
      </div>

      <div class="tabs" id="lb-tabs">
        <button class="tab active" data-tab="funniest" onclick="switchTab(this)">Funniest</button>
        <button class="tab" data-tab="stoneface" onclick="switchTab(this)">Stone Faces</button>
        <button class="tab" data-tab="submitters" onclick="switchTab(this)">Top Submitters</button>
      </div>

      <div id="tab-funniest" class="tab-content active">
        <div class="loading" id="lb-funniest-loading">Loading</div>
        <div id="lb-funniest-list"></div>
      </div>

      <div id="tab-stoneface" class="tab-content">
        <div class="loading" id="lb-stoneface-loading">Loading</div>
        <div id="lb-stoneface-list"></div>
      </div>

      <div id="tab-submitters" class="tab-content">
        <div class="loading" id="lb-submitters-loading">Loading</div>
        <div id="lb-submitters-list"></div>
      </div>

      <div class="backlink">
        <a href="https://sloppy.live" target="_blank">sloppy.live</a>
      </div>
    </div>

    <!-- ===== SUBMIT ===== -->
    <div id="screen-submit" class="screen">
      <button class="nav-back" onclick="showScreen('landing')">&lt; back</button>
      <h2 class="panel-header">Submit a Joke</h2>

      <textarea class="joke-textarea" id="joke-input" placeholder="Type your funniest joke..." maxlength="500" oninput="updateCharCount()"></textarea>
      <div class="char-count" id="char-count">0 / 500</div>

      <button class="btn mb-16" id="submit-joke-btn" onclick="submitJoke()">Upload to LAUGH.EXE</button>

      <div id="submit-error" class="error-msg hidden"></div>

      <div class="panel">
        <div class="panel-header">Your Jokes</div>
        <div id="my-jokes-loading" class="loading">Loading</div>
        <div id="my-jokes-list"></div>
        <div id="my-jokes-empty" class="lb-empty hidden">No jokes submitted yet</div>
      </div>
    </div>

    <!-- ===== CHALLENGE ===== -->
    <div id="screen-challenge" class="screen">
      <div class="streak-display">
        <div class="streak-label">Streak</div>
        <div class="streak-num" id="streak-num">0</div>
      </div>

      <div class="robot-container">
        <div class="robot" id="challenge-robot">
          <div class="robot-antenna"></div>
          <div class="robot-head">
            <div class="robot-eyes">
              <div class="robot-eye"></div>
              <div class="robot-eye"></div>
            </div>
            <div class="robot-mouth"></div>
          </div>
        </div>
      </div>

      <div class="joke-card" id="joke-card">Loading joke...</div>
      <div class="joke-counter" id="joke-counter"></div>

      <div class="challenge-actions">
        <button class="btn" id="btn-survived" onclick="survived()">Survived üòê</button>
        <button class="btn btn-red" id="btn-cracked" onclick="cracked()">Cracked üòÇ</button>
      </div>

      <div class="text-center" style="margin-top: 16px;">
        <button class="nav-back" onclick="abandonChallenge()">&lt; quit</button>
      </div>
    </div>

    <!-- ===== GAME OVER ===== -->
    <div id="screen-gameover" class="screen">
      <h1 class="title" style="font-size: 2rem;">CIRCUIT BROKEN</h1>

      <div class="robot-container">
        <div class="robot broken" id="gameover-robot">
          <div class="robot-antenna"></div>
          <div class="robot-head">
            <div class="robot-eyes">
              <div class="robot-eye"></div>
              <div class="robot-eye"></div>
            </div>
            <div class="robot-mouth"></div>
          </div>
        </div>
      </div>

      <div class="gameover-streak" id="final-streak">0</div>
      <div class="gameover-label">jokes survived</div>

      <div id="breaking-joke-box" class="breaking-joke hidden">
        <div class="breaking-joke-label">The joke that broke you:</div>
        <div id="breaking-joke-text"></div>
      </div>

      <div class="btn-row">
        <button class="btn btn-amber" onclick="startChallenge()">Try Again</button>
        <button class="btn" onclick="showScreen('landing')">Home</button>
      </div>
    </div>

    <!-- ===== VICTORY ===== -->
    <div id="screen-victory" class="screen">
      <h1 class="title" style="font-size: 2rem;">UNBREAKABLE</h1>

      <div class="robot-container">
        <div class="robot" id="victory-robot">
          <div class="robot-antenna"></div>
          <div class="robot-head">
            <div class="robot-eyes">
              <div class="robot-eye"></div>
              <div class="robot-eye"></div>
            </div>
            <div class="robot-mouth"></div>
          </div>
        </div>
      </div>

      <div class="victory-text">YOU SURVIVED ALL JOKES</div>
      <div class="gameover-streak" id="victory-streak">0</div>
      <div class="gameover-label">jokes survived</div>

      <div class="btn-row" style="margin-top: 20px;">
        <button class="btn" onclick="showScreen('landing')">Home</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    import supabase, { supabaseSession } from './supabase-config.js';

    let currentUser = null;
    let username = 'anonymous';
    let challengeJokes = [];
    let challengeIndex = 0;
    let streak = 0;
    let debouncing = false;

    // ===== INIT =====
    async function init() {
      try {
        const sess = await supabaseSession();
        currentUser = sess.user;

        // Try to get username from sloppy bar context
        if (typeof window.sloppyBarGetContext === 'function') {
          try {
            const ctx = await window.sloppyBarGetContext();
            if (ctx?.username) username = ctx.username;
          } catch (e) { /* ignore */ }
        }

        // Fallback: try sloppygram_profiles
        if (username === 'anonymous' && currentUser) {
          try {
            const { data } = await supabase
              .from('sloppygram_profiles')
              .select('username')
              .eq('user_id', currentUser.id)
              .single();
            if (data?.username) username = data.username;
          } catch (e) { /* ignore */ }
        }

        loadLeaderboards();
      } catch (err) {
        console.error('Init failed:', err);
        showToast('Auth failed ‚Äî try refreshing', true);
      }
    }

    // ===== SCREENS =====
    window.showScreen = function(name) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById('screen-' + name).classList.add('active');

      if (name === 'submit') loadMyJokes();
      if (name === 'landing') loadLeaderboards();
    };

    // ===== TABS =====
    window.switchTab = function(el) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      el.classList.add('active');
      document.getElementById('tab-' + el.dataset.tab).classList.add('active');
    };

    // ===== SUBMIT JOKE =====
    window.updateCharCount = function() {
      const ta = document.getElementById('joke-input');
      const count = ta.value.length;
      const el = document.getElementById('char-count');
      el.textContent = count + ' / 500';
      el.className = 'char-count' + (count > 480 ? ' over' : count > 400 ? ' warn' : '');
    };

    window.submitJoke = async function() {
      if (!currentUser) { showToast('Not authenticated', true); return; }
      const text = document.getElementById('joke-input').value.trim();
      if (!text) { showToast('Write a joke first!', true); return; }
      if (text.length > 500) { showToast('Too long!', true); return; }

      const btn = document.getElementById('submit-joke-btn');
      btn.disabled = true;

      try {
        const { error } = await supabase.from('laugh_jokes').insert({
          user_id: currentUser.id,
          username: username,
          joke_text: text,
          times_shown: 0,
          times_cracked: 0
        });

        if (error) throw error;

        document.getElementById('joke-input').value = '';
        updateCharCount();
        showToast('Joke uploaded!');
        loadMyJokes();
      } catch (err) {
        console.error('Submit error:', err);
        showToast('Failed to submit', true);
      } finally {
        btn.disabled = false;
      }
    };

    // ===== MY JOKES =====
    async function loadMyJokes() {
      if (!currentUser) return;

      const loading = document.getElementById('my-jokes-loading');
      const list = document.getElementById('my-jokes-list');
      const empty = document.getElementById('my-jokes-empty');
      loading.classList.remove('hidden');
      list.innerHTML = '';
      empty.classList.add('hidden');

      try {
        const { data, error } = await supabase
          .from('laugh_jokes')
          .select('*')
          .eq('user_id', currentUser.id)
          .order('created_at', { ascending: false });

        if (error) throw error;
        loading.classList.add('hidden');

        if (!data || data.length === 0) {
          empty.classList.remove('hidden');
          return;
        }

        data.forEach(joke => {
          const div = document.createElement('div');
          div.className = 'my-joke';
          div.innerHTML = `
            <div class="my-joke-text">${escapeHtml(joke.joke_text)}</div>
            <button class="my-joke-delete" onclick="deleteJoke('${joke.created_at}')">del</button>
          `;
          list.appendChild(div);
        });
      } catch (err) {
        console.error('Load jokes error:', err);
        loading.textContent = 'Failed to load';
      }
    }

    window.deleteJoke = async function(createdAt) {
      if (!currentUser) return;
      if (!confirm('Delete this joke?')) return;

      try {
        const { error } = await supabase
          .from('laugh_jokes')
          .delete()
          .eq('user_id', currentUser.id)
          .eq('created_at', createdAt);

        if (error) throw error;
        showToast('Deleted');
        loadMyJokes();
      } catch (err) {
        console.error('Delete error:', err);
        showToast('Failed to delete', true);
      }
    };

    // ===== CHALLENGE =====
    window.startChallenge = async function() {
      if (!currentUser) { showToast('Not authenticated', true); return; }

      showScreen('challenge');
      streak = 0;
      challengeIndex = 0;
      updateStreak();
      document.getElementById('joke-card').textContent = 'Loading jokes...';
      document.getElementById('joke-counter').textContent = '';
      document.getElementById('btn-survived').disabled = true;
      document.getElementById('btn-cracked').disabled = true;

      try {
        const { data, error } = await supabase
          .from('laugh_jokes')
          .select('*')
          .neq('user_id', currentUser.id)
          .limit(100);

        if (error) throw error;

        if (!data || data.length === 0) {
          document.getElementById('joke-card').textContent = 'No jokes available yet! Go submit some, or get others to submit.';
          return;
        }

        // Shuffle
        challengeJokes = data.sort(() => Math.random() - 0.5);
        showCurrentJoke();
      } catch (err) {
        console.error('Challenge load error:', err);
        document.getElementById('joke-card').textContent = 'Failed to load jokes.';
      }
    };

    function showCurrentJoke() {
      if (challengeIndex >= challengeJokes.length) {
        // Victory!
        recordStreak(null);
        document.getElementById('victory-streak').textContent = streak;
        showScreen('victory');
        return;
      }

      const joke = challengeJokes[challengeIndex];
      document.getElementById('joke-card').textContent = joke.joke_text;
      document.getElementById('joke-counter').textContent = `Joke ${challengeIndex + 1} of ${challengeJokes.length}`;
      document.getElementById('btn-survived').disabled = false;
      document.getElementById('btn-cracked').disabled = false;

      updateRobotStress();
    }

    function updateStreak() {
      document.getElementById('streak-num').textContent = streak;
    }

    function updateRobotStress() {
      const robot = document.getElementById('challenge-robot');
      robot.className = 'robot';
      if (streak >= 15) robot.classList.add('stress-3');
      else if (streak >= 8) robot.classList.add('stress-2');
      else if (streak >= 3) robot.classList.add('stress-1');
    }

    window.survived = function() {
      if (debouncing) return;
      debounce();

      streak++;
      challengeIndex++;
      updateStreak();
      showCurrentJoke();
    };

    window.cracked = function() {
      if (debouncing) return;
      debounce();

      const joke = challengeJokes[challengeIndex];
      recordStreak(joke.joke_text);

      document.getElementById('final-streak').textContent = streak;

      if (joke) {
        document.getElementById('breaking-joke-text').textContent = joke.joke_text;
        document.getElementById('breaking-joke-box').classList.remove('hidden');
      } else {
        document.getElementById('breaking-joke-box').classList.add('hidden');
      }

      showScreen('gameover');
    };

    window.abandonChallenge = function() {
      if (streak > 0 && !confirm('Abandon streak of ' + streak + '?')) return;
      showScreen('landing');
    };

    async function recordStreak(breakingJoke) {
      if (!currentUser || streak === 0) return;

      try {
        const { error } = await supabase.from('laugh_streaks').insert({
          user_id: currentUser.id,
          username: username,
          streak: streak,
          cracked_on_joke: breakingJoke
        });
        if (error) console.error('Record streak error:', error);
      } catch (err) {
        console.error('Record streak error:', err);
      }
    }

    function debounce() {
      debouncing = true;
      setTimeout(() => { debouncing = false; }, 300);
    }

    // ===== LEADERBOARDS =====
    async function loadLeaderboards() {
      loadFunniest();
      loadStoneFaces();
      loadSubmitters();
    }

    async function loadFunniest() {
      const loading = document.getElementById('lb-funniest-loading');
      const list = document.getElementById('lb-funniest-list');
      loading.classList.remove('hidden');
      list.innerHTML = '';

      try {
        // Get all streaks where someone cracked to count per joke
        const { data: streaks, error } = await supabase
          .from('laugh_streaks')
          .select('cracked_on_joke')
          .not('cracked_on_joke', 'is', null);

        if (error) throw error;
        loading.classList.add('hidden');

        if (!streaks || streaks.length === 0) {
          list.innerHTML = '<div class="lb-empty">No cracks yet ‚Äî all stone faces so far</div>';
          return;
        }

        // Count cracks per joke
        const crackMap = {};
        streaks.forEach(s => {
          const key = s.cracked_on_joke;
          crackMap[key] = (crackMap[key] || 0) + 1;
        });

        // Sort by crack count
        const sorted = Object.entries(crackMap)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10);

        sorted.forEach(([joke, count], i) => {
          list.appendChild(makeLbItem(
            i + 1,
            truncate(joke, 60),
            joke,
            count + ' crack' + (count !== 1 ? 's' : '')
          ));
        });
      } catch (err) {
        console.error('Funniest load error:', err);
        loading.textContent = 'Failed to load';
      }
    }

    async function loadStoneFaces() {
      const loading = document.getElementById('lb-stoneface-loading');
      const list = document.getElementById('lb-stoneface-list');
      loading.classList.remove('hidden');
      list.innerHTML = '';

      try {
        const { data, error } = await supabase
          .from('laugh_streaks')
          .select('username, streak')
          .order('streak', { ascending: false })
          .limit(10);

        if (error) throw error;
        loading.classList.add('hidden');

        if (!data || data.length === 0) {
          list.innerHTML = '<div class="lb-empty">No challenges completed yet</div>';
          return;
        }

        data.forEach((row, i) => {
          list.appendChild(makeLbItem(
            i + 1,
            row.username || 'anonymous',
            '',
            row.streak + ' survived'
          ));
        });
      } catch (err) {
        console.error('Stone faces load error:', err);
        loading.textContent = 'Failed to load';
      }
    }

    async function loadSubmitters() {
      const loading = document.getElementById('lb-submitters-loading');
      const list = document.getElementById('lb-submitters-list');
      loading.classList.remove('hidden');
      list.innerHTML = '';

      try {
        const { data, error } = await supabase
          .from('laugh_jokes')
          .select('username');

        if (error) throw error;
        loading.classList.add('hidden');

        if (!data || data.length === 0) {
          list.innerHTML = '<div class="lb-empty">No jokes submitted yet</div>';
          return;
        }

        // Count per user
        const countMap = {};
        data.forEach(j => {
          const name = j.username || 'anonymous';
          countMap[name] = (countMap[name] || 0) + 1;
        });

        const sorted = Object.entries(countMap)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10);

        sorted.forEach(([name, count], i) => {
          list.appendChild(makeLbItem(
            i + 1,
            name,
            '',
            count + ' joke' + (count !== 1 ? 's' : '')
          ));
        });
      } catch (err) {
        console.error('Submitters load error:', err);
        loading.textContent = 'Failed to load';
      }
    }

    function makeLbItem(rank, name, detail, stat) {
      const div = document.createElement('div');
      div.className = 'lb-item';
      const rankClass = rank === 1 ? 'gold' : rank === 2 ? 'silver' : rank === 3 ? 'bronze' : '';
      div.innerHTML = `
        <div class="lb-rank ${rankClass}">${rank}</div>
        <div class="lb-info">
          <div class="lb-name">${escapeHtml(name)}</div>
          ${detail ? '<div class="lb-detail">' + escapeHtml(detail) + '</div>' : ''}
        </div>
        <div class="lb-stat">${escapeHtml(stat)}</div>
      `;
      return div;
    }

    // ===== UTILS =====
    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function truncate(str, len) {
      if (!str) return '';
      return str.length > len ? str.slice(0, len) + '...' : str;
    }

    function showToast(msg, isError = false) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.className = 'toast' + (isError ? ' error' : '');
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2500);
    }

    // ===== BOOT =====
    init();
  </script>
<script src="/vibelib-extended.js"></script>
<script>
  // Compatibility Patch for Legacy Apps
  window.addEventListener("load", () => {
    if (window.SloppyKarma && window.VibeLib.Economy) {
      // Redirect old calls to new engine
      window.SloppyKarma.track = window.VibeLib.Economy.track;
    }
  });
</script>
</body>
</html>
