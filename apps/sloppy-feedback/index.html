<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sloppy Feedback</title>
    <link rel="icon" href="https://emojicdn.elk.sh/üí°">
    <meta property="og:title" content="Sloppy Feedback">
    <meta property="og:description" content="Submit ideas, report bugs, vote on what gets built next.">
    <meta property="og:url" content="https://app.sloppy.live/sloppy-feedback">
    <meta property="og:image" content="https://pollinations.ai/p/a%20suggestion%20box%20glowing%20with%20neon%20light%20bulbs%20on%20dark%20background%20pixel%20art?width=1200&height=630&nologo=true&referrer=sloppy.live">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,wght@0,300;0,400;0,700;1,400&family=Source+Code+Pro:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #08080c;
            --surface: #10101a;
            --surface-hover: #181824;
            --border: #22223a;
            --border-active: #3a3a5a;
            --text: #dcdce8;
            --text-dim: #8888a8;
            --text-muted: #4a4a68;
            --accent: #6ee06e;
            --accent-dim: #3a8a3a;
            --pink: #e06ea0;
            --orange: #e0a040;
            --blue: #5080e0;
            --red: #e05050;
            --upvote: #6ee06e;
            --downvote: #e05050;
            --card-own: rgba(110,224,110,0.04);
            --serif: 'Newsreader', Georgia, serif;
            --mono: 'Source Code Pro', 'Courier New', monospace;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: var(--bg);
            color: var(--text);
            font-family: var(--mono);
            font-size: 13px;
            min-height: 100vh;
        }
        a { color: var(--accent); text-decoration: none; }
        a:hover { text-decoration: underline; }

        .hdr {
            text-align: center;
            padding: 28px 16px 20px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(180deg, #10101a 0%, var(--bg) 100%);
        }
        .hdr h1 {
            font-family: var(--serif);
            font-size: 2.2rem;
            font-weight: 400;
        }
        .hdr h1 span { color: var(--accent); }
        .hdr .sub {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 4px;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }
        .stats-row {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 12px;
        }
        .stat { text-align: center; }
        .stat .val { font-size: 18px; font-weight: 700; color: var(--accent); }
        .stat .lbl { font-size: 9px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; }

        .toolbar {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            background: var(--surface);
            position: sticky;
            top: 0;
            z-index: 50;
            flex-wrap: wrap;
        }
        .filter-btn {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-dim);
            font-family: var(--mono);
            font-size: 10px;
            padding: 4px 10px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .filter-btn:hover { color: var(--text); border-color: var(--border-active); }
        .filter-btn.active { color: var(--accent); border-color: var(--accent-dim); background: rgba(110,224,110,0.06); }
        .toolbar-right { margin-left: auto; }
        .new-btn {
            background: var(--accent-dim);
            color: #fff;
            border: none;
            font-family: var(--mono);
            font-size: 11px;
            padding: 6px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 700;
        }
        .new-btn:hover { background: var(--accent); color: #000; }

        .sort-row {
            display: flex;
            gap: 4px;
            padding: 6px 12px;
            border-bottom: 1px solid var(--border);
            font-size: 10px;
            color: var(--text-muted);
            align-items: center;
        }
        .sort-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            font-family: var(--mono);
            font-size: 10px;
            padding: 2px 8px;
            cursor: pointer;
            border-radius: 3px;
        }
        .sort-btn:hover { color: var(--text); }
        .sort-btn.active { color: var(--accent); }

        .feed { max-width: 640px; margin: 0 auto; padding: 8px 8px 80px; }
        .feed-loading { text-align: center; padding: 40px; color: var(--text-muted); }
        .feed-empty { text-align: center; padding: 60px 20px; color: var(--text-muted); }
        .feed-empty .icon { font-size: 2.4rem; margin-bottom: 8px; }

        /* Feedback card */
        .fb-card {
            display: flex;
            gap: 10px;
            padding: 12px;
            border-bottom: 1px solid var(--border);
            transition: background 0.15s;
        }
        .fb-card:hover { background: var(--surface-hover); }
        .fb-card.own { background: var(--card-own); border-left: 2px solid var(--accent-dim); }
        .fb-vote {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            flex-shrink: 0;
            width: 36px;
        }
        .vote-btn {
            background: none;
            border: 1px solid transparent;
            color: var(--text-muted);
            font-size: 11px;
            padding: 3px 6px;
            cursor: pointer;
            border-radius: 3px;
            font-family: var(--mono);
            transition: all 0.12s;
        }
        .vote-btn:hover { background: var(--surface-hover); color: var(--text); }
        .vote-btn.up.active { color: var(--upvote); border-color: var(--upvote); }
        .vote-btn.down.active { color: var(--downvote); border-color: var(--downvote); }
        .vote-count {
            font-size: 14px;
            font-weight: 700;
            min-width: 20px;
            text-align: center;
        }
        .vote-count.positive { color: var(--upvote); }
        .vote-count.negative { color: var(--downvote); }
        .vote-count.neutral { color: var(--text-muted); }
        .fb-body { flex: 1; min-width: 0; }
        .fb-title {
            font-weight: 500;
            font-size: 13px;
            color: var(--text);
            margin-bottom: 2px;
        }
        .fb-desc {
            font-size: 12px;
            color: var(--text-dim);
            line-height: 1.4;
            word-break: break-word;
        }
        .fb-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 6px;
            font-size: 10px;
        }
        .cat-tag {
            padding: 1px 7px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .cat-tag.apps { background: rgba(110,224,110,0.12); color: var(--accent); }
        .cat-tag.sloppy { background: rgba(224,110,160,0.12); color: var(--pink); }
        .cat-tag.streamer { background: rgba(224,160,64,0.12); color: var(--orange); }
        .cat-tag.general { background: rgba(80,128,224,0.12); color: var(--blue); }
        .fb-time { color: var(--text-muted); }
        .fb-status {
            padding: 1px 6px;
            border-radius: 3px;
            font-size: 9px;
            background: rgba(110,224,110,0.08);
            color: var(--accent-dim);
        }
        .fb-delete {
            background: none;
            border: none;
            color: var(--text-muted);
            font-family: var(--mono);
            font-size: 9px;
            cursor: pointer;
            margin-left: auto;
        }
        .fb-delete:hover { color: var(--red); }

        /* Compose modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.open { display: flex; }
        .modal {
            background: var(--surface);
            border: 1px solid var(--border-active);
            border-radius: 8px;
            padding: 20px;
            width: 90%;
            max-width: 480px;
        }
        .modal h2 {
            font-family: var(--serif);
            font-size: 1.3rem;
            font-weight: 400;
            margin-bottom: 14px;
        }
        .modal label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            display: block;
            margin-bottom: 4px;
            margin-top: 12px;
        }
        .modal input, .modal textarea {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text);
            font-family: var(--mono);
            font-size: 12px;
            padding: 8px 10px;
            outline: none;
        }
        .modal input:focus, .modal textarea:focus { border-color: var(--accent-dim); }
        .modal textarea { min-height: 80px; resize: vertical; }
        .char-count { font-size: 10px; color: var(--text-muted); text-align: right; margin-top: 2px; }
        .cat-select {
            display: flex;
            gap: 4px;
            margin-top: 6px;
        }
        .cat-btn {
            flex: 1;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text-dim);
            font-family: var(--mono);
            font-size: 10px;
            padding: 6px 4px;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            transition: all 0.12s;
        }
        .cat-btn:hover { border-color: var(--border-active); color: var(--text); }
        .cat-btn.active { border-color: var(--accent-dim); color: var(--accent); background: rgba(110,224,110,0.06); }
        .modal-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            justify-content: flex-end;
        }
        .modal-actions button {
            font-family: var(--mono);
            font-size: 12px;
            padding: 7px 16px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--surface-hover);
            color: var(--text-dim);
        }
        .modal-actions button:hover { color: var(--text); border-color: var(--border-active); }
        .modal-actions .submit-btn {
            background: var(--accent-dim);
            border-color: var(--accent-dim);
            color: #fff;
            font-weight: 700;
        }
        .modal-actions .submit-btn:hover { background: var(--accent); color: #000; }

        .backlink { text-align: center; padding: 12px; font-size: 11px; }

        .toast {
            position: fixed; bottom: 60px; left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: var(--surface); border: 1px solid var(--accent-dim);
            color: var(--text); font-family: var(--mono); font-size: 11px;
            padding: 8px 18px; border-radius: 6px; z-index: 200;
            opacity: 0; transition: all 0.3s; pointer-events: none;
        }
        .toast.visible { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* Embed mode */
        body.embed-mode { min-height: auto; }
        body.embed-mode .hdr { display: none; }
        body.embed-mode .backlink { display: none; }
        body.embed-mode .toolbar { padding: 6px 8px; }
        body.embed-mode .feed { padding: 4px 6px 12px; }
        body.embed-mode .sort-row { padding: 4px 8px; }

        @media (max-width: 600px) {
            .hdr h1 { font-size: 1.6rem; }
            .toolbar { gap: 4px; }
            .filter-btn { font-size: 9px; padding: 3px 7px; }
            .cat-select { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <script>
        var IS_EMBED = new URLSearchParams(location.search).has('embed');
        if (IS_EMBED) document.body.classList.add('embed-mode');
    </script>
    <div class="hdr">
        <h1>Sloppy <span>Feedback</span></h1>
        <div class="sub">Ideas &amp; Bug Reports</div>
        <div class="stats-row">
            <div class="stat"><div class="val" id="sIdeas">‚Äî</div><div class="lbl">Ideas</div></div>
            <div class="stat"><div class="val" id="sVotes">‚Äî</div><div class="lbl">Votes</div></div>
            <div class="stat"><div class="val" id="sContrib">‚Äî</div><div class="lbl">Contributors</div></div>
        </div>
    </div>

    <div class="toolbar">
        <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">All</button>
        <button class="filter-btn" data-filter="apps" onclick="setFilter('apps')">Apps</button>
        <button class="filter-btn" data-filter="sloppy" onclick="setFilter('sloppy')">Sloppy/AI</button>
        <button class="filter-btn" data-filter="streamer" onclick="setFilter('streamer')">Streamer</button>
        <button class="filter-btn" data-filter="general" onclick="setFilter('general')">General</button>
        <button class="filter-btn" data-filter="mine" onclick="setFilter('mine')">My Ideas</button>
        <div class="toolbar-right">
            <button class="new-btn" onclick="openModal()">+ New Idea</button>
        </div>
    </div>

    <div class="sort-row">
        <span>Sort:</span>
        <button class="sort-btn active" data-sort="top" onclick="setSort('top')">Top</button>
        <button class="sort-btn" data-sort="newest" onclick="setSort('newest')">Newest</button>
        <button class="sort-btn" data-sort="controversial" onclick="setSort('controversial')">Controversial</button>
    </div>

    <div class="feed" id="feed">
        <div class="feed-loading" id="feedLoading">Loading ideas...</div>
    </div>

    <!-- Compose Modal -->
    <div class="modal-overlay" id="modal">
        <div class="modal">
            <h2>Submit an Idea</h2>
            <label>Title (required)</label>
            <input type="text" id="fbTitle" maxlength="100" placeholder="Short summary of your idea or bug">
            <div class="char-count"><span id="ccTitle">0</span>/100</div>
            <label>Description</label>
            <textarea id="fbDesc" maxlength="500" placeholder="More details..." oninput="document.getElementById('ccDesc').textContent=this.value.length"></textarea>
            <div class="char-count"><span id="ccDesc">0</span>/500</div>
            <label>Category</label>
            <div class="cat-select">
                <button class="cat-btn active" data-cat="apps" onclick="selectCat('apps')">Apps</button>
                <button class="cat-btn" data-cat="sloppy" onclick="selectCat('sloppy')">Sloppy/AI</button>
                <button class="cat-btn" data-cat="streamer" onclick="selectCat('streamer')">Streamer</button>
                <button class="cat-btn" data-cat="general" onclick="selectCat('general')">General</button>
            </div>
            <div class="modal-actions">
                <button onclick="closeModal()">Cancel</button>
                <button class="submit-btn" onclick="submitFeedback()">Submit</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>
    <div class="backlink"><a href="https://sloppy.live">‚Üê sloppy.live</a></div>

    <script src="/apps/sloppy-header/sloppy-bar.js" data-position="bottom" data-minimized="true"></script>
    <script type="module">
        import { createBrowserClient } from "https://cdn.jsdelivr.net/npm/@supabase/ssr@0.7.0/+esm";

        const supabase = createBrowserClient(
            'https://yjyxteqzhhmtrgcaekgz.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM4IS32IUYR2eenCCjdDdioiBU',
            { cookieOptions: { name: 'sb-auth-token', domain: location.hostname.includes('sloppy.live') ? '.sloppy.live' : location.hostname, path: '/', sameSite: 'lax' } }
        );

        window.supabase = supabase;

        let currentUser = null;
        let profile = { username: 'Anonymous' };
        let feedbackData = [];
        let feedbackVotes = {};
        let activeFilter = 'all';
        let activeSort = 'top';
        let selectedCat = 'apps';

        // Rate limiting
        const rateLimits = {};
        function checkRate(action, max, window) {
            const now = Date.now();
            if (!rateLimits[action]) rateLimits[action] = [];
            rateLimits[action] = rateLimits[action].filter(t => now - t < window);
            if (rateLimits[action].length >= max) return false;
            rateLimits[action].push(now);
            return true;
        }

        function escapeHtml(s) { return s ? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;') : ''; }
        function sanitize(str, max = 500) {
            if (!str) return '';
            let s = str.trim().slice(0, max);
            if (/<script|javascript:|on\w+\s*=/i.test(s)) return '';
            return s;
        }
        function timeAgo(d) {
            const s = Math.floor((Date.now() - new Date(d).getTime()) / 1000);
            if (s < 60) return 'now';
            if (s < 3600) return Math.floor(s/60) + 'm';
            if (s < 86400) return Math.floor(s/3600) + 'h';
            if (s < 604800) return Math.floor(s/86400) + 'd';
            return new Date(d).toLocaleDateString();
        }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.classList.add('visible');
            setTimeout(() => t.classList.remove('visible'), 2200);
        }

        // --- Auth ---
        async function initAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            let s = session;
            if (!s) { const { data } = await supabase.auth.signInAnonymously(); s = data?.session; }
            if (s?.user) {
                currentUser = s.user;
                const { data: prof } = await supabase.from('sloppygram_profiles')
                    .select('username').eq('user_id', currentUser.id).single();
                if (prof) profile.username = prof.username || 'Anonymous';
            }
        }

        // --- Load ---
        async function loadFeedback() {
            const [fbR, votesR] = await Promise.all([
                supabase.from('feedback').select('*').order('votes', { ascending: false }),
                currentUser
                    ? supabase.from('feedback_votes').select('feedback_id, vote_type').eq('user_id', currentUser.id)
                    : { data: [] }
            ]);

            feedbackData = fbR.data || [];
            feedbackVotes = {};
            (votesR.data || []).forEach(v => { feedbackVotes[v.feedback_id] = v.vote_type; });

            updateStats();
            renderFeed();
        }

        function updateStats() {
            document.getElementById('sIdeas').textContent = feedbackData.length;
            const totalVotes = feedbackData.reduce((a, f) => a + Math.abs(f.votes || 0), 0);
            document.getElementById('sVotes').textContent = totalVotes;
            const contributors = new Set(feedbackData.map(f => f.user_id)).size;
            document.getElementById('sContrib').textContent = contributors;
        }

        // --- Filter & Sort ---
        window.setFilter = function(f) {
            activeFilter = f;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === f));
            renderFeed();
        };
        window.setSort = function(s) {
            activeSort = s;
            document.querySelectorAll('.sort-btn').forEach(b => b.classList.toggle('active', b.dataset.sort === s));
            renderFeed();
        };

        function getFilteredSorted() {
            let items = [...feedbackData];

            // Filter
            if (activeFilter === 'mine') {
                items = items.filter(f => currentUser && f.user_id === currentUser.id);
            } else if (activeFilter !== 'all') {
                items = items.filter(f => f.category === activeFilter);
            }

            // Sort
            if (activeSort === 'top') {
                items.sort((a, b) => (b.votes || 0) - (a.votes || 0));
            } else if (activeSort === 'newest') {
                items.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            } else if (activeSort === 'controversial') {
                // Items near 0 votes but with activity (approximated by having any votes at all)
                items.sort((a, b) => Math.abs(a.votes || 0) - Math.abs(b.votes || 0));
            }

            return items;
        }

        // --- Render ---
        function renderFeed() {
            const container = document.getElementById('feed');
            document.getElementById('feedLoading').style.display = 'none';
            const items = getFilteredSorted();

            if (items.length === 0) {
                container.innerHTML = '<div class="feed-empty"><div class="icon">üí°</div>No ideas here yet. Submit the first one!</div>';
                return;
            }

            container.innerHTML = items.map(f => renderCard(f)).join('');
        }

        function renderCard(f) {
            const isOwn = currentUser && f.user_id === currentUser.id;
            const myVote = feedbackVotes[f.id] || 0;
            const votes = f.votes || 0;
            const voteClass = votes > 0 ? 'positive' : votes < 0 ? 'negative' : 'neutral';

            return `<div class="fb-card${isOwn ? ' own' : ''}">
                <div class="fb-vote">
                    <button class="vote-btn up${myVote === 1 ? ' active' : ''}" onclick="vote(${f.id}, 1)">‚ñ≤</button>
                    <span class="vote-count ${voteClass}">${votes}</span>
                    <button class="vote-btn down${myVote === -1 ? ' active' : ''}" onclick="vote(${f.id}, -1)">‚ñº</button>
                </div>
                <div class="fb-body">
                    <div class="fb-title">${escapeHtml(f.title)}</div>
                    ${f.description ? `<div class="fb-desc">${escapeHtml(f.description)}</div>` : ''}
                    <div class="fb-meta">
                        <span class="cat-tag ${f.category || 'general'}">${escapeHtml(f.category || 'general')}</span>
                        <span class="fb-status">${escapeHtml(f.status || 'new')}</span>
                        <span class="fb-time">${timeAgo(f.created_at)}</span>
                        ${isOwn ? `<button class="fb-delete" onclick="deleteFb(${f.id})">delete</button>` : ''}
                    </div>
                </div>
            </div>`;
        }

        // --- Vote ---
        window.vote = async function(feedbackId, direction) {
            if (!currentUser) { showToast('Sign in to vote'); return; }
            if (!checkRate('vote', 30, 60000)) { showToast('Slow down on votes'); return; }

            const current = feedbackVotes[feedbackId] || 0;
            const fb = feedbackData.find(f => f.id === feedbackId);
            if (!fb) return;

            if (current === direction) {
                // Remove vote
                await supabase.from('feedback_votes').delete()
                    .eq('feedback_id', feedbackId).eq('user_id', currentUser.id);
                fb.votes = (fb.votes || 0) - direction;
                feedbackVotes[feedbackId] = 0;
            } else {
                // Remove old vote if changing
                if (current !== 0) {
                    await supabase.from('feedback_votes').delete()
                        .eq('feedback_id', feedbackId).eq('user_id', currentUser.id);
                    fb.votes = (fb.votes || 0) - current;
                }
                // Insert new vote
                await supabase.from('feedback_votes').insert({
                    feedback_id: feedbackId, vote_type: direction, user_id: currentUser.id
                });
                fb.votes = (fb.votes || 0) + direction;
                feedbackVotes[feedbackId] = direction;
            }

            // Update feedback table vote count
            await supabase.from('feedback').update({ votes: fb.votes }).eq('id', feedbackId);
            renderFeed();
        };

        // --- Submit ---
        window.openModal = function() {
            if (!currentUser) { showToast('Sign in to submit'); return; }
            document.getElementById('modal').classList.add('open');
        };
        window.closeModal = function() {
            document.getElementById('modal').classList.remove('open');
            document.getElementById('fbTitle').value = '';
            document.getElementById('fbDesc').value = '';
            document.getElementById('ccTitle').textContent = '0';
            document.getElementById('ccDesc').textContent = '0';
            selectedCat = 'apps';
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.toggle('active', b.dataset.cat === 'apps'));
        };
        window.selectCat = function(cat) {
            selectedCat = cat;
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.toggle('active', b.dataset.cat === cat));
        };

        document.getElementById('fbTitle').addEventListener('input', function() {
            document.getElementById('ccTitle').textContent = this.value.length;
        });

        window.submitFeedback = async function() {
            if (!currentUser) return;
            if (!checkRate('submit', 5, 60000)) { showToast('Submitting too fast'); return; }

            const rawTitle = document.getElementById('fbTitle').value.trim();
            const rawDesc = document.getElementById('fbDesc').value.trim();

            if (!rawTitle) { showToast('Title is required'); return; }
            const title = sanitize(rawTitle, 100);
            const description = rawDesc ? sanitize(rawDesc, 500) : null;
            if (!title) { showToast('Invalid content'); return; }

            const { data, error } = await supabase.from('feedback').insert({
                title, description, category: selectedCat,
                votes: 0, status: 'new', user_id: currentUser.id
            }).select().single();

            if (error) { showToast('Failed to submit'); console.error(error); return; }

            feedbackData.unshift(data);
            closeModal();
            showToast('Idea submitted!');
            updateStats();
            renderFeed();
        };

        // --- Delete ---
        window.deleteFb = async function(id) {
            if (!currentUser || !confirm('Delete this idea?')) return;
            const { error } = await supabase.from('feedback').delete().eq('id', id).eq('user_id', currentUser.id);
            if (error) { showToast('Could not delete'); return; }
            feedbackData = feedbackData.filter(f => f.id !== id);
            updateStats();
            renderFeed();
            showToast('Deleted');
        };

        // --- Real-time ---
        function subscribeRealtime() {
            const channel = supabase.channel('sloppy-feedback-rt');

            channel.on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'feedback' }, payload => {
                if (!feedbackData.find(f => f.id === payload.new.id)) {
                    feedbackData.unshift(payload.new);
                    updateStats();
                    renderFeed();
                }
            });

            channel.on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'feedback' }, payload => {
                const idx = feedbackData.findIndex(f => f.id === payload.new.id);
                if (idx >= 0) {
                    feedbackData[idx] = { ...feedbackData[idx], ...payload.new };
                    renderFeed();
                }
            });

            channel.on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'feedback' }, payload => {
                feedbackData = feedbackData.filter(f => f.id !== payload.old.id);
                updateStats();
                renderFeed();
            });

            channel.subscribe();
        }

        // --- Init ---
        async function init() {
            await initAuth();
            await loadFeedback();
            subscribeRealtime();
        }

        init().catch(err => {
            console.error('Init error:', err);
            document.getElementById('feedLoading').textContent = 'Failed to load. Refresh to try again.';
        });

        // Close modal on overlay click
        document.getElementById('modal').addEventListener('click', e => {
            if (e.target === e.currentTarget) closeModal();
        });
    </script>
<script src="/vibelib-extended.js"></script>
<script>
  // Compatibility Patch for Legacy Apps
  window.addEventListener("load", () => {
    if (window.SloppyKarma && window.VibeLib.Economy) {
      // Redirect old calls to new engine
      window.SloppyKarma.track = window.VibeLib.Economy.track;
    }
  });
</script>
</body>
</html>