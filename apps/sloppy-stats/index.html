<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sloppy Stats - Universal Scoreboard</title>
    <link rel="icon" href="https://emojicdn.elk.sh/üèÜ">
    <meta property="og:title" content="Sloppy Stats">
    <meta property="og:description" content="Universal scoreboard across all sloppy.live games">
    <meta property="og:url" content="https://sloppy.live/sloppy-stats">
    <meta property="og:image" content="https://emojicdn.elk.sh/üèÜ?style=google">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Anybody:wght@100;400;800;900&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --gold: #f0c040;
            --gold-dim: #a08020;
            --silver: #c0c8d0;
            --bronze: #cd7f32;
            --bg: #0a0a0f;
            --surface: #12121a;
            --surface2: #1a1a28;
            --border: #2a2a3a;
            --text: #e0e0e8;
            --text-dim: #888898;
            --accent: #f0c040;
            --accent2: #ff6b4a;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'DM Mono', monospace;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Subtle grid bg */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                linear-gradient(90deg, rgba(240,192,64,0.03) 1px, transparent 1px),
                linear-gradient(rgba(240,192,64,0.03) 1px, transparent 1px);
            background-size: 60px 60px;
            pointer-events: none;
            z-index: 0;
        }

        .app { position: relative; z-index: 1; max-width: 1100px; margin: 0 auto; padding: 24px 16px 80px; }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 32px;
            padding: 32px 0 24px;
        }
        .header h1 {
            font-family: 'Anybody', sans-serif;
            font-weight: 900;
            font-size: clamp(2.4rem, 6vw, 4rem);
            color: var(--gold);
            text-shadow: 0 0 40px rgba(240,192,64,0.3);
            letter-spacing: -2px;
            line-height: 1;
        }
        .header .sub {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-top: 8px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        .total-players {
            display: inline-block;
            margin-top: 12px;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 6px 16px;
            font-size: 0.75rem;
            color: var(--text-dim);
        }
        .total-players span { color: var(--gold); font-weight: 500; }

        /* Search */
        .search-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 28px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        .search-bar input {
            flex: 1;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 14px;
            color: var(--text);
            font-family: 'DM Mono', monospace;
            font-size: 0.85rem;
            outline: none;
            transition: border-color 0.2s;
        }
        .search-bar input:focus { border-color: var(--gold); }
        .search-bar input::placeholder { color: var(--text-dim); }
        .search-bar button {
            background: var(--gold);
            color: var(--bg);
            border: none;
            border-radius: 8px;
            padding: 10px 18px;
            font-family: 'DM Mono', monospace;
            font-weight: 500;
            cursor: pointer;
            font-size: 0.85rem;
            transition: opacity 0.2s;
        }
        .search-bar button:hover { opacity: 0.85; }

        /* Player card */
        .player-card {
            display: none;
            background: var(--surface);
            border: 1px solid var(--gold-dim);
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 28px;
            animation: slideIn 0.3s ease;
        }
        .player-card.visible { display: block; }
        .player-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        .player-card-name {
            font-family: 'Anybody', sans-serif;
            font-weight: 800;
            font-size: 1.4rem;
            color: var(--gold);
        }
        .player-card-summary {
            font-size: 0.75rem;
            color: var(--text-dim);
        }
        .player-card-summary span { color: var(--accent2); font-weight: 500; }
        .player-scores {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        .player-score-item {
            background: var(--surface2);
            border-radius: 8px;
            padding: 10px 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .player-score-game { font-size: 0.75rem; color: var(--text-dim); }
        .player-score-val { font-weight: 500; color: var(--text); font-size: 0.9rem; }
        .player-card-close {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 4px 8px;
        }

        /* View toggle */
        .view-toggle {
            display: flex;
            gap: 4px;
            justify-content: center;
            margin-bottom: 24px;
        }
        .view-btn {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'DM Mono', monospace;
            font-size: 0.75rem;
            transition: all 0.2s;
        }
        .view-btn.active {
            background: var(--gold);
            color: var(--bg);
            border-color: var(--gold);
            font-weight: 500;
        }

        /* Game grid */
        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
        }

        .game-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            transition: border-color 0.2s;
        }
        .game-card:hover { border-color: var(--gold-dim); }
        .game-card-head {
            padding: 14px 18px 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
        }
        .game-card-title {
            font-family: 'Anybody', sans-serif;
            font-weight: 800;
            font-size: 1rem;
            color: var(--text);
        }
        .game-card-count {
            font-size: 0.65rem;
            color: var(--text-dim);
            background: var(--surface2);
            padding: 3px 8px;
            border-radius: 10px;
        }
        .game-card-body { padding: 0; }

        .lb-row {
            display: flex;
            align-items: center;
            padding: 8px 18px;
            gap: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            transition: background 0.15s;
            cursor: pointer;
        }
        .lb-row:hover { background: rgba(240,192,64,0.05); }
        .lb-row:last-child { border-bottom: none; }

        .lb-rank {
            width: 24px;
            text-align: center;
            font-weight: 500;
            font-size: 0.8rem;
        }
        .lb-rank.gold { color: var(--gold); }
        .lb-rank.silver { color: var(--silver); }
        .lb-rank.bronze { color: var(--bronze); }

        .lb-name {
            flex: 1;
            font-size: 0.8rem;
            color: var(--text);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .lb-score {
            font-weight: 500;
            font-size: 0.85rem;
            color: var(--gold);
            font-variant-numeric: tabular-nums;
        }
        .lb-detail {
            font-size: 0.65rem;
            color: var(--text-dim);
            margin-left: 4px;
        }

        .game-card-empty {
            padding: 20px;
            text-align: center;
            color: var(--text-dim);
            font-size: 0.75rem;
        }

        /* All-time rankings */
        .rankings-table {
            display: none;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }
        .rankings-table.visible { display: block; }
        .rankings-header {
            display: grid;
            grid-template-columns: 50px 1fr 80px 60px;
            padding: 12px 18px;
            border-bottom: 1px solid var(--border);
            font-size: 0.65rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .rankings-row {
            display: grid;
            grid-template-columns: 50px 1fr 80px 60px;
            padding: 10px 18px;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            cursor: pointer;
            transition: background 0.15s;
        }
        .rankings-row:hover { background: rgba(240,192,64,0.05); }
        .rankings-row .rank { font-weight: 500; font-size: 0.85rem; }
        .rankings-row .rank.gold { color: var(--gold); }
        .rankings-row .rank.silver { color: var(--silver); }
        .rankings-row .rank.bronze { color: var(--bronze); }
        .rankings-row .name { font-size: 0.8rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .rankings-row .score { font-weight: 500; color: var(--gold); font-size: 0.85rem; text-align: right; }
        .rankings-row .games { font-size: 0.75rem; color: var(--text-dim); text-align: right; }

        .loading-spinner {
            display: flex;
            justify-content: center;
            padding: 40px;
        }
        .loading-spinner::after {
            content: '';
            width: 28px; height: 28px;
            border: 2px solid var(--border);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .backlink {
            text-align: center;
            margin-top: 32px;
            font-size: 0.7rem;
        }
        .backlink a {
            color: var(--text-dim);
            text-decoration: none;
            transition: color 0.2s;
        }
        .backlink a:hover { color: var(--gold); }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 700px) {
            .games-grid { grid-template-columns: 1fr; }
            .player-scores { grid-template-columns: 1fr; }
            .rankings-header, .rankings-row {
                grid-template-columns: 40px 1fr 70px 50px;
                padding: 10px 12px;
            }
        }
    </style>
<script>
(function(){var Q=[],N=0,MAX=10;function send(e){var sb=window.supabase;if(!sb){Q.push(e);return;}if(N>=MAX)return;N++;sb.auth.getSession().then(function(r){var u=r&&r.data&&r.data.session&&r.data.session.user;if(!u)return;sb.from('ai_events').insert({event_type:'client_error',entity_type:'app',entity_id:u.id,username:location.pathname.split('/').filter(Boolean)[0]||'unknown',metadata:e,user_id:u.id}).then(function(){});}).catch(function(){});}window.onerror=function(m,s,l,c,e){send({type:'error',msg:String(m).slice(0,500),src:s||'',line:l,col:c,stack:e?String(e.stack).slice(0,1000):''});};window.addEventListener('unhandledrejection',function(ev){var r=ev.reason;send({type:'promise',msg:String(r&&r.message||r).slice(0,500),stack:r?String(r.stack||'').slice(0,1000):''});});var fi=setInterval(function(){if(window.supabase){Q.splice(0).forEach(send);clearInterval(fi);}},1000);setTimeout(function(){clearInterval(fi);},30000);})();
</script>
</head>
<body>
    <div class="app">
        <div class="header">
            <h1>SLOPPY STATS</h1>
            <div class="sub">Universal Scoreboard</div>
            <div class="total-players">Loading scores...</div>
        </div>

        <div class="search-bar">
            <input type="text" id="playerSearch" placeholder="Search player..." maxlength="40">
            <button onclick="searchPlayer()">Look up</button>
        </div>

        <div class="player-card" id="playerCard">
            <div class="player-card-header">
                <div class="player-card-name" id="pcName"></div>
                <button class="player-card-close" onclick="closePlayerCard()">‚úï</button>
            </div>
            <div class="player-card-summary" id="pcSummary"></div>
            <div class="player-scores" id="pcScores"></div>
        </div>

        <div class="view-toggle">
            <button class="view-btn active" data-view="games" onclick="switchView('games')">Per Game</button>
            <button class="view-btn" data-view="rankings" onclick="switchView('rankings')">All-Time Rankings</button>
        </div>

        <div class="games-grid" id="gamesGrid"></div>

        <div class="rankings-table" id="rankingsTable">
            <div class="rankings-header">
                <div>#</div>
                <div>Player</div>
                <div>Best Score</div>
                <div>Games</div>
            </div>
            <div id="rankingsBody"></div>
        </div>

        <div class="backlink">
            <a href="https://sloppy.live">‚Üê sloppy.live</a>
        </div>
    </div>

    <script src="/sloppy-header/sloppy-bar.js" data-position="bottom"></script>
    <script type="module">
        import { createBrowserClient } from "https://cdn.jsdelivr.net/npm/@supabase/ssr@0.7.0/+esm";

        const SUPABASE_URL = 'https://yjyxteqzhhmtrgcaekgz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM8IS32IUYR2eenCCjdDdioiBU';

        const supabase = createBrowserClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            cookieOptions: { name: 'sb-auth-token', domain: location.hostname.includes('sloppy.live') ? '.sloppy.live' : location.hostname, path: '/', sameSite: 'lax' }
        });

        // Game definitions: table, nameCol, scoreCol, label, extra details
        const GAMES = [
            { table: 'breakout_terminal_scores', nameCol: 'display_name', scoreCol: 'score', label: 'Breakout Terminal', extra: 'level', icon: 'üß±' },
            { table: 'icy_tower_scores', nameCol: 'display_name', scoreCol: 'score', label: 'Icy Tower', icon: 'üèîÔ∏è' },
            { table: 'tetris_leaderboard', nameCol: 'name', scoreCol: 'score', label: 'Neon Tetris', extra: 'lines', icon: 'üü¶' },
            { table: 'star_catcher_leaderboard', nameCol: 'player_name', scoreCol: 'score', label: 'Star Catcher', extra: 'stars_caught', icon: '‚≠ê' },
            { table: 'sea_scourge_leaderboard', nameCol: 'name', scoreCol: 'score', label: 'Sea Scourge', extra: 'wave', icon: 'üè¥‚Äç‚ò†Ô∏è' },
            { table: 'laptop_fire_scores', nameCol: 'display_name', scoreCol: 'score', label: 'Laptop Fire', extra: 'level_reached', icon: 'üî•' },
            { table: 'lighthouse_scores', nameCol: 'player_name', scoreCol: 'survival_time', label: 'Lighthouse Keeper', extra: 'fog_destroyed', icon: 'üè†' },
            { table: 'simpsons_road_rage_scores', nameCol: 'name', scoreCol: 'score', label: 'Road Rage', icon: 'üöó' },
            { table: 'toiletrun_leaderboard', nameCol: 'username', scoreCol: 'score', label: 'Toilet Run', icon: 'üöΩ' },
            { table: 'treasure_calculator_scores', nameCol: 'player_name', scoreCol: 'score', label: 'Treasure Calc', extra: 'streak_best', icon: 'üíé' },
            { table: 'sloppys_gift_leaderboard', nameCol: 'username', scoreCol: 'total_score', label: "Sloppy's Gift", extra: 'rarity', icon: 'üéÅ' },
        ];

        let allData = {}; // table -> rows
        let allPlayers = {}; // name -> { games: { label: { score, extra } }, bestScore, gameCount }

        async function init() {
            // Auth
            const sessRes = await supabase.auth.getSession();
            if (!sessRes.data.session) await supabase.auth.signInAnonymously();

            // Fetch all games in parallel
            const results = await Promise.all(
                GAMES.map(g => {
                    let select = `${g.nameCol}, ${g.scoreCol}`;
                    if (g.extra) select += `, ${g.extra}`;
                    return supabase.from(g.table).select(select).order(g.scoreCol, { ascending: false }).limit(100);
                })
            );

            let totalEntries = 0;
            const uniquePlayers = new Set();

            GAMES.forEach((g, i) => {
                const rows = results[i].data || [];
                allData[g.table] = rows;
                totalEntries += rows.length;

                rows.forEach(r => {
                    const name = (r[g.nameCol] || 'Anonymous').trim();
                    if (!name) return;
                    const nameLower = name.toLowerCase();
                    uniquePlayers.add(nameLower);

                    if (!allPlayers[nameLower]) {
                        allPlayers[nameLower] = { displayName: name, games: {}, bestScore: 0, gameCount: 0 };
                    }
                    const score = r[g.scoreCol] || 0;
                    const existing = allPlayers[nameLower].games[g.label];
                    if (!existing || score > existing.score) {
                        if (!existing) allPlayers[nameLower].gameCount++;
                        allPlayers[nameLower].games[g.label] = {
                            score,
                            extra: g.extra ? r[g.extra] : null,
                            extraLabel: g.extra
                        };
                        if (score > allPlayers[nameLower].bestScore) {
                            allPlayers[nameLower].bestScore = score;
                        }
                    }
                });
            });

            document.querySelector('.total-players').innerHTML =
                `<span>${uniquePlayers.size}</span> players across <span>${GAMES.length}</span> games ¬∑ <span>${totalEntries.toLocaleString()}</span> scores`;

            renderGameCards();
            renderRankings();
        }

        function renderGameCards() {
            const grid = document.getElementById('gamesGrid');
            grid.innerHTML = '';

            GAMES.forEach(g => {
                const rows = allData[g.table] || [];
                const card = document.createElement('div');
                card.className = 'game-card';

                const top10 = [];
                const seen = new Set();
                for (const r of rows) {
                    const name = (r[g.nameCol] || 'Anonymous').trim();
                    const key = name.toLowerCase();
                    if (seen.has(key)) continue;
                    seen.add(key);
                    top10.push({ name, score: r[g.scoreCol] || 0, extra: g.extra ? r[g.extra] : null });
                    if (top10.length >= 10) break;
                }

                let rowsHtml = '';
                if (top10.length === 0) {
                    rowsHtml = '<div class="game-card-empty">No scores yet</div>';
                } else {
                    top10.forEach((entry, idx) => {
                        const rankClass = idx === 0 ? 'gold' : idx === 1 ? 'silver' : idx === 2 ? 'bronze' : '';
                        const extraHtml = entry.extra != null ? `<span class="lb-detail">${g.extra}: ${entry.extra}</span>` : '';
                        rowsHtml += `
                            <div class="lb-row" onclick="window._searchPlayer('${entry.name.replace(/'/g, "\\'")}')">
                                <div class="lb-rank ${rankClass}">${idx + 1}</div>
                                <div class="lb-name">${escapeHtml(entry.name)}</div>
                                <div class="lb-score">${entry.score.toLocaleString()}</div>
                                ${extraHtml}
                            </div>`;
                    });
                }

                card.innerHTML = `
                    <div class="game-card-head">
                        <div class="game-card-title">${g.icon} ${g.label}</div>
                        <div class="game-card-count">${rows.length} scores</div>
                    </div>
                    <div class="game-card-body">${rowsHtml}</div>
                `;
                grid.appendChild(card);
            });
        }

        function renderRankings() {
            const body = document.getElementById('rankingsBody');
            const sorted = Object.values(allPlayers).sort((a, b) => {
                if (b.gameCount !== a.gameCount) return b.gameCount - a.gameCount;
                return b.bestScore - a.bestScore;
            });

            body.innerHTML = sorted.slice(0, 50).map((p, i) => {
                const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
                return `
                    <div class="rankings-row" onclick="window._searchPlayer('${p.displayName.replace(/'/g, "\\'")}')">
                        <div class="rank ${rankClass}">${i + 1}</div>
                        <div class="name">${escapeHtml(p.displayName)}</div>
                        <div class="score">${p.bestScore.toLocaleString()}</div>
                        <div class="games">${p.gameCount}</div>
                    </div>`;
            }).join('');
        }

        function escapeHtml(str) {
            const d = document.createElement('div');
            d.textContent = str;
            return d.innerHTML;
        }

        // Player search + card
        window.searchPlayer = function() {
            const q = document.getElementById('playerSearch').value.trim().toLowerCase();
            if (!q) return;
            const player = allPlayers[q];
            if (!player) {
                // Fuzzy search - find partial matches
                const matches = Object.keys(allPlayers).filter(k => k.includes(q));
                if (matches.length > 0) {
                    showPlayerCard(allPlayers[matches[0]]);
                } else {
                    const card = document.getElementById('playerCard');
                    card.classList.add('visible');
                    document.getElementById('pcName').textContent = 'Not Found';
                    document.getElementById('pcSummary').innerHTML = `No scores found for "${escapeHtml(q)}"`;
                    document.getElementById('pcScores').innerHTML = '';
                }
                return;
            }
            showPlayerCard(player);
        };

        window._searchPlayer = function(name) {
            document.getElementById('playerSearch').value = name;
            const player = allPlayers[name.toLowerCase()];
            if (player) showPlayerCard(player);
        };

        function showPlayerCard(player) {
            const card = document.getElementById('playerCard');
            card.classList.add('visible');
            document.getElementById('pcName').textContent = player.displayName;

            const totalScore = Object.values(player.games).reduce((s, g) => s + g.score, 0);
            document.getElementById('pcSummary').innerHTML =
                `<span>${player.gameCount}</span> games played ¬∑ <span>${totalScore.toLocaleString()}</span> total score`;

            const scoresEl = document.getElementById('pcScores');
            scoresEl.innerHTML = Object.entries(player.games)
                .sort((a, b) => b[1].score - a[1].score)
                .map(([label, data]) => {
                    const extraStr = data.extra != null ? ` <span style="color:var(--text-dim);font-size:0.65rem">(${data.extraLabel}: ${data.extra})</span>` : '';
                    return `<div class="player-score-item">
                        <div class="player-score-game">${label}</div>
                        <div class="player-score-val">${data.score.toLocaleString()}${extraStr}</div>
                    </div>`;
                }).join('');

            card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        window.closePlayerCard = function() {
            document.getElementById('playerCard').classList.remove('visible');
        };

        window.switchView = function(view) {
            document.querySelectorAll('.view-btn').forEach(b => b.classList.toggle('active', b.dataset.view === view));
            document.getElementById('gamesGrid').style.display = view === 'games' ? 'grid' : 'none';
            document.getElementById('rankingsTable').classList.toggle('visible', view === 'rankings');
        };

        // Enter key search
        document.getElementById('playerSearch').addEventListener('keydown', e => {
            if (e.key === 'Enter') window.searchPlayer();
        });

        init();
    </script>
</body>
</html>
