<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Aurora Lab — Sculpt Light & Sound</title>

    <meta name="description" content="Paint cinematic lightfields with music you conduct live. Share your vibe with one click." />
    <meta property="og:title" content="Aurora Lab — Sculpt Light & Sound" />
    <meta property="og:description" content="Paint cinematic lightfields with music you conduct live. Share your vibe with one click." />
    <meta property="og:image" content="./og.png" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Aurora Lab — Sculpt Light & Sound" />
    <meta name="twitter:description" content="Paint cinematic lightfields with music you conduct live. Share your vibe with one click." />
    <meta name="twitter:image" content="./og.png" />
    <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="0.82em" font-size="84">✨</text></svg>' />

    <style>
      @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;700&display=swap');
      :root {
        --bg: #04080f;
        --bg-secondary: #0c1424;
        --panel: rgba(11, 20, 35, 0.76);
        --panel-border: rgba(111, 255, 244, 0.18);
        --ink: #ecf8ff;
        --muted: #9fb4cd;
        --accent: #70f7ff;
        --accent-soft: rgba(112, 247, 255, 0.4);
        --danger: #ff6b9a;
        --shadow: 0 30px 120px rgba(0, 0, 0, 0.45);
        color-scheme: dark;
      }

      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        font-family: "Space Grotesk", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: var(--ink);
        background: radial-gradient(circle at 20% -10%, rgba(112,247,255,0.25), transparent 52%),
                    radial-gradient(circle at 80% 0%, rgba(255,104,221,0.2), transparent 55%),
                    var(--bg);
        overflow: hidden;
        display: grid;
        place-items: center;
      }

      canvas#scene {
        position: fixed;
        inset: 0;
        width: 100vw;
        height: 100vh;
        z-index: 0;
        background: transparent;
      }

      .overlay {
        position: relative;
        z-index: 1;
        width: min(1200px, 94vw);
        display: grid;
        gap: 18px;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        align-items: start;
      }

      header {
        grid-column: 1 / -1;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
        padding: 18px 22px;
        background: var(--panel);
        border: 1px solid var(--panel-border);
        border-radius: 20px;
        backdrop-filter: blur(16px);
        box-shadow: var(--shadow);
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 14px;
        font-weight: 700;
        font-size: clamp(20px, 3vw, 30px);
      }

      .brand .logo {
        width: 46px;
        height: 46px;
        border-radius: 16px;
        display: grid;
        place-items: center;
        background: linear-gradient(135deg, rgba(112,247,255,0.8), rgba(255,104,221,0.8));
        box-shadow: 0 12px 30px rgba(112, 247, 255, 0.25);
        font-size: 24px;
      }

      .status {
        display: flex;
        gap: 10px;
        align-items: center;
        font-size: 15px;
      }

      .status .pill {
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,0.1);
        background: rgba(10, 24, 35, 0.6);
        color: var(--muted);
      }

      .panel {
        padding: 20px;
        background: var(--panel);
        border: 1px solid var(--panel-border);
        border-radius: 20px;
        backdrop-filter: blur(18px);
        box-shadow: var(--shadow);
      }

      .panel h2 {
        margin-top: 0;
        margin-bottom: 14px;
        font-size: 20px;
        letter-spacing: 0.02em;
      }

      .controls { display: grid; gap: 14px; }
      .control {
        display: grid;
        gap: 10px;
      }
      .control label {
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--muted);
      }
      .control select,
      .control input[type="range"] {
        width: 100%;
        appearance: none;
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.12);
        background: rgba(6, 14, 24, 0.6);
        color: var(--ink);
        padding: 10px 14px;
        font-size: 15px;
      }

      input[type="range"] {
        height: 4px;
        padding: 0;
        background: linear-gradient(90deg, var(--accent), rgba(255,255,255,0.12));
        outline: none;
      }
      input[type="range"]::-webkit-slider-thumb {
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--ink);
        border: 2px solid var(--accent);
        box-shadow: 0 0 0 6px rgba(112,247,255,0.25);
        cursor: pointer;
      }
      input[type="range"]::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--ink);
        border: 2px solid var(--accent);
        box-shadow: 0 0 0 6px rgba(112,247,255,0.25);
        cursor: pointer;
      }

      .button-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      button {
        border: 1px solid rgba(255,255,255,0.16);
        border-radius: 999px;
        padding: 12px 20px;
        background: rgba(10, 18, 32, 0.8);
        color: var(--ink);
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 160ms ease, box-shadow 160ms ease;
      }
      button.primary {
        background: linear-gradient(135deg, rgba(112,247,255,0.85), rgba(255,104,221,0.85));
        border-color: rgba(255,255,255,0.35);
        color: #04141f;
        box-shadow: 0 14px 36px rgba(112, 247, 255, 0.38);
      }
      button:disabled {
        cursor: not-allowed;
        opacity: 0.4;
        box-shadow: none;
      }
      button:not(:disabled):hover {
        transform: translateY(-2px);
        box-shadow: 0 16px 32px rgba(112, 247, 255, 0.28);
      }

      .share-card {
        display: grid;
        gap: 14px;
      }

      .share-card textarea {
        width: 100%;
        min-height: 90px;
        resize: none;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,0.12);
        background: rgba(6, 14, 24, 0.6);
        color: var(--ink);
        padding: 14px;
        font-size: 14px;
      }

      .snapshot {
        border-radius: 18px;
        overflow: hidden;
        border: 1px solid rgba(255,255,255,0.12);
        background: rgba(6, 14, 24, 0.6);
        display: none;
        flex-direction: column;
        gap: 12px;
        padding: 16px;
      }

      .snapshot img {
        width: 100%;
        border-radius: 12px;
      }

      .snapshot .meta {
        font-size: 13px;
        color: var(--muted);
      }

      footer {
        grid-column: 1 / -1;
        text-align: center;
        font-size: 14px;
        color: var(--muted);
        padding-bottom: 18px;
      }

      footer a { color: var(--accent); text-decoration: none; }

      .premium-banner {
        display: none;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        padding: 12px;
        border-radius: 14px;
        background: rgba(255, 162, 239, 0.12);
        border: 1px solid rgba(255, 162, 239, 0.28);
      }
      .premium-banner strong { color: #ffd6fb; }

      .premium-badge {
        display: none;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(255, 221, 112, 0.18);
        border: 1px solid rgba(255, 221, 112, 0.3);
        font-size: 12px;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: #ffeaa7;
      }

      @media (max-width: 768px) {
        .overlay { gap: 14px; }
        header { flex-direction: column; align-items: flex-start; gap: 10px; }
        .button-row { justify-content: flex-start; }
      }

      @supports (padding: max(0px)) {
        body { padding-bottom: max(env(safe-area-inset-bottom), 20px); }
      }
    </style>
  </head>
  <body>
    <canvas id="scene" aria-hidden="true"></canvas>
    <div class="overlay">
      <header>
        <div class="brand">
          <div class="logo">⚡️</div>
          <div>
            <div>Aurora Lab</div>
            <small style="display:block; font-size:13px; color:var(--muted); letter-spacing:0.12em; text-transform:uppercase;">Realtime Lightfield Composer</small>
          </div>
        </div>
        <div class="status">
          <div class="premium-badge" id="premiumBadge"><span>✨</span><span>Premium</span></div>
          <div class="pill" id="userPill">Connecting…</div>
        </div>
      </header>

      <section class="panel">
        <h2>Control Deck</h2>
        <div class="controls">
          <div class="control">
            <label for="palette">Palette</label>
            <select id="palette" autocomplete="off"></select>
          </div>
          <div class="control">
            <label for="energy">Energy</label>
            <input type="range" id="energy" min="0" max="1" step="0.01" value="0.6" />
          </div>
          <div class="control">
            <label for="orbit">Orbit</label>
            <input type="range" id="orbit" min="0" max="1" step="0.01" value="0.5" />
          </div>
          <div class="control">
            <label for="trail">Echo Trail</label>
            <input type="range" id="trail" min="0.05" max="0.9" step="0.01" value="0.35" />
          </div>
          <div class="button-row">
            <button id="pulse" class="primary">Pulse the Field</button>
            <button id="sound">Start Soundtrack</button>
            <button id="reset">Reset</button>
          </div>
        </div>
      </section>

      <section class="panel share-card">
        <h2>Share the Vibe</h2>
        <div class="control">
          <label for="shareLink">Direct Link</label>
          <textarea id="shareLink" readonly></textarea>
        </div>
        <div class="button-row">
          <button id="copyLink">Copy Link</button>
          <button id="capture">Capture Frame</button>
          <button id="export4k" disabled>Premium 4K Capture</button>
        </div>
        <div class="premium-banner" id="premiumUpsell">
          <span>🌟</span>
          <span>Unlock celestial palettes and 4K captures when you go <strong>Premium</strong>.</span>
        </div>
        <div class="snapshot" id="snapshot">
          <img id="snapshotImage" alt="Captured lightfield snapshot" loading="lazy" />
          <div class="meta" id="snapshotMeta"></div>
          <button id="downloadSnapshot">Download PNG</button>
        </div>
      </section>

      <footer>
        <span>Crafted live on the stream • </span>
        <a href="https://www.vibecodedbyx.com" target="_blank" rel="noopener">Back to the livestream</a>
      </footer>
    </div>

    <!-- Ghost nodes for shared Supabase helper -->
    <div id="premium-content" style="display:none"></div>
    <div id="upgrade-button" style="display:none"></div>

    <script type="module">
      import supabase, { supabaseSession, isUserPremium } from './supabase-config.js';

      const canvas = document.getElementById('scene');
      const ctx = canvas.getContext('2d', { alpha: true });
      let width = 0, height = 0, dpr = Math.min(window.devicePixelRatio || 1, 2.5);

      const els = {
        palette: document.getElementById('palette'),
        energy: document.getElementById('energy'),
        orbit: document.getElementById('orbit'),
        trail: document.getElementById('trail'),
        pulse: document.getElementById('pulse'),
        sound: document.getElementById('sound'),
        reset: document.getElementById('reset'),
        shareLink: document.getElementById('shareLink'),
        copyLink: document.getElementById('copyLink'),
        capture: document.getElementById('capture'),
        export4k: document.getElementById('export4k'),
        snapshot: document.getElementById('snapshot'),
        snapshotImg: document.getElementById('snapshotImage'),
        snapshotMeta: document.getElementById('snapshotMeta'),
        downloadSnapshot: document.getElementById('downloadSnapshot'),
        premiumUpsell: document.getElementById('premiumUpsell'),
        premiumBadge: document.getElementById('premiumBadge'),
        userPill: document.getElementById('userPill'),
      };

      const palettes = [
        {
          id: 'aurora',
          name: 'Aurora Surge',
          premium: false,
          fog: '#04080f',
          ramp: ['#70f7ff', '#63ffa7', '#ff68dd'],
          sparks: ['#a5fff9', '#5dffda', '#ffe1ff'],
        },
        {
          id: 'ember',
          name: 'Sunset Ember',
          premium: false,
          fog: '#110700',
          ramp: ['#ff9c6f', '#ffd16f', '#ff6fae'],
          sparks: ['#ffe0b8', '#ffb6a5', '#ffc7f5'],
        },
        {
          id: 'prism',
          name: 'Prism Bloom',
          premium: false,
          fog: '#01030a',
          ramp: ['#6ab1ff', '#8a79ff', '#fb6bff'],
          sparks: ['#bfe0ff', '#d2c4ff', '#ffc8ff'],
        },
        {
          id: 'celestial',
          name: 'Celestial Vault',
          premium: true,
          fog: '#050013',
          ramp: ['#7b7dff', '#52f2ff', '#c8fffd'],
          sparks: ['#dcdcff', '#9ef7ff', '#fff8d8'],
        },
      ];

      const state = {
        palette: 'aurora',
        energy: parseFloat(els.energy.value),
        orbit: parseFloat(els.orbit.value),
        trail: parseFloat(els.trail.value),
        pulse: false,
        pulseUntil: 0,
        pointer: { x: 0.5, y: 0.5 },
        premium: false,
        user: null,
        audio: { context: null, gain: null, timer: null, playing: false },
        nodes: [],
        lastTime: 0,
      };

      function hexToRgba(hex, alpha) {
        const parsed = hex.replace('#', '');
        const bigint = parseInt(parsed, 16);
        const size = parsed.length === 3 ? 4 : 8;
        let r, g, b;
        if (parsed.length === 3) {
          r = ((bigint >> 8) & 0xf) * 17;
          g = ((bigint >> 4) & 0xf) * 17;
          b = (bigint & 0xf) * 17;
        } else {
          r = (bigint >> 16) & 255;
          g = (bigint >> 8) & 255;
          b = bigint & 255;
        }
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      }

      function resize() {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = Math.floor(width * dpr);
        canvas.height = Math.floor(height * dpr);
        canvas.style.width = width + 'px';
        canvas.style.height = height + 'px';
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.scale(dpr, dpr);
      }

      function createNode() {
        const radius = (Math.random() ** 1.4) * Math.min(width, height) * 0.45 + 40;
        const angle = Math.random() * Math.PI * 2;
        return {
          angle,
          baseRadius: radius,
          travel: radius * (0.18 + Math.random() * 0.4),
          speed: (0.0002 + Math.random() * 0.0006),
          hueShift: Math.random(),
          size: 2 + Math.random() * 4,
          spark: Math.random() > 0.55,
        };
      }

      function rebuildNodes() {
        const count = Math.floor(150 + state.energy * 100);
        state.nodes = Array.from({ length: count }, createNode);
      }

      function getPalette(id) {
        return palettes.find(p => p.id === id) || palettes[0];
      }

      function applyPalette(id) {
        const palette = getPalette(id);
        document.documentElement.style.setProperty('--bg', palette.fog);
        document.documentElement.style.setProperty('--accent', palette.ramp[0]);
        document.documentElement.style.setProperty('--panel-border', 'rgba(112,247,255,0.18)');
        canvas.style.background = `radial-gradient(circle at 50% 8%, ${hexToRgba(palette.ramp[0], 0.14)}, transparent 60%)`;
      }

      function updateShareURL() {
        const params = new URLSearchParams();
        params.set('palette', state.palette);
        params.set('energy', state.energy.toFixed(2));
        params.set('orbit', state.orbit.toFixed(2));
        params.set('trail', state.trail.toFixed(2));
        const url = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
        els.shareLink.value = url;
        history.replaceState(null, '', `?${params.toString()}`);
      }

      function deserializeState() {
        const params = new URLSearchParams(window.location.search);
        const paletteId = params.get('palette');
        if (paletteId) {
          const palette = getPalette(paletteId);
          if (palette && (!palette.premium || state.premium)) state.palette = palette.id;
        }
        if (params.has('energy')) state.energy = clamp(parseFloat(params.get('energy')), 0, 1);
        if (params.has('orbit')) state.orbit = clamp(parseFloat(params.get('orbit')), 0, 1);
        if (params.has('trail')) state.trail = clamp(parseFloat(params.get('trail')), 0.05, 0.9);
      }

      function clamp(value, min, max) {
        if (Number.isNaN(value)) return min;
        return Math.min(Math.max(value, min), max);
      }

      function populatePaletteSelect() {
        els.palette.innerHTML = palettes.map(p => {
          const disabled = p.premium && !state.premium ? 'disabled' : '';
          const tag = p.premium ? ' data-tag="premium"' : '';
          return `<option value="${p.id}" ${disabled}${tag}>${p.name}${p.premium ? ' ★' : ''}</option>`;
        }).join('');
        els.palette.value = state.palette;
      }

      function setPremiumUI() {
        if (state.premium) {
          els.premiumBadge.style.display = 'inline-flex';
          els.premiumUpsell.style.display = 'none';
          els.export4k.disabled = false;
        } else {
          els.premiumBadge.style.display = 'none';
          els.premiumUpsell.style.display = 'flex';
          els.export4k.disabled = true;
        }
      }

      function pulseField() {
        state.pulse = true;
        state.pulseUntil = performance.now() + 3200;
      }

      function animate(now) {
        if (!state.lastTime) state.lastTime = now;
        const dt = now - state.lastTime;
        state.lastTime = now;

        const palette = getPalette(state.palette);
        const fadeStrength = clamp(1 - state.trail, 0.05, 0.8);
        ctx.fillStyle = hexToRgba(palette.fog, fadeStrength);
        ctx.fillRect(0, 0, width, height);

        const pulseBoost = state.pulse ? Math.max(0, Math.min(1, (state.pulseUntil - now) / 3200)) : 0;
        if (pulseBoost === 0) state.pulse = false;
        const energy = state.energy + pulseBoost * 0.45;
        const orbitFactor = 0.75 + state.orbit * 1.2;

        ctx.save();
        ctx.translate(width / 2, height / 2);
        ctx.globalCompositeOperation = 'lighter';

        const pointerOffsetX = (state.pointer.x - 0.5) * 140;
        const pointerOffsetY = (state.pointer.y - 0.5) * 120;

        state.nodes.forEach(node => {
          node.angle += node.speed * dt * (0.5 + energy * 2.2);
          const dynamicRadius = node.baseRadius + Math.sin(now * 0.0002 + node.hueShift * 6) * node.travel * energy;
          const x = Math.cos(node.angle * orbitFactor) * dynamicRadius + pointerOffsetX;
          const y = Math.sin(node.angle) * dynamicRadius * (0.66 + state.orbit * 0.4) + pointerOffsetY;
          node.x = x;
          node.y = y;

          const size = node.size + energy * 6 + pulseBoost * 10;
          const colorIndex = Math.floor(node.hueShift * palette.ramp.length) % palette.ramp.length;
          const fill = palette.ramp[colorIndex];
          const gradient = ctx.createRadialGradient(x, y, 0, x, y, size * 2.2);
          gradient.addColorStop(0, hexToRgba(fill, 0.9));
          gradient.addColorStop(1, hexToRgba(fill, 0));

          ctx.fillStyle = gradient;
          ctx.beginPath();
          ctx.arc(x, y, size, 0, Math.PI * 2);
          ctx.fill();

          if (node.spark && Math.random() < energy * 0.08) {
            const sparkColor = palette.sparks[Math.floor(Math.random() * palette.sparks.length)];
            ctx.fillStyle = hexToRgba(sparkColor, 0.8);
            ctx.fillRect(x - 1, y - 1, 2, 2);
          }
        });

        // draw connective tissue
        const linkThreshold = 120 + energy * 120;
        ctx.lineWidth = 0.6 + energy * 1.6;
        for (let i = 0; i < state.nodes.length; i++) {
          const a = state.nodes[i];
          for (let j = i + 1; j < Math.min(i + 12, state.nodes.length); j++) {
            const b = state.nodes[j];
            const dx = a.x - b.x;
            const dy = a.y - b.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < linkThreshold) {
              const strength = 1 - dist / linkThreshold;
              const color = palette.ramp[(i + j) % palette.ramp.length];
              ctx.strokeStyle = hexToRgba(color, strength * 0.5 * (0.4 + energy));
              ctx.beginPath();
              ctx.moveTo(a.x, a.y);
              ctx.lineTo(b.x, b.y);
              ctx.stroke();
            }
          }
        }

        ctx.restore();
        requestAnimationFrame(animate);
      }

      function attachEvents() {
        els.energy.addEventListener('input', () => {
          state.energy = parseFloat(els.energy.value);
          rebuildNodes();
          updateShareURL();
        });
        els.orbit.addEventListener('input', () => {
          state.orbit = parseFloat(els.orbit.value);
          updateShareURL();
        });
        els.trail.addEventListener('input', () => {
          state.trail = parseFloat(els.trail.value);
          updateShareURL();
        });
        els.palette.addEventListener('change', () => {
          const next = els.palette.value;
          const palette = getPalette(next);
          if (palette.premium && !state.premium) {
            els.palette.value = state.palette;
            pulseAlert();
            return;
          }
          state.palette = next;
          applyPalette(next);
          updateShareURL();
        });
        els.pulse.addEventListener('click', () => {
          pulseField();
        });
        els.reset.addEventListener('click', () => {
          state.palette = 'aurora';
          state.energy = 0.6;
          state.orbit = 0.5;
          state.trail = 0.35;
          els.palette.value = state.palette;
          els.energy.value = state.energy;
          els.orbit.value = state.orbit;
          els.trail.value = state.trail;
          applyPalette(state.palette);
          rebuildNodes();
          updateShareURL();
        });
        els.copyLink.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(els.shareLink.value);
            toast('Link copied to clipboard.');
          } catch (err) {
            console.error(err);
            toast('Clipboard unavailable. Select and copy manually.', true);
          }
        });
        els.capture.addEventListener('click', () => captureFrame(false));
        els.export4k.addEventListener('click', () => {
          if (!state.premium) return pulseAlert();
          captureFrame(true);
        });
        els.downloadSnapshot.addEventListener('click', () => {
          if (!els.snapshotImg.src) return;
          const link = document.createElement('a');
          link.href = els.snapshotImg.src;
          link.download = `aurora-${Date.now()}.png`;
          link.click();
        });

        const pointerUpdate = evt => {
          const rect = canvas.getBoundingClientRect();
          state.pointer.x = (evt.clientX - rect.left) / rect.width;
          state.pointer.y = (evt.clientY - rect.top) / rect.height;
        };
        canvas.addEventListener('pointermove', pointerUpdate);
        canvas.addEventListener('pointerdown', pointerUpdate);

        window.addEventListener('resize', () => {
          resize();
          rebuildNodes();
        });

        els.sound.addEventListener('click', toggleSoundtrack);
      }

      function pulseAlert() {
        toast('That feature glows for Premium creators.');
      }

      function toast(message, danger = false) {
        const note = document.createElement('div');
        note.textContent = message;
        note.style.position = 'fixed';
        note.style.left = '50%';
        note.style.bottom = '32px';
        note.style.transform = 'translateX(-50%)';
        note.style.padding = '12px 18px';
        note.style.borderRadius = '999px';
        note.style.background = danger ? hexToRgba('#ff6b9a', 0.88) : 'rgba(8,15,24,0.82)';
        note.style.color = '#fff';
        note.style.border = '1px solid rgba(255,255,255,0.18)';
        note.style.boxShadow = '0 10px 30px rgba(0,0,0,0.4)';
        note.style.zIndex = '10';
        document.body.appendChild(note);
        setTimeout(() => {
          note.style.opacity = '0';
          note.style.transition = 'opacity 260ms ease';
          setTimeout(() => note.remove(), 260);
        }, 2200);
      }

      function captureFrame(highRes) {
        const snapshotCanvas = document.createElement('canvas');
        const scale = highRes ? 2 : 1;
        const snapWidth = Math.floor(width * scale);
        const snapHeight = Math.floor(height * scale);
        snapshotCanvas.width = snapWidth;
        snapshotCanvas.height = snapHeight;
        const snapCtx = snapshotCanvas.getContext('2d');
        snapCtx.drawImage(canvas, 0, 0, snapWidth, snapHeight);
        const dataUrl = snapshotCanvas.toDataURL('image/png');
        els.snapshotImg.src = dataUrl;
        els.snapshot.style.display = 'flex';
        const stamp = new Date().toLocaleTimeString();
        els.snapshotMeta.textContent = `Resolution: ${snapWidth}×${snapHeight} • Captured ${stamp}`;
      }

      function setupAudio() {
        if (state.audio.context) return;
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) {
          els.sound.disabled = true;
          toast('Audio context not supported in this browser.', true);
          return;
        }
        state.audio.context = new AudioContext();
        state.audio.gain = state.audio.context.createGain();
        state.audio.gain.gain.value = 0;
        state.audio.gain.connect(state.audio.context.destination);
      }

      function toggleSoundtrack() {
        if (!state.audio.context) setupAudio();
        if (!state.audio.context) return;

        if (state.audio.context.state === 'suspended') {
          state.audio.context.resume();
        }

        if (state.audio.playing) {
          stopSoundtrack();
        } else {
          startSoundtrack();
        }
      }

      function startSoundtrack() {
        state.audio.playing = true;
        els.sound.textContent = 'Stop Soundtrack';
        fadeGainTo(0.22, 1.6);
        schedulePad();
      }

      function stopSoundtrack() {
        state.audio.playing = false;
        els.sound.textContent = 'Start Soundtrack';
        fadeGainTo(0.0001, 1.2);
        if (state.audio.timer) {
          clearTimeout(state.audio.timer);
          state.audio.timer = null;
        }
      }

      function fadeGainTo(value, duration) {
        const now = state.audio.context.currentTime;
        state.audio.gain.gain.cancelScheduledValues(now);
        state.audio.gain.gain.exponentialRampToValueAtTime(Math.max(value, 0.0001), now + duration);
      }

      function schedulePad() {
        if (!state.audio.playing) return;
        const ctxAudio = state.audio.context;
        const baseTime = ctxAudio.currentTime + 0.05;
        const palette = getPalette(state.palette);
        const scale = chooseScale(palette.id);
        const chord = pickChord(scale);

        chord.forEach((freq, index) => {
          const osc = ctxAudio.createOscillator();
          osc.type = index % 2 === 0 ? 'sine' : 'triangle';
          osc.frequency.setValueAtTime(freq, baseTime);
          const gain = ctxAudio.createGain();
          const envelope = 6 + state.energy * 8;
          gain.gain.setValueAtTime(0.0001, baseTime);
          gain.gain.exponentialRampToValueAtTime(0.12 + state.energy * 0.18, baseTime + 0.4);
          gain.gain.exponentialRampToValueAtTime(0.0001, baseTime + envelope);
          osc.connect(gain);
          gain.connect(state.audio.gain);
          osc.start(baseTime);
          osc.stop(baseTime + envelope + 0.4);
        });

        state.audio.timer = setTimeout(schedulePad, 3500);
      }

      function chooseScale(paletteId) {
        switch (paletteId) {
          case 'ember':
            return [196.00, 246.94, 293.66, 329.63, 392.00, 440.00]; // D major
          case 'prism':
            return [207.65, 246.94, 311.13, 369.99, 415.30, 466.16]; // F# mixolydian
          case 'celestial':
            return [261.63, 311.13, 369.99, 415.30, 466.16, 523.25]; // C lydian
          default:
            return [220.00, 277.18, 329.63, 369.99, 415.30, 493.88]; // A dorian
        }
      }

      function pickChord(scale) {
        const rootIndex = Math.floor(Math.random() * scale.length);
        const root = scale[rootIndex];
        const third = scale[(rootIndex + 2) % scale.length];
        const fifth = scale[(rootIndex + 4) % scale.length];
        const octave = root * 2;
        return [root, third, fifth, octave];
      }

      async function bootstrap() {
        resize();
        rebuildNodes();
        attachEvents();
        deserializeState();
        populatePaletteSelect();
        els.palette.value = state.palette;
        els.energy.value = state.energy;
        els.orbit.value = state.orbit;
        els.trail.value = state.trail;
        applyPalette(state.palette);
        updateShareURL();
        requestAnimationFrame(animate);
        setPremiumUI();

        try {
          const { user } = await supabaseSession();
          state.user = user;
          els.userPill.textContent = `Signed in: …${String(user.id).slice(-6)}`;
          const premium = await isUserPremium();
          state.premium = premium;
          if (premium) {
            els.userPill.textContent = `Premium: …${String(user.id).slice(-6)}`;
          }
          setPremiumUI();
          populatePaletteSelect();
          applyPalette(state.palette);
        } catch (err) {
          console.error(err);
          els.userPill.textContent = 'Offline mode';
          state.premium = false;
          setPremiumUI();
        }
      }

      bootstrap();
    </script>
  </body>
</html>
