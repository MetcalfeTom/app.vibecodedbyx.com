<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sloppy Tags</title>
    <link rel="icon" href="https://emojicdn.elk.sh/üè∑Ô∏è">
    <meta property="og:title" content="Sloppy Tags">
    <meta property="og:description" content="Explore the tag universe. Browse, discover, and filter across posts, messages, and manifestos.">
    <meta property="og:url" content="https://sloppy.live/sloppy-tags">
    <meta property="og:image" content="https://pollinations.ai/p/neon%20hashtags%20floating%20in%20dark%20space%20glowing%20cyan%20magenta%20green%20pixel%20art?width=1200&height=630&nologo=true&referrer=sloppy.live">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@300;400;600;800&family=JetBrains+Mono:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #06060e;
            --surface: #0c0c1a;
            --surface-hover: #14142a;
            --border: #1e1e3a;
            --border-active: #34345a;
            --text: #d8d8f0;
            --text-dim: #8888b0;
            --text-muted: #4a4a70;
            --cyan: #00e8e8;
            --magenta: #e840a0;
            --green: #40e870;
            --yellow: #e8d040;
            --orange: #e89040;
            --pink: #e860c0;
            --display: 'Bricolage Grotesque', sans-serif;
            --mono: 'JetBrains Mono', monospace;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); font-family: var(--mono); font-size: 13px; min-height: 100vh; }
        a { color: var(--cyan); text-decoration: none; }
        a:hover { text-decoration: underline; }

        .hdr {
            text-align: center;
            padding: 28px 16px 20px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(180deg, #0c0c1a 0%, var(--bg) 100%);
        }
        .hdr h1 { font-family: var(--display); font-size: 2.4rem; font-weight: 300; }
        .hdr h1 span { color: var(--cyan); font-weight: 800; }
        .hdr .sub { font-size: 10px; color: var(--text-muted); margin-top: 4px; letter-spacing: 0.1em; text-transform: uppercase; }
        .stats-row {
            display: flex; gap: 20px; justify-content: center; margin-top: 12px; font-size: 11px; color: var(--text-dim);
        }
        .stats-row strong { color: var(--cyan); }

        .search-bar {
            max-width: 500px;
            margin: 16px auto 0;
            display: flex;
            gap: 6px;
            padding: 0 12px;
        }
        .search-bar input {
            flex: 1;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text);
            font-family: var(--mono);
            font-size: 12px;
            padding: 8px 12px;
            outline: none;
        }
        .search-bar input:focus { border-color: var(--cyan); }
        .search-bar input::placeholder { color: var(--text-muted); }

        /* Tag Cloud */
        .cloud-section {
            max-width: 700px;
            margin: 0 auto;
            padding: 16px 12px;
            text-align: center;
        }
        .cloud-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 10px;
        }
        .tag-cloud {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
        }
        .cloud-tag {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            animation: tagPulse 3s ease-in-out infinite;
        }
        .cloud-tag:hover { transform: scale(1.15); filter: brightness(1.3); border-color: currentColor; }
        .cloud-tag .count { font-size: 9px; opacity: 0.6; margin-left: 3px; }
        .size-1 { font-size: 0.72rem; }
        .size-2 { font-size: 0.85rem; }
        .size-3 { font-size: 1rem; font-weight: 500; }
        .size-4 { font-size: 1.15rem; font-weight: 600; }
        .size-5 { font-size: 1.35rem; font-weight: 700; }
        .neon-cyan { color: var(--cyan); }
        .neon-magenta { color: var(--magenta); }
        .neon-green { color: var(--green); }
        .neon-yellow { color: var(--yellow); }
        .neon-orange { color: var(--orange); }
        .neon-pink { color: var(--pink); }
        @keyframes tagPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Trending */
        .trending-section {
            max-width: 700px;
            margin: 0 auto;
            padding: 0 12px 12px;
        }
        .trending-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.12s;
        }
        .trending-row:hover { background: var(--surface-hover); }
        .trending-rank { width: 24px; font-size: 12px; font-weight: 700; color: var(--text-muted); text-align: center; }
        .trending-rank.hot { color: var(--magenta); }
        .trending-rank.warm { color: var(--orange); }
        .trending-name { flex: 1; font-size: 13px; }
        .trending-name .nested { opacity: 0.6; }
        .trending-count { font-size: 11px; color: var(--text-dim); }
        .trending-sources { font-size: 9px; color: var(--text-muted); }

        /* Explorer: tag detail view */
        .explorer {
            max-width: 700px;
            margin: 0 auto;
            padding: 0 12px 80px;
            display: none;
        }
        .explorer.active { display: block; }
        .explorer-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 0;
            border-bottom: 1px solid var(--border);
        }
        .explorer-tag {
            font-family: var(--display);
            font-size: 1.6rem;
            font-weight: 800;
            color: var(--cyan);
        }
        .explorer-back {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-dim);
            font-family: var(--mono);
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        .explorer-back:hover { color: var(--text); border-color: var(--border-active); }
        .explorer-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 12px 0;
        }
        .es-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 5px;
            padding: 10px;
            text-align: center;
        }
        .es-item .val { font-size: 20px; font-weight: 700; color: var(--cyan); }
        .es-item .lbl { font-size: 9px; color: var(--text-muted); text-transform: uppercase; }
        .explorer-tabs {
            display: flex;
            gap: 2px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0;
        }
        .exp-tab {
            background: none;
            border: none;
            color: var(--text-dim);
            font-family: var(--mono);
            font-size: 11px;
            padding: 8px 14px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.12s;
        }
        .exp-tab:hover { color: var(--text); }
        .exp-tab.active { color: var(--cyan); border-bottom-color: var(--cyan); }
        .exp-panel { display: none; padding: 8px 0; }
        .exp-panel.active { display: block; }

        /* Content cards in explorer */
        .content-card {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            transition: background 0.12s;
        }
        .content-card:hover { background: var(--surface-hover); }
        .cc-header {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            margin-bottom: 4px;
        }
        .cc-avatar { font-size: 14px; }
        .cc-user { font-weight: 500; color: var(--text); }
        .cc-time { color: var(--text-muted); margin-left: auto; font-size: 10px; }
        .cc-text { font-size: 12px; color: var(--text-dim); line-height: 1.4; word-break: break-word; }
        .cc-title { font-weight: 600; color: var(--text); font-size: 13px; margin-bottom: 2px; }
        .cc-image { max-width: 100%; max-height: 200px; border-radius: 4px; margin-top: 6px; display: block; }
        .cc-votes { font-size: 11px; color: var(--green); margin-top: 4px; }

        .section-label {
            font-size: 10px; color: var(--text-muted); text-transform: uppercase;
            letter-spacing: 0.1em; padding: 12px 0 6px; border-bottom: 1px solid var(--border);
        }
        .empty-state { text-align: center; padding: 30px; color: var(--text-muted); }
        .browse-section { max-width: 700px; margin: 0 auto; padding: 0 12px 80px; }

        .hierarchy-section { max-width: 700px; margin: 0 auto; padding: 0 12px 12px; }
        .parent-group { margin-bottom: 12px; }
        .parent-label {
            font-family: var(--display);
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            padding: 6px 0;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }
        .parent-label:hover { color: var(--cyan); }
        .parent-label .p-count { font-size: 10px; color: var(--text-muted); font-weight: 400; margin-left: 6px; }
        .child-tags { display: flex; flex-wrap: wrap; gap: 4px; padding: 6px 0 0 12px; }
        .child-tag {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-dim);
            font-size: 11px;
            padding: 3px 9px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.12s;
        }
        .child-tag:hover { color: var(--cyan); border-color: var(--cyan); }
        .child-tag .ct-count { font-size: 9px; opacity: 0.5; margin-left: 3px; }

        .backlink { text-align: center; padding: 12px; font-size: 11px; }
        .toast {
            position: fixed; bottom: 60px; left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: var(--surface); border: 1px solid var(--cyan);
            color: var(--text); font-family: var(--mono); font-size: 11px;
            padding: 8px 18px; border-radius: 6px; z-index: 200;
            opacity: 0; transition: all 0.3s; pointer-events: none;
        }
        .toast.visible { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* Embed mode */
        body.embed-mode { min-height: auto; }
        body.embed-mode .hdr { display: none; }
        body.embed-mode .search-bar { display: none; }
        body.embed-mode .backlink { display: none; }
        body.embed-mode .cloud-section { padding: 8px 6px; }
        body.embed-mode .cloud-label { margin-bottom: 6px; }
        body.embed-mode .hierarchy-section { padding: 0 6px 6px; }
        body.embed-mode .trending-section { padding: 0 6px 6px; }
        body.embed-mode .explorer { padding: 0 6px 12px; }
        body.embed-mode .section-label { padding: 8px 0 4px; }
        body.embed-mode .browse-section { padding: 0 6px 12px; }

        @media (max-width: 600px) {
            .hdr h1 { font-size: 1.7rem; }
            .explorer-stats { grid-template-columns: repeat(3, 1fr); }
            .explorer-tag { font-size: 1.2rem; }
        }
    </style>
</head>
<body>
    <script>
        var IS_EMBED = new URLSearchParams(location.search).has('embed');
        if (IS_EMBED) document.body.classList.add('embed-mode');
    </script>
    <div class="hdr">
        <h1>Sloppy <span>Tags</span></h1>
        <div class="sub">Tag Universe Explorer</div>
        <div class="stats-row">
            <span><strong id="sTotal">‚Äî</strong> tags</span>
            <span><strong id="sUnique">‚Äî</strong> unique</span>
            <span><strong id="sParents">‚Äî</strong> categories</span>
        </div>
    </div>

    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Search tags..." oninput="onSearch()">
    </div>

    <div id="browseView">
        <div class="cloud-section">
            <div class="cloud-label">Tag Cloud ‚Äî Top 30</div>
            <div class="tag-cloud" id="tagCloud">loading...</div>
        </div>

        <div class="hierarchy-section">
            <div class="section-label">Tag Hierarchy</div>
            <div id="hierarchyContainer"></div>
        </div>

        <div class="trending-section">
            <div class="section-label">All Tags by Frequency</div>
            <div id="trendingList"></div>
        </div>
    </div>

    <div class="explorer" id="explorer">
        <div class="explorer-header">
            <button class="explorer-back" onclick="closeExplorer()">‚Üê Back</button>
            <div class="explorer-tag" id="expTag"></div>
        </div>
        <div class="explorer-stats" id="expStats"></div>
        <div class="explorer-tabs">
            <button class="exp-tab active" data-tab="messages" onclick="switchExpTab('messages', this)">Messages</button>
            <button class="exp-tab" data-tab="posts" onclick="switchExpTab('posts', this)">Posts</button>
            <button class="exp-tab" data-tab="manifestos" onclick="switchExpTab('manifestos', this)">Manifestos</button>
        </div>
        <div class="exp-panel active" id="panel-messages"></div>
        <div class="exp-panel" id="panel-posts"></div>
        <div class="exp-panel" id="panel-manifestos"></div>
    </div>

    <div class="toast" id="toast"></div>
    <div class="backlink"><a href="https://sloppy.live">‚Üê sloppy.live</a></div>

    <script src="/sloppy-header/sloppy-bar.js" data-position="bottom" data-minimized="true"></script>
    <script type="module">
        import { createBrowserClient } from "https://cdn.jsdelivr.net/npm/@supabase/ssr@0.7.0/+esm";

        const supabase = createBrowserClient(
            'https://yjyxteqzhhmtrgcaekgz.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM4IS32IUYR2eenCCjdDdioiBU',
            { cookieOptions: { name: 'sb-auth-token', domain: location.hostname.includes('sloppy.live') ? '.sloppy.live' : location.hostname, path: '/', sameSite: 'lax' } }
        );

        window.supabase = supabase;
        const IS_EMBED = new URLSearchParams(location.search).has('embed');

        const NEON_COLORS = ['neon-cyan','neon-magenta','neon-green','neon-yellow','neon-orange','neon-pink'];
        let tagData = {};       // { displayTag: { count, sources: {message,post,manifesto}, parent_tag, tag } }
        let allTags = [];       // sorted array of {tag, count, ...}
        let currentUser = null;

        function escapeHtml(s) { return s ? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;') : ''; }
        function timeAgo(d) {
            const s = Math.floor((Date.now() - new Date(d).getTime()) / 1000);
            if (s < 60) return 'now';
            if (s < 3600) return Math.floor(s/60) + 'm';
            if (s < 86400) return Math.floor(s/3600) + 'h';
            if (s < 604800) return Math.floor(s/86400) + 'd';
            return new Date(d).toLocaleDateString();
        }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.classList.add('visible');
            setTimeout(() => t.classList.remove('visible'), 2200);
        }
        function truncate(s, n) { return s && s.length > n ? s.slice(0, n) + '‚Ä¶' : (s || ''); }

        // --- Auth ---
        async function initAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            let s = session;
            if (!s) { const { data } = await supabase.auth.signInAnonymously(); s = data?.session; }
            if (s?.user) currentUser = s.user;
        }

        // --- Load all tags ---
        async function loadTags() {
            const [msgR, postR, manR] = await Promise.all([
                supabase.from('sloppygram_message_tags').select('tag, parent_tag').limit(1000),
                supabase.from('sloppygram_post_tags').select('tag, parent_tag').limit(1000),
                supabase.from('sloppygram_manifesto_tags').select('tag, parent_tag').limit(1000)
            ]);

            tagData = {};

            function process(rows, source) {
                (rows || []).forEach(r => {
                    const display = r.parent_tag ? `${r.parent_tag}/${r.tag}` : r.tag;
                    if (!tagData[display]) {
                        tagData[display] = { count: 0, sources: { message: 0, post: 0, manifesto: 0 }, parent_tag: r.parent_tag, tag: r.tag };
                    }
                    tagData[display].count++;
                    tagData[display].sources[source]++;
                });
            }

            process(msgR.data, 'message');
            process(postR.data, 'post');
            process(manR.data, 'manifesto');

            allTags = Object.entries(tagData).map(([display, d]) => ({ display, ...d }))
                .sort((a, b) => b.count - a.count);

            updateStats();
            renderCloud();
            renderHierarchy();
            renderTrending();
        }

        function updateStats() {
            const total = allTags.reduce((a, t) => a + t.count, 0);
            const unique = allTags.length;
            const parents = new Set(allTags.filter(t => t.parent_tag).map(t => t.parent_tag)).size;
            document.getElementById('sTotal').textContent = total;
            document.getElementById('sUnique').textContent = unique;
            document.getElementById('sParents').textContent = parents;
        }

        // --- Tag Cloud ---
        function renderCloud() {
            const top = allTags.slice(0, 30);
            if (top.length === 0) { document.getElementById('tagCloud').innerHTML = '<span style="color:var(--text-muted)">No tags yet.</span>'; return; }
            const maxCount = top[0].count;
            document.getElementById('tagCloud').innerHTML = top.map((t, i) => {
                const ratio = maxCount > 1 ? t.count / maxCount : 1;
                const size = ratio > 0.8 ? 5 : ratio > 0.5 ? 4 : ratio > 0.3 ? 3 : ratio > 0.15 ? 2 : 1;
                const color = NEON_COLORS[i % NEON_COLORS.length];
                return `<span class="cloud-tag size-${size} ${color}" style="animation-delay:${(i*0.15)%3}s" onclick="openExplorer('${escapeHtml(t.display)}')">#${escapeHtml(t.display)}<span class="count">${t.count}</span></span>`;
            }).join('');
        }

        // --- Hierarchy ---
        function renderHierarchy() {
            const parents = {};
            const flat = [];
            allTags.forEach(t => {
                if (t.parent_tag) {
                    if (!parents[t.parent_tag]) parents[t.parent_tag] = [];
                    parents[t.parent_tag].push(t);
                } else {
                    // Check if this tag is also a parent of others
                    flat.push(t);
                }
            });

            const container = document.getElementById('hierarchyContainer');
            const parentKeys = Object.keys(parents).sort();

            if (parentKeys.length === 0) {
                container.innerHTML = '<div class="empty-state">No hierarchical tags yet.</div>';
                return;
            }

            container.innerHTML = parentKeys.map(p => {
                const children = parents[p].sort((a, b) => b.count - a.count);
                const totalCount = children.reduce((a, c) => a + c.count, 0);
                return `<div class="parent-group">
                    <div class="parent-label" onclick="openExplorer('${escapeHtml(p)}')">#${escapeHtml(p)} <span class="p-count">${totalCount} uses</span></div>
                    <div class="child-tags">
                        ${children.map(c => `<span class="child-tag" onclick="openExplorer('${escapeHtml(c.display)}')">${escapeHtml(c.tag)}<span class="ct-count">${c.count}</span></span>`).join('')}
                    </div>
                </div>`;
            }).join('');
        }

        // --- Trending list ---
        function renderTrending(filtered) {
            const list = filtered || allTags;
            const container = document.getElementById('trendingList');
            if (list.length === 0) { container.innerHTML = '<div class="empty-state">No matching tags.</div>'; return; }

            container.innerHTML = list.slice(0, 50).map((t, i) => {
                const rankClass = i === 0 ? 'hot' : i < 3 ? 'warm' : '';
                const src = [];
                if (t.sources.message) src.push(`${t.sources.message} msg`);
                if (t.sources.post) src.push(`${t.sources.post} post`);
                if (t.sources.manifesto) src.push(`${t.sources.manifesto} man`);
                return `<div class="trending-row" onclick="openExplorer('${escapeHtml(t.display)}')">
                    <div class="trending-rank ${rankClass}">${i + 1}</div>
                    <div class="trending-name">#${escapeHtml(t.display)}</div>
                    <div class="trending-sources">${src.join(' ¬∑ ')}</div>
                    <div class="trending-count">${t.count}</div>
                </div>`;
            }).join('');
        }

        // --- Search ---
        window.onSearch = function() {
            const q = document.getElementById('searchInput').value.trim().toLowerCase().replace(/^#/, '');
            if (!q) {
                renderTrending();
                renderCloud();
                return;
            }
            const filtered = allTags.filter(t => t.display.toLowerCase().includes(q));
            renderTrending(filtered);
            // Update cloud to show matching
            const top = filtered.slice(0, 20);
            const maxCount = top.length ? top[0].count : 1;
            document.getElementById('tagCloud').innerHTML = top.length === 0
                ? '<span style="color:var(--text-muted)">No matches.</span>'
                : top.map((t, i) => {
                    const ratio = maxCount > 1 ? t.count / maxCount : 1;
                    const size = ratio > 0.8 ? 5 : ratio > 0.5 ? 4 : ratio > 0.3 ? 3 : ratio > 0.15 ? 2 : 1;
                    const color = NEON_COLORS[i % NEON_COLORS.length];
                    return `<span class="cloud-tag size-${size} ${color}" onclick="openExplorer('${escapeHtml(t.display)}')">#${escapeHtml(t.display)}<span class="count">${t.count}</span></span>`;
                }).join('');
        };

        // --- Explorer: tag detail view ---
        window.openExplorer = async function(tagStr) {
            document.getElementById('browseView').style.display = 'none';
            const explorer = document.getElementById('explorer');
            explorer.classList.add('active');
            document.getElementById('expTag').textContent = '#' + tagStr;

            // Reset tabs
            document.querySelectorAll('.exp-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === 'messages'));
            document.querySelectorAll('.exp-panel').forEach(p => p.classList.toggle('active', p.id === 'panel-messages'));

            const td = tagData[tagStr] || { sources: { message: 0, post: 0, manifesto: 0 } };
            document.getElementById('expStats').innerHTML = `
                <div class="es-item"><div class="val">${td.sources.message}</div><div class="lbl">Messages</div></div>
                <div class="es-item"><div class="val">${td.sources.post}</div><div class="lbl">Posts</div></div>
                <div class="es-item"><div class="val">${td.sources.manifesto}</div><div class="lbl">Manifestos</div></div>`;

            // Parse tag for query
            let queryTag, queryParent;
            if (tagStr.includes('/')) {
                const parts = tagStr.split('/');
                queryParent = parts[0];
                queryTag = parts.slice(1).join('/');
            } else {
                queryTag = tagStr;
                queryParent = null;
            }

            // Load content for this tag
            const buildFilter = (q) => {
                if (queryParent) return q.eq('tag', queryTag).eq('parent_tag', queryParent);
                return q.eq('tag', queryTag);
            };

            const [msgTagsR, postTagsR, manTagsR] = await Promise.all([
                buildFilter(supabase.from('sloppygram_message_tags').select('message_id')).limit(20),
                buildFilter(supabase.from('sloppygram_post_tags').select('post_id')).limit(20),
                buildFilter(supabase.from('sloppygram_manifesto_tags').select('manifesto_id')).limit(20)
            ]);

            // Fetch actual content
            const msgIds = (msgTagsR.data || []).map(r => r.message_id).filter(Boolean);
            const postIds = (postTagsR.data || []).map(r => r.post_id).filter(Boolean);
            const manIds = (manTagsR.data || []).map(r => r.manifesto_id).filter(Boolean);

            const [msgsR, postsR, mansR] = await Promise.all([
                msgIds.length ? supabase.from('sloppygram_messages').select('id, username, avatar, content, created_at').in('id', msgIds).order('created_at', { ascending: false }).limit(10) : { data: [] },
                postIds.length ? supabase.from('sloppygram_posts').select('id, username, avatar, caption, image_url, likes_count, created_at').in('id', postIds).order('created_at', { ascending: false }).limit(10) : { data: [] },
                manIds.length ? supabase.from('sloppygram_manifestos').select('id, username, avatar, title, content, upvotes, created_at').in('id', manIds).order('created_at', { ascending: false }).limit(10) : { data: [] }
            ]);

            // Render messages
            const msgs = msgsR.data || [];
            document.getElementById('panel-messages').innerHTML = msgs.length === 0
                ? '<div class="empty-state">No messages with this tag.</div>'
                : msgs.map(m => `<div class="content-card">
                    <div class="cc-header"><span class="cc-avatar">${m.avatar || 'üë§'}</span><span class="cc-user" style="cursor:pointer" onclick="usernameClick('${escapeHtml(m.username)}')">${escapeHtml(m.username)}</span><span class="cc-time">${timeAgo(m.created_at)}</span></div>
                    <div class="cc-text">${escapeHtml(truncate(m.content, 300))}</div>
                </div>`).join('');

            // Render posts
            const posts = postsR.data || [];
            document.getElementById('panel-posts').innerHTML = posts.length === 0
                ? '<div class="empty-state">No posts with this tag.</div>'
                : posts.map(p => `<div class="content-card">
                    <div class="cc-header"><span class="cc-avatar">${p.avatar || 'üë§'}</span><span class="cc-user" style="cursor:pointer" onclick="usernameClick('${escapeHtml(p.username)}')">${escapeHtml(p.username)}</span><span class="cc-time">${timeAgo(p.created_at)}</span></div>
                    ${p.caption ? `<div class="cc-text">${escapeHtml(truncate(p.caption, 200))}</div>` : ''}
                    ${p.image_url ? `<img class="cc-image" src="${escapeHtml(p.image_url)}" alt="" loading="lazy" onerror="this.style.display='none'">` : ''}
                    <div class="cc-votes">‚ñ≤ ${p.likes_count || 0}</div>
                </div>`).join('');

            // Render manifestos
            const mans = mansR.data || [];
            document.getElementById('panel-manifestos').innerHTML = mans.length === 0
                ? '<div class="empty-state">No manifestos with this tag.</div>'
                : mans.map(m => `<div class="content-card">
                    <div class="cc-header"><span class="cc-avatar">${m.avatar || 'üë§'}</span><span class="cc-user" style="cursor:pointer" onclick="usernameClick('${escapeHtml(m.username)}')">${escapeHtml(m.username)}</span><span class="cc-time">${timeAgo(m.created_at)}</span></div>
                    <div class="cc-title">${escapeHtml(m.title || 'Untitled')}</div>
                    <div class="cc-text">${escapeHtml(truncate(m.content, 200))}</div>
                    <div class="cc-votes">‚ñ≤ ${m.upvotes || 0}</div>
                </div>`).join('');
        };

        window.closeExplorer = function() {
            document.getElementById('explorer').classList.remove('active');
            document.getElementById('browseView').style.display = '';
        };

        // Set tag as global filter in parent (embed mode)
        window.setTagFilter = function(tagStr) {
            if (IS_EMBED) {
                window.parent.postMessage({ type: 'tag-filter', tag: tagStr }, '*');
            }
        };

        // Username click ‚Üí parent profile card (embed mode)
        window.usernameClick = function(username) {
            if (IS_EMBED) {
                window.parent.postMessage({ type: 'username-click', username: username }, '*');
            }
        };

        window.switchExpTab = function(tab, btn) {
            document.querySelectorAll('.exp-tab').forEach(t => t.classList.toggle('active', t === btn));
            document.querySelectorAll('.exp-panel').forEach(p => p.classList.toggle('active', p.id === 'panel-' + tab));
        };

        // --- Real-time ---
        function subscribeRealtime() {
            const channel = supabase.channel('sloppy-tags-rt');
            ['sloppygram_message_tags', 'sloppygram_post_tags', 'sloppygram_manifesto_tags'].forEach(table => {
                channel.on('postgres_changes', { event: 'INSERT', schema: 'public', table }, () => {
                    loadTags(); // Reload on any new tag
                });
            });
            channel.subscribe();
        }

        // --- Init ---
        async function init() {
            await initAuth();
            await loadTags();
            subscribeRealtime();
        }

        init().catch(err => {
            console.error('Init error:', err);
            document.getElementById('tagCloud').textContent = 'Failed to load. Refresh to try again.';
        });
    </script>
</body>
</html>