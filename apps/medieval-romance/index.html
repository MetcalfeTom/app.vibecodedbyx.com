<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="A medieval romance simulator set in England. Choose your path through noble courts, taverns, and castle intrigue." />
  <meta property="og:title" content="Medieval Romance Quest" />
  <meta property="og:description" content="Navigate love and politics in medieval England. A romantic adventure through noble courts and castle intrigue." />
  <meta property="og:url" content="https://app.vibecodedbyx.com/medieval-romance/" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://app.vibecodedbyx.com/medieval-romance/og.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Medieval Romance Quest" />
  <meta name="twitter:description" content="Navigate love and politics in medieval England. A romantic adventure through noble courts and castle intrigue." />
  <meta name="twitter:image" content="https://app.vibecodedbyx.com/medieval-romance/og.png" />
  <title>Medieval Romance Quest</title>
  <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJz48dGV4dCB5PScuOWVtJyBmb250LXNpemU9JzkwJz7wn5GRPC90ZXh0Pjwvc3ZnPg==" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            medieval: ['Cinzel', 'serif'],
          },
          colors: {
            parchment: '#f4f1e8',
            ink: '#2d1810',
            gold: '#d4af37',
            royal: '#1e3a8a',
            crimson: '#dc2626'
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  <style>
    .parchment-bg {
      background: linear-gradient(45deg, #f4f1e8 0%, #e8e2d0 100%);
    }
    .medieval-shadow {
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
  </style>
</head>
<body class="parchment-bg min-h-screen font-serif">
  <!-- Game Container -->
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Header -->
    <header class="text-center mb-8">
      <h1 class="text-4xl md:text-6xl font-medieval font-bold text-ink mb-4">
        âš”ï¸ Medieval Romance Quest ğŸ‘‘
      </h1>
      <p class="text-lg text-ink/80 italic">
        Navigate love and politics in medieval England
      </p>
    </header>

    <!-- Auth Section -->
    <div class="bg-white/50 backdrop-blur-sm rounded-lg p-4 mb-6 medieval-shadow">
      <div class="flex items-center justify-between">
        <div id="auth-status" class="text-ink font-medium">Loading...</div>
        <div class="space-x-2">
          <button id="signin-btn" class="hidden bg-royal text-white px-4 py-2 rounded-lg hover:bg-royal/80 transition-colors">
            Sign in with Twitter
          </button>
          <button id="signout-btn" class="hidden bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
            Sign out
          </button>
        </div>
      </div>
    </div>

    <!-- Game Area -->
    <div class="grid gap-6 lg:grid-cols-3">
      <!-- Main Story Panel -->
      <div class="lg:col-span-2">
        <div class="bg-white/70 backdrop-blur-sm rounded-lg p-6 medieval-shadow">
          <div id="story-content">
            <!-- Story Image -->
            <div class="text-center mb-6">
              <div id="story-image" class="text-8xl mb-4">ğŸ°</div>
              <h2 id="location-title" class="text-2xl font-medieval font-bold text-ink mb-2">
                The Royal Court
              </h2>
            </div>

            <!-- Story Text -->
            <div id="story-text" class="text-ink leading-relaxed mb-6 text-lg">
              <p class="mb-4">
                The year is 1347, and you are a young noble newly arrived at the court of King Edward III.
                The castle halls echo with whispers of romance, political intrigue, and the distant sounds of war.
              </p>
              <p>
                As you enter the great hall, you notice several intriguing figures...
              </p>
            </div>

            <!-- Choices -->
            <div id="choices" class="space-y-3">
              <button class="choice-btn w-full text-left p-4 bg-gradient-to-r from-royal to-royal/80 text-white rounded-lg hover:from-royal/90 hover:to-royal/70 transition-all duration-300 medieval-shadow"
                      data-choice="noble">
                ğŸ’ Approach the mysterious noble by the fireplace
              </button>
              <button class="choice-btn w-full text-left p-4 bg-gradient-to-r from-crimson to-crimson/80 text-white rounded-lg hover:from-crimson/90 hover:to-crimson/70 transition-all duration-300 medieval-shadow"
                      data-choice="knight">
                âš”ï¸ Speak with the valiant knight in armor
              </button>
              <button class="choice-btn w-full text-left p-4 bg-gradient-to-r from-green-700 to-green-600 text-white rounded-lg hover:from-green-600 hover:to-green-500 transition-all duration-300 medieval-shadow"
                      data-choice="court">
                ğŸ‘‘ Join the courtly dance and mingle
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Side Panel -->
      <div class="space-y-6">
        <!-- Stats -->
        <div class="bg-white/70 backdrop-blur-sm rounded-lg p-4 medieval-shadow">
          <h3 class="font-medieval font-bold text-ink mb-4 text-xl">Your Standing</h3>
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-ink">ğŸ’° Wealth</span>
              <div class="flex space-x-1">
                <span id="wealth-stars">â­â­â­â˜†â˜†</span>
              </div>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-ink">ğŸ‘‘ Honor</span>
              <div class="flex space-x-1">
                <span id="honor-stars">â­â­â­â˜†â˜†</span>
              </div>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-ink">ğŸ’• Romance</span>
              <div class="flex space-x-1">
                <span id="romance-stars">â˜†â˜†â˜†â˜†â˜†</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Current Romance Interests -->
        <div class="bg-white/70 backdrop-blur-sm rounded-lg p-4 medieval-shadow">
          <h3 class="font-medieval font-bold text-ink mb-4 text-xl">Romance Interests</h3>
          <div id="romance-list" class="space-y-2 text-sm text-ink/80">
            <p class="italic">None yet discovered...</p>
          </div>
        </div>

        <!-- Game Progress -->
        <div class="bg-white/70 backdrop-blur-sm rounded-lg p-4 medieval-shadow">
          <h3 class="font-medieval font-bold text-ink mb-4 text-xl">Your Journey</h3>
          <div class="text-sm text-ink">
            <p>Chapter: <span id="chapter" class="font-medium">I</span></p>
            <p>Choices Made: <span id="choices-count" class="font-medium">0</span></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="text-center mt-8 pt-6 border-t border-ink/20">
      <a href="https://www.vibecodedbyx.com" target="_blank" rel="noopener"
         class="text-royal hover:text-royal/80 transition-colors font-medium">
        â† Back to the livestream
      </a>
    </footer>
  </div>

  <script type="module">
    import supabase, { supabaseSession } from './supabase-config.js';

    // Game State
    let gameState = {
      user: null,
      currentScene: 'intro',
      stats: {
        wealth: 3,
        honor: 3,
        romance: 0
      },
      romanceInterests: [],
      chapter: 1,
      choicesCount: 0,
      gameProgress: {}
    };

    // Game Scenes
    const scenes = {
      intro: {
        image: 'ğŸ°',
        title: 'The Royal Court',
        text: `
          <p class="mb-4">
            The year is 1347, and you are a young noble newly arrived at the court of King Edward III.
            The castle halls echo with whispers of romance, political intrigue, and the distant sounds of war.
          </p>
          <p>
            As you enter the great hall, you notice several intriguing figures...
          </p>
        `,
        choices: [
          { id: 'noble', text: 'ğŸ’ Approach the mysterious noble by the fireplace', next: 'meet_noble' },
          { id: 'knight', text: 'âš”ï¸ Speak with the valiant knight in armor', next: 'meet_knight' },
          { id: 'court', text: 'ğŸ‘‘ Join the courtly dance and mingle', next: 'court_dance' }
        ]
      },
      meet_noble: {
        image: 'ğŸ’',
        title: 'The Mysterious Noble',
        text: `
          <p class="mb-4">
            You approach a figure draped in rich velvet, their face partially hidden by shadows.
            As you draw near, they turn to reveal piercing green eyes and an enigmatic smile.
          </p>
          <p class="mb-4">
            "Ah, a new face at court," they say in a melodious voice. "I am Lady Evelyn of Ashford.
            And you are...?"
          </p>
          <p>
            How do you introduce yourself?
          </p>
        `,
        choices: [
          { id: 'humble', text: 'ğŸ™‡ Introduce yourself humbly', next: 'noble_humble', effects: { honor: 1 } },
          { id: 'bold', text: 'ğŸ˜ Make a bold, flirtatious introduction', next: 'noble_bold', effects: { romance: 1 } },
          { id: 'mysterious', text: 'ğŸ­ Remain mysteriously vague', next: 'noble_mystery', effects: { wealth: 1 } }
        ]
      },
      meet_knight: {
        image: 'âš”ï¸',
        title: 'Sir Gareth the Brave',
        text: `
          <p class="mb-4">
            The knight removes their helm to reveal a noble face marked by battle scars and kind eyes.
            Sir Gareth of the Round Table stands before you, legend made flesh.
          </p>
          <p class="mb-4">
            "Well met, young noble. I hear you've just arrived from the countryside.
            The court can be treacherous for those unprepared."
          </p>
          <p>
            How do you respond to this warning?
          </p>
        `,
        choices: [
          { id: 'grateful', text: 'ğŸ™ Thank them for the warning', next: 'knight_grateful', effects: { honor: 1 } },
          { id: 'confident', text: 'ğŸ’ª Declare you can handle anything', next: 'knight_confident', effects: { romance: 1 } },
          { id: 'curious', text: 'ğŸ¤” Ask about the dangers', next: 'knight_curious', effects: { wealth: 1 } }
        ]
      },
      court_dance: {
        image: 'ğŸ’ƒ',
        title: 'The Courtly Dance',
        text: `
          <p class="mb-4">
            You join the swirling dancers in the center of the hall. The music is lively,
            and you find yourself paired with different nobles as the dance progresses.
          </p>
          <p class="mb-4">
            During a particularly intricate turn, you catch the eye of a charming figure
            who seems to anticipate your every move perfectly.
          </p>
          <p>
            As the music reaches its crescendo, what do you do?
          </p>
        `,
        choices: [
          { id: 'dip', text: 'ğŸ’• Attempt a romantic dip', next: 'dance_romantic', effects: { romance: 2 } },
          { id: 'showcase', text: 'âœ¨ Show off with fancy footwork', next: 'dance_show', effects: { honor: 1, wealth: 1 } },
          { id: 'graceful', text: 'ğŸŒ¹ End with a graceful bow', next: 'dance_graceful', effects: { honor: 2 } }
        ]
      },
      noble_humble: {
        image: 'ğŸ’',
        title: 'A Humble Beginning',
        text: `
          <p class="mb-4">
            Lady Evelyn nods approvingly at your modest introduction. "Humility is rare at court,
            and all the more precious for it. You shall go far here."
          </p>
          <p class="mb-4">
            She leans closer, her voice dropping to a whisper. "The King seeks new advisors
            for his council. Perhaps someone with your... discretion... would be valued."
          </p>
          <p>
            A romance interest has been discovered! Lady Evelyn seems intrigued by your character.
          </p>
        `,
        choices: [
          { id: 'continue', text: 'â¡ï¸ Continue your evening at court', next: 'court_evening' }
        ]
      }
    };

    // DOM Elements
    const elements = {
      authStatus: document.getElementById('auth-status'),
      signinBtn: document.getElementById('signin-btn'),
      signoutBtn: document.getElementById('signout-btn'),
      storyImage: document.getElementById('story-image'),
      locationTitle: document.getElementById('location-title'),
      storyText: document.getElementById('story-text'),
      choices: document.getElementById('choices'),
      wealthStars: document.getElementById('wealth-stars'),
      honorStars: document.getElementById('honor-stars'),
      romanceStars: document.getElementById('romance-stars'),
      romanceList: document.getElementById('romance-list'),
      chapter: document.getElementById('chapter'),
      choicesCount: document.getElementById('choices-count')
    };

    // Initialize auth
    async function initAuth() {
      try {
        const { session, user } = await supabaseSession();
        gameState.user = user;

        if (user) {
          elements.authStatus.textContent = `Signed in: ...${user.id.slice(-6)}`;
          elements.signoutBtn.classList.remove('hidden');
          elements.signinBtn.classList.add('hidden');

          elements.signoutBtn.onclick = async () => {
            await supabase.auth.signOut();
            location.reload();
          };

          await loadGameProgress();
        } else {
          elements.authStatus.textContent = 'Not signed in';
          elements.signinBtn.classList.remove('hidden');
          elements.signoutBtn.classList.add('hidden');
        }
      } catch (error) {
        console.error('Auth error:', error);
        elements.authStatus.textContent = 'Auth error';
      }
    }

    // Save game progress
    async function saveProgress() {
      if (!gameState.user) return;

      try {
        const { error } = await supabase
          .from('medieval_romance_progress')
          .upsert({
            user_id: gameState.user.id,
            current_scene: gameState.currentScene,
            stats: gameState.stats,
            romance_interests: gameState.romanceInterests,
            chapter: gameState.chapter,
            choices_count: gameState.choicesCount,
            game_progress: gameState.gameProgress
          });

        if (error) console.error('Save error:', error);
      } catch (error) {
        console.error('Save error:', error);
      }
    }

    // Load game progress
    async function loadGameProgress() {
      if (!gameState.user) return;

      try {
        const { data, error } = await supabase
          .from('medieval_romance_progress')
          .select('*')
          .eq('user_id', gameState.user.id)
          .single();

        if (data && !error) {
          gameState.currentScene = data.current_scene || 'intro';
          gameState.stats = data.stats || { wealth: 3, honor: 3, romance: 0 };
          gameState.romanceInterests = data.romance_interests || [];
          gameState.chapter = data.chapter || 1;
          gameState.choicesCount = data.choices_count || 0;
          gameState.gameProgress = data.game_progress || {};
        }
      } catch (error) {
        console.error('Load error:', error);
      }
    }

    // Render stars
    function renderStars(value, max = 5) {
      const filled = 'â­'.repeat(Math.min(value, max));
      const empty = 'â˜†'.repeat(Math.max(0, max - value));
      return filled + empty;
    }

    // Update UI
    function updateUI() {
      const scene = scenes[gameState.currentScene];
      if (!scene) return;

      elements.storyImage.textContent = scene.image;
      elements.locationTitle.textContent = scene.title;
      elements.storyText.innerHTML = scene.text;

      // Update stats
      elements.wealthStars.textContent = renderStars(gameState.stats.wealth);
      elements.honorStars.textContent = renderStars(gameState.stats.honor);
      elements.romanceStars.textContent = renderStars(gameState.stats.romance);

      // Update romance interests
      if (gameState.romanceInterests.length > 0) {
        elements.romanceList.innerHTML = gameState.romanceInterests
          .map(interest => `<div class="flex items-center space-x-2"><span>${interest.emoji}</span><span>${interest.name}</span></div>`)
          .join('');
      } else {
        elements.romanceList.innerHTML = '<p class="italic">None yet discovered...</p>';
      }

      // Update progress
      elements.chapter.textContent = romanNumeral(gameState.chapter);
      elements.choicesCount.textContent = gameState.choicesCount;

      // Render choices
      elements.choices.innerHTML = '';
      if (scene.choices) {
        scene.choices.forEach(choice => {
          const button = document.createElement('button');
          button.className = 'choice-btn w-full text-left p-4 bg-gradient-to-r from-royal to-royal/80 text-white rounded-lg hover:from-royal/90 hover:to-royal/70 transition-all duration-300 medieval-shadow';
          button.innerHTML = choice.text;
          button.onclick = () => makeChoice(choice);
          elements.choices.appendChild(button);
        });
      }
    }

    // Make choice
    function makeChoice(choice) {
      gameState.choicesCount++;

      // Apply effects
      if (choice.effects) {
        Object.keys(choice.effects).forEach(stat => {
          gameState.stats[stat] = Math.max(0, Math.min(5, gameState.stats[stat] + choice.effects[stat]));
        });
      }

      // Add romance interests based on scene
      if (gameState.currentScene === 'noble_humble' && !gameState.romanceInterests.find(r => r.name === 'Lady Evelyn')) {
        gameState.romanceInterests.push({ name: 'Lady Evelyn', emoji: 'ğŸ’' });
      }

      // Move to next scene
      if (choice.next) {
        gameState.currentScene = choice.next;
      }

      // Save and update
      saveProgress();
      updateUI();
    }

    // Roman numeral converter
    function romanNumeral(num) {
      const values = [1000, 900, 500, 400, 100, 90, 50, 40, 10, 9, 5, 4, 1];
      const symbols = ['M', 'CM', 'D', 'CD', 'C', 'XC', 'L', 'XL', 'X', 'IX', 'V', 'IV', 'I'];
      let result = '';
      for (let i = 0; i < values.length; i++) {
        while (num >= values[i]) {
          result += symbols[i];
          num -= values[i];
        }
      }
      return result;
    }

    // Initialize game
    async function init() {
      await initAuth();
      updateUI();
    }

    init().catch(console.error);
  </script>
</body>
</html>