<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SQL TOWERS</title>
  <link rel="icon" href="https://emojicdn.elk.sh/üèôÔ∏è">
  <meta property="og:title" content="SQL TOWERS">
  <meta property="og:description" content="Write SQL queries, visualize data as glowing towers">
  <meta property="og:image" content="https://app.sloppy.live/sql-towers/og-image.png">
  <meta property="og:url" content="https://app.sloppy.live/sql-towers">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --cyan: #0ff;
      --magenta: #f0f;
      --green: #0f0;
      --yellow: #ff0;
      --orange: #f80;
      --bg: #050510;
    }

    body {
      background: var(--bg);
      min-height: 100vh;
      font-family: 'JetBrains Mono', monospace;
      color: var(--cyan);
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 15px 20px;
      border-bottom: 1px solid #1a1a2e;
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    h1 {
      font-size: 1.5em;
      text-shadow: 0 0 10px var(--cyan), 0 0 20px var(--cyan);
      letter-spacing: 2px;
    }

    .subtitle {
      font-size: 0.8em;
      color: #668;
    }

    main {
      display: grid;
      grid-template-columns: 1fr 1fr;
      flex: 1;
      min-height: 0;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr 1fr;
      }
    }

    .editor-panel {
      display: flex;
      flex-direction: column;
      border-right: 1px solid #1a1a2e;
      overflow: hidden;
    }

    .panel-header {
      padding: 10px 15px;
      background: #0a0a15;
      border-bottom: 1px solid #1a1a2e;
      font-size: 0.85em;
      color: var(--magenta);
    }

    .sql-editor {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    #sqlInput {
      flex: 1;
      background: #0a0a12;
      border: none;
      color: var(--cyan);
      font-family: inherit;
      font-size: 0.9em;
      padding: 15px;
      resize: none;
      outline: none;
    }

    #sqlInput::placeholder {
      color: #446;
    }

    .controls {
      display: flex;
      gap: 10px;
      padding: 10px 15px;
      background: #0a0a15;
      border-top: 1px solid #1a1a2e;
    }

    button {
      background: transparent;
      border: 1px solid var(--cyan);
      color: var(--cyan);
      font-family: inherit;
      font-size: 0.85em;
      padding: 8px 20px;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
    }

    button:hover {
      background: var(--cyan);
      color: #000;
      box-shadow: 0 0 15px var(--cyan);
    }

    .example-btn {
      border-color: var(--magenta);
      color: var(--magenta);
    }

    .example-btn:hover {
      background: var(--magenta);
      box-shadow: 0 0 15px var(--magenta);
    }

    .schema-panel {
      max-height: 200px;
      overflow-y: auto;
      padding: 10px 15px;
      background: #080810;
      border-top: 1px solid #1a1a2e;
      font-size: 0.75em;
    }

    .table-schema {
      margin-bottom: 10px;
    }

    .table-schema h4 {
      color: var(--green);
      margin-bottom: 5px;
    }

    .table-schema span {
      color: #668;
      display: inline-block;
      margin-right: 10px;
    }

    .viz-panel {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #visualization {
      flex: 1;
      position: relative;
      overflow: hidden;
      background: linear-gradient(180deg, #050510 0%, #0a0a20 100%);
    }

    #canvas {
      width: 100%;
      height: 100%;
    }

    .results-panel {
      max-height: 150px;
      overflow-y: auto;
      background: #0a0a12;
      border-top: 1px solid #1a1a2e;
      font-size: 0.75em;
    }

    .results-table {
      width: 100%;
      border-collapse: collapse;
    }

    .results-table th {
      background: #1a1a2e;
      color: var(--magenta);
      padding: 8px 10px;
      text-align: left;
      position: sticky;
      top: 0;
    }

    .results-table td {
      padding: 6px 10px;
      border-bottom: 1px solid #1a1a2e;
      color: var(--cyan);
    }

    .results-table tr:hover td {
      background: rgba(0,255,255,0.05);
    }

    .error {
      color: #f55;
      padding: 15px;
    }

    .message {
      color: #668;
      padding: 15px;
      font-style: italic;
    }

    .tower-info {
      position: absolute;
      bottom: 10px;
      left: 10px;
      font-size: 0.75em;
      color: #668;
      background: rgba(0,0,0,0.7);
      padding: 8px 12px;
      border-radius: 4px;
    }

    .grid-floor {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 100px;
      background:
        linear-gradient(90deg, rgba(0,255,255,0.1) 1px, transparent 1px),
        linear-gradient(0deg, rgba(0,255,255,0.1) 1px, transparent 1px);
      background-size: 40px 40px;
      transform: perspective(500px) rotateX(60deg);
      transform-origin: bottom;
    }

    .backlink {
      position: fixed;
      bottom: 5px;
      right: 10px;
      color: #333;
      text-decoration: none;
      font-size: 0.65em;
      z-index: 100;
    }
  </style>
</head>
<body>
  <header>
    <h1>üèôÔ∏è SQL TOWERS</h1>
    <span class="subtitle">Write queries, build cities</span>
  </header>

  <main>
    <div class="editor-panel">
      <div class="panel-header">// SQL EDITOR</div>
      <div class="sql-editor">
        <textarea id="sqlInput" placeholder="SELECT * FROM sales;

-- Try queries like:
-- SELECT product, revenue FROM sales
-- SELECT category, SUM(units) FROM sales GROUP BY category
-- SELECT * FROM users WHERE score > 50"></textarea>
      </div>
      <div class="controls">
        <button onclick="executeQuery()">‚ñ∂ RUN QUERY</button>
        <button class="example-btn" onclick="loadExample(1)">Example 1</button>
        <button class="example-btn" onclick="loadExample(2)">Example 2</button>
        <button class="example-btn" onclick="loadExample(3)">Example 3</button>
      </div>
      <div class="schema-panel">
        <div class="table-schema">
          <h4>üìä sales</h4>
          <span>id INT</span>
          <span>product TEXT</span>
          <span>category TEXT</span>
          <span>revenue INT</span>
          <span>units INT</span>
        </div>
        <div class="table-schema">
          <h4>üë• users</h4>
          <span>id INT</span>
          <span>name TEXT</span>
          <span>level TEXT</span>
          <span>score INT</span>
          <span>active BOOL</span>
        </div>
        <div class="table-schema">
          <h4>üìà metrics</h4>
          <span>month TEXT</span>
          <span>visits INT</span>
          <span>signups INT</span>
          <span>revenue INT</span>
        </div>
      </div>
    </div>

    <div class="viz-panel">
      <div class="panel-header">// TOWER VISUALIZATION</div>
      <div id="visualization">
        <canvas id="canvas"></canvas>
        <div class="grid-floor"></div>
        <div class="tower-info" id="towerInfo">Run a query to build towers</div>
      </div>
      <div class="results-panel">
        <table class="results-table" id="resultsTable">
          <thead><tr><th>Results will appear here</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>

  <a href="https://sloppy.live" class="backlink">sloppy.live</a>

  <script>
    // Sample database
    const database = {
      sales: [
        { id: 1, product: 'Widget A', category: 'Electronics', revenue: 1200, units: 45 },
        { id: 2, product: 'Widget B', category: 'Electronics', revenue: 800, units: 32 },
        { id: 3, product: 'Gadget X', category: 'Gadgets', revenue: 2100, units: 28 },
        { id: 4, product: 'Gadget Y', category: 'Gadgets', revenue: 1500, units: 41 },
        { id: 5, product: 'Tool Alpha', category: 'Tools', revenue: 950, units: 67 },
        { id: 6, product: 'Tool Beta', category: 'Tools', revenue: 1800, units: 23 },
        { id: 7, product: 'Device Pro', category: 'Electronics', revenue: 3200, units: 18 },
        { id: 8, product: 'Device Lite', category: 'Electronics', revenue: 600, units: 89 },
      ],
      users: [
        { id: 1, name: 'Alice', level: 'Gold', score: 850, active: true },
        { id: 2, name: 'Bob', level: 'Silver', score: 420, active: true },
        { id: 3, name: 'Charlie', level: 'Bronze', score: 180, active: false },
        { id: 4, name: 'Diana', level: 'Gold', score: 920, active: true },
        { id: 5, name: 'Eve', level: 'Silver', score: 550, active: true },
        { id: 6, name: 'Frank', level: 'Bronze', score: 90, active: false },
        { id: 7, name: 'Grace', level: 'Gold', score: 780, active: true },
        { id: 8, name: 'Hank', level: 'Silver', score: 340, active: true },
      ],
      metrics: [
        { month: 'Jan', visits: 12000, signups: 340, revenue: 45000 },
        { month: 'Feb', visits: 15000, signups: 420, revenue: 52000 },
        { month: 'Mar', visits: 18000, signups: 510, revenue: 61000 },
        { month: 'Apr', visits: 14000, signups: 380, revenue: 48000 },
        { month: 'May', visits: 21000, signups: 620, revenue: 78000 },
        { month: 'Jun', visits: 25000, signups: 750, revenue: 92000 },
      ]
    };

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const towerInfo = document.getElementById('towerInfo');
    const resultsTable = document.getElementById('resultsTable');

    let towers = [];
    let animationFrame = null;
    let hoverTower = null;

    function resize() {
      const container = document.getElementById('visualization');
      canvas.width = container.clientWidth * 2;
      canvas.height = container.clientHeight * 2;
      ctx.scale(2, 2);
      draw();
    }
    resize();
    window.addEventListener('resize', resize);

    // Simple SQL parser
    function parseSQL(sql) {
      sql = sql.trim().replace(/;$/, '').replace(/\s+/g, ' ');

      const selectMatch = sql.match(/^SELECT\s+(.+?)\s+FROM\s+(\w+)(?:\s+WHERE\s+(.+?))?(?:\s+GROUP\s+BY\s+(.+?))?(?:\s+ORDER\s+BY\s+(.+?))?(?:\s+LIMIT\s+(\d+))?$/i);

      if (!selectMatch) {
        throw new Error('Invalid SQL syntax. Use: SELECT columns FROM table [WHERE condition] [GROUP BY column]');
      }

      const [_, columnsStr, tableName, whereClause, groupBy, orderBy, limit] = selectMatch;

      if (!database[tableName.toLowerCase()]) {
        throw new Error(`Table "${tableName}" not found. Available: sales, users, metrics`);
      }

      let data = [...database[tableName.toLowerCase()]];

      // WHERE clause
      if (whereClause) {
        data = applyWhere(data, whereClause);
      }

      // Parse columns
      const columns = parseColumns(columnsStr.trim());

      // GROUP BY
      if (groupBy) {
        data = applyGroupBy(data, columns, groupBy.trim());
      }

      // SELECT columns
      data = applySelect(data, columns);

      // ORDER BY
      if (orderBy) {
        data = applyOrderBy(data, orderBy.trim());
      }

      // LIMIT
      if (limit) {
        data = data.slice(0, parseInt(limit));
      }

      return { data, columns: Object.keys(data[0] || {}) };
    }

    function parseColumns(str) {
      if (str === '*') return ['*'];

      const columns = [];
      const parts = str.split(',').map(s => s.trim());

      for (const part of parts) {
        const aggMatch = part.match(/^(SUM|COUNT|AVG|MAX|MIN)\((\w+|\*)\)$/i);
        if (aggMatch) {
          columns.push({ agg: aggMatch[1].toUpperCase(), col: aggMatch[2] });
        } else {
          columns.push({ col: part });
        }
      }

      return columns;
    }

    function applyWhere(data, clause) {
      // Simple comparison parsing
      const match = clause.match(/^(\w+)\s*(=|!=|>|<|>=|<=|LIKE)\s*['"]?([^'"]+)['"]?$/i);
      if (!match) return data;

      const [_, col, op, val] = match;

      return data.filter(row => {
        const rowVal = row[col];
        const compareVal = isNaN(val) ? val : parseFloat(val);

        switch(op.toUpperCase()) {
          case '=': return rowVal == compareVal;
          case '!=': return rowVal != compareVal;
          case '>': return rowVal > compareVal;
          case '<': return rowVal < compareVal;
          case '>=': return rowVal >= compareVal;
          case '<=': return rowVal <= compareVal;
          case 'LIKE': return String(rowVal).toLowerCase().includes(String(compareVal).toLowerCase());
          default: return true;
        }
      });
    }

    function applyGroupBy(data, columns, groupCol) {
      const groups = {};

      for (const row of data) {
        const key = row[groupCol];
        if (!groups[key]) groups[key] = [];
        groups[key].push(row);
      }

      return Object.entries(groups).map(([key, rows]) => {
        const result = { [groupCol]: key };

        for (const col of columns) {
          if (col.agg) {
            const values = rows.map(r => r[col.col]).filter(v => typeof v === 'number');
            switch(col.agg) {
              case 'SUM': result[`SUM(${col.col})`] = values.reduce((a,b) => a+b, 0); break;
              case 'COUNT': result[`COUNT(${col.col})`] = col.col === '*' ? rows.length : values.length; break;
              case 'AVG': result[`AVG(${col.col})`] = Math.round(values.reduce((a,b) => a+b, 0) / values.length); break;
              case 'MAX': result[`MAX(${col.col})`] = Math.max(...values); break;
              case 'MIN': result[`MIN(${col.col})`] = Math.min(...values); break;
            }
          }
        }

        return result;
      });
    }

    function applySelect(data, columns) {
      if (columns.length === 1 && columns[0] === '*') return data;
      if (columns.some(c => c.agg)) return data; // Already processed by GROUP BY

      return data.map(row => {
        const result = {};
        for (const col of columns) {
          if (row.hasOwnProperty(col.col)) {
            result[col.col] = row[col.col];
          }
        }
        return result;
      });
    }

    function applyOrderBy(data, clause) {
      const desc = clause.toUpperCase().includes(' DESC');
      const col = clause.replace(/\s+(ASC|DESC)$/i, '').trim();

      return [...data].sort((a, b) => {
        const av = a[col], bv = b[col];
        const cmp = typeof av === 'string' ? av.localeCompare(bv) : av - bv;
        return desc ? -cmp : cmp;
      });
    }

    function executeQuery() {
      const sql = document.getElementById('sqlInput').value;

      try {
        const { data, columns } = parseSQL(sql);
        displayResults(data, columns);
        buildTowers(data, columns);
      } catch (e) {
        resultsTable.innerHTML = `<tr><td class="error">‚ùå ${e.message}</td></tr>`;
        towers = [];
        draw();
        towerInfo.textContent = 'Query error';
      }
    }

    function displayResults(data, columns) {
      if (data.length === 0) {
        resultsTable.innerHTML = '<tr><td class="message">No results</td></tr>';
        return;
      }

      let html = '<thead><tr>';
      columns.forEach(col => html += `<th>${col}</th>`);
      html += '</tr></thead><tbody>';

      data.forEach(row => {
        html += '<tr>';
        columns.forEach(col => html += `<td>${row[col] ?? ''}</td>`);
        html += '</tr>';
      });

      html += '</tbody>';
      resultsTable.innerHTML = html;
    }

    const COLORS = ['#0ff', '#f0f', '#0f0', '#ff0', '#f80', '#80f', '#0f8', '#f08'];

    function buildTowers(data, columns) {
      towers = [];

      // Find numeric columns for height
      const numericCols = columns.filter(col =>
        data.some(row => typeof row[col] === 'number')
      );

      if (numericCols.length === 0) {
        // Use row index as height
        data.forEach((row, i) => {
          towers.push({
            label: Object.values(row)[0] || `Row ${i+1}`,
            height: 50 + i * 30,
            color: COLORS[i % COLORS.length],
            data: row
          });
        });
      } else {
        // Use first numeric column as height
        const heightCol = numericCols[0];
        const labelCol = columns.find(c => c !== heightCol) || heightCol;
        const maxVal = Math.max(...data.map(r => r[heightCol]));

        data.forEach((row, i) => {
          const normalizedHeight = (row[heightCol] / maxVal) * 250 + 30;
          towers.push({
            label: String(row[labelCol]),
            value: row[heightCol],
            height: normalizedHeight,
            color: COLORS[i % COLORS.length],
            data: row
          });
        });
      }

      towerInfo.textContent = `${towers.length} towers built from ${columns.length} columns`;
      startAnimation();
    }

    let time = 0;
    function startAnimation() {
      if (animationFrame) cancelAnimationFrame(animationFrame);

      function animate() {
        time += 0.02;
        draw();
        animationFrame = requestAnimationFrame(animate);
      }
      animate();
    }

    function draw() {
      const w = canvas.width / 2;
      const h = canvas.height / 2;

      ctx.fillStyle = '#050510';
      ctx.fillRect(0, 0, w, h);

      if (towers.length === 0) return;

      const towerWidth = Math.min(60, (w - 100) / towers.length);
      const gap = 10;
      const totalWidth = towers.length * (towerWidth + gap) - gap;
      const startX = (w - totalWidth) / 2;
      const baseY = h - 80;

      towers.forEach((tower, i) => {
        const x = startX + i * (towerWidth + gap);
        const animHeight = tower.height * (1 + Math.sin(time + i * 0.5) * 0.05);

        drawTower(x, baseY, towerWidth, animHeight, tower.color, tower.label, i === hoverTower);
      });
    }

    function drawTower(x, baseY, width, height, color, label, isHover) {
      const depth = 15;

      // Glow
      ctx.shadowColor = color;
      ctx.shadowBlur = isHover ? 30 : 15;

      // Front face
      ctx.fillStyle = color;
      ctx.globalAlpha = 0.8;
      ctx.fillRect(x, baseY - height, width, height);

      // Top face (lighter)
      ctx.fillStyle = color;
      ctx.globalAlpha = 0.4;
      ctx.beginPath();
      ctx.moveTo(x, baseY - height);
      ctx.lineTo(x + depth, baseY - height - depth);
      ctx.lineTo(x + width + depth, baseY - height - depth);
      ctx.lineTo(x + width, baseY - height);
      ctx.closePath();
      ctx.fill();

      // Right face (darker)
      ctx.fillStyle = color;
      ctx.globalAlpha = 0.3;
      ctx.beginPath();
      ctx.moveTo(x + width, baseY - height);
      ctx.lineTo(x + width + depth, baseY - height - depth);
      ctx.lineTo(x + width + depth, baseY - depth);
      ctx.lineTo(x + width, baseY);
      ctx.closePath();
      ctx.fill();

      // Grid lines on front
      ctx.strokeStyle = color;
      ctx.globalAlpha = 0.3;
      ctx.lineWidth = 1;
      const gridSize = 20;
      for (let gy = baseY - gridSize; gy > baseY - height; gy -= gridSize) {
        ctx.beginPath();
        ctx.moveTo(x, gy);
        ctx.lineTo(x + width, gy);
        ctx.stroke();
      }

      ctx.globalAlpha = 1;
      ctx.shadowBlur = 0;

      // Label
      ctx.fillStyle = '#fff';
      ctx.font = '10px JetBrains Mono';
      ctx.textAlign = 'center';
      ctx.fillText(label.substring(0, 8), x + width/2, baseY + 15);
    }

    // Mouse hover
    canvas.addEventListener('mousemove', e => {
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) * 2;
      const w = canvas.width / 2;

      if (towers.length === 0) return;

      const towerWidth = Math.min(60, (w - 100) / towers.length);
      const gap = 10;
      const totalWidth = towers.length * (towerWidth + gap) - gap;
      const startX = (w - totalWidth) / 2;

      hoverTower = null;
      towers.forEach((tower, i) => {
        const tx = startX + i * (towerWidth + gap);
        if (x >= tx && x <= tx + towerWidth) {
          hoverTower = i;
          const vals = Object.entries(tower.data).map(([k,v]) => `${k}: ${v}`).join(', ');
          towerInfo.textContent = vals;
        }
      });
    });

    const examples = [
      "SELECT product, revenue FROM sales ORDER BY revenue DESC",
      "SELECT category, SUM(revenue) FROM sales GROUP BY category",
      "SELECT month, visits, signups FROM metrics"
    ];

    function loadExample(n) {
      document.getElementById('sqlInput').value = examples[n-1];
      executeQuery();
    }

    // Run initial example
    loadExample(1);

    // Keyboard shortcut
    document.getElementById('sqlInput').addEventListener('keydown', e => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        executeQuery();
      }
    });
  </script>
<script src="/sloppy-header/sloppy-bar.js"></script>
<script src="/vibelib-extended.js"></script>
<script>
  // Compatibility Patch for Legacy Apps
  window.addEventListener("load", () => {
    if (window.SloppyKarma && window.VibeLib.Economy) {
      // Redirect old calls to new engine
      window.SloppyKarma.track = window.VibeLib.Economy.track;
    }
  });
</script>
</body>
</html>
