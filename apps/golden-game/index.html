<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Golden Game â€” Premium Only</title>

    <!-- Open Graph / Twitter -->
    <meta property="og:title" content="Golden Game â€” Premium Only" />
    <meta property="og:description" content="Tap the golden coin, climb the leaderboard. Premium members only." />
    <meta property="og:image" content="./og.svg" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Golden Game â€” Premium Only" />
    <meta name="twitter:description" content="Tap the golden coin, climb the leaderboard. Premium members only." />
    <meta name="twitter:image" content="./og.svg" />

    <!-- Favicon: inline crown emoji as SVG -->
    <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="0.9em" font-size="90">ðŸ‘‘</text></svg>' />

    <style>
      :root {
        --gold: #ffd700;
        --gold-deep: #c9a400;
        --bg: #0b0b0b;
        --text: #f8f6ef;
        --muted: #b8b6ad;
        --card: #141414;
        --accent: #1f1f1f;
      }
      html, body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        color: var(--text);
        background: radial-gradient(1200px 800px at 50% -20%, #1b1b1b 0%, #0b0b0b 55%);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .wrap {
        width: min(920px, 96vw);
        padding: 24px;
      }
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 16px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 700;
      }
      .brand .logo {
        width: 28px; height: 28px;
        display: grid; place-items: center;
        background: linear-gradient(135deg, var(--gold), var(--gold-deep));
        border-radius: 8px;
        box-shadow: 0 0 0 2px #000 inset, 0 6px 18px rgba(0,0,0,0.35);
      }
      .card {
        background: linear-gradient(180deg, rgba(255,215,0,0.06), rgba(255,215,0,0.02));
        border: 1px solid #2a2a2a;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.03);
        padding: 20px;
      }
      .row {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
      }
      @media (min-width: 860px) {
        .row { grid-template-columns: 1.2fr 1fr; }
      }
      .coin-area {
        display: grid; place-items: center;
        padding: 16px;
        min-height: 360px;
      }
      .coin {
        width: clamp(120px, 28vw, 220px);
        height: clamp(120px, 28vw, 220px);
        border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, #fff7b2 0%, var(--gold) 35%, var(--gold-deep) 70%, #7a6400 100%);
        box-shadow: 0 12px 28px rgba(0,0,0,0.45), inset 0 3px 8px rgba(255,255,255,0.45), inset 0 -6px 16px rgba(0,0,0,0.25);
        display: grid; place-items: center;
        cursor: pointer;
        transition: transform 80ms ease, filter 120ms ease;
        user-select: none; -webkit-user-select: none;
      }
      .coin:active { transform: scale(0.96); filter: brightness(1.05); }
      .hud {
        display: flex; align-items: center; justify-content: center; gap: 16px;
        flex-wrap: wrap;
        margin-top: 10px;
      }
      .hud .pill {
        background: #111;
        border: 1px solid #2a2a2a;
        border-radius: 999px;
        padding: 8px 14px;
        font-weight: 600;
      }
      .btn {
        border: 1px solid #3a3a3a;
        background: linear-gradient(180deg, #222, #161616);
        color: var(--text);
        padding: 10px 14px;
        border-radius: 10px;
        cursor: pointer;
      }
      .btn.gold {
        border-color: #5a4a00;
        background: linear-gradient(180deg, #ffdf5a, #e7c31f);
        color: #000;
        font-weight: 800;
        text-shadow: 0 1px 0 rgba(255,255,255,0.5);
      }
      .stack { display: grid; gap: 8px; }
      .muted { color: var(--muted); }
      .link { color: var(--gold); text-decoration: none; }

      .paywall {
        display: grid; gap: 12px;
        text-align: center;
        padding: 24px;
        border: 1px dashed #3a3a3a;
        border-radius: 12px;
        background: #0f0f0f;
      }
      .leaderboard ol { margin: 0; padding-left: 18px; }
      .leaderboard li { padding: 4px 0; }
      footer { margin-top: 18px; text-align: center; font-size: 14px; color: var(--muted); }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div class="brand">
          <div class="logo"> </div>
          <div>Golden Game</div>
        </div>
        <div class="stack" style="align-items:end;">
          <div id="auth-status" class="muted">Checking sessionâ€¦</div>
          <div style="display:flex; gap:8px;">
            <button id="signin" class="btn" style="display:none">Sign in with Twitter</button>
            <button id="signout" class="btn" style="display:none">Sign out</button>
          </div>
        </div>
      </header>

      <div class="row">
        <section class="card">
          <div id="game-section" style="display:none">
            <h2>Tap the Coin</h2>
            <div class="coin-area">
              <div id="coin" class="coin" aria-label="Golden coin" title="Tap!">ðŸ’°</div>
            </div>
            <div class="hud">
              <div class="pill">Time: <span id="time">20</span>s</div>
              <div class="pill">Score: <span id="score">0</span></div>
              <div class="pill">Best: <span id="best">0</span></div>
              <button id="start" class="btn gold">Start</button>
            </div>
            <p class="muted" style="text-align:center">Premium perk: results save to the global leaderboard.</p>
          </div>

          <div id="paywall" class="paywall" style="display:none">
            <h2>Premium Only</h2>
            <p>Golden Game is for premium members. Sign in and upgrade to play and compete on the leaderboard.</p>
            <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
              <button id="paywall-signin" class="btn">Sign in</button>
              <a class="btn gold" href="https://www.vibecodedbyx.com" target="_blank" rel="noopener">Become Premium</a>
            </div>
            <p class="muted">Already premium? Sign in so we can verify.</p>
          </div>
        </section>

        <aside class="card leaderboard">
          <h3>Top Scores</h3>
          <ol id="leaders"></ol>
          <p class="muted">Scores update live for all players.</p>
        </aside>
      </div>

      <footer>
        <a class="link" href="https://www.vibecodedbyx.com" target="_blank" rel="noopener">Back to the livestream</a>
      </footer>
    </div>

    <script type="module">
      import supabase, { supabaseSession, isUserPremium } from "./supabase-config.js";

      const els = {
        authStatus: document.getElementById('auth-status'),
        signin: document.getElementById('signin'),
        signout: document.getElementById('signout'),
        paywallSignin: document.getElementById('paywall-signin'),
        game: document.getElementById('game-section'),
        paywall: document.getElementById('paywall'),
        coin: document.getElementById('coin'),
        start: document.getElementById('start'),
        time: document.getElementById('time'),
        score: document.getElementById('score'),
        best: document.getElementById('best'),
        leaders: document.getElementById('leaders'),
      };

      let state = {
        session: null,
        user: null,
        premium: false,
        running: false,
        score: 0,
        best: 0,
        timeLeft: 20,
        timerId: null,
      };

      function fmtUser(u) {
        if (!u) return 'anon';
        return 'â€¦' + String(u).slice(-6);
      }

      async function loadBest() {
        if (!state.user) return 0;
        const { data, error } = await supabase
          .from('golden_game_scores')
          .select('score')
          .eq('user_id', state.user.id)
          .single();
        if (error) {
          // PGRST116: No rows returned (i.e., user has no score yet)
          if (error.code !== 'PGRST116') console.error('Best load error:', error.message);
          return 0;
        }
        return (data && typeof data.score === 'number') ? data.score : 0;
      }

      async function saveBestIfImproved() {
        if (!state.user) return;
        try {
          const nextBest = Math.max(state.best || 0, state.score || 0);
          const { error } = await supabase
            .from('golden_game_scores')
            .upsert({ user_id: state.user.id, score: nextBest }, { onConflict: 'user_id' });
          if (error) console.error('Save error:', error.message);
          state.best = nextBest;
          els.best.textContent = String(state.best);
          await refreshLeaders();
        } catch (e) {
          console.error('Save exception:', e);
        }
      }

      async function refreshLeaders() {
        const { data, error } = await supabase
          .from('golden_game_scores')
          .select('score, user_id')
          .order('score', { ascending: false })
          .limit(10);
        if (error) { console.error('Leaders error:', error.message); return; }
        els.leaders.innerHTML = (data || [])
          .map((r, i) => `<li>#${i+1} <strong>${r.score}</strong> â€” ${fmtUser(r.user_id)}</li>`) 
          .join('');
      }

      function setRunning(running) {
        state.running = running;
        els.start.disabled = running;
        els.coin.style.opacity = running ? '1' : '0.9';
      }

      function resetGame() {
        state.score = 0;
        state.timeLeft = 20;
        els.score.textContent = '0';
        els.time.textContent = '20';
        setRunning(false);
      }

      async function startGame() {
        if (!state.premium) return; // extra guard
        resetGame();
        setRunning(true);
        state.timerId = setInterval(async () => {
          state.timeLeft -= 1;
          els.time.textContent = String(state.timeLeft);
          if (state.timeLeft <= 0) {
            clearInterval(state.timerId);
            setRunning(false);
            await saveBestIfImproved();
          }
        }, 1000);
      }

      function coinTap() {
        if (!state.running) return;
        state.score += 1;
        els.score.textContent = String(state.score);
        // tiny sparkle
        els.coin.animate([
          { transform: 'translateY(0)' },
          { transform: 'translateY(-6px)' },
          { transform: 'translateY(0)' },
        ], { duration: 120, easing: 'ease-out' });
      }

      async function wireAuthUI() {
        els.signin.onclick = async () => {
          await supabase.auth.signInWithOAuth({ provider: 'twitter', options: { redirectTo: window.location.href } });
        };
        els.paywallSignin.onclick = els.signin.onclick;
        els.signout.onclick = async () => {
          await supabase.auth.signOut();
          window.location.reload();
        };
      }

      async function gateAndRender() {
        try {
          const { session, user } = await supabaseSession();
          state.session = session; state.user = user;
          const premium = await isUserPremium();
          state.premium = premium;

          els.authStatus.textContent = premium
            ? `Premium âœ“ (${fmtUser(user?.id)})`
            : `Not premium (${fmtUser(user?.id)})`;
          // Always allow sign-in (even if anonymously signed in)
          els.signin.style.display = !premium ? 'inline-block' : 'none';
          els.signout.style.display = 'inline-block';

          if (premium) {
            els.game.style.display = '';
            els.paywall.style.display = 'none';
            state.best = await loadBest();
            els.best.textContent = String(state.best);
          } else {
            els.game.style.display = 'none';
            els.paywall.style.display = '';
          }

          await refreshLeaders();
        } catch (e) {
          console.error('Init error:', e);
          els.authStatus.textContent = 'Error loading session';
        }
      }

      // Live updates for leaderboard
      supabase
        .channel('golden_game_scores')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'golden_game_scores' }, refreshLeaders)
        .subscribe();

      els.start.addEventListener('click', startGame);
      els.coin.addEventListener('click', coinTap);

      await wireAuthUI();
      await gateAndRender();
    </script>
  </body>
</html>
