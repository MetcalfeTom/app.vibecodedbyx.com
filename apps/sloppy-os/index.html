<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SloppyOS</title>
  <link rel="icon" href="https://emojicdn.elk.sh/üíæ">
  <meta property="og:title" content="SloppyOS">
  <meta property="og:description" content="Explore the neon mansion hallway - each door leads to a new world">
  <meta property="og:url" content="https://sloppy.live/sloppy-os">
  <meta property="og:image" content="https://emojicdn.elk.sh/üíæ?style=apple&size=512">
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #000; overflow: hidden; font-family: 'Share Tech Mono', monospace; }
    #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
    canvas { display: block; }

    .boot-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #000; display: flex; flex-direction: column;
      align-items: center; justify-content: center; z-index: 10000;
      transition: opacity 0.5s, visibility 0.5s;
    }
    .boot-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
    .boot-logo {
      font-family: 'Orbitron', sans-serif; font-size: 2.5rem; font-weight: 900;
      color: #00ffff; text-shadow: 0 0 20px #00ffff, 0 0 40px #ff00ff;
      animation: pulse 1s ease-in-out infinite;
    }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .boot-text { margin-top: 30px; color: #00ff88; font-size: 0.9rem; }
    .boot-progress { width: 300px; height: 4px; background: rgba(0,255,255,0.2); margin-top: 20px; border-radius: 2px; overflow: hidden; }
    .boot-progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #00ffff, #ff00ff); transition: width 0.1s; }

    .hud { position: fixed; top: 0; left: 0; width: 100%; pointer-events: none; z-index: 100; }
    .hud-top { position: absolute; top: 15px; left: 20px; right: 20px; display: flex; justify-content: space-between; }
    .os-logo { font-family: 'Orbitron'; font-weight: 700; font-size: 1rem; color: #00ffff; text-shadow: 0 0 10px #00ffff; }
    .clock { color: #ffff00; font-family: 'Orbitron'; font-weight: 700; text-shadow: 0 0 10px #ffff00; }

    .crosshair {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 20px; height: 20px; border: 2px solid #00ffff; border-radius: 50%;
      opacity: 0.7; box-shadow: 0 0 10px #00ffff; z-index: 100; pointer-events: none;
    }
    .crosshair::before, .crosshair::after { content: ''; position: absolute; background: #00ffff; box-shadow: 0 0 5px #00ffff; }
    .crosshair::before { width: 2px; height: 6px; top: 50%; left: 50%; transform: translate(-50%, -50%); }
    .crosshair::after { width: 6px; height: 2px; top: 50%; left: 50%; transform: translate(-50%, -50%); }

    .app-info {
      position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
      background: rgba(10,10,25,0.95); border: 2px solid #00ffff; border-radius: 10px;
      padding: 15px 30px; text-align: center; z-index: 100; opacity: 0;
      transition: opacity 0.2s; pointer-events: none;
    }
    .app-info.visible { opacity: 1; }
    .app-info h3 { font-family: 'Orbitron'; color: #00ffff; font-size: 1.2rem; text-shadow: 0 0 10px #00ffff; margin-bottom: 5px; }
    .app-info p { color: #aaa; font-size: 0.85rem; }

    .stream-link-btn {
      position: fixed; top: 15px; right: 20px; display: flex; align-items: center; gap: 8px;
      padding: 10px 18px; background: linear-gradient(135deg, #9146ff, #772ce8);
      border: 2px solid #9146ff; border-radius: 25px; color: #fff; text-decoration: none;
      font-family: 'Orbitron'; font-size: 0.8rem; font-weight: 700; z-index: 200;
      pointer-events: auto; transition: all 0.3s; box-shadow: 0 0 20px rgba(145,70,255,0.4);
    }
    .stream-link-btn:hover { transform: scale(1.05); box-shadow: 0 0 35px rgba(145,70,255,0.7); }
    .stream-pulse { position: absolute; top: -3px; right: -3px; width: 10px; height: 10px; background: #ff0044; border-radius: 50%; animation: live-pulse 1.5s ease-in-out infinite; }
    @keyframes live-pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.7; } }

    .pet-container { position: fixed; bottom: 20px; right: 20px; z-index: 200; pointer-events: auto; }
    .pet-btn { width: 60px; height: 60px; background: rgba(10,10,25,0.9); border: 2px solid #ff00ff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; cursor: pointer; transition: all 0.3s; box-shadow: 0 0 20px rgba(255,0,255,0.4); animation: pet-float 3s ease-in-out infinite; }
    @keyframes pet-float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    .pet-btn:hover { transform: scale(1.1); box-shadow: 0 0 30px rgba(255,0,255,0.6); }
    .pet-popup { position: absolute; bottom: 70px; right: 0; background: rgba(10,10,25,0.98); border: 2px solid #ff00ff; border-radius: 15px; padding: 20px; min-width: 180px; text-align: center; display: none; box-shadow: 0 0 30px rgba(255,0,255,0.4); }
    .pet-popup.open { display: block; }
    .pet-popup h3 { font-family: 'Orbitron'; color: #ff00ff; font-size: 0.9rem; margin-bottom: 10px; }
    .pet-display { font-size: 2.5rem; margin: 10px 0; }
    .pet-status { font-size: 0.75rem; color: #00ffff; }
    .pet-actions { display: flex; gap: 8px; justify-content: center; margin-top: 12px; }
    .pet-action-btn { padding: 6px 12px; background: linear-gradient(135deg, #00ffff, #ff00ff); border: none; border-radius: 15px; color: #000; font-size: 0.7rem; cursor: pointer; transition: all 0.2s; }
    .pet-action-btn:hover { transform: scale(1.1); }

    .instructions { position: fixed; bottom: 20px; left: 20px; color: #666; font-size: 0.75rem; z-index: 100; pointer-events: none; }
    .instructions span { color: #00ffff; }

    .click-to-start { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 500; cursor: pointer; }
    .click-to-start.hidden { display: none; }
    .click-to-start h2 { font-family: 'Orbitron'; color: #00ffff; font-size: 2rem; text-shadow: 0 0 20px #00ffff; animation: pulse 1s ease-in-out infinite; }
    .click-to-start p { color: #888; margin-top: 15px; }

    .mobile-controls { display: none; position: fixed; bottom: 20px; left: 20px; z-index: 200; pointer-events: auto; gap: 10px; }
    @media (max-width: 768px) { .mobile-controls { display: flex; } .instructions { display: none; } }
    .mobile-btn { width: 50px; height: 50px; background: rgba(0,255,255,0.2); border: 2px solid #00ffff; border-radius: 10px; color: #00ffff; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; }

    .scanlines { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; background: repeating-linear-gradient(0deg, rgba(0,0,0,0.05) 0px, rgba(0,0,0,0.05) 1px, transparent 1px, transparent 2px); }
  </style>
</head>
<body>
  <div class="boot-screen" id="boot-screen">
    <div class="boot-logo">SloppyOS Mansion</div>
    <div class="boot-text" id="boot-text">Initializing hallway...</div>
    <div class="boot-progress"><div class="boot-progress-fill" id="boot-progress"></div></div>
  </div>

  <div class="click-to-start hidden" id="click-to-start">
    <h2>ENTER THE MANSION</h2>
    <p>WASD to walk, Mouse to look, Click doors to enter</p>
  </div>

  <div id="canvas-container"></div>
  <div class="scanlines"></div>

  <div class="hud">
    <div class="hud-top">
      <div class="os-logo">üíæ SloppyOS Mansion</div>
      <div class="clock" id="clock">00:00:00</div>
    </div>
  </div>

  <div class="crosshair"></div>

  <div class="app-info" id="app-info">
    <h3 id="app-name">App Name</h3>
    <p>Click to enter</p>
  </div>

  <a href="https://twitch.tv/sloppy_ai" target="_blank" class="stream-link-btn">
    <span class="stream-pulse"></span><span>üì°</span><span>LIVE</span>
  </a>

  <div class="pet-container">
    <div class="pet-btn" id="pet-btn">ü•ö</div>
    <div class="pet-popup" id="pet-popup">
      <h3>Virtual Pet</h3>
      <div class="pet-display" id="pet-display">ü•ö</div>
      <div class="pet-status" id="pet-status">Click to hatch!</div>
      <div class="pet-actions">
        <button class="pet-action-btn" id="pet-interact">ü§ö Pet</button>
        <button class="pet-action-btn" id="pet-feed">üçï Feed</button>
      </div>
    </div>
  </div>

  <div class="instructions"><span>WASD</span> Walk | <span>Mouse</span> Look | <span>Click</span> Enter Door</div>

  <div class="mobile-controls">
    <div class="mobile-btn" id="mobile-forward">‚Üë</div>
    <div class="mobile-btn" id="mobile-left">‚Üê</div>
    <div class="mobile-btn" id="mobile-right">‚Üí</div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
    // Apps for left and right doors
    const leftDoors = [
      { name: 'Space Flight', icon: 'üöÄ', url: '/space-flight', color: 0x00ffff },
      { name: 'Moon Explorer', icon: 'üåô', url: '/moon-explorer', color: 0xaaaaff },
      { name: 'Minecraft', icon: '‚õèÔ∏è', url: '/minecraft', color: 0x00ff00 },
      { name: 'Doom 3D', icon: 'üëπ', url: '/doom-3d', color: 0xff0044 },
      { name: 'Motorbike Racing', icon: 'üèçÔ∏è', url: '/motorbike-racing', color: 0xff6600 },
      { name: 'Neon Bowling', icon: 'üé≥', url: '/neon-bowling', color: 0xff00ff }
    ];

    const rightDoors = [
      { name: 'Voxel World', icon: 'üß±', url: '/voxel-world', color: 0x00ff88 },
      { name: 'Disco Ball', icon: 'ü™©', url: '/disco-ball', color: 0xffff00 },
      { name: 'Space Chess', icon: '‚ôüÔ∏è', url: '/space-chess', color: 0x4488ff },
      { name: 'Bikini Brawl', icon: 'ü•ä', url: '/bikini-bottom-brawl', color: 0xffaa00 },
      { name: 'Eggcraft', icon: 'ü•ö', url: '/eggcraft', color: 0xffddaa },
      { name: 'Sneaker Room', icon: 'üëü', url: null, color: 0xff00ff, special: 'sneakers' }
    ];

    let scene, camera, renderer, raycaster;
    let doors = [];
    let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
    let velocity = new THREE.Vector3();
    let direction = new THREE.Vector3();
    let isLocked = false;
    let euler = new THREE.Euler(0, 0, 0, 'YXZ');
    const PI_2 = Math.PI / 2;

    // Room state
    let currentRoom = 'hallway';
    let hallwayObjects = [];
    let sneakerRoomObjects = [];
    let sneakers = [];
    let exitPortal = null;

    const hallwayLength = 80;
    const hallwayWidth = 8;
    const hallwayHeight = 6;
    const doorSpacing = 12;

    function init() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x050510);
      scene.fog = new THREE.FogExp2(0x050510, 0.015);

      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(0, 1.7, hallwayLength / 2 - 5);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      document.getElementById('canvas-container').appendChild(renderer.domElement);

      raycaster = new THREE.Raycaster();

      createHallway();
      createDoors();
      createSneakerRoom();
      createAmbientLights();

      window.addEventListener('resize', onResize);
      document.addEventListener('keydown', onKeyDown);
      document.addEventListener('keyup', onKeyUp);
      document.addEventListener('click', onClick);
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('pointerlockchange', onPointerLockChange);
      setupMobileControls();

      animate();
    }

    function createHallway() {
      const group = new THREE.Group();

      // Floor
      const floorGeo = new THREE.PlaneGeometry(hallwayWidth, hallwayLength);
      const floorMat = new THREE.MeshBasicMaterial({ color: 0x0a0a15 });
      const floor = new THREE.Mesh(floorGeo, floorMat);
      floor.rotation.x = -Math.PI / 2;
      group.add(floor);

      // Floor grid
      const gridMat = new THREE.LineBasicMaterial({ color: 0x00ffff, transparent: true, opacity: 0.2 });
      const gridGeo = new THREE.BufferGeometry();
      const pts = [];
      for (let x = -hallwayWidth/2; x <= hallwayWidth/2; x += 1) {
        pts.push(x, 0.01, -hallwayLength/2, x, 0.01, hallwayLength/2);
      }
      for (let z = -hallwayLength/2; z <= hallwayLength/2; z += 1) {
        pts.push(-hallwayWidth/2, 0.01, z, hallwayWidth/2, 0.01, z);
      }
      gridGeo.setAttribute('position', new THREE.Float32BufferAttribute(pts, 3));
      group.add(new THREE.LineSegments(gridGeo, gridMat));

      // Ceiling
      const ceilGeo = new THREE.PlaneGeometry(hallwayWidth, hallwayLength);
      const ceilMat = new THREE.MeshBasicMaterial({ color: 0x0a0a18, side: THREE.DoubleSide });
      const ceiling = new THREE.Mesh(ceilGeo, ceilMat);
      ceiling.rotation.x = Math.PI / 2;
      ceiling.position.y = hallwayHeight;
      group.add(ceiling);

      // Walls
      const wallMat = new THREE.MeshBasicMaterial({ color: 0x0f0f20, side: THREE.DoubleSide });

      const leftWall = new THREE.Mesh(new THREE.PlaneGeometry(hallwayLength, hallwayHeight), wallMat);
      leftWall.rotation.y = Math.PI / 2;
      leftWall.position.set(-hallwayWidth/2, hallwayHeight/2, 0);
      group.add(leftWall);

      const rightWall = new THREE.Mesh(new THREE.PlaneGeometry(hallwayLength, hallwayHeight), wallMat);
      rightWall.rotation.y = -Math.PI / 2;
      rightWall.position.set(hallwayWidth/2, hallwayHeight/2, 0);
      group.add(rightWall);

      // End walls
      const endWall1 = new THREE.Mesh(new THREE.PlaneGeometry(hallwayWidth, hallwayHeight), wallMat);
      endWall1.position.set(0, hallwayHeight/2, -hallwayLength/2);
      group.add(endWall1);

      const endWall2 = new THREE.Mesh(new THREE.PlaneGeometry(hallwayWidth, hallwayHeight), wallMat);
      endWall2.rotation.y = Math.PI;
      endWall2.position.set(0, hallwayHeight/2, hallwayLength/2);
      group.add(endWall2);

      // Neon strips along ceiling
      const stripColors = [0x00ffff, 0xff00ff];
      stripColors.forEach((color, i) => {
        const stripGeo = new THREE.BoxGeometry(0.1, 0.1, hallwayLength);
        const stripMat = new THREE.MeshBasicMaterial({ color });
        const strip = new THREE.Mesh(stripGeo, stripMat);
        strip.position.set((i === 0 ? -1 : 1) * (hallwayWidth/2 - 0.5), hallwayHeight - 0.1, 0);
        group.add(strip);
      });

      // Center ceiling strip
      const centerStrip = new THREE.Mesh(
        new THREE.BoxGeometry(0.15, 0.1, hallwayLength),
        new THREE.MeshBasicMaterial({ color: 0x00ff88 })
      );
      centerStrip.position.set(0, hallwayHeight - 0.1, 0);
      group.add(centerStrip);

      scene.add(group);
      hallwayObjects.push(group);
    }

    function createDoors() {
      const doorWidth = 2.5;
      const doorHeight = 4;

      // Left side doors
      leftDoors.forEach((app, i) => {
        const z = hallwayLength/2 - 10 - i * doorSpacing;
        createDoor(app, -hallwayWidth/2 + 0.1, z, Math.PI/2, doorWidth, doorHeight);
      });

      // Right side doors
      rightDoors.forEach((app, i) => {
        const z = hallwayLength/2 - 10 - i * doorSpacing;
        createDoor(app, hallwayWidth/2 - 0.1, z, -Math.PI/2, doorWidth, doorHeight);
      });
    }

    function createDoor(app, x, z, rotY, width, height) {
      const group = new THREE.Group();
      group.position.set(x, 0, z);
      group.rotation.y = rotY;

      // Door frame
      const frameGeo = new THREE.BoxGeometry(width + 0.4, height + 0.3, 0.2);
      const frameMat = new THREE.MeshBasicMaterial({ color: 0x1a1a2e });
      const frame = new THREE.Mesh(frameGeo, frameMat);
      frame.position.y = height/2 + 0.1;
      group.add(frame);

      // Door surface
      const doorGeo = new THREE.PlaneGeometry(width, height);
      const doorMat = new THREE.MeshBasicMaterial({
        color: app.color,
        transparent: true,
        opacity: 0.4,
        side: THREE.DoubleSide
      });
      const door = new THREE.Mesh(doorGeo, doorMat);
      door.position.set(0, height/2 + 0.1, 0.15);
      door.userData = { app };
      group.add(door);
      doors.push(door);

      // Door edges glow
      const edgeGeo = new THREE.EdgesGeometry(new THREE.BoxGeometry(width, height, 0.05));
      const edgeMat = new THREE.LineBasicMaterial({ color: app.color });
      const edges = new THREE.LineSegments(edgeGeo, edgeMat);
      edges.position.set(0, height/2 + 0.1, 0.15);
      group.add(edges);

      // Icon
      const iconCanvas = document.createElement('canvas');
      iconCanvas.width = 128;
      iconCanvas.height = 128;
      const ctx = iconCanvas.getContext('2d');
      ctx.font = '80px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(app.icon, 64, 64);
      const iconTex = new THREE.CanvasTexture(iconCanvas);
      const iconSprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: iconTex }));
      iconSprite.scale.set(1.5, 1.5, 1);
      iconSprite.position.set(0, height/2 + 0.5, 0.3);
      group.add(iconSprite);

      // Name label
      const labelCanvas = document.createElement('canvas');
      labelCanvas.width = 256;
      labelCanvas.height = 64;
      const lctx = labelCanvas.getContext('2d');
      lctx.fillStyle = '#' + app.color.toString(16).padStart(6, '0');
      lctx.font = 'bold 22px Orbitron, sans-serif';
      lctx.textAlign = 'center';
      lctx.fillText(app.name, 128, 40);
      const labelTex = new THREE.CanvasTexture(labelCanvas);
      const labelSprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: labelTex }));
      labelSprite.scale.set(3, 0.75, 1);
      labelSprite.position.set(0, height + 0.8, 0.2);
      group.add(labelSprite);

      // Floor glow
      const glowGeo = new THREE.PlaneGeometry(width + 1, 1.5);
      const glowMat = new THREE.MeshBasicMaterial({ color: app.color, transparent: true, opacity: 0.2 });
      const glow = new THREE.Mesh(glowGeo, glowMat);
      glow.rotation.x = -Math.PI/2;
      glow.position.set(0, 0.02, 0.8);
      group.add(glow);

      scene.add(group);
      hallwayObjects.push(group);
    }

    function createSneakerRoom() {
      const roomGroup = new THREE.Group();
      roomGroup.visible = false;

      const roomWidth = 20;
      const roomDepth = 25;
      const roomHeight = 8;

      // Floor
      const floor = new THREE.Mesh(
        new THREE.PlaneGeometry(roomWidth, roomDepth),
        new THREE.MeshBasicMaterial({ color: 0x0a0a15 })
      );
      floor.rotation.x = -Math.PI/2;
      roomGroup.add(floor);

      // Grid
      const gridMat = new THREE.LineBasicMaterial({ color: 0xff00ff, transparent: true, opacity: 0.3 });
      const gridGeo = new THREE.BufferGeometry();
      const pts = [];
      for (let i = -roomWidth/2; i <= roomWidth/2; i += 2) pts.push(i, 0.01, -roomDepth/2, i, 0.01, roomDepth/2);
      for (let i = -roomDepth/2; i <= roomDepth/2; i += 2) pts.push(-roomWidth/2, 0.01, i, roomWidth/2, 0.01, i);
      gridGeo.setAttribute('position', new THREE.Float32BufferAttribute(pts, 3));
      roomGroup.add(new THREE.LineSegments(gridGeo, gridMat));

      // Walls
      const wallMat = new THREE.MeshBasicMaterial({ color: 0x1a0a2e, side: THREE.DoubleSide });
      const walls = [
        { pos: [0, roomHeight/2, -roomDepth/2], rot: [0, 0, 0], size: [roomWidth, roomHeight] },
        { pos: [-roomWidth/2, roomHeight/2, 0], rot: [0, Math.PI/2, 0], size: [roomDepth, roomHeight] },
        { pos: [roomWidth/2, roomHeight/2, 0], rot: [0, -Math.PI/2, 0], size: [roomDepth, roomHeight] },
        { pos: [0, roomHeight, 0], rot: [Math.PI/2, 0, 0], size: [roomWidth, roomDepth] }
      ];
      walls.forEach(w => {
        const wall = new THREE.Mesh(new THREE.PlaneGeometry(w.size[0], w.size[1]), wallMat);
        wall.position.set(...w.pos);
        wall.rotation.set(...w.rot);
        roomGroup.add(wall);
      });

      // Neon strips
      [0xff00ff, 0x00ffff, 0x00ff88].forEach((c, i) => {
        const strip = new THREE.Mesh(
          new THREE.BoxGeometry(roomWidth - 2, 0.1, 0.1),
          new THREE.MeshBasicMaterial({ color: c })
        );
        strip.position.set(0, 2 + i * 2, -roomDepth/2 + 0.1);
        roomGroup.add(strip);
      });

      // Sneakers
      const sneakerData = [
        { name: 'Neon Runner', color: 0x00ffff, accent: 0xff00ff },
        { name: 'Cyber High', color: 0xff00ff, accent: 0x00ff88 },
        { name: 'Grid Walker', color: 0x00ff88, accent: 0xffff00 },
        { name: 'Pixel Kick', color: 0xffff00, accent: 0xff0044 },
        { name: 'Retro Glow', color: 0xff6600, accent: 0x00ffff },
        { name: 'Matrix Step', color: 0x00ff00, accent: 0xff00ff }
      ];

      sneakerData.forEach((data, i) => {
        const x = (i % 3 - 1) * 6;
        const z = Math.floor(i / 3) * 8 - 6;

        // Pedestal
        const ped = new THREE.Mesh(
          new THREE.CylinderGeometry(1, 1.2, 0.8, 32),
          new THREE.MeshBasicMaterial({ color: 0x1a1a2e })
        );
        ped.position.set(x, 0.4, z);
        roomGroup.add(ped);

        // Ring
        const ring = new THREE.Mesh(
          new THREE.TorusGeometry(1.1, 0.08, 8, 32),
          new THREE.MeshBasicMaterial({ color: data.color })
        );
        ring.rotation.x = Math.PI/2;
        ring.position.set(x, 0.82, z);
        roomGroup.add(ring);

        // Sneaker
        const sneaker = createSneaker(data.color, data.accent);
        sneaker.position.set(x, 1.5, z);
        sneaker.userData = { name: data.name, baseY: 1.5 };
        roomGroup.add(sneaker);
        sneakers.push(sneaker);

        // Label
        const lc = document.createElement('canvas');
        lc.width = 256; lc.height = 64;
        const lctx = lc.getContext('2d');
        lctx.fillStyle = '#' + data.color.toString(16).padStart(6, '0');
        lctx.font = 'bold 24px Orbitron';
        lctx.textAlign = 'center';
        lctx.fillText(data.name, 128, 40);
        const label = new THREE.Sprite(new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(lc) }));
        label.scale.set(3, 0.75, 1);
        label.position.set(x, 2.8, z);
        roomGroup.add(label);
      });

      // Exit portal
      const exitGroup = new THREE.Group();
      exitGroup.position.set(0, 0, roomDepth/2 - 0.5);

      const exitDoor = new THREE.Mesh(
        new THREE.PlaneGeometry(3, 5),
        new THREE.MeshBasicMaterial({ color: 0x00ffff, transparent: true, opacity: 0.4, side: THREE.DoubleSide })
      );
      exitDoor.position.y = 2.5;
      exitDoor.userData = { type: 'exit' };
      exitGroup.add(exitDoor);
      exitPortal = exitDoor;

      const exitEdges = new THREE.LineSegments(
        new THREE.EdgesGeometry(new THREE.BoxGeometry(3, 5, 0.1)),
        new THREE.LineBasicMaterial({ color: 0x00ffff })
      );
      exitEdges.position.y = 2.5;
      exitGroup.add(exitEdges);

      const ec = document.createElement('canvas');
      ec.width = 128; ec.height = 64;
      const ectx = ec.getContext('2d');
      ectx.fillStyle = '#00ffff';
      ectx.font = 'bold 24px Orbitron';
      ectx.textAlign = 'center';
      ectx.fillText('‚Üê EXIT', 64, 40);
      const exitLabel = new THREE.Sprite(new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(ec) }));
      exitLabel.scale.set(2.5, 1.25, 1);
      exitLabel.position.y = 5.5;
      exitGroup.add(exitLabel);

      roomGroup.add(exitGroup);
      scene.add(roomGroup);
      sneakerRoomObjects.push(roomGroup);
    }

    function createSneaker(mainColor, accentColor) {
      const g = new THREE.Group();

      // Sole
      const soleShape = new THREE.Shape();
      soleShape.moveTo(-0.8, -0.3);
      soleShape.lineTo(1, -0.3);
      soleShape.quadraticCurveTo(1.2, 0, 1, 0.3);
      soleShape.lineTo(-0.6, 0.3);
      soleShape.quadraticCurveTo(-1, 0, -0.8, -0.3);

      const sole = new THREE.Mesh(
        new THREE.ExtrudeGeometry(soleShape, { depth: 0.2, bevelEnabled: false }),
        new THREE.MeshBasicMaterial({ color: 0x222222 })
      );
      sole.rotation.x = -Math.PI/2;
      sole.position.y = -0.2;
      g.add(sole);

      // Midsole
      const mid = new THREE.Mesh(
        new THREE.ExtrudeGeometry(soleShape, { depth: 0.1, bevelEnabled: false }),
        new THREE.MeshBasicMaterial({ color: accentColor, transparent: true, opacity: 0.9 })
      );
      mid.rotation.x = -Math.PI/2;
      mid.position.y = -0.1;
      mid.scale.set(0.95, 0.95, 1);
      g.add(mid);

      // Upper
      const upper = new THREE.Mesh(
        new THREE.BoxGeometry(1.5, 0.6, 0.7),
        new THREE.MeshBasicMaterial({ color: mainColor })
      );
      upper.position.set(0.1, 0.15, 0);
      g.add(upper);

      // Toe
      const toe = new THREE.Mesh(
        new THREE.SphereGeometry(0.35, 16, 16, 0, Math.PI, 0, Math.PI/2),
        new THREE.MeshBasicMaterial({ color: mainColor })
      );
      toe.rotation.z = -Math.PI/2;
      toe.position.set(0.8, 0.05, 0);
      g.add(toe);

      // Heel
      const heel = new THREE.Mesh(
        new THREE.BoxGeometry(0.3, 0.5, 0.5),
        new THREE.MeshBasicMaterial({ color: accentColor })
      );
      heel.position.set(-0.6, 0.2, 0);
      g.add(heel);

      // Stripe
      const stripe = new THREE.Mesh(
        new THREE.BoxGeometry(0.8, 0.08, 0.04),
        new THREE.MeshBasicMaterial({ color: accentColor })
      );
      stripe.position.set(0.15, 0.2, 0.36);
      stripe.rotation.z = 0.15;
      g.add(stripe);

      // Edges
      const edges = new THREE.LineSegments(
        new THREE.EdgesGeometry(new THREE.BoxGeometry(1.5, 0.6, 0.7)),
        new THREE.LineBasicMaterial({ color: accentColor })
      );
      edges.position.set(0.1, 0.15, 0);
      g.add(edges);

      g.scale.set(0.7, 0.7, 0.7);
      return g;
    }

    function createAmbientLights() {
      scene.add(new THREE.AmbientLight(0x111122, 0.3));
      const pl = new THREE.PointLight(0x00ffff, 0.5, 50);
      pl.position.set(0, hallwayHeight - 1, 0);
      scene.add(pl);
    }

    function switchRoom(room) {
      if (room === 'sneakers') {
        hallwayObjects.forEach(o => o.visible = false);
        sneakerRoomObjects.forEach(o => o.visible = true);
        camera.position.set(0, 1.7, 10);
        euler.set(0, Math.PI, 0);
        camera.quaternion.setFromEuler(euler);
        currentRoom = 'sneakers';
      } else {
        sneakerRoomObjects.forEach(o => o.visible = false);
        hallwayObjects.forEach(o => o.visible = true);
        camera.position.set(0, 1.7, hallwayLength/2 - 15);
        euler.set(0, 0, 0);
        camera.quaternion.setFromEuler(euler);
        currentRoom = 'hallway';
      }
    }

    function onResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function onKeyDown(e) {
      if (e.code === 'KeyW' || e.code === 'ArrowUp') moveForward = true;
      if (e.code === 'KeyS' || e.code === 'ArrowDown') moveBackward = true;
      if (e.code === 'KeyA' || e.code === 'ArrowLeft') moveLeft = true;
      if (e.code === 'KeyD' || e.code === 'ArrowRight') moveRight = true;
    }

    function onKeyUp(e) {
      if (e.code === 'KeyW' || e.code === 'ArrowUp') moveForward = false;
      if (e.code === 'KeyS' || e.code === 'ArrowDown') moveBackward = false;
      if (e.code === 'KeyA' || e.code === 'ArrowLeft') moveLeft = false;
      if (e.code === 'KeyD' || e.code === 'ArrowRight') moveRight = false;
    }

    function onClick(e) {
      if (e.target.closest('.stream-link-btn') || e.target.closest('.pet-container') || e.target.closest('.mobile-controls')) return;

      if (!isLocked) {
        document.body.requestPointerLock();
        document.getElementById('click-to-start').classList.add('hidden');
        return;
      }

      raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);

      if (currentRoom === 'hallway') {
        const hits = raycaster.intersectObjects(doors);
        if (hits.length > 0 && hits[0].distance < 8) {
          const app = hits[0].object.userData.app;
          if (app.special === 'sneakers') {
            switchRoom('sneakers');
          } else if (app.url) {
            window.location.href = app.url;
          }
        }
      } else if (currentRoom === 'sneakers') {
        const exitHit = raycaster.intersectObject(exitPortal);
        if (exitHit.length > 0 && exitHit[0].distance < 8) {
          switchRoom('hallway');
        }
      }
    }

    function onMouseMove(e) {
      if (!isLocked) return;
      euler.setFromQuaternion(camera.quaternion);
      euler.y -= (e.movementX || 0) * 0.002;
      euler.x -= (e.movementY || 0) * 0.002;
      euler.x = Math.max(-PI_2, Math.min(PI_2, euler.x));
      camera.quaternion.setFromEuler(euler);
    }

    function onPointerLockChange() {
      isLocked = document.pointerLockElement === document.body;
      if (!isLocked) document.getElementById('click-to-start').classList.remove('hidden');
    }

    function setupMobileControls() {
      const fwd = document.getElementById('mobile-forward');
      const left = document.getElementById('mobile-left');
      const right = document.getElementById('mobile-right');
      fwd.addEventListener('touchstart', () => moveForward = true);
      fwd.addEventListener('touchend', () => moveForward = false);
      left.addEventListener('touchstart', () => moveLeft = true);
      left.addEventListener('touchend', () => moveLeft = false);
      right.addEventListener('touchstart', () => moveRight = true);
      right.addEventListener('touchend', () => moveRight = false);
    }

    function updateInfo() {
      const info = document.getElementById('app-info');
      const name = document.getElementById('app-name');
      raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);

      if (currentRoom === 'hallway') {
        const hits = raycaster.intersectObjects(doors);
        if (hits.length > 0 && hits[0].distance < 10) {
          const app = hits[0].object.userData.app;
          name.textContent = app.icon + ' ' + app.name;
          info.classList.add('visible');
          return;
        }
      } else if (currentRoom === 'sneakers') {
        const exitHit = raycaster.intersectObject(exitPortal);
        if (exitHit.length > 0 && exitHit[0].distance < 10) {
          name.textContent = '‚Üê Exit to Hallway';
          info.classList.add('visible');
          return;
        }
        const sneakerHits = raycaster.intersectObjects(sneakers, true);
        if (sneakerHits.length > 0 && sneakerHits[0].distance < 8) {
          let p = sneakerHits[0].object;
          while (p.parent && !p.userData.name) p = p.parent;
          if (p.userData.name) {
            name.textContent = 'üëü ' + p.userData.name;
            info.classList.add('visible');
            return;
          }
        }
      }
      info.classList.remove('visible');
    }

    function animate() {
      requestAnimationFrame(animate);
      const time = performance.now() * 0.001;

      // Animate sneakers
      sneakers.forEach((s, i) => {
        if (s.userData.baseY) {
          s.position.y = s.userData.baseY + Math.sin(time * 2 + i) * 0.1;
          s.rotation.y += 0.01;
        }
      });

      // Movement with collision
      if (isLocked) {
        velocity.x -= velocity.x * 5 * 0.016;
        velocity.z -= velocity.z * 5 * 0.016;

        direction.z = Number(moveForward) - Number(moveBackward);
        direction.x = Number(moveRight) - Number(moveLeft);
        direction.normalize();

        if (moveForward || moveBackward) velocity.z -= direction.z * 40 * 0.016;
        if (moveLeft || moveRight) velocity.x -= direction.x * 40 * 0.016;

        camera.translateX(-velocity.x * 0.016);
        camera.translateZ(velocity.z * 0.016);

        // Hallway bounds
        if (currentRoom === 'hallway') {
          camera.position.x = Math.max(-hallwayWidth/2 + 0.5, Math.min(hallwayWidth/2 - 0.5, camera.position.x));
          camera.position.z = Math.max(-hallwayLength/2 + 1, Math.min(hallwayLength/2 - 1, camera.position.z));
        } else {
          camera.position.x = Math.max(-9, Math.min(9, camera.position.x));
          camera.position.z = Math.max(-11, Math.min(11, camera.position.z));
        }
        camera.position.y = 1.7;
      }

      updateInfo();
      renderer.render(scene, camera);
    }

    // Boot
    const bootScreen = document.getElementById('boot-screen');
    const bootProgress = document.getElementById('boot-progress');
    const bootText = document.getElementById('boot-text');
    const msgs = ['Initializing hallway...', 'Loading doors...', 'Polishing floors...', 'Activating neon...', 'Welcome to the Mansion'];
    let step = 0;
    const bootInt = setInterval(() => {
      step++;
      bootProgress.style.width = (step / msgs.length * 100) + '%';
      if (step < msgs.length) bootText.textContent = msgs[step];
      if (step >= msgs.length) {
        clearInterval(bootInt);
        setTimeout(() => {
          bootScreen.classList.add('hidden');
          document.getElementById('click-to-start').classList.remove('hidden');
          init();
        }, 500);
      }
    }, 400);

    // Clock
    function updateClock() { document.getElementById('clock').textContent = new Date().toLocaleTimeString('en-US', { hour12: false }); }
    updateClock(); setInterval(updateClock, 1000);

    // Pet
    const petBtn = document.getElementById('pet-btn');
    const petPopup = document.getElementById('pet-popup');
    const petDisplay = document.getElementById('pet-display');
    const petStatus = document.getElementById('pet-status');
    const petStages = ['ü•ö', 'üê£', 'üê•', 'üê§', 'üêî'];
    let petStage = parseInt(localStorage.getItem('petStage') || '0');
    let petHappiness = parseInt(localStorage.getItem('petHappiness') || '50');
    let petClicks = parseInt(localStorage.getItem('petClicks') || '0');

    function updatePet() {
      if (petStage === 0) {
        petDisplay.textContent = petBtn.textContent = 'ü•ö';
        petStatus.textContent = petClicks + '/10 clicks to hatch';
      } else {
        const s = Math.min(petStage, petStages.length - 1);
        petDisplay.textContent = petBtn.textContent = petStages[s];
        petStatus.textContent = 'Happiness: ' + petHappiness + '%';
      }
      localStorage.setItem('petStage', petStage);
      localStorage.setItem('petHappiness', petHappiness);
      localStorage.setItem('petClicks', petClicks);
    }

    petBtn.onclick = e => {
      e.stopPropagation();
      petPopup.classList.toggle('open');
      if (petStage === 0) { petClicks++; if (petClicks >= 10) { petStage = 1; petHappiness = 100; } updatePet(); }
    };
    document.getElementById('pet-interact').onclick = () => { if (petStage > 0) { petHappiness = Math.min(100, petHappiness + 10); if (petHappiness >= 100 && petStage < petStages.length - 1) petStage++; updatePet(); } };
    document.getElementById('pet-feed').onclick = () => { if (petStage > 0) { petHappiness = Math.min(100, petHappiness + 15); updatePet(); } };
    setInterval(() => { if (petStage > 0 && petHappiness > 0) { petHappiness--; updatePet(); } }, 30000);
    updatePet();
  </script>
</body>
</html>
