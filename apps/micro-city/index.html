<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Micro City</title>
  <link rel="icon" href="https://emojicdn.elk.sh/üèôÔ∏è">
  <meta property="og:title" content="Micro City">
  <meta property="og:description" content="Build and survive in this challenging city sim!">
  <meta property="og:url" content="https://app.sloppy.live/micro-city">
  <meta property="og:image" content="https://app.sloppy.live/micro-city/og-image.png">
  <style>
    /* Windows 95 Classic Theme */
    @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
    * { margin: 0; padding: 0; box-sizing: border-box; }

    /* Win95 Color Palette */
    :root {
      --win-bg: #008080;
      --win-face: #c0c0c0;
      --win-light: #ffffff;
      --win-mid: #808080;
      --win-dark: #404040;
      --win-shadow: #000000;
      --win-title: #000080;
      --win-title-inactive: #808080;
      --win-text: #000000;
      --win-highlight: #000080;
      --win-selected: #0000aa;
    }

    body { background: var(--win-bg); min-height: 100vh; font-family: 'Segoe UI', Tahoma, Geneva, sans-serif; font-size: 11px; color: var(--win-text); display: flex; flex-direction: column; }

    /* Win95 3D Border Mixins */
    .win-raised { border: 2px solid; border-color: var(--win-light) var(--win-dark) var(--win-dark) var(--win-light); }
    .win-sunken { border: 2px solid; border-color: var(--win-dark) var(--win-light) var(--win-light) var(--win-dark); }
    .win-groove { border: 2px solid; border-color: var(--win-mid) var(--win-light) var(--win-light) var(--win-mid); }

    /* Title Bar */
    .header { background: linear-gradient(90deg, var(--win-title) 0%, #1084d0 100%); padding: 2px 4px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px; }
    h1 { font-size: 12px; font-weight: bold; color: white; display: flex; align-items: center; gap: 6px; text-shadow: 1px 1px 0 #000; }
    .stats { display: flex; gap: 8px; font-size: 11px; flex-wrap: wrap; background: var(--win-face); padding: 2px 6px; border: 2px solid; border-color: var(--win-dark) var(--win-light) var(--win-light) var(--win-dark); }
    .stat { display: flex; align-items: center; gap: 3px; }
    .stat-icon { font-size: 12px; }
    .stat-value { color: var(--win-text); font-weight: bold; }
    .stat-value.negative { color: #aa0000; }
    .stat-value.warning { color: #aa5500; }

    /* Main Layout */
    .main { display: flex; flex: 1; overflow: hidden; background: var(--win-face); }

    /* Toolbar */
    .toolbar { background: var(--win-face); padding: 4px; display: flex; flex-direction: column; gap: 2px; border-right: 2px solid; border-color: var(--win-light) var(--win-dark) var(--win-dark) var(--win-light); width: 150px; overflow-y: auto; }
    .tool-section { margin-bottom: 4px; padding: 4px; background: var(--win-face); border: 2px solid; border-color: var(--win-mid) var(--win-light) var(--win-light) var(--win-mid); }
    .tool-label { font-size: 10px; color: var(--win-text); font-weight: bold; margin-bottom: 4px; }
    .tools { display: flex; flex-direction: column; gap: 2px; }

    /* Win95 Buttons */
    .tool-btn { background: var(--win-face); border: 2px solid; border-color: var(--win-light) var(--win-dark) var(--win-dark) var(--win-light); padding: 3px 6px; font-family: inherit; font-size: 11px; color: var(--win-text); cursor: pointer; display: flex; align-items: center; gap: 4px; }
    .tool-btn:hover { background: #d4d4d4; }
    .tool-btn:active { border-color: var(--win-dark) var(--win-light) var(--win-light) var(--win-dark); padding: 4px 5px 2px 7px; }
    .tool-btn.active { border-color: var(--win-dark) var(--win-light) var(--win-light) var(--win-dark); background: #a0a0a0; padding: 4px 5px 2px 7px; }
    .tool-cost { margin-left: auto; font-size: 10px; color: #444; }

    /* Canvas Area */
    .canvas-container { flex: 1; display: flex; align-items: center; justify-content: center; padding: 8px; overflow: auto; position: relative; background: var(--win-bg); }
    canvas { border: 2px solid; border-color: var(--win-dark) var(--win-light) var(--win-light) var(--win-dark); cursor: crosshair; background: #000; }

    /* Right Panel */
    .panel { background: var(--win-face); padding: 6px; border-left: 2px solid; border-color: var(--win-light) var(--win-dark) var(--win-dark) var(--win-light); width: 170px; display: flex; flex-direction: column; gap: 6px; overflow-y: auto; font-size: 11px; }
    .panel > div { padding: 4px; background: var(--win-face); border: 2px solid; border-color: var(--win-mid) var(--win-light) var(--win-light) var(--win-mid); }
    .panel-title { font-size: 10px; font-weight: bold; color: var(--win-text); margin-bottom: 4px; }

    /* Demand Bars */
    .demand-bars { display: flex; flex-direction: column; gap: 3px; }
    .demand-row { display: flex; align-items: center; gap: 4px; }
    .demand-label { width: 14px; font-size: 10px; font-weight: bold; }
    .demand-label.r { color: #008000; }
    .demand-label.c { color: #000080; }
    .demand-label.i { color: #804000; }
    .demand-bar-bg { flex: 1; height: 12px; background: white; border: 2px solid; border-color: var(--win-dark) var(--win-light) var(--win-light) var(--win-dark); }
    .demand-bar { height: 100%; }
    .demand-bar.r { background: #00aa00; }
    .demand-bar.c { background: #0000aa; }
    .demand-bar.i { background: #aa5500; }

    /* Info Grid */
    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
    .info-item { background: white; padding: 4px; text-align: center; border: 2px solid; border-color: var(--win-dark) var(--win-light) var(--win-light) var(--win-dark); }
    .info-value { font-size: 12px; font-weight: bold; color: var(--win-title); }
    .info-label { font-size: 9px; color: #444; }

    /* Meters */
    .meter { margin-bottom: 6px; }
    .meter-label { display: flex; justify-content: space-between; font-size: 10px; margin-bottom: 2px; }
    .meter-bar { height: 12px; background: white; border: 2px solid; border-color: var(--win-dark) var(--win-light) var(--win-light) var(--win-dark); }
    .meter-fill { height: 100%; }
    .meter-fill.happiness { background: linear-gradient(90deg, #aa0000, #aaaa00, #00aa00); }
    .meter-fill.power { background: #aaaa00; }
    .meter-fill.crime { background: #aa0000; }

    /* Speed Controls */
    .speed-controls { display: flex; gap: 2px; }
    .speed-btn { flex: 1; background: var(--win-face); border: 2px solid; border-color: var(--win-light) var(--win-dark) var(--win-dark) var(--win-light); padding: 2px; color: var(--win-text); cursor: pointer; font-size: 10px; font-family: inherit; }
    .speed-btn:active, .speed-btn.active { border-color: var(--win-dark) var(--win-light) var(--win-light) var(--win-dark); background: #a0a0a0; }

    /* Income Ticker */
    .income-ticker { position: fixed; pointer-events: none; z-index: 400; font-family: 'VT323', monospace; font-weight: bold; font-size: 16px; animation: floatUp 1.5s ease-out forwards; text-shadow: 1px 1px 0 #000; }
    .income-ticker.positive { color: #00ff00; }
    .income-ticker.negative { color: #ff0000; }
    @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-30px); } }

    /* Treasury Button */
    .treasury-btn { cursor: pointer; padding: 1px 4px; }
    .treasury-btn:hover { background: #a0a0a0; }

    /* Loan Section */
    .loan-section { margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--win-mid); }
    .loan-btn { background: var(--win-face); border: 2px solid; border-color: var(--win-light) var(--win-dark) var(--win-dark) var(--win-light); padding: 2px 6px; color: var(--win-text); cursor: pointer; font-size: 10px; margin-right: 4px; font-family: inherit; }
    .loan-btn:active { border-color: var(--win-dark) var(--win-light) var(--win-light) var(--win-dark); }
    .loan-info { font-size: 10px; color: #804000; margin-top: 4px; }

    /* Win95 Dialog Boxes */
    .budget-modal, .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 350; }
    .budget-modal.show, .modal.show { display: flex; }
    .budget-box, .modal-box { background: var(--win-face); border: 2px solid; border-color: var(--win-light) var(--win-dark) var(--win-dark) var(--win-light); padding: 0; max-width: 380px; width: 90%; max-height: 85vh; box-shadow: 2px 2px 0 #000; }
    .win-titlebar { background: linear-gradient(90deg, var(--win-title) 0%, #1084d0 100%); color: white; padding: 2px 4px; font-weight: bold; font-size: 11px; display: flex; align-items: center; gap: 4px; }
    .win-content { padding: 12px; overflow-y: auto; max-height: 70vh; }
    .budget-title, .modal-title { background: linear-gradient(90deg, var(--win-title) 0%, #1084d0 100%); color: white; padding: 3px 6px; font-weight: bold; font-size: 11px; margin: -12px -12px 12px -12px; }
    .budget-section { margin-bottom: 12px; }
    .budget-section-title { font-size: 10px; color: #444; font-weight: bold; margin-bottom: 6px; border-bottom: 1px solid var(--win-mid); padding-bottom: 2px; }
    .budget-row { display: flex; justify-content: space-between; padding: 2px 0; font-size: 11px; }
    .budget-row span:last-child { font-weight: bold; }
    .budget-row.income span:last-child { color: #008000; }
    .budget-row.expense span:last-child { color: #aa0000; }
    .budget-row.total { border-top: 1px solid var(--win-mid); margin-top: 4px; padding-top: 4px; font-weight: bold; }
    .budget-row.total.positive span:last-child { color: #008000; }
    .budget-row.total.negative span:last-child { color: #aa0000; }
    .budget-close, .modal-btn { background: var(--win-face); border: 2px solid; border-color: var(--win-light) var(--win-dark) var(--win-dark) var(--win-light); padding: 4px 16px; font-family: inherit; font-size: 11px; color: var(--win-text); cursor: pointer; margin-top: 10px; }
    .budget-close:active, .modal-btn:active { border-color: var(--win-dark) var(--win-light) var(--win-light) var(--win-dark); }
    .modal-btn.confirm { font-weight: bold; }
    .modal-btns { display: flex; gap: 8px; margin-top: 12px; justify-content: center; }

    /* Save Slots */
    .slot { background: white; border: 2px solid; border-color: var(--win-dark) var(--win-light) var(--win-light) var(--win-dark); padding: 6px; margin-bottom: 6px; cursor: pointer; }
    .slot:hover { background: var(--win-title); color: white; }
    .slot:hover .slot-info { color: #ccc; }
    .slot-name { font-weight: bold; margin-bottom: 2px; }
    .slot-info { font-size: 10px; color: #666; }
    .slot-empty { color: #888; font-style: italic; }

    /* Alert */
    .alert { position: fixed; top: 50px; left: 50%; transform: translateX(-50%); background: var(--win-face); border: 2px solid; border-color: var(--win-light) var(--win-dark) var(--win-dark) var(--win-light); color: var(--win-text); padding: 8px 16px; font-weight: bold; z-index: 100; box-shadow: 2px 2px 0 #000; display: none; }
    .alert.show { display: block; }

    /* Game Over */
    .game-over { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,128,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 200; }
    .game-over.show { display: flex; }
    .game-over h2 { font-size: 24px; color: white; margin-bottom: 8px; font-family: 'VT323', monospace; }
    .game-over p { color: #ccc; margin-bottom: 16px; }
    .game-over button { background: var(--win-face); border: 2px solid; border-color: var(--win-light) var(--win-dark) var(--win-dark) var(--win-light); padding: 6px 20px; font-family: inherit; font-size: 12px; color: var(--win-text); cursor: pointer; }

    /* Zoom Controls */
    .zoom-controls { position: absolute; bottom: 8px; right: 8px; display: flex; gap: 2px; z-index: 50; }
    .zoom-btn { width: 24px; height: 24px; background: var(--win-face); border: 2px solid; border-color: var(--win-light) var(--win-dark) var(--win-dark) var(--win-light); color: var(--win-text); font-size: 14px; cursor: pointer; font-family: inherit; }
    .zoom-btn:active { border-color: var(--win-dark) var(--win-light) var(--win-light) var(--win-dark); }
    .zoom-label { background: white; border: 2px solid; border-color: var(--win-dark) var(--win-light) var(--win-light) var(--win-dark); color: var(--win-text); padding: 2px 8px; font-size: 10px; display: flex; align-items: center; }

    /* Tooltip */
    .tooltip { position: fixed; background: #ffffcc; border: 1px solid #000; padding: 6px 8px; font-size: 11px; pointer-events: none; z-index: 500; max-width: 260px; display: none; box-shadow: 2px 2px 0 rgba(0,0,0,0.3); }
    .tooltip.show { display: block; opacity: 1; }
    .tooltip-title { font-weight: bold; color: var(--win-title); margin-bottom: 6px; display: flex; align-items: center; gap: 4px; font-size: 12px; }
    .tooltip-row { display: flex; justify-content: space-between; margin: 2px 0; color: #333; }
    .tooltip-row span:last-child { font-weight: bold; }
    .tooltip-row.good span:last-child { color: #008000; }
    .tooltip-row.bad span:last-child { color: #aa0000; }
    .tooltip-row.warn span:last-child { color: #aa5500; }
    .tooltip-divider { border-top: 1px solid #ccc; margin: 6px 0; }
    .tooltip-hint { font-size: 10px; color: #666; margin-top: 4px; line-height: 1.3; }
    .tooltip-section { font-size: 9px; color: var(--win-title); font-weight: bold; margin: 6px 0 2px 0; }

    /* Back Link */
    .back-link { text-align: center; padding: 4px; background: var(--win-face); color: #0000aa; text-decoration: underline; font-size: 10px; border-top: 2px solid; border-color: var(--win-light) var(--win-dark) var(--win-dark) var(--win-light); }
    .back-link:hover { color: #aa0000; }

    /* Mobile */
    @media (max-width: 900px) {
      .main { flex-direction: column; }
      .toolbar { width: 100%; flex-direction: row; flex-wrap: wrap; border-right: none; border-bottom: 2px solid var(--win-mid); }
      .tool-section { margin-bottom: 0; flex: 1; min-width: 140px; }
      .tools { flex-direction: row; flex-wrap: wrap; }
      .panel { width: 100%; border-left: none; border-top: 2px solid var(--win-mid); flex-direction: row; flex-wrap: wrap; }
      .panel > div { flex: 1; min-width: 150px; }
    }
  </style>
</head>
<body>
  <div class="tooltip" id="tooltip"></div>
  <div class="alert" id="alert">üî• FIRE!</div>
  <div class="game-over" id="gameOver">
    <h2>BANKRUPTCY!</h2>
    <p>Your city ran out of money.</p>
    <p id="finalStats"></p>
    <button onclick="resetGame()">Try Again</button>
  </div>
  <div class="modal" id="saveModal">
    <div class="modal-box">
      <div class="modal-title" id="modalTitle">Save Game</div>
      <div id="slotList"></div>
      <div class="modal-btns">
        <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>
  <div class="modal" id="newGameModal">
    <div class="modal-box">
      <div class="modal-title">Start New Game?</div>
      <p style="color:#6a8299;font-size:0.8rem;margin-bottom:15px;text-align:center;">Save current progress first?</p>
      <div class="modal-btns">
        <button class="modal-btn cancel" onclick="closeNewGameModal()">Cancel</button>
        <button class="modal-btn" style="background:#ff9800;color:#000" onclick="newGameWithSave()">Save First</button>
        <button class="modal-btn confirm" onclick="newGameNow()">New Game</button>
      </div>
    </div>
  </div>
  <div class="budget-modal" id="budgetModal">
    <div class="budget-box">
      <div class="budget-title">üìä City Budget</div>
      <div class="budget-section">
        <div class="budget-section-title">üí∞ Income</div>
        <div class="budget-row income"><span>Commercial Tax</span><span id="budgetComTax">$0</span></div>
        <div class="budget-row income"><span>Industrial Tax</span><span id="budgetIndTax">$0</span></div>
        <div class="budget-row income"><span>Population Bonus</span><span id="budgetPopBonus">$0</span></div>
        <div class="budget-row income total"><span>Total Income</span><span id="budgetTotalIncome">$0</span></div>
      </div>
      <div class="budget-section">
        <div class="budget-section-title">üí∏ Expenses</div>
        <div class="budget-row expense"><span>Residential Upkeep</span><span id="budgetResMaint">$0</span></div>
        <div class="budget-row expense"><span>Commercial Upkeep</span><span id="budgetComMaint">$0</span></div>
        <div class="budget-row expense"><span>Industrial Upkeep</span><span id="budgetIndMaint">$0</span></div>
        <div class="budget-row expense"><span>Power Plants</span><span id="budgetPowerMaint">$0</span></div>
        <div class="budget-row expense"><span>Police Stations</span><span id="budgetPoliceMaint">$0</span></div>
        <div class="budget-row expense"><span>Fire Stations</span><span id="budgetFireMaint">$0</span></div>
        <div class="budget-row expense"><span>Parks</span><span id="budgetParkMaint">$0</span></div>
        <div class="budget-row expense"><span>Loan Interest</span><span id="budgetLoanInterest">$0</span></div>
        <div class="budget-row expense"><span>Infrastructure</span><span id="budgetInfra">$0</span></div>
        <div class="budget-row expense total"><span>Total Expenses</span><span id="budgetTotalExpense">$0</span></div>
      </div>
      <div class="budget-section">
        <div class="budget-section-title">üìà Summary</div>
        <div class="budget-row total" id="budgetNetRow"><span>Net Income/Year</span><span id="budgetNet">$0</span></div>
        <div class="budget-row"><span>Current Treasury</span><span id="budgetTreasury">$0</span></div>
        <div class="budget-row"><span>Active Loans</span><span id="budgetLoans">$0</span></div>
      </div>
      <button class="budget-close" onclick="closeBudgetModal()">Close</button>
    </div>
  </div>
  <header class="header">
    <h1>üèôÔ∏è Micro City</h1>
    <div class="stats">
      <div class="stat" title="Population: Total citizens living in your residential zones. Each residential level houses 80 people. More population = more demand for commercial shops."><span class="stat-icon">üë•</span><span class="stat-value" id="population">0</span></div>
      <div class="stat treasury-btn" onclick="showBudgetModal()" title="Treasury: Click for detailed budget breakdown. Your city's funds. Goes negative = debt. At -$2,000 you go bankrupt!"><span class="stat-icon">üí∞</span><span class="stat-value" id="money">$5,000</span></div>
      <div class="stat" title="Net Income: Yearly profit/loss. Green = profit, Red = loss. Income from Commercial & Industrial taxes. Expenses from building maintenance. ‚ö†Ô∏è means maintenance surge active!"><span class="stat-icon">üìà</span><span class="stat-value" id="income">+$0</span></div>
      <div class="stat" title="Year: Game time. Each year you collect taxes and pay maintenance. Random events like fires and maintenance surges occur over time."><span class="stat-icon">üìÖ</span><span class="stat-value" id="date">Year 1</span></div>
      <div class="stat" title="Happiness: Citizen satisfaction (0-100%). Affected by: power coverage, crime rate, pollution levels, parks, and shops. High happiness = faster growth & more tax income!"><span class="stat-icon">üòä</span><span class="stat-value" id="happiness">50%</span></div>
    </div>
  </header>
  <div class="main">
    <div class="toolbar">
      <div class="tool-section">
        <div class="tool-label">Zones</div>
        <div class="tools">
          <button class="tool-btn residential active" data-tool="residential" title="Residential Zone ($100): Houses for citizens. Needs: road access, 30%+ power, low pollution (<50%), low crime (<70%). Each citizen earns you $0.02/yr! Only $1/yr maintenance!">üè† Res<span class="tool-cost">$100</span></button>
          <button class="tool-btn commercial" data-tool="commercial" title="Commercial Zone ($150): Shops & businesses. Needs: road access, 30%+ power, nearby residential (4 tiles). Generates ~$18/level tax income! Only $2/yr maintenance!">üè™ Com<span class="tool-cost">$150</span></button>
          <button class="tool-btn industrial" data-tool="industrial" title="Industrial Zone ($200): Factories & industry. Needs: road access, 30%+ power. Generates ~$14/level tax income! Creates some pollution but it decays fast. Only $3/yr maintenance!">üè≠ Ind<span class="tool-cost">$200</span></button>
        </div>
      </div>
      <div class="tool-section">
        <div class="tool-label">Infrastructure</div>
        <div class="tools">
          <button class="tool-btn road" data-tool="road" title="Road ($50): Essential infrastructure! All zones MUST be adjacent to a road to develop. No maintenance cost - build freely to connect your city.">üõ§Ô∏è Road<span class="tool-cost">$50</span></button>
          <button class="tool-btn power" data-tool="power" title="Power Plant ($300): Provides electricity. Each plant supports ~15 building levels. Below 30% coverage = no growth! Only $10/yr maintenance!">‚ö° Power<span class="tool-cost">$300</span></button>
        </div>
      </div>
      <div class="tool-section">
        <div class="tool-label">Services</div>
        <div class="tools">
          <button class="tool-btn police" data-tool="police" title="Police Station ($500): Reduces crime in 4-tile radius. Each station cuts city crime by ~20%. High crime (70%+) blocks residential growth. Only $20/yr maintenance!">üöî Police<span class="tool-cost">$500</span></button>
          <button class="tool-btn fire" data-tool="fire" title="Fire Station ($500): Prevents fires within 4 tiles, contains spread within 3 tiles. Fires are rare but can destroy buildings! Only $20/yr maintenance!">üöí Fire<span class="tool-cost">$500</span></button>
          <button class="tool-btn park" data-tool="park" title="Park ($150): Multi-purpose! Cleans pollution (1-tile radius), +5% happiness, slight crime reduction. Perfect buffer between industrial and residential zones. Only $5/yr maintenance!">üå≥ Park<span class="tool-cost">$150</span></button>
        </div>
      </div>
      <div class="tool-section">
        <div class="tool-label">Tools</div>
        <div class="tools">
          <button class="tool-btn bulldoze" data-tool="bulldoze" title="Bulldoze ($10): Demolish any building or zone. Use to clear space, remove polluting industry, or redesign your city layout.">üí• Bulldoze<span class="tool-cost">$10</span></button>
        </div>
      </div>
      <div class="tool-section">
        <div class="tool-label">Game</div>
        <div class="tools">
          <button class="tool-btn new-btn" onclick="showNewGameModal()" title="New Game: Start a fresh city from scratch. You can save your current city first. Starts with $10,000 funds on a 36x36 grid!">üÜï New</button>
          <button class="tool-btn save-btn" onclick="showSaveModal()" title="Save Game: Manually save to one of 5 slots. Game also auto-saves every 30 seconds and when you close the tab.">üíæ Save</button>
          <button class="tool-btn load-btn" onclick="showLoadModal()" title="Load Game: Load a previously saved city from any of your 5 save slots. Shows population, year, and money for each save.">üìÇ Load</button>
          <button class="tool-btn expand-btn" onclick="expandLand()" title="Expand Land ($2000): Adds 6 tiles to each edge of your map (max 60x60). Use when running out of building space. Expensive but essential for growth!">üó∫Ô∏è Expand<span class="tool-cost">$2000</span></button>
        </div>
      </div>
    </div>
    <div class="canvas-container">
      <canvas id="city" title="City Grid: Click to place zones and buildings. Hover over any cell for detailed info. Drag to place multiple tiles. Green=Residential, Blue=Commercial, Orange=Industrial."></canvas>
      <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomOut()" title="Zoom Out: Shrink the view to see more of your city (min 50%)">‚àí</button>
        <span class="zoom-label" id="zoomLabel" title="Current zoom level. 100% is default. Range: 50% - 200%">100%</span>
        <button class="zoom-btn" onclick="zoomIn()" title="Zoom In: Enlarge the view for detailed building (max 200%)">+</button>
      </div>
    </div>
    <div class="panel">
      <div title="RCI Demand: Shows market demand for each zone type. Higher demand (longer bar) = faster zone development. Demand above 45% allows growth. Balance all three for a healthy city!">
        <div class="panel-title">RCI Demand</div>
        <div class="demand-bars">
          <div class="demand-row" title="Residential Demand: Need for housing. Increases with more commercial/industrial jobs. Build more homes when this is high!"><span class="demand-label r">R</span><div class="demand-bar-bg"><div class="demand-bar r" id="demandR" style="width:50%"></div></div></div>
          <div class="demand-row" title="Commercial Demand: Need for shops. Increases with population. Commercial needs nearby residential (3 tiles) to develop."><span class="demand-label c">C</span><div class="demand-bar-bg"><div class="demand-bar c" id="demandC" style="width:50%"></div></div></div>
          <div class="demand-row" title="Industrial Demand: Need for factories. Increases with population and commercial. Warning: Industry creates pollution!"><span class="demand-label i">I</span><div class="demand-bar-bg"><div class="demand-bar i" id="demandI" style="width:50%"></div></div></div>
        </div>
      </div>
      <div title="City Health: Critical metrics affecting growth and happiness. Keep power high, crime low, and pollution minimal for a thriving city!">
        <div class="panel-title">City Health</div>
        <div class="meter" title="Power Coverage: % of city's power needs met. Below 30% = NO development! Below 50% = happiness penalty. Build more power plants as you grow."><div class="meter-label"><span>Power</span><span id="powerPct">0%</span></div><div class="meter-bar"><div class="meter-fill power" id="powerBar" style="width:0%"></div></div></div>
        <div class="meter" title="Crime Rate: Higher with more buildings, lower with police stations. Above 60% = residential won't grow! Each police station reduces crime ~20%."><div class="meter-label"><span>Crime</span><span id="crimePct">0%</span></div><div class="meter-bar"><div class="meter-fill crime" id="crimeBar" style="width:0%"></div></div></div>
        <div class="meter" title="Pollution Level: Average pollution in residential areas. Caused by industry, cleaned by parks. Above 40% = residential won't grow! Pollution spreads over time."><div class="meter-label"><span>Pollution</span><span id="pollPct">0%</span></div><div class="meter-bar"><div class="meter-fill" id="pollBar" style="width:0%;background:#9c27b0"></div></div></div>
      </div>
      <div title="Building Counts: Number of developed buildings by type. Only counts zones that have grown to at least level 1.">
        <div class="panel-title">Buildings</div>
        <div class="info-grid">
          <div class="info-item" title="Developed Residential Zones: Each home can grow to level 3 (240 people). Provides population but no direct income."><div class="info-value" id="resCount">0</div><div class="info-label">Homes</div></div>
          <div class="info-item" title="Developed Commercial Zones: Each shop generates $6/level in yearly taxes. Also boosts city happiness!"><div class="info-value" id="comCount">0</div><div class="info-label">Shops</div></div>
          <div class="info-item" title="Developed Industrial Zones: Each factory generates $4.5/level in yearly taxes. Warning: Creates pollution!"><div class="info-value" id="indCount">0</div><div class="info-label">Factory</div></div>
          <div class="info-item" title="Service Buildings: Total power plants, police stations, fire stations, and parks. Essential for city function!"><div class="info-value" id="svcCount">0</div><div class="info-label">Services</div></div>
        </div>
      </div>
      <div title="Game Speed: Control how fast time passes. Pause to plan, speed up to grow quickly. Events and development happen faster at higher speeds.">
        <div class="panel-title">Speed</div>
        <div class="speed-controls">
          <button class="speed-btn" data-speed="0" title="Pause: Stop time completely. Use to plan your city layout without pressure.">‚è∏</button>
          <button class="speed-btn active" data-speed="1" title="Normal Speed (1x): Default game pace. Good for active management.">1x</button>
          <button class="speed-btn" data-speed="2" title="Fast (2x): Double speed. Good for watching your city develop.">2x</button>
          <button class="speed-btn" data-speed="4" title="Turbo (4x): Quadruple speed. Quick development.">4x</button>
          <button class="speed-btn" data-speed="8" title="Hyperspeed (8x): Maximum speed. Watch years fly by!">8x</button>
        </div>
      </div>
      <div class="loan-section">
        <div class="panel-title">üí≥ Loans</div>
        <div>
          <button class="loan-btn borrow" onclick="takeLoan()" title="Borrow $1,000 at 5% annual interest. Max debt: $10,000">Borrow $1k</button>
          <button class="loan-btn repay" onclick="repayLoan()" title="Repay $1,000 of your loan balance">Repay $1k</button>
        </div>
        <div class="loan-info" id="loanInfo">No active loans</div>
      </div>
    </div>
  </div>
  <a href="https://sloppy.live" class="back-link">sloppy.live</a>
  <script>
    const canvas = document.getElementById('city');
    const ctx = canvas.getContext('2d');
    const alertEl = document.getElementById('alert');
    const gameOverEl = document.getElementById('gameOver');

    const CELL = 14;
    const EMPTY=0,ROAD=1,RES=2,COM=3,IND=4,POWER=5,POLICE=6,FIRE=7,PARK=8;

    let gridSize = 36;
    let zoomLevel = 1;
    let grid=[], buildings=[], onFire=[], pollution=[];

    function initGrid(size){
      gridSize=size;
      grid=[];buildings=[];onFire=[];pollution=[];
      for(let y=0;y<gridSize;y++){
        grid[y]=[];buildings[y]=[];onFire[y]=[];pollution[y]=[];
        for(let x=0;x<gridSize;x++){grid[y][x]=EMPTY;buildings[y][x]=0;onFire[y][x]=0;pollution[y][x]=0;}
      }
      updateCanvasSize();
    }

    function updateCanvasSize(){
      canvas.width = gridSize * CELL * zoomLevel;
      canvas.height = gridSize * CELL * zoomLevel;
      document.getElementById('zoomLabel').textContent=Math.round(zoomLevel*100)+'%';
    }

    function zoomIn(){
      if(zoomLevel<2){zoomLevel=Math.min(2,zoomLevel+0.25);updateCanvasSize();draw();}
    }

    function zoomOut(){
      if(zoomLevel>0.5){zoomLevel=Math.max(0.5,zoomLevel-0.25);updateCanvasSize();draw();}
    }

    function expandLand(){
      if(!gameActive)return;
      const cost=2000;
      if(money<cost){showAlert('üí∏ Need $2,000!');return;}
      if(gridSize>=60){showAlert('üó∫Ô∏è Max size reached!');return;}
      money-=cost;
      const oldSize=gridSize;
      const newSize=oldSize+6;
      // Create new larger arrays
      const newGrid=[],newBuildings=[],newFire=[],newPoll=[];
      for(let y=0;y<newSize;y++){
        newGrid[y]=[];newBuildings[y]=[];newFire[y]=[];newPoll[y]=[];
        for(let x=0;x<newSize;x++){
          // Copy old data centered, or empty for new cells
          const ox=x-3,oy=y-3;
          if(ox>=0&&ox<oldSize&&oy>=0&&oy<oldSize){
            newGrid[y][x]=grid[oy][ox];
            newBuildings[y][x]=buildings[oy][ox];
            newFire[y][x]=onFire[oy][ox];
            newPoll[y][x]=pollution[oy][ox];
          }else{
            newGrid[y][x]=EMPTY;newBuildings[y][x]=0;newFire[y][x]=0;newPoll[y][x]=0;
          }
        }
      }
      grid=newGrid;buildings=newBuildings;onFire=newFire;pollution=newPoll;
      gridSize=newSize;
      updateCanvasSize();
      updateUI();draw();
      showAlert('üó∫Ô∏è Land expanded!');
    }

    initGrid(36);

    let money=10000,population=0,year=1,gameSpeed=1,selectedTool='residential',tickCount=0,gameActive=true;
    let demandR=50,demandC=50,demandI=50,happiness=60,powerCoverage=0,crimeLvl=0,pollutionLvl=0;
    let lastIncome=0;
    let maintenanceSurge=1,surgeYearsLeft=0,surgeName='';
    let loanBalance=0;
    const LOAN_INTEREST=0.05; // 5% annual interest
    const MAX_LOAN=10000;
    // Budget breakdown tracking
    let budgetData={comTax:0,indTax:0,popBonus:0,resMaint:0,comMaint:0,indMaint:0,powerMaint:0,policeMaint:0,fireMaint:0,parkMaint:0,loanInterest:0};

    // REBALANCED v3: Anti-capitalist nightmare edition
    const costs={residential:100,commercial:150,industrial:200,road:50,power:300,police:500,fire:500,park:150,bulldoze:10};
    const maintenance={[RES]:1,[COM]:2,[IND]:3,[POWER]:10,[POLICE]:20,[FIRE]:20,[PARK]:5}; // Police/Fire $30->$20
    const TAX_COM=80,TAX_IND=100; // Commercial nerfed 100->80, Industrial buffed 80->100
    const POP_BONUS=0.05; // Residential bonus buffed $0.02->$0.05 per citizen

    document.querySelectorAll('.tool-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        selectedTool=btn.dataset.tool;
      });
    });

    document.querySelectorAll('.speed-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('.speed-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        gameSpeed=parseInt(btn.dataset.speed);
      });
    });

    let isDrawing=false;
    const tooltip=document.getElementById('tooltip');
    let hoveredCell={x:-1,y:-1};
    let hoverTimer=null;
    let lastMousePos={x:0,y:0};
    const HOVER_DELAY=450; // ms before tooltip appears

    canvas.addEventListener('mousedown',e=>{isDrawing=true;hideTooltip();handleDraw(e);});
    canvas.addEventListener('mousemove',e=>{if(isDrawing)handleDraw(e);handleHover(e);});
    canvas.addEventListener('mouseup',()=>isDrawing=false);
    canvas.addEventListener('mouseleave',()=>{isDrawing=false;hideTooltip();});
    canvas.addEventListener('touchstart',e=>{e.preventDefault();isDrawing=true;handleDraw(e.touches[0]);});
    canvas.addEventListener('touchmove',e=>{e.preventDefault();if(isDrawing)handleDraw(e.touches[0]);});
    canvas.addEventListener('touchend',()=>isDrawing=false);

    function handleHover(e){
      lastMousePos={x:e.clientX,y:e.clientY};
      if(isDrawing){hideTooltip();return;}
      const rect=canvas.getBoundingClientRect();
      const x=Math.floor((e.clientX-rect.left)/(rect.width/gridSize));
      const y=Math.floor((e.clientY-rect.top)/(rect.height/gridSize));
      if(x<0||x>=gridSize||y<0||y>=gridSize){hideTooltip();return;}
      if(hoveredCell.x===x&&hoveredCell.y===y)return;

      // Clear any pending tooltip
      if(hoverTimer)clearTimeout(hoverTimer);
      tooltip.classList.remove('show');
      hoveredCell={x,y};

      // Start new delay timer
      hoverTimer=setTimeout(()=>{
        showTooltip(x,y,lastMousePos.x,lastMousePos.y);
      },HOVER_DELAY);
    }

    function hideTooltip(){
      if(hoverTimer){clearTimeout(hoverTimer);hoverTimer=null;}
      tooltip.classList.remove('show');
      hoveredCell={x:-1,y:-1};
    }

    function showTooltip(x,y,mx,my){
      const t=grid[y][x];
      const lv=buildings[y][x];
      const poll=pollution[y][x];
      const fire=onFire[y][x];

      let html='';
      const typeNames={
        [EMPTY]:'Empty Land',[ROAD]:'Road',[RES]:'Residential Zone',[COM]:'Commercial Zone',
        [IND]:'Industrial Zone',[POWER]:'Power Plant',[POLICE]:'Police Station',
        [FIRE]:'Fire Station',[PARK]:'Park'
      };
      const typeIcons={
        [EMPTY]:'üèúÔ∏è',[ROAD]:'üõ§Ô∏è',[RES]:'üè†',[COM]:'üè™',[IND]:'üè≠',
        [POWER]:'‚ö°',[POLICE]:'üöî',[FIRE]:'üöí',[PARK]:'üå≥'
      };

      html+=`<div class="tooltip-title">${typeIcons[t]||''} ${typeNames[t]||'Unknown'}</div>`;

      if(t===EMPTY){
        html+=`<div class="tooltip-row"><span>Status</span><span>Vacant</span></div>`;
        const nearRoad=isNear(x,y,ROAD,1);
        html+=`<div class="tooltip-row ${nearRoad?'good':'bad'}"><span>Road Access</span><span>${nearRoad?'Yes':'No'}</span></div>`;
        if(poll>0.1)html+=`<div class="tooltip-row ${poll>0.4?'bad':'warn'}"><span>Pollution</span><span>${Math.floor(poll*100)}%</span></div>`;
        html+=`<div class="tooltip-hint">Zone this land with Residential, Commercial, or Industrial to start development. All zones need adjacent roads to grow.</div>`;
      }
      else if(t===ROAD){
        const connected=isNear(x,y,ROAD,1);
        html+=`<div class="tooltip-row"><span>Network</span><span>${connected?'Connected':'Isolated'}</span></div>`;
        html+=`<div class="tooltip-row"><span>Maintenance</span><span>$0/yr</span></div>`;
        html+=`<div class="tooltip-hint">Roads are essential! Zones must be adjacent to a road to develop. Roads have no maintenance cost - build freely to connect your city.</div>`;
      }
      else if(t===RES){
        html+=`<div class="tooltip-section">Status</div>`;
        if(lv===0){
          html+=`<div class="tooltip-row warn"><span>Development</span><span>Waiting...</span></div>`;
        }else{
          html+=`<div class="tooltip-row"><span>Level</span><span>${lv}/3</span></div>`;
          html+=`<div class="tooltip-row"><span>Population</span><span>${lv*80} people</span></div>`;
        }
        html+=`<div class="tooltip-section">Conditions</div>`;
        const nearRoad=isNear(x,y,ROAD,1);
        html+=`<div class="tooltip-row ${nearRoad?'good':'bad'}"><span>Road Access</span><span>${nearRoad?'‚úì Connected':'‚úó DISCONNECTED'}</span></div>`;
        if(!nearRoad&&lv>0)html+=`<div class="tooltip-row bad"><span>‚ö†Ô∏è Status</span><span>No population!</span></div>`;
        html+=`<div class="tooltip-row ${poll<0.2?'good':poll<0.4?'warn':'bad'}"><span>Pollution</span><span>${Math.floor(poll*100)}%${poll>=0.4?' (blocks growth)':''}</span></div>`;
        const nearPolice=isNear(x,y,POLICE,4);
        html+=`<div class="tooltip-row ${nearPolice?'good':'warn'}"><span>Police Coverage</span><span>${nearPolice?'‚úì Protected':'‚úó Unsafe'}</span></div>`;
        const nearFire=isNear(x,y,FIRE,4);
        html+=`<div class="tooltip-row ${nearFire?'good':'warn'}"><span>Fire Coverage</span><span>${nearFire?'‚úì Protected':'‚úó At Risk'}</span></div>`;
        const maintRes=Math.floor(maintenance[RES]*maintenanceSurge);
        if(lv>0)html+=`<div class="tooltip-row ${maintenanceSurge>1?'warn':''}"><span>Upkeep</span><span>$${maintRes}/year${maintenanceSurge>1?' ‚ö†Ô∏è':''}</span></div>`;
        html+=`<div class="tooltip-hint">Residents need road access to count towards population! Also needs: 30%+ power, low pollution (<40%), low crime (<60%).</div>`;
      }
      else if(t===COM){
        html+=`<div class="tooltip-section">Status</div>`;
        if(lv===0){
          html+=`<div class="tooltip-row warn"><span>Development</span><span>Waiting...</span></div>`;
        }else{
          html+=`<div class="tooltip-row"><span>Level</span><span>${lv}/3</span></div>`;
          const income=Math.floor(lv*TAX_COM*0.1*(happiness/50));
          html+=`<div class="tooltip-row good"><span>Tax Revenue</span><span>+$${income}/year</span></div>`;
        }
        html+=`<div class="tooltip-section">Conditions</div>`;
        const nearRoad=isNear(x,y,ROAD,1);
        html+=`<div class="tooltip-row ${nearRoad?'good':'bad'}"><span>Road Access</span><span>${nearRoad?'‚úì Connected':'‚úó DISCONNECTED'}</span></div>`;
        if(!nearRoad&&lv>0)html+=`<div class="tooltip-row bad"><span>‚ö†Ô∏è Status</span><span>No tax income!</span></div>`;
        const nearRes=countNear(x,y,RES,3);
        html+=`<div class="tooltip-row ${nearRes>0?'good':'bad'}"><span>Nearby Homes</span><span>${nearRes} zone${nearRes!==1?'s':''}</span></div>`;
        html+=`<div class="tooltip-row"><span>City Power</span><span>${powerCoverage}%</span></div>`;
        const maintCom=Math.floor(maintenance[COM]*maintenanceSurge);
        if(lv>0)html+=`<div class="tooltip-row ${maintenanceSurge>1?'warn':''}"><span>Upkeep</span><span>$${maintCom}/year${maintenanceSurge>1?' ‚ö†Ô∏è':''}</span></div>`;
        html+=`<div class="tooltip-hint">Shops need road access to generate tax income! Also needs: 30%+ power, nearby residential (3 tiles).</div>`;
      }
      else if(t===IND){
        html+=`<div class="tooltip-section">Status</div>`;
        if(lv===0){
          html+=`<div class="tooltip-row warn"><span>Development</span><span>Waiting...</span></div>`;
        }else{
          html+=`<div class="tooltip-row"><span>Level</span><span>${lv}/3</span></div>`;
          const income=Math.floor(lv*TAX_IND*0.1*(happiness/50));
          html+=`<div class="tooltip-row good"><span>Tax Revenue</span><span>+$${income}/year</span></div>`;
          html+=`<div class="tooltip-row bad"><span>Pollution Output</span><span>High</span></div>`;
        }
        html+=`<div class="tooltip-section">Conditions</div>`;
        const nearRoad=isNear(x,y,ROAD,1);
        html+=`<div class="tooltip-row ${nearRoad?'good':'bad'}"><span>Road Access</span><span>${nearRoad?'‚úì Connected':'‚úó DISCONNECTED'}</span></div>`;
        if(!nearRoad&&lv>0)html+=`<div class="tooltip-row bad"><span>‚ö†Ô∏è Status</span><span>No tax income!</span></div>`;
        html+=`<div class="tooltip-row"><span>City Power</span><span>${powerCoverage}%</span></div>`;
        const maintInd=Math.floor(maintenance[IND]*maintenanceSurge);
        if(lv>0)html+=`<div class="tooltip-row ${maintenanceSurge>1?'warn':''}"><span>Upkeep</span><span>$${maintInd}/year${maintenanceSurge>1?' ‚ö†Ô∏è':''}</span></div>`;
        html+=`<div class="tooltip-hint">Factories need road access to generate tax income! Also needs 30%+ power. Warning: Creates pollution - keep away from residential!</div>`;
      }
      else if(t===POWER){
        html+=`<div class="tooltip-section">Output</div>`;
        html+=`<div class="tooltip-row good"><span>Status</span><span>Online</span></div>`;
        html+=`<div class="tooltip-row"><span>Capacity</span><span>~15 building levels</span></div>`;
        html+=`<div class="tooltip-row ${powerCoverage>=50?'good':powerCoverage>=30?'warn':'bad'}"><span>City Coverage</span><span>${powerCoverage}%</span></div>`;
        html+=`<div class="tooltip-divider"></div>`;
        const maintPow=Math.floor(maintenance[POWER]*maintenanceSurge);
        html+=`<div class="tooltip-row ${maintenanceSurge>1?'warn':''}"><span>Upkeep</span><span>$${maintPow}/year${maintenanceSurge>1?' ‚ö†Ô∏è':''}</span></div>`;
        html+=`<div class="tooltip-hint">Power is critical! Below 30% = no development. Below 50% = happiness penalty. Build power plants early! Each supports about 15 building levels total.</div>`;
      }
      else if(t===POLICE){
        html+=`<div class="tooltip-section">Protection</div>`;
        html+=`<div class="tooltip-row good"><span>Status</span><span>Active</span></div>`;
        html+=`<div class="tooltip-row"><span>Coverage Radius</span><span>4 tiles</span></div>`;
        html+=`<div class="tooltip-row ${crimeLvl<30?'good':crimeLvl<60?'warn':'bad'}"><span>City Crime Rate</span><span>${Math.floor(crimeLvl)}%</span></div>`;
        html+=`<div class="tooltip-divider"></div>`;
        const maintPol=Math.floor(maintenance[POLICE]*maintenanceSurge);
        html+=`<div class="tooltip-row ${maintenanceSurge>1?'warn':''}"><span>Upkeep</span><span>$${maintPol}/year${maintenanceSurge>1?' ‚ö†Ô∏è':''}</span></div>`;
        html+=`<div class="tooltip-hint">Police reduce crime in a 4-tile radius. High crime (60%+) blocks residential growth and hurts happiness. Each station reduces city crime by ~20%. Crime increases with more buildings.</div>`;
      }
      else if(t===FIRE){
        html+=`<div class="tooltip-section">Protection</div>`;
        html+=`<div class="tooltip-row good"><span>Status</span><span>Active</span></div>`;
        html+=`<div class="tooltip-row"><span>Prevention Range</span><span>4 tiles</span></div>`;
        html+=`<div class="tooltip-row"><span>Containment Range</span><span>3 tiles</span></div>`;
        html+=`<div class="tooltip-divider"></div>`;
        const maintFir=Math.floor(maintenance[FIRE]*maintenanceSurge);
        html+=`<div class="tooltip-row ${maintenanceSurge>1?'warn':''}"><span>Upkeep</span><span>$${maintFir}/year${maintenanceSurge>1?' ‚ö†Ô∏è':''}</span></div>`;
        html+=`<div class="tooltip-hint">Fire stations prevent fires within 4 tiles and stop fire spread within 3 tiles. Without coverage, fires start randomly and spread to adjacent buildings, destroying them!</div>`;
      }
      else if(t===PARK){
        html+=`<div class="tooltip-section">Benefits</div>`;
        html+=`<div class="tooltip-row good"><span>Status</span><span>Active</span></div>`;
        html+=`<div class="tooltip-row good"><span>Happiness Bonus</span><span>+5%</span></div>`;
        html+=`<div class="tooltip-row good"><span>Pollution Reduction</span><span>1 tile radius</span></div>`;
        html+=`<div class="tooltip-row"><span>Crime Reduction</span><span>Slight</span></div>`;
        html+=`<div class="tooltip-divider"></div>`;
        const maintPark=Math.floor(maintenance[PARK]*maintenanceSurge);
        html+=`<div class="tooltip-row ${maintenanceSurge>1?'warn':''}"><span>Upkeep</span><span>$${maintPark}/year${maintenanceSurge>1?' ‚ö†Ô∏è':''}</span></div>`;
        html+=`<div class="tooltip-hint">Parks actively clean pollution in a 1-tile radius. They boost happiness, and slightly reduce crime. Essential buffers between industrial and residential zones!</div>`;
      }

      if(fire>0){
        html+=`<div class="tooltip-divider"></div>`;
        html+=`<div class="tooltip-row bad"><span>üî• ON FIRE!</span><span>${fire} turn${fire!==1?'s':''} left</span></div>`;
        html+=`<div class="tooltip-hint" style="color:#f44336">Fire spreads to adjacent buildings! Build fire stations nearby to contain it. When the timer expires, building loses 1 level.</div>`;
      }

      tooltip.innerHTML=html;
      tooltip.classList.add('show');

      // Position tooltip
      const tw=tooltip.offsetWidth,th=tooltip.offsetHeight;
      let tx=mx+15,ty=my+15;
      if(tx+tw>window.innerWidth-10)tx=mx-tw-15;
      if(ty+th>window.innerHeight-10)ty=my-th-15;
      tooltip.style.left=tx+'px';
      tooltip.style.top=ty+'px';
    }

    function handleDraw(e){
      if(!gameActive)return;
      const rect=canvas.getBoundingClientRect();
      const x=Math.floor((e.clientX-rect.left)/(rect.width/gridSize));
      const y=Math.floor((e.clientY-rect.top)/(rect.height/gridSize));
      if(x<0||x>=gridSize||y<0||y>=gridSize)return;
      const cost=costs[selectedTool];
      if(money<cost)return;

      if(selectedTool==='bulldoze'){
        if(grid[y][x]!==EMPTY){grid[y][x]=EMPTY;buildings[y][x]=0;onFire[y][x]=0;money-=cost;}
      }else if(grid[y][x]===EMPTY){
        const typeMap={residential:RES,commercial:COM,industrial:IND,road:ROAD,power:POWER,police:POLICE,fire:FIRE,park:PARK};
        grid[y][x]=typeMap[selectedTool];
        buildings[y][x]=0;
        money-=cost;
      }
      updateUI();draw();
    }

    function draw(){
      ctx.save();
      ctx.scale(zoomLevel,zoomLevel);
      ctx.fillStyle='#1a2634';
      ctx.fillRect(0,0,gridSize*CELL,gridSize*CELL);

      // Draw pollution overlay
      for(let y=0;y<gridSize;y++){
        for(let x=0;x<gridSize;x++){
          if(pollution[y][x]>0){
            ctx.fillStyle=`rgba(156,39,176,${pollution[y][x]*0.15})`;
            ctx.fillRect(x*CELL,y*CELL,CELL,CELL);
          }
        }
      }

      ctx.strokeStyle='#2a3f55';ctx.lineWidth=0.5;
      const totalSize=gridSize*CELL;
      for(let i=0;i<=gridSize;i++){ctx.beginPath();ctx.moveTo(i*CELL,0);ctx.lineTo(i*CELL,totalSize);ctx.stroke();ctx.beginPath();ctx.moveTo(0,i*CELL);ctx.lineTo(totalSize,i*CELL);ctx.stroke();}

      for(let y=0;y<gridSize;y++){
        for(let x=0;x<gridSize;x++){
          const t=grid[y][x],lv=buildings[y][x],px=x*CELL,py=y*CELL;

          if(t===ROAD){
            ctx.fillStyle='#3a4550';ctx.fillRect(px,py,CELL,CELL);
            // Check neighbors and draw connections
            const hasN=y>0&&grid[y-1][x]===ROAD;
            const hasS=y<gridSize-1&&grid[y+1][x]===ROAD;
            const hasW=x>0&&grid[y][x-1]===ROAD;
            const hasE=x<gridSize-1&&grid[y][x+1]===ROAD;
            ctx.fillStyle='#5a6570';
            const cx=px+CELL/2,cy=py+CELL/2,hw=3,hl=CELL/2;
            if(hasN)ctx.fillRect(cx-hw,py,hw*2,hl);
            if(hasS)ctx.fillRect(cx-hw,cy,hw*2,hl);
            if(hasW)ctx.fillRect(px,cy-hw,hl,hw*2);
            if(hasE)ctx.fillRect(cx,cy-hw,hl,hw*2);
            ctx.fillRect(cx-hw,cy-hw,hw*2,hw*2); // center
            // Yellow center line
            ctx.fillStyle='#ffd700';
            if(hasN||hasS)ctx.fillRect(cx-1,py+2,2,CELL-4);
            if(hasW||hasE)ctx.fillRect(px+2,cy-1,CELL-4,2);
            if(!hasN&&!hasS&&!hasW&&!hasE)ctx.fillRect(cx-1,cy-1,2,2);
          }
          else if(t===RES){ctx.fillStyle=lv>0?'#2d4a2d':'#1e331e';ctx.fillRect(px+1,py+1,CELL-2,CELL-2);if(lv>0)drawHouse(px,py,lv);}
          else if(t===COM){ctx.fillStyle=lv>0?'#1a4a7a':'#0d3560';ctx.fillRect(px+1,py+1,CELL-2,CELL-2);if(lv>0)drawShop(px,py,lv);}
          else if(t===IND){ctx.fillStyle=lv>0?'#4a3a2d':'#33281e';ctx.fillRect(px+1,py+1,CELL-2,CELL-2);if(lv>0)drawFactory(px,py,lv);}
          else if(t===POWER){ctx.fillStyle='#333';ctx.fillRect(px+1,py+1,CELL-2,CELL-2);ctx.fillStyle='#ffeb3b';ctx.fillRect(px+4,py+2,CELL-8,CELL-4);ctx.fillStyle='#ff5722';ctx.fillRect(px+CELL/2-1,py+CELL-4,2,4);}
          else if(t===POLICE){ctx.fillStyle='#3f51b5';ctx.fillRect(px+2,py+3,CELL-4,CELL-5);ctx.fillStyle='#fff';ctx.fillRect(px+CELL/2-2,py+4,4,3);}
          else if(t===FIRE){ctx.fillStyle='#c62828';ctx.fillRect(px+2,py+3,CELL-4,CELL-5);ctx.fillStyle='#fff';ctx.fillRect(px+3,py+CELL-4,CELL-6,2);}
          else if(t===PARK){ctx.fillStyle='#2e7d32';ctx.fillRect(px+1,py+1,CELL-2,CELL-2);ctx.fillStyle='#4caf50';ctx.beginPath();ctx.arc(px+CELL/2,py+CELL/2,4,0,Math.PI*2);ctx.fill();}

          if(onFire[y][x]>0){ctx.fillStyle=`rgba(255,${100+Math.random()*100},0,0.8)`;ctx.fillRect(px+2,py+2,CELL-4,CELL-4);}

          // v4: Show disconnected buildings (no road access) with red corner indicator
          if((t===RES||t===COM||t===IND)&&lv>0&&!isNear(x,y,ROAD,1)){
            ctx.fillStyle='#f44336';
            ctx.beginPath();
            ctx.moveTo(px+CELL-1,py+1);
            ctx.lineTo(px+CELL-1,py+6);
            ctx.lineTo(px+CELL-6,py+1);
            ctx.closePath();
            ctx.fill();
          }
        }
      }
      ctx.restore();
    }

    function drawHouse(px,py,lv){
      const h=3+lv*2,w=6+lv;
      ctx.fillStyle=['#4caf50','#66bb6a','#81c784'][lv-1];
      ctx.fillRect(px+(CELL-w)/2,py+CELL-h-1,w,h);
      ctx.fillStyle='#ffeb3b';
      ctx.fillRect(px+CELL/2-1,py+CELL-h,2,2);
    }

    function drawShop(px,py,lv){
      const h=4+lv*2,w=8+lv;
      ctx.fillStyle=['#00aaff','#00ccff','#33ddff'][lv-1];
      ctx.fillRect(px+(CELL-w)/2,py+CELL-h-1,w,h);
      ctx.fillStyle='#fff';
      ctx.fillRect(px+(CELL-w)/2+1,py+CELL-3,w-2,2);
    }

    function drawFactory(px,py,lv){
      const h=5+lv,w=9+lv;
      ctx.fillStyle=['#ff9800','#ffa726','#ffb74d'][lv-1];
      ctx.fillRect(px+(CELL-w)/2,py+CELL-h-1,w,h);
      ctx.fillStyle='#555';
      ctx.fillRect(px+CELL-4,py+CELL-h-3,2,3);
    }

    function isNear(x,y,type,range=2){
      for(let dy=-range;dy<=range;dy++){
        for(let dx=-range;dx<=range;dx++){
          const nx=x+dx,ny=y+dy;
          if(nx>=0&&nx<gridSize&&ny>=0&&ny<gridSize&&grid[ny][nx]===type)return true;
        }
      }
      return false;
    }

    function countNear(x,y,type,range=3){
      let c=0;
      for(let dy=-range;dy<=range;dy++){
        for(let dx=-range;dx<=range;dx++){
          const nx=x+dx,ny=y+dy;
          if(nx>=0&&nx<gridSize&&ny>=0&&ny<gridSize&&grid[ny][nx]===type)c++;
        }
      }
      return c;
    }

    function spreadPollution(){
      const newPoll=[];
      for(let y=0;y<gridSize;y++){newPoll[y]=[];for(let x=0;x<gridSize;x++)newPoll[y][x]=0;}
      for(let y=0;y<gridSize;y++){
        for(let x=0;x<gridSize;x++){
          // Industrial creates pollution (reduced for v3 balance)
          if(grid[y][x]===IND&&buildings[y][x]>0){
            const lvl=buildings[y][x];
            for(let dy=-2;dy<=2;dy++){
              for(let dx=-2;dx<=2;dx++){
                const nx=x+dx,ny=y+dy;
                if(nx>=0&&nx<gridSize&&ny>=0&&ny<gridSize){
                  newPoll[ny][nx]+=(0.15+lvl*0.03)/(1+Math.abs(dx)+Math.abs(dy)); // Reduced from 0.25+0.05
                }
              }
            }
          }
          // Parks actively clean pollution
          if(grid[y][x]===PARK){
            for(let dy=-1;dy<=1;dy++){
              for(let dx=-1;dx<=1;dx++){
                const nx=x+dx,ny=y+dy;
                if(nx>=0&&nx<gridSize&&ny>=0&&ny<gridSize){
                  newPoll[ny][nx]-=0.3;
                }
              }
            }
          }
          // Pollution drift reduced
          if(pollution[y][x]>0.2){
            const dirs=[[0,-1],[0,1],[-1,0],[1,0]];
            for(const[dx,dy]of dirs){
              const nx=x+dx,ny=y+dy;
              if(nx>=0&&nx<gridSize&&ny>=0&&ny<gridSize){
                newPoll[ny][nx]+=pollution[y][x]*0.01; // minimal spread
              }
            }
          }
        }
      }
      // Faster pollution decay - environment recovers quicker! (v3: 0.92->0.88)
      for(let y=0;y<gridSize;y++)for(let x=0;x<gridSize;x++)pollution[y][x]=Math.max(0,Math.min(1,(pollution[y][x]+newPoll[y][x])*0.88));
    }

    function startFire(){
      const candidates=[];
      for(let y=0;y<gridSize;y++){
        for(let x=0;x<gridSize;x++){
          if(buildings[y][x]>0&&onFire[y][x]===0&&!isNear(x,y,FIRE,4))candidates.push([x,y]);
        }
      }
      if(candidates.length>0){
        const [fx,fy]=candidates[Math.floor(Math.random()*candidates.length)];
        onFire[fy][fx]=3;
        showAlert('üî• FIRE!');
      }
    }

    function spreadFire(){
      const newFires=[];
      for(let y=0;y<gridSize;y++){
        for(let x=0;x<gridSize;x++){
          if(onFire[y][x]>0){
            onFire[y][x]--;
            if(onFire[y][x]===0&&buildings[y][x]>0){
              buildings[y][x]=Math.max(0,buildings[y][x]-1);
              if(buildings[y][x]===0)grid[y][x]=EMPTY;
            }
            if(!isNear(x,y,FIRE,3)&&Math.random()<0.3){
              const dirs=[[0,-1],[0,1],[-1,0],[1,0]];
              for(const[dx,dy]of dirs){
                const nx=x+dx,ny=y+dy;
                if(nx>=0&&nx<gridSize&&ny>=0&&ny<gridSize&&buildings[ny][nx]>0&&onFire[ny][nx]===0)newFires.push([nx,ny]);
              }
            }
          }
        }
      }
      for(const[fx,fy]of newFires)if(Math.random()<0.4)onFire[fy][fx]=3;
    }

    function showAlert(msg){
      alertEl.textContent=msg;
      alertEl.classList.add('show');
      setTimeout(()=>alertEl.classList.remove('show'),2000);
    }

    // Income ticker animation
    function showIncomeTicker(amount){
      const treasuryEl=document.getElementById('money');
      const rect=treasuryEl.getBoundingClientRect();
      const ticker=document.createElement('div');
      ticker.className='income-ticker '+(amount>=0?'positive':'negative');
      ticker.textContent=(amount>=0?'+':'')+amount;
      ticker.style.left=(rect.left+rect.width/2)+'px';
      ticker.style.top=(rect.bottom+5)+'px';
      document.body.appendChild(ticker);
      setTimeout(()=>ticker.remove(),1500);
    }

    // Loan system
    function takeLoan(){
      if(!gameActive)return;
      if(loanBalance>=MAX_LOAN){
        showAlert('üí≥ Max loan reached!');
        return;
      }
      const amount=Math.min(1000,MAX_LOAN-loanBalance);
      loanBalance+=amount;
      money+=amount;
      showIncomeTicker(amount);
      updateLoanUI();
      updateUI();
      showAlert('üí≥ Borrowed $'+amount);
    }

    function repayLoan(){
      if(!gameActive)return;
      if(loanBalance<=0){
        showAlert('üí≥ No loan to repay!');
        return;
      }
      const amount=Math.min(1000,loanBalance,money);
      if(amount<=0){
        showAlert('üí∏ Not enough money!');
        return;
      }
      loanBalance-=amount;
      money-=amount;
      showIncomeTicker(-amount);
      updateLoanUI();
      updateUI();
      showAlert('üí≥ Repaid $'+amount);
    }

    function updateLoanUI(){
      const info=document.getElementById('loanInfo');
      if(loanBalance>0){
        const interest=Math.floor(loanBalance*LOAN_INTEREST);
        info.textContent='Debt: $'+loanBalance.toLocaleString()+' ('+interest+'/yr interest)';
        info.style.color='#ff9800';
      }else{
        info.textContent='No active loans';
        info.style.color='#6a8299';
      }
    }

    // Budget modal
    function showBudgetModal(){
      const b=budgetData;
      const totalIncome=b.comTax+b.indTax+b.popBonus;
      const totalExpense=b.resMaint+b.comMaint+b.indMaint+b.powerMaint+b.policeMaint+b.fireMaint+b.parkMaint+b.loanInterest+(b.infraOverhead||0);
      const net=totalIncome-totalExpense;

      document.getElementById('budgetComTax').textContent='+$'+b.comTax;
      document.getElementById('budgetIndTax').textContent='+$'+b.indTax;
      document.getElementById('budgetPopBonus').textContent='+$'+b.popBonus;
      document.getElementById('budgetTotalIncome').textContent='+$'+totalIncome;

      document.getElementById('budgetResMaint').textContent='-$'+b.resMaint;
      document.getElementById('budgetComMaint').textContent='-$'+b.comMaint;
      document.getElementById('budgetIndMaint').textContent='-$'+b.indMaint;
      document.getElementById('budgetPowerMaint').textContent='-$'+b.powerMaint;
      document.getElementById('budgetPoliceMaint').textContent='-$'+b.policeMaint;
      document.getElementById('budgetFireMaint').textContent='-$'+b.fireMaint;
      document.getElementById('budgetParkMaint').textContent='-$'+b.parkMaint;
      document.getElementById('budgetLoanInterest').textContent='-$'+b.loanInterest;
      document.getElementById('budgetInfra').textContent='-$'+(b.infraOverhead||0);
      document.getElementById('budgetTotalExpense').textContent='-$'+totalExpense;

      document.getElementById('budgetNet').textContent=(net>=0?'+':'')+net;
      document.getElementById('budgetNetRow').className='budget-row total '+(net>=0?'positive':'negative');
      document.getElementById('budgetTreasury').textContent='$'+money.toLocaleString();
      document.getElementById('budgetLoans').textContent='$'+loanBalance.toLocaleString();

      document.getElementById('budgetModal').classList.add('show');
    }

    function closeBudgetModal(){
      document.getElementById('budgetModal').classList.remove('show');
    }

    function gameTick(){
      if(gameSpeed===0||!gameActive)return;
      tickCount++;

      // v4: Road connectivity matters - only connected buildings function properly
      let resB=0,comB=0,indB=0,svc=0,powerPlants=0,policeCount=0,fireCount=0,parkCount=0;
      let resBConnected=0,comBConnected=0,indBConnected=0; // Only connected buildings generate income
      for(let y=0;y<gridSize;y++){
        for(let x=0;x<gridSize;x++){
          const t=grid[y][x],lv=buildings[y][x];
          const hasRoad=isNear(x,y,ROAD,1);
          if(t===RES&&lv>0){resB+=lv;if(hasRoad)resBConnected+=lv;}
          else if(t===COM&&lv>0){comB+=lv;if(hasRoad)comBConnected+=lv;}
          else if(t===IND&&lv>0){indB+=lv;if(hasRoad)indBConnected+=lv;}
          else if(t===POWER){powerPlants++;svc++;}
          else if(t===POLICE){policeCount++;svc++;}
          else if(t===FIRE){fireCount++;svc++;}
          else if(t===PARK){parkCount++;svc++;}
        }
      }

      const totalBuildings=resB+comB+indB;
      powerCoverage=totalBuildings>0?Math.min(100,Math.floor(powerPlants*15/totalBuildings*100)):100;

      // v4: Crime scales with city size, police reduce by percentage
      const baseCrime=Math.min(100,totalBuildings*2); // More buildings = more crime
      const policeReduction=Math.pow(0.7,policeCount); // Each police reduces crime by 30%
      const parkCrimeReduction=Math.pow(0.95,parkCount); // Parks reduce crime by 5% each
      crimeLvl=Math.floor(baseCrime*policeReduction*parkCrimeReduction);

      spreadPollution();
      let totalPoll=0,pollCount=0;
      for(let y=0;y<gridSize;y++)for(let x=0;x<gridSize;x++)if(grid[y][x]===RES){totalPoll+=pollution[y][x];pollCount++;}
      pollutionLvl=pollCount>0?Math.floor(totalPoll/pollCount*100):0;

      // Happiness calculation (v4: diminishing returns on parks)
      const powerPenalty=powerCoverage<50?(50-powerCoverage)*0.5:0;
      const crimePenalty=crimeLvl*0.3;
      const pollPenalty=pollutionLvl*0.2;
      const parkBonus=Math.min(30,parkCount*5*(1-parkCount*0.03)); // Diminishing returns, cap at 30
      const comBonus=Math.min(20,Math.sqrt(comB)*4); // Diminishing returns on commercial happiness
      happiness=Math.max(0,Math.min(100,50-powerPenalty-crimePenalty-pollPenalty+parkBonus+comBonus));

      // Demand affected by happiness
      const happinessMod=happiness/50;
      demandR=Math.max(0,Math.min(100,50+(comB+indB-resB*0.7)*2*happinessMod));
      demandC=Math.max(0,Math.min(100,50+(resB*0.4-comB)*2*happinessMod));
      demandI=Math.max(0,Math.min(100,50+(resB*0.2+comB*0.2-indB)*2));

      // Development - much harder
      if(tickCount%(12/gameSpeed)===0){
        for(let y=0;y<gridSize;y++){
          for(let x=0;x<gridSize;x++){
            const t=grid[y][x],lv=buildings[y][x];
            if(t<RES||t>IND)continue;
            if(!isNear(x,y,ROAD,1))continue;
            if(lv>=3)continue;
            if(powerCoverage<30)continue;

            // REBALANCED: Easier growth conditions
            let demand=0,canGrow=false;
            if(t===RES&&demandR>=35&&pollution[y][x]<0.5&&crimeLvl<70){demand=demandR;canGrow=true;}
            else if(t===COM&&demandC>=35&&isNear(x,y,RES,4)){demand=demandC;canGrow=true;}
            else if(t===IND&&demandI>=35){demand=demandI;canGrow=true;}

            // Faster growth rate
            if(canGrow&&Math.random()<(demand-20)/150*happinessMod){
              buildings[y][x]++;
            }

            // Decay only at very low happiness
            if(lv>0&&happiness<20&&Math.random()<0.01){
              buildings[y][x]--;
              if(buildings[y][x]===0)grid[y][x]=EMPTY;
            }
          }
        }
      }

      // v4: Fire risk scales with city size (5% base + 0.3% per 10 buildings, max 20%)
      const fireChance=Math.min(0.20,0.05+totalBuildings*0.003);
      if(tickCount%(60/gameSpeed)===0&&Math.random()<fireChance&&totalBuildings>8){
        startFire();
      }
      spreadFire();

      // Economy - v4: Only road-connected buildings generate income!
      population=resBConnected*80; // Only connected residential counts for population
      const taxRate=0.15;
      const comTaxIncome=Math.floor(comBConnected*TAX_COM*taxRate*happinessMod); // Only connected commercial
      const indTaxIncome=Math.floor(indBConnected*TAX_IND*taxRate*happinessMod); // Only connected industrial
      const popBonus=Math.floor(population*POP_BONUS); // $0.05 per citizen bonus
      const income=comTaxIncome+indTaxIncome+popBonus;

      // Detailed maintenance tracking
      let resMaint=0,comMaint=0,indMaint=0,powMaint=0,polMaint=0,firMaint=0,parkMaint=0;
      for(let y=0;y<gridSize;y++){
        for(let x=0;x<gridSize;x++){
          const t=grid[y][x];
          if(t===RES)resMaint+=maintenance[RES];
          else if(t===COM)comMaint+=maintenance[COM];
          else if(t===IND)indMaint+=maintenance[IND];
          else if(t===POWER)powMaint+=maintenance[POWER];
          else if(t===POLICE)polMaint+=maintenance[POLICE];
          else if(t===FIRE)firMaint+=maintenance[FIRE];
          else if(t===PARK)parkMaint+=maintenance[PARK];
        }
      }
      // Apply maintenance surge multiplier
      resMaint=Math.floor(resMaint*maintenanceSurge);
      comMaint=Math.floor(comMaint*maintenanceSurge);
      indMaint=Math.floor(indMaint*maintenanceSurge);
      powMaint=Math.floor(powMaint*maintenanceSurge);
      polMaint=Math.floor(polMaint*maintenanceSurge);
      firMaint=Math.floor(firMaint*maintenanceSurge);
      parkMaint=Math.floor(parkMaint*maintenanceSurge);
      const loanInterestCost=Math.floor(loanBalance*LOAN_INTEREST);
      // v4: Infrastructure overhead scales with city size ($1 per 10 building levels)
      const infraOverhead=Math.floor(totalBuildings/10);
      const maint=resMaint+comMaint+indMaint+powMaint+polMaint+firMaint+parkMaint+loanInterestCost+infraOverhead;

      // Update budget data
      budgetData={comTax:comTaxIncome,indTax:indTaxIncome,popBonus:popBonus,resMaint:resMaint,comMaint:comMaint,indMaint:indMaint,powerMaint:powMaint,policeMaint:polMaint,fireMaint:firMaint,parkMaint:parkMaint,loanInterest:loanInterestCost,infraOverhead:infraOverhead};

      if(tickCount%(40/gameSpeed)===0){
        // Handle maintenance surge countdown
        if(surgeYearsLeft>0){
          surgeYearsLeft--;
          if(surgeYearsLeft===0){
            maintenanceSurge=1;
            surgeName='';
            showAlert('üìâ Costs normalized');
          }
        }

        // Random maintenance surge events - less frequent (6%) and milder
        if(year>10&&maintenanceSurge===1&&Math.random()<0.06){
          const surges=[
            {name:'‚ö° Power Grid Strain',mult:1.2,dur:2,msg:'Power costs +20% for 2 years'},
            {name:'üîß Minor Repairs',mult:1.25,dur:2,msg:'Maintenance +25% for 2 years'},
            {name:'üí∏ Wage Increase',mult:1.15,dur:3,msg:'Service costs +15% for 3 years'},
            {name:'üìà Material Costs',mult:1.2,dur:2,msg:'Upkeep +20% for 2 years'}
          ];
          const surge=surges[Math.floor(Math.random()*surges.length)];
          maintenanceSurge=surge.mult;
          surgeYearsLeft=surge.dur;
          surgeName=surge.name;
          showAlert(surge.name+' '+surge.msg);
        }

        lastIncome=income-maint;
        money+=lastIncome;
        year++;
        // Show income ticker animation
        showIncomeTicker(lastIncome);

        // More forgiving bankruptcy threshold
        if(money<-2000){
          gameActive=false;
          document.getElementById('finalStats').textContent=`Population: ${population} | Year: ${year}`;
          gameOverEl.classList.add('show');
        }
      }

      updateUI();draw();
    }

    function updateUI(){
      document.getElementById('population').textContent=population.toLocaleString();
      document.getElementById('money').textContent='$'+money.toLocaleString();
      document.getElementById('money').className='stat-value'+(money<0?' negative':money<500?' warning':'');
      const incomeText=(lastIncome>=0?'+':'')+lastIncome+(maintenanceSurge>1?' ‚ö†Ô∏è':'');
      document.getElementById('income').textContent=incomeText;
      document.getElementById('income').className='stat-value'+(lastIncome<0?' negative':maintenanceSurge>1?' warning':'');
      document.getElementById('income').title=maintenanceSurge>1?`${surgeName}: ${Math.round((maintenanceSurge-1)*100)}% extra costs (${surgeYearsLeft}yr left)`:'';
      document.getElementById('date').textContent='Year '+year;
      document.getElementById('happiness').textContent=Math.floor(happiness)+'%';
      document.getElementById('happiness').className='stat-value'+(happiness<30?' negative':happiness<50?' warning':'');

      document.getElementById('demandR').style.width=demandR+'%';
      document.getElementById('demandC').style.width=demandC+'%';
      document.getElementById('demandI').style.width=demandI+'%';

      document.getElementById('powerBar').style.width=powerCoverage+'%';
      document.getElementById('powerPct').textContent=powerCoverage+'%';
      document.getElementById('crimeBar').style.width=crimeLvl+'%';
      document.getElementById('crimePct').textContent=Math.floor(crimeLvl)+'%';
      document.getElementById('pollBar').style.width=pollutionLvl+'%';
      document.getElementById('pollPct').textContent=pollutionLvl+'%';

      let res=0,com=0,ind=0,svc=0;
      for(let y=0;y<gridSize;y++){
        for(let x=0;x<gridSize;x++){
          if(grid[y][x]===RES&&buildings[y][x]>0)res++;
          if(grid[y][x]===COM&&buildings[y][x]>0)com++;
          if(grid[y][x]===IND&&buildings[y][x]>0)ind++;
          if(grid[y][x]>=POWER)svc++;
        }
      }
      document.getElementById('resCount').textContent=res;
      document.getElementById('comCount').textContent=com;
      document.getElementById('indCount').textContent=ind;
      document.getElementById('svcCount').textContent=svc;
    }

    const SLOT_NAMES=['City Alpha','City Beta','City Gamma','City Delta','City Omega'];
    let currentSlot=null;
    let modalMode='save';

    function getSaveData(){
      return {
        gridSize:gridSize,
        grid:grid,buildings:buildings,onFire:onFire,pollution:pollution,
        money:money,population:population,year:year,tickCount:tickCount,
        demandR:demandR,demandC:demandC,demandI:demandI,
        happiness:happiness,powerCoverage:powerCoverage,crimeLvl:crimeLvl,pollutionLvl:pollutionLvl,
        lastIncome:lastIncome,gameActive:gameActive,savedAt:Date.now(),
        maintenanceSurge:maintenanceSurge,surgeYearsLeft:surgeYearsLeft,surgeName:surgeName,
        loanBalance:loanBalance
      };
    }

    function saveToSlot(slot){
      try{
        const saveData=getSaveData();
        saveData.slotName=SLOT_NAMES[slot];
        localStorage.setItem('microCity_slot'+slot,JSON.stringify(saveData));
        localStorage.setItem('microCity_lastSlot',slot.toString());
        currentSlot=slot;
        showAlert('üíæ Saved to '+SLOT_NAMES[slot]);
        closeModal();
      }catch(e){showAlert('‚ùå Save Failed!');}
    }

    function loadFromSlot(slot){
      try{
        const data=localStorage.getItem('microCity_slot'+slot);
        if(!data){showAlert('üìÇ Slot Empty');return;}
        const save=JSON.parse(data);
        // Restore grid size (default to 36 for old saves)
        const savedSize=save.gridSize||36;
        initGrid(savedSize);
        for(let y=0;y<gridSize;y++){
          for(let x=0;x<gridSize;x++){
            grid[y][x]=save.grid[y]?.[x]??EMPTY;
            buildings[y][x]=save.buildings[y]?.[x]??0;
            onFire[y][x]=save.onFire[y]?.[x]??0;
            pollution[y][x]=save.pollution[y]?.[x]??0;
          }
        }
        money=save.money;population=save.population;year=save.year;tickCount=save.tickCount;
        demandR=save.demandR;demandC=save.demandC;demandI=save.demandI;
        happiness=save.happiness;powerCoverage=save.powerCoverage;crimeLvl=save.crimeLvl;pollutionLvl=save.pollutionLvl;
        maintenanceSurge=save.maintenanceSurge||1;surgeYearsLeft=save.surgeYearsLeft||0;surgeName=save.surgeName||'';
        loanBalance=save.loanBalance||0;
        lastIncome=save.lastIncome;gameActive=save.gameActive!==false;
        updateLoanUI();
        currentSlot=slot;
        localStorage.setItem('microCity_lastSlot',slot.toString());
        // Show game over if loaded a bankrupt save
        if(!gameActive||money<=-1000){
          gameActive=false;
          document.getElementById('finalStats').textContent=`Population: ${population} | Year: ${year}`;
          gameOverEl.classList.add('show');
        }else{
          gameOverEl.classList.remove('show');
        }
        updateUI();draw();
        showAlert('üìÇ Loaded '+SLOT_NAMES[slot]);
        closeModal();
      }catch(e){showAlert('‚ùå Load Failed!');}
    }

    function getSlotInfo(slot){
      try{
        const data=localStorage.getItem('microCity_slot'+slot);
        if(!data)return null;
        const save=JSON.parse(data);
        return {pop:save.population,year:save.year,money:save.money,savedAt:save.savedAt,size:save.gridSize||36};
      }catch(e){return null;}
    }

    function renderSlots(){
      const list=document.getElementById('slotList');
      list.innerHTML='';
      for(let i=0;i<5;i++){
        const info=getSlotInfo(i);
        const div=document.createElement('div');
        div.className='slot';
        if(info){
          const date=info.savedAt?new Date(info.savedAt).toLocaleDateString():'';
          div.innerHTML=`<div class="slot-name">${SLOT_NAMES[i]}</div><div class="slot-info">üë• ${info.pop.toLocaleString()} | üìÖ Year ${info.year} | üí∞ $${info.money.toLocaleString()} | üó∫Ô∏è ${info.size}x${info.size}<br>${date}</div>`;
        }else{
          div.innerHTML=`<div class="slot-name">${SLOT_NAMES[i]}</div><div class="slot-info slot-empty">Empty Slot</div>`;
        }
        div.onclick=()=>modalMode==='save'?saveToSlot(i):loadFromSlot(i);
        list.appendChild(div);
      }
    }

    function showSaveModal(){
      modalMode='save';
      document.getElementById('modalTitle').textContent='üíæ Save Game';
      renderSlots();
      document.getElementById('saveModal').classList.add('show');
    }

    function showLoadModal(){
      modalMode='load';
      document.getElementById('modalTitle').textContent='üìÇ Load Game';
      renderSlots();
      document.getElementById('saveModal').classList.add('show');
    }

    function closeModal(){document.getElementById('saveModal').classList.remove('show');}

    function showNewGameModal(){document.getElementById('newGameModal').classList.add('show');}
    function closeNewGameModal(){document.getElementById('newGameModal').classList.remove('show');}

    function newGameWithSave(){
      closeNewGameModal();
      showSaveModal();
      modalMode='save';
      // After save, start new game
      const origSave=saveToSlot;
      saveToSlot=function(slot){
        origSave(slot);
        saveToSlot=origSave;
        resetGame();
      };
    }

    function newGameNow(){
      closeNewGameModal();
      resetGame();
    }

    function resetGame(){
      // Reset grid size and zoom
      zoomLevel=1;
      initGrid(36);
      // Reset all game state to defaults - generous starting conditions!
      money=10000;population=0;year=1;tickCount=0;gameActive=true;
      gameSpeed=1;selectedTool='residential';
      demandR=50;demandC=50;demandI=50;happiness=60;powerCoverage=0;crimeLvl=0;pollutionLvl=0;lastIncome=0;
      maintenanceSurge=1;surgeYearsLeft=0;surgeName='';
      loanBalance=0;
      budgetData={comTax:0,indTax:0,popBonus:0,resMaint:0,comMaint:0,indMaint:0,powerMaint:0,policeMaint:0,fireMaint:0,parkMaint:0,loanInterest:0};
      currentSlot=null;
      updateLoanUI();
      // Reset UI buttons
      document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('active'));
      document.querySelector('.tool-btn.residential').classList.add('active');
      document.querySelectorAll('.speed-btn').forEach(b=>b.classList.remove('active'));
      document.querySelector('.speed-btn[data-speed="1"]').classList.add('active');
      gameOverEl.classList.remove('show');
      updateUI();draw();
      showAlert('üÜï New City Started!');
    }

    // Auto-assign new games to first empty slot (or slot 0 if all full)
    function ensureSlotAssigned(){
      if(currentSlot===null){
        for(let i=0;i<5;i++){
          if(!getSlotInfo(i)){currentSlot=i;return;}
        }
        currentSlot=0; // fallback to slot 0 if all full
      }
    }

    // Auto-load last played slot
    (function(){
      const lastSlot=localStorage.getItem('microCity_lastSlot');
      if(lastSlot!==null){
        const slot=parseInt(lastSlot);
        if(getSlotInfo(slot)){loadFromSlot(slot);return;}
      }
      // Fallback: load first available slot
      for(let i=0;i<5;i++){
        if(getSlotInfo(i)){loadFromSlot(i);return;}
      }
      // No saves exist - this is a fresh start, save immediately after a short delay
      setTimeout(()=>{
        if(gameActive&&currentSlot===null){
          ensureSlotAssigned();
          const saveData=getSaveData();
          saveData.slotName=SLOT_NAMES[currentSlot];
          try{
            localStorage.setItem('microCity_slot'+currentSlot,JSON.stringify(saveData));
            localStorage.setItem('microCity_lastSlot',currentSlot.toString());
          }catch(e){}
        }
      },2000);
    })();

    // Autosave every 30 seconds to current slot
    setInterval(()=>{
      if(gameActive){
        ensureSlotAssigned();
        const saveData=getSaveData();
        saveData.slotName=SLOT_NAMES[currentSlot];
        try{
          localStorage.setItem('microCity_slot'+currentSlot,JSON.stringify(saveData));
          localStorage.setItem('microCity_lastSlot',currentSlot.toString());
        }catch(e){}
      }
    },30000);

    // Save on window close to current slot
    window.addEventListener('beforeunload',()=>{
      if(gameActive){
        ensureSlotAssigned();
        const saveData=getSaveData();
        saveData.slotName=SLOT_NAMES[currentSlot];
        try{
          localStorage.setItem('microCity_slot'+currentSlot,JSON.stringify(saveData));
          localStorage.setItem('microCity_lastSlot',currentSlot.toString());
        }catch(e){}
      }
    });

    setInterval(gameTick,400);
    draw();updateUI();
  </script>
<script src="/apps/sloppy-header/sloppy-bar.js"></script>
<script src="/vibelib-extended.js"></script>
<script>
  // Compatibility Patch for Legacy Apps
  window.addEventListener("load", () => {
    if (window.SloppyKarma && window.VibeLib.Economy) {
      // Redirect old calls to new engine
      window.SloppyKarma.track = window.VibeLib.Economy.track;
    }
  });
</script>
</body>
</html>
