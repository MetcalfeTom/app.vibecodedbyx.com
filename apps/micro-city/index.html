<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Micro City</title>
  <link rel="icon" href="https://emojicdn.elk.sh/üèôÔ∏è">
  <meta property="og:title" content="Micro City">
  <meta property="og:description" content="Build and survive in this challenging city sim!">
  <meta property="og:url" content="https://sloppy.live/micro-city">
  <meta property="og:image" content="https://sloppy.live/micro-city/og-image.png">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&family=Space+Mono&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #1a2634; min-height: 100vh; font-family: 'Outfit', sans-serif; color: #e0e8f0; display: flex; flex-direction: column; }
    .header { background: #0d1520; padding: 8px 15px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px; border-bottom: 2px solid #2a3f55; }
    h1 { font-size: 1.2rem; font-weight: 700; color: #4fc3f7; display: flex; align-items: center; gap: 8px; }
    .stats { display: flex; gap: 12px; font-family: 'Space Mono', monospace; font-size: 0.75rem; flex-wrap: wrap; }
    .stat { display: flex; align-items: center; gap: 4px; }
    .stat-icon { font-size: 1rem; }
    .stat-value { color: #4fc3f7; font-weight: 700; }
    .stat-value.negative { color: #f44336; }
    .stat-value.warning { color: #ff9800; }
    .main { display: flex; flex: 1; overflow: hidden; }
    .toolbar { background: #0d1520; padding: 10px; display: flex; flex-direction: column; gap: 6px; border-right: 2px solid #2a3f55; width: 160px; overflow-y: auto; }
    .tool-section { margin-bottom: 6px; }
    .tool-label { font-size: 0.6rem; color: #6a8299; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
    .tools { display: flex; flex-direction: column; gap: 4px; }
    .tool-btn { background: #1a2634; border: 2px solid #2a3f55; padding: 6px 8px; font-family: 'Outfit', sans-serif; font-size: 0.7rem; color: #e0e8f0; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
    .tool-btn:hover { background: #2a3f55; }
    .tool-btn.active { border-color: #4fc3f7; background: rgba(79, 195, 247, 0.15); }
    .tool-btn.residential { border-left: 3px solid #4caf50; }
    .tool-btn.commercial { border-left: 3px solid #2196f3; }
    .tool-btn.industrial { border-left: 3px solid #ff9800; }
    .tool-btn.road { border-left: 3px solid #9e9e9e; }
    .tool-btn.power { border-left: 3px solid #ffeb3b; }
    .tool-btn.police { border-left: 3px solid #3f51b5; }
    .tool-btn.fire { border-left: 3px solid #f44336; }
    .tool-btn.park { border-left: 3px solid #8bc34a; }
    .tool-btn.bulldoze { border-left: 3px solid #f44336; }
    .tool-btn.save-btn { border-left: 3px solid #4fc3f7; }
    .tool-btn.load-btn { border-left: 3px solid #ab47bc; }
    .tool-cost { margin-left: auto; font-size: 0.6rem; color: #6a8299; }
    .canvas-container { flex: 1; display: flex; align-items: center; justify-content: center; padding: 10px; overflow: auto; position: relative; }
    canvas { border: 2px solid #2a3f55; border-radius: 6px; cursor: crosshair; }
    .panel { background: #0d1520; padding: 10px; border-left: 2px solid #2a3f55; width: 180px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; font-size: 0.75rem; }
    .panel-title { font-size: 0.7rem; font-weight: 700; color: #4fc3f7; margin-bottom: 6px; }
    .demand-bars { display: flex; flex-direction: column; gap: 4px; }
    .demand-row { display: flex; align-items: center; gap: 6px; }
    .demand-label { width: 16px; font-size: 0.65rem; font-weight: 700; }
    .demand-label.r { color: #4caf50; }
    .demand-label.c { color: #2196f3; }
    .demand-label.i { color: #ff9800; }
    .demand-bar-bg { flex: 1; height: 8px; background: #1a2634; border-radius: 3px; overflow: hidden; }
    .demand-bar { height: 100%; transition: width 0.3s; }
    .demand-bar.r { background: #4caf50; }
    .demand-bar.c { background: #2196f3; }
    .demand-bar.i { background: #ff9800; }
    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
    .info-item { background: #1a2634; padding: 6px; border-radius: 4px; text-align: center; }
    .info-value { font-size: 0.9rem; font-weight: 700; color: #4fc3f7; }
    .info-label { font-size: 0.55rem; color: #6a8299; text-transform: uppercase; }
    .meter { margin-bottom: 8px; }
    .meter-label { display: flex; justify-content: space-between; font-size: 0.6rem; margin-bottom: 2px; }
    .meter-bar { height: 6px; background: #1a2634; border-radius: 3px; overflow: hidden; }
    .meter-fill { height: 100%; transition: width 0.3s; }
    .meter-fill.happiness { background: linear-gradient(90deg, #f44336, #ff9800, #4caf50); }
    .meter-fill.power { background: #ffeb3b; }
    .meter-fill.crime { background: #f44336; }
    .speed-controls { display: flex; gap: 3px; }
    .speed-btn { flex: 1; background: #1a2634; border: 1px solid #2a3f55; padding: 4px; color: #e0e8f0; cursor: pointer; border-radius: 3px; font-size: 0.7rem; }
    .speed-btn:hover { background: #2a3f55; }
    .speed-btn.active { background: #4fc3f7; color: #0d1520; }
    .alert { position: fixed; top: 60px; left: 50%; transform: translateX(-50%); background: #f44336; color: #fff; padding: 10px 20px; border-radius: 6px; font-weight: 700; z-index: 100; animation: alertPulse 0.5s ease-out; display: none; }
    .alert.show { display: block; }
    @keyframes alertPulse { 0% { transform: translateX(-50%) scale(0.8); } 50% { transform: translateX(-50%) scale(1.1); } 100% { transform: translateX(-50%) scale(1); } }
    .game-over { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 200; display: none; }
    .game-over.show { display: flex; }
    .game-over h2 { font-size: 2rem; color: #f44336; margin-bottom: 10px; }
    .game-over p { color: #888; margin-bottom: 20px; }
    .game-over button { background: #4fc3f7; border: none; padding: 12px 30px; font-family: 'Outfit', sans-serif; font-size: 1rem; color: #0d1520; cursor: pointer; border-radius: 6px; }
    .back-link { text-align: center; padding: 8px; color: #2a3f55; text-decoration: none; font-size: 0.6rem; }
    .back-link:hover { color: #4fc3f7; }
    @media (max-width: 900px) {
      .main { flex-direction: column; }
      .toolbar { width: 100%; flex-direction: row; flex-wrap: wrap; border-right: none; border-bottom: 2px solid #2a3f55; }
      .tool-section { margin-bottom: 0; }
      .tools { flex-direction: row; flex-wrap: wrap; }
      .panel { width: 100%; border-left: none; border-top: 2px solid #2a3f55; flex-direction: row; flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <div class="alert" id="alert">üî• FIRE!</div>
  <div class="game-over" id="gameOver">
    <h2>BANKRUPTCY!</h2>
    <p>Your city ran out of money.</p>
    <p id="finalStats"></p>
    <button onclick="location.reload()">Try Again</button>
  </div>
  <header class="header">
    <h1>üèôÔ∏è Micro City</h1>
    <div class="stats">
      <div class="stat"><span class="stat-icon">üë•</span><span class="stat-value" id="population">0</span></div>
      <div class="stat"><span class="stat-icon">üí∞</span><span class="stat-value" id="money">$5,000</span></div>
      <div class="stat"><span class="stat-icon">üìà</span><span class="stat-value" id="income">+$0</span></div>
      <div class="stat"><span class="stat-icon">üìÖ</span><span class="stat-value" id="date">Year 1</span></div>
      <div class="stat"><span class="stat-icon">üòä</span><span class="stat-value" id="happiness">50%</span></div>
    </div>
  </header>
  <div class="main">
    <div class="toolbar">
      <div class="tool-section">
        <div class="tool-label">Zones</div>
        <div class="tools">
          <button class="tool-btn residential active" data-tool="residential">üè† Res<span class="tool-cost">$150</span></button>
          <button class="tool-btn commercial" data-tool="commercial">üè™ Com<span class="tool-cost">$200</span></button>
          <button class="tool-btn industrial" data-tool="industrial">üè≠ Ind<span class="tool-cost">$250</span></button>
        </div>
      </div>
      <div class="tool-section">
        <div class="tool-label">Infrastructure</div>
        <div class="tools">
          <button class="tool-btn road" data-tool="road">üõ§Ô∏è Road<span class="tool-cost">$75</span></button>
          <button class="tool-btn power" data-tool="power">‚ö° Power<span class="tool-cost">$500</span></button>
        </div>
      </div>
      <div class="tool-section">
        <div class="tool-label">Services</div>
        <div class="tools">
          <button class="tool-btn police" data-tool="police">üöî Police<span class="tool-cost">$750</span></button>
          <button class="tool-btn fire" data-tool="fire">üöí Fire<span class="tool-cost">$750</span></button>
          <button class="tool-btn park" data-tool="park">üå≥ Park<span class="tool-cost">$300</span></button>
        </div>
      </div>
      <div class="tool-section">
        <div class="tool-label">Tools</div>
        <div class="tools">
          <button class="tool-btn bulldoze" data-tool="bulldoze">üí• Bulldoze<span class="tool-cost">$25</span></button>
        </div>
      </div>
      <div class="tool-section">
        <div class="tool-label">Save/Load</div>
        <div class="tools">
          <button class="tool-btn save-btn" onclick="saveGame()">üíæ Save</button>
          <button class="tool-btn load-btn" onclick="loadGame()">üìÇ Load</button>
        </div>
      </div>
    </div>
    <div class="canvas-container">
      <canvas id="city"></canvas>
    </div>
    <div class="panel">
      <div>
        <div class="panel-title">RCI Demand</div>
        <div class="demand-bars">
          <div class="demand-row"><span class="demand-label r">R</span><div class="demand-bar-bg"><div class="demand-bar r" id="demandR" style="width:50%"></div></div></div>
          <div class="demand-row"><span class="demand-label c">C</span><div class="demand-bar-bg"><div class="demand-bar c" id="demandC" style="width:50%"></div></div></div>
          <div class="demand-row"><span class="demand-label i">I</span><div class="demand-bar-bg"><div class="demand-bar i" id="demandI" style="width:50%"></div></div></div>
        </div>
      </div>
      <div>
        <div class="panel-title">City Health</div>
        <div class="meter"><div class="meter-label"><span>Power</span><span id="powerPct">0%</span></div><div class="meter-bar"><div class="meter-fill power" id="powerBar" style="width:0%"></div></div></div>
        <div class="meter"><div class="meter-label"><span>Crime</span><span id="crimePct">0%</span></div><div class="meter-bar"><div class="meter-fill crime" id="crimeBar" style="width:0%"></div></div></div>
        <div class="meter"><div class="meter-label"><span>Pollution</span><span id="pollPct">0%</span></div><div class="meter-bar"><div class="meter-fill" id="pollBar" style="width:0%;background:#9c27b0"></div></div></div>
      </div>
      <div>
        <div class="panel-title">Buildings</div>
        <div class="info-grid">
          <div class="info-item"><div class="info-value" id="resCount">0</div><div class="info-label">Homes</div></div>
          <div class="info-item"><div class="info-value" id="comCount">0</div><div class="info-label">Shops</div></div>
          <div class="info-item"><div class="info-value" id="indCount">0</div><div class="info-label">Factory</div></div>
          <div class="info-item"><div class="info-value" id="svcCount">0</div><div class="info-label">Services</div></div>
        </div>
      </div>
      <div>
        <div class="panel-title">Speed</div>
        <div class="speed-controls">
          <button class="speed-btn" data-speed="0">‚è∏</button>
          <button class="speed-btn active" data-speed="1">‚ñ∂</button>
          <button class="speed-btn" data-speed="2">‚ñ∂‚ñ∂</button>
          <button class="speed-btn" data-speed="3">‚ñ∂‚ñ∂‚ñ∂</button>
        </div>
      </div>
    </div>
  </div>
  <a href="https://sloppy.live" class="back-link">sloppy.live</a>
  <script>
    const canvas = document.getElementById('city');
    const ctx = canvas.getContext('2d');
    const alertEl = document.getElementById('alert');
    const gameOverEl = document.getElementById('gameOver');

    const GRID = 36, CELL = 14;
    canvas.width = GRID * CELL;
    canvas.height = GRID * CELL;

    const EMPTY=0,ROAD=1,RES=2,COM=3,IND=4,POWER=5,POLICE=6,FIRE=7,PARK=8;
    const grid=[], buildings=[], onFire=[], pollution=[];

    for(let y=0;y<GRID;y++){
      grid[y]=[];buildings[y]=[];onFire[y]=[];pollution[y]=[];
      for(let x=0;x<GRID;x++){grid[y][x]=EMPTY;buildings[y][x]=0;onFire[y][x]=0;pollution[y][x]=0;}
    }

    let money=5000,population=0,year=1,gameSpeed=1,selectedTool='residential',tickCount=0,gameActive=true;
    let demandR=50,demandC=50,demandI=50,happiness=50,powerCoverage=0,crimeLvl=0,pollutionLvl=0;
    let lastIncome=0;

    const costs={residential:150,commercial:200,industrial:250,road:75,power:500,police:750,fire:750,park:300,bulldoze:25};
    const maintenance={[RES]:5,[COM]:8,[IND]:10,[POWER]:50,[POLICE]:100,[FIRE]:100,[PARK]:20};

    document.querySelectorAll('.tool-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        selectedTool=btn.dataset.tool;
      });
    });

    document.querySelectorAll('.speed-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('.speed-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        gameSpeed=parseInt(btn.dataset.speed);
      });
    });

    let isDrawing=false;
    canvas.addEventListener('mousedown',e=>{isDrawing=true;handleDraw(e);});
    canvas.addEventListener('mousemove',e=>{if(isDrawing)handleDraw(e);});
    canvas.addEventListener('mouseup',()=>isDrawing=false);
    canvas.addEventListener('mouseleave',()=>isDrawing=false);
    canvas.addEventListener('touchstart',e=>{e.preventDefault();isDrawing=true;handleDraw(e.touches[0]);});
    canvas.addEventListener('touchmove',e=>{e.preventDefault();if(isDrawing)handleDraw(e.touches[0]);});
    canvas.addEventListener('touchend',()=>isDrawing=false);

    function handleDraw(e){
      if(!gameActive)return;
      const rect=canvas.getBoundingClientRect();
      const x=Math.floor((e.clientX-rect.left)/(rect.width/GRID));
      const y=Math.floor((e.clientY-rect.top)/(rect.height/GRID));
      if(x<0||x>=GRID||y<0||y>=GRID)return;
      const cost=costs[selectedTool];
      if(money<cost)return;

      if(selectedTool==='bulldoze'){
        if(grid[y][x]!==EMPTY){grid[y][x]=EMPTY;buildings[y][x]=0;onFire[y][x]=0;money-=cost;}
      }else if(grid[y][x]===EMPTY){
        const typeMap={residential:RES,commercial:COM,industrial:IND,road:ROAD,power:POWER,police:POLICE,fire:FIRE,park:PARK};
        grid[y][x]=typeMap[selectedTool];
        buildings[y][x]=0;
        money-=cost;
      }
      updateUI();draw();
    }

    function draw(){
      ctx.fillStyle='#1a2634';
      ctx.fillRect(0,0,canvas.width,canvas.height);

      // Draw pollution overlay
      for(let y=0;y<GRID;y++){
        for(let x=0;x<GRID;x++){
          if(pollution[y][x]>0){
            ctx.fillStyle=`rgba(156,39,176,${pollution[y][x]*0.15})`;
            ctx.fillRect(x*CELL,y*CELL,CELL,CELL);
          }
        }
      }

      ctx.strokeStyle='#2a3f55';ctx.lineWidth=0.5;
      for(let i=0;i<=GRID;i++){ctx.beginPath();ctx.moveTo(i*CELL,0);ctx.lineTo(i*CELL,canvas.height);ctx.stroke();ctx.beginPath();ctx.moveTo(0,i*CELL);ctx.lineTo(canvas.width,i*CELL);ctx.stroke();}

      for(let y=0;y<GRID;y++){
        for(let x=0;x<GRID;x++){
          const t=grid[y][x],lv=buildings[y][x],px=x*CELL,py=y*CELL;

          if(t===ROAD){
            ctx.fillStyle='#3a4550';ctx.fillRect(px,py,CELL,CELL);
            // Check neighbors and draw connections
            const hasN=y>0&&grid[y-1][x]===ROAD;
            const hasS=y<GRID-1&&grid[y+1][x]===ROAD;
            const hasW=x>0&&grid[y][x-1]===ROAD;
            const hasE=x<GRID-1&&grid[y][x+1]===ROAD;
            ctx.fillStyle='#5a6570';
            const cx=px+CELL/2,cy=py+CELL/2,hw=3,hl=CELL/2;
            if(hasN)ctx.fillRect(cx-hw,py,hw*2,hl);
            if(hasS)ctx.fillRect(cx-hw,cy,hw*2,hl);
            if(hasW)ctx.fillRect(px,cy-hw,hl,hw*2);
            if(hasE)ctx.fillRect(cx,cy-hw,hl,hw*2);
            ctx.fillRect(cx-hw,cy-hw,hw*2,hw*2); // center
            // Yellow center line
            ctx.fillStyle='#ffd700';
            if(hasN||hasS)ctx.fillRect(cx-1,py+2,2,CELL-4);
            if(hasW||hasE)ctx.fillRect(px+2,cy-1,CELL-4,2);
            if(!hasN&&!hasS&&!hasW&&!hasE)ctx.fillRect(cx-1,cy-1,2,2);
          }
          else if(t===RES){ctx.fillStyle=lv>0?'#2d4a2d':'#1e331e';ctx.fillRect(px+1,py+1,CELL-2,CELL-2);if(lv>0)drawHouse(px,py,lv);}
          else if(t===COM){ctx.fillStyle=lv>0?'#2d3a4a':'#1e2833';ctx.fillRect(px+1,py+1,CELL-2,CELL-2);if(lv>0)drawShop(px,py,lv);}
          else if(t===IND){ctx.fillStyle=lv>0?'#4a3a2d':'#33281e';ctx.fillRect(px+1,py+1,CELL-2,CELL-2);if(lv>0)drawFactory(px,py,lv);}
          else if(t===POWER){ctx.fillStyle='#333';ctx.fillRect(px+1,py+1,CELL-2,CELL-2);ctx.fillStyle='#ffeb3b';ctx.fillRect(px+4,py+2,CELL-8,CELL-4);ctx.fillStyle='#ff5722';ctx.fillRect(px+CELL/2-1,py+CELL-4,2,4);}
          else if(t===POLICE){ctx.fillStyle='#3f51b5';ctx.fillRect(px+2,py+3,CELL-4,CELL-5);ctx.fillStyle='#fff';ctx.fillRect(px+CELL/2-2,py+4,4,3);}
          else if(t===FIRE){ctx.fillStyle='#c62828';ctx.fillRect(px+2,py+3,CELL-4,CELL-5);ctx.fillStyle='#fff';ctx.fillRect(px+3,py+CELL-4,CELL-6,2);}
          else if(t===PARK){ctx.fillStyle='#2e7d32';ctx.fillRect(px+1,py+1,CELL-2,CELL-2);ctx.fillStyle='#4caf50';ctx.beginPath();ctx.arc(px+CELL/2,py+CELL/2,4,0,Math.PI*2);ctx.fill();}

          if(onFire[y][x]>0){ctx.fillStyle=`rgba(255,${100+Math.random()*100},0,0.8)`;ctx.fillRect(px+2,py+2,CELL-4,CELL-4);}
        }
      }
    }

    function drawHouse(px,py,lv){
      const h=3+lv*2,w=6+lv;
      ctx.fillStyle=['#4caf50','#66bb6a','#81c784'][lv-1];
      ctx.fillRect(px+(CELL-w)/2,py+CELL-h-1,w,h);
      ctx.fillStyle='#ffeb3b';
      ctx.fillRect(px+CELL/2-1,py+CELL-h,2,2);
    }

    function drawShop(px,py,lv){
      const h=4+lv*2,w=8+lv;
      ctx.fillStyle=['#2196f3','#42a5f5','#64b5f6'][lv-1];
      ctx.fillRect(px+(CELL-w)/2,py+CELL-h-1,w,h);
      ctx.fillStyle='#fff';
      ctx.fillRect(px+(CELL-w)/2+1,py+CELL-3,w-2,2);
    }

    function drawFactory(px,py,lv){
      const h=5+lv,w=9+lv;
      ctx.fillStyle=['#ff9800','#ffa726','#ffb74d'][lv-1];
      ctx.fillRect(px+(CELL-w)/2,py+CELL-h-1,w,h);
      ctx.fillStyle='#555';
      ctx.fillRect(px+CELL-4,py+CELL-h-3,2,3);
    }

    function isNear(x,y,type,range=2){
      for(let dy=-range;dy<=range;dy++){
        for(let dx=-range;dx<=range;dx++){
          const nx=x+dx,ny=y+dy;
          if(nx>=0&&nx<GRID&&ny>=0&&ny<GRID&&grid[ny][nx]===type)return true;
        }
      }
      return false;
    }

    function countNear(x,y,type,range=3){
      let c=0;
      for(let dy=-range;dy<=range;dy++){
        for(let dx=-range;dx<=range;dx++){
          const nx=x+dx,ny=y+dy;
          if(nx>=0&&nx<GRID&&ny>=0&&ny<GRID&&grid[ny][nx]===type)c++;
        }
      }
      return c;
    }

    function spreadPollution(){
      const newPoll=[];
      for(let y=0;y<GRID;y++){newPoll[y]=[];for(let x=0;x<GRID;x++)newPoll[y][x]=0;}
      for(let y=0;y<GRID;y++){
        for(let x=0;x<GRID;x++){
          if(grid[y][x]===IND&&buildings[y][x]>0){
            for(let dy=-2;dy<=2;dy++){
              for(let dx=-2;dx<=2;dx++){
                const nx=x+dx,ny=y+dy;
                if(nx>=0&&nx<GRID&&ny>=0&&ny<GRID){
                  newPoll[ny][nx]+=0.3/(1+Math.abs(dx)+Math.abs(dy));
                }
              }
            }
          }
          if(grid[y][x]===PARK){newPoll[y][x]-=0.5;}
        }
      }
      for(let y=0;y<GRID;y++)for(let x=0;x<GRID;x++)pollution[y][x]=Math.max(0,Math.min(1,(pollution[y][x]+newPoll[y][x])*0.95));
    }

    function startFire(){
      const candidates=[];
      for(let y=0;y<GRID;y++){
        for(let x=0;x<GRID;x++){
          if(buildings[y][x]>0&&onFire[y][x]===0&&!isNear(x,y,FIRE,4))candidates.push([x,y]);
        }
      }
      if(candidates.length>0){
        const [fx,fy]=candidates[Math.floor(Math.random()*candidates.length)];
        onFire[fy][fx]=3;
        showAlert('üî• FIRE!');
      }
    }

    function spreadFire(){
      const newFires=[];
      for(let y=0;y<GRID;y++){
        for(let x=0;x<GRID;x++){
          if(onFire[y][x]>0){
            onFire[y][x]--;
            if(onFire[y][x]===0&&buildings[y][x]>0){
              buildings[y][x]=Math.max(0,buildings[y][x]-1);
              if(buildings[y][x]===0)grid[y][x]=EMPTY;
            }
            if(!isNear(x,y,FIRE,3)&&Math.random()<0.3){
              const dirs=[[0,-1],[0,1],[-1,0],[1,0]];
              for(const[dx,dy]of dirs){
                const nx=x+dx,ny=y+dy;
                if(nx>=0&&nx<GRID&&ny>=0&&ny<GRID&&buildings[ny][nx]>0&&onFire[ny][nx]===0)newFires.push([nx,ny]);
              }
            }
          }
        }
      }
      for(const[fx,fy]of newFires)if(Math.random()<0.4)onFire[fy][fx]=3;
    }

    function showAlert(msg){
      alertEl.textContent=msg;
      alertEl.classList.add('show');
      setTimeout(()=>alertEl.classList.remove('show'),2000);
    }

    function gameTick(){
      if(gameSpeed===0||!gameActive)return;
      tickCount++;

      let resB=0,comB=0,indB=0,svc=0,powerPlants=0,policeCount=0,fireCount=0,parkCount=0;
      for(let y=0;y<GRID;y++){
        for(let x=0;x<GRID;x++){
          const t=grid[y][x],lv=buildings[y][x];
          if(t===RES&&lv>0)resB+=lv;
          else if(t===COM&&lv>0)comB+=lv;
          else if(t===IND&&lv>0)indB+=lv;
          else if(t===POWER){powerPlants++;svc++;}
          else if(t===POLICE){policeCount++;svc++;}
          else if(t===FIRE){fireCount++;svc++;}
          else if(t===PARK){parkCount++;svc++;}
        }
      }

      const totalBuildings=resB+comB+indB;
      powerCoverage=totalBuildings>0?Math.min(100,Math.floor(powerPlants*15/totalBuildings*100)):100;
      crimeLvl=policeCount>0?Math.max(0,100-policeCount*20-parkCount*5):Math.min(100,totalBuildings*3);

      spreadPollution();
      let totalPoll=0,pollCount=0;
      for(let y=0;y<GRID;y++)for(let x=0;x<GRID;x++)if(grid[y][x]===RES){totalPoll+=pollution[y][x];pollCount++;}
      pollutionLvl=pollCount>0?Math.floor(totalPoll/pollCount*100):0;

      // Happiness calculation
      const powerPenalty=powerCoverage<50?(50-powerCoverage)*0.5:0;
      const crimePenalty=crimeLvl*0.3;
      const pollPenalty=pollutionLvl*0.2;
      const parkBonus=parkCount*5;
      happiness=Math.max(0,Math.min(100,50-powerPenalty-crimePenalty-pollPenalty+parkBonus+Math.min(20,comB)));

      // Demand affected by happiness
      const happinessMod=happiness/50;
      demandR=Math.max(0,Math.min(100,50+(comB+indB-resB*0.7)*2*happinessMod));
      demandC=Math.max(0,Math.min(100,50+(resB*0.4-comB)*2*happinessMod));
      demandI=Math.max(0,Math.min(100,50+(resB*0.2+comB*0.2-indB)*2));

      // Development - much harder
      if(tickCount%(12/gameSpeed)===0){
        for(let y=0;y<GRID;y++){
          for(let x=0;x<GRID;x++){
            const t=grid[y][x],lv=buildings[y][x];
            if(t<RES||t>IND)continue;
            if(!isNear(x,y,ROAD,1))continue;
            if(lv>=3)continue;
            if(powerCoverage<30)continue;

            let demand=0,canGrow=false;
            if(t===RES&&demandR>50&&pollution[y][x]<0.4&&crimeLvl<60){demand=demandR;canGrow=true;}
            else if(t===COM&&demandC>50&&isNear(x,y,RES,3)){demand=demandC;canGrow=true;}
            else if(t===IND&&demandI>50){demand=demandI;canGrow=true;}

            if(canGrow&&Math.random()<(demand-40)/300*happinessMod){
              buildings[y][x]++;
            }

            // Decay from low happiness
            if(lv>0&&happiness<30&&Math.random()<0.02){
              buildings[y][x]--;
              if(buildings[y][x]===0)grid[y][x]=EMPTY;
            }
          }
        }
      }

      // Random fire
      if(tickCount%(60/gameSpeed)===0&&Math.random()<0.15&&totalBuildings>5){
        startFire();
      }
      spreadFire();

      // Economy
      population=resB*80;
      const taxRate=0.1;
      const income=Math.floor((comB*40+indB*25)*taxRate*happinessMod);
      let maint=0;
      for(let y=0;y<GRID;y++)for(let x=0;x<GRID;x++)if(maintenance[grid[y][x]])maint+=maintenance[grid[y][x]];

      if(tickCount%(40/gameSpeed)===0){
        lastIncome=income-maint;
        money+=lastIncome;
        year++;

        if(money<-1000){
          gameActive=false;
          document.getElementById('finalStats').textContent=`Population: ${population} | Year: ${year}`;
          gameOverEl.classList.add('show');
        }
      }

      updateUI();draw();
    }

    function updateUI(){
      document.getElementById('population').textContent=population.toLocaleString();
      document.getElementById('money').textContent='$'+money.toLocaleString();
      document.getElementById('money').className='stat-value'+(money<0?' negative':money<500?' warning':'');
      document.getElementById('income').textContent=(lastIncome>=0?'+':'')+lastIncome;
      document.getElementById('income').className='stat-value'+(lastIncome<0?' negative':'');
      document.getElementById('date').textContent='Year '+year;
      document.getElementById('happiness').textContent=Math.floor(happiness)+'%';
      document.getElementById('happiness').className='stat-value'+(happiness<30?' negative':happiness<50?' warning':'');

      document.getElementById('demandR').style.width=demandR+'%';
      document.getElementById('demandC').style.width=demandC+'%';
      document.getElementById('demandI').style.width=demandI+'%';

      document.getElementById('powerBar').style.width=powerCoverage+'%';
      document.getElementById('powerPct').textContent=powerCoverage+'%';
      document.getElementById('crimeBar').style.width=crimeLvl+'%';
      document.getElementById('crimePct').textContent=Math.floor(crimeLvl)+'%';
      document.getElementById('pollBar').style.width=pollutionLvl+'%';
      document.getElementById('pollPct').textContent=pollutionLvl+'%';

      let res=0,com=0,ind=0,svc=0;
      for(let y=0;y<GRID;y++){
        for(let x=0;x<GRID;x++){
          if(grid[y][x]===RES&&buildings[y][x]>0)res++;
          if(grid[y][x]===COM&&buildings[y][x]>0)com++;
          if(grid[y][x]===IND&&buildings[y][x]>0)ind++;
          if(grid[y][x]>=POWER)svc++;
        }
      }
      document.getElementById('resCount').textContent=res;
      document.getElementById('comCount').textContent=com;
      document.getElementById('indCount').textContent=ind;
      document.getElementById('svcCount').textContent=svc;
    }

    function saveGame(){
      const saveData={
        grid:grid,buildings:buildings,onFire:onFire,pollution:pollution,
        money:money,population:population,year:year,tickCount:tickCount,
        demandR:demandR,demandC:demandC,demandI:demandI,
        happiness:happiness,powerCoverage:powerCoverage,crimeLvl:crimeLvl,pollutionLvl:pollutionLvl,
        lastIncome:lastIncome,gameActive:gameActive
      };
      try{
        localStorage.setItem('microCitySave',JSON.stringify(saveData));
        showAlert('üíæ Game Saved!');
      }catch(e){
        showAlert('‚ùå Save Failed!');
      }
    }

    function loadGame(){
      try{
        const data=localStorage.getItem('microCitySave');
        if(!data){showAlert('üìÇ No Save Found');return;}
        const save=JSON.parse(data);
        for(let y=0;y<GRID;y++){
          for(let x=0;x<GRID;x++){
            grid[y][x]=save.grid[y][x];
            buildings[y][x]=save.buildings[y][x];
            onFire[y][x]=save.onFire[y][x];
            pollution[y][x]=save.pollution[y][x];
          }
        }
        money=save.money;population=save.population;year=save.year;tickCount=save.tickCount;
        demandR=save.demandR;demandC=save.demandC;demandI=save.demandI;
        happiness=save.happiness;powerCoverage=save.powerCoverage;crimeLvl=save.crimeLvl;pollutionLvl=save.pollutionLvl;
        lastIncome=save.lastIncome;gameActive=save.gameActive;
        gameOverEl.classList.remove('show');
        updateUI();draw();
        showAlert('üìÇ Game Loaded!');
      }catch(e){
        showAlert('‚ùå Load Failed!');
      }
    }

    // Auto-load on start if save exists
    if(localStorage.getItem('microCitySave')){
      loadGame();
    }

    // Autosave every 30 seconds
    setInterval(()=>{
      if(gameActive){
        const saveData={
          grid:grid,buildings:buildings,onFire:onFire,pollution:pollution,
          money:money,population:population,year:year,tickCount:tickCount,
          demandR:demandR,demandC:demandC,demandI:demandI,
          happiness:happiness,powerCoverage:powerCoverage,crimeLvl:crimeLvl,pollutionLvl:pollutionLvl,
          lastIncome:lastIncome,gameActive:gameActive
        };
        try{localStorage.setItem('microCitySave',JSON.stringify(saveData));}catch(e){}
      }
    },30000);

    // Save on window close
    window.addEventListener('beforeunload',()=>{
      if(gameActive){
        const saveData={
          grid:grid,buildings:buildings,onFire:onFire,pollution:pollution,
          money:money,population:population,year:year,tickCount:tickCount,
          demandR:demandR,demandC:demandC,demandI:demandI,
          happiness:happiness,powerCoverage:powerCoverage,crimeLvl:crimeLvl,pollutionLvl:pollutionLvl,
          lastIncome:lastIncome,gameActive:gameActive
        };
        try{localStorage.setItem('microCitySave',JSON.stringify(saveData));}catch(e){}
      }
    });

    setInterval(gameTick,400);
    draw();updateUI();
  </script>
</body>
</html>
