<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sloppygram - Cyber Chat 1999</title>
    <link rel="icon" href="https://emojicdn.elk.sh/ðŸ’¾">

    <meta property="og:title" content="Sloppygram">
    <meta property="og:description" content="Retro cyber chatroom from 1999. Global chat, AI roasts, and pure vibes.">
    <meta property="og:url" content="https://sloppy.live/sloppygram">
    <meta property="og:image" content="https://image.pollinations.ai/prompt/1990s%20retro%20cyber%20chatroom%20neon%20green%20dark%20hacker%20aesthetic%20terminal?width=1200&height=630&nologo=true">
    <meta property="og:type" content="website">

    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --neon-green: #00ff41;
            --neon-cyan: #00ffff;
            --neon-magenta: #ff00ff;
            --neon-yellow: #ffff00;
            --dark-bg: #0a0a0f;
            --panel-bg: #12121a;
            --border-color: #00ff4140;
            --text-dim: #00ff4180;
        }

        body {
            font-family: 'VT323', monospace;
            background: var(--dark-bg);
            min-height: 100vh;
            color: var(--neon-green);
            overflow: hidden;
        }

        /* Scanline effect */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.15),
                rgba(0, 0, 0, 0.15) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 9999;
        }

        .app {
            display: grid;
            grid-template-columns: 200px 1fr 180px;
            grid-template-rows: auto 1fr auto;
            height: 100vh;
            gap: 2px;
            background: var(--neon-green);
        }

        @media (max-width: 768px) {
            .app {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr auto;
            }
            .sidebar-left, .sidebar-right {
                display: none;
            }
            .sidebar-left.mobile-show, .sidebar-right.mobile-show {
                display: block;
                position: fixed;
                top: 60px;
                bottom: 60px;
                width: 80%;
                max-width: 300px;
                z-index: 100;
            }
            .sidebar-left.mobile-show { left: 0; }
            .sidebar-right.mobile-show { right: 0; }
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            background: var(--panel-bg);
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid var(--neon-green);
        }

        .logo {
            font-size: 1.8rem;
            color: var(--neon-cyan);
            text-shadow: 0 0 5px var(--neon-cyan);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-blink {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .marquee-container {
            flex: 1;
            overflow: hidden;
            margin: 0 20px;
            color: var(--neon-yellow);
            font-size: 1.1rem;
        }

        .marquee {
            display: inline-block;
            white-space: nowrap;
            animation: marquee 20s linear infinite;
        }

        @keyframes marquee {
            from { transform: translateX(100%); }
            to { transform: translateX(-100%); }
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .cyber-btn {
            background: transparent;
            border: 1px solid var(--neon-green);
            color: var(--neon-green);
            padding: 6px 12px;
            font-family: inherit;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cyber-btn:hover {
            background: var(--neon-green);
            color: var(--dark-bg);
        }

        /* Sidebars */
        .sidebar-left, .sidebar-right {
            background: var(--panel-bg);
            padding: 12px;
            overflow-y: auto;
        }

        .panel-title {
            color: var(--neon-magenta);
            font-size: 1.2rem;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px dashed var(--neon-magenta);
        }

        /* Online Users */
        .user-list {
            list-style: none;
        }

        .user-item {
            padding: 6px 8px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            border-left: 2px solid transparent;
            transition: all 0.2s;
        }

        .user-item:hover {
            background: rgba(0, 255, 65, 0.1);
            border-left-color: var(--neon-green);
        }

        .user-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--neon-green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .user-avatar {
            font-size: 1.2rem;
        }

        .user-name {
            color: var(--neon-cyan);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Public Feed */
        .feed-item {
            padding: 8px;
            margin-bottom: 8px;
            background: rgba(0, 255, 255, 0.05);
            border-left: 2px solid var(--neon-cyan);
            font-size: 0.95rem;
        }

        .feed-user {
            color: var(--neon-magenta);
        }

        .feed-action {
            color: var(--text-dim);
        }

        .feed-time {
            color: #666;
            font-size: 0.85rem;
        }

        /* Messages Container */
        .main-content {
            background: var(--panel-bg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .messages-container::-webkit-scrollbar {
            width: 8px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: var(--dark-bg);
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: var(--neon-green);
        }

        .message {
            display: flex;
            gap: 10px;
            animation: glitchIn 0.3s ease-out;
        }

        @keyframes glitchIn {
            0% { opacity: 0; transform: translateX(-10px); }
            50% { opacity: 1; transform: translateX(3px); }
            100% { transform: translateX(0); }
        }

        .message.own {
            flex-direction: row-reverse;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border: 2px solid var(--neon-cyan);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
            background: var(--dark-bg);
        }

        .message-bubble {
            max-width: 70%;
            background: rgba(0, 255, 65, 0.1);
            border: 1px solid var(--border-color);
            padding: 10px 14px;
            color: var(--neon-green);
        }

        .message.own .message-bubble {
            background: rgba(255, 0, 255, 0.15);
            border-color: var(--neon-magenta);
            color: var(--neon-magenta);
        }

        .message.roast .message-bubble {
            background: rgba(255, 0, 0, 0.15);
            border-color: #ff4444;
            color: #ff6666;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .message-username {
            color: var(--neon-cyan);
            font-size: 1rem;
        }

        .message.own .message-username {
            color: var(--neon-magenta);
        }

        .message-time {
            font-size: 0.85rem;
            color: #555;
        }

        .message-content {
            font-size: 1.1rem;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message-image, .message-drawing {
            max-width: 100%;
            margin-top: 8px;
            cursor: pointer;
            border: 1px solid var(--border-color);
        }

        /* Input Area */
        .input-area {
            background: var(--dark-bg);
            padding: 12px 16px;
            border-top: 2px solid var(--neon-green);
            grid-column: 1 / -1;
        }

        .input-row {
            display: flex;
            gap: 8px;
            align-items: flex-end;
            max-width: 800px;
            margin: 0 auto;
        }

        .input-actions {
            display: flex;
            gap: 4px;
        }

        .action-btn {
            width: 40px;
            height: 40px;
            border: 1px solid var(--neon-green);
            background: transparent;
            color: var(--neon-green);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: var(--neon-green);
            color: var(--dark-bg);
        }

        .message-input {
            flex: 1;
            background: var(--panel-bg);
            border: 1px solid var(--neon-green);
            padding: 10px 16px;
            color: var(--neon-green);
            font-family: inherit;
            font-size: 1.1rem;
            resize: none;
            max-height: 100px;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--neon-cyan);
        }

        .message-input::placeholder {
            color: var(--text-dim);
        }

        .send-btn {
            width: 60px;
            height: 40px;
            border: 1px solid var(--neon-cyan);
            background: transparent;
            color: var(--neon-cyan);
            font-family: inherit;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .send-btn:hover {
            background: var(--neon-cyan);
            color: var(--dark-bg);
        }

        /* Roast button */
        .roast-btn {
            border-color: #ff4444 !important;
            color: #ff4444 !important;
        }

        .roast-btn:hover {
            background: #ff4444 !important;
            color: var(--dark-bg) !important;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--panel-bg);
            border: 2px solid var(--neon-green);
            padding: 24px;
            width: 90%;
            max-width: 400px;
            color: var(--neon-green);
        }

        .modal h2 {
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--neon-cyan);
            font-size: 1.5rem;
        }

        .modal-close {
            margin-left: auto;
            background: none;
            border: none;
            color: var(--neon-magenta);
            font-size: 24px;
            cursor: pointer;
        }

        /* Avatar Picker */
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .avatar-option {
            aspect-ratio: 1;
            border: 2px solid #333;
            background: var(--dark-bg);
            font-size: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .avatar-option:hover {
            border-color: var(--neon-green);
        }

        .avatar-option.selected {
            border-color: var(--neon-cyan);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 1rem;
            color: var(--neon-magenta);
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            background: var(--dark-bg);
            border: 1px solid var(--neon-green);
            color: var(--neon-green);
            font-family: inherit;
            font-size: 1.1rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--neon-cyan);
        }

        .color-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .color-option {
            width: 32px;
            height: 32px;
            border: 2px solid transparent;
            cursor: pointer;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: white;
        }

        .modal-btn {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 2px solid var(--neon-cyan);
            color: var(--neon-cyan);
            font-family: inherit;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 16px;
            transition: all 0.2s;
        }

        .modal-btn:hover {
            background: var(--neon-cyan);
            color: var(--dark-bg);
        }

        /* Drawing Canvas */
        .drawing-modal .modal {
            max-width: 500px;
        }

        .canvas-container {
            background: #111;
            border: 1px solid var(--neon-green);
            margin-bottom: 16px;
        }

        #drawingCanvas {
            display: block;
            width: 100%;
            cursor: crosshair;
            touch-action: none;
        }

        .canvas-tools {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .tool-btn {
            padding: 8px 12px;
            background: transparent;
            border: 1px solid var(--neon-green);
            color: var(--neon-green);
            cursor: pointer;
            font-family: inherit;
        }

        .tool-btn:hover, .tool-btn.active {
            background: var(--neon-green);
            color: var(--dark-bg);
        }

        .brush-colors {
            display: flex;
            gap: 6px;
        }

        .brush-color {
            width: 28px;
            height: 28px;
            border: 2px solid #333;
            cursor: pointer;
        }

        .brush-color.selected {
            border-color: white;
        }

        /* Image preview */
        .image-preview {
            margin-bottom: 8px;
            position: relative;
            display: none;
        }

        .image-preview img {
            max-width: 200px;
            max-height: 150px;
            border: 1px solid var(--neon-green);
        }

        .image-preview .remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background: #ff4444;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }

        .backlink {
            text-align: center;
            padding: 4px;
            font-size: 0.9rem;
            color: #444;
            background: var(--dark-bg);
        }

        .backlink a {
            color: var(--neon-green);
            text-decoration: none;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-dim);
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        #imageInput {
            display: none;
        }

        /* Mobile toggle buttons */
        .mobile-toggle {
            display: none;
        }

        @media (max-width: 768px) {
            .mobile-toggle {
                display: inline-block;
            }
        }

        /* Roast loading animation */
        .roast-loading {
            color: #ff4444;
            animation: roastPulse 0.5s infinite;
        }

        @keyframes roastPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <div class="logo">
                <span>ðŸ’¾</span>
                <span>SLOPPYGRAM<span class="logo-blink">_</span></span>
            </div>
            <div class="marquee-container">
                <div class="marquee">
                    â˜… WELCOME TO THE CYBER ZONE â˜… TYPE /roast TO GET ROASTED BY AI â˜… EST. 1999 â˜… VISITORS: <span id="visitorCount">???</span> â˜…
                </div>
            </div>
            <div class="header-actions">
                <button class="cyber-btn mobile-toggle" onclick="toggleSidebar('left')">USERS</button>
                <button class="cyber-btn mobile-toggle" onclick="toggleSidebar('right')">FEED</button>
                <button class="cyber-btn" onclick="openProfileModal()">PROFILE</button>
            </div>
        </div>

        <div class="sidebar-left" id="sidebarLeft">
            <div class="panel-title">[ ONLINE USERS ]</div>
            <ul class="user-list" id="userList">
                <li class="user-item">
                    <span class="user-status"></span>
                    <span class="user-avatar">ðŸ¤–</span>
                    <span class="user-name">RoastBot3000</span>
                </li>
            </ul>
        </div>

        <div class="main-content">
            <div class="messages-container" id="messagesContainer">
                <div class="empty-state" id="emptyState">
                    <div class="icon">ðŸ’¾</div>
                    <p>INITIALIZING CHAT PROTOCOL...</p>
                    <p>TYPE /roast TO GET ROASTED</p>
                </div>
            </div>
        </div>

        <div class="sidebar-right" id="sidebarRight">
            <div class="panel-title">[ PUBLIC FEED ]</div>
            <div id="publicFeed">
                <div class="feed-item">
                    <span class="feed-user">System</span>
                    <span class="feed-action">initialized</span>
                    <div class="feed-time">just now</div>
                </div>
            </div>
        </div>

        <div class="input-area">
            <div class="image-preview" id="imagePreview">
                <img id="previewImg" src="">
                <button class="remove-btn" onclick="removeImage()">Ã—</button>
            </div>
            <div class="input-row">
                <div class="input-actions">
                    <button class="action-btn" onclick="document.getElementById('imageInput').click()">ðŸ“·</button>
                    <button class="action-btn" onclick="openDrawingModal()">ðŸŽ¨</button>
                    <button class="action-btn roast-btn" onclick="requestRoast()">ðŸ”¥</button>
                </div>
                <input type="file" id="imageInput" accept="image/*" onchange="handleImageSelect(event)">
                <textarea class="message-input" id="messageInput" placeholder="Type message or /roast..." rows="1"></textarea>
                <button class="send-btn" onclick="sendMessage()">SEND</button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal">
            <h2>
                <span>ðŸ‘¤</span> PROFILE CONFIG
                <button class="modal-close" onclick="closeProfileModal()">Ã—</button>
            </h2>

            <div class="form-group">
                <label>USERNAME:</label>
                <input type="text" id="usernameInput" placeholder="Enter handle..." maxlength="20">
            </div>

            <div class="form-group">
                <label>SELECT AVATAR:</label>
                <div class="avatar-grid" id="avatarGrid"></div>
            </div>

            <div class="form-group">
                <label>AVATAR COLOR:</label>
                <div class="color-options" id="colorOptions"></div>
            </div>

            <button class="modal-btn" onclick="saveProfile()">[ SAVE ]</button>
        </div>
    </div>

    <!-- Drawing Modal -->
    <div class="modal-overlay drawing-modal" id="drawingModal">
        <div class="modal">
            <h2>
                <span>ðŸŽ¨</span> PIXEL CANVAS
                <button class="modal-close" onclick="closeDrawingModal()">Ã—</button>
            </h2>

            <div class="canvas-tools">
                <div class="brush-colors" id="brushColors"></div>
                <button class="tool-btn" onclick="clearCanvas()">CLEAR</button>
            </div>

            <div class="canvas-container">
                <canvas id="drawingCanvas" width="400" height="300"></canvas>
            </div>

            <button class="modal-btn" onclick="sendDrawing()">[ TRANSMIT ]</button>
        </div>
    </div>

    <div class="backlink">
        &lt;/&gt; Built at <a href="https://sloppy.live">sloppy.live</a> | Netscape Navigator Recommended
    </div>

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

        const SUPABASE_URL = 'https://yjyxteqzhhmtrgcaekgz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM8IS32IUYR2eenCCjdDdioiBU';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Avatar options
        const AVATARS = ['ðŸ˜€', 'ðŸ˜Ž', 'ðŸ¤–', 'ðŸ‘½', 'ðŸ±', 'ðŸ¶', 'ðŸ¦Š', 'ðŸ¼', 'ðŸ¸', 'ðŸ¦„', 'ðŸ²', 'ðŸ‘»', 'ðŸ’€', 'ðŸŽƒ', 'ðŸ¤¡', 'ðŸ‘¾', 'ðŸ¥·', 'ðŸ§™'];
        const COLORS = ['#00ff41', '#00ffff', '#ff00ff', '#ffff00', '#ff4444', '#ff8800', '#8844ff', '#44ff88', '#ff44aa', '#44aaff'];
        const BRUSH_COLORS = ['#00ff41', '#00ffff', '#ff00ff', '#ffff00', '#ff4444', '#ffffff', '#000000', '#888888'];

        let currentUser = null;
        let profile = {
            username: 'Anon' + Math.floor(Math.random() * 9999),
            avatar: AVATARS[Math.floor(Math.random() * AVATARS.length)],
            color: COLORS[Math.floor(Math.random() * COLORS.length)]
        };
        let selectedImage = null;
        let drawingCtx = null;
        let isDrawing = false;
        let brushColor = '#00ff41';
        const seenMessageIds = new Set();
        let onlineUsers = new Map();
        let realtimeChannel = null;

        // Load saved profile
        const savedProfile = localStorage.getItem('sloppygram_profile');
        if (savedProfile) {
            profile = JSON.parse(savedProfile);
        }

        // Initialize
        async function init() {
            // Auth
            let { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                const { data, error } = await supabase.auth.signInAnonymously();
                if (error) console.error('Auth error:', error);
                session = data?.session;
            }
            currentUser = session?.user;

            setupAvatarGrid();
            setupColorOptions();
            setupBrushColors();
            setupDrawingCanvas();
            loadMessages();
            subscribeToMessages();
            setupPresence();

            // Random visitor count for 90s vibes
            document.getElementById('visitorCount').textContent = Math.floor(10000 + Math.random() * 90000);

            // Auto-resize textarea
            const input = document.getElementById('messageInput');
            input.addEventListener('input', () => {
                input.style.height = 'auto';
                input.style.height = Math.min(input.scrollHeight, 100) + 'px';
            });

            // Enter to send
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        // Presence for online users
        function setupPresence() {
            const presenceChannel = supabase.channel('sloppygram_presence', {
                config: {
                    presence: { key: currentUser?.id || 'anon_' + Math.random() }
                }
            });

            presenceChannel
                .on('presence', { event: 'sync' }, () => {
                    const state = presenceChannel.presenceState();
                    updateOnlineUsers(state);
                })
                .on('presence', { event: 'join' }, ({ key, newPresences }) => {
                    addToFeed(newPresences[0]?.username || 'Someone', 'joined the chat');
                })
                .on('presence', { event: 'leave' }, ({ key, leftPresences }) => {
                    addToFeed(leftPresences[0]?.username || 'Someone', 'left the chat');
                })
                .subscribe(async (status) => {
                    if (status === 'SUBSCRIBED') {
                        await presenceChannel.track({
                            username: profile.username,
                            avatar: profile.avatar,
                            color: profile.color,
                            online_at: new Date().toISOString()
                        });
                    }
                });
        }

        function updateOnlineUsers(state) {
            const userList = document.getElementById('userList');
            const users = [];

            // Always show RoastBot
            users.push({ username: 'RoastBot3000', avatar: 'ðŸ¤–', color: '#ff4444', isBot: true });

            // Add real users
            Object.values(state).forEach(presences => {
                presences.forEach(p => {
                    if (!users.find(u => u.username === p.username)) {
                        users.push(p);
                    }
                });
            });

            userList.innerHTML = users.map(u => `
                <li class="user-item">
                    <span class="user-status" style="${u.isBot ? 'background: #ff4444;' : ''}"></span>
                    <span class="user-avatar">${u.avatar}</span>
                    <span class="user-name" style="color: ${u.color || '#00ffff'}">${escapeHtml(u.username)}</span>
                </li>
            `).join('');
        }

        function addToFeed(user, action) {
            const feed = document.getElementById('publicFeed');
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            const item = document.createElement('div');
            item.className = 'feed-item';
            item.innerHTML = `
                <span class="feed-user">${escapeHtml(user)}</span>
                <span class="feed-action">${action}</span>
                <div class="feed-time">${time}</div>
            `;

            feed.insertBefore(item, feed.firstChild);

            // Keep only last 20 items
            while (feed.children.length > 20) {
                feed.removeChild(feed.lastChild);
            }
        }

        // Setup avatar grid
        function setupAvatarGrid() {
            const grid = document.getElementById('avatarGrid');
            grid.innerHTML = AVATARS.map(a =>
                `<button class="avatar-option ${a === profile.avatar ? 'selected' : ''}" onclick="selectAvatar('${a}')">${a}</button>`
            ).join('');
        }

        window.selectAvatar = function(avatar) {
            profile.avatar = avatar;
            document.querySelectorAll('.avatar-option').forEach(el => {
                el.classList.toggle('selected', el.textContent === avatar);
            });
        };

        // Setup color options
        function setupColorOptions() {
            const container = document.getElementById('colorOptions');
            container.innerHTML = COLORS.map(c =>
                `<button class="color-option ${c === profile.color ? 'selected' : ''}" style="background: ${c}" onclick="selectColor('${c}')"></button>`
            ).join('');
        }

        window.selectColor = function(color) {
            profile.color = color;
            document.querySelectorAll('.color-option').forEach(el => {
                el.classList.toggle('selected', el.style.background === color);
            });
        };

        // Setup brush colors
        function setupBrushColors() {
            const container = document.getElementById('brushColors');
            container.innerHTML = BRUSH_COLORS.map(c =>
                `<button class="brush-color ${c === brushColor ? 'selected' : ''}" style="background: ${c}" onclick="selectBrushColor('${c}')"></button>`
            ).join('');
        }

        window.selectBrushColor = function(color) {
            brushColor = color;
            document.querySelectorAll('.brush-color').forEach(el => {
                el.classList.toggle('selected', el.style.background === color);
            });
        };

        // Drawing canvas
        function setupDrawingCanvas() {
            const canvas = document.getElementById('drawingCanvas');
            drawingCtx = canvas.getContext('2d');
            drawingCtx.fillStyle = '#111';
            drawingCtx.fillRect(0, 0, canvas.width, canvas.height);
            drawingCtx.lineCap = 'round';
            drawingCtx.lineJoin = 'round';
            drawingCtx.lineWidth = 4;

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const offsetX = touch.clientX - rect.left;
                const offsetY = touch.clientY - rect.top;
                startDrawing({ offsetX, offsetY });
            }, { passive: false });

            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const offsetX = touch.clientX - rect.left;
                const offsetY = touch.clientY - rect.top;
                draw({ offsetX, offsetY });
            }, { passive: false });

            canvas.addEventListener('touchend', stopDrawing);
        }

        function getCanvasCoords(e) {
            const canvas = document.getElementById('drawingCanvas');
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: e.offsetX * scaleX,
                y: e.offsetY * scaleY
            };
        }

        function startDrawing(e) {
            isDrawing = true;
            const coords = getCanvasCoords(e);
            drawingCtx.beginPath();
            drawingCtx.moveTo(coords.x, coords.y);
        }

        function draw(e) {
            if (!isDrawing) return;
            const coords = getCanvasCoords(e);
            drawingCtx.strokeStyle = brushColor;
            drawingCtx.lineTo(coords.x, coords.y);
            drawingCtx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        window.clearCanvas = function() {
            const canvas = document.getElementById('drawingCanvas');
            drawingCtx.fillStyle = '#111';
            drawingCtx.fillRect(0, 0, canvas.width, canvas.height);
        };

        // Load messages
        async function loadMessages() {
            const { data, error } = await supabase
                .from('sloppygram_messages')
                .select('*')
                .order('created_at', { ascending: true })
                .limit(100);

            if (error) {
                console.error('Load error:', error);
                return;
            }

            const container = document.getElementById('messagesContainer');
            const emptyState = document.getElementById('emptyState');

            if (data.length === 0) {
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            data.forEach(msg => {
                seenMessageIds.add(msg.id);
                addMessageToUI(msg);
            });
            container.scrollTop = container.scrollHeight;
        }

        // Subscribe to new messages
        function subscribeToMessages() {
            if (realtimeChannel) {
                supabase.removeChannel(realtimeChannel);
            }

            realtimeChannel = supabase.channel('sloppygram-global', {
                config: {
                    broadcast: { self: false }
                }
            });

            realtimeChannel.on('broadcast', { event: 'new_message' }, (payload) => {
                const msg = payload.payload;
                if (!msg || seenMessageIds.has(msg.id)) return;
                seenMessageIds.add(msg.id);
                addMessageToUI(msg);
                scrollToBottom();
                addToFeed(msg.username, 'sent a message');
            });

            realtimeChannel.on('postgres_changes', {
                event: 'INSERT',
                schema: 'public',
                table: 'sloppygram_messages'
            }, (payload) => {
                if (seenMessageIds.has(payload.new.id)) return;
                seenMessageIds.add(payload.new.id);
                addMessageToUI(payload.new);
                scrollToBottom();
            });

            realtimeChannel.subscribe();
        }

        function broadcastMessage(msg) {
            if (realtimeChannel) {
                realtimeChannel.send({
                    type: 'broadcast',
                    event: 'new_message',
                    payload: msg
                });
            }
        }

        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }

        // Add message to UI
        function addMessageToUI(msg) {
            const container = document.getElementById('messagesContainer');
            document.getElementById('emptyState').style.display = 'none';

            const isOwn = msg.user_id === currentUser?.id;
            const isRoast = msg.username === 'RoastBot3000';
            const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            const div = document.createElement('div');
            div.className = `message ${isOwn ? 'own' : ''} ${isRoast ? 'roast' : ''}`;

            let contentHTML = '';
            if (msg.content) {
                contentHTML = `<div class="message-content">${escapeHtml(msg.content)}</div>`;
            }
            if (msg.image_data) {
                contentHTML += `<img class="message-image" src="${msg.image_data}" onclick="window.open(this.src)">`;
            }
            if (msg.drawing_data) {
                contentHTML += `<img class="message-drawing" src="${msg.drawing_data}">`;
            }

            div.innerHTML = `
                <div class="avatar" style="border-color: ${isRoast ? '#ff4444' : (isOwn ? '#ff00ff' : '#00ffff')}">${msg.avatar || 'ðŸ‘¤'}</div>
                <div class="message-bubble">
                    <div class="message-header">
                        <span class="message-username" style="color: ${isRoast ? '#ff4444' : ''}">${escapeHtml(msg.username || 'Anonymous')}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    ${contentHTML}
                </div>
            `;

            container.appendChild(div);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // AI Roast function
        window.requestRoast = async function() {
            const input = document.getElementById('messageInput');
            input.value = '/roast';
            sendMessage();
        };

        async function generateRoast(targetUser) {
            const fallbacks = [
                `${targetUser}? More like ${targetUser.split('').reverse().join('')}. Yeah, I said it.`,
                `I've seen better usernames generated by a broken keyboard. Looking at you, ${targetUser}.`,
                `${targetUser} walked into a chatroom and the chatroom walked out.`,
                `Hey ${targetUser}, the 90s called - they don't want you back either.`,
                `${targetUser}'s code is so bad, even Internet Explorer refuses to run it.`,
                `${targetUser} types so slow, dial-up modems feel bad for them.`,
                `If ${targetUser} was a font, they'd be Comic Sans.`,
                `${targetUser}'s password is probably "password123". Bold move.`,
                `I'd roast ${targetUser} harder but my CPU can only handle so much cringe.`,
                `${targetUser} looks like they still use Internet Explorer. Unironically.`,
                `${targetUser}'s vibe is "Reply All to company-wide email".`,
                `Legend says ${targetUser} still waits for their Limewire downloads.`
            ];

            const prompt = `You are RoastBot3000, a witty AI from a 1990s chat room. Generate ONE funny, light-hearted roast for "${targetUser}". Keep it playful, not mean. Max 1-2 short sentences. No quotes around your response.`;

            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 8000);

                const response = await fetch('https://text.pollinations.ai/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [{ role: 'user', content: prompt }],
                        model: 'openai',
                        referrer: 'sloppy.live'
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeout);

                if (!response.ok) throw new Error('API error');

                const roast = await response.text();
                const cleaned = roast.trim().replace(/^["']|["']$/g, '').substring(0, 200);
                return cleaned || fallbacks[Math.floor(Math.random() * fallbacks.length)];
            } catch (e) {
                console.error('Roast error:', e);
                return fallbacks[Math.floor(Math.random() * fallbacks.length)];
            }
        }

        // Send message
        window.sendMessage = async function() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content && !selectedImage) return;

            // Check for roast command
            if (content.toLowerCase() === '/roast') {
                input.value = '';

                // Show loading message
                const loadingId = 'loading_' + Date.now();
                const loadingMsg = {
                    id: loadingId,
                    username: 'RoastBot3000',
                    avatar: 'ðŸ¤–',
                    content: 'GENERATING SICK BURN...',
                    created_at: new Date().toISOString()
                };
                seenMessageIds.add(loadingId);
                addMessageToUI(loadingMsg);
                scrollToBottom();

                // Make the loading message pulse
                const lastMsg = document.querySelector('.messages-container .message:last-child .message-content');
                if (lastMsg) lastMsg.classList.add('roast-loading');

                // Generate roast
                const roast = await generateRoast(profile.username);

                // Remove loading message
                const msgs = document.querySelectorAll('.messages-container .message');
                if (msgs.length > 0) msgs[msgs.length - 1].remove();

                // Send actual roast as bot message
                const tempId = 'roast_' + Date.now();
                const roastMsg = {
                    id: tempId,
                    username: 'RoastBot3000',
                    avatar: 'ðŸ¤–',
                    content: `ðŸ”¥ ${roast}`,
                    created_at: new Date().toISOString(),
                    user_id: 'bot'
                };

                seenMessageIds.add(tempId);
                addMessageToUI(roastMsg);
                scrollToBottom();
                broadcastMessage(roastMsg);
                addToFeed('RoastBot3000', `roasted ${profile.username}`);

                // Save roast to DB
                await supabase.from('sloppygram_messages').insert({
                    username: 'RoastBot3000',
                    avatar: 'ðŸ¤–',
                    content: roastMsg.content,
                    message_type: 'text',
                    user_id: currentUser?.id
                });

                return;
            }

            // Regular message
            const tempId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            const msg = {
                id: tempId,
                username: profile.username,
                avatar: profile.avatar,
                content: content || null,
                image_data: selectedImage || null,
                drawing_data: null,
                message_type: selectedImage ? 'image' : 'text',
                user_id: currentUser?.id,
                created_at: new Date().toISOString()
            };

            input.value = '';
            input.style.height = 'auto';
            removeImage();

            seenMessageIds.add(tempId);
            addMessageToUI(msg);
            scrollToBottom();
            broadcastMessage(msg);
            addToFeed(profile.username, msg.image_data ? 'shared an image' : 'sent a message');

            const { data, error } = await supabase
                .from('sloppygram_messages')
                .insert({
                    username: msg.username,
                    avatar: msg.avatar,
                    content: msg.content,
                    image_data: msg.image_data,
                    drawing_data: msg.drawing_data,
                    message_type: msg.message_type,
                    user_id: msg.user_id
                })
                .select('id')
                .single();

            if (error) {
                console.error('Send error:', error);
                return;
            }

            if (data?.id) {
                seenMessageIds.add(data.id);
            }
        };

        // Send drawing
        window.sendDrawing = async function() {
            const canvas = document.getElementById('drawingCanvas');
            const drawingData = canvas.toDataURL('image/png');

            const tempId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            const msg = {
                id: tempId,
                username: profile.username,
                avatar: profile.avatar,
                content: null,
                image_data: null,
                drawing_data: drawingData,
                message_type: 'drawing',
                user_id: currentUser?.id,
                created_at: new Date().toISOString()
            };

            closeDrawingModal();
            clearCanvas();

            seenMessageIds.add(tempId);
            addMessageToUI(msg);
            scrollToBottom();
            broadcastMessage(msg);
            addToFeed(profile.username, 'shared a drawing');

            const { data, error } = await supabase
                .from('sloppygram_messages')
                .insert({
                    username: msg.username,
                    avatar: msg.avatar,
                    content: msg.content,
                    image_data: msg.image_data,
                    drawing_data: msg.drawing_data,
                    message_type: msg.message_type,
                    user_id: msg.user_id
                })
                .select('id')
                .single();

            if (error) {
                console.error('Send error:', error);
            }

            if (data?.id) {
                seenMessageIds.add(data.id);
            }
        };

        // Image handling
        window.handleImageSelect = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 500000) {
                alert('FILE TOO LARGE. MAX 500KB.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                selectedImage = e.target.result;
                document.getElementById('previewImg').src = selectedImage;
                document.getElementById('imagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        };

        window.removeImage = function() {
            selectedImage = null;
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('imageInput').value = '';
        };

        // Profile modal
        window.openProfileModal = function() {
            document.getElementById('usernameInput').value = profile.username;
            setupAvatarGrid();
            setupColorOptions();
            document.getElementById('profileModal').classList.add('active');
        };

        window.closeProfileModal = function() {
            document.getElementById('profileModal').classList.remove('active');
        };

        window.saveProfile = function() {
            const username = document.getElementById('usernameInput').value.trim() || 'Anon' + Math.floor(Math.random() * 9999);
            profile.username = username;
            localStorage.setItem('sloppygram_profile', JSON.stringify(profile));
            closeProfileModal();
        };

        // Drawing modal
        window.openDrawingModal = function() {
            clearCanvas();
            document.getElementById('drawingModal').classList.add('active');
        };

        window.closeDrawingModal = function() {
            document.getElementById('drawingModal').classList.remove('active');
        };

        // Mobile sidebar toggle
        window.toggleSidebar = function(side) {
            const sidebar = side === 'left' ? document.getElementById('sidebarLeft') : document.getElementById('sidebarRight');
            sidebar.classList.toggle('mobile-show');
        };

        // Initialize
        init();
    </script>
</body>
</html>
