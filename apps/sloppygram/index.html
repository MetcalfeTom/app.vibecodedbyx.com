<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sloppygram - Global Chat</title>
    <link rel="icon" href="https://emojicdn.elk.sh/ðŸ’¬">

    <meta property="og:title" content="Sloppygram">
    <meta property="og:description" content="Global chatroom with image uploads, avatars, and a drawing tool. Join the sloppy conversation!">
    <meta property="og:url" content="https://sloppy.live/sloppygram">
    <meta property="og:image" content="https://image.pollinations.ai/prompt/social%20media%20chat%20app%20colorful%20messages%20avatars%20modern%20ui?width=1200&height=630&nologo=true">
    <meta property="og:type" content="website">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 800px;
            margin: 0 auto;
            background: #1a1a2e;
        }

        /* Header */
        .header {
            background: linear-gradient(90deg, #e91e63, #9c27b0);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .logo {
            font-size: 1.4rem;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .online-count {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.8);
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .icon-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Messages */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            display: flex;
            gap: 10px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.own {
            flex-direction: row-reverse;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .message-bubble {
            max-width: 70%;
            background: #2d2d44;
            border-radius: 16px;
            padding: 10px 14px;
            color: #fff;
        }

        .message.own .message-bubble {
            background: linear-gradient(135deg, #e91e63, #9c27b0);
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .message-username {
            font-weight: 600;
            font-size: 0.85rem;
        }

        .message-time {
            font-size: 0.7rem;
            color: rgba(255,255,255,0.5);
        }

        .message-content {
            font-size: 0.95rem;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message-image {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 8px;
            cursor: pointer;
        }

        .message-drawing {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 8px;
            background: white;
        }

        /* Input Area */
        .input-area {
            background: #16162a;
            padding: 12px 16px;
            border-top: 1px solid #2d2d44;
        }

        .input-row {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        .input-actions {
            display: flex;
            gap: 4px;
        }

        .action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: #2d2d44;
            color: #aaa;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: #3d3d54;
            color: #fff;
        }

        .action-btn.active {
            background: #e91e63;
            color: white;
        }

        .message-input {
            flex: 1;
            background: #2d2d44;
            border: none;
            border-radius: 20px;
            padding: 10px 16px;
            color: white;
            font-family: inherit;
            font-size: 0.95rem;
            resize: none;
            max-height: 100px;
        }

        .message-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px #e91e63;
        }

        .send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #e91e63, #9c27b0);
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .send-btn:hover {
            transform: scale(1.1);
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #1a1a2e;
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            color: white;
        }

        .modal h2 {
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            margin-left: auto;
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
        }

        /* Avatar Picker */
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .avatar-option {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 50%;
            border: 3px solid transparent;
            background: #2d2d44;
            font-size: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .avatar-option:hover {
            border-color: #666;
        }

        .avatar-option.selected {
            border-color: #e91e63;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.9rem;
            color: #aaa;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            background: #2d2d44;
            border: 1px solid #3d3d54;
            border-radius: 8px;
            color: white;
            font-family: inherit;
        }

        .form-group input:focus {
            outline: none;
            border-color: #e91e63;
        }

        .color-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .color-option {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: white;
        }

        .modal-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #e91e63, #9c27b0);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            margin-top: 16px;
        }

        .modal-btn:hover {
            opacity: 0.9;
        }

        /* Drawing Canvas */
        .drawing-modal .modal {
            max-width: 500px;
        }

        .canvas-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        #drawingCanvas {
            display: block;
            width: 100%;
            cursor: crosshair;
            touch-action: none;
        }

        .canvas-tools {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .tool-btn {
            padding: 8px 12px;
            background: #2d2d44;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }

        .tool-btn.active {
            background: #e91e63;
        }

        .brush-colors {
            display: flex;
            gap: 6px;
        }

        .brush-color {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
        }

        .brush-color.selected {
            border-color: white;
        }

        /* Image preview */
        .image-preview {
            margin-top: 8px;
            position: relative;
            display: none;
        }

        .image-preview img {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
        }

        .image-preview .remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #e91e63;
            border: none;
            color: white;
            cursor: pointer;
        }

        .backlink {
            text-align: center;
            padding: 8px;
            font-size: 11px;
            color: #666;
            background: #16162a;
        }

        .backlink a {
            color: #e91e63;
            text-decoration: none;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* Hide file input */
        #imageInput {
            display: none;
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <div class="logo">
                <span>ðŸ’¬</span>
                <span>Sloppygram</span>
            </div>
            <div class="online-count" id="onlineCount">Global Chat</div>
            <div class="header-actions">
                <button class="icon-btn" onclick="openProfileModal()">ðŸ‘¤</button>
            </div>
        </div>

        <div class="messages-container" id="messagesContainer">
            <div class="empty-state" id="emptyState">
                <div class="icon">ðŸ’¬</div>
                <p>No messages yet. Be the first to say hi!</p>
            </div>
        </div>

        <div class="input-area">
            <div class="image-preview" id="imagePreview">
                <img id="previewImg" src="">
                <button class="remove-btn" onclick="removeImage()">Ã—</button>
            </div>
            <div class="input-row">
                <div class="input-actions">
                    <button class="action-btn" onclick="document.getElementById('imageInput').click()">ðŸ“·</button>
                    <button class="action-btn" onclick="openDrawingModal()">ðŸŽ¨</button>
                </div>
                <input type="file" id="imageInput" accept="image/*" onchange="handleImageSelect(event)">
                <textarea class="message-input" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
                <button class="send-btn" onclick="sendMessage()">âž¤</button>
            </div>
        </div>

        <div class="backlink">
            Built at <a href="https://sloppy.live">sloppy.live</a>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal">
            <h2>
                <span>ðŸ‘¤</span> Your Profile
                <button class="modal-close" onclick="closeProfileModal()">Ã—</button>
            </h2>

            <div class="form-group">
                <label>Username</label>
                <input type="text" id="usernameInput" placeholder="Enter username" maxlength="20">
            </div>

            <div class="form-group">
                <label>Pick an Avatar</label>
                <div class="avatar-grid" id="avatarGrid"></div>
            </div>

            <div class="form-group">
                <label>Avatar Color</label>
                <div class="color-options" id="colorOptions"></div>
            </div>

            <button class="modal-btn" onclick="saveProfile()">Save Profile</button>
        </div>
    </div>

    <!-- Drawing Modal -->
    <div class="modal-overlay drawing-modal" id="drawingModal">
        <div class="modal">
            <h2>
                <span>ðŸŽ¨</span> Draw Something
                <button class="modal-close" onclick="closeDrawingModal()">Ã—</button>
            </h2>

            <div class="canvas-tools">
                <div class="brush-colors" id="brushColors"></div>
                <button class="tool-btn" onclick="clearCanvas()">Clear</button>
            </div>

            <div class="canvas-container">
                <canvas id="drawingCanvas" width="400" height="300"></canvas>
            </div>

            <button class="modal-btn" onclick="sendDrawing()">Send Drawing</button>
        </div>
    </div>

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

        const SUPABASE_URL = 'https://yjyxteqzhhmtrgcaekgz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM8IS32IUYR2eenCCjdDdioiBU';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Avatar options
        const AVATARS = ['ðŸ˜€', 'ðŸ˜Ž', 'ðŸ¤–', 'ðŸ‘½', 'ðŸ±', 'ðŸ¶', 'ðŸ¦Š', 'ðŸ¼', 'ðŸ¸', 'ðŸ¦„', 'ðŸ²', 'ðŸ‘»', 'ðŸ’€', 'ðŸŽƒ', 'ðŸ¤¡', 'ðŸ‘¾', 'ðŸ¥·', 'ðŸ§™'];
        const COLORS = ['#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#00bcd4', '#009688', '#4caf50', '#ff9800', '#ff5722'];
        const BRUSH_COLORS = ['#000000', '#e91e63', '#9c27b0', '#2196f3', '#4caf50', '#ff9800', '#ff5722', '#ffffff'];

        let currentUser = null;
        let profile = {
            username: 'Anonymous' + Math.floor(Math.random() * 1000),
            avatar: AVATARS[Math.floor(Math.random() * AVATARS.length)],
            color: COLORS[Math.floor(Math.random() * COLORS.length)]
        };
        let selectedImage = null;
        let drawingCtx = null;
        let isDrawing = false;
        let brushColor = '#000000';
        const seenMessageIds = new Set();

        // Load saved profile
        const savedProfile = localStorage.getItem('sloppygram_profile');
        if (savedProfile) {
            profile = JSON.parse(savedProfile);
        }

        // Initialize
        async function init() {
            // Auth
            let { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                const { data, error } = await supabase.auth.signInAnonymously();
                if (error) console.error('Auth error:', error);
                session = data?.session;
            }
            currentUser = session?.user;

            setupAvatarGrid();
            setupColorOptions();
            setupBrushColors();
            setupDrawingCanvas();
            loadMessages();
            subscribeToMessages();

            // Auto-resize textarea
            const input = document.getElementById('messageInput');
            input.addEventListener('input', () => {
                input.style.height = 'auto';
                input.style.height = Math.min(input.scrollHeight, 100) + 'px';
            });

            // Enter to send
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        // Setup avatar grid
        function setupAvatarGrid() {
            const grid = document.getElementById('avatarGrid');
            grid.innerHTML = AVATARS.map(a =>
                `<button class="avatar-option ${a === profile.avatar ? 'selected' : ''}" onclick="selectAvatar('${a}')">${a}</button>`
            ).join('');
        }

        window.selectAvatar = function(avatar) {
            profile.avatar = avatar;
            document.querySelectorAll('.avatar-option').forEach(el => {
                el.classList.toggle('selected', el.textContent === avatar);
            });
        };

        // Setup color options
        function setupColorOptions() {
            const container = document.getElementById('colorOptions');
            container.innerHTML = COLORS.map(c =>
                `<button class="color-option ${c === profile.color ? 'selected' : ''}" style="background: ${c}" onclick="selectColor('${c}')"></button>`
            ).join('');
        }

        window.selectColor = function(color) {
            profile.color = color;
            document.querySelectorAll('.color-option').forEach(el => {
                el.classList.toggle('selected', el.style.background === color);
            });
        };

        // Setup brush colors
        function setupBrushColors() {
            const container = document.getElementById('brushColors');
            container.innerHTML = BRUSH_COLORS.map(c =>
                `<button class="brush-color ${c === brushColor ? 'selected' : ''}" style="background: ${c}" onclick="selectBrushColor('${c}')"></button>`
            ).join('');
        }

        window.selectBrushColor = function(color) {
            brushColor = color;
            document.querySelectorAll('.brush-color').forEach(el => {
                el.classList.toggle('selected', el.style.background === color);
            });
        };

        // Drawing canvas
        function setupDrawingCanvas() {
            const canvas = document.getElementById('drawingCanvas');
            drawingCtx = canvas.getContext('2d');
            drawingCtx.fillStyle = 'white';
            drawingCtx.fillRect(0, 0, canvas.width, canvas.height);
            drawingCtx.lineCap = 'round';
            drawingCtx.lineJoin = 'round';
            drawingCtx.lineWidth = 4;

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const offsetX = touch.clientX - rect.left;
                const offsetY = touch.clientY - rect.top;
                startDrawing({ offsetX, offsetY });
            }, { passive: false });

            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const offsetX = touch.clientX - rect.left;
                const offsetY = touch.clientY - rect.top;
                draw({ offsetX, offsetY });
            }, { passive: false });

            canvas.addEventListener('touchend', stopDrawing);
        }

        function getCanvasCoords(e) {
            const canvas = document.getElementById('drawingCanvas');
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: e.offsetX * scaleX,
                y: e.offsetY * scaleY
            };
        }

        function startDrawing(e) {
            isDrawing = true;
            const coords = getCanvasCoords(e);
            drawingCtx.beginPath();
            drawingCtx.moveTo(coords.x, coords.y);
        }

        function draw(e) {
            if (!isDrawing) return;
            const coords = getCanvasCoords(e);
            drawingCtx.strokeStyle = brushColor;
            drawingCtx.lineTo(coords.x, coords.y);
            drawingCtx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        window.clearCanvas = function() {
            const canvas = document.getElementById('drawingCanvas');
            drawingCtx.fillStyle = 'white';
            drawingCtx.fillRect(0, 0, canvas.width, canvas.height);
        };

        // Load messages
        async function loadMessages() {
            const { data, error } = await supabase
                .from('sloppygram_messages')
                .select('*')
                .order('created_at', { ascending: true })
                .limit(100);

            if (error) {
                console.error('Load error:', error);
                return;
            }

            const container = document.getElementById('messagesContainer');
            const emptyState = document.getElementById('emptyState');

            if (data.length === 0) {
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            data.forEach(msg => {
                seenMessageIds.add(msg.id);
                addMessageToUI(msg);
            });
            container.scrollTop = container.scrollHeight;
        }

        // Subscribe to new messages
        function subscribeToMessages() {
            const channel = supabase
                .channel('sloppygram_realtime')
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'sloppygram_messages'
                }, (payload) => {
                    // Avoid duplicate messages
                    if (seenMessageIds.has(payload.new.id)) return;
                    seenMessageIds.add(payload.new.id);

                    addMessageToUI(payload.new);
                    const container = document.getElementById('messagesContainer');
                    container.scrollTop = container.scrollHeight;
                })
                .subscribe((status) => {
                    console.log('Realtime subscription status:', status);
                    if (status === 'SUBSCRIBED') {
                        document.getElementById('onlineCount').textContent = 'Live ðŸŸ¢';
                    } else if (status === 'CHANNEL_ERROR') {
                        document.getElementById('onlineCount').textContent = 'Reconnecting...';
                        // Retry subscription after a delay
                        setTimeout(subscribeToMessages, 3000);
                    }
                });
        }

        // Add message to UI
        function addMessageToUI(msg) {
            const container = document.getElementById('messagesContainer');
            document.getElementById('emptyState').style.display = 'none';

            const isOwn = msg.user_id === currentUser?.id;
            const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            const div = document.createElement('div');
            div.className = `message ${isOwn ? 'own' : ''}`;

            let contentHTML = '';
            if (msg.content) {
                contentHTML = `<div class="message-content">${escapeHtml(msg.content)}</div>`;
            }
            if (msg.image_data) {
                contentHTML += `<img class="message-image" src="${msg.image_data}" onclick="window.open(this.src)">`;
            }
            if (msg.drawing_data) {
                contentHTML += `<img class="message-drawing" src="${msg.drawing_data}">`;
            }

            div.innerHTML = `
                <div class="avatar" style="background: ${msg.avatar ? getAvatarColor(msg.username) : '#666'}">${msg.avatar || 'ðŸ‘¤'}</div>
                <div class="message-bubble">
                    <div class="message-header">
                        <span class="message-username">${escapeHtml(msg.username || 'Anonymous')}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    ${contentHTML}
                </div>
            `;

            container.appendChild(div);
        }

        function getAvatarColor(username) {
            let hash = 0;
            for (let i = 0; i < (username || '').length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
            }
            return COLORS[Math.abs(hash) % COLORS.length];
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Send message
        window.sendMessage = async function() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content && !selectedImage) return;

            const msg = {
                username: profile.username,
                avatar: profile.avatar,
                content: content || null,
                image_data: selectedImage || null,
                drawing_data: null,
                message_type: selectedImage ? 'image' : 'text',
                user_id: currentUser?.id
            };

            const { error } = await supabase.from('sloppygram_messages').insert(msg);

            if (error) {
                console.error('Send error:', error);
                alert('Failed to send message');
                return;
            }

            input.value = '';
            input.style.height = 'auto';
            removeImage();
        };

        // Send drawing
        window.sendDrawing = async function() {
            const canvas = document.getElementById('drawingCanvas');
            const drawingData = canvas.toDataURL('image/png');

            const msg = {
                username: profile.username,
                avatar: profile.avatar,
                content: null,
                image_data: null,
                drawing_data: drawingData,
                message_type: 'drawing',
                user_id: currentUser?.id
            };

            const { error } = await supabase.from('sloppygram_messages').insert(msg);

            if (error) {
                console.error('Send error:', error);
                alert('Failed to send drawing');
                return;
            }

            closeDrawingModal();
            clearCanvas();
        };

        // Image handling
        window.handleImageSelect = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 500000) {
                alert('Image too large. Please use an image under 500KB.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                selectedImage = e.target.result;
                document.getElementById('previewImg').src = selectedImage;
                document.getElementById('imagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        };

        window.removeImage = function() {
            selectedImage = null;
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('imageInput').value = '';
        };

        // Profile modal
        window.openProfileModal = function() {
            document.getElementById('usernameInput').value = profile.username;
            setupAvatarGrid();
            setupColorOptions();
            document.getElementById('profileModal').classList.add('active');
        };

        window.closeProfileModal = function() {
            document.getElementById('profileModal').classList.remove('active');
        };

        window.saveProfile = function() {
            const username = document.getElementById('usernameInput').value.trim() || 'Anonymous';
            profile.username = username;
            localStorage.setItem('sloppygram_profile', JSON.stringify(profile));
            closeProfileModal();
        };

        // Drawing modal
        window.openDrawingModal = function() {
            clearCanvas();
            document.getElementById('drawingModal').classList.add('active');
        };

        window.closeDrawingModal = function() {
            document.getElementById('drawingModal').classList.remove('active');
        };

        // Initialize
        init();
    </script>
</body>
</html>
