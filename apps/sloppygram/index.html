<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sloppygram - Cyber Chat 1999</title>
    <link rel="icon" href="https://emojicdn.elk.sh/üíæ">

    <meta property="og:title" content="Sloppygram">
    <meta property="og:description" content="Retro cyber chatroom from 1999. Global chat and pure vibes.">
    <meta property="og:url" content="https://sloppy.live/sloppygram">
    <meta property="og:image" content="https://image.pollinations.ai/prompt/1990s%20retro%20cyber%20chatroom%20neon%20green%20dark%20hacker%20aesthetic%20terminal?width=1200&height=630&nologo=true">
    <meta property="og:type" content="website">

    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --accent: #7c9885;
            --accent-light: #a8c4b0;
            --accent-dim: #5a7060;
            --highlight: #c9a87c;
            --dark-bg: #0a0a0f;
            --panel-bg: #12121a;
            --border-color: #2a2a35;
            --text-dim: #6a6a75;
        }

        body {
            font-family: 'VT323', monospace;
            background: var(--dark-bg);
            min-height: 100vh;
            color: var(--accent);
            overflow: hidden;
        }

        /* Scanline effect */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.15),
                rgba(0, 0, 0, 0.15) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 9999;
        }

        .app {
            display: grid;
            grid-template-columns: 200px 1fr 180px;
            grid-template-rows: auto 1fr auto;
            height: 100vh;
            gap: 1px;
            background: var(--border-color);
        }

        @media (max-width: 768px) {
            .app {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr auto;
            }
            .sidebar-left, .sidebar-right {
                display: none;
            }
            .sidebar-left.mobile-show, .sidebar-right.mobile-show {
                display: block;
                position: fixed;
                top: 60px;
                bottom: 60px;
                width: 80%;
                max-width: 300px;
                z-index: 100;
            }
            .sidebar-left.mobile-show { left: 0; }
            .sidebar-right.mobile-show { right: 0; }
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            background: var(--panel-bg);
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-size: 1.8rem;
            color: var(--accent-light);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-blink {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .marquee-container {
            flex: 1;
            overflow: hidden;
            margin: 0 20px;
            color: var(--highlight);
            font-size: 1.1rem;
        }

        .marquee {
            display: inline-block;
            white-space: nowrap;
            animation: marquee 20s linear infinite;
        }

        @keyframes marquee {
            from { transform: translateX(100%); }
            to { transform: translateX(-100%); }
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .cyber-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--accent);
            padding: 6px 12px;
            font-family: inherit;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cyber-btn:hover {
            background: var(--accent-dim);
            color: white;
        }

        /* Sidebars */
        .sidebar-left, .sidebar-right {
            background: var(--panel-bg);
            padding: 12px;
            overflow-y: auto;
        }

        .panel-title {
            color: var(--highlight);
            font-size: 1.2rem;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border-color);
        }

        /* Online Users */
        .user-list {
            list-style: none;
        }

        .user-item {
            padding: 6px 8px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            border-left: 2px solid transparent;
            transition: all 0.2s;
        }

        .user-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-left-color: var(--accent);
        }

        .user-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .user-avatar {
            font-size: 1.2rem;
        }

        .user-name {
            color: var(--accent-light);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Public Feed */
        .feed-item {
            padding: 8px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.02);
            border-left: 2px solid var(--border-color);
            font-size: 0.95rem;
        }

        .feed-user {
            color: var(--highlight);
        }

        .feed-action {
            color: var(--text-dim);
        }

        .feed-time {
            color: #666;
            font-size: 0.85rem;
        }

        /* Messages Container */
        .main-content {
            background: var(--panel-bg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 0;
        }

        .messages-container::-webkit-scrollbar {
            width: 8px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: var(--dark-bg);
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: var(--border-color);
        }

        .message {
            display: flex;
            gap: 10px;
            animation: glitchIn 0.3s ease-out;
        }

        @keyframes glitchIn {
            0% { opacity: 0; transform: translateX(-10px); }
            50% { opacity: 1; transform: translateX(3px); }
            100% { transform: translateX(0); }
        }

        .message.own {
            flex-direction: row-reverse;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
            background: var(--dark-bg);
        }

        .message-bubble {
            max-width: 70%;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px 14px;
            color: var(--accent);
        }

        .message.own .message-bubble {
            background: rgba(124, 152, 133, 0.15);
            color: var(--accent-light);
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .message-username {
            color: var(--accent-light);
            font-size: 1rem;
        }

        .message.own .message-username {
            color: var(--highlight);
        }

        .message-time {
            font-size: 0.85rem;
            color: #555;
        }

        .message-content {
            font-size: 1.1rem;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message-image, .message-drawing {
            max-width: 100%;
            margin-top: 8px;
            cursor: pointer;
            border: 1px solid var(--border-color);
        }

        /* Doodle Vote */
        .doodle-wrapper {
            position: relative;
            display: inline-block;
        }

        .doodle-vote-btn {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0,0,0,0.7);
            border: 1px solid var(--border-color);
            color: var(--text-dim);
            padding: 4px 10px;
            font-family: inherit;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .doodle-vote-btn:hover {
            background: rgba(0,0,0,0.9);
            border-color: var(--highlight);
            color: var(--highlight);
        }

        .doodle-vote-btn.voted {
            color: var(--highlight);
            border-color: var(--highlight);
        }

        /* Doodle Leaderboard */
        .doodles-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: none;
            flex-direction: column;
            gap: 16px;
            min-height: 0;
        }

        .doodles-container.active {
            display: flex;
        }

        .leaderboard-header {
            text-align: center;
            padding: 16px;
            color: var(--accent);
            font-size: 1.1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .doodle-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }

        .doodle-card {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            overflow: hidden;
            border-radius: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .doodle-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .doodle-card.top-3 {
            border-color: var(--highlight);
        }

        .doodle-rank {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--dark-bg);
        }

        .rank-badge {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            background: var(--border-color);
            color: var(--text-dim);
        }

        .rank-badge.gold {
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #000;
        }
        .rank-badge.silver {
            background: linear-gradient(135deg, #e0e0e0, #a0a0a0);
            color: #000;
        }
        .rank-badge.bronze {
            background: linear-gradient(135deg, #cd7f32, #8b4513);
            color: #fff;
        }

        .doodle-artist {
            flex: 1;
            color: var(--accent-light);
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .doodle-votes {
            color: var(--highlight);
            font-size: 1rem;
            font-weight: bold;
        }

        .doodle-thumbnail {
            position: relative;
            background: #111;
            aspect-ratio: 4/3;
            overflow: hidden;
        }

        .doodle-card img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .doodle-card:hover img {
            transform: scale(1.05);
        }

        .doodle-card-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-top: 1px solid var(--border-color);
            background: var(--dark-bg);
        }

        .doodle-time {
            color: var(--text-dim);
            font-size: 0.75rem;
        }

        .empty-doodles {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-dim);
        }

        /* Input Area */
        .input-area {
            background: var(--dark-bg);
            padding: 12px 16px;
            grid-column: 1 / -1;
        }

        .input-row {
            display: flex;
            gap: 8px;
            align-items: flex-end;
            max-width: 800px;
            margin: 0 auto;
        }

        .input-actions {
            display: flex;
            gap: 4px;
        }

        .action-btn {
            width: 40px;
            height: 40px;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--accent);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: var(--accent-dim);
            color: white;
        }

        .message-input {
            flex: 1;
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            padding: 10px 16px;
            color: var(--accent-light);
            font-family: inherit;
            font-size: 1.1rem;
            resize: none;
            max-height: 100px;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--accent-dim);
        }

        .message-input::placeholder {
            color: var(--text-dim);
        }

        .send-btn {
            width: 60px;
            height: 40px;
            border: 1px solid var(--border-color);
            background: var(--accent-dim);
            color: white;
            font-family: inherit;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .send-btn:hover {
            background: var(--accent);
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            padding: 24px;
            width: 90%;
            max-width: 400px;
            max-height: 85vh;
            overflow-y: auto;
            color: var(--accent);
        }

        .modal h2 {
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--accent-light);
            font-size: 1.5rem;
        }

        .modal-close {
            margin-left: auto;
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 24px;
            cursor: pointer;
        }

        /* Avatar Picker */
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .avatar-option {
            aspect-ratio: 1;
            border: 2px solid #333;
            background: var(--dark-bg);
            font-size: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .avatar-option:hover {
            border-color: var(--accent-dim);
        }

        .avatar-option.selected {
            border-color: var(--accent);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 1rem;
            color: var(--highlight);
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            background: var(--dark-bg);
            border: 1px solid var(--border-color);
            color: var(--accent-light);
            font-family: inherit;
            font-size: 1.1rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent-dim);
        }

        .color-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .color-option {
            width: 32px;
            height: 32px;
            border: 2px solid transparent;
            cursor: pointer;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: white;
        }

        .modal-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent-dim);
            border: 1px solid var(--border-color);
            color: white;
            font-family: inherit;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 16px;
            transition: all 0.2s;
        }

        .modal-btn:hover {
            background: var(--accent);
        }

        /* File Upload */
        .file-upload-row {
            display: flex;
            gap: 8px;
        }

        .file-upload-btn {
            flex: 1;
            padding: 10px;
            background: var(--dark-bg);
            border: 1px dashed var(--border-color);
            color: var(--text-dim);
            font-family: inherit;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-upload-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .file-clear-btn {
            padding: 10px 15px;
            background: #3a2020;
            border: 1px solid #5a3030;
            color: #ff6666;
            font-family: inherit;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-clear-btn:hover {
            background: #4a2525;
        }

        .upload-preview {
            margin-top: 10px;
            border: 1px solid var(--border-color);
            padding: 8px;
            background: var(--dark-bg);
        }

        .upload-preview img {
            max-width: 100%;
            max-height: 150px;
            display: block;
            margin: 0 auto;
        }

        /* Global Backgrounds */
        .global-bg-section {
            margin-top: 8px;
        }

        .global-bg-label {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-bottom: 8px;
        }

        .global-bg-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            max-height: 150px;
            overflow-y: auto;
        }

        .global-bg-item {
            aspect-ratio: 16/9;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
        }

        .global-bg-item:hover {
            border-color: var(--accent);
            transform: scale(1.05);
        }

        .global-bg-item.selected {
            border-color: var(--highlight);
        }

        .global-bg-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .global-bg-upload {
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--dark-bg);
            color: var(--text-dim);
            font-size: 1.5rem;
        }

        .global-bg-upload:hover {
            color: var(--accent);
        }

        /* Drawing Canvas */
        .drawing-modal .modal {
            max-width: 500px;
        }

        .canvas-container {
            background: #111;
            border: 1px solid var(--border-color);
            margin-bottom: 16px;
        }

        #drawingCanvas {
            display: block;
            width: 100%;
            cursor: crosshair;
            touch-action: none;
        }

        .canvas-tools {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .tool-btn {
            padding: 8px 12px;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--accent);
            cursor: pointer;
            font-family: inherit;
        }

        .tool-btn:hover, .tool-btn.active {
            background: var(--accent-dim);
            color: white;
        }

        .brush-colors {
            display: flex;
            gap: 6px;
        }

        .brush-color {
            width: 28px;
            height: 28px;
            border: 2px solid #333;
            cursor: pointer;
        }

        .brush-color.selected {
            border-color: white;
        }

        /* Image preview */
        .image-preview {
            margin-bottom: 8px;
            position: relative;
            display: none;
        }

        .image-preview img {
            max-width: 200px;
            max-height: 150px;
            border: 1px solid var(--border-color);
        }

        .image-preview .remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background: #ff4444;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }

        .backlink {
            text-align: center;
            padding: 4px;
            font-size: 0.9rem;
            color: #444;
            background: var(--dark-bg);
        }

        .backlink a {
            color: var(--accent);
            text-decoration: none;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-dim);
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        #imageInput {
            display: none;
        }

        /* Mobile toggle buttons */
        .mobile-toggle {
            display: none;
        }

        @media (max-width: 768px) {
            .mobile-toggle {
                display: inline-block;
            }
        }

        /* Tabs */
        .view-tabs {
            display: flex;
            background: var(--dark-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .view-tab {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-dim);
            font-family: inherit;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-tab:hover {
            color: var(--accent);
        }

        .view-tab.active {
            color: var(--accent-light);
            border-bottom-color: var(--accent);
        }

        /* Posts Container */
        .posts-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: none;
            flex-direction: column;
            gap: 16px;
            min-height: 0;
        }

        .posts-container.active {
            display: flex;
        }

        .messages-container.hidden {
            display: none;
        }

        /* Post Card */
        .post-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .post-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--dark-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            border: 1px solid var(--border-color);
        }

        .post-username {
            color: var(--accent-light);
            font-size: 1.1rem;
        }

        .post-time {
            margin-left: auto;
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        .post-image {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            background: #000;
            display: block;
        }

        .post-caption {
            padding: 12px;
            font-size: 1.1rem;
            line-height: 1.4;
            border-top: 1px solid var(--border-color);
        }

        /* Post Tags */
        .post-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 8px 12px;
            border-top: 1px solid var(--border-color);
        }

        .tag {
            background: linear-gradient(135deg, rgba(124, 152, 133, 0.2), rgba(169, 196, 176, 0.1));
            border: 1px solid var(--accent-dim);
            border-radius: 4px;
            padding: 3px 8px;
            font-size: 0.85rem;
            color: var(--accent-light);
            cursor: pointer;
            transition: all 0.2s;
        }

        .tag:hover {
            background: var(--accent-dim);
            color: white;
        }

        .tag.nested {
            background: linear-gradient(135deg, rgba(201, 168, 124, 0.2), rgba(201, 168, 124, 0.1));
            border-color: var(--highlight);
            color: var(--highlight);
        }

        .tag.nested:hover {
            background: var(--highlight);
            color: var(--dark-bg);
        }

        .tag-hierarchy {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-right: 2px;
        }

        /* Tag Filter Bar */
        .tag-filter-bar {
            display: none;
            padding: 8px 12px;
            background: var(--dark-bg);
            border-bottom: 1px solid var(--border-color);
            align-items: center;
            gap: 8px;
        }

        .tag-filter-bar.active {
            display: flex;
        }

        .tag-filter-bar .tag {
            background: var(--accent);
            color: white;
        }

        .clear-filter {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0 8px;
        }

        .clear-filter:hover {
            color: #ff6666;
        }

        /* Trending Tags */
        .trending-tags {
            padding: 12px;
            border-top: 1px solid var(--border-color);
        }

        .trending-title {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .trending-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .trending-tag {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 4px 10px;
            font-size: 0.8rem;
            color: var(--accent);
            cursor: pointer;
            transition: all 0.2s;
        }

        .trending-tag:hover {
            border-color: var(--accent);
            background: rgba(124, 152, 133, 0.2);
        }

        .trending-tag .count,
        .trending-tag .tag-count {
            color: var(--text-dim);
            font-size: 0.7rem;
            margin-left: 4px;
        }

        .trending-tag.hot {
            background: linear-gradient(135deg, rgba(255,100,100,0.2), rgba(255,150,100,0.1));
            border-color: #ff6666;
            color: #ff9999;
        }

        .trending-tag.warm {
            background: linear-gradient(135deg, rgba(201,168,124,0.2), rgba(201,168,124,0.1));
            border-color: var(--highlight);
            color: var(--highlight);
        }

        .trending-tags-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }

        .trending-tags-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 200px;
            overflow-y: auto;
        }

        .trending-tags-list .trending-tag {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Tag Input */
        .tag-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 8px;
            background: var(--dark-bg);
            border: 1px solid var(--border-color);
            min-height: 40px;
            align-items: center;
        }

        .tag-input-container .tag {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .tag-input-container .tag .remove {
            cursor: pointer;
            opacity: 0.7;
        }

        .tag-input-container .tag .remove:hover {
            opacity: 1;
        }

        .tag-input {
            flex: 1;
            min-width: 100px;
            background: transparent;
            border: none;
            color: var(--accent);
            font-family: inherit;
            font-size: 0.9rem;
            outline: none;
        }

        .tag-input::placeholder {
            color: var(--text-dim);
        }

        .post-actions {
            display: flex;
            gap: 16px;
            padding: 10px 12px;
            border-top: 1px solid var(--border-color);
        }

        .post-action-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            font-family: inherit;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s;
        }

        .post-action-btn:hover {
            color: var(--accent-light);
        }

        .post-action-btn.liked {
            color: #ff4466;
        }

        /* Emoji Reactions */
        .post-reactions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 8px 12px;
            border-top: 1px solid var(--border-color);
        }

        .reaction-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 4px 10px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .reaction-btn:hover {
            background: rgba(255,255,255,0.1);
            border-color: var(--accent);
        }

        .reaction-btn.active {
            background: rgba(124, 152, 133, 0.2);
            border-color: var(--accent);
        }

        .reaction-count {
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .add-reaction-btn {
            background: transparent;
            border: 1px dashed var(--border-color);
            border-radius: 16px;
            padding: 4px 10px;
            font-size: 0.9rem;
            cursor: pointer;
            color: var(--text-dim);
            transition: all 0.2s;
        }

        .add-reaction-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .reaction-picker {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 0;
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px;
            gap: 4px;
            flex-wrap: wrap;
            max-width: 200px;
            z-index: 10;
        }

        .reaction-picker.active {
            display: flex;
        }

        .reaction-picker button {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .reaction-picker button:hover {
            background: rgba(255,255,255,0.1);
        }

        .post-comments {
            border-top: 1px solid var(--border-color);
            max-height: 200px;
            overflow-y: auto;
        }

        .comment {
            display: flex;
            gap: 8px;
            padding: 8px 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .comment-avatar {
            font-size: 16px;
        }

        .comment-content {
            flex: 1;
        }

        .comment-username {
            color: var(--accent);
            font-size: 0.95rem;
        }

        .comment-text {
            color: var(--accent-light);
            font-size: 1rem;
        }

        .comment-input-row {
            display: flex;
            gap: 8px;
            padding: 8px 12px;
            border-top: 1px solid var(--border-color);
        }

        .comment-input {
            flex: 1;
            background: var(--dark-bg);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            color: var(--accent-light);
            font-family: inherit;
            font-size: 1rem;
        }

        .comment-input:focus {
            outline: none;
            border-color: var(--accent-dim);
        }

        .comment-send {
            background: var(--accent-dim);
            border: none;
            color: white;
            padding: 8px 16px;
            font-family: inherit;
            cursor: pointer;
        }

        .comment-send:hover {
            background: var(--accent);
        }

        /* Create Post Button */
        .create-post-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--accent-dim);
            border: 2px solid var(--accent);
            color: white;
            font-size: 28px;
            cursor: pointer;
            z-index: 50;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .create-post-btn.visible {
            display: flex;
        }

        .create-post-btn:hover {
            background: var(--accent);
            transform: scale(1.1);
        }

        /* Post Modal */
        .post-modal .modal {
            max-width: 500px;
        }

        .post-preview {
            margin-bottom: 16px;
            border: 1px solid var(--border-color);
            background: #000;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dim);
        }

        .post-preview img {
            max-width: 100%;
            max-height: 300px;
            display: block;
        }

        .post-preview.has-image {
            min-height: auto;
        }

        .or-divider {
            text-align: center;
            margin: 12px 0;
            color: var(--text-dim);
        }

    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <div class="logo">
                <span>üíæ</span>
                <span>SLOPPYGRAM<span class="logo-blink">_</span></span>
            </div>
            <div class="marquee-container">
                <div class="marquee">
                    ‚òÖ WELCOME TO THE CYBER ZONE ‚òÖ GLOBAL CHAT ‚òÖ EST. 1999 ‚òÖ VISITORS: <span id="visitorCount">???</span> ‚òÖ
                </div>
            </div>
            <div class="header-actions">
                <button class="cyber-btn mobile-toggle" onclick="toggleSidebar('left')">USERS</button>
                <button class="cyber-btn mobile-toggle" onclick="toggleSidebar('right')">FEED</button>
                <button class="cyber-btn" onclick="openProfileModal()">PROFILE</button>
            </div>
        </div>

        <div class="sidebar-left" id="sidebarLeft">
            <div class="panel-title">[ ONLINE USERS ]</div>
            <ul class="user-list" id="userList">
            </ul>
        </div>

        <div class="main-content">
            <div class="view-tabs">
                <button class="view-tab active" data-view="chat" onclick="switchView('chat')">üí¨ CHAT</button>
                <button class="view-tab" data-view="posts" onclick="switchView('posts')">üì∏ POSTS</button>
                <button class="view-tab" data-view="doodles" onclick="switchView('doodles')">üèÜ DOODLES</button>
            </div>
            <div class="messages-container" id="messagesContainer">
                <div class="empty-state" id="emptyState">
                    <div class="icon">üíæ</div>
                    <p>INITIALIZING CHAT PROTOCOL...</p>
                    <p>Say something!</p>
                </div>
            </div>
            <div class="tag-filter-bar" id="tagFilterBar">
                <span style="color:var(--text-dim);font-size:0.85rem;">Filtering by:</span>
                <span class="tag" id="activeFilterTag"></span>
                <button class="clear-filter" onclick="clearTagFilter()">√ó</button>
            </div>
            <div class="posts-container" id="postsContainer">
                <div class="empty-state" id="postsEmptyState">
                    <div class="icon">üì∏</div>
                    <p>NO POSTS YET...</p>
                    <p>Be the first to share!</p>
                </div>
            </div>
            <div class="doodles-container" id="doodlesContainer">
                <div class="leaderboard-header">üèÜ LEGENDARY DOODLES üèÜ</div>
                <div class="empty-doodles" id="doodlesEmptyState">
                    <div class="icon">üé®</div>
                    <p>NO LEGENDARY DOODLES YET...</p>
                    <p>Draw something and get votes!</p>
                </div>
            </div>
        </div>

        <div class="sidebar-right" id="sidebarRight">
            <div class="panel-title">[ PUBLIC FEED ]</div>
            <div id="publicFeed">
                <div class="feed-item">
                    <span class="feed-user">System</span>
                    <span class="feed-action">initialized</span>
                    <div class="feed-time">just now</div>
                </div>
            </div>
            <div class="trending-tags-section" id="trendingTagsSection">
                <div class="panel-title">[ TRENDING TAGS ]</div>
                <div id="trendingTagsList" class="trending-tags-list">
                    <div style="font-size:0.85rem;color:var(--text-dim)">Loading tags...</div>
                </div>
            </div>
        </div>

        <div class="input-area">
            <div class="image-preview" id="imagePreview">
                <img id="previewImg" src="">
                <button class="remove-btn" onclick="removeImage()">√ó</button>
            </div>
            <div class="input-row">
                <div class="input-actions">
                    <button class="action-btn" onclick="document.getElementById('imageInput').click()">üì∑</button>
                    <button class="action-btn" onclick="openDrawingModal()">üé®</button>
                </div>
                <input type="file" id="imageInput" accept="image/*" onchange="handleImageSelect(event)">
                <textarea class="message-input" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
                <button class="send-btn" onclick="sendMessage()">SEND</button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal">
            <h2>
                <span>üë§</span> PROFILE CONFIG
                <button class="modal-close" onclick="closeProfileModal()">√ó</button>
            </h2>

            <div class="form-group">
                <label>USERNAME:</label>
                <input type="text" id="usernameInput" placeholder="Enter handle..." maxlength="20">
            </div>

            <div class="form-group">
                <label>SELECT AVATAR:</label>
                <div class="avatar-grid" id="avatarGrid"></div>
            </div>

            <div class="form-group">
                <label>CUSTOM AVATAR (upload image):</label>
                <div class="file-upload-row">
                    <input type="file" id="avatarFileInput" accept="image/*" onchange="handleAvatarUpload(event)" style="display:none">
                    <button class="file-upload-btn" onclick="document.getElementById('avatarFileInput').click()">üìÅ CHOOSE FILE</button>
                    <button class="file-clear-btn" onclick="clearAvatarUpload()" id="clearAvatarBtn" style="display:none">‚úï CLEAR</button>
                </div>
                <div class="upload-preview" id="avatarPreview" style="display:none">
                    <img id="avatarPreviewImg" src="">
                </div>
            </div>

            <div class="form-group">
                <label>AVATAR COLOR:</label>
                <div class="color-options" id="colorOptions"></div>
            </div>

            <div class="form-group">
                <label>CUSTOM BACKGROUND (upload image):</label>
                <div class="file-upload-row">
                    <input type="file" id="bgFileInput" accept="image/*" onchange="handleBgUpload(event)" style="display:none">
                    <button class="file-upload-btn" onclick="document.getElementById('bgFileInput').click()">üìÅ UPLOAD NEW</button>
                    <button class="file-upload-btn" onclick="shareBackground()" id="shareBgBtn" style="display:none">üåê SHARE</button>
                    <button class="file-clear-btn" onclick="clearBgUpload()" id="clearBgBtn" style="display:none">‚úï</button>
                </div>
                <div class="upload-preview" id="bgPreview" style="display:none">
                    <img id="bgPreviewImg" src="">
                </div>
                <div class="global-bg-section">
                    <div class="global-bg-label">Or choose a shared background:</div>
                    <div class="global-bg-grid" id="globalBgGrid">
                        <div class="global-bg-item global-bg-upload" onclick="document.getElementById('bgFileInput').click()" title="Upload new">+</div>
                    </div>
                </div>
            </div>

            <button class="modal-btn" onclick="saveProfile()">[ SAVE ]</button>
            <button class="modal-btn" style="background: #3a2020; margin-top: 8px;" onclick="resetProfile()">[ RESET ALL ]</button>
        </div>
    </div>

    <!-- Drawing Modal -->
    <div class="modal-overlay drawing-modal" id="drawingModal">
        <div class="modal">
            <h2>
                <span>üé®</span> PIXEL CANVAS
                <button class="modal-close" onclick="closeDrawingModal()">√ó</button>
            </h2>

            <div class="canvas-tools">
                <div class="brush-colors" id="brushColors"></div>
                <button class="tool-btn" onclick="clearCanvas()">CLEAR</button>
            </div>

            <div class="canvas-container">
                <canvas id="drawingCanvas" width="400" height="300"></canvas>
            </div>

            <button class="modal-btn" onclick="sendDrawing()">[ TRANSMIT ]</button>
        </div>
    </div>

    <!-- Create Post Modal -->
    <div class="modal-overlay post-modal" id="postModal">
        <div class="modal">
            <h2>
                <span>üì∏</span> NEW POST
                <button class="modal-close" onclick="closePostModal()">√ó</button>
            </h2>

            <div class="post-preview" id="postPreview">
                <span>No image selected</span>
            </div>

            <div class="form-group">
                <label>IMAGE URL:</label>
                <input type="text" id="postImageUrl" placeholder="https://example.com/image.jpg" oninput="previewPostImage()">
            </div>

            <div class="or-divider">‚Äî OR ‚Äî</div>

            <div class="form-group">
                <label>UPLOAD FILE:</label>
                <input type="file" id="postFileInput" accept="image/*" onchange="handlePostFileSelect(event)" style="display:block;background:var(--dark-bg);padding:8px;border:1px solid var(--border-color);color:var(--accent-light);width:100%;">
            </div>

            <div class="form-group">
                <label>CAPTION:</label>
                <input type="text" id="postCaption" placeholder="Write something..." maxlength="280">
            </div>

            <div class="form-group">
                <label>TAGS (use parent/child for nested):</label>
                <div class="tag-input-container" id="tagInputContainer">
                    <input type="text" class="tag-input" id="tagInput" placeholder="Type tag and press Enter... (e.g. art/digital)" onkeydown="handleTagInput(event)">
                </div>
                <div style="font-size:0.75rem;color:var(--text-dim);margin-top:4px;">
                    Tip: Use "/" for nested tags like "meme/cursed" or "art/pixel"
                </div>
            </div>

            <button class="modal-btn" onclick="submitPost()">[ POST IT ]</button>
        </div>
    </div>

    <!-- Create Post FAB -->
    <button class="create-post-btn" id="createPostBtn" onclick="openPostModal()">+</button>

    <div class="backlink">
        &lt;/&gt; Built at <a href="https://sloppy.live">sloppy.live</a> | Netscape Navigator Recommended
    </div>

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

        const SUPABASE_URL = 'https://yjyxteqzhhmtrgcaekgz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM8IS32IUYR2eenCCjdDdioiBU';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                persistSession: true,
                storageKey: 'sloppygram-auth',
                autoRefreshToken: true,
                detectSessionInUrl: false
            }
        });

        // Avatar options
        const AVATARS = ['üòÄ', 'üòé', 'ü§ñ', 'üëΩ', 'üê±', 'üê∂', 'ü¶ä', 'üêº', 'üê∏', 'ü¶Ñ', 'üê≤', 'üëª', 'üíÄ', 'üéÉ', 'ü§°', 'üëæ', 'ü•∑', 'üßô'];
        const COLORS = ['#00ff41', '#00ffff', '#ff00ff', '#ffff00', '#ff4444', '#ff8800', '#8844ff', '#44ff88', '#ff44aa', '#44aaff'];
        const BRUSH_COLORS = ['#00ff41', '#00ffff', '#ff00ff', '#ffff00', '#ff4444', '#ffffff', '#000000', '#888888'];

        let currentUser = null;
        let profile = {
            username: 'Anon' + Math.floor(Math.random() * 9999),
            avatar: AVATARS[Math.floor(Math.random() * AVATARS.length)],
            color: COLORS[Math.floor(Math.random() * COLORS.length)],
            avatarUrl: '',
            bgUrl: ''
        };
        let selectedImage = null;
        let drawingCtx = null;
        let isDrawing = false;
        let brushColor = '#00ff41';
        const seenMessageIds = new Set();
        let onlineUsers = new Map();
        let realtimeChannel = null;
        let currentView = 'chat';
        let posts = [];
        let postLikes = {};
        let postComments = {};
        let postReactions = {}; // { postId: { emoji: count, ... } }
        let myReactions = {}; // { postId: Set of emojis I've reacted with }
        const REACTION_EMOJIS = ['üòÇ', 'üî•', '‚ù§Ô∏è', 'üòÆ', 'üò¢', 'üëè', 'üôå', 'üíÄ'];
        let globalBackgrounds = [];
        let postImageData = null;
        let doodleVotes = {}; // { messageId: voteCount }
        let myDoodleVotes = {}; // { messageId: true } for votes I've cast
        let postTags = {}; // { postId: [{ tag, parent_tag }, ...] }
        let pendingTags = []; // tags being added to new post
        let activeTagFilter = null; // current tag filter

        // Load saved profile
        const savedProfile = localStorage.getItem('sloppygram_profile');
        if (savedProfile) {
            profile = JSON.parse(savedProfile);
        }

        // Initialize
        async function init() {
            // Listen for auth state changes
            supabase.auth.onAuthStateChange((event, session) => {
                console.log('Auth state changed:', event);
                if (session) {
                    currentUser = session.user;
                }
            });

            // Auth - try to restore existing session first
            let { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                console.log('No existing session, signing in anonymously...');
                const { data, error } = await supabase.auth.signInAnonymously();
                if (error) console.error('Auth error:', error);
                session = data?.session;
            } else {
                console.log('Restored existing session for user:', session.user?.id);
            }
            currentUser = session?.user;

            setupAvatarGrid();
            setupColorOptions();
            setupBrushColors();
            setupDrawingCanvas();
            await loadDoodleVotes();
            loadMessages();
            subscribeToMessages();
            setupPresence();
            applyCustomBackground();

            // Random visitor count for 90s vibes
            document.getElementById('visitorCount').textContent = Math.floor(10000 + Math.random() * 90000);

            // Auto-resize textarea
            const input = document.getElementById('messageInput');
            input.addEventListener('input', () => {
                input.style.height = 'auto';
                input.style.height = Math.min(input.scrollHeight, 100) + 'px';
            });

            // Enter to send
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        // Presence for online users
        function setupPresence() {
            const presenceChannel = supabase.channel('sloppygram_presence', {
                config: {
                    presence: { key: currentUser?.id || 'anon_' + Math.random() }
                }
            });

            presenceChannel
                .on('presence', { event: 'sync' }, () => {
                    const state = presenceChannel.presenceState();
                    updateOnlineUsers(state);
                })
                .on('presence', { event: 'join' }, ({ key, newPresences }) => {
                    addToFeed(newPresences[0]?.username || 'Someone', 'joined the chat');
                })
                .on('presence', { event: 'leave' }, ({ key, leftPresences }) => {
                    addToFeed(leftPresences[0]?.username || 'Someone', 'left the chat');
                })
                .subscribe(async (status) => {
                    if (status === 'SUBSCRIBED') {
                        await presenceChannel.track({
                            username: profile.username,
                            avatar: profile.avatar,
                            avatarUrl: profile.avatarUrl || null,
                            color: profile.color,
                            online_at: new Date().toISOString()
                        });
                    }
                });
        }

        function updateOnlineUsers(state) {
            const userList = document.getElementById('userList');
            const users = [];

            // Add real users
            Object.values(state).forEach(presences => {
                presences.forEach(p => {
                    if (!users.find(u => u.username === p.username)) {
                        users.push(p);
                    }
                });
            });

            userList.innerHTML = users.map(u => {
                const avatarContent = u.avatarUrl
                    ? `<img src="${u.avatarUrl}" style="width:24px;height:24px;border-radius:50%;object-fit:cover;">`
                    : u.avatar;
                return `
                <li class="user-item">
                    <span class="user-status"></span>
                    <span class="user-avatar">${avatarContent}</span>
                    <span class="user-name" style="color: ${u.color || 'var(--accent-light)'}">${escapeHtml(u.username)}</span>
                </li>
            `}).join('');
        }

        function addToFeed(user, action) {
            const feed = document.getElementById('publicFeed');
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            const item = document.createElement('div');
            item.className = 'feed-item';
            item.innerHTML = `
                <span class="feed-user">${escapeHtml(user)}</span>
                <span class="feed-action">${action}</span>
                <div class="feed-time">${time}</div>
            `;

            feed.insertBefore(item, feed.firstChild);

            // Keep only last 20 items
            while (feed.children.length > 20) {
                feed.removeChild(feed.lastChild);
            }
        }

        // Setup avatar grid
        function setupAvatarGrid() {
            const grid = document.getElementById('avatarGrid');
            grid.innerHTML = AVATARS.map(a =>
                `<button class="avatar-option ${a === profile.avatar ? 'selected' : ''}" onclick="selectAvatar('${a}')">${a}</button>`
            ).join('');
        }

        window.selectAvatar = function(avatar) {
            profile.avatar = avatar;
            document.querySelectorAll('.avatar-option').forEach(el => {
                el.classList.toggle('selected', el.textContent === avatar);
            });
        };

        // Setup color options
        function setupColorOptions() {
            const container = document.getElementById('colorOptions');
            container.innerHTML = COLORS.map(c =>
                `<button class="color-option ${c === profile.color ? 'selected' : ''}" style="background: ${c}" onclick="selectColor('${c}')"></button>`
            ).join('');
        }

        window.selectColor = function(color) {
            profile.color = color;
            document.querySelectorAll('.color-option').forEach(el => {
                el.classList.toggle('selected', el.style.background === color);
            });
        };

        // Setup brush colors
        function setupBrushColors() {
            const container = document.getElementById('brushColors');
            container.innerHTML = BRUSH_COLORS.map(c =>
                `<button class="brush-color ${c === brushColor ? 'selected' : ''}" style="background: ${c}" onclick="selectBrushColor('${c}')"></button>`
            ).join('');
        }

        window.selectBrushColor = function(color) {
            brushColor = color;
            document.querySelectorAll('.brush-color').forEach(el => {
                el.classList.toggle('selected', el.style.background === color);
            });
        };

        // Drawing canvas
        function setupDrawingCanvas() {
            const canvas = document.getElementById('drawingCanvas');
            drawingCtx = canvas.getContext('2d');
            drawingCtx.fillStyle = '#111';
            drawingCtx.fillRect(0, 0, canvas.width, canvas.height);
            drawingCtx.lineCap = 'round';
            drawingCtx.lineJoin = 'round';
            drawingCtx.lineWidth = 4;

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const offsetX = touch.clientX - rect.left;
                const offsetY = touch.clientY - rect.top;
                startDrawing({ offsetX, offsetY });
            }, { passive: false });

            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const offsetX = touch.clientX - rect.left;
                const offsetY = touch.clientY - rect.top;
                draw({ offsetX, offsetY });
            }, { passive: false });

            canvas.addEventListener('touchend', stopDrawing);
        }

        function getCanvasCoords(e) {
            const canvas = document.getElementById('drawingCanvas');
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: e.offsetX * scaleX,
                y: e.offsetY * scaleY
            };
        }

        function startDrawing(e) {
            isDrawing = true;
            const coords = getCanvasCoords(e);
            drawingCtx.beginPath();
            drawingCtx.moveTo(coords.x, coords.y);
        }

        function draw(e) {
            if (!isDrawing) return;
            const coords = getCanvasCoords(e);
            drawingCtx.strokeStyle = brushColor;
            drawingCtx.lineTo(coords.x, coords.y);
            drawingCtx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        window.clearCanvas = function() {
            const canvas = document.getElementById('drawingCanvas');
            drawingCtx.fillStyle = '#111';
            drawingCtx.fillRect(0, 0, canvas.width, canvas.height);
        };

        // Load messages
        async function loadMessages() {
            const { data, error } = await supabase
                .from('sloppygram_messages')
                .select('*')
                .order('created_at', { ascending: true })
                .limit(100);

            if (error) {
                console.error('Load error:', error);
                return;
            }

            const container = document.getElementById('messagesContainer');
            const emptyState = document.getElementById('emptyState');

            if (data.length === 0) {
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            data.forEach(msg => {
                seenMessageIds.add(msg.id);
                addMessageToUI(msg);
            });
            container.scrollTop = container.scrollHeight;
        }

        // Subscribe to new messages
        function subscribeToMessages() {
            if (realtimeChannel) {
                supabase.removeChannel(realtimeChannel);
            }

            realtimeChannel = supabase.channel('sloppygram-global', {
                config: {
                    broadcast: { self: false }
                }
            });

            realtimeChannel.on('broadcast', { event: 'new_message' }, (payload) => {
                const msg = payload.payload;
                if (!msg || seenMessageIds.has(msg.id)) return;
                seenMessageIds.add(msg.id);
                addMessageToUI(msg);
                scrollToBottom();
                addToFeed(msg.username, 'sent a message');
            });

            realtimeChannel.on('postgres_changes', {
                event: 'INSERT',
                schema: 'public',
                table: 'sloppygram_messages'
            }, (payload) => {
                if (seenMessageIds.has(payload.new.id)) return;
                seenMessageIds.add(payload.new.id);
                addMessageToUI(payload.new);
                scrollToBottom();
            });

            realtimeChannel.subscribe();
        }

        function broadcastMessage(msg) {
            if (realtimeChannel) {
                realtimeChannel.send({
                    type: 'broadcast',
                    event: 'new_message',
                    payload: msg
                });
            }
        }

        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }

        // Add message to UI
        function addMessageToUI(msg) {
            const container = document.getElementById('messagesContainer');
            document.getElementById('emptyState').style.display = 'none';

            const isOwn = msg.user_id === currentUser?.id;
            const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            const div = document.createElement('div');
            div.className = `message ${isOwn ? 'own' : ''}`;

            let contentHTML = '';
            if (msg.content) {
                contentHTML = `<div class="message-content">${escapeHtml(msg.content)}</div>`;
            }
            if (msg.image_data) {
                contentHTML += `<img class="message-image" src="${msg.image_data}" onclick="window.open(this.src)">`;
            }
            if (msg.drawing_data) {
                const msgId = msg.id;
                const isRealId = typeof msgId === 'number' || (typeof msgId === 'string' && !msgId.startsWith('temp_'));
                const voteCount = doodleVotes[msgId] || 0;
                const hasVoted = myDoodleVotes[msgId] || false;
                const votedClass = hasVoted ? 'voted' : '';
                // Only show vote button for messages with real database IDs
                const voteBtn = isRealId ? `
                    <button class="doodle-vote-btn ${votedClass}" onclick="toggleDoodleVote('${msgId}', this)" data-msg-id="${msgId}">
                        ‚≠ê <span class="vote-count">${voteCount}</span>
                    </button>` : '';
                contentHTML += `
                    <div class="doodle-wrapper">
                        <img class="message-drawing" src="${msg.drawing_data}">
                        ${voteBtn}
                    </div>`;
            }

            const avatarContent = msg.avatarUrl
                ? `<img src="${msg.avatarUrl}" alt="avatar" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`
                : (msg.avatar || 'üë§');
            div.innerHTML = `
                <div class="avatar">${avatarContent}</div>
                <div class="message-bubble">
                    <div class="message-header">
                        <span class="message-username">${escapeHtml(msg.username || 'Anonymous')}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    ${contentHTML}
                </div>
            `;

            container.appendChild(div);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Send message
        window.sendMessage = async function() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content && !selectedImage) return;

            const tempId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            const msg = {
                id: tempId,
                username: profile.username,
                avatar: profile.avatar,
                avatarUrl: profile.avatarUrl || null,
                content: content || null,
                image_data: selectedImage || null,
                drawing_data: null,
                message_type: selectedImage ? 'image' : 'text',
                user_id: currentUser?.id,
                created_at: new Date().toISOString()
            };

            input.value = '';
            input.style.height = 'auto';
            removeImage();

            seenMessageIds.add(tempId);
            addMessageToUI(msg);
            scrollToBottom();
            broadcastMessage(msg);
            addToFeed(profile.username, msg.image_data ? 'shared an image' : 'sent a message');

            const { data, error } = await supabase
                .from('sloppygram_messages')
                .insert({
                    username: msg.username,
                    avatar: msg.avatar,
                    content: msg.content,
                    image_data: msg.image_data,
                    drawing_data: msg.drawing_data,
                    message_type: msg.message_type,
                    user_id: msg.user_id
                })
                .select('id')
                .single();

            if (error) {
                console.error('Send error:', error);
                return;
            }

            if (data?.id) {
                seenMessageIds.add(data.id);
            }
        };

        // Send drawing
        window.sendDrawing = async function() {
            const canvas = document.getElementById('drawingCanvas');
            const drawingData = canvas.toDataURL('image/png');

            const tempId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            const msg = {
                id: tempId,
                username: profile.username,
                avatar: profile.avatar,
                avatarUrl: profile.avatarUrl || null,
                content: null,
                image_data: null,
                drawing_data: drawingData,
                message_type: 'drawing',
                user_id: currentUser?.id,
                created_at: new Date().toISOString()
            };

            closeDrawingModal();
            clearCanvas();

            seenMessageIds.add(tempId);
            addMessageToUI(msg);
            scrollToBottom();
            broadcastMessage(msg);
            addToFeed(profile.username, 'shared a drawing');

            const { data, error } = await supabase
                .from('sloppygram_messages')
                .insert({
                    username: msg.username,
                    avatar: msg.avatar,
                    content: msg.content,
                    image_data: msg.image_data,
                    drawing_data: msg.drawing_data,
                    message_type: msg.message_type,
                    user_id: msg.user_id
                })
                .select('id')
                .single();

            if (error) {
                console.error('Send error:', error);
            }

            if (data?.id) {
                seenMessageIds.add(data.id);
            }
        };

        // Image handling
        window.handleImageSelect = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 500000) {
                alert('FILE TOO LARGE. MAX 500KB.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                selectedImage = e.target.result;
                document.getElementById('previewImg').src = selectedImage;
                document.getElementById('imagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        };

        window.removeImage = function() {
            selectedImage = null;
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('imageInput').value = '';
        };

        // Profile modal
        let pendingAvatarData = null;
        let pendingBgData = null;

        window.openProfileModal = async function() {
            document.getElementById('usernameInput').value = profile.username;

            // Show current avatar preview if exists
            pendingAvatarData = profile.avatarUrl || null;
            if (pendingAvatarData) {
                document.getElementById('avatarPreviewImg').src = pendingAvatarData;
                document.getElementById('avatarPreview').style.display = 'block';
                document.getElementById('clearAvatarBtn').style.display = 'block';
            } else {
                document.getElementById('avatarPreview').style.display = 'none';
                document.getElementById('clearAvatarBtn').style.display = 'none';
            }

            // Show current bg preview if exists
            pendingBgData = profile.bgUrl || null;
            if (pendingBgData) {
                document.getElementById('bgPreviewImg').src = pendingBgData;
                document.getElementById('bgPreview').style.display = 'block';
                document.getElementById('clearBgBtn').style.display = 'block';
                document.getElementById('shareBgBtn').style.display = 'block';
            } else {
                document.getElementById('bgPreview').style.display = 'none';
                document.getElementById('clearBgBtn').style.display = 'none';
                document.getElementById('shareBgBtn').style.display = 'none';
            }

            setupAvatarGrid();
            setupColorOptions();
            await loadGlobalBackgrounds();
            document.getElementById('profileModal').classList.add('active');
        };

        window.closeProfileModal = function() {
            document.getElementById('profileModal').classList.remove('active');
            pendingAvatarData = null;
            pendingBgData = null;
        };

        window.handleAvatarUpload = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 500000) {
                alert('Image too large! Max 500KB.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                pendingAvatarData = e.target.result;
                document.getElementById('avatarPreviewImg').src = pendingAvatarData;
                document.getElementById('avatarPreview').style.display = 'block';
                document.getElementById('clearAvatarBtn').style.display = 'block';
            };
            reader.readAsDataURL(file);
        };

        window.clearAvatarUpload = function() {
            pendingAvatarData = null;
            document.getElementById('avatarFileInput').value = '';
            document.getElementById('avatarPreview').style.display = 'none';
            document.getElementById('clearAvatarBtn').style.display = 'none';
        };

        window.handleBgUpload = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 1000000) {
                alert('Image too large! Max 1MB for backgrounds.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                pendingBgData = e.target.result;
                document.getElementById('bgPreviewImg').src = pendingBgData;
                document.getElementById('bgPreview').style.display = 'block';
                document.getElementById('clearBgBtn').style.display = 'block';
                document.getElementById('shareBgBtn').style.display = 'block';
            };
            reader.readAsDataURL(file);
        };

        window.clearBgUpload = function() {
            pendingBgData = null;
            document.getElementById('bgFileInput').value = '';
            document.getElementById('bgPreview').style.display = 'none';
            document.getElementById('clearBgBtn').style.display = 'none';
            document.getElementById('shareBgBtn').style.display = 'none';
        };

        // Global Backgrounds
        async function loadGlobalBackgrounds() {
            const { data } = await supabase
                .from('sloppygram_global_backgrounds')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(20);

            globalBackgrounds = data || [];
            renderGlobalBackgrounds();
        }

        function renderGlobalBackgrounds() {
            const grid = document.getElementById('globalBgGrid');
            grid.innerHTML = globalBackgrounds.map(bg => `
                <div class="global-bg-item ${pendingBgData === bg.image_data ? 'selected' : ''}"
                     onclick="selectGlobalBg('${bg.id}')"
                     title="${bg.name || 'Shared by ' + bg.username}">
                    <img src="${bg.image_data}" alt="${bg.name || 'Background'}">
                </div>
            `).join('') + `
                <div class="global-bg-item global-bg-upload" onclick="document.getElementById('bgFileInput').click()" title="Upload new">+</div>
            `;
        }

        window.selectGlobalBg = function(bgId) {
            const bg = globalBackgrounds.find(b => b.id == bgId);
            if (!bg) return;

            pendingBgData = bg.image_data;
            document.getElementById('bgPreviewImg').src = pendingBgData;
            document.getElementById('bgPreview').style.display = 'block';
            document.getElementById('clearBgBtn').style.display = 'block';
            document.getElementById('shareBgBtn').style.display = 'none'; // Already shared

            renderGlobalBackgrounds();
        };

        window.shareBackground = async function() {
            if (!pendingBgData || !currentUser) return;

            const name = prompt('Give your background a name:', 'My Background');
            if (!name) return;

            const { error } = await supabase
                .from('sloppygram_global_backgrounds')
                .insert({
                    image_data: pendingBgData,
                    username: profile.username,
                    name: name,
                    user_id: currentUser.id
                });

            if (error) {
                console.error('Error sharing background:', error);
                alert('Failed to share background');
                return;
            }

            alert('Background shared with everyone!');
            document.getElementById('shareBgBtn').style.display = 'none';
            await loadGlobalBackgrounds();
        };

        window.saveProfile = function() {
            const username = document.getElementById('usernameInput').value.trim() || 'Anon' + Math.floor(Math.random() * 9999);
            profile.username = username;
            profile.avatarUrl = pendingAvatarData || '';
            profile.bgUrl = pendingBgData || '';
            localStorage.setItem('sloppygram_profile', JSON.stringify(profile));
            applyCustomBackground();
            closeProfileModal();
        };

        window.resetProfile = function() {
            if (!confirm('Reset all profile data? This cannot be undone.')) return;
            localStorage.removeItem('sloppygram_profile');
            profile = {
                username: 'Anon' + Math.floor(Math.random() * 9999),
                avatar: AVATARS[Math.floor(Math.random() * AVATARS.length)],
                color: COLORS[Math.floor(Math.random() * COLORS.length)],
                avatarUrl: '',
                bgUrl: ''
            };
            pendingAvatarData = null;
            pendingBgData = null;
            document.body.style.backgroundImage = '';
            closeProfileModal();
        };

        function applyCustomBackground() {
            if (profile.bgUrl) {
                document.body.style.backgroundImage = `url(${profile.bgUrl})`;
                document.body.style.backgroundSize = 'cover';
                document.body.style.backgroundPosition = 'center';
                document.body.style.backgroundAttachment = 'fixed';
            } else {
                document.body.style.backgroundImage = '';
            }
        }

        // Drawing modal
        window.openDrawingModal = function() {
            clearCanvas();
            document.getElementById('drawingModal').classList.add('active');
        };

        window.closeDrawingModal = function() {
            document.getElementById('drawingModal').classList.remove('active');
        };

        // === POSTS FUNCTIONALITY ===

        window.switchView = function(view) {
            currentView = view;
            document.querySelectorAll('.view-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.view === view);
            });
            document.getElementById('messagesContainer').classList.toggle('hidden', view !== 'chat');
            document.getElementById('postsContainer').classList.toggle('active', view === 'posts');
            document.getElementById('doodlesContainer').classList.toggle('active', view === 'doodles');
            document.querySelector('.input-area').style.display = view === 'chat' ? 'block' : 'none';
            document.getElementById('createPostBtn').classList.toggle('visible', view === 'posts');

            if (view === 'posts') {
                loadPosts();
            }
            if (view === 'doodles') {
                loadDoodleLeaderboard();
            }
        };

        async function loadPosts() {
            const { data, error } = await supabase
                .from('sloppygram_posts')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(50);

            if (error) {
                console.error('Error loading posts:', error);
                return;
            }

            posts = data || [];

            // Load likes for current user
            if (currentUser) {
                const { data: likesData } = await supabase
                    .from('sloppygram_post_likes')
                    .select('post_id')
                    .eq('user_id', currentUser.id);

                postLikes = {};
                (likesData || []).forEach(like => {
                    postLikes[like.post_id] = true;
                });
            }

            // Load comments for all posts
            const postIds = posts.map(p => p.id);
            if (postIds.length > 0) {
                const { data: commentsData } = await supabase
                    .from('sloppygram_post_comments')
                    .select('*')
                    .in('post_id', postIds)
                    .order('created_at', { ascending: true });

                postComments = {};
                (commentsData || []).forEach(comment => {
                    if (!postComments[comment.post_id]) {
                        postComments[comment.post_id] = [];
                    }
                    postComments[comment.post_id].push(comment);
                });

                // Load reactions for all posts
                const { data: reactionsData } = await supabase
                    .from('sloppygram_post_reactions')
                    .select('*')
                    .in('post_id', postIds);

                postReactions = {};
                myReactions = {};
                (reactionsData || []).forEach(r => {
                    if (!postReactions[r.post_id]) postReactions[r.post_id] = {};
                    postReactions[r.post_id][r.emoji] = (postReactions[r.post_id][r.emoji] || 0) + 1;

                    // Track my reactions
                    if (r.username === profile.username) {
                        if (!myReactions[r.post_id]) myReactions[r.post_id] = new Set();
                        myReactions[r.post_id].add(r.emoji);
                    }
                });

                // Load tags for all posts
                const { data: tagsData } = await supabase
                    .from('sloppygram_post_tags')
                    .select('*')
                    .in('post_id', postIds);

                postTags = {};
                (tagsData || []).forEach(t => {
                    if (!postTags[t.post_id]) postTags[t.post_id] = [];
                    postTags[t.post_id].push({ tag: t.tag, parent_tag: t.parent_tag });
                });
            }

            renderPosts();
        }

        function renderPosts() {
            const container = document.getElementById('postsContainer');
            const emptyState = document.getElementById('postsEmptyState');

            if (posts.length === 0) {
                emptyState.style.display = 'block';
                container.innerHTML = '';
                container.appendChild(emptyState);
                return;
            }

            emptyState.style.display = 'none';
            container.innerHTML = posts.map(post => renderPostCard(post)).join('');
        }

        function renderPostCard(post) {
            const time = new Date(post.created_at).toLocaleString();
            const liked = postLikes[post.id];
            const comments = postComments[post.id] || [];
            const likesCount = post.likes_count || 0;
            const reactions = postReactions[post.id] || {};
            const myPostReactions = myReactions[post.id] || new Set();

            const avatarContent = post.avatar_url
                ? `<img src="${post.avatar_url}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`
                : (post.avatar || 'üë§');

            const imageHtml = post.image_url
                ? `<img class="post-image" src="${post.image_url}" onerror="this.style.display='none'">`
                : (post.image_data ? `<img class="post-image" src="${post.image_data}">` : '');

            const commentsHtml = comments.map(c => `
                <div class="comment">
                    <span class="comment-avatar">${c.avatar || 'üë§'}</span>
                    <div class="comment-content">
                        <span class="comment-username">${escapeHtml(c.username)}</span>
                        <span class="comment-text">${escapeHtml(c.content)}</span>
                    </div>
                </div>
            `).join('');

            // Build reactions HTML
            const reactionsHtml = Object.entries(reactions)
                .sort((a, b) => b[1] - a[1])
                .map(([emoji, count]) => {
                    const isActive = myPostReactions.has(emoji);
                    return `<button class="reaction-btn ${isActive ? 'active' : ''}" onclick="toggleReaction(${post.id}, '${emoji}')">
                        ${emoji} <span class="reaction-count">${count}</span>
                    </button>`;
                }).join('');

            const reactionPickerHtml = REACTION_EMOJIS.map(emoji =>
                `<button onclick="toggleReaction(${post.id}, '${emoji}')">${emoji}</button>`
            ).join('');

            // Build tags HTML
            const tags = postTags[post.id] || [];
            const tagsHtml = tags.length > 0 ? `
                <div class="post-tags">
                    ${tags.map(t => {
                        const isNested = t.parent_tag != null;
                        const displayTag = isNested ? `${t.parent_tag}/${t.tag}` : t.tag;
                        return `<span class="tag ${isNested ? 'nested' : ''}" onclick="filterByTag('${escapeHtml(displayTag)}')">#${escapeHtml(displayTag)}</span>`;
                    }).join('')}
                </div>
            ` : '';

            return `
                <div class="post-card" data-post-id="${post.id}">
                    <div class="post-header">
                        <div class="post-avatar">${avatarContent}</div>
                        <span class="post-username">${escapeHtml(post.username || 'Anonymous')}</span>
                        <span class="post-time">${time}</span>
                    </div>
                    ${imageHtml}
                    ${post.caption ? `<div class="post-caption">${escapeHtml(post.caption)}</div>` : ''}
                    <div class="post-actions">
                        <button class="post-action-btn ${liked ? 'liked' : ''}" onclick="toggleLike(${post.id})">
                            ${liked ? '‚ù§Ô∏è' : 'ü§ç'} <span id="likes-${post.id}">${likesCount}</span>
                        </button>
                        <button class="post-action-btn" onclick="focusComment(${post.id})">
                            üí¨ ${comments.length}
                        </button>
                    </div>
                    <div class="post-reactions" id="reactions-${post.id}">
                        ${reactionsHtml}
                        <div style="position:relative;display:inline-block;">
                            <button class="add-reaction-btn" onclick="toggleReactionPicker(${post.id})">+ üòÄ</button>
                            <div class="reaction-picker" id="picker-${post.id}">
                                ${reactionPickerHtml}
                            </div>
                        </div>
                    </div>
                    ${tagsHtml}
                    <div class="post-comments" id="comments-${post.id}">
                        ${commentsHtml}
                    </div>
                    <div class="comment-input-row">
                        <input class="comment-input" id="comment-input-${post.id}" placeholder="Add a comment..." onkeydown="if(event.key==='Enter')addComment(${post.id})">
                        <button class="comment-send" onclick="addComment(${post.id})">POST</button>
                    </div>
                </div>
            `;
        }

        window.toggleLike = async function(postId) {
            if (!currentUser) return;

            const liked = postLikes[postId];

            if (liked) {
                // Unlike
                await supabase
                    .from('sloppygram_post_likes')
                    .delete()
                    .eq('post_id', postId)
                    .eq('user_id', currentUser.id);

                postLikes[postId] = false;

                // Update count
                const post = posts.find(p => p.id === postId);
                if (post) post.likes_count = Math.max(0, (post.likes_count || 0) - 1);
            } else {
                // Like
                await supabase
                    .from('sloppygram_post_likes')
                    .insert({
                        post_id: postId,
                        username: profile.username,
                        user_id: currentUser.id
                    });

                postLikes[postId] = true;

                // Update count
                const post = posts.find(p => p.id === postId);
                if (post) post.likes_count = (post.likes_count || 0) + 1;
            }

            renderPosts();
        };

        window.focusComment = function(postId) {
            document.getElementById(`comment-input-${postId}`).focus();
        };

        window.addComment = async function(postId) {
            const input = document.getElementById(`comment-input-${postId}`);
            const content = input.value.trim();
            if (!content || !currentUser) return;

            const comment = {
                post_id: postId,
                username: profile.username,
                avatar: profile.avatar,
                content: content,
                user_id: currentUser.id
            };

            const { error } = await supabase
                .from('sloppygram_post_comments')
                .insert(comment);

            if (error) {
                console.error('Error adding comment:', error);
                return;
            }

            if (!postComments[postId]) postComments[postId] = [];
            postComments[postId].push({ ...comment, created_at: new Date().toISOString() });

            input.value = '';
            renderPosts();
        };

        // Emoji Reactions
        window.toggleReactionPicker = function(postId) {
            const picker = document.getElementById(`picker-${postId}`);
            // Close all other pickers
            document.querySelectorAll('.reaction-picker.active').forEach(p => {
                if (p.id !== `picker-${postId}`) p.classList.remove('active');
            });
            picker.classList.toggle('active');
        };

        window.toggleReaction = async function(postId, emoji) {
            if (!currentUser) return;

            // Close picker
            const picker = document.getElementById(`picker-${postId}`);
            if (picker) picker.classList.remove('active');

            const hasReaction = myReactions[postId]?.has(emoji);

            if (hasReaction) {
                // Remove reaction
                await supabase
                    .from('sloppygram_post_reactions')
                    .delete()
                    .eq('post_id', postId)
                    .eq('emoji', emoji)
                    .eq('user_id', currentUser.id);

                myReactions[postId]?.delete(emoji);
                if (postReactions[postId]?.[emoji]) {
                    postReactions[postId][emoji]--;
                    if (postReactions[postId][emoji] <= 0) delete postReactions[postId][emoji];
                }
            } else {
                // Add reaction
                await supabase
                    .from('sloppygram_post_reactions')
                    .insert({
                        post_id: postId,
                        emoji: emoji,
                        username: profile.username,
                        user_id: currentUser.id
                    });

                if (!myReactions[postId]) myReactions[postId] = new Set();
                myReactions[postId].add(emoji);
                if (!postReactions[postId]) postReactions[postId] = {};
                postReactions[postId][emoji] = (postReactions[postId][emoji] || 0) + 1;
            }

            renderPosts();
        };

        // Close reaction pickers when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.add-reaction-btn') && !e.target.closest('.reaction-picker')) {
                document.querySelectorAll('.reaction-picker.active').forEach(p => p.classList.remove('active'));
            }
        });

        // Post Modal
        window.openPostModal = function() {
            postImageData = null;
            document.getElementById('postImageUrl').value = '';
            document.getElementById('postCaption').value = '';
            document.getElementById('postFileInput').value = '';
            document.getElementById('postPreview').innerHTML = '<span>No image selected</span>';
            document.getElementById('postPreview').classList.remove('has-image');
            document.getElementById('postModal').classList.add('active');
        };

        window.closePostModal = function() {
            document.getElementById('postModal').classList.remove('active');
        };

        window.previewPostImage = function() {
            const url = document.getElementById('postImageUrl').value.trim();
            const preview = document.getElementById('postPreview');

            if (url) {
                preview.innerHTML = `<img src="${url}" onerror="this.parentElement.innerHTML='<span>Failed to load image</span>'">`;
                preview.classList.add('has-image');
                postImageData = null;
            } else if (!postImageData) {
                preview.innerHTML = '<span>No image selected</span>';
                preview.classList.remove('has-image');
            }
        };

        window.handlePostFileSelect = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 500000) {
                alert('Image too large! Max 500KB');
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                postImageData = e.target.result;
                const preview = document.getElementById('postPreview');
                preview.innerHTML = `<img src="${postImageData}">`;
                preview.classList.add('has-image');
                document.getElementById('postImageUrl').value = '';
            };
            reader.readAsDataURL(file);
        };

        window.submitPost = async function() {
            const imageUrl = document.getElementById('postImageUrl').value.trim();
            const caption = document.getElementById('postCaption').value.trim();

            if (!imageUrl && !postImageData && !caption) {
                alert('Add an image or caption!');
                return;
            }

            const post = {
                username: profile.username,
                avatar: profile.avatar,
                avatar_url: profile.avatarUrl || null,
                caption: caption || null,
                image_url: imageUrl || null,
                image_data: postImageData || null,
                likes_count: 0,
                user_id: currentUser.id
            };

            const { data: insertedPost, error } = await supabase
                .from('sloppygram_posts')
                .insert(post)
                .select()
                .single();

            if (error) {
                console.error('Error creating post:', error);
                alert('Failed to create post: ' + error.message);
                return;
            }

            if (!insertedPost) {
                console.error('Post insert returned no data');
                alert('Post created but could not retrieve ID for tags');
            }

            // Save tags if any
            if (pendingTags.length > 0 && insertedPost) {
                const tagInserts = pendingTags.map(t => ({
                    post_id: insertedPost.id,
                    tag: t.tag,
                    parent_tag: t.parent_tag || null,
                    user_id: currentUser.id
                }));
                const { error: tagError } = await supabase.from('sloppygram_post_tags').insert(tagInserts);
                if (tagError) {
                    console.error('Error saving tags:', tagError);
                }
            }

            closePostModal();
            addToFeed(profile.username, 'created a new post');

            // Clear any active tag filter so new post is visible
            activeTagFilter = null;
            document.getElementById('tagFilterBar').classList.remove('active');

            loadPosts();
        };

        // === TAG HANDLING FUNCTIONALITY ===

        window.handleTagInput = function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = document.getElementById('tagInput');
                const value = input.value.trim();
                if (!value) return;

                // Parse nested tag (e.g., "meme/cursed" -> parent_tag: "meme", tag: "cursed")
                let tag, parent_tag = null;
                if (value.includes('/')) {
                    const parts = value.split('/');
                    parent_tag = parts[0].trim();
                    tag = parts.slice(1).join('/').trim();
                } else {
                    tag = value;
                }

                // Don't add duplicates
                const exists = pendingTags.some(t => t.tag === tag && t.parent_tag === parent_tag);
                if (!exists) {
                    pendingTags.push({ tag, parent_tag });
                    renderPendingTags();
                }

                input.value = '';
            }
        };

        function renderPendingTags() {
            const container = document.getElementById('tagInputContainer');
            const input = document.getElementById('tagInput');

            // Remove existing tag chips
            container.querySelectorAll('.tag-chip').forEach(el => el.remove());

            // Add tag chips
            pendingTags.forEach((t, idx) => {
                const displayTag = t.parent_tag ? `${t.parent_tag}/${t.tag}` : t.tag;
                const chip = document.createElement('span');
                chip.className = `tag-chip ${t.parent_tag ? 'nested' : ''}`;
                chip.innerHTML = `#${escapeHtml(displayTag)} <button onclick="removePendingTag(${idx})">√ó</button>`;
                container.insertBefore(chip, input);
            });
        }

        window.removePendingTag = function(idx) {
            pendingTags.splice(idx, 1);
            renderPendingTags();
        };

        window.filterByTag = function(tagStr) {
            activeTagFilter = tagStr;
            document.getElementById('tagFilterBar').classList.add('active');
            document.getElementById('activeFilterTag').textContent = '#' + tagStr;

            // Filter posts by tag
            renderFilteredPosts();
        };

        window.clearTagFilter = function() {
            activeTagFilter = null;
            document.getElementById('tagFilterBar').classList.remove('active');
            renderPosts();
        };

        function renderFilteredPosts() {
            if (!activeTagFilter) {
                renderPosts();
                return;
            }

            const container = document.getElementById('postsContainer');
            const emptyState = document.getElementById('postsEmptyState');

            // Filter posts that have the matching tag
            const filteredPosts = posts.filter(post => {
                const tags = postTags[post.id] || [];
                return tags.some(t => {
                    const fullTag = t.parent_tag ? `${t.parent_tag}/${t.tag}` : t.tag;
                    return fullTag === activeTagFilter ||
                           t.tag === activeTagFilter ||
                           t.parent_tag === activeTagFilter;
                });
            });

            if (filteredPosts.length === 0) {
                emptyState.style.display = 'block';
                emptyState.innerHTML = `<p>No posts with tag #${escapeHtml(activeTagFilter)}</p>`;
                container.innerHTML = '';
                container.appendChild(emptyState);
                return;
            }

            emptyState.style.display = 'none';
            container.innerHTML = filteredPosts.map(post => renderPostCard(post)).join('');
        }

        // Reset pending tags when opening post modal
        const originalOpenPostModal = window.openPostModal;
        window.openPostModal = function() {
            pendingTags = [];
            renderPendingTags();
            if (originalOpenPostModal) originalOpenPostModal();
            else document.getElementById('postModal').classList.add('active');
        };

        // Load and display trending tags
        async function loadTrendingTags() {
            const { data: tagsData } = await supabase
                .from('sloppygram_post_tags')
                .select('tag, parent_tag');

            if (!tagsData || tagsData.length === 0) {
                document.getElementById('trendingTagsList').innerHTML = `
                    <div style="font-size:0.85rem;color:var(--text-dim)">No tags yet</div>
                `;
                return;
            }

            // Count tag occurrences
            const tagCounts = {};
            tagsData.forEach(t => {
                const fullTag = t.parent_tag ? `${t.parent_tag}/${t.tag}` : t.tag;
                tagCounts[fullTag] = (tagCounts[fullTag] || 0) + 1;
            });

            // Sort by count and take top 10
            const topTags = Object.entries(tagCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const container = document.getElementById('trendingTagsList');
            container.innerHTML = topTags.map(([tag, count], idx) => {
                const isNested = tag.includes('/');
                const rankClass = idx === 0 ? 'hot' : idx < 3 ? 'warm' : '';
                return `
                    <div class="trending-tag ${rankClass}" onclick="filterByTag('${escapeHtml(tag)}')">
                        <span class="tag ${isNested ? 'nested' : ''}">#${escapeHtml(tag)}</span>
                        <span class="tag-count">${count}</span>
                    </div>
                `;
            }).join('');
        }

        // Call loadTrendingTags when switching to posts view
        const originalSwitchView = switchView;
        switchView = function(view) {
            originalSwitchView(view);
            if (view === 'posts') {
                loadTrendingTags();
            }
        };

        // === DOODLE LEADERBOARD FUNCTIONALITY ===

        async function loadDoodleVotes() {
            // Get all vote counts
            const { data: messages } = await supabase
                .from('sloppygram_messages')
                .select('id')
                .not('drawing_data', 'is', null);

            if (!messages) return;

            const messageIds = messages.map(m => m.id);
            if (messageIds.length === 0) return;

            const { data: votes } = await supabase
                .from('sloppygram_doodle_votes')
                .select('message_id, voter_username');

            if (votes) {
                // Count votes per message
                doodleVotes = {};
                votes.forEach(v => {
                    doodleVotes[v.message_id] = (doodleVotes[v.message_id] || 0) + 1;
                });

                // Track my votes
                myDoodleVotes = {};
                votes.filter(v => v.voter_username === profile.username).forEach(v => {
                    myDoodleVotes[v.message_id] = true;
                });
            }
        }

        window.toggleDoodleVote = async function(messageId, btn) {
            if (!currentUser) return;

            const hasVoted = myDoodleVotes[messageId];

            if (hasVoted) {
                // Remove vote
                await supabase
                    .from('sloppygram_doodle_votes')
                    .delete()
                    .eq('message_id', messageId)
                    .eq('user_id', currentUser.id);

                myDoodleVotes[messageId] = false;
                doodleVotes[messageId] = Math.max(0, (doodleVotes[messageId] || 1) - 1);
            } else {
                // Add vote
                await supabase
                    .from('sloppygram_doodle_votes')
                    .insert({
                        message_id: messageId,
                        voter_username: profile.username,
                        user_id: currentUser.id
                    });

                myDoodleVotes[messageId] = true;
                doodleVotes[messageId] = (doodleVotes[messageId] || 0) + 1;
            }

            // Update button UI
            btn.classList.toggle('voted', myDoodleVotes[messageId]);
            btn.querySelector('.vote-count').textContent = doodleVotes[messageId] || 0;

            // Update all buttons with same message ID
            document.querySelectorAll(`[data-msg-id="${messageId}"]`).forEach(b => {
                b.classList.toggle('voted', myDoodleVotes[messageId]);
                b.querySelector('.vote-count').textContent = doodleVotes[messageId] || 0;
            });
        };

        async function loadDoodleLeaderboard() {
            const container = document.getElementById('doodlesContainer');
            const emptyState = document.getElementById('doodlesEmptyState');

            // Get all doodles with their vote counts
            const { data: doodles, error } = await supabase
                .from('sloppygram_messages')
                .select('*')
                .not('drawing_data', 'is', null)
                .order('created_at', { ascending: false });

            if (error || !doodles || doodles.length === 0) {
                emptyState.style.display = 'block';
                return;
            }

            // Get vote counts
            const { data: votes } = await supabase
                .from('sloppygram_doodle_votes')
                .select('message_id');

            // Count votes
            const voteCounts = {};
            if (votes) {
                votes.forEach(v => {
                    voteCounts[v.message_id] = (voteCounts[v.message_id] || 0) + 1;
                });
            }

            // Sort by votes (descending), then by date
            const sortedDoodles = doodles
                .map(d => ({ ...d, votes: voteCounts[d.id] || 0 }))
                .sort((a, b) => b.votes - a.votes || new Date(b.created_at) - new Date(a.created_at));

            // Render leaderboard
            container.innerHTML = '<div class="leaderboard-header">üèÜ LEGENDARY DOODLES üèÜ</div>';

            if (sortedDoodles.length === 0) {
                container.innerHTML += `<div class="empty-doodles" id="doodlesEmptyState">
                    <div class="icon">üé®</div>
                    <p>NO LEGENDARY DOODLES YET...</p>
                    <p>Draw something and get votes!</p>
                </div>`;
                return;
            }

            // Create grid container
            const grid = document.createElement('div');
            grid.className = 'doodle-grid';

            sortedDoodles.forEach((doodle, index) => {
                const rank = index + 1;
                let rankClass = '';
                if (rank === 1) rankClass = 'gold';
                else if (rank === 2) rankClass = 'silver';
                else if (rank === 3) rankClass = 'bronze';

                const time = new Date(doodle.created_at).toLocaleDateString();
                const hasVoted = myDoodleVotes[doodle.id] || false;
                const isTop3 = rank <= 3;

                const card = document.createElement('div');
                card.className = `doodle-card${isTop3 ? ' top-3' : ''}`;
                card.innerHTML = `
                    <div class="doodle-rank">
                        <span class="rank-badge ${rankClass}">${rank}</span>
                        <span class="doodle-artist">${escapeHtml(doodle.username || 'Anonymous')}</span>
                        <span class="doodle-votes">‚≠ê ${doodle.votes}</span>
                    </div>
                    <div class="doodle-thumbnail">
                        <img src="${doodle.drawing_data}" onclick="window.open(this.src)">
                    </div>
                    <div class="doodle-card-actions">
                        <span class="doodle-time">${time}</span>
                        <button class="doodle-vote-btn ${hasVoted ? 'voted' : ''}" onclick="toggleDoodleVote('${doodle.id}', this)" data-msg-id="${doodle.id}">
                            ‚≠ê <span class="vote-count">${doodle.votes}</span>
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });

            container.appendChild(grid);
        }

        // Mobile sidebar toggle
        window.toggleSidebar = function(side) {
            const sidebar = side === 'left' ? document.getElementById('sidebarLeft') : document.getElementById('sidebarRight');
            sidebar.classList.toggle('mobile-show');
        };

        // Initialize
        init();
    </script>
</body>
</html>
