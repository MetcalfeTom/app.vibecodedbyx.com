<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mouse Mood Reader</title>
  <meta name="description" content="We guess your mood from how you move the mouse." />
  <link rel="icon" href="https://emojicdn.elk.sh/üñ±Ô∏è" />

  <meta property="og:type" content="website" />
  <meta property="og:title" content="Mouse Mood Reader" />
  <meta property="og:description" content="Move your mouse. We guess your mood live." />
  <meta property="og:url" content="https://app.vibecodedbyx.com/mouse-mood" />
  <meta property="og:image" content="https://app.vibecodedbyx.com/mouse-mood/og.png" />

  <style>
    :root{
      --bg:#0c1017; --panel:#0f1722; --muted:#223044; --text:#e6edf3; --sub:#98a7ba;
      --good:#7bd389; --warn:#ffd166; --bad:#ff6b6b; --acc:#8ab4ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(120% 120% at 50% 0%, #0f1a2b, #0b0f16);color:var(--text);font:500 15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--muted);background:rgba(10,16,25,.7);backdrop-filter:blur(6px)}
    header a{color:var(--sub);text-decoration:none}
    header a:hover{color:var(--text)}
    main{max-width:1100px;margin:0 auto;padding:14px;display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
    @media (max-width: 900px){main{grid-template-columns:1fr}}
    .card{background:var(--panel);border:1px solid var(--muted);border-radius:14px;overflow:hidden}
    .pad{padding:14px}
    .title{font-weight:800;letter-spacing:.2px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{border:1px solid var(--muted);background:#122034;color:var(--text);border-radius:10px;padding:10px 12px;cursor:pointer}
    .btn.primary{background:var(--good);color:#0b0f14;border-color:#54b46a}
    .btn.ghost{background:transparent}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:var(--sub)}
    .error{background:#2a1320;border:1px solid #6b283f;color:#ffd6e0;border-radius:10px;padding:8px 10px;margin:8px 0;display:none}

    .arena{position:relative;height:60vh;min-height:360px;cursor:crosshair}
    .arena .hint{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:var(--sub);pointer-events:none}
    canvas{display:block;width:100%;height:100%}

    .mood{display:flex;align-items:center;gap:10px}
    .mood .emoji{font-size:42px}
    .mood .name{font-size:24px;font-weight:900;letter-spacing:.3px}
    .conf{font-weight:700}

    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .metric{background:#0e1a2a;border:1px solid #1a2740;border-radius:12px;padding:10px}
    .metric h4{margin:0 0 6px 0;font-size:12px;color:var(--sub);font-weight:700;letter-spacing:.2px}
    .metric .val{font-weight:800}

    .footer{padding:10px 14px;border-top:1px solid var(--muted);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .footer small{color:var(--sub)}
    .backlink a{color:var(--acc);text-decoration:none}

    .feedback{display:grid;gap:8px}
    .feedback select,.feedback input{background:#0e151d;color:var(--text);border:1px solid var(--muted);border-radius:10px;padding:10px 12px}
  </style>
</head>
<body>
  <header>
    <div class="title">üñ±Ô∏è Mouse Mood Reader</div>
    <nav><a href="https://www.vibecodedbyx.com" target="_blank" rel="noopener">Back to Livestream</a> | <a href="https://app.vibecodedbyx.com/overview" style="color:#4ecdc4;text-decoration:none">üé® View All Apps</a></nav>
  </header>

  <main>
    <section class="card">
      <div class="pad">
        <div class="row" style="justify-content:space-between">
          <div class="mood"><div id="moodEmoji" class="emoji">üôÇ</div><div class="name" id="moodName">Calibrating‚Ä¶</div></div>
          <div>Confidence: <span id="confidence" class="conf">0%</span></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="startBtn" class="btn primary">Start</button>
          <button id="stopBtn" class="btn">Stop</button>
          <button id="clearBtn" class="btn ghost">Reset</button>
          <button id="shareBtn" class="btn ghost">Share</button>
        </div>
        <div id="err" class="error"></div>
      </div>
      <div class="arena" id="arena">
        <canvas id="cnv"></canvas>
        <div class="hint">Move your mouse (or finger) around here</div>
      </div>
      <div class="footer">
        <small id="status">Idle. Click Start, then move around for ~5s.</small>
        <div class="backlink"><a href="https://www.vibecodedbyx.com" target="_blank" rel="noopener">‚Üê VibeCodedByX</a></div>
      </div>
    </section>

    <aside class="card">
      <div class="pad">
        <div class="title" style="margin-bottom:8px">Live Features</div>
        <div class="grid">
          <div class="metric"><h4>Avg speed (px/s)</h4><div class="val" id="m_speed">0</div></div>
          <div class="metric"><h4>Speed variance</h4><div class="val" id="m_svar">0</div></div>
          <div class="metric"><h4>Direction changes/s</h4><div class="val" id="m_turns">0</div></div>
          <div class="metric"><h4>Straightness</h4><div class="val" id="m_straight">0.00</div></div>
          <div class="metric"><h4>Idle ratio</h4><div class="val" id="m_idle">0%</div></div>
          <div class="metric"><h4>Accel variance</h4><div class="val" id="m_avar">0</div></div>
        </div>

        <hr style="border:0;border-top:1px solid var(--muted);margin:12px 0" />
        <div class="title" style="margin-bottom:6px">Feedback (optional)</div>
        <div class="feedback">
          <select id="trueMood">
            <option value="">I actually feel‚Ä¶</option>
            <option>Calm</option>
            <option>Focused</option>
            <option>Energetic</option>
            <option>Anxious</option>
            <option>Bored</option>
            <option>Confident</option>
          </select>
          <button id="saveFb" class="btn">Submit Feedback</button>
          <div id="saveMsg" class="muted"></div>
        </div>
        <div id="premium-content" style="display:none"></div>
        <button id="upgrade-button" style="display:none"></button>
      </div>
    </aside>
  </main>

  <script type="module">
    import supabase, { supabaseSession } from './supabase-config.js';

    // Canvas setup
    const cnv = document.getElementById('cnv');
    const ctx = cnv.getContext('2d');
    const arena = document.getElementById('arena');
    let W=0,H=0,dpr=Math.max(1, window.devicePixelRatio||1);
    function resize(){ W = arena.clientWidth|0; H = arena.clientHeight|0; cnv.width=W*dpr; cnv.height=H*dpr; ctx.setTransform(dpr,0,0,dpr,0,0); drawBg(); }
    addEventListener('resize', resize); resize();

    function drawBg(){ ctx.clearRect(0,0,W,H); ctx.fillStyle='#0a1524'; ctx.fillRect(0,0,W,H); ctx.strokeStyle='#1c2c46'; for(let i=0;i<8;i++){ ctx.globalAlpha=0.06; ctx.beginPath(); ctx.arc(W/2,H/2,(i+1)*40,0,Math.PI*2); ctx.stroke(); } ctx.globalAlpha=1; }

    // Tracking window
    const WINDOW_MS = 5000; // last 5s
    const MIN_MOVE = 1.5;   // px threshold to count as movement
    const samples = [];     // {t,x,y}
    const speeds = [];      // instantaneous px/s
    const accels = [];      // dv/dt
    let turns = 0;          // direction changes in window
    let lastAngle = null;   // radians
    let lastMoveT = 0;
    let running = false;
    let anim = null;

    const ui = {
      moodName: document.getElementById('moodName'),
      moodEmoji: document.getElementById('moodEmoji'),
      conf: document.getElementById('confidence'),
      m_speed: document.getElementById('m_speed'),
      m_svar: document.getElementById('m_svar'),
      m_turns: document.getElementById('m_turns'),
      m_straight: document.getElementById('m_straight'),
      m_idle: document.getElementById('m_idle'),
      m_avar: document.getElementById('m_avar'),
      status: document.getElementById('status'),
      err: document.getElementById('err'),
      shareBtn: document.getElementById('shareBtn'),
      saveFb: document.getElementById('saveFb'),
      trueMood: document.getElementById('trueMood'),
      saveMsg: document.getElementById('saveMsg'),
    };

    // Pointer capture
    arena.addEventListener('pointerdown', (e)=>{ if (!running) return; arena.setPointerCapture(e.pointerId); addPoint(e); });
    arena.addEventListener('pointermove', (e)=>{ if (!running) return; addPoint(e); });
    arena.addEventListener('pointerup', ()=>{ /* no-op */ });

    function addPoint(e){
      const rect = arena.getBoundingClientRect();
      const x = e.clientX - rect.left; const y = e.clientY - rect.top; const t = performance.now();
      const prev = samples.length ? samples[samples.length-1] : null;
      samples.push({t,x,y});
      lastMoveT = t;

      // drop old
      const cutoff = t - WINDOW_MS; while (samples.length && samples[0].t < cutoff) samples.shift();

      // speed + angle
      if (prev){
        const dx = x - prev.x, dy = y - prev.y; const dist = Math.hypot(dx,dy); const dt = Math.max(1, t - prev.t)/1000;
        const v = dist / dt; speeds.push({t, v});
        const cutoffS = cutoff; while (speeds.length && speeds[0].t < cutoffS) speeds.shift();

        if (dist > MIN_MOVE){
          const ang = Math.atan2(dy, dx);
          if (lastAngle !== null){ const d = angleDelta(ang, lastAngle); if (Math.abs(d) > (Math.PI/3)) turns++; }
          lastAngle = ang;
        }

        // accel
        if (speeds.length >= 2){ const dv = speeds[speeds.length-1].v - speeds[speeds.length-2].v; const dt2 = Math.max(1, (speeds[speeds.length-1].t - speeds[speeds.length-2].t))/1000; accels.push({t, a: dv/dt2}); while (accels.length && accels[0].t < cutoffS) accels.shift(); }
      }

      // draw trail
      drawTrail();
    }

    function angleDelta(a,b){ let d=a-b; while(d>Math.PI)d-=Math.PI*2; while(d<-Math.PI)d+=Math.PI*2; return d; }

    function drawTrail(){
      drawBg();
      if (samples.length < 2) return;
      ctx.lineWidth = 2; ctx.lineCap='round';
      for (let i=1;i<samples.length;i++){
        const s0 = samples[i-1], s1 = samples[i];
        const age = (performance.now() - s1.t)/WINDOW_MS; const alpha = Math.max(0, 1 - age);
        ctx.strokeStyle = `rgba(138,180,255,${0.15 + alpha*0.6})`;
        ctx.beginPath(); ctx.moveTo(s0.x, s0.y); ctx.lineTo(s1.x, s1.y); ctx.stroke();
      }
    }

    function stats(){
      // basic features
      const t = performance.now(); const cutoff = t - WINDOW_MS;
      const pts = samples.slice(); if (pts.length < 2) return null;
      let totalDist=0; for (let i=1;i<pts.length;i++){ totalDist += Math.hypot(pts[i].x-pts[i-1].x, pts[i].y-pts[i-1].y); }
      const V = speeds.map(s=>s.v);
      const avgSpeed = V.length ? mean(V) : 0;
      const varSpeed = V.length ? variance(V) : 0;
      const A = accels.map(a=>a.a);
      const varAccel = A.length ? variance(A) : 0;

      const netDx = pts[pts.length-1].x - pts[0].x; const netDy = pts[pts.length-1].y - pts[0].y;
      const net = Math.hypot(netDx, netDy);
      const straightness = totalDist > 1 ? Math.min(1, net / totalDist) : 0; // 0..1

      // turns per second over window (decayed)
      const moves = speeds.length; const duration = Math.max(0.5, (pts[pts.length-1].t - pts[0].t)/1000);
      const turnRate = turns / duration;
      // idle ratio: proportion of time without movement
      let idleTime = 0; for (let i=1;i<pts.length;i++){ const d = Math.hypot(pts[i].x-pts[i-1].x, pts[i].y-pts[i-1].y); if (d < MIN_MOVE) idleTime += (pts[i].t - pts[i-1].t); }
      const idleRatio = Math.min(1, idleTime / (WINDOW_MS));

      // decay old turns
      if (pts[0].t > cutoff) { turns *= 0.98; }

      return { avgSpeed, varSpeed, varAccel, straightness, turnRate, idleRatio };
    }

    function mean(a){ let s=0; for (const x of a) s+=x; return s/a.length; }
    function variance(a){ const m=mean(a); let s=0; for (const x of a) s+=(x-m)*(x-m); return s/a.length; }

    function guessMood(feat){
      const { avgSpeed:v, varSpeed:vv, varAccel:va, straightness:st, turnRate:tr, idleRatio:ir } = feat;
      const norm = (x,a,b)=> Math.max(0, Math.min(1, (x-a)/(b-a)));
      const S = {
        slow: 1 - norm(v, 150, 900),
        fast: norm(v, 300, 1400),
        jitter: norm(Math.sqrt(vv+va*40), 50, 800),
        straight: st,
        loopy: norm(tr, 0.3, 2.5),
        idle: ir,
        active: 1 - ir
      };
      // Scores per mood (heuristic blend)
      const scores = [
        { name:'Calm',      emoji:'üôÇ', s: 0.6*S.slow + 0.2*S.straight + 0.2*(1-S.jitter) + 0.2*S.idle },
        { name:'Focused',   emoji:'üß†', s: 0.3*S.active + 0.4*S.straight + 0.2*(1-S.jitter) + 0.1*(1-S.loopy) },
        { name:'Energetic', emoji:'‚ö°Ô∏è', s: 0.5*S.fast + 0.2*S.active + 0.2*S.loopy + 0.1*S.jitter },
        { name:'Anxious',   emoji:'üòµ‚Äçüí´', s: 0.45*S.jitter + 0.25*S.loopy + 0.2*S.fast + 0.1*(1-S.straight) },
        { name:'Bored',     emoji:'ü•±', s: 0.6*S.idle + 0.3*S.slow + 0.1*(1-S.loopy) },
        { name:'Confident', emoji:'üòé', s: 0.4*S.fast + 0.35*S.straight + 0.15*(1-S.jitter) + 0.1*S.active },
      ];
      // normalize
      const max = Math.max(...scores.map(o=>o.s));
      let conf = Math.min(100, Math.round(max*100));
      // use spread to add confidence gap
      const sorted = scores.sort((a,b)=>b.s-a.s);
      const gap = sorted[0].s - sorted[1].s;
      conf = Math.max(5, Math.min(99, Math.round((sorted[0].s/(sorted[0].s+sorted[1].s))*100)));
      return { mood: sorted[0].name, emoji: sorted[0].emoji, confidence: conf, scores: sorted };
    }

    function updateUI(feat, res){
      if (!feat) return;
      ui.m_speed.textContent = Math.round(feat.avgSpeed);
      ui.m_svar.textContent = Math.round(feat.varSpeed);
      ui.m_turns.textContent = (feat.turnRate).toFixed(2);
      ui.m_straight.textContent = feat.straightness.toFixed(2);
      ui.m_idle.textContent = Math.round(feat.idleRatio*100)+'%';
      ui.m_avar.textContent = Math.round(feat.varAccel);
      if (res){ ui.moodName.textContent = res.mood; ui.moodEmoji.textContent = res.emoji; ui.conf.textContent = res.confidence+'%'; }
    }

    function loop(){
      if (!running) return;
      const feat = stats();
      if (feat){ const res = guessMood(feat); updateUI(feat, res); }
      anim = requestAnimationFrame(loop);
    }

    // Controls
    document.getElementById('startBtn').onclick = ()=>{ running = true; ui.status.textContent='Tracking‚Ä¶ move for ~5s'; ui.err.style.display='none'; loop(); };
    document.getElementById('stopBtn').onclick = ()=>{ running = false; if (anim) cancelAnimationFrame(anim); ui.status.textContent='Stopped.' };
    document.getElementById('clearBtn').onclick = ()=>{ samples.length=0; speeds.length=0; accels.length=0; turns=0; lastAngle=null; drawBg(); ui.status.textContent='Reset. Start again.' };
    ui.shareBtn.onclick = ()=>{
      const mood = ui.moodName.textContent || 'Unknown';
      const url = encodeURIComponent('https://app.vibecodedbyx.com/mouse-mood');
      const text = encodeURIComponent(`My mouse feels ${mood} on Mouse Mood Reader!`);
      window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`,'_blank');
    };

    // Feedback saving
    let currentUser = null; initAuth();
    async function initAuth(){
      try{ const { user } = await supabaseSession(); currentUser = user; }catch(e){ console.warn('Auth failed', e.message); }
    }
    ui.saveFb.onclick = async ()=>{
      try{
        const feat = stats(); if (!feat) throw new Error('No movement yet. Move around first.');
        const mood = document.getElementById('moodName').textContent;
        const trueMood = ui.trueMood.value || null;
        const payload = { mood_guess: mood, mood_user: trueMood, features: feat, user_id: currentUser?.id };
        const { error } = await supabase.from('mouse_mood_feedback').insert([payload]);
        if (error) throw error;
        ui.saveMsg.textContent = 'Thanks! Feedback saved.';
      } catch(e){ ui.saveMsg.textContent = 'Save failed: '+ e.message; }
    };
  </script>
</body>
</html>

