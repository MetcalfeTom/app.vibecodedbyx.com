<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Purple Pixel Scanner</title>
  <link rel="icon" href="https://emojicdn.elk.sh/üîÆ">
  <meta property="og:title" content="Purple Pixel Scanner">
  <meta property="og:description" content="Scan images for purple pixels and get coordinates">
  <meta property="og:image" content="https://sloppy.live/purple-scanner/og-image.png">
  <meta property="og:url" content="https://sloppy.live/purple-scanner">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --purple: #b400ff;
      --purple-dim: #6a0099;
      --cyan: #0ff;
      --bg: #0a0a0f;
      --glow: 0 0 10px #b400ff, 0 0 20px #b400ff, 0 0 40px #6a0099;
    }

    body {
      background: var(--bg);
      min-height: 100vh;
      font-family: 'Orbitron', sans-serif;
      color: var(--purple);
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      font-size: 2em;
      text-shadow: var(--glow);
      margin-bottom: 10px;
      letter-spacing: 3px;
    }

    .subtitle {
      text-align: center;
      color: var(--purple-dim);
      font-size: 0.9em;
      margin-bottom: 30px;
    }

    .upload-zone {
      border: 3px dashed var(--purple);
      border-radius: 15px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 20px;
      background: rgba(180, 0, 255, 0.05);
    }

    .upload-zone:hover, .upload-zone.dragover {
      border-color: var(--cyan);
      background: rgba(0, 255, 255, 0.1);
      box-shadow: 0 0 30px rgba(180, 0, 255, 0.3);
    }

    .upload-zone p {
      font-size: 1.2em;
      margin-bottom: 10px;
    }

    .upload-zone .icon {
      font-size: 3em;
      margin-bottom: 10px;
    }

    input[type="file"] {
      display: none;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
      padding: 20px;
      background: rgba(180, 0, 255, 0.1);
      border-radius: 10px;
      border: 1px solid var(--purple-dim);
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .control-group label {
      font-size: 0.8em;
      color: var(--cyan);
    }

    .control-group input[type="range"] {
      width: 100%;
      accent-color: var(--purple);
    }

    .control-group .value {
      font-size: 0.9em;
      color: var(--purple);
    }

    .preview-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .preview-container {
        grid-template-columns: 1fr;
      }
    }

    .preview-box {
      background: #111;
      border: 2px solid var(--purple-dim);
      border-radius: 10px;
      padding: 10px;
      position: relative;
    }

    .preview-box h3 {
      font-size: 0.9em;
      margin-bottom: 10px;
      color: var(--cyan);
    }

    .preview-box canvas {
      width: 100%;
      height: auto;
      max-height: 400px;
      object-fit: contain;
      border-radius: 5px;
      background: #000;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-box {
      background: rgba(180, 0, 255, 0.1);
      border: 2px solid var(--purple);
      border-radius: 10px;
      padding: 15px;
      text-align: center;
    }

    .stat-box .number {
      font-size: 2em;
      text-shadow: var(--glow);
      color: var(--cyan);
    }

    .stat-box .label {
      font-size: 0.8em;
      color: var(--purple-dim);
      margin-top: 5px;
    }

    .coordinates {
      background: #111;
      border: 2px solid var(--purple-dim);
      border-radius: 10px;
      padding: 15px;
      max-height: 300px;
      overflow-y: auto;
    }

    .coordinates h3 {
      font-size: 0.9em;
      margin-bottom: 10px;
      color: var(--cyan);
      position: sticky;
      top: 0;
      background: #111;
      padding: 5px 0;
    }

    .coord-list {
      font-family: monospace;
      font-size: 0.85em;
      color: var(--purple);
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 5px;
    }

    .coord-item {
      background: rgba(180, 0, 255, 0.1);
      padding: 3px 8px;
      border-radius: 3px;
    }

    .coord-item:hover {
      background: rgba(180, 0, 255, 0.3);
    }

    button {
      background: transparent;
      border: 2px solid var(--purple);
      color: var(--purple);
      font-family: inherit;
      font-size: 1em;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    button:hover {
      background: var(--purple);
      color: #000;
      box-shadow: var(--glow);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .progress {
      height: 4px;
      background: var(--purple-dim);
      border-radius: 2px;
      margin-bottom: 20px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: var(--purple);
      width: 0%;
      transition: width 0.1s;
      box-shadow: 0 0 10px var(--purple);
    }

    .color-preview {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }

    .color-swatch {
      width: 40px;
      height: 40px;
      border-radius: 5px;
      border: 2px solid var(--purple);
    }

    .backlink {
      position: fixed;
      bottom: 10px;
      right: 10px;
      color: #333;
      text-decoration: none;
      font-size: 0.7em;
    }

    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîÆ PURPLE PIXEL SCANNER</h1>
    <p class="subtitle">Upload an image to detect and count purple pixels</p>

    <div class="upload-zone" id="uploadZone">
      <div class="icon">üì§</div>
      <p>DROP IMAGE HERE</p>
      <p style="font-size:0.8em;color:var(--purple-dim)">or click to browse</p>
      <input type="file" id="fileInput" accept="image/*">
    </div>

    <div class="progress hidden" id="progress">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <div class="controls">
      <div class="control-group">
        <label>HUE MIN (Purple range: ~260-320)</label>
        <input type="range" id="hueMin" min="0" max="360" value="260">
        <span class="value" id="hueMinVal">260¬∞</span>
      </div>
      <div class="control-group">
        <label>HUE MAX</label>
        <input type="range" id="hueMax" min="0" max="360" value="320">
        <span class="value" id="hueMaxVal">320¬∞</span>
      </div>
      <div class="control-group">
        <label>MIN SATURATION</label>
        <input type="range" id="satMin" min="0" max="100" value="20">
        <span class="value" id="satMinVal">20%</span>
      </div>
      <div class="control-group">
        <label>MIN LIGHTNESS</label>
        <input type="range" id="lightMin" min="0" max="100" value="10">
        <span class="value" id="lightMinVal">10%</span>
      </div>
      <div class="color-preview">
        <div class="color-swatch" id="minSwatch"></div>
        <span style="font-size:0.8em">to</span>
        <div class="color-swatch" id="maxSwatch"></div>
      </div>
    </div>

    <div class="actions">
      <button id="scanBtn" disabled>SCAN FOR PURPLE</button>
      <button id="exportBtn" disabled>EXPORT COORDINATES</button>
    </div>

    <div class="stats">
      <div class="stat-box">
        <div class="number" id="totalPixels">0</div>
        <div class="label">TOTAL PIXELS</div>
      </div>
      <div class="stat-box">
        <div class="number" id="purpleCount">0</div>
        <div class="label">PURPLE PIXELS</div>
      </div>
      <div class="stat-box">
        <div class="number" id="percentage">0%</div>
        <div class="label">PURPLE %</div>
      </div>
      <div class="stat-box">
        <div class="number" id="avgColor">-</div>
        <div class="label">AVG HUE</div>
      </div>
    </div>

    <div class="preview-container">
      <div class="preview-box">
        <h3>üì∑ ORIGINAL IMAGE</h3>
        <canvas id="originalCanvas"></canvas>
      </div>
      <div class="preview-box">
        <h3>üîÆ PURPLE PIXELS HIGHLIGHTED</h3>
        <canvas id="resultCanvas"></canvas>
      </div>
    </div>

    <div class="coordinates">
      <h3>üìç PURPLE PIXEL COORDINATES <span id="coordCount">(0)</span></h3>
      <div class="coord-list" id="coordList">
        Upload an image and scan to see coordinates
      </div>
    </div>
  </div>

  <a href="https://sloppy.live" class="backlink">sloppy.live</a>

  <script>
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const originalCanvas = document.getElementById('originalCanvas');
    const resultCanvas = document.getElementById('resultCanvas');
    const origCtx = originalCanvas.getContext('2d');
    const resultCtx = resultCanvas.getContext('2d');

    const hueMin = document.getElementById('hueMin');
    const hueMax = document.getElementById('hueMax');
    const satMin = document.getElementById('satMin');
    const lightMin = document.getElementById('lightMin');

    const scanBtn = document.getElementById('scanBtn');
    const exportBtn = document.getElementById('exportBtn');
    const progress = document.getElementById('progress');
    const progressBar = document.getElementById('progressBar');

    let currentImage = null;
    let purpleCoords = [];

    // Update control displays
    function updateControls() {
      document.getElementById('hueMinVal').textContent = hueMin.value + '¬∞';
      document.getElementById('hueMaxVal').textContent = hueMax.value + '¬∞';
      document.getElementById('satMinVal').textContent = satMin.value + '%';
      document.getElementById('lightMinVal').textContent = lightMin.value + '%';

      // Update swatches
      document.getElementById('minSwatch').style.background =
        `hsl(${hueMin.value}, 70%, 50%)`;
      document.getElementById('maxSwatch').style.background =
        `hsl(${hueMax.value}, 70%, 50%)`;
    }

    [hueMin, hueMax, satMin, lightMin].forEach(el => {
      el.addEventListener('input', updateControls);
    });
    updateControls();

    // Drag and drop
    uploadZone.addEventListener('click', () => fileInput.click());

    uploadZone.addEventListener('dragover', e => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', e => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) {
        loadImage(file);
      }
    });

    fileInput.addEventListener('change', e => {
      if (e.target.files[0]) {
        loadImage(e.target.files[0]);
      }
    });

    function loadImage(file) {
      const reader = new FileReader();
      reader.onload = e => {
        const img = new Image();
        img.onload = () => {
          currentImage = img;

          // Set canvas sizes
          const maxW = 800;
          const scale = img.width > maxW ? maxW / img.width : 1;
          const w = img.width * scale;
          const h = img.height * scale;

          originalCanvas.width = resultCanvas.width = w;
          originalCanvas.height = resultCanvas.height = h;

          // Draw original
          origCtx.drawImage(img, 0, 0, w, h);
          resultCtx.drawImage(img, 0, 0, w, h);

          // Update stats
          document.getElementById('totalPixels').textContent =
            (img.width * img.height).toLocaleString();

          scanBtn.disabled = false;
          exportBtn.disabled = true;
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    // RGB to HSL conversion
    function rgbToHsl(r, g, b) {
      r /= 255; g /= 255; b /= 255;
      const max = Math.max(r, g, b), min = Math.min(r, g, b);
      let h, s, l = (max + min) / 2;

      if (max === min) {
        h = s = 0;
      } else {
        const d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        switch (max) {
          case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
          case g: h = ((b - r) / d + 2) / 6; break;
          case b: h = ((r - g) / d + 4) / 6; break;
        }
      }
      return [h * 360, s * 100, l * 100];
    }

    function isPurple(r, g, b) {
      const [h, s, l] = rgbToHsl(r, g, b);
      const minH = parseInt(hueMin.value);
      const maxH = parseInt(hueMax.value);
      const minS = parseInt(satMin.value);
      const minL = parseInt(lightMin.value);

      return h >= minH && h <= maxH && s >= minS && l >= minL && l <= 90;
    }

    scanBtn.addEventListener('click', async () => {
      if (!currentImage) return;

      scanBtn.disabled = true;
      progress.classList.remove('hidden');
      purpleCoords = [];

      const w = originalCanvas.width;
      const h = originalCanvas.height;

      // Get image data
      const imageData = origCtx.getImageData(0, 0, w, h);
      const data = imageData.data;

      // Create result image data
      const resultData = resultCtx.createImageData(w, h);
      const result = resultData.data;

      let purpleCount = 0;
      let hueSum = 0;
      const totalPixels = w * h;

      // Scan pixels
      for (let y = 0; y < h; y++) {
        for (let x = 0; x < w; x++) {
          const i = (y * w + x) * 4;
          const r = data[i];
          const g = data[i + 1];
          const b = data[i + 2];

          if (isPurple(r, g, b)) {
            purpleCount++;
            const [hue] = rgbToHsl(r, g, b);
            hueSum += hue;

            // Store coordinate (limit to 10000 for performance)
            if (purpleCoords.length < 10000) {
              purpleCoords.push({ x, y, r, g, b });
            }

            // Highlight in result - make it glow
            result[i] = 255;
            result[i + 1] = 0;
            result[i + 2] = 255;
            result[i + 3] = 255;
          } else {
            // Dim non-purple pixels
            result[i] = r * 0.3;
            result[i + 1] = g * 0.3;
            result[i + 2] = b * 0.3;
            result[i + 3] = 255;
          }
        }

        // Update progress
        if (y % 50 === 0) {
          progressBar.style.width = ((y / h) * 100) + '%';
          await new Promise(r => setTimeout(r, 0));
        }
      }

      // Draw result
      resultCtx.putImageData(resultData, 0, 0);

      // Update stats
      document.getElementById('purpleCount').textContent = purpleCount.toLocaleString();
      document.getElementById('percentage').textContent =
        ((purpleCount / totalPixels) * 100).toFixed(2) + '%';
      document.getElementById('avgColor').textContent =
        purpleCount > 0 ? Math.round(hueSum / purpleCount) + '¬∞' : '-';

      // Update coordinate list
      const coordList = document.getElementById('coordList');
      document.getElementById('coordCount').textContent =
        `(${purpleCoords.length}${purpleCoords.length >= 10000 ? '+' : ''})`;

      if (purpleCoords.length > 0) {
        coordList.innerHTML = purpleCoords.slice(0, 500).map(c =>
          `<span class="coord-item">(${c.x}, ${c.y})</span>`
        ).join('');
        if (purpleCoords.length > 500) {
          coordList.innerHTML += `<span class="coord-item">...and ${purpleCoords.length - 500} more</span>`;
        }
      } else {
        coordList.innerHTML = 'No purple pixels found with current settings';
      }

      progressBar.style.width = '100%';
      setTimeout(() => {
        progress.classList.add('hidden');
        progressBar.style.width = '0%';
      }, 500);

      scanBtn.disabled = false;
      exportBtn.disabled = purpleCoords.length === 0;
    });

    exportBtn.addEventListener('click', () => {
      if (purpleCoords.length === 0) return;

      const csv = 'x,y,r,g,b\n' + purpleCoords.map(c =>
        `${c.x},${c.y},${c.r},${c.g},${c.b}`
      ).join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'purple_pixels.csv';
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
