<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Code Sprint - Competitive Timed Coding</title>
  <link rel="icon" href="https://emojicdn.elk.sh/üèÉ">
  <meta name="description" content="Compete against others to build apps against the clock.">
  <meta property="og:title" content="Code Sprint - Competitive Timed Coding">
  <meta property="og:description" content="Compete against others to build apps against the clock.">
  <meta property="og:url" content="https://sloppy.live/code-sprint">
  <meta property="og:image" content="https://emojicdn.elk.sh/üèÉ?style=twitter">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #0a0a0f;
      color: #e0e0e0;
      font-family: 'Space Grotesk', sans-serif;
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, #1a1a2e 0%, #0a0a0f 100%);
      border-bottom: 1px solid #2a2a3a;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      font-size: 28px;
    }

    .logo h1 {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(90deg, #00ff88, #00ccff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: 1px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-name {
      font-size: 14px;
      color: #888;
    }

    .user-name input {
      background: #1a1a2e;
      border: 1px solid #2a2a3a;
      color: #fff;
      padding: 6px 12px;
      border-radius: 6px;
      font-family: inherit;
      font-size: 14px;
      width: 150px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
    }

    .tab {
      padding: 12px 24px;
      font-family: inherit;
      font-size: 14px;
      font-weight: 500;
      background: #1a1a2e;
      border: 1px solid #2a2a3a;
      color: #888;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tab:hover {
      border-color: #00ff88;
      color: #fff;
    }

    .tab.active {
      background: linear-gradient(135deg, #00ff8820, #00ccff20);
      border-color: #00ff88;
      color: #00ff88;
    }

    .panel {
      display: none;
    }

    .panel.active {
      display: block;
    }

    /* Sprint Cards */
    .sprints-grid {
      display: grid;
      gap: 20px;
    }

    .sprint-card {
      background: #12121a;
      border: 1px solid #2a2a3a;
      border-radius: 12px;
      padding: 24px;
      transition: all 0.2s;
    }

    .sprint-card:hover {
      border-color: #00ff88;
      transform: translateY(-2px);
    }

    .sprint-card.active-sprint {
      border-color: #00ff88;
      box-shadow: 0 0 30px #00ff8820;
    }

    .sprint-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .sprint-title {
      font-size: 20px;
      font-weight: 700;
      color: #fff;
    }

    .sprint-status {
      padding: 4px 12px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-radius: 20px;
    }

    .sprint-status.waiting {
      background: #ffaa0030;
      color: #ffaa00;
    }

    .sprint-status.active {
      background: #00ff8830;
      color: #00ff88;
      animation: pulse 2s infinite;
    }

    .sprint-status.ended {
      background: #ff555530;
      color: #ff5555;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .sprint-prompt {
      background: #0a0a0f;
      border-left: 3px solid #00ccff;
      padding: 15px;
      margin: 15px 0;
      font-size: 14px;
      line-height: 1.6;
      border-radius: 0 8px 8px 0;
    }

    .sprint-meta {
      display: flex;
      gap: 20px;
      font-size: 13px;
      color: #666;
      margin-bottom: 15px;
    }

    .sprint-meta span {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .timer {
      font-family: 'JetBrains Mono', monospace;
      font-size: 48px;
      font-weight: 700;
      text-align: center;
      padding: 20px;
      background: #0a0a0f;
      border-radius: 12px;
      margin: 20px 0;
    }

    .timer.running {
      color: #00ff88;
      text-shadow: 0 0 20px #00ff88;
    }

    .timer.warning {
      color: #ffaa00;
      text-shadow: 0 0 20px #ffaa00;
    }

    .timer.danger {
      color: #ff5555;
      text-shadow: 0 0 20px #ff5555;
      animation: flash 0.5s infinite;
    }

    @keyframes flash {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .participants {
      margin-top: 20px;
    }

    .participants-title {
      font-size: 14px;
      color: #888;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .participant-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .participant {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: #1a1a2e;
      border-radius: 20px;
      font-size: 13px;
    }

    .participant.finished {
      background: #00ff8830;
      color: #00ff88;
    }

    .participant-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #666;
    }

    .participant.coding .participant-status {
      background: #00ccff;
      animation: pulse 1s infinite;
    }

    .participant.finished .participant-status {
      background: #00ff88;
    }

    .btn {
      padding: 12px 24px;
      font-family: inherit;
      font-size: 14px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #00ff88, #00ccff);
      color: #000;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px #00ff8840;
    }

    .btn-secondary {
      background: #1a1a2e;
      border: 1px solid #2a2a3a;
      color: #888;
    }

    .btn-secondary:hover {
      border-color: #00ff88;
      color: #fff;
    }

    .btn-danger {
      background: #ff555530;
      color: #ff5555;
    }

    .sprint-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    /* Create Sprint Form */
    .create-form {
      background: #12121a;
      border: 1px solid #2a2a3a;
      border-radius: 12px;
      padding: 30px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      color: #888;
      margin-bottom: 8px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px 16px;
      font-family: inherit;
      font-size: 14px;
      background: #0a0a0f;
      border: 1px solid #2a2a3a;
      color: #fff;
      border-radius: 8px;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #00ff88;
    }

    .form-group textarea {
      min-height: 120px;
      resize: vertical;
    }

    /* Submit Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-overlay.visible {
      display: flex;
    }

    .modal {
      background: #12121a;
      border: 1px solid #2a2a3a;
      border-radius: 16px;
      padding: 30px;
      width: 90%;
      max-width: 500px;
    }

    .modal h2 {
      font-size: 24px;
      margin-bottom: 20px;
      color: #00ff88;
    }

    /* Leaderboard */
    .leaderboard {
      background: #12121a;
      border: 1px solid #2a2a3a;
      border-radius: 12px;
      overflow: hidden;
    }

    .leaderboard-header {
      background: #1a1a2e;
      padding: 15px 20px;
      font-weight: 600;
      display: grid;
      grid-template-columns: 50px 1fr 100px 100px;
      gap: 15px;
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .leaderboard-row {
      display: grid;
      grid-template-columns: 50px 1fr 100px 100px;
      gap: 15px;
      padding: 15px 20px;
      border-bottom: 1px solid #2a2a3a;
      align-items: center;
    }

    .leaderboard-row:last-child {
      border-bottom: none;
    }

    .rank {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 700;
      font-size: 18px;
    }

    .rank-1 { color: #ffd700; }
    .rank-2 { color: #c0c0c0; }
    .rank-3 { color: #cd7f32; }

    .submission-link {
      color: #00ccff;
      text-decoration: none;
    }

    .submission-link:hover {
      text-decoration: underline;
    }

    .vote-btn {
      padding: 6px 12px;
      font-size: 12px;
      background: transparent;
      border: 1px solid #2a2a3a;
      color: #888;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .vote-btn:hover {
      border-color: #00ff88;
      color: #00ff88;
    }

    .vote-btn.voted {
      background: #00ff8830;
      border-color: #00ff88;
      color: #00ff88;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .backlink {
      display: block;
      text-align: center;
      margin-top: 40px;
      color: #444;
      font-size: 12px;
      text-decoration: none;
    }

    .backlink:hover {
      color: #00ff88;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .tabs {
        flex-wrap: wrap;
        justify-content: center;
      }

      .timer {
        font-size: 32px;
      }

      .leaderboard-header,
      .leaderboard-row {
        grid-template-columns: 40px 1fr 80px;
      }

      .leaderboard-header > *:last-child,
      .leaderboard-row > *:last-child {
        display: none;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">
      <span class="logo-icon">üèÉ</span>
      <h1>CODE SPRINT</h1>
    </div>
    <div class="user-info">
      <div class="user-name">
        <input type="text" id="displayName" placeholder="Your name..." maxlength="20">
      </div>
    </div>
  </header>

  <div class="container">
    <div class="tabs">
      <button class="tab active" data-tab="active">Active Sprints</button>
      <button class="tab" data-tab="create">Create Sprint</button>
      <button class="tab" data-tab="history">History</button>
    </div>

    <!-- Active Sprints Panel -->
    <div class="panel active" id="active-panel">
      <div class="sprints-grid" id="activeSprintsList">
        <div class="loading">Loading sprints...</div>
      </div>
    </div>

    <!-- Create Sprint Panel -->
    <div class="panel" id="create-panel">
      <div class="create-form">
        <div class="form-group">
          <label>Sprint Title</label>
          <input type="text" id="sprintTitle" placeholder="e.g., Build a Todo App" maxlength="100">
        </div>
        <div class="form-group">
          <label>Challenge Prompt</label>
          <textarea id="sprintPrompt" placeholder="Describe what participants need to build..."></textarea>
        </div>
        <div class="form-group">
          <label>Duration</label>
          <select id="sprintDuration">
            <option value="5">5 minutes (Speed Round)</option>
            <option value="10">10 minutes</option>
            <option value="15" selected>15 minutes</option>
            <option value="30">30 minutes</option>
            <option value="60">60 minutes (Marathon)</option>
          </select>
        </div>
        <button class="btn btn-primary" id="createSprintBtn">Create Sprint</button>
      </div>
    </div>

    <!-- History Panel -->
    <div class="panel" id="history-panel">
      <div class="sprints-grid" id="historyList">
        <div class="loading">Loading history...</div>
      </div>
    </div>

    <a href="https://sloppy.live" class="backlink">sloppy.live</a>
  </div>

  <!-- Submit Modal -->
  <div class="modal-overlay" id="submitModal">
    <div class="modal">
      <h2>Submit Your Work</h2>
      <div class="form-group">
        <label>Submission URL (GitHub, CodePen, etc.)</label>
        <input type="url" id="submissionUrl" placeholder="https://...">
      </div>
      <div class="sprint-actions">
        <button class="btn btn-primary" id="confirmSubmit">Submit</button>
        <button class="btn btn-secondary" id="cancelSubmit">Cancel</button>
      </div>
    </div>
  </div>

  <script type="module">
    import supabase, { supabaseSession } from '../../supabase-config.js';

    let currentUser = null;
    let currentSprint = null;
    let timerInterval = null;
    let participantSubscription = null;

    // Initialize
    async function init() {
      console.log('[DEBUG] init() starting...');
      try {
        console.log('[DEBUG] Calling supabaseSession()...');
        const { user } = await supabaseSession();
        currentUser = user;
        console.log('[DEBUG] Authentication successful, user:', user?.id);

        // Load saved display name
        const savedName = localStorage.getItem('codeSprint_displayName');
        if (savedName) {
          document.getElementById('displayName').value = savedName;
          console.log('[DEBUG] Loaded saved display name:', savedName);
        }

        console.log('[DEBUG] Loading sprints...');
        loadActiveSprints();
        loadHistory();
        setupRealtimeSubscription();
        console.log('[DEBUG] init() complete');
      } catch (err) {
        console.error('[DEBUG] init() ERROR:', err);
      }
    }

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`${tab.dataset.tab}-panel`).classList.add('active');
      });
    });

    // Save display name
    document.getElementById('displayName').addEventListener('change', (e) => {
      localStorage.setItem('codeSprint_displayName', e.target.value);
    });

    // Load active sprints
    async function loadActiveSprints() {
      const container = document.getElementById('activeSprintsList');

      const { data: sprints, error } = await supabase
        .from('code_sprints')
        .select('*')
        .in('status', ['waiting', 'active'])
        .order('created_at', { ascending: false });

      if (error) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div>Error loading sprints</div>';
        return;
      }

      if (!sprints || sprints.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üèÉ</div>
            <p>No active sprints right now</p>
            <p style="margin-top:10px;font-size:13px">Create one to get started!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = '';
      for (const sprint of sprints) {
        const card = await createSprintCard(sprint, true);
        container.appendChild(card);
      }
    }

    // Load history
    async function loadHistory() {
      const container = document.getElementById('historyList');

      const { data: sprints, error } = await supabase
        .from('code_sprints')
        .select('*')
        .eq('status', 'ended')
        .order('created_at', { ascending: false })
        .limit(20);

      if (error || !sprints || sprints.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìú</div>
            <p>No completed sprints yet</p>
          </div>
        `;
        return;
      }

      container.innerHTML = '';
      for (const sprint of sprints) {
        const card = await createSprintCard(sprint, false);
        container.appendChild(card);
      }
    }

    // Create sprint card
    async function createSprintCard(sprint, isActive) {
      const card = document.createElement('div');
      card.className = `sprint-card ${sprint.status === 'active' ? 'active-sprint' : ''}`;
      card.dataset.sprintId = sprint.id;

      // Load participants
      const { data: participants } = await supabase
        .from('sprint_participants')
        .select('*')
        .eq('sprint_id', sprint.id);

      const myParticipation = participants?.find(p => p.user_id === currentUser?.id);
      const hasJoined = !!myParticipation;
      const hasSubmitted = myParticipation?.status === 'finished';

      let timerHtml = '';
      let actionsHtml = '';

      if (sprint.status === 'waiting') {
        timerHtml = `<div class="timer">${sprint.duration_minutes}:00</div>`;
        actionsHtml = hasJoined
          ? `<button class="btn btn-secondary" disabled>Joined - Waiting to Start</button>
             ${sprint.user_id === currentUser?.id ? `<button class="btn btn-primary" onclick="startSprint('${sprint.id}')">Start Sprint</button>` : ''}`
          : `<button class="btn btn-primary" onclick="joinSprint('${sprint.id}')">Join Sprint</button>`;
      } else if (sprint.status === 'active') {
        const endTime = new Date(sprint.ends_at).getTime();
        const now = Date.now();
        const remaining = Math.max(0, Math.floor((endTime - now) / 1000));
        const mins = Math.floor(remaining / 60);
        const secs = remaining % 60;

        timerHtml = `<div class="timer running" data-ends="${sprint.ends_at}">${mins}:${secs.toString().padStart(2, '0')}</div>`;

        if (hasJoined) {
          actionsHtml = hasSubmitted
            ? `<button class="btn btn-secondary" disabled>Submitted!</button>`
            : `<button class="btn btn-primary" onclick="openSubmitModal('${sprint.id}')">Submit Work</button>`;
        } else {
          actionsHtml = `<button class="btn btn-primary" onclick="joinSprint('${sprint.id}')">Join (Late Entry)</button>`;
        }
      } else {
        timerHtml = `<div class="timer">FINISHED</div>`;
      }

      const participantsList = participants?.map(p => `
        <div class="participant ${p.status}">
          <span class="participant-status"></span>
          ${p.display_name || 'Anonymous'}
          ${p.status === 'finished' ? '‚úì' : ''}
        </div>
      `).join('') || '';

      card.innerHTML = `
        <div class="sprint-header">
          <div class="sprint-title">${sprint.title}</div>
          <div class="sprint-status ${sprint.status}">${sprint.status}</div>
        </div>
        <div class="sprint-prompt">${sprint.prompt}</div>
        <div class="sprint-meta">
          <span>‚è±Ô∏è ${sprint.duration_minutes} min</span>
          <span>üë§ ${sprint.created_by_name || 'Anonymous'}</span>
          <span>üë• ${participants?.length || 0} joined</span>
        </div>
        ${timerHtml}
        <div class="participants">
          <div class="participants-title">üë• Participants</div>
          <div class="participant-list">${participantsList || '<span style="color:#666">No one yet...</span>'}</div>
        </div>
        ${sprint.status === 'ended' ? await renderLeaderboard(sprint.id, participants) : ''}
        <div class="sprint-actions">${actionsHtml}</div>
      `;

      // Start timer if active
      if (sprint.status === 'active') {
        const timerEl = card.querySelector('.timer');
        startTimerCountdown(timerEl, sprint);
      }

      return card;
    }

    // Render leaderboard for ended sprints
    async function renderLeaderboard(sprintId, participants) {
      if (!participants || participants.length === 0) return '';

      const finished = participants
        .filter(p => p.status === 'finished')
        .sort((a, b) => new Date(a.submitted_at) - new Date(b.submitted_at));

      if (finished.length === 0) return '<p style="color:#666;margin-top:20px">No submissions</p>';

      let html = `
        <div class="leaderboard" style="margin-top:20px">
          <div class="leaderboard-header">
            <span>#</span>
            <span>Name</span>
            <span>Time</span>
            <span>Votes</span>
          </div>
      `;

      finished.forEach((p, i) => {
        const rank = i + 1;
        const rankClass = rank <= 3 ? `rank-${rank}` : '';
        html += `
          <div class="leaderboard-row">
            <span class="rank ${rankClass}">${rank}</span>
            <span>
              ${p.display_name || 'Anonymous'}
              ${p.submission_url ? `<a href="${p.submission_url}" target="_blank" class="submission-link">‚Üó</a>` : ''}
            </span>
            <span>${formatSubmitTime(p.submitted_at)}</span>
            <span>
              <button class="vote-btn" onclick="vote('${p.id}')">
                üëç ${p.votes || 0}
              </button>
            </span>
          </div>
        `;
      });

      html += '</div>';
      return html;
    }

    function formatSubmitTime(timestamp) {
      if (!timestamp) return '-';
      const date = new Date(timestamp);
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // Timer countdown
    function startTimerCountdown(timerEl, sprint) {
      if (timerInterval) clearInterval(timerInterval);

      function updateTimer() {
        const endTime = new Date(sprint.ends_at).getTime();
        const now = Date.now();
        const remaining = Math.max(0, Math.floor((endTime - now) / 1000));

        const mins = Math.floor(remaining / 60);
        const secs = remaining % 60;
        timerEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;

        // Update styling based on time remaining
        timerEl.classList.remove('running', 'warning', 'danger');
        if (remaining > 60) {
          timerEl.classList.add('running');
        } else if (remaining > 30) {
          timerEl.classList.add('warning');
        } else if (remaining > 0) {
          timerEl.classList.add('danger');
        }

        if (remaining <= 0) {
          clearInterval(timerInterval);
          timerEl.textContent = 'TIME!';
          loadActiveSprints();
          loadHistory();
        }
      }

      updateTimer();
      timerInterval = setInterval(updateTimer, 1000);
    }

    // Create sprint
    document.getElementById('createSprintBtn').addEventListener('click', async () => {
      console.log('[DEBUG] Create Sprint button clicked');
      console.log('[DEBUG] currentUser:', currentUser);

      if (!currentUser) {
        console.log('[DEBUG] BLOCKED: No currentUser');
        alert('Please wait for authentication to complete');
        return;
      }

      const title = document.getElementById('sprintTitle').value.trim();
      const prompt = document.getElementById('sprintPrompt').value.trim();
      const duration = parseInt(document.getElementById('sprintDuration').value);
      const displayName = document.getElementById('displayName').value.trim() || 'Anonymous';

      console.log('[DEBUG] Form values:', { title, prompt, duration, displayName });

      if (!title || !prompt) {
        console.log('[DEBUG] BLOCKED: Missing title or prompt');
        alert('Please fill in title and prompt');
        return;
      }

      console.log('[DEBUG] Inserting sprint into database...');
      const { data, error } = await supabase
        .from('code_sprints')
        .insert({
          title,
          prompt,
          duration_minutes: duration,
          status: 'waiting',
          created_by_name: displayName,
          user_id: currentUser.id
        })
        .select()
        .single();

      if (error) {
        console.error('[DEBUG] Create sprint ERROR:', error);
        alert('Failed to create sprint');
        return;
      }

      console.log('[DEBUG] Sprint created successfully:', data);

      // Auto-join as creator
      console.log('[DEBUG] Auto-joining as creator...');
      await joinSprint(data.id);

      // Clear form
      document.getElementById('sprintTitle').value = '';
      document.getElementById('sprintPrompt').value = '';

      // Switch to active tab
      console.log('[DEBUG] Switching to active tab');
      document.querySelector('[data-tab="active"]').click();
      loadActiveSprints();
    });

    // Join sprint
    window.joinSprint = async function(sprintId) {
      console.log('[DEBUG] Join Sprint clicked, sprintId:', sprintId);
      console.log('[DEBUG] currentUser:', currentUser);

      if (!currentUser) {
        console.log('[DEBUG] BLOCKED: No currentUser');
        alert('Please wait for authentication to complete');
        return;
      }

      const displayName = document.getElementById('displayName').value.trim() || 'Anonymous';
      console.log('[DEBUG] Joining as:', displayName);

      console.log('[DEBUG] Inserting participant into database...');
      const { error } = await supabase
        .from('sprint_participants')
        .insert({
          sprint_id: sprintId,
          display_name: displayName,
          status: 'coding',
          user_id: currentUser.id,
          votes: 0
        });

      if (error && !error.message.includes('duplicate')) {
        console.error('[DEBUG] Join sprint ERROR:', error);
        alert('Failed to join sprint');
        return;
      }

      console.log('[DEBUG] Successfully joined sprint');
      loadActiveSprints();
    };

    // Start sprint
    window.startSprint = async function(sprintId) {
      console.log('[DEBUG] Start Sprint clicked, sprintId:', sprintId);

      const { data: sprint, error: fetchError } = await supabase
        .from('code_sprints')
        .select('duration_minutes')
        .eq('id', sprintId)
        .single();

      console.log('[DEBUG] Fetched sprint data:', sprint, 'error:', fetchError);

      if (!sprint) {
        console.log('[DEBUG] BLOCKED: Sprint not found');
        return;
      }

      const now = new Date();
      const endsAt = new Date(now.getTime() + sprint.duration_minutes * 60 * 1000);
      console.log('[DEBUG] Setting sprint active, ends at:', endsAt.toISOString());

      const { error } = await supabase
        .from('code_sprints')
        .update({
          status: 'active',
          started_at: now.toISOString(),
          ends_at: endsAt.toISOString()
        })
        .eq('id', sprintId);

      if (error) {
        console.error('[DEBUG] Start sprint ERROR:', error);
        return;
      }

      console.log('[DEBUG] Sprint started successfully');
      loadActiveSprints();
    };

    // Open submit modal
    window.openSubmitModal = function(sprintId) {
      console.log('[DEBUG] Open Submit Modal clicked, sprintId:', sprintId);
      currentSprint = sprintId;
      document.getElementById('submissionUrl').value = '';
      document.getElementById('submitModal').classList.add('visible');
    };

    document.getElementById('cancelSubmit').addEventListener('click', () => {
      console.log('[DEBUG] Cancel Submit clicked');
      document.getElementById('submitModal').classList.remove('visible');
    });

    document.getElementById('confirmSubmit').addEventListener('click', async () => {
      console.log('[DEBUG] Confirm Submit clicked');
      console.log('[DEBUG] currentUser:', currentUser);
      console.log('[DEBUG] currentSprint:', currentSprint);

      if (!currentUser) {
        console.log('[DEBUG] BLOCKED: No currentUser');
        alert('Please wait for authentication to complete');
        return;
      }

      const url = document.getElementById('submissionUrl').value.trim();
      console.log('[DEBUG] Submission URL:', url);

      console.log('[DEBUG] Updating participant status to finished...');
      const { error } = await supabase
        .from('sprint_participants')
        .update({
          status: 'finished',
          submitted_at: new Date().toISOString(),
          submission_url: url || null
        })
        .eq('sprint_id', currentSprint)
        .eq('user_id', currentUser.id);

      if (error) {
        console.error('[DEBUG] Submit ERROR:', error);
        alert('Failed to submit');
        return;
      }

      console.log('[DEBUG] Submission successful');
      document.getElementById('submitModal').classList.remove('visible');
      loadActiveSprints();
    });

    // Vote
    window.vote = async function(participantId) {
      console.log('[DEBUG] Vote clicked, participantId:', participantId);

      const { data: participant, error: fetchError } = await supabase
        .from('sprint_participants')
        .select('votes')
        .eq('id', participantId)
        .single();

      console.log('[DEBUG] Fetched participant:', participant, 'error:', fetchError);

      if (!participant) {
        console.log('[DEBUG] BLOCKED: Participant not found');
        return;
      }

      const newVotes = (participant.votes || 0) + 1;
      console.log('[DEBUG] Updating votes to:', newVotes);

      const { error } = await supabase
        .from('sprint_participants')
        .update({ votes: newVotes })
        .eq('id', participantId);

      if (error) {
        console.error('[DEBUG] Vote ERROR:', error);
        return;
      }

      console.log('[DEBUG] Vote successful');
      loadHistory();
    };

    // Real-time subscription
    function setupRealtimeSubscription() {
      supabase
        .channel('sprints_changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'code_sprints' }, () => {
          loadActiveSprints();
          loadHistory();
        })
        .on('postgres_changes', { event: '*', schema: 'public', table: 'sprint_participants' }, () => {
          loadActiveSprints();
        })
        .subscribe();
    }

    // Check for ended sprints periodically
    setInterval(async () => {
      const { data: activeSprints } = await supabase
        .from('code_sprints')
        .select('id, ends_at')
        .eq('status', 'active');

      if (activeSprints) {
        const now = Date.now();
        for (const sprint of activeSprints) {
          if (new Date(sprint.ends_at).getTime() <= now) {
            await supabase
              .from('code_sprints')
              .update({ status: 'ended' })
              .eq('id', sprint.id);
          }
        }
      }
    }, 5000);

    // Initialize
    init();
  </script>
</body>
</html>
