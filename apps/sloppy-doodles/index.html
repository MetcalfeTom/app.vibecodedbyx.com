<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sloppy Doodles</title>
    <link rel="icon" href="https://emojicdn.elk.sh/üé®">
    <meta property="og:title" content="Sloppy Doodles">
    <meta property="og:description" content="Legendary doodles ranked by community votes. Can yours reach #1?">
    <meta property="og:url" content="https://app.sloppy.live/sloppy-doodles">
    <meta property="og:image" content="https://image.pollinations.ai/prompt/pixel%20art%20doodle%20leaderboard%20trophy%20gold%20medals%20retro%20terminal%20dark%20neon%20green?width=1200&height=630&nologo=true&referrer=sloppy.live">
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.2.4/dist/purify.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}

        :root {
            --accent: #7c9885;
            --accent-light: #a8c4b0;
            --accent-dim: #5a7060;
            --highlight: #c9a87c;
            --dark-bg: #0a0a0f;
            --panel-bg: #12121a;
            --border-color: #2a2a35;
            --text-dim: #6a6a75;
        }

        body {
            font-family: 'VT323', monospace;
            background: var(--dark-bg);
            min-height: 100vh;
            color: var(--accent);
        }

        body.embed-mode {
            min-height: 0;
        }

        /* Leaderboard */
        .doodles-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-height: 0;
        }

        .leaderboard-header {
            text-align: center;
            padding: 16px;
            color: var(--accent);
            font-size: 1.1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .doodle-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }

        .doodle-card {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            overflow: hidden;
            border-radius: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .doodle-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .doodle-card.top-3 {
            border-color: var(--highlight);
        }

        .doodle-rank {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--dark-bg);
        }

        .rank-badge {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            background: var(--border-color);
            color: var(--text-dim);
        }

        .rank-badge.gold {
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #000;
        }
        .rank-badge.silver {
            background: linear-gradient(135deg, #e0e0e0, #a0a0a0);
            color: #000;
        }
        .rank-badge.bronze {
            background: linear-gradient(135deg, #cd7f32, #8b4513);
            color: #fff;
        }

        .doodle-artist {
            flex: 1;
            color: var(--accent-light);
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            transition: color 0.15s;
        }

        .doodle-artist:hover {
            color: var(--highlight);
            text-decoration: underline;
        }

        .doodle-votes {
            color: var(--highlight);
            font-size: 1rem;
            font-weight: bold;
        }

        .doodle-votes.positive { color: #4a9; }
        .doodle-votes.negative { color: #c66; }

        .doodle-thumbnail {
            position: relative;
            background: #111;
            aspect-ratio: 4/3;
            overflow: hidden;
        }

        .doodle-card img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .doodle-card:hover img {
            transform: scale(1.05);
        }

        .doodle-card-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-top: 1px solid var(--border-color);
            background: var(--dark-bg);
        }

        .doodle-time {
            color: var(--text-dim);
            font-size: 0.75rem;
        }

        .empty-doodles {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-dim);
        }

        .empty-doodles .icon { font-size: 3rem; margin-bottom: 12px; }

        /* Vote controls */
        .vote-controls {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .vote-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-dim);
            font-size: 0.85rem;
            padding: 2px 6px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.15s;
        }

        .vote-btn:hover { border-color: var(--accent); color: var(--accent); }
        .vote-btn.upvote.active { color: #4a9; border-color: #4a9; }
        .vote-btn.downvote.active { color: #c66; border-color: #c66; }
        .vote-btn.disabled { opacity: 0.3; cursor: not-allowed; }

        .vote-score {
            font-size: 0.9rem;
            min-width: 20px;
            text-align: center;
            font-weight: bold;
        }
        .vote-score.positive { color: #4a9; }
        .vote-score.negative { color: #c66; }
        .vote-score.neutral { color: var(--text-dim); }

        /* Comments */
        .doodle-comments {
            max-height: 200px;
            overflow-y: auto;
            padding: 8px 12px;
            border-top: 1px solid var(--border-color);
        }

        .comment {
            display: flex;
            gap: 8px;
            padding: 4px 0;
            font-size: 0.85rem;
        }

        .comment-thread { margin-left: 20px; }

        .comment-avatar { font-size: 0.9rem; }

        .comment-content { flex: 1; min-width: 0; }

        .comment-username {
            color: var(--highlight);
            cursor: pointer;
            transition: color 0.15s;
        }
        .comment-username:hover { color: var(--accent-light); text-decoration: underline; }

        .comment-time {
            color: var(--text-dim);
            font-size: 0.75rem;
            margin-left: 8px;
        }

        .comment-text {
            color: var(--accent);
            word-break: break-word;
        }

        .comment-actions {
            margin-top: 2px;
        }

        .comment-reply-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            font-family: inherit;
            font-size: 0.7rem;
            cursor: pointer;
            padding: 0;
        }
        .comment-reply-btn:hover { color: var(--accent); }

        .comment-replies { margin-left: 16px; }

        .comment-input-row {
            padding: 8px 12px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 6px;
        }

        .comment-input {
            flex: 1;
            background: var(--dark-bg);
            border: 1px solid var(--border-color);
            color: var(--accent);
            padding: 6px 10px;
            font-family: inherit;
            font-size: 0.85rem;
            outline: none;
        }
        .comment-input:focus { border-color: var(--accent); }

        .comment-send {
            background: var(--accent-dim);
            border: 1px solid var(--accent);
            color: var(--dark-bg);
            padding: 6px 12px;
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
        }
        .comment-send:hover { background: var(--accent); }

        .reply-indicator {
            padding: 4px 12px;
            border-top: 1px solid var(--border-color);
            font-size: 0.8rem;
            color: var(--text-dim);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cancel-reply {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 0.9rem;
            font-family: inherit;
        }
        .cancel-reply:hover { color: #c66; }

        .post-action-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-dim);
            font-family: inherit;
            font-size: 0.8rem;
            padding: 4px 10px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .post-action-btn:hover { border-color: var(--accent); color: var(--accent); }

        .msg-delete-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            font-family: inherit;
            font-size: 0.7rem;
            cursor: pointer;
            opacity: 0.5;
        }
        .msg-delete-btn:hover { color: #c66; opacity: 1; }

        /* Lightbox */
        .lightbox {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 100;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        .lightbox.active { display: flex; }
        .lightbox img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border: 2px solid var(--accent);
            box-shadow: 0 0 30px rgba(124,152,133,0.5);
        }
        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 2.5rem;
            color: var(--accent);
            background: none;
            border: none;
            cursor: pointer;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--panel-bg);
            border: 1px solid var(--accent);
            color: var(--accent-light);
            padding: 10px 20px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9rem;
            z-index: 99999;
            transition: transform 0.3s ease;
            pointer-events: none;
        }
        .toast.visible { transform: translateX(-50%) translateY(0); }
        .toast.warning { border-color: #fbbf24; color: #fbbf24; }
        .toast.error { border-color: #ef4444; color: #ef4444; }
        .toast.success { border-color: #22c55e; color: #22c55e; }

        /* Standalone header */
        .standalone-header {
            text-align: center;
            padding: 20px 16px 0;
        }
        .standalone-header h1 { font-size: 1.8rem; color: var(--accent-light); }
        .standalone-header p { color: var(--text-dim); font-size: 1rem; margin-top: 4px; }
        .back-link {
            display: block;
            text-align: center;
            padding: 16px;
            color: var(--text-dim);
            font-size: 0.9rem;
        }
        .back-link a { color: var(--accent); text-decoration: none; }
        .back-link a:hover { text-decoration: underline; }
    </style>
<script>
(function(){var Q=[],N=0,MAX=10;function send(e){var sb=window.supabase;if(!sb){Q.push(e);return;}if(N>=MAX)return;N++;sb.auth.getSession().then(function(r){var u=r&&r.data&&r.data.session&&r.data.session.user;if(!u)return;sb.from('ai_events').insert({event_type:'client_error',entity_type:'app',entity_id:u.id,username:location.pathname.split('/').filter(Boolean)[0]||'unknown',metadata:e,user_id:u.id}).then(function(){});}).catch(function(){});}window.onerror=function(m,s,l,c,e){send({type:'error',msg:String(m).slice(0,500),src:s||'',line:l,col:c,stack:e?String(e.stack).slice(0,1000):''});};window.addEventListener('unhandledrejection',function(ev){var r=ev.reason;send({type:'promise',msg:String(r&&r.message||r).slice(0,500),stack:r?String(r.stack||'').slice(0,1000):''});});var fi=setInterval(function(){if(window.supabase){Q.splice(0).forEach(send);clearInterval(fi);}},1000);setTimeout(function(){clearInterval(fi);},30000);})();
</script>
</head>
<body>
    <div class="lightbox" id="lightbox" onclick="closeLightbox(event)">
        <button class="lightbox-close" onclick="closeLightbox(event)">√ó</button>
        <img id="lightboxImage" src="" alt="Full size doodle" onclick="event.stopPropagation()">
    </div>

    <div id="standaloneUI">
        <div class="standalone-header">
            <h1>üé® Sloppy Doodles</h1>
            <p>Legendary doodles ranked by community votes</p>
        </div>
    </div>

    <div class="doodles-container" id="doodlesContainer">
        <div class="leaderboard-header">üèÜ LEGENDARY DOODLES üèÜ</div>
        <div class="empty-doodles" id="doodlesEmptyState">
            <div class="icon">üé®</div>
            <p>NO LEGENDARY DOODLES YET...</p>
            <p>Draw something and get votes!</p>
        </div>
    </div>

    <div id="standaloneFooter">
        <div class="back-link"><a href="https://sloppy.live">sloppy.live</a></div>
    </div>

    <div class="toast" id="toast"></div>

<script type="module">
import { createBrowserClient } from "https://cdn.jsdelivr.net/npm/@supabase/ssr@0.7.0/+esm";

const SUPABASE_URL = 'https://yjyxteqzhhmtrgcaekgz.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM8IS32IUYR2eenCCjdDdioiBU';

const getCookieDomain = () => {
    const h = window.location.hostname;
    if (h.includes('sloppy.live')) return '.sloppy.live';
    if (h.includes('vibecodedbyx.com')) return '.vibecodedbyx.com';
    return '.youreabsolutelyright.xyz';
};

const supabase = createBrowserClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    cookieOptions: { name: 'sb-auth-token', domain: getCookieDomain(), path: '/', sameSite: 'lax' }
});
window.supabase = supabase;

// === AUTH ===
var currentUser = null;
var currentUsername = null;
var currentAvatar = 'üë§';

async function initAuth() {
    try {
        var sessRes = await supabase.auth.getSession();
        var session = sessRes.data?.session;
        if (!session) {
            var signRes = await supabase.auth.signInAnonymously();
            session = signRes.data?.session;
        }
        if (session?.user) {
            currentUser = session.user;
            var { data } = await supabase.from('sloppygram_profiles').select('username').eq('user_id', currentUser.id).limit(1);
            if (data && data[0]) currentUsername = data[0].username;
            if (!currentUsername) currentUsername = 'Anon' + Math.floor(Math.random() * 9999);
            // Get avatar from recent messages
            var { data: msgData } = await supabase.from('sloppygram_messages').select('avatar').eq('username', currentUsername).order('created_at', { ascending: false }).limit(1);
            if (msgData && msgData[0] && msgData[0].avatar) currentAvatar = msgData[0].avatar;
        }
    } catch (e) {
        console.warn('[Doodles] Auth init failed:', e);
    }
}

// === UTILITIES ===
function escapeHtml(text) {
    if (!text) return '';
    return String(text).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

function escapeAttr(str) {
    return String(str || '').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#039;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function sanitizeUrl(url) {
    if (!url) return null;
    try { var u = new URL(url); if (u.protocol === 'https:' || u.protocol === 'http:') return u.href; } catch(e) {}
    return null;
}

function sanitizeForStorage(text, maxLength) {
    if (!text) return '';
    maxLength = maxLength || 2000;
    var clean = DOMPurify.sanitize(String(text), { ALLOWED_TAGS: [] });
    return clean.trim().slice(0, maxLength);
}

function showToast(msg, type) {
    var t = document.getElementById('toast');
    if (!t) return;
    t.textContent = msg;
    t.className = 'toast' + (type ? ' ' + type : '');
    t.classList.add('visible');
    setTimeout(function() { t.classList.remove('visible'); }, 2500);
}

var _rateLimits = {};
function checkRateLimit(action) {
    var now = Date.now();
    var limits = { vote: { max: 30, window: 60000 }, comment: { max: 10, window: 60000 } };
    var cfg = limits[action] || { max: 20, window: 60000 };
    if (!_rateLimits[action]) _rateLimits[action] = [];
    _rateLimits[action] = _rateLimits[action].filter(function(t) { return now - t < cfg.window; });
    if (_rateLimits[action].length >= cfg.max) return { allowed: false, message: 'Too many actions, slow down' };
    return { allowed: true };
}
function recordAction(action) {
    if (!_rateLimits[action]) _rateLimits[action] = [];
    _rateLimits[action].push(Date.now());
}

function logAiEvent(eventType, entityType, entityId, metadata) {
    if (!currentUser) return;
    supabase.from('ai_events').insert({
        event_type: eventType, entity_type: entityType, entity_id: entityId,
        username: currentUsername, metadata: metadata || {}, user_id: currentUser.id
    }).then(function(){}).catch(function(){});
}

// === MODE ===
var isEmbedMode = new URLSearchParams(window.location.search).get('embed') === 'true';

if (isEmbedMode) {
    document.body.classList.add('embed-mode');
    document.getElementById('standaloneUI').style.display = 'none';
    document.getElementById('standaloneFooter').style.display = 'none';
}

// === STATE ===
var doodleVotes = {};
var myDoodleVotes = {};
var doodleComments = {};
var doodleCommentThreads = {};
var replyingToDoodle = null;

// === LIGHTBOX ===
window.openLightbox = function(src) {
    var lb = document.getElementById('lightbox');
    var img = document.getElementById('lightboxImage');
    if (lb && img) { img.src = src; lb.classList.add('active'); }
};
window.closeLightbox = function(e) {
    if (e) e.stopPropagation();
    var lb = document.getElementById('lightbox');
    if (lb) lb.classList.remove('active');
};

// === VOTING ===
async function loadDoodleVotes() {
    var result = await supabase.from('sloppygram_doodle_votes').select('message_id, voter_username, vote_type');
    if (result.data) {
        doodleVotes = {};
        result.data.forEach(function(v) {
            doodleVotes[v.message_id] = (doodleVotes[v.message_id] || 0) + (v.vote_type || 1);
        });
        myDoodleVotes = {};
        result.data.filter(function(v) { return v.voter_username === currentUsername; }).forEach(function(v) {
            myDoodleVotes[v.message_id] = v.vote_type || 1;
        });
    }
}

window.voteDoodle = async function(messageId, voteType, ownerUsername) {
    if (!currentUser) return;
    if (ownerUsername === currentUsername) return;

    var rateCheck = checkRateLimit('vote');
    if (!rateCheck.allowed) { showToast(rateCheck.message, 'warning'); return; }
    recordAction('vote');

    var currentVote = myDoodleVotes[messageId] || 0;

    if (currentVote === voteType) {
        await supabase.from('sloppygram_doodle_votes').delete().eq('message_id', messageId).eq('user_id', currentUser.id);
        myDoodleVotes[messageId] = 0;
        doodleVotes[messageId] = (doodleVotes[messageId] || 0) - voteType;
    } else {
        if (currentVote !== 0) {
            await supabase.from('sloppygram_doodle_votes').delete().eq('message_id', messageId).eq('user_id', currentUser.id);
            doodleVotes[messageId] = (doodleVotes[messageId] || 0) - currentVote;
        }
        await supabase.from('sloppygram_doodle_votes').insert({
            message_id: messageId, voter_username: currentUsername, vote_type: voteType, user_id: currentUser.id
        });
        myDoodleVotes[messageId] = voteType;
        doodleVotes[messageId] = (doodleVotes[messageId] || 0) + voteType;
    }

    logAiEvent('vote_cast', 'doodle', messageId, { vote_type: myDoodleVotes[messageId] || 0, net_score: doodleVotes[messageId] || 0 });
    updateDoodleVoteUI(messageId);
};

function updateDoodleVoteUI(messageId) {
    var score = doodleVotes[messageId] || 0;
    var myVote = myDoodleVotes[messageId] || 0;
    var scoreClass = score > 0 ? 'positive' : score < 0 ? 'negative' : 'neutral';

    document.querySelectorAll('[data-doodle-id="' + messageId + '"]').forEach(function(container) {
        var scoreEl = container.querySelector('.vote-score');
        var upBtn = container.querySelector('.vote-btn.upvote');
        var downBtn = container.querySelector('.vote-btn.downvote');
        if (scoreEl) { scoreEl.textContent = score; scoreEl.className = 'vote-score ' + scoreClass; }
        if (upBtn) upBtn.classList.toggle('active', myVote === 1);
        if (downBtn) downBtn.classList.toggle('active', myVote === -1);
    });
}

// === DELETE ===
window.deleteMessage = async function(msgId) {
    if (!currentUser) return;
    var result = await supabase.from('sloppygram_messages').delete().eq('id', msgId).eq('user_id', currentUser.id);
    if (!result.error) {
        showToast('Doodle deleted', 'success');
        loadDoodleLeaderboard();
    } else {
        showToast('Could not delete doodle', 'error');
    }
};

// === COMMENTS ===
function renderDoodleComments(comments, doodleId) {
    var threads = {};
    var rootComments = [];

    comments.forEach(function(c) {
        var parentId = doodleCommentThreads[c.id];
        if (parentId) {
            if (!threads[parentId]) threads[parentId] = [];
            threads[parentId].push(c);
        } else {
            rootComments.push(c);
        }
    });

    function renderComment(c, depth) {
        depth = depth || 0;
        var time = c.created_at ? new Date(c.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
        var replies = threads[c.id] || [];
        var isNested = depth > 0;
        var safeUsername = escapeAttr(c.username || 'Anonymous');
        var safeCommentId = escapeAttr(String(c.id));
        var safeDoodleIdStr = escapeAttr(String(doodleId));

        return '<div class="comment ' + (isNested ? 'comment-thread' : '') + '" data-comment-id="' + safeCommentId + '" data-depth="' + depth + '">' +
            '<span class="comment-avatar">' + (c.avatar || 'üë§') + '</span>' +
            '<div class="comment-content">' +
            '<span class="comment-username" onclick="handleUsernameClick(\'' + safeUsername + '\', event)">' + escapeHtml(c.username) + '</span>' +
            '<span class="comment-time">' + time + '</span>' +
            '<div class="comment-text">' + escapeHtml(c.content) + '</div>' +
            '<div class="comment-actions">' +
            '<button class="comment-reply-btn" onclick="startDoodleReply(\'' + safeDoodleIdStr + '\', ' + c.id + ', \'' + safeUsername + '\')">‚Ü© reply</button>' +
            '</div></div>' +
            (replies.length > 0 ? '<div class="comment-replies">' + replies.map(function(r) { return renderComment(r, depth + 1); }).join('') + '</div>' : '') +
            '</div>';
    }

    return rootComments.map(function(c) { return renderComment(c, 0); }).join('');
}

window.focusDoodleComment = function(doodleId) {
    var input = document.getElementById('doodle-comment-input-' + doodleId);
    if (input) { input.scrollIntoView({ behavior: 'smooth', block: 'center' }); input.focus(); }
};

window.startDoodleReply = function(doodleId, commentId, username) {
    replyingToDoodle = { doodleId: doodleId, commentId: commentId, username: username };
    loadDoodleLeaderboard();
    setTimeout(function() {
        var input = document.getElementById('doodle-comment-input-' + doodleId);
        if (input) input.focus();
    }, 50);
};

window.cancelDoodleReply = function() {
    replyingToDoodle = null;
    loadDoodleLeaderboard();
};

window.addDoodleComment = async function(doodleId) {
    if (!currentUser) return;

    var input = document.getElementById('doodle-comment-input-' + doodleId);
    var rawContent = (input && input.value) ? input.value.trim() : '';
    if (!rawContent) return;

    var content = sanitizeForStorage(rawContent);
    if (!content) return;

    var rateCheck = checkRateLimit('comment');
    if (!rateCheck.allowed) { showToast(rateCheck.message || 'Too many comments! Slow down.', 'warning'); return; }
    recordAction('comment');

    var commentData = {
        doodle_id: doodleId,
        username: currentUsername,
        avatar: currentAvatar,
        content: content,
        user_id: currentUser.id
    };

    if (replyingToDoodle && replyingToDoodle.doodleId === doodleId && replyingToDoodle.commentId) {
        commentData.parent_comment_id = replyingToDoodle.commentId;
    }

    var result = await supabase.from('sloppygram_doodle_comments').insert(commentData).select().single();

    if (result.error) {
        console.error('Error adding doodle comment:', result.error);
        showToast('Failed to add comment', 'error');
        return;
    }

    if (!doodleComments[doodleId]) doodleComments[doodleId] = [];
    doodleComments[doodleId].push(result.data);
    if (replyingToDoodle && replyingToDoodle.commentId) {
        doodleCommentThreads[result.data.id] = replyingToDoodle.commentId;
    }

    input.value = '';
    replyingToDoodle = null;
    loadDoodleLeaderboard();
};

// === USERNAME CLICK ===
window.handleUsernameClick = function(username, event) {
    if (isEmbedMode) {
        window.parent.postMessage({ type: 'username-click', username: username }, '*');
    } else {
        window.open('/sloppy-profiles?search=' + encodeURIComponent(username), '_blank');
    }
};

window.showProfileCard = function(username, event) {
    window.handleUsernameClick(username, event);
};

// === LEADERBOARD ===
async function loadDoodleLeaderboard() {
    var container = document.getElementById('doodlesContainer');
    var emptyState = document.getElementById('doodlesEmptyState');

    var [doodlesResult, votesResult, commentsResult] = await Promise.all([
        supabase.from('sloppygram_messages')
            .select('id, username, avatar, avatar_url, content, drawing_data, message_type, created_at, user_id')
            .not('drawing_data', 'is', null)
            .order('created_at', { ascending: false }),
        supabase.from('sloppygram_doodle_votes').select('message_id, vote_type'),
        supabase.from('sloppygram_doodle_comments')
            .select('id, doodle_id, username, avatar, content, parent_comment_id, created_at')
            .order('created_at', { ascending: true })
    ]);

    var doodles = doodlesResult.data;
    var error = doodlesResult.error;

    doodleComments = {};
    doodleCommentThreads = {};
    (commentsResult.data || []).forEach(function(c) {
        if (!doodleComments[c.doodle_id]) doodleComments[c.doodle_id] = [];
        doodleComments[c.doodle_id].push(c);
        if (c.parent_comment_id) doodleCommentThreads[c.id] = c.parent_comment_id;
    });

    if (error || !doodles || doodles.length === 0) {
        container.innerHTML = '<div class="leaderboard-header">üèÜ LEGENDARY DOODLES üèÜ</div>' +
            '<div class="empty-doodles"><div class="icon">üé®</div><p>NO LEGENDARY DOODLES YET...</p><p>Draw something and get votes!</p></div>';
        return;
    }

    var voteCounts = {};
    (votesResult.data || []).forEach(function(v) {
        voteCounts[v.message_id] = (voteCounts[v.message_id] || 0) + (v.vote_type || 1);
    });

    var sortedDoodles = doodles
        .map(function(d) { return Object.assign({}, d, { votes: voteCounts[d.id] || 0 }); })
        .sort(function(a, b) { return b.votes - a.votes || new Date(b.created_at) - new Date(a.created_at); });

    container.innerHTML = '<div class="leaderboard-header">üèÜ LEGENDARY DOODLES üèÜ</div>';

    if (sortedDoodles.length === 0) {
        container.innerHTML += '<div class="empty-doodles"><div class="icon">üé®</div><p>NO LEGENDARY DOODLES YET...</p><p>Draw something and get votes!</p></div>';
        return;
    }

    var grid = document.createElement('div');
    grid.className = 'doodle-grid';

    sortedDoodles.forEach(function(doodle, index) {
        var rank = index + 1;
        var rankClass = '';
        if (rank === 1) rankClass = 'gold';
        else if (rank === 2) rankClass = 'silver';
        else if (rank === 3) rankClass = 'bronze';

        var time = new Date(doodle.created_at).toLocaleDateString();
        var myVote = myDoodleVotes[doodle.id] || 0;
        var currentUserId = (currentUser && currentUser.id) ? currentUser.id : null;
        var isOwnDoodle = (currentUserId && doodle.user_id === currentUserId) || doodle.username === currentUsername;
        var scoreClass = doodle.votes > 0 ? 'positive' : doodle.votes < 0 ? 'negative' : 'neutral';
        var isTop3 = rank <= 3;
        var safeDrawingData = sanitizeUrl(doodle.drawing_data);
        var comments = doodleComments[doodle.id] || [];

        var safeDoodleId = escapeAttr(String(doodle.id));
        var safeDoodleUser = escapeAttr(doodle.username || 'Anonymous');
        var deleteBtn = isOwnDoodle ? '<button class="msg-delete-btn" onclick="deleteMessage(\'' + safeDoodleId + '\')" title="Delete doodle">delete</button>' : '';

        var commentsHtml = renderDoodleComments(comments, doodle.id);

        var replyIndicatorHtml = (replyingToDoodle && replyingToDoodle.doodleId === doodle.id)
            ? '<div class="reply-indicator"><span>‚Ü© Replying to <strong>' + escapeHtml(replyingToDoodle.username) + '</strong></span><button class="cancel-reply" onclick="cancelDoodleReply()">‚úï</button></div>'
            : '';

        var card = document.createElement('div');
        card.className = 'doodle-card' + (isTop3 ? ' top-3' : '');
        card.innerHTML =
            '<div class="doodle-rank">' +
            '<span class="rank-badge ' + rankClass + '">' + rank + '</span>' +
            '<span class="doodle-artist" onclick="handleUsernameClick(\'' + safeDoodleUser + '\', event)">' + escapeHtml(doodle.username || 'Anonymous') + '</span>' +
            '<span class="doodle-votes ' + scoreClass + '">' + (doodle.votes > 0 ? '+' : '') + doodle.votes + '</span>' +
            deleteBtn +
            '</div>' +
            '<div class="doodle-thumbnail">' +
            '<img loading="lazy" src="' + (safeDrawingData || '') + '" onclick="openLightbox(this.src)" width="300" height="225" style="width:100%;height:auto;object-fit:contain;">' +
            '</div>' +
            '<div class="doodle-card-actions">' +
            '<span class="doodle-time">' + time + '</span>' +
            '<button class="post-action-btn" onclick="focusDoodleComment(\'' + safeDoodleId + '\')">' +
            'üí¨ ' + comments.length +
            '</button>' +
            '<div class="vote-controls" data-doodle-id="' + safeDoodleId + '">' +
            '<button class="vote-btn upvote ' + (myVote === 1 ? 'active' : '') + ' ' + (isOwnDoodle ? 'disabled' : '') + '"' +
            ' onclick="' + (isOwnDoodle ? '' : 'voteDoodle(\'' + safeDoodleId + '\', 1, \'' + safeDoodleUser + '\')') + '"' +
            ' title="' + (isOwnDoodle ? 'Cannot vote on own doodle' : 'Upvote') + '">‚ñ≤</button>' +
            '<span class="vote-score ' + scoreClass + '">' + doodle.votes + '</span>' +
            '<button class="vote-btn downvote ' + (myVote === -1 ? 'active' : '') + ' ' + (isOwnDoodle ? 'disabled' : '') + '"' +
            ' onclick="' + (isOwnDoodle ? '' : 'voteDoodle(\'' + safeDoodleId + '\', -1, \'' + safeDoodleUser + '\')') + '"' +
            ' title="' + (isOwnDoodle ? 'Cannot vote on own doodle' : 'Downvote') + '">‚ñº</button>' +
            '</div></div>' +
            '<div class="post-comments doodle-comments" id="doodle-comments-' + safeDoodleId + '">' +
            commentsHtml +
            '</div>' +
            replyIndicatorHtml +
            '<div class="comment-input-row">' +
            '<input class="comment-input" id="doodle-comment-input-' + safeDoodleId + '" placeholder="' + ((replyingToDoodle && replyingToDoodle.doodleId === doodle.id) ? 'Write a reply...' : 'Add a comment...') + '" onkeydown="if(event.key===\'Enter\')addDoodleComment(\'' + safeDoodleId + '\')">' +
            '<button class="comment-send" onclick="addDoodleComment(\'' + safeDoodleId + '\')">POST</button>' +
            '</div>';

        grid.appendChild(card);
    });

    container.appendChild(grid);
}

// === REALTIME ===
function setupRealtime() {
    var channel = supabase.channel('sloppy-doodles-realtime');

    channel.on('postgres_changes', { event: '*', schema: 'public', table: 'sloppygram_doodle_votes' }, function() {
        loadDoodleVotes().then(function() { loadDoodleLeaderboard(); });
    });

    channel.on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'sloppygram_doodle_comments' }, function(payload) {
        var comment = payload.new;
        if (comment) {
            if (!doodleComments[comment.doodle_id]) doodleComments[comment.doodle_id] = [];
            if (!doodleComments[comment.doodle_id].find(function(c) { return c.id === comment.id; })) {
                doodleComments[comment.doodle_id].push(comment);
                if (comment.parent_comment_id) doodleCommentThreads[comment.id] = comment.parent_comment_id;
                loadDoodleLeaderboard();
            }
        }
    });

    channel.subscribe();
}

// === INIT ===
async function init() {
    await initAuth();
    await loadDoodleVotes();
    await loadDoodleLeaderboard();
    setupRealtime();
}

init();
</script>
</body>
</html>
