<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sloppy Widgets - Confidence Monitor + Presence Pulse</title>
    <meta name="description" content="Live confidence metrics and presence radar for the Sloppy network">
    <meta property="og:title" content="Sloppy Widgets - Confidence + Presence">
    <meta property="og:description" content="Live confidence metrics and presence radar for the Sloppy network">
    <meta property="og:url" content="https://sloppy.live/sloppy-widgets/">
    <meta property="og:image" content="https://emojicdn.elk.sh/üì°.png">
    <link rel="icon" href="https://emojicdn.elk.sh/üì°">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --accent: #7c9885;
            --text-dim: #6a6a75;
            --widget-opacity: 1;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: #0a0a0f;
            color: #e0e0e5;
            min-height: 100vh;
        }

        /* =============================== */
        /* STANDALONE MODE                 */
        /* =============================== */
        .standalone-layout {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 60px;
            padding: 40px 20px;
        }

        .standalone-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, #1a0a2e 0%, #2a1a4a 50%, #1a0a2e 100%);
            border-bottom: 1px solid rgba(138, 43, 226, 0.3);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 100;
        }

        .standalone-title {
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 3px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .standalone-title .diamond { color: #9146ff; animation: diamondGlow 2s ease-in-out infinite; }

        .standalone-back {
            color: var(--text-dim);
            text-decoration: none;
            font-size: 13px;
            transition: color 0.2s;
        }
        .standalone-back:hover { color: #9146ff; }

        .widget-showcase {
            display: flex;
            gap: 80px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 60px;
        }

        .widget-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .widget-label {
            font-size: 11px;
            color: var(--text-dim);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* Make widgets non-fixed in standalone mode */
        .standalone-layout .confidence-monitor,
        .standalone-layout .ghost-radar {
            position: relative;
            bottom: auto;
            left: auto;
            right: auto;
        }

        /* =============================== */
        /* EMBED MODE                      */
        /* =============================== */
        body.embed-mode {
            background: transparent;
        }
        body.embed-mode .standalone-layout { display: none; }

        /* =============================== */
        /* CONFIDENCE MONITOR WIDGET       */
        /* =============================== */
        .confidence-monitor {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #1a1a2e 0%, #0d0d1a 100%);
            border: 2px solid var(--accent);
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.4), inset 0 0 30px rgba(138, 43, 226, 0.1);
            z-index: 9997;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: var(--widget-opacity);
        }
        .confidence-monitor:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(138, 43, 226, 0.6), inset 0 0 40px rgba(138, 43, 226, 0.2);
        }
        .confidence-monitor::before, .confidence-monitor::after {
            content: '‚óÜ';
            position: absolute;
            color: var(--accent);
            font-size: 10px;
            opacity: 0.7;
            animation: diamondGlow 2s ease-in-out infinite;
        }
        .confidence-monitor::before { top: 5px; }
        .confidence-monitor::after { bottom: 5px; }
        .confidence-ring {
            position: absolute;
            width: 90px;
            height: 90px;
            border-radius: 50%;
            border: 2px solid var(--accent);
            opacity: 0.3;
            animation: confidencePulse 3s ease-in-out infinite;
        }
        .confidence-ring-inner {
            position: absolute;
            width: 78px;
            height: 78px;
            border-radius: 50%;
            border: 1px solid rgba(138, 43, 226, 0.4);
            animation: confidencePulse 3s ease-in-out infinite 1.5s;
        }
        @keyframes confidencePulse {
            0%, 100% { opacity: 0.2; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.02); }
        }
        .confidence-value {
            font-size: 24px;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 10px var(--accent);
            z-index: 1;
        }
        .confidence-value.high { color: #0f0; text-shadow: 0 0 10px #0f0; }
        .confidence-value.medium { color: #ff0; text-shadow: 0 0 10px #ff0; }
        .confidence-value.low { color: #f00; text-shadow: 0 0 10px #f00; }
        .confidence-label {
            font-size: 8px;
            color: var(--accent);
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-top: 2px;
            z-index: 1;
        }
        .confidence-status {
            font-size: 7px;
            color: var(--text-dim);
            margin-top: 1px;
            z-index: 1;
        }
        .confidence-pulse {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 1px solid var(--accent);
            animation: confidenceOuterPulse 2s ease-out infinite;
            opacity: 0;
        }
        @keyframes confidenceOuterPulse {
            0% { transform: scale(1); opacity: 0.5; }
            100% { transform: scale(1.3); opacity: 0; }
        }
        @media (max-width: 768px) {
            .confidence-monitor { width: 70px; height: 70px; bottom: 80px; right: 10px; }
            .confidence-ring { width: 62px; height: 62px; }
            .confidence-ring-inner { width: 52px; height: 52px; }
            .confidence-value { font-size: 18px; }
            .confidence-label { font-size: 6px; }
            .confidence-status { display: none; }
        }

        /* =============================== */
        /* GHOST RADAR / PRESENCE PULSE    */
        /* =============================== */
        .ghost-radar {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, #0a1a0a 0%, #001100 70%, #000800 100%);
            border: 2px solid #0f0;
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(0,255,0,0.3), inset 0 0 20px rgba(0,255,0,0.1);
            z-index: 9997;
            overflow: hidden;
            cursor: pointer;
            opacity: var(--widget-opacity);
        }
        .ghost-radar::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 10px;
            height: 10px;
            border: 2px solid rgba(0,255,0,0.6);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: wavePulse 3s ease-out infinite;
        }
        .ghost-radar::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 10px;
            height: 10px;
            border: 2px solid rgba(0,255,0,0.6);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: wavePulse 3s ease-out infinite 1s;
        }
        @keyframes wavePulse {
            0% { width: 10px; height: 10px; opacity: 0.8; border-width: 2px; }
            100% { width: 90%; height: 90%; opacity: 0; border-width: 1px; }
        }
        .ghost-radar-rings {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: #0f0;
            border-radius: 50%;
            box-shadow: 0 0 10px #0f0, 0 0 20px rgba(0,255,0,0.5);
            animation: centerGlow 2s ease-in-out infinite;
        }
        @keyframes centerGlow {
            0%, 100% { box-shadow: 0 0 10px #0f0, 0 0 20px rgba(0,255,0,0.5); }
            50% { box-shadow: 0 0 15px #0f0, 0 0 30px rgba(0,255,0,0.7); }
        }
        .ghost-radar-rings::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 10px;
            height: 10px;
            border: 2px solid rgba(0,255,0,0.6);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: wavePulse 3s ease-out infinite 2s;
        }
        .ghost-radar-rings::after { display: none; }
        .ghost-radar-count {
            position: absolute;
            bottom: -22px;
            left: 50%;
            transform: translateX(-50%);
            background: #001a00;
            border: 1px solid #0f0;
            padding: 2px 8px;
            font-size: 10px;
            color: #0f0;
            font-family: 'Courier New', monospace;
            white-space: nowrap;
            border-radius: 3px;
            text-shadow: 0 0 5px #0f0;
        }
        .ghost-radar-blip {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #0f0;
            border-radius: 50%;
            opacity: 0;
            animation: blipFade 3s ease-out infinite;
            box-shadow: 0 0 8px #0f0;
        }
        @keyframes blipFade {
            0% { opacity: 0.8; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.5); }
        }
        .ghost-radar-label {
            position: absolute;
            top: -18px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 8px;
            color: #0f0;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 0 5px #0f0;
        }
        @media (max-width: 768px) {
            .ghost-radar { bottom: 80px; left: 10px; width: 60px; height: 60px; }
            .ghost-radar-count { font-size: 8px; bottom: -18px; }
            .ghost-radar-label { font-size: 6px; top: -14px; }
        }

        @keyframes diamondGlow {
            0%, 100% { opacity: 0.4; text-shadow: 0 0 5px var(--accent); }
            50% { opacity: 1; text-shadow: 0 0 15px var(--accent), 0 0 25px var(--accent); }
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1a1a2e;
            border: 1px solid var(--accent);
            color: #e0e0e5;
            padding: 10px 16px;
            font-size: 12px;
            border-radius: 4px;
            z-index: 10000;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s;
            pointer-events: none;
        }
        .toast.visible {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <!-- =============================== -->
    <!-- STANDALONE MODE                 -->
    <!-- =============================== -->
    <div class="standalone-layout" id="standaloneLayout">
        <div class="standalone-header">
            <div class="standalone-title">
                <span class="diamond">‚óÜ</span>
                SLOPPY WIDGETS
                <span class="diamond">‚óá</span>
            </div>
            <a href="https://sloppy.live" class="standalone-back">‚Üê sloppy.live</a>
        </div>
        <div class="widget-showcase">
            <div class="widget-card">
                <div class="widget-label">Confidence Monitor</div>
                <div class="confidence-monitor" id="confidenceMonitorStandalone" onclick="cycleConfidenceMode()">
                    <div class="confidence-pulse"></div>
                    <div class="confidence-ring"></div>
                    <div class="confidence-ring-inner"></div>
                    <span class="confidence-value" id="confidenceValueStandalone">--</span>
                    <span class="confidence-label" id="confidenceLabelStandalone">CERTAINTY</span>
                    <span class="confidence-status" id="confidenceStatusStandalone">initializing...</span>
                </div>
            </div>
            <div class="widget-card">
                <div class="widget-label">Presence Pulse</div>
                <div class="ghost-radar" id="ghostRadarStandalone" onclick="ghostRadarPing()">
                    <span class="ghost-radar-label">PRESENCE</span>
                    <div class="ghost-radar-rings"></div>
                    <div id="ghostRadarBlipsStandalone"></div>
                    <span class="ghost-radar-count" id="ghostRadarCountStandalone">0 watching</span>
                </div>
            </div>
        </div>
    </div>

    <!-- =============================== -->
    <!-- EMBED MODE WIDGETS              -->
    <!-- =============================== -->

    <!-- Confidence Monitor -->
    <div class="confidence-monitor" id="confidenceMonitor" onclick="cycleConfidenceMode()" title="Confidence Monitor" style="display:none;">
        <div class="confidence-pulse"></div>
        <div class="confidence-ring"></div>
        <div class="confidence-ring-inner"></div>
        <span class="confidence-value" id="confidenceValue">--</span>
        <span class="confidence-label" id="confidenceLabel">CERTAINTY</span>
        <span class="confidence-status" id="confidenceStatus">initializing...</span>
    </div>

    <!-- Ghost Radar -->
    <div class="ghost-radar" id="ghostRadar" onclick="ghostRadarPing()" title="Presence Pulse" style="display:none;">
        <span class="ghost-radar-label">PRESENCE</span>
        <div class="ghost-radar-rings"></div>
        <div id="ghostRadarBlips"></div>
        <span class="ghost-radar-count" id="ghostRadarCount">0 watching</span>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
    (function() {
        var isEmbed = new URLSearchParams(window.location.search).has('embed');

        // === SUPABASE CLIENT ===
        var _sbLib = window.supabase;
        var SUPABASE_URL = 'https://yjyxteqzhhmtrgcaekgz.supabase.co';
        var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM8IS32IUYR2eenCCjdDdioiBU';
        var sb = (_sbLib && _sbLib.createClient) ? _sbLib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: { persistSession: true, storageKey: 'sloppy-widgets-auth', autoRefreshToken: true, detectSessionInUrl: false }
        }) : null;

        // DOM element IDs based on mode
        var IDS = isEmbed
            ? { value: 'confidenceValue', status: 'confidenceStatus', label: 'confidenceLabel',
                monitor: 'confidenceMonitor', radar: 'ghostRadar', count: 'ghostRadarCount', blips: 'ghostRadarBlips' }
            : { value: 'confidenceValueStandalone', status: 'confidenceStatusStandalone', label: 'confidenceLabelStandalone',
                monitor: 'confidenceMonitorStandalone', radar: 'ghostRadarStandalone', count: 'ghostRadarCountStandalone', blips: 'ghostRadarBlipsStandalone' };

        // Show embed widgets
        if (isEmbed) {
            document.body.classList.add('embed-mode');
            document.getElementById('confidenceMonitor').style.display = 'flex';
            document.getElementById('ghostRadar').style.display = 'block';
        }

        // === TOAST ===
        var toastTimer = null;
        function showToast(msg) {
            var el = document.getElementById('toast');
            if (!el) return;
            el.textContent = msg;
            el.classList.add('visible');
            clearTimeout(toastTimer);
            toastTimer = setTimeout(function() { el.classList.remove('visible'); }, 2500);
        }

        // ==============================================
        // CONFIDENCE MONITOR
        // ==============================================
        var confidenceScore = 0;
        var confidenceMode = 0;
        var confidenceModes = ['SYSTEM', 'ENGAGE', 'SYNTH'];
        var confidenceCache = { votes: 0, reactions: 0, manifestos: 0, lastFetch: 0 };
        var CONFIDENCE_CACHE_TTL = 5 * 60 * 1000;

        // Data passed from parent (embed) or fetched standalone
        var localMessageCount = 0;
        var localPostCount = 0;
        var localOnlineCount = 0;

        async function fetchConfidenceMetrics() {
            if (Date.now() - confidenceCache.lastFetch < 10000) return confidenceCache;

            try {
                var cached = sessionStorage.getItem('confidenceMetrics');
                if (cached) {
                    var parsed = JSON.parse(cached);
                    if (Date.now() - parsed.lastFetch < CONFIDENCE_CACHE_TTL) {
                        confidenceCache = parsed;
                        return confidenceCache;
                    }
                }
            } catch (e) {}

            if (!sb) return confidenceCache;

            try {
                var results = await Promise.all([
                    sb.from('sloppygram_post_likes').select('post_id', { count: 'exact', head: true }),
                    sb.from('sloppygram_post_reactions').select('id', { count: 'exact', head: true }),
                    sb.from('sloppygram_manifestos').select('id, upvotes'),
                    sb.from('sloppygram_message_votes').select('message_id', { count: 'exact', head: true }),
                    sb.from('sloppygram_message_reactions').select('id', { count: 'exact', head: true }),
                    sb.from('sloppygram_manifesto_votes').select('manifesto_id', { count: 'exact', head: true })
                ]);

                var totalVotes = (results[0].count || 0) + (results[3].count || 0);
                var totalReactions = (results[1].count || 0) + (results[4].count || 0);
                var totalManifestoUpvotes = 0;
                if (results[2].data) {
                    results[2].data.forEach(function(m) { totalManifestoUpvotes += (m.upvotes || 0); });
                }
                var manifestoVoteCount = results[5].count || 0;

                confidenceCache = {
                    votes: totalVotes,
                    reactions: totalReactions,
                    manifestos: results[2].data ? results[2].data.length : 0,
                    manifestoUpvotes: totalManifestoUpvotes + manifestoVoteCount,
                    manifestoVoteCount: manifestoVoteCount,
                    lastFetch: Date.now()
                };

                try { sessionStorage.setItem('confidenceMetrics', JSON.stringify(confidenceCache)); } catch (e) {}
            } catch (e) {
                console.warn('Confidence metrics fetch failed:', e);
            }

            return confidenceCache;
        }

        async function calculateConfidence() {
            var factors = [];
            var weights = [];
            var metrics = await fetchConfidenceMetrics();

            if (confidenceMode === 0) {
                var connectionHealth = navigator.onLine ? 95 : 20;
                var dataLoaded = localMessageCount > 0 ? 90 : 40;
                var presenceScore = Math.min(100, 50 + localOnlineCount * 10);
                factors = [connectionHealth, dataLoaded, presenceScore];
                weights = [0.4, 0.3, 0.3];
            } else if (confidenceMode === 1) {
                var contentScore = Math.min(100, 30 + localMessageCount + localPostCount * 3);
                var voteActivity = Math.min(100, 40 + metrics.votes * 1.2);
                var reactionScore = Math.min(100, 50 + metrics.reactions * 1.67);
                factors = [contentScore, voteActivity, reactionScore];
                weights = [0.4, 0.3, 0.3];
            } else {
                var manifestoScore = Math.min(100, 40 + metrics.manifestos * 20);
                var upvoteScore = Math.min(100, 50 + metrics.manifestoUpvotes * 5);
                var totalContent = localMessageCount + localPostCount;
                var diversityRatio = totalContent > 0
                    ? Math.min(localMessageCount, localPostCount * 3) / Math.max(localMessageCount, localPostCount * 3)
                    : 0.5;
                var diversityScore = 50 + diversityRatio * 50;
                factors = [manifestoScore, upvoteScore, diversityScore];
                weights = [0.35, 0.35, 0.3];
            }

            var newScore = 0;
            for (var i = 0; i < factors.length; i++) newScore += factors[i] * weights[i];
            confidenceScore = confidenceScore * 0.6 + newScore * 0.4;
            updateConfidenceDisplay();
        }

        function updateConfidenceDisplay() {
            var valueEl = document.getElementById(IDS.value);
            var statusEl = document.getElementById(IDS.status);
            if (!valueEl || !statusEl) return;

            var displayScore = Math.round(confidenceScore);
            valueEl.textContent = displayScore + '%';
            valueEl.classList.remove('high', 'medium', 'low');
            if (displayScore >= 85) {
                valueEl.classList.add('high');
                statusEl.textContent = 'optimal';
            } else if (displayScore >= 60) {
                valueEl.classList.add('medium');
                statusEl.textContent = 'nominal';
            } else {
                valueEl.classList.add('low');
                statusEl.textContent = 'uncertain';
            }
        }

        window.cycleConfidenceMode = function() {
            confidenceMode = (confidenceMode + 1) % 3;
            var labelEl = document.getElementById(IDS.label);
            if (labelEl) labelEl.textContent = confidenceModes[confidenceMode];
            calculateConfidence();
            var monitor = document.getElementById(IDS.monitor);
            if (monitor) {
                monitor.style.transform = 'scale(1.1)';
                setTimeout(function() { monitor.style.transform = ''; }, 150);
            }
        };

        // ==============================================
        // GHOST RADAR
        // ==============================================
        var ghostRadarUsers = [];
        var ghostRadarCache = { lastCount: -1 };

        function updateGhostRadar(presenceState) {
            var users = [];
            var seen = {};
            if (presenceState) {
                Object.values(presenceState).forEach(function(presences) {
                    presences.forEach(function(p) {
                        if (!seen[p.username]) {
                            seen[p.username] = true;
                            users.push(p);
                        }
                    });
                });
            }
            ghostRadarUsers = users;
            localOnlineCount = users.length;
            renderGhostRadar();
        }

        function renderGhostRadar() {
            var countEl = document.getElementById(IDS.count);
            var blipsEl = document.getElementById(IDS.blips);
            if (!countEl || !blipsEl) return;

            var ghostCount = ghostRadarUsers.length;
            if (ghostCount === ghostRadarCache.lastCount) return;
            ghostRadarCache.lastCount = ghostCount;

            countEl.textContent = ghostCount + ' watching';

            var maxBlips = Math.min(ghostCount, 8);
            var blipsHtml = '';
            for (var i = 0; i < maxBlips; i++) {
                var angle = (i / maxBlips) * Math.PI * 2 + Math.random() * 0.5;
                var radius = 15 + Math.random() * 20;
                var x = 40 + Math.cos(angle) * radius - 3;
                var y = 40 + Math.sin(angle) * radius - 3;
                blipsHtml += '<div class="ghost-radar-blip" style="left:' + x + 'px;top:' + y + 'px;animation-delay:' + (i * 0.3) + 's;"></div>';
            }
            blipsEl.innerHTML = blipsHtml;
        }

        window.ghostRadarPing = function() {
            var ghostCount = ghostRadarUsers.length;
            if (ghostCount === 0) showToast('üëª No ghosts detected...');
            else if (ghostCount === 1) showToast('üëª 1 silent lurker detected!');
            else showToast('üëª ' + ghostCount + ' ghosts in the shadows!');
        };

        // ==============================================
        // INITIALIZATION
        // ==============================================

        // Start confidence monitor
        updateConfidenceDisplay();
        setTimeout(function() { calculateConfidence(); }, 1500);
        setInterval(calculateConfidence, 5000);

        // Start ghost radar render loop
        setInterval(renderGhostRadar, 5000);

        // Standalone: subscribe to presence channel directly
        if (!isEmbed && sb) {
            var presenceChannel = sb.channel('sloppygram_presence');
            presenceChannel.on('presence', { event: 'sync' }, function() {
                updateGhostRadar(presenceChannel.presenceState());
            });
            presenceChannel.subscribe(function(status) {
                if (status === 'SUBSCRIBED') {
                    presenceChannel.track({ username: 'widget-viewer', status: 'watching' });
                }
            });
        }

        // ==============================================
        // postMessage BRIDGE (embed mode)
        // ==============================================
        window.addEventListener('message', function(e) {
            if (!e.data || !e.data.type) return;

            // Presence state sync from parent
            if (e.data.type === 'presence-sync') {
                updateGhostRadar(e.data.state);
            }

            // Content counts for confidence calculations
            if (e.data.type === 'content-counts') {
                localMessageCount = e.data.messageCount || 0;
                localPostCount = e.data.postCount || 0;
                localOnlineCount = e.data.onlineCount || 0;
            }

            // Force confidence recalculation (e.g., after a vote)
            if (e.data.type === 'refresh-confidence') {
                confidenceCache.lastFetch = 0;
                calculateConfidence();
            }

            // Widget opacity from parent theme
            if (e.data.type === 'set-widget-opacity') {
                document.documentElement.style.setProperty('--widget-opacity', e.data.opacity || 1);
            }

            // Accent color from parent theme
            if (e.data.type === 'set-accent') {
                document.documentElement.style.setProperty('--accent', e.data.accent || '#7c9885');
            }
        });

        // Notify parent we're ready
        if (window.parent !== window) {
            window.parent.postMessage({ type: 'widgets-ready' }, '*');
        }
    })();
    </script>
</body>
</html>
