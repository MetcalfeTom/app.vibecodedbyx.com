<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Orangutan Slurp · Zookeeper Challenge</title>

    <meta name="description" content="Help the zookeeper slurp up as many flanged orangutans as possible in this hilarious and challenging game!" />
    <meta property="og:title" content="Orangutan Slurp · Zookeeper Challenge" />
    <meta property="og:description" content="Help the zookeeper slurp up as many flanged orangutans as possible in this hilarious and challenging game!" />
    <meta property="og:image" content="./og-image.svg" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Orangutan Slurp · Zookeeper Challenge" />
    <meta name="twitter:description" content="Help the zookeeper slurp up as many flanged orangutans as possible in this hilarious and challenging game!" />
    <meta name="twitter:image" content="./og-image.svg" />
    <link rel="icon" href="./favicon.svg" type="image/svg+xml" />

    <style>
      :root {
        --bg: #0b0e10;
        --card: #13171a;
        --ink: #eef2f6;
        --muted: #aab3bd;
        --pho: #ffedd5;
        --accent: #22c55e;
        --btn: #1f2937;
      }
      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        color: var(--ink);
        background-color: #0d1320;
        background: linear-gradient(180deg, #3a1c2c 0%, #70373d 30%, #1a2538 100%),
          radial-gradient(circle at 20% 18%, rgba(255, 215, 155, 0.3) 0%, rgba(215, 152, 120, 0.25) 32%, transparent 58%),
          radial-gradient(circle at 74% 14%, rgba(186, 120, 150, 0.25) 0%, transparent 46%);
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-size: cover;
        display: flex; align-items: center; justify-content: center;
        position: relative;
        overflow: hidden;
      }
      body::before {
        content: '';
        position: fixed;
        inset: -4%;
        background:
          radial-gradient(circle at 16% 22%, rgba(255, 181, 102, 0.14) 0%, transparent 52%),
          radial-gradient(circle at 78% 24%, rgba(223, 118, 151, 0.16) 0%, transparent 48%),
          linear-gradient(180deg, rgba(12, 18, 29, 0.0) 0%, rgba(12, 18, 29, 0.35) 100%);
        opacity: 0.9;
        pointer-events: none;
        transform-origin: center;
        animation: duskDrift 28s ease-in-out infinite alternate;
        z-index: 0;
      }
      @keyframes duskDrift {
        0% { transform: translate3d(-1.5%, -1.8%, 0) scale(1.02); opacity: 0.8; }
        100% { transform: translate3d(1.6%, 1.8%, 0) scale(1.045); opacity: 0.95; }
      }
      @keyframes orangutanFloat {
        0% { transform: translate3d(0, 0, 0) rotate(0deg); }
        25% { transform: translate3d(4px, -6px, 0) rotate(-1.5deg); }
        50% { transform: translate3d(-5px, -3px, 0) rotate(1.2deg); }
        75% { transform: translate3d(3px, 5px, 0) rotate(-1deg); }
        100% { transform: translate3d(0, 0, 0) rotate(0deg); }
      }
      .wrap { width: min(1000px, 96vw); padding: 20px; position: relative; z-index: 1; }
      header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
      .brand { display: flex; align-items: center; gap: 10px; font-weight: 900; }
      .brand .logo { width: 28px; height: 28px; border-radius: 6px; display:grid;place-items:center; background:#0ea5e9; }
      .row { display: grid; grid-template-columns: 1fr; gap: 16px; }
      @media (min-width: 900px) { .row { grid-template-columns: 1.2fr 1fr; } }
      .card { background: var(--card); border: 1px solid #23313a; border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.03); }
      .hud { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
      .pill { background: #0f1418; border: 1px solid #23313a; border-radius: 999px; padding: 8px 12px; font-weight: 600; }
      .btn { border: 1px solid #2b3540; background: linear-gradient(180deg, #26313a, #1a232a); color: var(--ink); padding: 14px 18px; border-radius: 14px; cursor: pointer; touch-action: manipulation; }
      .btn.primary { background: linear-gradient(180deg, #22c55e, #16a34a); color: #04110a; font-weight: 900; border-color: #0b5c2d; }
      .btn.primary.slurp-start { box-shadow: 0 12px 24px rgba(34, 197, 94, 0.35); letter-spacing: 0.04em; text-transform: uppercase; }
      .btn.primary.slurp-start:hover { filter: brightness(1.05); }
      .muted { color: var(--muted); }
      .link { color: #22c55e; text-decoration: none; }

      .game { text-align: center; position: relative; overflow: hidden; }
      .leaderboard { display: grid; gap: 18px; }
      .leader-section h3 { margin-top: 0; }
      .pho {
        font-size: clamp(80px, 22vw, 180px);
        line-height: 1;
        filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.5));
        animation: orangutanFloat 3.6s ease-in-out infinite;
        transform-origin: center;
        will-change: transform;
      }
      .slurp { font-size: clamp(18px, 5vw, 28px); padding: 16px 22px; border-radius: 16px; }
      .stats { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-top: 10px; }
      .unlocks { margin-top: 18px; display: grid; gap: 10px; text-align: left; }
      .unlock-title { font-size: 15px; font-weight: 700; }
      .unlock-list { display: grid; gap: 10px; }
      .unlock-ribbon { display: grid; gap: 8px; padding: 12px 14px; border-radius: 14px; border: 1px solid rgba(255,255,255,0.06); background: rgba(12,18,29,0.55); box-shadow: inset 0 1px 0 rgba(255,255,255,0.03); transition: border-color 240ms ease, background 240ms ease, transform 240ms ease; }
      .unlock-ribbon.locked { opacity: 0.55; filter: grayscale(0.25); }
      .unlock-ribbon.unlocked { border-color: rgba(34, 197, 94, 0.45); background: rgba(34, 197, 94, 0.12); transform: translateY(-2px); }
      .unlock-meta { display:flex; gap:10px; align-items:center; font-size:14px; color: var(--muted); }
      .unlock-meta strong { font-size:16px; color: var(--ink); display:block; }
      .unlock-badge { width: 36px; height: 36px; border-radius: 12px; display:grid; place-items:center; background: rgba(255,255,255,0.08); box-shadow: inset 0 1px 0 rgba(255,255,255,0.05); font-size: 20px; }
      .npc-space { min-height:92px; display:flex; justify-content:center; transition:opacity 180ms ease; }
      .npc-event { display:flex; gap:12px; align-items:flex-start; background:rgba(14,20,24,0.75); border:1px solid rgba(34,197,94,0.25); margin-top:16px; padding:14px; border-radius:14px; box-shadow:0 12px 30px rgba(0,0,0,0.35); backdrop-filter:blur(8px); transition:opacity 180ms ease, transform 180ms ease; max-width:360px; width:100%; }
      .npc-event.hidden { opacity:0; transform:translateY(6px); pointer-events:none; }
      .npc-avatar { width:44px; height:44px; border-radius:12px; display:grid; place-items:center; background:#1f2937; font-size:26px; box-shadow:inset 0 0 0 1px rgba(255,255,255,0.04), 0 6px 20px rgba(0,0,0,0.35); }
      .npc-copy { flex:1; display:flex; flex-direction:column; gap:4px; }
      .npc-name { font-weight:800; font-size:16px; }
      .npc-line { color:var(--pho); font-size:15px; line-height:1.4; }

      .leaderboard ol { margin: 0; padding-left: 18px; }
      .leaderboard li { padding: 4px 0; }
      footer { margin-top: 16px; text-align: center; font-size: 14px; color: var(--muted); }

      .pho-explosion { position: absolute; inset: 0; pointer-events: none; }
      .pho-spark {
        position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%) scale(0);
        font-size: clamp(26px, 6vw, 46px); filter: drop-shadow(0 6px 16px rgba(0,0,0,0.45));
        animation: phoSpark 900ms cubic-bezier(0.16, 1, 0.3, 1) forwards;
        animation-delay: var(--delay, 0s);
      }
      .pho-shockwave {
        position: absolute; left: 50%; top: 50%; width: 160px; height: 160px;
        border: 4px solid rgba(34, 197, 94, 0.45); border-radius: 999px;
        transform: translate(-50%, -50%) scale(0.2);
        animation: phoShockwave 650ms ease-out forwards;
      }
      body.pho-shake .wrap { animation: phoShake 480ms cubic-bezier(0.36, 0.07, 0.19, 0.97); }

      @keyframes phoSpark {
        0% { transform: translate(-50%, -50%) scale(0.3); opacity: 1; }
        65% { opacity: 1; }
        100% { transform: translate(calc(-50% + var(--tx, 0px)), calc(-50% + var(--ty, 0px))) scale(0.8) rotate(var(--rot, 0deg)); opacity: 0; }
      }
      @keyframes phoShockwave {
        0% { transform: translate(-50%, -50%) scale(0.2); opacity: 0.8; }
        100% { transform: translate(-50%, -50%) scale(2.4); opacity: 0; }
      }
      @keyframes phoShake {
        0%, 100% { transform: translate3d(0, 0, 0); }
        20% { transform: translate3d(-6px, 4px, 0); }
        40% { transform: translate3d(7px, -6px, 0); }
        60% { transform: translate3d(-5px, 3px, 0); }
        80% { transform: translate3d(4px, -5px, 0); }
      }

      @supports (padding: max(0px)) { body { padding-bottom: max(env(safe-area-inset-bottom), 0px); } }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div class="brand">
          <div class="logo">🦧</div>          <div>
            <div>Orangutan Slurp</div>
            <small style="display:block; font-size:13px; color:var(--muted); letter-spacing:0.12em; text-transform:uppercase;">Zookeeper Challenge</small>
          </div></div>
        <div class="hud">
          <div id="auth" class="muted">Loading…</div>
          <button id="signin" class="btn" style="display:none">Sign in with Twitter</button>
          <button id="signout" class="btn" style="display:none">Sign out</button>
        </div>
      </header>

      <div class="row">
        <section class="card game">
          <div class="pho" id="pho" aria-label="Orangutan">🦧</div>
          <div class="stats">
            <div class="pill">Time: <span id="time">20</span>s</div>
            <div class="pill">Bowls: <span id="bowls">0</span></div>
            <div class="pill">Best: <span id="best">0</span></div>
          </div>
          <div class="npc-space">
            <div id="npc" class="npc-event hidden" aria-live="polite" aria-hidden="true" role="status">
              <div id="npc-avatar" class="npc-avatar" aria-hidden="true">🧡</div>
              <div class="npc-copy">
                <div id="npc-name" class="npc-name"></div>
                <div id="npc-line" class="npc-line"></div>
              </div>
            </div>
          </div>
          <div style="margin-top:12px">
          <button id="start" class="btn primary slurp-start">Start Slurping Orangutans</button>
            <button id="slurp" class="btn slurp" style="display:none">Slurp!</button>
          </div>
        <p>You slurped <span id="score">0</span> orangutans in <span id="final-time">0</span> seconds!</p>
        </section>

        <aside class="card leaderboard">
          <div class="leader-section">
            <h3>Top Pho Fans</h3>
            <ol id="leaders"></ol>
            <p class="muted">Leaderboard updates live.</p>
          </div>
          <div class="unlocks" aria-live="polite" aria-label="Score unlocks">
            <div class="unlock-title">Unlocks</div>
            <div id="unlock-list" class="unlock-list"></div>
          </div>
        </aside>
      </div>

      <footer>
        <a class="link" href="https://www.vibecodedbyx.com" target="_blank" rel="noopener">Back to the livestream</a>
      </footer>
    </div>

    <!-- Dummy nodes for supabase-config.js example -->
    <div id="premium-content" style="display:none"></div>
    <div id="upgrade-button" style="display:none"></div>

    <script type="module">
      import supabase, { supabaseSession } from './supabase-config.js';

      const els = {
        auth: document.getElementById('auth'),
        signin: document.getElementById('signin'),
        signout: document.getElementById('signout'),
        start: document.getElementById('start'),
        slurp: document.getElementById('slurp'),
        time: document.getElementById('time'),
        finalTime: document.getElementById('final-time'),
        bowls: document.getElementById('bowls'),
        best: document.getElementById('best'),
        pho: document.getElementById('pho'),
        leaders: document.getElementById('leaders'),
        npc: document.getElementById('npc'),
        npcAvatar: document.getElementById('npc-avatar'),
        npcName: document.getElementById('npc-name'),
        npcLine: document.getElementById('npc-line'),
        unlockList: document.getElementById('unlock-list'),
      };

      const UNLOCKS = [
        { score: 50, icon: '🥈', title: 'Junior Zookeeper', detail: 'Slurp 50 orangutans for a permanent spot in the primate house.' },
        { score: 100, icon: '🥇', title: 'Primate Protector', detail: '100 slurps unlocks extra bananas and a nod from the head zookeeper.' },
        { score: 150, icon: '🏆', title: 'Orangutan Whisperer', detail: '150 slurps makes you a legend among the flanged ones.' },
      ];

      const escapeHtml = (text) => String(text ?? '').replace(/[&<>'"]/g, (ch) => {
        switch (ch) {
          case '&': return '&amp;';
          case '<': return '&lt;';
          case '>': return '&gt;';
          case '"': return '&quot;';
          case "'": return '&#39;';
          default: return ch;
        }
      });

      const npcCast = [
        {
          name: 'Head Zookeeper Bob',
          avatar: '👨‍🌾',
          lines: [
            'No double dipping the banana puree! Wait—actually, go nuts.',
            'I prepared this puree for 12 hours, slurp like it owes you rent!',
            'Puree temp is perfect. Don’t let science down now.',
          ],
        },
        {
          name: 'Drone Handler 7',
          avatar: '🤖',
          lines: [
            'Calculating orangutan velocity... chaotic good.',
            'Warning: excessive slurping may open a wormhole to banana heaven.',
            'Battery low, but morale high. Keep slurping for both of us.',
          ],
        },
        {
          name: 'Elder Jane',
          avatar: '🧓',
          lines: [
            'In my day we slurped uphill both ways and still beat this score.',
            'I tucked a banana under your chair. For courage.',
            'If you beat your best, I’ll finally share the secret fruit.',
          ],
        },
        {
          name: 'Zoolife Influencer Nova',
          avatar: '🎥',
          lines: [
            'I’m livestreaming your slurp face to 40k viewers. Make it iconic.',
            'Trending hashtag idea: #OrangutanNirvana. You in?',
            'I brought ring lights and fruit. Viral content unlocked.',
          ],
        },
      ];

      const npcEvents = {
        sessionStart: [
          'Heard you logged in—hope your slurp stamina did too.',
          'Fresh puree, fresh you. Let’s see that orangutan form.',
        ],
        finale: [
          'Timer’s toast, but the puree lives forever in memory.',
          'Orangutan gods nod approvingly. Screenshot that score!',
        ],
      };

      const START_TIME = 20;

      let state = {
        session: null,
        user: null,
        running: false,
        bowls: 0,
        best: 0,
        timeLeft: START_TIME,
        timerId: null,
        npcTimeout: null,
        npcAmbientTimeout: null,
        unlocksAchieved: new Set(),
      };
      const explosionIcons = ['🦧', '🍌', '🐒', '🌴', '🌳', '🧡'];

      function vibrate(p=10){ try{ if(navigator.vibrate) navigator.vibrate(p) }catch{} }

      function renderUnlocks(bestScore) {
        if (!els.unlockList) return;
        const best = bestScore ?? 0;
        const html = UNLOCKS.map((unlock) => {
          const unlocked = best >= unlock.score;
          if (unlocked) state.unlocksAchieved.add(unlock.score);
          const statusClass = unlocked ? 'unlocked' : 'locked';
          const statusCopy = unlocked ? 'Unlocked' : `Unlock at ${unlock.score} bowls`;
          return `
            <div class="unlock-ribbon ${statusClass}">
              <div class="unlock-meta">
                <span class="unlock-badge">${escapeHtml(unlock.icon)}</span>
                <span><strong>${escapeHtml(unlock.title)}</strong><br />${escapeHtml(statusCopy)}</span>
              </div>
              <div class="muted">${escapeHtml(unlock.detail)}</div>
            </div>
          `;
        }).join('');
        els.unlockList.innerHTML = html;
      }

      function celebrateUnlock(scoreAchieved) {
        const unlocked = UNLOCKS.find((entry) => entry.score === scoreAchieved);
        if (!unlocked) return;
        showNpc(
          {
            name: 'Unlock Agent',
            avatar: '🔓',
            lines: [
              `Unlocked: ${unlocked.title}!`,
              unlocked.detail,
            ],
          },
          `Unlocked: ${unlocked.title}!`
        );
      }

      async function loadBest() {
        if (!state.user) return 0;
        const { data, error } = await supabase
          .from('pho_scores')
          .select('bowls')
          .eq('user_id', state.user.id)
          .single();
        if (error && error.code !== 'PGRST116') console.error('Best load error:', error.message);
        return data?.bowls ?? 0;
      }

      async function saveBestIfImproved() {
        if (!state.user) return;
        const latest = state.bowls || 0;
        const currentBest = state.best || 0;
        const nextBest = Math.max(currentBest, latest);

        if (nextBest === 0) {
          state.best = 0;
          els.best.textContent = '0';
          return;
        }

        const { data: existingRows, error: readError } = await supabase
          .from('pho_scores')
          .select('bowls')
          .eq('user_id', state.user.id)
          .limit(1);

        if (readError && readError.code !== 'PGRST116') {
          console.error('Score read error:', readError.message);
          return;
        }

        const existing = existingRows?.[0];

        if (!existing) {
          const { error: insertError } = await supabase
            .from('pho_scores')
            .insert({ user_id: state.user.id, bowls: nextBest });
          if (insertError) {
            console.error('Score insert error:', insertError.message);
            return;
          }
        } else if (nextBest > (existing.bowls ?? 0)) {
          const { error: updateError } = await supabase
            .from('pho_scores')
            .update({ bowls: nextBest })
            .eq('user_id', state.user.id);
          if (updateError) {
            console.error('Score update error:', updateError.message);
            return;
          }
        }

        state.best = nextBest;
        els.best.textContent = String(state.best);
        const thresholdsPassed = UNLOCKS
          .filter((unlock) => nextBest >= unlock.score && !state.unlocksAchieved.has(unlock.score))
          .map((unlock) => unlock.score);
        renderUnlocks(state.best);
        thresholdsPassed.forEach(celebrateUnlock);
        await refreshLeaders();
      }

      async function refreshLeaders() {
        const { data, error } = await supabase
          .from('pho_scores')
          .select('bowls, user_id')
          .order('bowls', { ascending: false })
          .limit(10);
        if (error) { console.error('Leaders error:', error.message); return; }
        const rows = data || [];
        const ids = rows.map((r) => r.user_id).filter(Boolean);
        const nameLookup = {};

        if (ids.length) {
          const { data: profiles, error: profileError } = await supabase
            .from('users')
            .select('user_id, display_name, twitter_handle')
            .in('user_id', ids);
          if (profileError) {
            console.error('Leader profile error:', profileError.message);
          } else {
            for (const profile of profiles) {
              const displayName = profile.display_name?.trim();
              const twitter = profile.twitter_handle?.trim();
              const handle = twitter ? (twitter.startsWith('@') ? twitter : `@${twitter}`) : '';
              const label = displayName || handle;
              if (label) nameLookup[profile.user_id] = label;
            }
          }
        }

        els.leaders.innerHTML = rows
          .map((r, i) => {
            const fallback = `…${String(r.user_id ?? '').slice(-6)}`;
            const label = nameLookup[r.user_id] || fallback;
            return `<li>#${i + 1} <strong>${escapeHtml(r.bowls)}</strong> — ${escapeHtml(label)}</li>`;
          })
          .join('');
      }

      function setRunning(r) {
        state.running = r;
        els.start.style.display = r ? 'none' : 'inline-block';
        els.slurp.style.display = r ? 'inline-block' : 'none';
        if (!r) clearNpcTimers();
      }

      function resetGame(){
        state.bowls = 0;
        state.timeLeft = START_TIME;
        els.bowls.textContent = '0';
        els.time.textContent = String(START_TIME);
        if (els.finalTime) els.finalTime.textContent = '0';
        hideNpc();
        setRunning(false);
      }

      async function startGame(){
        resetGame();
        setRunning(true);
        maybeSpawnNpc('sessionStart');
        queueAmbientNpc();
        let elapsedSeconds = 0;
        state.timerId = setInterval(async ()=>{
          state.timeLeft -= 1;
          elapsedSeconds += 1;
          els.time.textContent = String(state.timeLeft);
          if (els.finalTime) els.finalTime.textContent = String(elapsedSeconds);
          if (state.timeLeft <= 0) {
            clearInterval(state.timerId);
            setRunning(false);
            maybeSpawnNpc('finale');
            await saveBestIfImproved();
            vibrate([20,40,20]);
            if (els.finalTime) els.finalTime.textContent = String(elapsedSeconds);
          }
        }, 1000);
      }

      function triggerExplosion(){
        const shell = document.createElement('div');
        shell.className = 'pho-explosion';
        const sparks = 14;
        for (let i = 0; i < sparks; i += 1) {
          const spark = document.createElement('span');
          spark.className = 'pho-spark';
          spark.textContent = explosionIcons[(i + state.bowls) % explosionIcons.length];
          const angle = (Math.PI * 2 * i) / sparks;
          const distance = 90 + Math.random() * 90;
          spark.style.setProperty('--tx', `${Math.cos(angle) * distance}px`);
          spark.style.setProperty('--ty', `${Math.sin(angle) * distance}px`);
          spark.style.setProperty('--rot', `${Math.random() * 720 - 360}deg`);
          spark.style.setProperty('--delay', `${Math.random() * 0.08}s`);
          shell.appendChild(spark);
        }
        const shockwave = document.createElement('div');
        shockwave.className = 'pho-shockwave';
        shell.appendChild(shockwave);
        els.pho.parentElement?.appendChild(shell);
        document.body.classList.add('pho-shake');
        setTimeout(()=>document.body.classList.remove('pho-shake'), 500);
        setTimeout(()=>shell.remove(), 1100);
      }

      function doSlurp(){
        if(!state.running) return;
        state.bowls+=1;
        els.bowls.textContent=String(state.bowls);
        vibrate(8);
        els.pho.animate([{transform:'scale(1)'},{transform:'scale(1.05)'},{transform:'scale(1)'}],{duration:120});
        if (state.bowls > 0 && state.bowls % 20 === 0) {
          triggerExplosion();
          vibrate([50, 20, 70, 20, 150]);
          maybeSpawnNpc('milestone');
        }
        maybeSpawnNpc('slurp');
      }

      function clearNpcTimers(){
        if (state.npcTimeout) { clearTimeout(state.npcTimeout); state.npcTimeout = null; }
        if (state.npcAmbientTimeout) { clearTimeout(state.npcAmbientTimeout); state.npcAmbientTimeout = null; }
      }

      function hideNpc(){
        els.npc.classList.add('hidden');
        els.npc.setAttribute('aria-hidden','true');
        clearNpcTimers();
      }

      function showNpc(npc, line){
        els.npcAvatar.textContent = npc.avatar;
        els.npcName.textContent = npc.name;
        els.npcLine.textContent = line;
        els.npc.setAttribute('aria-hidden','false');
        requestAnimationFrame(()=>{ els.npc.classList.remove('hidden'); });
        if (state.npcTimeout) clearTimeout(state.npcTimeout);
        state.npcTimeout = setTimeout(()=>{
          els.npc.classList.add('hidden');
          state.npcTimeout = setTimeout(()=>{ els.npc.setAttribute('aria-hidden','true'); clearNpcTimers(); queueAmbientNpc(); }, 220);
        }, 3600);
      }

      function pickNpcLine(pool){
        const npc = pool ?? npcCast[Math.floor(Math.random()*npcCast.length)];
        const line = npc.lines[Math.floor(Math.random()*npc.lines.length)];
        return { npc, line };
      }

      function queueAmbientNpc(){
        if (!state.running) return;
        if (state.npcAmbientTimeout) clearTimeout(state.npcAmbientTimeout);
        const delay = 3500 + Math.random()*5000;
        state.npcAmbientTimeout = setTimeout(()=>{
          state.npcAmbientTimeout = null;
          if (!state.running) return;
          if (!isNpcHidden()) { queueAmbientNpc(); return; }
          const { npc, line } = pickNpcLine();
          showNpc(npc, line);
        }, delay);
      }

      function maybeSpawnNpc(trigger){
        if (els.npc && !isNpcHidden() && trigger!=='finale') return;
        if (!state.running && trigger!=='finale' && trigger!=='sessionStart') return;

        const chance = trigger === 'milestone' ? 1 : trigger === 'sessionStart' ? 1 : trigger === 'finale' ? 1 : 0.12;
        if (Math.random() > chance) {
          if (trigger === 'sessionStart' || trigger === 'finale') {
            const pool = {
              name: 'Announcer',
              avatar: '📣',
              lines: npcEvents[trigger] ?? ['Back in the broth soon!'],
            };
            const line = pool.lines[Math.floor(Math.random()*pool.lines.length)];
            showNpc(pool, line);
          }
          return;
        }

        if (trigger === 'sessionStart' || trigger === 'finale') {
          const announcer = {
            name: trigger === 'sessionStart' ? 'Head Zookeeper Bob' : 'DJ Orangutan Drop',
            avatar: trigger === 'sessionStart' ? '👨‍🌾' : '🎶',
            lines: npcEvents[trigger],
          };
          const line = announcer.lines[Math.floor(Math.random()*announcer.lines.length)];
          showNpc(announcer, line);
          return;
        }

        const { npc, line } = pickNpcLine();
        showNpc(npc, line);
      }

      function isNpcHidden(){
        return els.npc.classList.contains('hidden');
      }

      async function init(){
        const { session, user } = await supabaseSession();
        state.session = session; state.user = user;
        els.auth.textContent = `Signed in: …${String(user.id).slice(-6)}`;
        els.signout.style.display = 'inline-block'; els.signin.style.display = 'none';
        els.signout.onclick = async ()=>{ await supabase.auth.signOut(); location.reload(); };

        state.best = await loadBest(); els.best.textContent = String(state.best);
        state.unlocksAchieved = new Set(UNLOCKS.filter((unlock)=>state.best>=unlock.score).map((unlock)=>unlock.score));
        renderUnlocks(state.best);
        await refreshLeaders();
        supabase.channel('pho_scores').on('postgres_changes', { event:'*', schema:'public', table:'pho_scores' }, refreshLeaders).subscribe();

        els.start.addEventListener('click', startGame);
        els.slurp.addEventListener('click', doSlurp);
        els.slurp.addEventListener('touchstart', (e)=>{ e.preventDefault(); doSlurp(); }, { passive:false });
      }

      renderUnlocks(0);
      init().catch(err=>{ console.error(err); els.auth.textContent='Auth error'; });
    </script>
  </body>
</html>
