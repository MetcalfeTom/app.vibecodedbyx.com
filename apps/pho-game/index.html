<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pho Slurp ‚Äî Eat Pho Fast</title>

    <!-- Social Sharing -->
    <meta property="og:title" content="Pho Slurp ‚Äî Eat Pho Fast" />
    <meta property="og:description" content="Tap to slurp pho bowls in 20s. Climb the global leaderboard!" />
    <meta property="og:image" content="./og.svg" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Pho Slurp ‚Äî Eat Pho Fast" />
    <meta name="twitter:description" content="Tap to slurp pho bowls in 20s. Climb the global leaderboard!" />
    <meta name="twitter:image" content="./og.svg" />
    <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="0.9em" font-size="90">üçú</text></svg>' />

    <style>
      :root {
        --bg: #0b0e10;
        --card: #13171a;
        --ink: #eef2f6;
        --muted: #aab3bd;
        --pho: #ffedd5;
        --accent: #22c55e;
        --btn: #1f2937;
      }
      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        color: var(--ink);
        background: radial-gradient(1200px 800px at 50% -20%, #16212a 0%, var(--bg) 55%);
        display: flex; align-items: center; justify-content: center;
      }
      .wrap { width: min(1000px, 96vw); padding: 20px; }
      header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
      .brand { display: flex; align-items: center; gap: 10px; font-weight: 900; }
      .brand .logo { width: 28px; height: 28px; border-radius: 6px; display:grid;place-items:center; background:#0ea5e9; }
      .row { display: grid; grid-template-columns: 1fr; gap: 16px; }
      @media (min-width: 900px) { .row { grid-template-columns: 1.2fr 1fr; } }
      .card { background: var(--card); border: 1px solid #23313a; border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.03); }
      .hud { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
      .pill { background: #0f1418; border: 1px solid #23313a; border-radius: 999px; padding: 8px 12px; font-weight: 600; }
      .btn { border: 1px solid #2b3540; background: linear-gradient(180deg, #26313a, #1a232a); color: var(--ink); padding: 14px 18px; border-radius: 14px; cursor: pointer; touch-action: manipulation; }
      .btn.primary { background: linear-gradient(180deg, #22c55e, #16a34a); color: #04110a; font-weight: 900; border-color: #0b5c2d; }
      .muted { color: var(--muted); }
      .link { color: #22c55e; text-decoration: none; }

      .game { text-align: center; position: relative; overflow: hidden; }
      .pho { font-size: clamp(80px, 22vw, 180px); line-height: 1; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5)); }
      .slurp { font-size: clamp(18px, 5vw, 28px); padding: 16px 22px; border-radius: 16px; }
      .stats { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-top: 10px; }
      .npc-space { min-height:92px; display:flex; justify-content:center; transition:opacity 180ms ease; }
      .npc-event { display:flex; gap:12px; align-items:flex-start; background:rgba(14,20,24,0.75); border:1px solid rgba(34,197,94,0.25); margin-top:16px; padding:14px; border-radius:14px; box-shadow:0 12px 30px rgba(0,0,0,0.35); backdrop-filter:blur(8px); transition:opacity 180ms ease, transform 180ms ease; max-width:360px; width:100%; }
      .npc-event.hidden { opacity:0; transform:translateY(6px); pointer-events:none; }
      .npc-avatar { width:44px; height:44px; border-radius:12px; display:grid; place-items:center; background:#1f2937; font-size:26px; box-shadow:inset 0 0 0 1px rgba(255,255,255,0.04), 0 6px 20px rgba(0,0,0,0.35); }
      .npc-copy { flex:1; display:flex; flex-direction:column; gap:4px; }
      .npc-name { font-weight:800; font-size:16px; }
      .npc-line { color:var(--pho); font-size:15px; line-height:1.4; }

      .leaderboard ol { margin: 0; padding-left: 18px; }
      .leaderboard li { padding: 4px 0; }
      footer { margin-top: 16px; text-align: center; font-size: 14px; color: var(--muted); }

      .pho-explosion { position: absolute; inset: 0; pointer-events: none; }
      .pho-spark {
        position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%) scale(0);
        font-size: clamp(26px, 6vw, 46px); filter: drop-shadow(0 6px 16px rgba(0,0,0,0.45));
        animation: phoSpark 900ms cubic-bezier(0.16, 1, 0.3, 1) forwards;
        animation-delay: var(--delay, 0s);
      }
      .pho-shockwave {
        position: absolute; left: 50%; top: 50%; width: 160px; height: 160px;
        border: 4px solid rgba(34, 197, 94, 0.45); border-radius: 999px;
        transform: translate(-50%, -50%) scale(0.2);
        animation: phoShockwave 650ms ease-out forwards;
      }
      body.pho-shake .wrap { animation: phoShake 480ms cubic-bezier(0.36, 0.07, 0.19, 0.97); }

      @keyframes phoSpark {
        0% { transform: translate(-50%, -50%) scale(0.3); opacity: 1; }
        65% { opacity: 1; }
        100% { transform: translate(calc(-50% + var(--tx, 0px)), calc(-50% + var(--ty, 0px))) scale(0.8) rotate(var(--rot, 0deg)); opacity: 0; }
      }
      @keyframes phoShockwave {
        0% { transform: translate(-50%, -50%) scale(0.2); opacity: 0.8; }
        100% { transform: translate(-50%, -50%) scale(2.4); opacity: 0; }
      }
      @keyframes phoShake {
        0%, 100% { transform: translate3d(0, 0, 0); }
        20% { transform: translate3d(-6px, 4px, 0); }
        40% { transform: translate3d(7px, -6px, 0); }
        60% { transform: translate3d(-5px, 3px, 0); }
        80% { transform: translate3d(4px, -5px, 0); }
      }

      @supports (padding: max(0px)) { body { padding-bottom: max(env(safe-area-inset-bottom), 0px); } }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div class="brand"><div class="logo"></div><div>Pho Slurp</div></div>
        <div class="hud">
          <div id="auth" class="muted">Loading‚Ä¶</div>
          <button id="signin" class="btn" style="display:none">Sign in with Twitter</button>
          <button id="signout" class="btn" style="display:none">Sign out</button>
        </div>
      </header>

      <div class="row">
        <section class="card game">
          <div class="pho" id="pho" aria-label="Pho bowl">üçú</div>
          <div class="stats">
            <div class="pill">Time: <span id="time">20</span>s</div>
            <div class="pill">Bowls: <span id="bowls">0</span></div>
            <div class="pill">Best: <span id="best">0</span></div>
          </div>
          <div class="npc-space">
            <div id="npc" class="npc-event hidden" aria-live="polite" aria-hidden="true" role="status">
              <div id="npc-avatar" class="npc-avatar" aria-hidden="true">üß°</div>
              <div class="npc-copy">
                <div id="npc-name" class="npc-name"></div>
                <div id="npc-line" class="npc-line"></div>
              </div>
            </div>
          </div>
          <div style="margin-top:12px">
            <button id="start" class="btn primary slurp">Start Slurping</button>
            <button id="slurp" class="btn slurp" style="display:none">Slurp!</button>
          </div>
          <p class="muted" style="margin-top:10px">Tap Slurp! to finish bowls before the timer ends. Best score saves and appears on the leaderboard.</p>
        </section>

        <aside class="card leaderboard">
          <h3>Top Pho Fans</h3>
          <ol id="leaders"></ol>
          <p class="muted">Leaderboard updates live.</p>
        </aside>
      </div>

      <footer>
        <a class="link" href="https://www.vibecodedbyx.com" target="_blank" rel="noopener">Back to the livestream</a>
      </footer>
    </div>

    <!-- Dummy nodes for supabase-config.js example -->
    <div id="premium-content" style="display:none"></div>
    <div id="upgrade-button" style="display:none"></div>

    <script type="module">
      import supabase, { supabaseSession } from './supabase-config.js';

      const els = {
        auth: document.getElementById('auth'),
        signin: document.getElementById('signin'),
        signout: document.getElementById('signout'),
        start: document.getElementById('start'),
        slurp: document.getElementById('slurp'),
        time: document.getElementById('time'),
        bowls: document.getElementById('bowls'),
        best: document.getElementById('best'),
        pho: document.getElementById('pho'),
        leaders: document.getElementById('leaders'),
        npc: document.getElementById('npc'),
        npcAvatar: document.getElementById('npc-avatar'),
        npcName: document.getElementById('npc-name'),
        npcLine: document.getElementById('npc-line'),
      };

      const npcCast = [
        {
          name: 'Chef Linh',
          avatar: 'üë©‚Äçüç≥',
          lines: [
            'No double dipping the chili oil! Wait‚Äîactually, go nuts.',
            'I simmered this broth for 12 hours, slurp like it owes you rent!',
            'Broth temp is perfect. Don‚Äôt let science down now.',
          ],
        },
        {
          name: 'Delivery Drone 7',
          avatar: 'ü§ñ',
          lines: [
            'Calculating noodle velocity... chaotic good.',
            'Warning: excessive slurping may open a wormhole to flavor town.',
            'Battery low, but morale high. Keep slurping for both of us.',
          ],
        },
        {
          name: 'Grandma Mai',
          avatar: 'üßì',
          lines: [
            'In my day we slurped uphill both ways and still beat this score.',
            'I tucked a lime wedge under your chair. For courage.',
            'If you beat your best, I‚Äôll finally share the secret herb.',
          ],
        },
        {
          name: 'Phofluencer Nova',
          avatar: 'üé•',
          lines: [
            'I‚Äôm livestreaming your slurp face to 40k viewers. Make it iconic.',
            'Trending hashtag idea: #NoodleNirvana. You in?',
            'I brought ring lights and chopsticks. Viral content unlocked.',
          ],
        },
      ];

      const npcEvents = {
        sessionStart: [
          'Heard you logged in‚Äîhope your slurp stamina did too.',
          'Fresh bowl, fresh you. Let‚Äôs see that noodle form.',
        ],
        finale: [
          'Timer‚Äôs toast, but the broth lives forever in memory.',
          'Pho gods nod approvingly. Screenshot that score!',
        ],
      };

      let state = {
        session: null,
        user: null,
        running: false,
        bowls: 0,
        best: 0,
        timeLeft: 20,
        timerId: null,
        npcTimeout: null,
        npcAmbientTimeout: null,
      };
      const explosionIcons = ['üçú', 'üî•', 'ü•¢', 'üí•', 'üå∂Ô∏è', '‚ú®'];

      function vibrate(p=10){ try{ if(navigator.vibrate) navigator.vibrate(p) }catch{} }

      async function loadBest() {
        if (!state.user) return 0;
        const { data, error } = await supabase
          .from('pho_scores')
          .select('bowls')
          .eq('user_id', state.user.id)
          .single();
        if (error && error.code !== 'PGRST116') console.error('Best load error:', error.message);
        return data?.bowls ?? 0;
      }

      async function saveBestIfImproved() {
        if (!state.user) return;
        const nextBest = Math.max(state.best||0, state.bowls||0);
        const { error } = await supabase
          .from('pho_scores')
          .upsert({ user_id: state.user.id, bowls: nextBest }, { onConflict: 'user_id' });
        if (error) console.error('Save error:', error.message);
        state.best = nextBest; els.best.textContent = String(state.best);
        await refreshLeaders();
      }

      async function refreshLeaders() {
        const { data, error } = await supabase
          .from('pho_scores')
          .select('bowls, user_id')
          .order('bowls', { ascending: false })
          .limit(10);
        if (error) { console.error('Leaders error:', error.message); return; }
        els.leaders.innerHTML = (data||[]).map((r,i)=>`<li>#${i+1} <strong>${r.bowls}</strong> ‚Äî ‚Ä¶${String(r.user_id).slice(-6)}</li>`).join('');
      }

      function setRunning(r) {
        state.running = r;
        els.start.style.display = r ? 'none' : 'inline-block';
        els.slurp.style.display = r ? 'inline-block' : 'none';
        if (!r) clearNpcTimers();
      }

      function resetGame(){
        state.bowls=0;
        state.timeLeft=20;
        els.bowls.textContent='0';
        els.time.textContent='20';
        hideNpc();
        setRunning(false);
      }

      async function startGame(){
        resetGame();
        setRunning(true);
        maybeSpawnNpc('sessionStart');
        queueAmbientNpc();
        state.timerId = setInterval(async ()=>{
          state.timeLeft -= 1; els.time.textContent = String(state.timeLeft);
          if (state.timeLeft <= 0) {
            clearInterval(state.timerId);
            setRunning(false);
            maybeSpawnNpc('finale');
            await saveBestIfImproved();
            vibrate([20,40,20]);
          }
        }, 1000);
      }

      function triggerExplosion(){
        const shell = document.createElement('div');
        shell.className = 'pho-explosion';
        const sparks = 14;
        for (let i = 0; i < sparks; i += 1) {
          const spark = document.createElement('span');
          spark.className = 'pho-spark';
          spark.textContent = explosionIcons[(i + state.bowls) % explosionIcons.length];
          const angle = (Math.PI * 2 * i) / sparks;
          const distance = 90 + Math.random() * 90;
          spark.style.setProperty('--tx', `${Math.cos(angle) * distance}px`);
          spark.style.setProperty('--ty', `${Math.sin(angle) * distance}px`);
          spark.style.setProperty('--rot', `${Math.random() * 720 - 360}deg`);
          spark.style.setProperty('--delay', `${Math.random() * 0.08}s`);
          shell.appendChild(spark);
        }
        const shockwave = document.createElement('div');
        shockwave.className = 'pho-shockwave';
        shell.appendChild(shockwave);
        els.pho.parentElement?.appendChild(shell);
        document.body.classList.add('pho-shake');
        setTimeout(()=>document.body.classList.remove('pho-shake'), 500);
        setTimeout(()=>shell.remove(), 1100);
      }

      function doSlurp(){
        if(!state.running) return;
        state.bowls+=1;
        els.bowls.textContent=String(state.bowls);
        vibrate(8);
        els.pho.animate([{transform:'scale(1)'},{transform:'scale(1.05)'},{transform:'scale(1)'}],{duration:120});
        if (state.bowls > 0 && state.bowls % 20 === 0) {
          triggerExplosion();
          vibrate([50, 20, 70, 20, 150]);
          maybeSpawnNpc('milestone');
        }
        maybeSpawnNpc('slurp');
      }

      function clearNpcTimers(){
        if (state.npcTimeout) { clearTimeout(state.npcTimeout); state.npcTimeout = null; }
        if (state.npcAmbientTimeout) { clearTimeout(state.npcAmbientTimeout); state.npcAmbientTimeout = null; }
      }

      function hideNpc(){
        els.npc.classList.add('hidden');
        els.npc.setAttribute('aria-hidden','true');
        clearNpcTimers();
      }

      function showNpc(npc, line){
        els.npcAvatar.textContent = npc.avatar;
        els.npcName.textContent = npc.name;
        els.npcLine.textContent = line;
        els.npc.setAttribute('aria-hidden','false');
        requestAnimationFrame(()=>{ els.npc.classList.remove('hidden'); });
        if (state.npcTimeout) clearTimeout(state.npcTimeout);
        state.npcTimeout = setTimeout(()=>{
          els.npc.classList.add('hidden');
          state.npcTimeout = setTimeout(()=>{ els.npc.setAttribute('aria-hidden','true'); clearNpcTimers(); queueAmbientNpc(); }, 220);
        }, 3600);
      }

      function pickNpcLine(pool){
        const npc = pool ?? npcCast[Math.floor(Math.random()*npcCast.length)];
        const line = npc.lines[Math.floor(Math.random()*npc.lines.length)];
        return { npc, line };
      }

      function queueAmbientNpc(){
        if (!state.running) return;
        if (state.npcAmbientTimeout) clearTimeout(state.npcAmbientTimeout);
        const delay = 3500 + Math.random()*5000;
        state.npcAmbientTimeout = setTimeout(()=>{
          state.npcAmbientTimeout = null;
          if (!state.running) return;
          if (!isNpcHidden()) { queueAmbientNpc(); return; }
          const { npc, line } = pickNpcLine();
          showNpc(npc, line);
        }, delay);
      }

      function maybeSpawnNpc(trigger){
        if (els.npc && !isNpcHidden() && trigger!=='finale') return;
        if (!state.running && trigger!=='finale' && trigger!=='sessionStart') return;

        const chance = trigger === 'milestone' ? 1 : trigger === 'sessionStart' ? 1 : trigger === 'finale' ? 1 : 0.12;
        if (Math.random() > chance) {
          if (trigger === 'sessionStart' || trigger === 'finale') {
            const pool = {
              name: 'Announcer',
              avatar: 'üì£',
              lines: npcEvents[trigger] ?? ['Back in the broth soon!'],
            };
            const line = pool.lines[Math.floor(Math.random()*pool.lines.length)];
            showNpc(pool, line);
          }
          return;
        }

        if (trigger === 'sessionStart' || trigger === 'finale') {
          const announcer = {
            name: trigger === 'sessionStart' ? 'Chef Linh' : 'DJ Broth Drop',
            avatar: trigger === 'sessionStart' ? 'üë©‚Äçüç≥' : 'üé∂',
            lines: npcEvents[trigger],
          };
          const line = announcer.lines[Math.floor(Math.random()*announcer.lines.length)];
          showNpc(announcer, line);
          return;
        }

        const { npc, line } = pickNpcLine();
        showNpc(npc, line);
      }

      function isNpcHidden(){
        return els.npc.classList.contains('hidden');
      }

      async function init(){
        const { session, user } = await supabaseSession();
        state.session = session; state.user = user;
        els.auth.textContent = `Signed in: ‚Ä¶${String(user.id).slice(-6)}`;
        els.signout.style.display = 'inline-block'; els.signin.style.display = 'none';
        els.signout.onclick = async ()=>{ await supabase.auth.signOut(); location.reload(); };

        state.best = await loadBest(); els.best.textContent = String(state.best);
        await refreshLeaders();
        supabase.channel('pho_scores').on('postgres_changes', { event:'*', schema:'public', table:'pho_scores' }, refreshLeaders).subscribe();

        els.start.addEventListener('click', startGame);
        els.slurp.addEventListener('click', doSlurp);
        els.slurp.addEventListener('touchstart', (e)=>{ e.preventDefault(); doSlurp(); }, { passive:false });
      }

      init().catch(err=>{ console.error(err); els.auth.textContent='Auth error'; });
    </script>
  </body>
</html>
