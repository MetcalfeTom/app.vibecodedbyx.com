<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DB Visualizer</title>
  <link rel="icon" href="https://emojicdn.elk.sh/üóÑÔ∏è">
  <meta property="og:title" content="DB Visualizer">
  <meta property="og:description" content="Full CRUD database explorer with search, sort, and pagination">
  <meta property="og:url" content="https://sloppy.live/db-visualizer">
  <meta property="og:image" content="https://emojicdn.elk.sh/üóÑÔ∏è?style=google">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --border: #30363d;
      --text: #c9d1d9;
      --text-dim: #8b949e;
      --accent: #58a6ff;
      --accent-dim: rgba(88, 166, 255, 0.1);
      --green: #3fb950;
      --yellow: #d29922;
      --purple: #a371f7;
      --red: #f85149;
    }

    body {
      min-height: 100vh;
      background: var(--bg);
      font-family: 'JetBrains Mono', monospace;
      color: var(--text);
      font-size: 13px;
    }

    .layout { display: grid; grid-template-columns: 280px 1fr; min-height: 100vh; }
    .sidebar { background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
    .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); }
    .logo { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 14px; color: var(--accent); }
    .logo span { font-size: 20px; }
    .sidebar-actions { display: flex; gap: 8px; margin-top: 15px; }
    .search-box { margin-top: 12px; }
    .search-box input { width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 10px 12px; color: var(--text); font-family: inherit; font-size: 12px; }
    .search-box input:focus { outline: none; border-color: var(--accent); }
    .search-box input::placeholder { color: var(--text-dim); }
    .table-list { flex: 1; overflow-y: auto; padding: 10px; }
    .table-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 6px; cursor: pointer; transition: all 0.15s ease; color: var(--text-dim); }
    .table-item:hover { background: var(--accent-dim); color: var(--text); }
    .table-item.active { background: var(--accent-dim); color: var(--accent); }
    .table-item .icon { opacity: 0.6; }
    .table-item .name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .table-item .count { font-size: 11px; color: var(--text-dim); background: var(--bg); padding: 2px 8px; border-radius: 10px; }

    .main { display: flex; flex-direction: column; overflow: hidden; }
    .main-header { padding: 20px 25px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: var(--surface); flex-wrap: wrap; gap: 15px; }
    .table-title { font-size: 16px; font-weight: 700; }
    .header-actions { display: flex; gap: 10px; flex-wrap: wrap; }

    .toolbar { display: flex; gap: 15px; padding: 15px 25px; border-bottom: 1px solid var(--border); background: var(--surface); align-items: center; flex-wrap: wrap; }
    .toolbar-group { display: flex; align-items: center; gap: 8px; }
    .toolbar-label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
    .data-search { background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 8px 12px; color: var(--text); font-family: inherit; font-size: 12px; width: 200px; }
    .data-search:focus { outline: none; border-color: var(--accent); }
    .data-search::placeholder { color: var(--text-dim); }

    .tabs { display: flex; gap: 5px; padding: 15px 25px; border-bottom: 1px solid var(--border); background: var(--surface); }
    .tab { padding: 8px 16px; border-radius: 6px; cursor: pointer; color: var(--text-dim); transition: all 0.15s ease; }
    .tab:hover { color: var(--text); }
    .tab.active { background: var(--accent-dim); color: var(--accent); }

    .content { flex: 1; overflow: auto; padding: 20px 25px; }

    .data-table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .data-table th { text-align: left; padding: 12px 15px; background: var(--surface); border-bottom: 1px solid var(--border); color: var(--text-dim); font-weight: 500; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px; position: sticky; top: 0; cursor: pointer; user-select: none; transition: color 0.15s; }
    .data-table th:hover { color: var(--accent); }
    .data-table th.sorted { color: var(--accent); }
    .data-table th .sort-icon { margin-left: 5px; opacity: 0.5; }
    .data-table th.sorted .sort-icon { opacity: 1; }
    .data-table td { padding: 12px 15px; border-bottom: 1px solid var(--border); max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .data-table tr:hover td { background: var(--accent-dim); }
    .row-actions { display: flex; gap: 8px; opacity: 0; transition: opacity 0.15s; }
    .data-table tr:hover .row-actions { opacity: 1; }

    .pagination { display: flex; align-items: center; gap: 15px; padding: 15px 25px; border-top: 1px solid var(--border); background: var(--surface); justify-content: space-between; flex-wrap: wrap; }
    .pagination-info { font-size: 12px; color: var(--text-dim); }
    .pagination-controls { display: flex; gap: 8px; align-items: center; }
    .page-btn { background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 6px 12px; color: var(--text); font-family: inherit; font-size: 12px; cursor: pointer; transition: all 0.15s ease; }
    .page-btn:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); }
    .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .page-btn.active { background: var(--accent); border-color: var(--accent); color: var(--bg); }
    .page-size-select { background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 6px 10px; color: var(--text); font-family: inherit; font-size: 12px; }

    .btn { background: var(--accent-dim); border: 1px solid var(--border); border-radius: 6px; padding: 8px 14px; color: var(--text); font-family: inherit; font-size: 12px; cursor: pointer; transition: all 0.15s ease; display: inline-flex; align-items: center; gap: 6px; }
    .btn:hover { background: var(--surface); border-color: var(--accent); color: var(--accent); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--accent); border-color: var(--accent); color: var(--bg); }
    .btn-primary:hover { background: #79b8ff; }
    .btn-danger { border-color: var(--red); color: var(--red); }
    .btn-danger:hover { background: rgba(248, 81, 73, 0.15); }
    .btn-success { border-color: var(--green); color: var(--green); }
    .btn-success:hover { background: rgba(63, 185, 80, 0.15); }
    .btn-sm { padding: 5px 10px; font-size: 11px; }

    .type-tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; }
    .type-text { background: rgba(88, 166, 255, 0.15); color: var(--accent); }
    .type-int { background: rgba(63, 185, 80, 0.15); color: var(--green); }
    .type-bool { background: rgba(210, 153, 34, 0.15); color: var(--yellow); }
    .type-uuid { background: rgba(163, 113, 247, 0.15); color: var(--purple); }
    .type-time { background: rgba(248, 81, 73, 0.15); color: var(--red); }
    .type-json { background: rgba(255, 255, 255, 0.1); color: var(--text); }

    .null-value { color: var(--text-dim); font-style: italic; }
    .json-value { color: var(--yellow); cursor: pointer; }
    .uuid-value { color: var(--purple); font-size: 11px; }
    .highlight { background: rgba(255, 190, 11, 0.3); padding: 1px 2px; border-radius: 2px; }

    .loading { display: flex; align-items: center; justify-content: center; height: 200px; color: var(--text-dim); }
    .spinner { width: 30px; height: 30px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-right: 15px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-dim); }
    .empty-state .icon { font-size: 48px; margin-bottom: 15px; opacity: 0.5; }
    .schema-view { display: grid; gap: 10px; }
    .schema-row { display: grid; grid-template-columns: 200px 150px 1fr; gap: 15px; padding: 12px 15px; background: var(--surface); border-radius: 8px; border: 1px solid var(--border); }
    .schema-row .col-name { font-weight: 500; color: var(--accent); }

    .back-link { display: block; padding: 15px 20px; color: var(--text-dim); text-decoration: none; font-size: 11px; border-top: 1px solid var(--border); transition: color 0.15s; }
    .back-link:hover { color: var(--accent); }

    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
    .modal-content { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; max-width: 600px; width: 100%; max-height: 85vh; overflow: auto; }
    .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: 700; }
    .modal-body { padding: 20px; }
    .modal-footer { padding: 15px 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }
    .close-btn { background: none; border: none; color: var(--text-dim); font-size: 24px; cursor: pointer; line-height: 1; }
    .close-btn:hover { color: var(--text); }

    .form-group { margin-bottom: 18px; }
    .form-group label { display: block; color: var(--text-dim); font-size: 11px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 12px; color: var(--text); font-family: inherit; font-size: 13px; }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: var(--accent); }
    .form-group textarea { min-height: 80px; resize: vertical; }

    .column-builder { display: flex; flex-direction: column; gap: 12px; }
    .column-row { display: grid; grid-template-columns: 1fr 120px 40px; gap: 10px; align-items: center; }
    .column-row input, .column-row select { background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 10px; color: var(--text); font-family: inherit; font-size: 12px; }
    .remove-col-btn { background: none; border: none; color: var(--red); font-size: 18px; cursor: pointer; padding: 5px; }
    .remove-col-btn:hover { color: #ff7b72; }

    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 8px; font-size: 13px; z-index: 200; animation: slideUp 0.3s ease; }
    .toast-success { background: var(--green); color: #000; }
    .toast-error { background: var(--red); color: #fff; }
    @keyframes slideUp { from { opacity: 0; transform: translateX(-50%) translateY(20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }

    .warning-box { background: rgba(248, 81, 73, 0.1); border: 1px solid var(--red); border-radius: 8px; padding: 15px; margin-bottom: 20px; color: var(--red); font-size: 12px; }
    .info-box { background: rgba(88, 166, 255, 0.1); border: 1px solid var(--accent); border-radius: 8px; padding: 15px; margin-bottom: 20px; color: var(--accent); font-size: 12px; }

    @media (max-width: 800px) {
      .layout { grid-template-columns: 1fr; }
      .sidebar { display: none; }
      .column-row { grid-template-columns: 1fr 100px 30px; }
      .toolbar { flex-direction: column; align-items: stretch; }
      .data-search { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo"><span>üóÑÔ∏è</span> DB Visualizer</div>
        <div class="sidebar-actions">
          <button class="btn btn-success btn-sm" onclick="showCreateTableModal()" style="flex:1">+ New Table</button>
        </div>
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="Search tables...">
        </div>
      </div>
      <div class="table-list" id="tableList">
        <div class="loading"><div class="spinner"></div></div>
      </div>
      <a href="https://sloppy.live" class="back-link">‚Üê sloppy.live</a>
    </aside>

    <main class="main">
      <div class="main-header">
        <div class="table-title" id="tableTitle">Select a table</div>
        <div class="header-actions" id="headerActions"></div>
      </div>
      <div class="toolbar" id="toolbar" style="display:none">
        <div class="toolbar-group">
          <span class="toolbar-label">Search:</span>
          <input type="text" class="data-search" id="dataSearch" placeholder="Filter rows...">
        </div>
        <div class="toolbar-group">
          <span class="toolbar-label">Per page:</span>
          <select class="page-size-select" id="pageSizeSelect">
            <option value="25">25</option>
            <option value="50" selected>50</option>
            <option value="100">100</option>
            <option value="250">250</option>
          </select>
        </div>
      </div>
      <div class="tabs">
        <div class="tab active" data-tab="data">Data</div>
        <div class="tab" data-tab="schema">Schema</div>
      </div>
      <div class="content" id="content">
        <div class="empty-state">
          <div class="icon">üìä</div>
          <p>Select a table from the sidebar to view its contents</p>
        </div>
      </div>
      <div class="pagination" id="pagination" style="display:none">
        <div class="pagination-info" id="paginationInfo"></div>
        <div class="pagination-controls" id="paginationControls"></div>
      </div>
    </main>
  </div>

  <!-- Create Table Modal -->
  <div class="modal" id="createTableModal" style="display:none">
    <div class="modal-content">
      <div class="modal-header">
        <span>Create New Table</span>
        <button class="close-btn" onclick="closeModal('createTableModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="info-box">Tables auto-include: user_id, created_at, updated_at columns with RLS policies.</div>
        <div class="form-group">
          <label>Table Name</label>
          <input type="text" id="newTableName" placeholder="my_table_name" pattern="[a-z_]+" />
        </div>
        <div class="form-group">
          <label>Columns</label>
          <div class="column-builder" id="columnBuilder">
            <div class="column-row">
              <input type="text" placeholder="column_name" class="col-name" />
              <select class="col-type">
                <option value="text">text</option>
                <option value="integer">integer</option>
                <option value="boolean">boolean</option>
                <option value="jsonb">jsonb</option>
              </select>
              <button class="remove-col-btn" onclick="this.parentElement.remove()">√ó</button>
            </div>
          </div>
          <button class="btn btn-sm" style="margin-top:10px" onclick="addColumnRow()">+ Add Column</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal('createTableModal')">Cancel</button>
        <button class="btn btn-primary" onclick="createTable()">Create Table</button>
      </div>
    </div>
  </div>

  <!-- Add Row Modal -->
  <div class="modal" id="addRowModal" style="display:none">
    <div class="modal-content">
      <div class="modal-header">
        <span>Add New Row</span>
        <button class="close-btn" onclick="closeModal('addRowModal')">&times;</button>
      </div>
      <div class="modal-body" id="addRowForm"></div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal('addRowModal')">Cancel</button>
        <button class="btn btn-primary" onclick="insertRow()">Insert Row</button>
      </div>
    </div>
  </div>

  <!-- Edit Row Modal -->
  <div class="modal" id="editRowModal" style="display:none">
    <div class="modal-content">
      <div class="modal-header">
        <span>Edit Row</span>
        <button class="close-btn" onclick="closeModal('editRowModal')">&times;</button>
      </div>
      <div class="modal-body" id="editRowForm"></div>
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="deleteCurrentRow()">Delete Row</button>
        <button class="btn" onclick="closeModal('editRowModal')">Cancel</button>
        <button class="btn btn-primary" onclick="updateRow()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Delete Table Modal -->
  <div class="modal" id="deleteTableModal" style="display:none">
    <div class="modal-content">
      <div class="modal-header">
        <span>Delete Table</span>
        <button class="close-btn" onclick="closeModal('deleteTableModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="warning-box">‚ö†Ô∏è This will permanently delete the table and ALL its data. This cannot be undone!</div>
        <div class="form-group">
          <label>Type table name to confirm: <strong id="confirmTableName"></strong></label>
          <input type="text" id="deleteTableConfirm" placeholder="table_name" />
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal('deleteTableModal')">Cancel</button>
        <button class="btn btn-danger" onclick="deleteTable()">Delete Forever</button>
      </div>
    </div>
  </div>

  <!-- JSON Modal -->
  <div class="modal" id="jsonModal" style="display:none">
    <div class="modal-content">
      <div class="modal-header">
        <span>JSON Data</span>
        <button class="close-btn" onclick="closeModal('jsonModal')">&times;</button>
      </div>
      <div class="modal-body">
        <pre id="jsonContent" style="white-space:pre-wrap;word-break:break-all;color:var(--yellow);font-size:12px;line-height:1.6"></pre>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = 'https://yjyxteqzhhmtrgcaekgz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM8IS32IUYR2eenCCjdDdioiBU';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let TABLES = [];
    let currentTable = null;
    let currentTab = 'data';
    let tableData = {};
    let tableCounts = {};
    let currentUser = null;
    let editingRow = null;

    // Pagination & sorting state
    let currentPage = 1;
    let pageSize = 50;
    let totalRows = 0;
    let sortColumn = null;
    let sortDirection = 'asc';
    let searchTerm = '';
    let allData = [];

    async function initAuth() {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        currentUser = session.user;
      } else {
        const { data } = await supabase.auth.signInAnonymously();
        if (data.session) currentUser = data.session.user;
      }
    }

    async function fetchTables() {
      const knownTables = [
        "accountability_goals", "app_votes", "bouldering_scores", "breakout_terminal_scores",
        "button_presses", "chat_messages", "chat_messages_staging", "claude_diary_entries",
        "confessions", "cosmic_messages", "daily_quests", "feedback", "feedback_votes",
        "git_info", "global_stats", "gratitude_entries", "guestbook", "guestbook_entries",
        "icy_tower_scores", "kanban_tasks", "knowledge_messages", "laptop_fire_scores",
        "leaderboard_scores", "live_chat_messages", "lofi_beat_votes", "lofi_beats",
        "medieval_romance_progress", "minecraft_blocks", "model_analytics", "mouse_mood_feedback",
        "notes", "ouija_sessions", "ouija_sessions_ai", "pho_scores", "quest_entries",
        "simple_chat_messages", "simpsons_road_rage_scores", "star_catcher_leaderboard",
        "tasks", "test_table", "tetris_leaderboard", "user_dragons", "user_inventory",
        "user_stats", "users", "web_snapshots"
      ];
      TABLES = knownTables;
    }

    async function loadTableCounts() {
      for (const table of TABLES) {
        try {
          const { count } = await supabase.from(table).select('*', { count: 'exact', head: true });
          tableCounts[table] = count || 0;
        } catch (e) {
          tableCounts[table] = '?';
        }
      }
      renderTableList();
    }

    function renderTableList(filter = '') {
      const list = document.getElementById('tableList');
      const filtered = TABLES.filter(t => t.toLowerCase().includes(filter.toLowerCase()));

      list.innerHTML = filtered.map(table => `
        <div class="table-item ${currentTable === table ? 'active' : ''}" data-table="${table}">
          <span class="icon">üìã</span>
          <span class="name">${table}</span>
          <span class="count">${tableCounts[table] ?? '...'}</span>
        </div>
      `).join('');

      list.querySelectorAll('.table-item').forEach(item => {
        item.addEventListener('click', () => selectTable(item.dataset.table));
      });
    }

    async function selectTable(table) {
      currentTable = table;
      currentPage = 1;
      sortColumn = 'created_at'; // Default sort by created_at
      sortDirection = 'desc';    // Newest first
      searchTerm = '';
      document.getElementById('dataSearch').value = '';

      renderTableList(document.getElementById('searchInput').value);

      document.getElementById('tableTitle').textContent = table;
      document.getElementById('content').innerHTML = '<div class="loading"><div class="spinner"></div> Loading...</div>';
      document.getElementById('toolbar').style.display = 'flex';
      document.getElementById('pagination').style.display = 'flex';

      document.getElementById('headerActions').innerHTML = `
        <button class="btn btn-success" onclick="showAddRowModal()">+ Add Row</button>
        <button class="btn" onclick="window.refreshTable()">‚Üª Refresh</button>
        <button class="btn btn-danger" onclick="showDeleteTableModal()">üóë Delete Table</button>
      `;

      try {
        // Get total count
        const { count } = await supabase.from(table).select('*', { count: 'exact', head: true });
        totalRows = count || 0;

        // Fetch data ordered by created_at desc (newest first) - up to 1000 rows
        const { data, error } = await supabase
          .from(table)
          .select('*')
          .order('created_at', { ascending: false, nullsFirst: false })
          .limit(1000);

        if (error) throw error;

        allData = data || [];
        tableData[table] = allData;

        // Check if table has created_at column, if not reset sort
        if (allData.length > 0 && !('created_at' in allData[0])) {
          sortColumn = null;
          sortDirection = 'asc';
        }

        renderContent();
        renderPagination();
      } catch (e) {
        // If order by created_at fails, try without ordering
        try {
          const { data, error } = await supabase.from(table).select('*').limit(1000);
          if (error) throw error;
          allData = data || [];
          tableData[table] = allData;
          sortColumn = null;
          sortDirection = 'asc';
          renderContent();
          renderPagination();
        } catch (e2) {
          document.getElementById('content').innerHTML = `<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><p>Error: ${e2.message}</p></div>`;
          document.getElementById('pagination').style.display = 'none';
        }
      }
    }

    function getFilteredSortedData() {
      let data = [...allData];

      // Filter by search term
      if (searchTerm) {
        const term = searchTerm.toLowerCase();
        data = data.filter(row => {
          return Object.values(row).some(val => {
            if (val === null) return false;
            return String(val).toLowerCase().includes(term);
          });
        });
      }

      // Sort
      if (sortColumn) {
        data.sort((a, b) => {
          let aVal = a[sortColumn];
          let bVal = b[sortColumn];

          if (aVal === null) return 1;
          if (bVal === null) return -1;

          if (typeof aVal === 'number' && typeof bVal === 'number') {
            return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
          }

          aVal = String(aVal).toLowerCase();
          bVal = String(bVal).toLowerCase();

          if (sortDirection === 'asc') {
            return aVal.localeCompare(bVal);
          } else {
            return bVal.localeCompare(aVal);
          }
        });
      }

      return data;
    }

    function getPaginatedData() {
      const filtered = getFilteredSortedData();
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      return {
        data: filtered.slice(start, end),
        total: filtered.length,
        start: start + 1,
        end: Math.min(end, filtered.length)
      };
    }

    function renderContent() {
      if (!currentTable) return;

      const content = document.getElementById('content');

      if (currentTab === 'data') {
        const { data, total, start, end } = getPaginatedData();

        if (allData.length === 0) {
          content.innerHTML = `<div class="empty-state"><div class="icon">üì≠</div><p>No data in this table</p><button class="btn btn-primary" style="margin-top:20px" onclick="showAddRowModal()">+ Add First Row</button></div>`;
          document.getElementById('pagination').style.display = 'none';
          return;
        }

        if (data.length === 0 && searchTerm) {
          content.innerHTML = `<div class="empty-state"><div class="icon">üîç</div><p>No results for "${escapeHtml(searchTerm)}"</p></div>`;
          document.getElementById('pagination').style.display = 'none';
          return;
        }

        document.getElementById('pagination').style.display = 'flex';

        const columns = Object.keys(allData[0]);
        content.innerHTML = `
          <table class="data-table">
            <thead>
              <tr>
                <th>Actions</th>
                ${columns.map(col => `
                  <th class="${sortColumn === col ? 'sorted' : ''}" onclick="window.sortBy('${col}')">
                    ${col}
                    <span class="sort-icon">${sortColumn === col ? (sortDirection === 'asc' ? '‚ñ≤' : '‚ñº') : '‚óã'}</span>
                  </th>
                `).join('')}
              </tr>
            </thead>
            <tbody>
              ${data.map((row, idx) => {
                const realIdx = allData.indexOf(row);
                return `
                  <tr>
                    <td>
                      <div class="row-actions">
                        <button class="btn btn-sm" onclick="showEditRowModal(${realIdx})">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteRow(${realIdx})">üóë</button>
                      </div>
                    </td>
                    ${columns.map(col => `<td>${formatValue(row[col], col)}</td>`).join('')}
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `;

        document.getElementById('paginationInfo').textContent = `Showing ${start}-${end} of ${total} rows`;

      } else if (currentTab === 'schema') {
        document.getElementById('pagination').style.display = 'none';

        if (allData.length === 0) {
          content.innerHTML = '<div class="empty-state"><div class="icon">üì≠</div><p>No data to infer schema</p></div>';
          return;
        }

        const columns = Object.keys(allData[0]);
        content.innerHTML = `
          <div class="schema-view">
            ${columns.map(col => {
              const sampleValue = allData.find(r => r[col] !== null)?.[col];
              const type = inferType(sampleValue, col);
              return `
                <div class="schema-row">
                  <span class="col-name">${col}</span>
                  <span class="type-tag type-${type.class}">${type.name}</span>
                  <span class="col-sample">${type.sample}</span>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }
    }

    function renderPagination() {
      const { total } = getPaginatedData();
      const totalPages = Math.ceil(total / pageSize);
      const controls = document.getElementById('paginationControls');

      if (totalPages <= 1) {
        controls.innerHTML = '';
        return;
      }

      let pages = [];
      const maxVisible = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
      let endPage = Math.min(totalPages, startPage + maxVisible - 1);

      if (endPage - startPage < maxVisible - 1) {
        startPage = Math.max(1, endPage - maxVisible + 1);
      }

      pages.push(`<button class="page-btn" onclick="window.goToPage(1)" ${currentPage === 1 ? 'disabled' : ''}>¬´</button>`);
      pages.push(`<button class="page-btn" onclick="window.goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‚Äπ</button>`);

      for (let i = startPage; i <= endPage; i++) {
        pages.push(`<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="window.goToPage(${i})">${i}</button>`);
      }

      pages.push(`<button class="page-btn" onclick="window.goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>‚Ä∫</button>`);
      pages.push(`<button class="page-btn" onclick="window.goToPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>¬ª</button>`);

      controls.innerHTML = pages.join('');
    }

    window.goToPage = (page) => {
      const { total } = getPaginatedData();
      const totalPages = Math.ceil(total / pageSize);
      currentPage = Math.max(1, Math.min(page, totalPages));
      renderContent();
      renderPagination();
    };

    window.sortBy = (column) => {
      if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortColumn = column;
        sortDirection = 'asc';
      }
      currentPage = 1;
      renderContent();
      renderPagination();
    };

    function formatValue(value, column) {
      if (value === null || value === undefined) return '<span class="null-value">null</span>';
      if (typeof value === 'object') {
        const json = JSON.stringify(value);
        const preview = json.length > 40 ? json.substring(0, 40) + '...' : json;
        return `<span class="json-value" onclick="window.showJson(\`${encodeURIComponent(JSON.stringify(value, null, 2))}\`)">${escapeHtml(preview)}</span>`;
      }
      if (column === 'user_id' || (column.endsWith('_id') && String(value).includes('-'))) {
        return `<span class="uuid-value" title="${value}">${String(value).substring(0, 8)}...</span>`;
      }
      if (typeof value === 'boolean') return value ? '‚úì true' : '‚úó false';

      let str = String(value);
      if (str.length > 80) str = str.substring(0, 80) + '...';

      // Highlight search term
      if (searchTerm && str.toLowerCase().includes(searchTerm.toLowerCase())) {
        const regex = new RegExp(`(${escapeRegex(searchTerm)})`, 'gi');
        str = escapeHtml(str).replace(regex, '<span class="highlight">$1</span>');
        return str;
      }

      return escapeHtml(str);
    }

    function escapeRegex(str) {
      return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function inferType(value, column) {
      if (column === 'user_id' || (column.endsWith('_id') && String(value).includes('-'))) return { name: 'uuid', class: 'uuid', sample: 'UUID' };
      if (column.includes('_at') || column.includes('date')) return { name: 'timestamptz', class: 'time', sample: 'Timestamp' };
      if (value === null) return { name: 'unknown', class: 'text', sample: 'All null' };
      if (typeof value === 'boolean') return { name: 'boolean', class: 'bool', sample: 'true/false' };
      if (typeof value === 'number') return Number.isInteger(value) ? { name: 'integer', class: 'int', sample: 'Number' } : { name: 'float', class: 'int', sample: 'Decimal' };
      if (typeof value === 'object') return { name: 'jsonb', class: 'json', sample: 'JSON' };
      return { name: 'text', class: 'text', sample: 'String' };
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showToast(message, type = 'success') {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    window.closeModal = (id) => document.getElementById(id).style.display = 'none';

    window.showCreateTableModal = () => {
      document.getElementById('newTableName').value = '';
      document.getElementById('columnBuilder').innerHTML = `
        <div class="column-row">
          <input type="text" placeholder="column_name" class="col-name" />
          <select class="col-type"><option value="text">text</option><option value="integer">integer</option><option value="boolean">boolean</option><option value="jsonb">jsonb</option></select>
          <button class="remove-col-btn" onclick="this.parentElement.remove()">√ó</button>
        </div>
      `;
      document.getElementById('createTableModal').style.display = 'flex';
    };

    window.addColumnRow = () => {
      const builder = document.getElementById('columnBuilder');
      const row = document.createElement('div');
      row.className = 'column-row';
      row.innerHTML = `
        <input type="text" placeholder="column_name" class="col-name" />
        <select class="col-type"><option value="text">text</option><option value="integer">integer</option><option value="boolean">boolean</option><option value="jsonb">jsonb</option></select>
        <button class="remove-col-btn" onclick="this.parentElement.remove()">√ó</button>
      `;
      builder.appendChild(row);
    };

    window.createTable = async () => {
      showToast('Table creation requires MCP tools - use Claude to create tables', 'error');
      closeModal('createTableModal');
    };

    window.showAddRowModal = () => {
      if (!currentTable) return;
      const columns = allData.length > 0 ? Object.keys(allData[0]) : ['user_id'];
      const skipCols = ['created_at', 'updated_at'];

      document.getElementById('addRowForm').innerHTML = `
        <div class="info-box">You can only insert rows with your user_id. Some fields are auto-generated.</div>
        ${columns.filter(c => !skipCols.includes(c)).map(col => `
          <div class="form-group">
            <label>${col} ${col === 'user_id' ? '(auto)' : ''}</label>
            <input type="text" id="add_${col}" placeholder="${col}" ${col === 'user_id' ? 'disabled' : ''} value="${col === 'user_id' && currentUser ? currentUser.id : ''}" />
          </div>
        `).join('')}
      `;
      document.getElementById('addRowModal').style.display = 'flex';
    };

    window.insertRow = async () => {
      if (!currentTable || !currentUser) { showToast('Not authenticated', 'error'); return; }

      const columns = allData.length > 0 ? Object.keys(allData[0]) : ['user_id'];
      const skipCols = ['created_at', 'updated_at'];
      const rowData = {};

      columns.filter(c => !skipCols.includes(c)).forEach(col => {
        const input = document.getElementById(`add_${col}`);
        if (input) {
          let val = input.value.trim();
          if (val === '') val = null;
          else if (val === 'true') val = true;
          else if (val === 'false') val = false;
          else if (!isNaN(val) && val !== '') val = Number(val);
          rowData[col] = val;
        }
      });
      rowData.user_id = currentUser.id;

      try {
        const { error } = await supabase.from(currentTable).insert([rowData]);
        if (error) throw error;
        showToast('Row inserted!');
        closeModal('addRowModal');
        selectTable(currentTable);
      } catch (e) {
        showToast('Error: ' + e.message, 'error');
      }
    };

    window.showEditRowModal = (idx) => {
      if (!currentTable || !allData[idx]) return;

      const row = allData[idx];
      editingRow = { idx, data: row };
      const columns = Object.keys(row);

      document.getElementById('editRowForm').innerHTML = `
        <div class="info-box">You can only edit your own rows (RLS policy).</div>
        ${columns.map(col => `
          <div class="form-group">
            <label>${col}</label>
            <input type="text" id="edit_${col}" value="${row[col] === null ? '' : (typeof row[col] === 'object' ? JSON.stringify(row[col]) : row[col])}" ${['user_id', 'created_at', 'updated_at'].includes(col) ? 'disabled' : ''} />
          </div>
        `).join('')}
      `;
      document.getElementById('editRowModal').style.display = 'flex';
    };

    window.updateRow = async () => {
      if (!currentTable || !editingRow) return;

      const row = editingRow.data;
      const columns = Object.keys(row);
      const updates = {};
      const skipCols = ['user_id', 'created_at', 'updated_at'];

      columns.filter(c => !skipCols.includes(c)).forEach(col => {
        const input = document.getElementById(`edit_${col}`);
        if (input) {
          let val = input.value.trim();
          if (val === '') val = null;
          else if (val === 'true') val = true;
          else if (val === 'false') val = false;
          else if (!isNaN(val) && val !== '') val = Number(val);
          else if (val.startsWith('{') || val.startsWith('[')) {
            try { val = JSON.parse(val); } catch (e) {}
          }
          updates[col] = val;
        }
      });

      try {
        const pk = row.id || row.user_id;
        const pkCol = row.id !== undefined ? 'id' : 'user_id';
        const { error } = await supabase.from(currentTable).update(updates).eq(pkCol, pk);
        if (error) throw error;
        showToast('Row updated!');
        closeModal('editRowModal');
        selectTable(currentTable);
      } catch (e) {
        showToast('Error: ' + e.message, 'error');
      }
    };

    window.deleteRow = async (idx) => {
      if (!currentTable || !allData[idx]) return;
      if (!confirm('Delete this row?')) return;

      const row = allData[idx];
      try {
        const pk = row.id || row.user_id;
        const pkCol = row.id !== undefined ? 'id' : 'user_id';
        const { error } = await supabase.from(currentTable).delete().eq(pkCol, pk);
        if (error) throw error;
        showToast('Row deleted!');
        selectTable(currentTable);
      } catch (e) {
        showToast('Error: ' + e.message, 'error');
      }
    };

    window.deleteCurrentRow = async () => {
      if (!editingRow) return;
      await window.deleteRow(editingRow.idx);
      closeModal('editRowModal');
    };

    window.showDeleteTableModal = () => {
      if (!currentTable) return;
      document.getElementById('confirmTableName').textContent = currentTable;
      document.getElementById('deleteTableConfirm').value = '';
      document.getElementById('deleteTableModal').style.display = 'flex';
    };

    window.deleteTable = async () => {
      showToast('Table deletion requires MCP tools - use Claude to delete tables', 'error');
      closeModal('deleteTableModal');
    };

    window.showJson = (encoded) => {
      document.getElementById('jsonContent').textContent = decodeURIComponent(encoded);
      document.getElementById('jsonModal').style.display = 'flex';
    };

    window.refreshTable = () => { if (currentTable) selectTable(currentTable); };

    // Event listeners
    document.getElementById('searchInput').addEventListener('input', (e) => renderTableList(e.target.value));

    document.getElementById('dataSearch').addEventListener('input', (e) => {
      searchTerm = e.target.value;
      currentPage = 1;
      renderContent();
      renderPagination();
    });

    document.getElementById('pageSizeSelect').addEventListener('change', (e) => {
      pageSize = parseInt(e.target.value);
      currentPage = 1;
      renderContent();
      renderPagination();
    });

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentTab = tab.dataset.tab;
        renderContent();
      });
    });

    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.style.display = 'none';
      });
    });

    // Initialize
    await initAuth();
    await fetchTables();
    renderTableList();
    loadTableCounts();
  </script>
</body>
</html>
