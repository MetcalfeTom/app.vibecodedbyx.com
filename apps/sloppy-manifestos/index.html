<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sloppy Manifestos - Declare Your Ideas</title>
    <link rel="icon" href="https://emojicdn.elk.sh/üìú">
    <meta property="og:title" content="Sloppy Manifestos">
    <meta property="og:description" content="Write, fork, and vote on manifestos that shape the community">
    <meta property="og:url" content="https://app.sloppy.live/sloppy-manifestos">
    <meta property="og:image" content="https://emojicdn.elk.sh/üìú?style=google">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,200;0,400;0,700;0,900;1,400&family=IBM+Plex+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{
            --bg:#08070c;--surface:#0e0d14;--surface2:#15141e;--border:#222235;
            --text:#d4d0dc;--dim:#6a6680;--accent:#c084fc;--accent2:#a855f7;
            --up:#4ade80;--down:#f87171;--tag:#7c3aed;
        }
        body{background:var(--bg);color:var(--text);font-family:'Crimson Pro',serif;min-height:100vh;line-height:1.6}

        /* Embed mode (inside Sloppygram iframe) */
        body.embed-mode .header{display:none}
        body.embed-mode .backlink{display:none}
        body.embed-mode .app{padding-top:8px;padding-bottom:16px}

        body::before{content:'';position:fixed;inset:0;
            background:radial-gradient(ellipse at 20% 0%,rgba(168,85,247,0.06),transparent 60%),
                radial-gradient(ellipse at 80% 100%,rgba(192,132,252,0.04),transparent 50%);
            pointer-events:none;z-index:0}

        .app{position:relative;z-index:1;max-width:780px;margin:0 auto;padding:24px 16px 80px}

        /* Header */
        .header{text-align:center;padding:28px 0 24px}
        .header h1{font-weight:900;font-size:clamp(2rem,5vw,3rem);color:var(--accent);
            letter-spacing:-1px;line-height:1.1}
        .header .sub{font-family:'IBM Plex Mono',monospace;font-size:0.65rem;color:var(--dim);
            margin-top:6px;letter-spacing:1px;text-transform:uppercase}
        .header-stats{display:flex;justify-content:center;gap:16px;margin-top:12px;
            font-family:'IBM Plex Mono',monospace;font-size:0.65rem;color:var(--dim)}
        .header-stats span{color:var(--accent);font-weight:500}

        /* Write button */
        .write-btn{display:block;margin:0 auto 24px;background:var(--accent2);color:#fff;border:none;
            padding:12px 28px;border-radius:8px;font-family:'Crimson Pro',serif;font-size:1rem;
            font-weight:700;cursor:pointer;transition:all 0.2s;letter-spacing:0.5px}
        .write-btn:hover{opacity:0.85;transform:translateY(-1px)}

        /* Filters */
        .filters{display:flex;gap:6px;justify-content:center;margin-bottom:20px;flex-wrap:wrap}
        .filter-btn{background:var(--surface);border:1px solid var(--border);color:var(--dim);
            padding:6px 14px;border-radius:6px;cursor:pointer;font-family:'IBM Plex Mono',monospace;
            font-size:0.65rem;transition:all 0.2s}
        .filter-btn.active{background:var(--accent2);color:#fff;border-color:var(--accent2)}
        .tag-filter-active{display:none;text-align:center;margin-bottom:12px;font-family:'IBM Plex Mono',monospace;
            font-size:0.7rem;color:var(--accent)}
        .tag-filter-active.show{display:block}
        .tag-filter-active button{background:none;border:none;color:var(--dim);cursor:pointer;
            font-family:inherit;font-size:inherit;margin-left:8px;text-decoration:underline}

        /* Manifesto cards */
        .card{background:var(--surface);border:1px solid var(--border);border-radius:12px;
            margin-bottom:16px;overflow:hidden;transition:border-color 0.2s}
        .card:hover{border-color:rgba(168,85,247,0.3)}

        .card-header{display:flex;align-items:center;gap:10px;padding:14px 18px 0}
        .card-avatar{width:32px;height:32px;border-radius:50%;background:var(--surface2);
            display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;
            border:1px solid var(--border)}
        .card-meta{flex:1;min-width:0}
        .card-author{font-family:'IBM Plex Mono',monospace;font-size:0.75rem;font-weight:500;color:var(--text)}
        .card-time{font-family:'IBM Plex Mono',monospace;font-size:0.55rem;color:var(--dim)}

        .card-title{font-weight:900;font-size:1.3rem;padding:10px 18px 4px;color:var(--text);line-height:1.3}

        .card-body{padding:0 18px 12px;font-size:0.95rem;color:var(--text);line-height:1.7}
        .card-body p{margin-bottom:8px}
        .card-body strong,.card-body b{color:var(--accent);font-weight:700}
        .card-body em,.card-body i{font-style:italic;color:#b8b0c8}
        .card-body code{background:var(--surface2);padding:1px 5px;border-radius:3px;
            font-family:'IBM Plex Mono',monospace;font-size:0.85em;color:var(--accent)}
        .card-body pre{background:var(--surface2);padding:12px;border-radius:6px;overflow-x:auto;
            margin:8px 0;font-family:'IBM Plex Mono',monospace;font-size:0.8rem;line-height:1.5}
        .card-body blockquote{border-left:3px solid var(--accent);padding-left:14px;margin:8px 0;
            color:var(--dim);font-style:italic}
        .card-body a{color:var(--accent);text-decoration:underline}
        .card-body h1,.card-body h2,.card-body h3{margin:12px 0 6px;color:var(--text)}
        .card-body ul,.card-body ol{padding-left:20px;margin:6px 0}
        .card-body hr{border:none;border-top:1px solid var(--border);margin:12px 0}

        /* DNA signature */
        .card-dna{display:flex;align-items:center;gap:6px;padding:0 18px 8px;
            font-family:'IBM Plex Mono',monospace;font-size:0.55rem;color:var(--dim);flex-wrap:wrap}
        .dna-helix{animation:pulse 2s infinite;font-size:0.7rem}
        .dna-gen{color:var(--accent);font-weight:500}
        .dna-seq span{font-weight:500}
        .nA{color:#4ade80}.nT{color:#fb923c}.nC{color:#60a5fa}.nG{color:#e879f9}
        .dna-parent{color:var(--dim);cursor:pointer;text-decoration:underline}
        .dna-parent:hover{color:var(--accent)}

        /* Tags */
        .card-tags{display:flex;gap:4px;padding:0 18px 10px;flex-wrap:wrap}
        .tag-chip{font-family:'IBM Plex Mono',monospace;font-size:0.55rem;background:rgba(124,58,237,0.15);
            color:var(--tag);padding:2px 8px;border-radius:4px;cursor:pointer;transition:background 0.15s}
        .tag-chip:hover{background:rgba(124,58,237,0.3)}

        /* Actions bar */
        .card-actions{display:flex;align-items:center;gap:4px;padding:8px 18px 12px;
            border-top:1px solid rgba(255,255,255,0.03)}
        .vote-group{display:flex;align-items:center;gap:2px}
        .vote-btn{background:none;border:1px solid var(--border);color:var(--dim);
            width:28px;height:28px;border-radius:4px;cursor:pointer;font-size:0.7rem;
            display:flex;align-items:center;justify-content:center;transition:all 0.15s}
        .vote-btn:hover{border-color:var(--accent)}
        .vote-btn.up.active{background:rgba(74,222,128,0.15);border-color:var(--up);color:var(--up)}
        .vote-btn.down.active{background:rgba(248,113,113,0.15);border-color:var(--down);color:var(--down)}
        .vote-score{font-family:'IBM Plex Mono',monospace;font-size:0.75rem;font-weight:500;
            min-width:24px;text-align:center;padding:0 4px}
        .vote-score.pos{color:var(--up)}.vote-score.neg{color:var(--down)}.vote-score.zero{color:var(--dim)}

        .action-btn{background:none;border:1px solid var(--border);color:var(--dim);
            padding:4px 10px;border-radius:4px;cursor:pointer;font-family:'IBM Plex Mono',monospace;
            font-size:0.6rem;transition:all 0.15s;margin-left:4px}
        .action-btn:hover{border-color:var(--accent);color:var(--text)}

        .action-spacer{flex:1}

        .delete-btn{background:none;border:1px solid rgba(248,113,113,0.2);color:rgba(248,113,113,0.5);
            padding:4px 8px;border-radius:4px;cursor:pointer;font-size:0.6rem;font-family:'IBM Plex Mono',monospace}
        .delete-btn:hover{border-color:var(--down);color:var(--down)}

        /* Reactions */
        .card-reactions{display:flex;gap:4px;padding:0 18px 8px;flex-wrap:wrap}
        .reaction-chip{font-family:'IBM Plex Mono',monospace;font-size:0.65rem;background:var(--surface2);
            border:1px solid var(--border);padding:2px 8px;border-radius:12px;cursor:pointer;transition:all 0.15s}
        .reaction-chip:hover{border-color:var(--accent)}
        .reaction-chip.mine{background:rgba(168,85,247,0.15);border-color:var(--accent)}
        .reaction-picker{display:none;gap:4px;padding:4px 18px 8px}
        .reaction-picker.show{display:flex}
        .reaction-pick{font-size:1.1rem;cursor:pointer;padding:2px;transition:transform 0.1s}
        .reaction-pick:hover{transform:scale(1.3)}

        /* Comments */
        .card-comments{padding:0 18px 12px}
        .comment{display:flex;gap:8px;padding:6px 0;border-top:1px solid rgba(255,255,255,0.03)}
        .comment:first-child{border-top:none}
        .comment-avatar{width:22px;height:22px;border-radius:50%;background:var(--surface2);
            display:flex;align-items:center;justify-content:center;font-size:0.65rem;flex-shrink:0}
        .comment-body{flex:1;min-width:0}
        .comment-author{font-family:'IBM Plex Mono',monospace;font-size:0.6rem;font-weight:500;color:var(--accent)}
        .comment-text{font-size:0.8rem;line-height:1.5;color:var(--text)}
        .comment-time{font-family:'IBM Plex Mono',monospace;font-size:0.5rem;color:var(--dim)}
        .comment-input{display:flex;gap:6px;padding-top:8px}
        .comment-input input{flex:1;background:var(--surface2);border:1px solid var(--border);
            border-radius:6px;padding:6px 10px;color:var(--text);font-family:'Crimson Pro',serif;
            font-size:0.8rem;outline:none}
        .comment-input input:focus{border-color:var(--accent)}
        .comment-input button{background:var(--accent2);color:#fff;border:none;border-radius:6px;
            padding:6px 12px;cursor:pointer;font-family:'IBM Plex Mono',monospace;font-size:0.6rem;font-weight:500}

        /* Write modal */
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:100;display:none;
            align-items:center;justify-content:center;padding:20px}
        .modal-overlay.visible{display:flex}
        .modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;
            padding:28px;max-width:620px;width:100%;max-height:90vh;overflow-y:auto;animation:modalIn 0.25s ease}
        .modal h2{font-weight:900;font-size:1.3rem;color:var(--accent);margin-bottom:16px}
        .modal-input{width:100%;background:var(--surface2);border:1px solid var(--border);
            border-radius:8px;padding:10px 14px;color:var(--text);font-family:'Crimson Pro',serif;
            font-size:1rem;outline:none;margin-bottom:12px}
        .modal-input:focus{border-color:var(--accent)}
        .modal-textarea{width:100%;height:200px;background:var(--surface2);border:1px solid var(--border);
            border-radius:8px;padding:12px 14px;color:var(--text);font-family:'Crimson Pro',serif;
            font-size:0.95rem;line-height:1.6;outline:none;resize:vertical;margin-bottom:4px}
        .modal-textarea:focus{border-color:var(--accent)}
        .char-count{font-family:'IBM Plex Mono',monospace;font-size:0.6rem;color:var(--dim);
            text-align:right;margin-bottom:12px}
        .fork-indicator{background:rgba(168,85,247,0.1);border:1px solid rgba(168,85,247,0.2);
            border-radius:6px;padding:8px 12px;margin-bottom:12px;font-family:'IBM Plex Mono',monospace;
            font-size:0.7rem;color:var(--accent);display:none}
        .fork-indicator.show{display:block}
        .tag-input-row{display:flex;gap:6px;margin-bottom:8px}
        .tag-input-row input{flex:1;background:var(--surface2);border:1px solid var(--border);
            border-radius:6px;padding:6px 10px;color:var(--text);font-family:'IBM Plex Mono',monospace;
            font-size:0.75rem;outline:none}
        .tag-input-row input:focus{border-color:var(--tag)}
        .tag-input-row input::placeholder{color:var(--dim)}
        .pending-tags{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:12px}
        .pending-tag{font-family:'IBM Plex Mono',monospace;font-size:0.6rem;background:rgba(124,58,237,0.15);
            color:var(--tag);padding:3px 8px;border-radius:4px;display:flex;align-items:center;gap:4px}
        .pending-tag button{background:none;border:none;color:var(--dim);cursor:pointer;font-size:0.7rem}
        .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}
        .modal-submit{background:var(--accent2);color:#fff;border:none;padding:10px 24px;border-radius:8px;
            cursor:pointer;font-family:'Crimson Pro',serif;font-size:1rem;font-weight:700}
        .modal-submit:hover{opacity:0.85}
        .modal-cancel{background:none;border:1px solid var(--border);color:var(--dim);padding:10px 20px;
            border-radius:8px;cursor:pointer;font-family:'Crimson Pro',serif;font-size:1rem}
        .modal-cancel:hover{color:var(--text);border-color:var(--text)}

        .empty-state{text-align:center;padding:40px;color:var(--dim);font-size:0.85rem}
        .empty-state-icon{font-size:2.5rem;margin-bottom:10px}

        .backlink{text-align:center;margin-top:28px;font-family:'IBM Plex Mono',monospace;font-size:0.6rem}
        .backlink a{color:var(--dim);text-decoration:none}.backlink a:hover{color:var(--accent)}

        .toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--surface2);
            border:1px solid var(--border);border-radius:8px;padding:8px 18px;
            font-family:'IBM Plex Mono',monospace;font-size:0.7rem;color:var(--text);
            z-index:50;opacity:0;transition:opacity 0.3s;pointer-events:none}
        .toast.show{opacity:1}

        @keyframes modalIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}

        @media(max-width:600px){
            .card-title{font-size:1.1rem}
            .card-body{font-size:0.9rem}
            .card-actions{flex-wrap:wrap}
        }
    </style>
<script>
(function(){var Q=[],N=0,MAX=10;function send(e){var sb=window.supabase;if(!sb){Q.push(e);return;}if(N>=MAX)return;N++;sb.auth.getSession().then(function(r){var u=r&&r.data&&r.data.session&&r.data.session.user;if(!u)return;sb.from('ai_events').insert({event_type:'client_error',entity_type:'app',entity_id:u.id,username:location.pathname.split('/').filter(Boolean)[0]||'unknown',metadata:e,user_id:u.id}).then(function(){});}).catch(function(){});}window.onerror=function(m,s,l,c,e){send({type:'error',msg:String(m).slice(0,500),src:s||'',line:l,col:c,stack:e?String(e.stack).slice(0,1000):''});};window.addEventListener('unhandledrejection',function(ev){var r=ev.reason;send({type:'promise',msg:String(r&&r.message||r).slice(0,500),stack:r?String(r.stack||'').slice(0,1000):''});});var fi=setInterval(function(){if(window.supabase){Q.splice(0).forEach(send);clearInterval(fi);}},1000);setTimeout(function(){clearInterval(fi);},30000);})();
</script>
</head>
<body>
    <div class="app">
        <div class="header">
            <h1>üìú SLOPPY MANIFESTOS</h1>
            <div class="sub">Declare ¬∑ Fork ¬∑ Shape the Future</div>
            <div class="header-stats">
                <div><span id="totalManifestos">0</span> manifestos</div>
                <div><span id="totalVotes">0</span> votes cast</div>
                <div><span id="totalForks">0</span> forks</div>
            </div>
        </div>

        <button class="write-btn" onclick="openModal()">‚úçÔ∏è Write a Manifesto</button>

        <div class="filters">
            <button class="filter-btn active" data-sort="newest" onclick="setSort('newest')">Newest</button>
            <button class="filter-btn" data-sort="top" onclick="setSort('top')">Top Voted</button>
            <button class="filter-btn" data-sort="discussed" onclick="setSort('discussed')">Most Discussed</button>
            <button class="filter-btn" data-sort="forked" onclick="setSort('forked')">Most Forked</button>
        </div>

        <div class="tag-filter-active" id="tagFilterBar">
            Filtering by: <strong id="tagFilterLabel"></strong>
            <button onclick="clearTagFilter()">clear</button>
        </div>

        <div id="manifestoList"></div>

        <div class="backlink"><a href="https://sloppy.live">‚Üê sloppy.live</a></div>
    </div>

    <!-- Write Modal -->
    <div class="modal-overlay" id="writeModal">
        <div class="modal">
            <h2 id="modalTitle">üìú Write Your Manifesto</h2>
            <div class="fork-indicator" id="forkIndicator"></div>
            <input type="text" class="modal-input" id="inputTitle" placeholder="Title" maxlength="200">
            <textarea class="modal-textarea" id="inputContent" placeholder="Write your manifesto... (Markdown supported)" maxlength="5000"></textarea>
            <div class="char-count"><span id="charCount">0</span>/5000 ¬∑ Markdown supported</div>
            <div class="tag-input-row">
                <input type="text" id="tagInput" placeholder="Add tag (Enter to add, use / for hierarchy)" maxlength="100">
            </div>
            <div class="pending-tags" id="pendingTags"></div>
            <div class="modal-actions">
                <button class="modal-cancel" onclick="closeModal()">Cancel</button>
                <button class="modal-submit" onclick="submitManifesto()">DECLARE IT</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script src="/apps/sloppy-header/sloppy-bar.js" data-position="bottom"></script>
    <script type="module">
        import { createBrowserClient } from "https://cdn.jsdelivr.net/npm/@supabase/ssr@0.7.0/+esm";

        // Embed mode detection
        const IS_EMBED = new URLSearchParams(window.location.search).get('embed') === 'true';
        if (IS_EMBED) document.body.classList.add('embed-mode');

        const SUPABASE_URL = 'https://yjyxteqzhhmtrgcaekgz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM8IS32IUYR2eenCCjdDdioiBU';
        const supabase = createBrowserClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            cookieOptions: { name: 'sb-auth-token', domain: location.hostname.includes('sloppy.live') ? '.sloppy.live' : location.hostname, path: '/', sameSite: 'lax' }
        });
        window.supabase = supabase;

        const REACTION_EMOJIS = ['üî•','üí°','üß†','üëè','üíÄ','‚ù§Ô∏è','ü§î','‚ö°'];

        // postMessage helper for embed mode
        function notifyParent(data) {
            if (IS_EMBED && window.parent !== window) {
                window.parent.postMessage(data, '*');
            }
        }

        // State
        let currentUser = null;
        let username = 'Anonymous';
        let avatar = 'üë§';
        let manifestos = [];
        let manifestoVotes = {};       // {id: netScore}
        let myVotes = {};              // {id: 1|-1|0}
        let manifestoReactions = {};   // {id: {emoji: count}}
        let myReactions = {};          // {id: Set<emoji>}
        let manifestoComments = {};    // {id: [comments]}
        let manifestoTags = {};        // {id: [{tag, parent_tag}]}
        let manifestoLineage = {};     // {id: {parent_id, fork_type}}
        let forkChildCount = {};       // {id: count}
        let pendingTags = [];
        let forkingFromId = null;
        let currentSort = 'newest';
        let activeTagFilter = null;

        // Auth
        async function initAuth() {
            const sessRes = await supabase.auth.getSession();
            let session = sessRes.data.session;
            if (!session) session = (await supabase.auth.signInAnonymously()).data.session;
            currentUser = session?.user;
            if (currentUser) {
                const { data: prof } = await supabase.from('sloppygram_profiles').select('username, avatar').eq('user_id', currentUser.id).single();
                if (prof) { username = prof.username || 'Anonymous'; avatar = prof.avatar || 'üë§'; }
            }
        }

        // Load all data
        async function loadManifestos() {
            const [mRes, vRes, rRes, cRes, tRes, lRes] = await Promise.all([
                supabase.from('sloppygram_manifestos').select('*').order('created_at', { ascending: false }).limit(100),
                supabase.from('sloppygram_manifesto_votes').select('manifesto_id, username, vote_type, user_id').limit(2000),
                supabase.from('sloppygram_manifesto_reactions').select('id, manifesto_id, emoji, username, user_id').limit(2000),
                supabase.from('sloppygram_manifesto_comments').select('*').order('created_at', { ascending: true }).limit(1000),
                supabase.from('sloppygram_manifesto_tags').select('manifesto_id, tag, parent_tag').limit(1000),
                supabase.from('sloppygram_manifesto_lineage').select('manifesto_id, parent_id, fork_type').limit(500),
            ]);

            manifestos = mRes.data || [];

            // Process votes
            manifestoVotes = {}; myVotes = {};
            (vRes.data || []).forEach(v => {
                const mid = v.manifesto_id;
                manifestoVotes[mid] = (manifestoVotes[mid] || 0) + (v.vote_type || 0);
                if (currentUser && v.user_id === currentUser.id) myVotes[mid] = v.vote_type;
            });

            // Process reactions
            manifestoReactions = {}; myReactions = {};
            (rRes.data || []).forEach(r => {
                const mid = r.manifesto_id;
                if (!manifestoReactions[mid]) manifestoReactions[mid] = {};
                manifestoReactions[mid][r.emoji] = (manifestoReactions[mid][r.emoji] || 0) + 1;
                if (currentUser && r.user_id === currentUser.id) {
                    if (!myReactions[mid]) myReactions[mid] = new Set();
                    myReactions[mid].add(r.emoji);
                }
            });

            // Process comments
            manifestoComments = {};
            (cRes.data || []).forEach(c => {
                const mid = c.manifesto_id;
                if (!manifestoComments[mid]) manifestoComments[mid] = [];
                manifestoComments[mid].push(c);
            });

            // Process tags
            manifestoTags = {};
            (tRes.data || []).forEach(t => {
                const mid = t.manifesto_id;
                if (!manifestoTags[mid]) manifestoTags[mid] = [];
                manifestoTags[mid].push(t);
            });

            // Process lineage
            manifestoLineage = {}; forkChildCount = {};
            (lRes.data || []).forEach(l => {
                manifestoLineage[l.manifesto_id] = { parent_id: l.parent_id, fork_type: l.fork_type };
                forkChildCount[l.parent_id] = (forkChildCount[l.parent_id] || 0) + 1;
            });

            // Stats
            const totalVotes = (vRes.data || []).length;
            const totalForks = (lRes.data || []).length;
            document.getElementById('totalManifestos').textContent = manifestos.length;
            document.getElementById('totalVotes').textContent = totalVotes;
            document.getElementById('totalForks').textContent = totalForks;

            renderManifestos();
        }

        // DNA signature
        function generateDNA(m) {
            let seed = (m.id || 0) * 7919;
            for (let i = 0; i < (m.title || '').length; i++) seed += m.title.charCodeAt(i);
            seed += new Date(m.created_at || 0).getTime() % 10000;
            const rng = () => { seed = (seed * 16807 + 12345) % 2147483647; return seed / 2147483647; };

            const bases = 'ATCG';
            let seq = '';
            for (let i = 0; i < 12; i++) {
                if (i > 0 && i % 4 === 0) seq += '-';
                seq += bases[Math.floor(rng() * 4)];
            }
            const markers = 'Œ±Œ≤Œ≥Œ¥ŒµŒ∂Œ∑Œ∏';
            const marker = markers[Math.floor(((m.content || '').length % 8))];
            const gen = 'G' + String(m.id || 0).padStart(3, '0');
            let lin = '';
            const author = m.username || 'anon';
            lin += String.fromCharCode(65 + (author.charCodeAt(0) || 0) % 26);
            lin += String.fromCharCode(65 + ((author.charCodeAt(1) || 0) + (m.id || 0)) % 26);
            return { seq, marker, lin, gen };
        }

        // Render
        function getSortedManifestos() {
            let list = [...manifestos];
            if (activeTagFilter) {
                list = list.filter(m => {
                    const tags = manifestoTags[m.id] || [];
                    return tags.some(t => t.tag.toLowerCase() === activeTagFilter.toLowerCase() ||
                        (t.parent_tag && t.parent_tag.toLowerCase() === activeTagFilter.toLowerCase()));
                });
            }
            if (currentSort === 'top') list.sort((a, b) => (manifestoVotes[b.id] || 0) - (manifestoVotes[a.id] || 0));
            else if (currentSort === 'discussed') list.sort((a, b) => (manifestoComments[b.id] || []).length - (manifestoComments[a.id] || []).length);
            else if (currentSort === 'forked') list.sort((a, b) => (forkChildCount[b.id] || 0) - (forkChildCount[a.id] || 0));
            return list;
        }

        function renderManifestos() {
            const list = getSortedManifestos();
            const el = document.getElementById('manifestoList');
            if (list.length === 0) {
                el.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìú</div>No manifestos yet. Be the first to declare your ideas.</div>';
                return;
            }
            el.innerHTML = list.map(renderCard).join('');
        }

        function renderCard(m) {
            const dna = generateDNA(m);
            const score = manifestoVotes[m.id] || m.upvotes || 0;
            const myVote = myVotes[m.id] || 0;
            const reactions = manifestoReactions[m.id] || {};
            const myR = myReactions[m.id] || new Set();
            const comments = manifestoComments[m.id] || [];
            const tags = manifestoTags[m.id] || [];
            const lineage = manifestoLineage[m.id];
            const isOwn = currentUser && m.user_id === currentUser.id;

            // Parse markdown
            let bodyHtml;
            try {
                if (typeof marked !== 'undefined') {
                    bodyHtml = marked.parse(m.content || '', { breaks: true, gfm: true });
                    if (typeof DOMPurify !== 'undefined') {
                        bodyHtml = DOMPurify.sanitize(bodyHtml, {
                            ALLOWED_TAGS: ['p','br','strong','b','em','i','code','pre','blockquote','ul','ol','li','a','h1','h2','h3','hr'],
                            ALLOWED_ATTR: ['href','title']
                        });
                    }
                } else {
                    bodyHtml = esc(m.content || '').replace(/\n/g, '<br>');
                }
            } catch { bodyHtml = esc(m.content || '').replace(/\n/g, '<br>'); }

            // Score class
            const scoreCls = score > 0 ? 'pos' : score < 0 ? 'neg' : 'zero';

            // Reactions HTML
            let reactHtml = '';
            const sortedEmoji = Object.entries(reactions).sort((a, b) => b[1] - a[1]);
            sortedEmoji.forEach(([emoji, count]) => {
                const mine = myR.has(emoji) ? ' mine' : '';
                reactHtml += `<span class="reaction-chip${mine}" onclick="window._toggleReaction(${m.id},'${emoji}')">${emoji} ${count}</span>`;
            });

            // Tags HTML
            let tagHtml = tags.map(t => {
                const label = t.parent_tag ? `${t.parent_tag}/${t.tag}` : t.tag;
                return `<span class="tag-chip" onclick="window._filterTag('${esc(t.tag)}')">#${esc(label)}</span>`;
            }).join('');

            // DNA
            const seqHtml = dna.seq.split('').map(c =>
                c === '-' ? '-' : `<span class="n${c}">${c}</span>`
            ).join('');
            let dnaHtml = `<span class="dna-helix">üß¨</span> <span class="dna-gen">${dna.gen}</span> ${dna.lin}¬∑${dna.marker} <span class="dna-seq">${seqHtml}</span>`;
            if (lineage) {
                const parent = manifestos.find(x => x.id === lineage.parent_id);
                dnaHtml += ` ‚Üê <span class="dna-parent" onclick="window._scrollTo(${lineage.parent_id})" title="${parent ? esc(parent.title) : ''}">G${String(lineage.parent_id).padStart(3,'0')}</span>`;
            }

            // Comments HTML
            let commentsHtml = comments.slice(-5).map(c => `
                <div class="comment">
                    <div class="comment-avatar">${esc(c.avatar || 'üë§')}</div>
                    <div class="comment-body">
                        <span class="comment-author" style="cursor:pointer" onclick="window._usernameClick('${esc(c.username || '?')}')">${esc(c.username || '?')}</span>
                        <span class="comment-time">${timeAgo(c.created_at)}</span>
                        <div class="comment-text">${esc(c.content || '')}</div>
                    </div>
                </div>`).join('');

            return `<div class="card" id="manifesto-${m.id}">
                <div class="card-header">
                    <div class="card-avatar">${esc(m.avatar || 'üë§')}</div>
                    <div class="card-meta">
                        <div class="card-author" style="cursor:pointer" onclick="window._usernameClick('${esc(m.username || 'Anonymous')}')">${esc(m.username || 'Anonymous')}</div>
                        <div class="card-time">${timeAgo(m.created_at)}</div>
                    </div>
                </div>
                <div class="card-title">${esc(m.title || 'Untitled')}</div>
                <div class="card-body">${bodyHtml}</div>
                <div class="card-dna">${dnaHtml}</div>
                ${tagHtml ? `<div class="card-tags">${tagHtml}</div>` : ''}
                ${reactHtml ? `<div class="card-reactions">${reactHtml}</div>` : ''}
                <div class="reaction-picker" id="picker-${m.id}">
                    ${REACTION_EMOJIS.map(e => `<span class="reaction-pick" onclick="window._toggleReaction(${m.id},'${e}')">${e}</span>`).join('')}
                </div>
                <div class="card-actions">
                    <div class="vote-group">
                        <button class="vote-btn up${myVote===1?' active':''}" onclick="window._vote(${m.id},1)">‚ñ≤</button>
                        <span class="vote-score ${scoreCls}">${score}</span>
                        <button class="vote-btn down${myVote===-1?' active':''}" onclick="window._vote(${m.id},-1)">‚ñº</button>
                    </div>
                    <button class="action-btn" onclick="window._togglePicker(${m.id})">üòÄ</button>
                    <button class="action-btn" onclick="window._fork(${m.id})">üîÄ Fork</button>
                    <button class="action-btn" onclick="document.querySelector('#comment-input-${m.id}')?.focus()">üí¨ ${comments.length}</button>
                    <span class="action-spacer"></span>
                    ${isOwn ? `<button class="delete-btn" onclick="window._delete(${m.id})">üóëÔ∏è</button>` : ''}
                </div>
                <div class="card-comments">
                    ${commentsHtml}
                    <div class="comment-input">
                        <input type="text" id="comment-input-${m.id}" placeholder="Add a comment..." maxlength="500"
                            onkeydown="if(event.key==='Enter')window._comment(${m.id})">
                        <button onclick="window._comment(${m.id})">Post</button>
                    </div>
                </div>
            </div>`;
        }

        // Username click ‚Üí postMessage to parent
        window._usernameClick = function(username) {
            notifyParent({ type: 'username-click', username });
        };

        // Actions
        window._vote = async function(id, dir) {
            if (!currentUser) { showToast('Sign in first'); return; }
            const current = myVotes[id] || 0;
            if (current === dir) {
                // Remove vote
                await supabase.from('sloppygram_manifesto_votes').delete()
                    .eq('manifesto_id', id).eq('user_id', currentUser.id);
                myVotes[id] = 0;
                manifestoVotes[id] = (manifestoVotes[id] || 0) - dir;
            } else {
                // Remove old if exists
                if (current !== 0) {
                    await supabase.from('sloppygram_manifesto_votes').delete()
                        .eq('manifesto_id', id).eq('user_id', currentUser.id);
                    manifestoVotes[id] = (manifestoVotes[id] || 0) - current;
                }
                await supabase.from('sloppygram_manifesto_votes').insert({
                    manifesto_id: id, username, vote_type: dir, user_id: currentUser.id
                });
                myVotes[id] = dir;
                manifestoVotes[id] = (manifestoVotes[id] || 0) + dir;
            }
            notifyParent({ type: 'manifesto-voted' });
            renderManifestos();
        };

        window._toggleReaction = async function(id, emoji) {
            if (!currentUser) { showToast('Sign in first'); return; }
            if (!myReactions[id]) myReactions[id] = new Set();
            if (!manifestoReactions[id]) manifestoReactions[id] = {};

            if (myReactions[id].has(emoji)) {
                await supabase.from('sloppygram_manifesto_reactions').delete()
                    .eq('manifesto_id', id).eq('emoji', emoji).eq('user_id', currentUser.id);
                myReactions[id].delete(emoji);
                manifestoReactions[id][emoji] = Math.max(0, (manifestoReactions[id][emoji] || 1) - 1);
                if (manifestoReactions[id][emoji] === 0) delete manifestoReactions[id][emoji];
            } else {
                await supabase.from('sloppygram_manifesto_reactions').insert({
                    manifesto_id: id, emoji, username, user_id: currentUser.id
                });
                myReactions[id].add(emoji);
                manifestoReactions[id][emoji] = (manifestoReactions[id][emoji] || 0) + 1;
            }
            const picker = document.getElementById('picker-' + id);
            if (picker) picker.classList.remove('show');
            renderManifestos();
        };

        window._togglePicker = function(id) {
            const picker = document.getElementById('picker-' + id);
            if (picker) picker.classList.toggle('show');
        };

        window._comment = async function(id) {
            if (!currentUser) { showToast('Sign in first'); return; }
            const input = document.getElementById('comment-input-' + id);
            const content = input?.value.trim();
            if (!content) return;
            if (content.length > 500) { showToast('Comment too long'); return; }

            const { data, error } = await supabase.from('sloppygram_manifesto_comments').insert({
                manifesto_id: id, username, avatar, content, user_id: currentUser.id
            }).select().single();

            if (error) { showToast('Failed to comment'); return; }
            if (!manifestoComments[id]) manifestoComments[id] = [];
            manifestoComments[id].push(data);
            renderManifestos();
        };

        window._fork = function(id) {
            const parent = manifestos.find(m => m.id === id);
            if (!parent) return;
            forkingFromId = id;
            document.getElementById('modalTitle').textContent = 'üîÄ Fork Manifesto';
            const fi = document.getElementById('forkIndicator');
            fi.classList.add('show');
            fi.textContent = `Forking from: "${parent.title}" by ${parent.username}`;
            document.getElementById('inputTitle').value = 'RE: ' + (parent.title || '');
            const preview = (parent.content || '').substring(0, 200);
            document.getElementById('inputContent').value = `> ${preview}${parent.content.length > 200 ? '...' : ''}\n\n`;
            document.getElementById('writeModal').classList.add('visible');
            document.getElementById('inputContent').focus();
        };

        window._delete = async function(id) {
            if (!confirm('Delete this manifesto?')) return;
            await supabase.from('sloppygram_manifestos').delete().eq('id', id).eq('user_id', currentUser.id);
            manifestos = manifestos.filter(m => m.id !== id);
            renderManifestos();
            showToast('Manifesto deleted');
        };

        window._scrollTo = function(id) {
            const el = document.getElementById('manifesto-' + id);
            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        };

        window._filterTag = function(tag) {
            activeTagFilter = tag;
            document.getElementById('tagFilterBar').classList.add('show');
            document.getElementById('tagFilterLabel').textContent = '#' + tag;
            renderManifestos();
        };

        window.clearTagFilter = function() {
            activeTagFilter = null;
            document.getElementById('tagFilterBar').classList.remove('show');
            renderManifestos();
        };

        // Modal
        window.openModal = function() {
            forkingFromId = null;
            document.getElementById('modalTitle').textContent = 'üìú Write Your Manifesto';
            document.getElementById('forkIndicator').classList.remove('show');
            document.getElementById('inputTitle').value = '';
            document.getElementById('inputContent').value = '';
            document.getElementById('charCount').textContent = '0';
            pendingTags = [];
            renderPendingTags();
            document.getElementById('writeModal').classList.add('visible');
            document.getElementById('inputTitle').focus();
        };

        window.closeModal = function() {
            document.getElementById('writeModal').classList.remove('visible');
            forkingFromId = null;
        };

        window.submitManifesto = async function() {
            if (!currentUser) { showToast('Sign in first'); return; }
            const title = document.getElementById('inputTitle').value.trim();
            const content = document.getElementById('inputContent').value.trim();
            if (!title) { showToast('Title required'); return; }
            if (!content) { showToast('Content required'); return; }
            if (title.length > 200) { showToast('Title too long (max 200)'); return; }
            if (content.length > 5000) { showToast('Content too long (max 5000)'); return; }

            const { data: newM, error } = await supabase.from('sloppygram_manifestos').insert({
                title, content, username, avatar, upvotes: 0, user_id: currentUser.id
            }).select().single();

            if (error) { showToast('Failed to publish: ' + error.message); return; }

            // Save tags
            if (pendingTags.length > 0 && newM) {
                const tagRows = pendingTags.map(t => ({
                    manifesto_id: newM.id, tag: t.tag, parent_tag: t.parent || null, user_id: currentUser.id
                }));
                await supabase.from('sloppygram_manifesto_tags').insert(tagRows);
            }

            // Save lineage
            if (forkingFromId && newM) {
                await supabase.from('sloppygram_manifesto_lineage').insert({
                    manifesto_id: newM.id, parent_id: forkingFromId,
                    fork_type: 'synthesis', user_id: currentUser.id
                });
            }

            closeModal();
            showToast('Manifesto declared!');
            notifyParent({
                type: 'new-manifesto-created',
                manifesto: { id: newM?.id, title, username, forked: !!forkingFromId }
            });
            await loadManifestos();
        };

        // Tag input
        document.getElementById('tagInput').addEventListener('keydown', e => {
            if (e.key !== 'Enter') return;
            e.preventDefault();
            const val = e.target.value.trim();
            if (!val || val.length > 100) return;
            const parts = val.split('/');
            const tag = { tag: parts[parts.length - 1], parent: parts.length > 1 ? parts[0] : null };
            if (!pendingTags.some(t => t.tag === tag.tag && t.parent === tag.parent)) {
                pendingTags.push(tag);
                renderPendingTags();
            }
            e.target.value = '';
        });

        function renderPendingTags() {
            document.getElementById('pendingTags').innerHTML = pendingTags.map((t, i) => {
                const label = t.parent ? `${t.parent}/${t.tag}` : t.tag;
                return `<span class="pending-tag">#${esc(label)} <button onclick="window._removeTag(${i})">√ó</button></span>`;
            }).join('');
        }
        window._removeTag = function(i) { pendingTags.splice(i, 1); renderPendingTags(); };

        // Char count
        document.getElementById('inputContent').addEventListener('input', e => {
            document.getElementById('charCount').textContent = e.target.value.length;
        });

        // Sort
        window.setSort = function(sort) {
            currentSort = sort;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.toggle('active', b.dataset.sort === sort));
            renderManifestos();
        };

        // Helpers
        function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
        function timeAgo(ts) {
            if (!ts) return '';
            const d = Date.now() - new Date(ts).getTime();
            if (d < 60000) return 'just now';
            if (d < 3600000) return Math.floor(d / 60000) + 'm ago';
            if (d < 86400000) return Math.floor(d / 3600000) + 'h ago';
            return Math.floor(d / 86400000) + 'd ago';
        }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        // Real-time
        function setupRealtime() {
            supabase.channel('manifesto-updates')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'sloppygram_manifestos' }, () => {
                    setTimeout(loadManifestos, 500);
                })
                .subscribe();
        }

        // Init
        async function init() {
            await initAuth();
            await loadManifestos();
            setupRealtime();
        }
        init();
    </script>
<script src="/vibelib-extended.js"></script>
<script>
  // Compatibility Patch for Legacy Apps
  window.addEventListener("load", () => {
    if (window.SloppyKarma && window.VibeLib.Economy) {
      // Redirect old calls to new engine
      window.SloppyKarma.track = window.VibeLib.Economy.track;
    }
  });
</script>
</body>
</html>
