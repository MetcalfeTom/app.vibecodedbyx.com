<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Badnik Border Patrol ‚Äî Eggnet Command Deck</title>
    <meta
      name="description"
      content="Operate Eggman's command desk, scan incoming badnik blueprints, and decide which schematics make the cut before launch."
    />
    <meta property="og:title" content="Badnik Border Patrol ‚Äî Eggnet Command Deck" />
    <meta
      property="og:description"
      content="Scrutinise Sonic universe badnik schematics, spot sabotage, and keep the Egg Fleet secure in this frantic desk sim."
    />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://app.vibecodedbyx.com/meteor-mash/" />
    <meta property="og:image" content="./og-image.svg" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Badnik Border Patrol ‚Äî Eggnet Command Deck" />
    <meta
      name="twitter:description"
      content="Hold the command deck, vet badnik schematics, and keep sabotage from slipping into Eggman's armada."
    />
    <meta name="twitter:image" content="./og-image.svg" />
    <link rel="icon" href="./favicon.svg" type="image/svg+xml" />
    <meta name="theme-color" content="#0a1130" />
    <style>
      :root {
        color-scheme: dark;
        font-family: "Chakra Petch", "Inter", "Segoe UI", sans-serif;
        --space-bg: radial-gradient(circle at 16% -12%, rgba(80, 149, 255, 0.26), transparent 60%),
          radial-gradient(circle at 78% 120%, rgba(255, 99, 176, 0.3), transparent 65%),
          #040717;
        --deck-surface: rgba(13, 20, 53, 0.94);
        --panel-surface: rgba(16, 24, 64, 0.9);
        --panel-alt: rgba(10, 18, 48, 0.78);
        --accent: #ffd34d;
        --accent-soft: rgba(255, 211, 77, 0.18);
        --accent-glow: rgba(255, 92, 163, 0.4);
        --success: #7dfcd3;
        --warning: #ff9f68;
        --danger: #ff5d7a;
        --text: #f5f6ff;
        --text-muted: rgba(245, 246, 255, 0.68);
        --border: rgba(255, 255, 255, 0.14);
        --shadow-strong: 0 18px 38px rgba(4, 10, 32, 0.6);
        --shadow-soft: 0 12px 22px rgba(7, 16, 46, 0.45);
      }

      *, *::before, *::after {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: var(--space-bg);
        color: var(--text);
        display: flex;
        justify-content: center;
        align-items: stretch;
        padding: clamp(18px, 4vw, 52px);
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200' width='200' height='200'%3E%3Cg fill='rgba(78,118,255,0.18)'%3E%3Ccircle cx='20' cy='20' r='1'/><circle cx='60' cy='80' r='1'/><circle cx='150' cy='40' r='1.5'/><circle cx='120' cy='170' r='1'/><circle cx='10' cy='150' r='1.2'/><circle cx='180' cy='120' r='1.4'/><circle cx='90' cy='30' r='1.1'/><circle cx='40' cy='120' r='1'/><circle cx='160' cy='180' r='1.3'/%3E%3C/g%3E%3C/svg%3E");
        opacity: 0.35;
        pointer-events: none;
        mix-blend-mode: screen;
      }

      .app-surface {
        position: relative;
        width: min(1160px, 100%);
        display: grid;
        gap: clamp(20px, 4vw, 34px);
        z-index: 1;
      }

      .hero {
        display: grid;
        gap: 18px;
        background: var(--deck-surface);
        border-radius: 28px;
        padding: clamp(18px, 3vw, 36px);
        border: 1px solid rgba(255, 255, 255, 0.12);
        box-shadow: var(--shadow-strong);
      }

      .hero-top {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        justify-content: space-between;
        align-items: flex-start;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.08);
        font-size: 0.85rem;
        letter-spacing: 0.16em;
        text-transform: uppercase;
        color: var(--text-muted);
      }

      h1 {
        margin: 0;
        font-size: clamp(2.4rem, 6vw, 3.4rem);
        letter-spacing: 0.08em;
        text-transform: uppercase;
        text-shadow: 0 0 36px var(--accent-glow);
      }

      .deck-copy {
        margin: 0;
        max-width: 640px;
        color: var(--text-muted);
        line-height: 1.6;
      }

      .hero-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .backlink {
        justify-self: start;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.14);
        color: var(--text);
        text-decoration: none;
        transition: background 0.2s ease, transform 0.2s ease;
        font-size: 0.95rem;
      }

      .backlink:hover,
      .backlink:focus-visible {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-1px);
        outline: none;
      }

      .btn {
        appearance: none;
        border: 1px solid transparent;
        border-radius: 16px;
        padding: 12px 20px;
        font-size: 0.95rem;
        font-family: inherit;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        color: #060815;
        background: var(--accent);
        box-shadow: 0 12px 24px rgba(255, 211, 77, 0.25);
        transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease;
      }

      .btn:hover:enabled,
      .btn:focus-visible:enabled {
        transform: translateY(-1px);
        box-shadow: 0 16px 28px rgba(255, 211, 77, 0.35);
        outline: none;
      }

      .btn:disabled {
        opacity: 0.45;
        cursor: not-allowed;
        box-shadow: none;
      }

      .btn.secondary {
        background: transparent;
        color: var(--text);
        border-color: rgba(255, 255, 255, 0.16);
        box-shadow: none;
      }

      .btn.secondary:hover:enabled,
      .btn.secondary:focus-visible:enabled {
        background: rgba(255, 255, 255, 0.12);
      }

      .btn.danger {
        background: var(--danger);
        color: #160308;
        box-shadow: 0 12px 24px rgba(255, 93, 122, 0.32);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: clamp(12px, 3vw, 20px);
      }

      .stat-card {
        background: var(--panel-surface);
        border-radius: 20px;
        padding: 16px 18px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        display: grid;
        gap: 6px;
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow-soft);
      }

      .stat-card::after {
        content: "";
        position: absolute;
        inset: -30% -20% auto -20%;
        height: 90%;
        background: linear-gradient(120deg, rgba(255, 255, 255, 0.12), transparent 70%);
        opacity: 0.55;
        pointer-events: none;
      }

      .stat-label {
        letter-spacing: 0.16em;
        font-size: 0.68rem;
        text-transform: uppercase;
        color: var(--text-muted);
      }

      .stat-value {
        font-size: clamp(1.4rem, 2.6vw, 1.9rem);
        font-weight: 600;
      }

      .stat-small {
        font-size: clamp(1rem, 2.4vw, 1.2rem);
      }

      .status-line {
        margin: 0;
        padding: 14px 18px;
        border-radius: 16px;
        background: var(--panel-alt);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--text-muted);
        box-shadow: var(--shadow-soft);
      }

      .deck {
        display: grid;
        gap: clamp(16px, 3vw, 26px);
        grid-template-columns: minmax(0, 3fr) minmax(0, 2fr);
        align-items: stretch;
      }

      .blueprint-card {
        display: grid;
        gap: 18px;
        padding: clamp(18px, 3vw, 28px);
        background: var(--panel-surface);
        border-radius: 28px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow-strong);
      }

      .blueprint-card::before {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at 18% 20%, rgba(255, 255, 255, 0.08), transparent 65%);
        opacity: 0.6;
        pointer-events: none;
      }

      .case-header {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 12px;
        position: relative;
        z-index: 1;
      }

      .case-banner {
        font-size: 0.85rem;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        color: var(--text-muted);
      }

      .holo-frame {
        position: relative;
        display: grid;
        place-items: center;
        border-radius: 24px;
        background: linear-gradient(160deg, rgba(255, 255, 255, 0.08), transparent 70%);
        border: 1px solid rgba(255, 255, 255, 0.12);
        padding: clamp(18px, 3vw, 26px);
        min-height: 240px;
        overflow: hidden;
      }

      .holo-frame svg {
        width: min(240px, 100%);
        height: auto;
        filter: drop-shadow(0 12px 18px rgba(0, 0, 0, 0.35));
      }

      .holo-placeholder {
        font-size: clamp(2rem, 8vw, 3rem);
        color: var(--text-muted);
      }

      .blueprint-meta {
        display: grid;
        gap: 8px;
        z-index: 1;
      }

      .blueprint-meta h2 {
        margin: 0;
        font-size: clamp(1.6rem, 5vw, 2.1rem);
      }

      .blueprint-meta p {
        margin: 0;
        color: var(--text-muted);
      }

      .spec-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 12px;
      }

      .spec {
        background: rgba(6, 12, 32, 0.4);
        border-radius: 16px;
        padding: 12px 14px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: grid;
        gap: 4px;
      }

      .spec dt {
        font-size: 0.72rem;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        color: var(--text-muted);
      }

      .spec dd {
        margin: 0;
        font-family: "IBM Plex Mono", "Chakra Petch", monospace;
        font-size: 0.92rem;
      }

      .story-chip {
        padding: 14px 16px;
        border-radius: 18px;
        background: rgba(255, 255, 255, 0.07);
        border: 1px solid rgba(255, 255, 255, 0.14);
        color: var(--text-muted);
        font-size: 0.95rem;
        line-height: 1.5;
        z-index: 1;
      }

      .decision-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        z-index: 1;
      }

      .intel-panel {
        display: grid;
        gap: 18px;
        background: var(--panel-alt);
        border-radius: 28px;
        padding: clamp(18px, 3vw, 28px);
        border: 1px solid rgba(255, 255, 255, 0.12);
        box-shadow: var(--shadow-soft);
      }

      .panel-title {
        margin: 0 0 6px;
        font-size: 1.1rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
      }

      .rules-list {
        margin: 0;
        padding-left: 18px;
        display: grid;
        gap: 8px;
        color: var(--text-muted);
      }

      .intel-output {
        min-height: 80px;
        background: rgba(6, 12, 32, 0.4);
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        padding: 12px 14px;
        font-size: 0.92rem;
        line-height: 1.5;
        color: var(--text-muted);
      }

      .intel-output div {
        padding: 4px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }

      .intel-output div:last-child {
        border-bottom: none;
      }

      .log-board {
        display: grid;
        gap: clamp(16px, 3vw, 24px);
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      }

      .log-card,
      .notes-card {
        background: var(--panel-surface);
        border-radius: 24px;
        padding: clamp(18px, 3vw, 26px);
        border: 1px solid rgba(255, 255, 255, 0.12);
        box-shadow: var(--shadow-soft);
        display: grid;
        gap: 12px;
      }

      .log-stream {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 220px;
        overflow-y: auto;
        font-family: "IBM Plex Mono", monospace;
        font-size: 0.86rem;
      }

      .log-stream span {
        padding: 10px 12px;
        border-radius: 12px;
        background: rgba(6, 12, 32, 0.55);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      .notes-list {
        margin: 0;
        display: grid;
        gap: 10px;
      }

      .notes-list dt {
        font-size: 0.78rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: var(--text-muted);
      }

      .notes-list dd {
        margin: 0;
        font-size: 0.95rem;
        line-height: 1.5;
      }

      .picker-row {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        margin-bottom: 12px;
      }

      label span {
        display: block;
        margin-bottom: 6px;
        font-size: 0.88rem;
        color: var(--text-muted);
      }

      input[type="color"] {
        width: 100%;
        height: 48px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 14px;
        background: transparent;
        cursor: pointer;
      }

      .toggle {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        color: var(--text-muted);
        font-size: 0.95rem;
        margin-bottom: 12px;
      }

      .toggle input {
        width: 18px;
        height: 18px;
      }

      .premium-card,
      .upgrade-card {
        background: var(--panel-alt);
        border-radius: 28px;
        padding: clamp(18px, 3vw, 28px);
        border: 1px solid rgba(255, 255, 255, 0.12);
        box-shadow: var(--shadow-soft);
        display: grid;
        gap: 16px;
      }

      footer {
        text-align: center;
        color: var(--text-muted);
        font-size: 0.92rem;
        padding-bottom: 10px;
      }

      .hidden {
        display: none !important;
      }

      @media (max-width: 1024px) {
        .deck {
          grid-template-columns: 1fr;
        }

        .hero-top {
          flex-direction: column;
          align-items: flex-start;
        }
      }

      @media (max-width: 640px) {
        body {
          padding: 16px;
        }

        .hero-actions {
          flex-direction: column;
          width: 100%;
        }

        .btn,
        .btn.secondary,
        .btn.danger {
          width: 100%;
          justify-content: center;
        }

        .stats-grid {
          grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
        }
      }
    </style>
  </head>
  <body>
    <div class="app-surface">
      <header class="hero">
        <div class="hero-top">
          <div>
            <span class="badge">Eggnet Command Deck</span>
            <h1>Badnik Border Patrol</h1>
            <p class="deck-copy">
              Scrutinise every incoming badnik schematic, reject sabotage, and protect the Egg Fleet before Sonic blurs into
              orbit.
            </p>
          </div>
          <div class="hero-actions">
            <button class="btn" id="start-btn" type="button">Launch shift</button>
            <button class="btn secondary" id="reset-btn" type="button" disabled>Reset deck</button>
            <button class="btn secondary" id="skip-btn" type="button" disabled>Skip blueprint</button>
          </div>
        </div>
        <a class="backlink" href="https://www.vibecodedbyx.com" target="_blank" rel="noreferrer noopener"
          >‚¨Ö Back to the livestream</a
        >
      </header>

      <section class="stats-grid" aria-label="Shift dashboard">
        <div class="stat-card">
          <span class="stat-label">Ring score</span>
          <span class="stat-value" id="score-value">0</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Blueprints processed</span>
          <span class="stat-value stat-small" id="cases-value">0 / 0</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Accuracy</span>
          <span class="stat-value stat-small" id="accuracy-value">‚Äî</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Warnings remaining</span>
          <span class="stat-value stat-small" id="warnings-value">3</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Shift timer</span>
          <span class="stat-value stat-small" id="timer-value">60.0s</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Personal best</span>
          <span class="stat-value stat-small" id="highscore-value">0</span>
        </div>
      </section>

      <p class="status-line" id="status-message">Station idle. Fire up the scanner when you're ready.</p>

      <section class="deck">
        <article class="blueprint-card">
          <div class="case-header">
            <span class="case-banner" id="case-banner">Awaiting transmission‚Ä¶</span>
            <span class="case-banner" id="model-id">---- ----</span>
          </div>
          <div class="holo-frame" id="holo-portrait" aria-hidden="true">
            <div class="holo-placeholder">‚ùì</div>
          </div>
          <div class="blueprint-meta">
            <h2 id="badnik-name">No blueprint loaded</h2>
            <p id="badnik-tagline">Connect to Eggnet to receive schematics.</p>
          </div>
          <div class="spec-grid" aria-label="Blueprint specification">
            <dl class="spec">
              <dt>Power core</dt>
              <dd id="power-core">‚Äî</dd>
            </dl>
            <dl class="spec">
              <dt>Chaos output</dt>
              <dd id="chaos-output">‚Äî</dd>
            </dl>
            <dl class="spec">
              <dt>Mission zone</dt>
              <dd id="mission-zone">‚Äî</dd>
            </dl>
            <dl class="spec">
              <dt>Loadout</dt>
              <dd id="loadout">‚Äî</dd>
            </dl>
            <dl class="spec">
              <dt>Origin plant</dt>
              <dd id="origin">‚Äî</dd>
            </dl>
          </div>
          <div class="story-chip" id="intel-note">Field transmissions will appear once the sweep begins.</div>
          <div class="decision-row">
            <button class="btn" id="accept-btn" type="button" disabled>Approve blueprint</button>
            <button class="btn danger" id="deny-btn" type="button" disabled>Reject blueprint</button>
          </div>
        </article>

        <aside class="intel-panel">
          <div>
            <h3 class="panel-title">Eggnet rulebook</h3>
            <ol class="rules-list" id="rules-list">
              <li>Power cores must register at least <strong>120 ring watts</strong>.</li>
              <li>Only <strong>Eggman Industries</strong> factories are certified.</li>
              <li>Chaos output above <strong>150%</strong> signals sabotage.</li>
              <li>Deployments to <strong>Marble Garden</strong> or <strong>Stardust Speedway</strong> are frozen.</li>
              <li>Mission loadout has to match the profile checklist.</li>
            </ol>
          </div>
          <div>
            <h3 class="panel-title">Intel mode</h3>
            <div class="intel-output" id="intel-output">Enable Intel Mode (premium) to surface likely sabotage.</div>
          </div>
          <div>
            <h3 class="panel-title">Command chatter</h3>
            <p class="status-line" id="chatter-line">No transmissions yet.</p>
          </div>
        </aside>
      </section>

      <section class="log-board">
        <div class="log-card">
          <h3 class="panel-title">Security log</h3>
          <div class="log-stream" id="log-stream">
            <span>No transmissions recorded yet.</span>
          </div>
        </div>
        <div class="notes-card">
          <h3 class="panel-title">Field notes</h3>
          <dl class="notes-list">
            <div>
              <dt>Spark core notes</dt>
              <dd id="core-notes">‚Äî</dd>
            </div>
            <div>
              <dt>Quirk registry</dt>
              <dd id="quirk-registry">‚Äî</dd>
            </div>
            <div>
              <dt>Latest intel ping</dt>
              <dd id="field-chatter">‚Äî</dd>
            </div>
          </dl>
        </div>
      </section>

      <section class="premium-card hidden" id="premium-content">
        <h3 class="panel-title">Premium arsenal</h3>
        <p class="status-line">
          Customize Eggnet theming and flip on Intel Mode overlays that auto-call sabotage the instant it hits the queue.
        </p>
        <form id="premium-form">
          <div class="picker-row">
            <label>
              <span>Deck surface</span>
              <input type="color" id="desk-color" name="desk" value="#102050" />
            </label>
            <label>
              <span>Accent neon</span>
              <input type="color" id="accent-color" name="accent" value="#ffd34d" />
            </label>
          </div>
          <label class="toggle">
            <input type="checkbox" id="intel-toggle" />
            Engage Intel Mode (auto sabotage hints)
          </label>
          <button class="btn" type="submit">Apply custom theme</button>
        </form>
      </section>

      <section class="upgrade-card" id="upgrade-button">
        <h3 class="panel-title">Upgrade for Intel Mode</h3>
        <p class="status-line">
          Premium desk chiefs unlock command-deck recolors and Intel overlays. Tap upgrade in your profile menu to enlist.
        </p>
      </section>

      <footer>Built live on stream ‚Äî share your top sabotage catch streak and tag @VibeCodedByX ‚öôÔ∏èü¶î</footer>
    </div>

    <script type="module">
      import { supabaseSession, isUserPremium } from "../../supabase-config.js";

      const SHIFT_DURATION = 75_000;
      const CASES_PER_SHIFT = 10;
      const MAX_WARNINGS = 3;

      const BADNIK_TYPES = [
        {
          id: "motobug",
          name: "Motobug V6",
          tagline: "Patrol racer with thruster overdrive.",
          icon: "üèéÔ∏è",
          palette: {
            glow: "#ff5894",
            accent: "#ffd34d",
            bg: "#2a0824",
            stroke: "#ff7ab7",
          },
        },
        {
          id: "buzzbomber",
          name: "Buzz Bomber Neo",
          tagline: "Hover assault unit with stinger payload.",
          icon: "üêù",
          palette: {
            glow: "#ffc247",
            accent: "#45e6ff",
            bg: "#241300",
            stroke: "#8ef1ff",
          },
        },
        {
          id: "eggpawn",
          name: "Egg Pawn Prime",
          tagline: "Adaptive grunt with modular armor.",
          icon: "ü§ñ",
          palette: {
            glow: "#6f8bff",
            accent: "#ff5da2",
            bg: "#0d1b54",
            stroke: "#8ea5ff",
          },
        },
        {
          id: "orbinaut",
          name: "Orbinaut Flux",
          tagline: "Defensive drone orbiting plasma mines.",
          icon: "ü™ê",
          palette: {
            glow: "#94fff3",
            accent: "#ffd34d",
            bg: "#04292f",
            stroke: "#5affde",
          },
        },
        {
          id: "clucker",
          name: "Aquis Clucker",
          tagline: "Sea-floor turret with sonar beacon.",
          icon: "üêî",
          palette: {
            glow: "#ff8fb4",
            accent: "#45ffe1",
            bg: "#240816",
            stroke: "#ffe1f0",
          },
        },
      ];

      const MISSION_ZONES = [
        "Chemical Plant",
        "Angel Island",
        "Oil Ocean",
        "Hydrocity",
        "Marble Garden",
        "Stardust Speedway",
        "Press Garden",
        "Aquatic Ruin",
      ];

      const LOADOUTS = [
        "Drill claw",
        "Ring siphon",
        "Plasma stinger",
        "Spike mine array",
        "Steam cannon",
        "Buzz saw jets",
        "Chaos net",
        "Sand skimmer",
      ];

      const REQUIRED_LOADOUTS = {
        "Chemical Plant": ["Ring siphon", "Chaos net"],
        "Angel Island": ["Spike mine array", "Buzz saw jets"],
        "Oil Ocean": ["Steam cannon", "Sand skimmer"],
        "Hydrocity": ["Chaos net", "Spike mine array"],
        "Press Garden": ["Buzz saw jets", "Drill claw"],
        "Aquatic Ruin": ["Sand skimmer", "Chaos net"],
      };

      const CORE_NOTES = [
        "Heat sinks replaced after Flying Battery skirmish.",
        "Power couplers retuned for loop acceleration.",
        "Chaos capacitor emits faint static at idle.",
        "Oil Ocean residue scrubbed from actuator joints.",
        "Rotor fins swapped for lightweight alloy.",
      ];

      const QUIRK_REGISTRY = [
        "Keeps requesting chiptune soundtrack uploads.",
        "Chants 'Eggman' when idle longer than 12 seconds.",
        "Collects rings despite official policy.",
        "Paint job attracts rogue Chao swarms.",
        "Randomly quotes Rouge's mission briefs.",
      ];

      const CHATTER = [
        "Team Shadow flagged counterfeit cores in this sector.",
        "Metal Sonic uploaded a firmware integrity sweep.",
        "Rouge intercepted a fake Egg Carrier badge.",
        "Sonic sighted three zones away ‚Äî tighten checks.",
        "Dr. Eggman wants stealthier jet trails by sundown.",
      ];

      const RULES = [
        {
          id: "power",
          test: (bp) => bp.powerCore >= 120,
          message: (bp) => `Power core only ${bp.powerCore} ring watts (< 120).`,
        },
        {
          id: "factory",
          test: (bp) => bp.origin === "Eggman Industries",
          message: (bp) => `${bp.origin} is not Eggman-certified.`,
        },
        {
          id: "chaos",
          test: (bp) => bp.chaosOutput <= 150,
          message: (bp) => `Chaos output ${bp.chaosOutput}% exceeds safe 150%.`,
        },
        {
          id: "mission",
          test: (bp) => !["Marble Garden", "Stardust Speedway"].includes(bp.missionZone),
          message: (bp) => `${bp.missionZone} deployments are frozen after sabotage.`,
        },
        {
          id: "loadout",
          test: (bp) => REQUIRED_LOADOUTS[bp.missionZone]?.includes(bp.loadout) ?? true,
          message: (bp) => `Loadout "${bp.loadout}" is not approved for ${bp.missionZone}.`,
        },
      ];

      const SABOTAGE_ACTIONS = [
        (bp) => (bp.powerCore = Math.max(80, bp.powerCore - Math.floor(Math.random() * 70 + 20))),
        (bp) => (bp.origin = "Mystery Foundry"),
        (bp) => (bp.chaosOutput = Math.floor(160 + Math.random() * 40)),
        (bp) => (bp.missionZone = "Marble Garden"),
        (bp) => {
          const pool = LOADOUTS.filter((item) => !(REQUIRED_LOADOUTS[bp.missionZone] || []).includes(item));
          if (pool.length) bp.loadout = pool[Math.floor(Math.random() * pool.length)];
        },
      ];

      const elements = {
        startBtn: document.getElementById("start-btn"),
        resetBtn: document.getElementById("reset-btn"),
        skipBtn: document.getElementById("skip-btn"),
        acceptBtn: document.getElementById("accept-btn"),
        denyBtn: document.getElementById("deny-btn"),
        score: document.getElementById("score-value"),
        cases: document.getElementById("cases-value"),
        accuracy: document.getElementById("accuracy-value"),
        warnings: document.getElementById("warnings-value"),
        timer: document.getElementById("timer-value"),
        highscore: document.getElementById("highscore-value"),
        status: document.getElementById("status-message"),
        banner: document.getElementById("case-banner"),
        modelId: document.getElementById("model-id"),
        portrait: document.getElementById("holo-portrait"),
        name: document.getElementById("badnik-name"),
        tagline: document.getElementById("badnik-tagline"),
        powerCore: document.getElementById("power-core"),
        chaosOutput: document.getElementById("chaos-output"),
        missionZone: document.getElementById("mission-zone"),
        loadout: document.getElementById("loadout"),
        origin: document.getElementById("origin"),
        intelNote: document.getElementById("intel-note"),
        coreNotes: document.getElementById("core-notes"),
        quirkRegistry: document.getElementById("quirk-registry"),
        fieldChatter: document.getElementById("field-chatter"),
        chatterLine: document.getElementById("chatter-line"),
        intelOutput: document.getElementById("intel-output"),
        logStream: document.getElementById("log-stream"),
        premiumPanel: document.getElementById("premium-content"),
        upgradeCard: document.getElementById("upgrade-button"),
        premiumForm: document.getElementById("premium-form"),
        intelToggle: document.getElementById("intel-toggle"),
        deskColor: document.getElementById("desk-color"),
        accentColor: document.getElementById("accent-color"),
      };

      const state = {
        queue: [],
        index: 0,
        score: 0,
        reviewed: 0,
        correct: 0,
        warnings: 0,
        highScore: 0,
        running: false,
        shiftEndsAt: 0,
        timeLeft: SHIFT_DURATION,
        raf: null,
        premium: false,
        intelMode: false,
      };

      function nowStamp() {
        return new Date().toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
      }

      function randomItem(list) {
        return list[Math.floor(Math.random() * list.length)];
      }

      function pad(value, size = 3) {
        return value.toString().padStart(size, "0");
      }

      function composeModelId(type) {
        return `${type.id.toUpperCase()}-${pad(Math.floor(Math.random() * 999))}-${pad(Math.floor(Math.random() * 999))}`;
      }

      function buildBlueprint(index) {
        const type = randomItem(BADNIK_TYPES);
        const missionZone = randomItem(MISSION_ZONES);
        const eligibleLoadouts = REQUIRED_LOADOUTS[missionZone] || LOADOUTS;
        const loadout = randomItem(eligibleLoadouts);
        const blueprint = {
          type,
          modelId: composeModelId(type),
          missionZone,
          loadout,
          powerCore: Math.floor(120 + Math.random() * 80),
          chaosOutput: Math.floor(90 + Math.random() * 50),
          origin: "Eggman Industries",
          intel: randomItem(CHATTER),
          quirk: randomItem(QUIRK_REGISTRY),
          coreNote: randomItem(CORE_NOTES),
        };

        if (Math.random() < 0.55) {
          randomItem(SABOTAGE_ACTIONS)(blueprint);
        }

        const failures = RULES.filter((rule) => !rule.test(blueprint));
        return {
          id: `case-${Date.now()}-${index}`,
          blueprint,
          failures,
        };
      }

      function createQueue() {
        return Array.from({ length: CASES_PER_SHIFT }, (_, idx) => buildBlueprint(idx));
      }

      function resetPortrait() {
        elements.portrait.innerHTML = '<div class="holo-placeholder">‚ùì</div>';
      }

      function drawPortrait(blueprint) {
        const {
          type: {
            icon,
            palette: { glow, accent, bg, stroke },
          },
          missionZone,
          powerCore,
          chaosOutput,
          loadout,
        } = blueprint;

        const svg = `
          <svg viewBox="0 0 260 260" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <radialGradient id="glow-${blueprint.type.id}" cx="50%" cy="50%" r="70%">
                <stop offset="0%" stop-color="${glow}" stop-opacity="0.8" />
                <stop offset="100%" stop-color="${bg}" stop-opacity="0.2" />
              </radialGradient>
            </defs>
            <rect width="260" height="260" rx="28" fill="${bg}" />
            <g>
              <circle cx="130" cy="120" r="110" fill="url(#glow-${blueprint.type.id})" />
              <circle cx="130" cy="120" r="78" fill="rgba(6,12,32,0.55)" stroke="${accent}" stroke-width="4" />
              <text x="130" y="120" font-size="52" text-anchor="middle" alignment-baseline="central">${icon}</text>
              <text x="130" y="162" text-anchor="middle" font-size="14" fill="${accent}" font-family="'Chakra Petch', sans-serif">${missionZone}</text>
            </g>
            <g font-family="'IBM Plex Mono', monospace" font-size="12" fill="${stroke}">
              <text x="24" y="210">Power ${powerCore}</text>
              <text x="24" y="228">Chaos ${chaosOutput}%</text>
              <text x="24" y="246">Loadout ${loadout}</text>
            </g>
          </svg>
        `;
        elements.portrait.innerHTML = svg;
      }

      function updateStats() {
        const total = state.queue.length || CASES_PER_SHIFT;
        elements.score.textContent = state.score.toString();
        elements.cases.textContent = `${state.reviewed} / ${total}`;
        const accuracy = state.reviewed ? Math.round((state.correct / state.reviewed) * 100) : null;
        elements.accuracy.textContent = accuracy === null ? "‚Äî" : `${accuracy}%`;
        elements.warnings.textContent = Math.max(0, MAX_WARNINGS - state.warnings).toString();
        elements.timer.textContent = `${(state.timeLeft / 1000).toFixed(1)}s`;
        elements.highscore.textContent = state.highScore.toString();
      }

      function updateIntel(failures = []) {
        if (!state.premium || !state.intelMode) {
          elements.intelOutput.textContent = state.premium
            ? "Intel Mode disabled. Flip the toggle to auto-call sabotage."
            : "Enable Intel Mode (premium) to surface likely sabotage.";
          return;
        }

        const current = state.queue[state.index];
        if (!current) {
          elements.intelOutput.textContent = "Intel Mode standing by. Launch the shift to receive overlays.";
          return;
        }

        if (!failures.length) {
          elements.intelOutput.textContent = "No sabotage detected. Blueprint passes current rule stack.";
          return;
        }

        elements.intelOutput.innerHTML = failures
          .map((failure) => `<div>${failure.message(current.blueprint)}</div>`)
          .join("");
      }

      function logEvent(message) {
        const entry = document.createElement("span");
        entry.textContent = `[${nowStamp()}] ${message}`;
        elements.logStream.prepend(entry);
        while (elements.logStream.children.length > 28) {
          elements.logStream.removeChild(elements.logStream.lastElementChild);
        }
      }

      function setStatus(text) {
        elements.status.textContent = text;
      }

      function renderBlueprint() {
        const current = state.queue[state.index];
        if (!current) {
          elements.banner.textContent = "Awaiting transmission‚Ä¶";
          elements.modelId.textContent = "---- ----";
          elements.name.textContent = "No blueprint loaded";
          elements.tagline.textContent = "Connect to Eggnet to receive schematics.";
          elements.powerCore.textContent = "‚Äî";
          elements.chaosOutput.textContent = "‚Äî";
          elements.missionZone.textContent = "‚Äî";
          elements.loadout.textContent = "‚Äî";
          elements.origin.textContent = "‚Äî";
          elements.intelNote.textContent = "Field transmissions will appear once the sweep begins.";
          elements.coreNotes.textContent = "‚Äî";
          elements.quirkRegistry.textContent = "‚Äî";
          elements.fieldChatter.textContent = "‚Äî";
          elements.chatterLine.textContent = "No transmissions yet.";
          resetPortrait();
          updateIntel();
          return;
        }

        const { blueprint, failures } = current;
        elements.banner.textContent = `Transmission ${state.index + 1} / ${state.queue.length}`;
        elements.modelId.textContent = blueprint.modelId;
        elements.name.textContent = blueprint.type.name;
        elements.tagline.textContent = blueprint.type.tagline;
        elements.powerCore.textContent = `${blueprint.powerCore} ring watts`;
        elements.chaosOutput.textContent = `${blueprint.chaosOutput}% flux`;
        elements.missionZone.textContent = blueprint.missionZone;
        elements.loadout.textContent = blueprint.loadout;
        elements.origin.textContent = blueprint.origin;
        elements.intelNote.textContent = blueprint.intel;
        elements.coreNotes.textContent = blueprint.coreNote;
        elements.quirkRegistry.textContent = blueprint.quirk;
        elements.fieldChatter.textContent = randomItem(CHATTER);
        elements.chatterLine.textContent = randomItem(CHATTER);
        drawPortrait(blueprint);

        const disabled = !state.running;
        elements.acceptBtn.disabled = disabled;
        elements.denyBtn.disabled = disabled;
        elements.skipBtn.disabled = disabled;
        updateIntel(failures);
      }

      function scoreDecision(correct, failures) {
        if (correct) {
          const bonus = Math.max(1, failures.length);
          state.score += 150 + bonus * 30;
          state.correct += 1;
        } else {
          state.score = Math.max(0, state.score - 120);
          state.warnings += 1;
        }
      }

      function advanceBlueprint() {
        state.index += 1;
        if (state.index >= state.queue.length) {
          endShift("queue");
        } else {
          renderBlueprint();
          updateStats();
        }
      }

      function handleDecision(decision) {
        if (!state.running) return;
        const current = state.queue[state.index];
        if (!current) return;

        const shouldApprove = current.failures.length === 0;
        const correct = (decision === "approve" && shouldApprove) || (decision === "deny" && !shouldApprove);
        scoreDecision(correct, current.failures);
        state.reviewed += 1;
        updateStats();

        if (correct) {
          setStatus("Solid call. Eggnet is routing the next blueprint.");
          logEvent(`‚úî Case ${state.index + 1} cleared. Score +${150 + Math.max(1, current.failures.length) * 30}.`);
        } else {
          const reason = current.failures[0]?.message(current.blueprint) ?? "Incorrect decision.";
          setStatus(`Warning logged: ${reason}`);
          logEvent(`‚úñ Case ${state.index + 1} flagged. Reason: ${reason}`);
        }

        if (state.warnings >= MAX_WARNINGS) {
          endShift("warnings");
          return;
        }

        advanceBlueprint();
      }

      function skipBlueprint() {
        if (!state.running) return;
        const current = state.queue[state.index];
        if (!current) return;
        state.score = Math.max(0, state.score - 60);
        state.reviewed += 1;
        setStatus("Blueprint skipped. Eggman wants a report on that.");
        logEvent(`‚Ü∑ Case ${state.index + 1} skipped. Ring penalty applied.`);
        advanceBlueprint();
      }

      function shiftLoop(timestamp) {
        if (!state.running) return;
        if (!state.shiftEndsAt) {
          state.shiftEndsAt = timestamp + SHIFT_DURATION;
        }
        state.timeLeft = Math.max(0, state.shiftEndsAt - timestamp);
        updateStats();
        if (state.timeLeft <= 0) {
          endShift("time");
          return;
        }
        state.raf = requestAnimationFrame(shiftLoop);
      }

      function startShift() {
        Object.assign(state, {
          queue: createQueue(),
          index: 0,
          score: 0,
          reviewed: 0,
          correct: 0,
          warnings: 0,
          running: true,
          shiftEndsAt: 0,
          timeLeft: SHIFT_DURATION,
        });
        elements.startBtn.disabled = true;
        elements.resetBtn.disabled = false;
        elements.skipBtn.disabled = false;
        elements.acceptBtn.disabled = false;
        elements.denyBtn.disabled = false;
        setStatus("Sweep live. Scrutinise every spec.");
        elements.logStream.innerHTML = "";
        logEvent("Security sweep initiated. Eggman is watching your accuracy.");
        renderBlueprint();
        updateStats();
        cancelAnimationFrame(state.raf);
        state.raf = requestAnimationFrame(shiftLoop);
      }

      function endShift(reason) {
        state.running = false;
        cancelAnimationFrame(state.raf);
        elements.startBtn.disabled = false;
        elements.acceptBtn.disabled = true;
        elements.denyBtn.disabled = true;
        elements.skipBtn.disabled = true;
        elements.resetBtn.disabled = false;

        let summary = "Sweep complete.";
        if (reason === "time") summary = "Timer expired. Sonic breached the perimeter!";
        if (reason === "warnings") summary = "Three warnings triggered. Eggnet locked you out.";
        if (reason === "queue") summary = "Queue cleared. Eggman begrudgingly approves.";

        setStatus(`${summary} Final score ${state.score}.`);
        logEvent(`Sweep ended (${reason}). Final score ${state.score}. Accuracy ${elements.accuracy.textContent}.`);

        if (state.score > state.highScore) {
          state.highScore = state.score;
          logEvent(`üèÜ New personal best recorded: ${state.highScore}.`);
        }

        updateStats();
      }

      function hardReset() {
        cancelAnimationFrame(state.raf);
        state.running = false;
        state.queue = [];
        state.index = 0;
        state.score = 0;
        state.reviewed = 0;
        state.correct = 0;
        state.warnings = 0;
        state.timeLeft = SHIFT_DURATION;
        elements.startBtn.disabled = false;
        elements.resetBtn.disabled = true;
        elements.skipBtn.disabled = true;
        elements.acceptBtn.disabled = true;
        elements.denyBtn.disabled = true;
        elements.logStream.innerHTML = '<span>No transmissions recorded yet.</span>';
        setStatus("Station idle. Fire up the scanner when you're ready.");
        resetPortrait();
        renderBlueprint();
        updateStats();
      }

      function hexToRgba(hex, alpha = 0.22) {
        let normalized = hex.replace("#", "");
        if (normalized.length === 3) {
          normalized = normalized
            .split("")
            .map((char) => char + char)
            .join("");
        }
        const num = parseInt(normalized, 16);
        const r = (num >> 16) & 255;
        const g = (num >> 8) & 255;
        const b = num & 255;
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      }

      function applyPremiumTheme(event) {
        event.preventDefault();
        if (!state.premium) {
          setStatus("Premium required to recolor the desk.");
          return;
        }
        const desk = elements.deskColor.value;
        const accent = elements.accentColor.value;
        document.documentElement.style.setProperty("--deck-surface", `${desk}f2`);
        document.documentElement.style.setProperty("--panel-surface", `${desk}e6`);
        document.documentElement.style.setProperty("--panel-alt", `${desk}d9`);
        document.documentElement.style.setProperty("--accent", accent);
        document.documentElement.style.setProperty("--accent-soft", hexToRgba(accent, 0.18));
        setStatus("Custom desk applied.");
        logEvent(`Desk aura shifted to ${desk}, accent ${accent}.`);
        updateIntel(state.queue[state.index]?.failures ?? []);
      }

      function toggleIntelMode(event) {
        if (!state.premium) {
          event.target.checked = false;
          setStatus("Premium required for Intel Mode.");
          return;
        }
        state.intelMode = event.target.checked;
        logEvent(state.intelMode ? "Intel Mode engaged." : "Intel Mode disengaged.");
        updateIntel(state.queue[state.index]?.failures ?? []);
      }

      async function initAuth() {
        try {
          await supabaseSession();
        } catch (error) {
          console.error("Session error", error);
          setStatus("Auth hiccup ‚Äî refresh if Intel Mode fails.");
        }
        try {
          state.premium = await isUserPremium();
        } catch (error) {
          console.error("Premium lookup failed", error);
          state.premium = false;
        }

        if (state.premium) {
          elements.premiumPanel.classList.remove("hidden");
          elements.upgradeCard.classList.add("hidden");
          elements.premiumPanel.style.display = "block";
          elements.upgradeCard.style.display = "none";
          setStatus("Premium systems online. Customize the deck or engage Intel Mode.");
        } else {
          elements.premiumPanel.classList.add("hidden");
          elements.upgradeCard.classList.remove("hidden");
          elements.premiumPanel.style.display = "none";
          elements.upgradeCard.style.display = "block";
        }
      }

      function bindEvents() {
        elements.startBtn.addEventListener("click", startShift);
        elements.resetBtn.addEventListener("click", hardReset);
        elements.skipBtn.addEventListener("click", skipBlueprint);
        elements.acceptBtn.addEventListener("click", () => handleDecision("approve"));
        elements.denyBtn.addEventListener("click", () => handleDecision("deny"));
        elements.premiumForm.addEventListener("submit", applyPremiumTheme);
        elements.intelToggle.addEventListener("change", toggleIntelMode);
        window.addEventListener("blur", () => {
          if (state.running) {
            endShift("focus");
            logEvent("Sweep auto-paused ‚Äî Eggnet lost focus.");
          }
        });
      }

      bindEvents();
      initAuth();
      renderBlueprint();
      updateStats();
    </script>
  </body>
</html>
