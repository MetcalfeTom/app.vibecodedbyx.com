<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Badnik Border Patrol — Eggnet Security Desk</title>
    <meta
      name="description"
      content="Staff the Eggnet Security Desk and screen Sonic universe badniks for counterfeit parts before they enter Eggman's armada."
    />
    <meta property="og:title" content="Badnik Border Patrol — Eggnet Security Desk" />
    <meta
      property="og:description"
      content="Inspect rogue badnik blueprints, flag sabotage, and keep Eggman's airship secure before Sonic busts in."
    />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://app.vibecodedbyx.com/meteor-mash/" />
    <meta property="og:image" content="./og-image.svg" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Badnik Border Patrol — Eggnet Security" />
    <meta
      name="twitter:description"
      content="Accept or scrap Sonic badniks before launch. Can you keep Eggman's forces legit?"
    />
    <meta name="twitter:image" content="./og-image.svg" />
    <link rel="icon" href="./favicon.svg" type="image/svg+xml" />
    <meta name="theme-color" content="#0c1239" />
    <style>
      :root {
        color-scheme: dark;
        font-family: "Chakra Petch", "Inter", "Segoe UI", sans-serif;
        --bg-sky: radial-gradient(circle at 20% -10%, rgba(61, 140, 255, 0.3), transparent 60%),
          radial-gradient(circle at 82% 120%, rgba(255, 83, 146, 0.32), transparent 65%),
          #04081f;
        --panel: rgba(10, 15, 47, 0.9);
        --panel-alt: rgba(16, 22, 58, 0.82);
        --accent: #ffd248;
        --accent-soft: rgba(255, 210, 72, 0.18);
        --accent-bright: #ff5ca3;
        --text-main: #f5f6ff;
        --text-muted: rgba(245, 246, 255, 0.72);
        --border: rgba(255, 255, 255, 0.12);
        --hitbox: rgba(255, 87, 136, 0.65);
      }

      *, *::before, *::after {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: var(--bg-sky);
        color: var(--text-main);
        display: flex;
        justify-content: center;
        align-items: stretch;
        padding: clamp(18px, 4vw, 48px);
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160' viewBox='0 0 160 160'%3E%3Cg fill='rgba(30, 73, 255, 0.18)'%3E%3Cpath d='M80 12l10 28h30l-24 18 9 28-25-16-25 16 9-28-24-18h30z'/%3E%3C/g%3E%3C/svg%3E");
        opacity: 0.35;
        mix-blend-mode: screen;
        pointer-events: none;
      }

      .app-shell {
        width: min(1140px, 100%);
        display: grid;
        gap: clamp(18px, 3vw, 28px);
        position: relative;
      }

      header {
        display: grid;
        gap: 12px;
        text-align: center;
      }

      header h1 {
        margin: 0;
        font-size: clamp(2.3rem, 6vw, 3.4rem);
        letter-spacing: 0.08em;
        text-transform: uppercase;
        text-shadow: 0 0 28px rgba(64, 160, 255, 0.6);
      }

      header p {
        margin: 0 auto;
        max-width: 720px;
        color: var(--text-muted);
        line-height: 1.6;
      }

      .backlink {
        justify-self: center;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: rgba(255, 255, 255, 0.08);
        color: var(--text-main);
        text-decoration: none;
        font-size: 0.95rem;
        transition: transform 0.2s ease, background 0.2s ease;
      }

      .backlink:hover,
      .backlink:focus-visible {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-1px);
        outline: none;
      }

      main {
        display: grid;
        gap: clamp(18px, 3vw, 28px);
      }

      .hud {
        display: grid;
        gap: 14px;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }

      .stat {
        background: linear-gradient(140deg, rgba(26, 44, 120, 0.92), rgba(11, 20, 80, 0.92));
        border: 1px solid rgba(96, 162, 255, 0.32);
        border-radius: 20px;
        padding: 16px 18px;
        position: relative;
        overflow: hidden;
        display: grid;
        gap: 4px;
        box-shadow: 0 20px 35px rgba(4, 12, 32, 0.55);
      }

      .stat::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(120deg, rgba(64, 160, 255, 0.24), transparent);
        opacity: 0.6;
        mix-blend-mode: screen;
        pointer-events: none;
      }

      .stat .label {
        text-transform: uppercase;
        letter-spacing: 0.18em;
        font-size: 0.68rem;
        color: var(--text-muted);
      }

      .stat .value {
        font-size: 1.7rem;
        font-weight: 600;
      }

      .stat .value.small {
        font-size: 1.1rem;
      }

      .timer-track {
        height: 12px;
        border-radius: 999px;
        border: 1px solid rgba(90, 145, 255, 0.28);
        background: rgba(15, 24, 60, 0.92);
        overflow: hidden;
        position: relative;
        box-shadow: inset 0 0 18px rgba(4, 8, 26, 0.6);
      }

      .timer-fill {
        position: absolute;
        inset: 0;
        background: linear-gradient(90deg, #ffd248, #ff5ca3);
        transform-origin: left;
        transform: scaleX(1);
      }

      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
      }

      .btn {
        appearance: none;
        border: none;
        border-radius: 12px;
        padding: 12px 18px;
        font-size: 1rem;
        font-weight: 600;
        font-family: inherit;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.2s ease;
        color: #0a113a;
        background: linear-gradient(130deg, var(--accent), #ffb14d);
        box-shadow: 0 12px 24px rgba(255, 210, 72, 0.35);
      }

      .btn.secondary {
        background: rgba(255, 255, 255, 0.08);
        color: var(--text-main);
        box-shadow: none;
        border: 1px solid rgba(255, 255, 255, 0.18);
      }

      .btn.danger {
        background: linear-gradient(130deg, #ff5ca3, #ff3d6d);
        color: #210312;
        box-shadow: 0 12px 24px rgba(255, 80, 149, 0.35);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn:not(:disabled):hover {
        transform: translateY(-1px);
      }

      .status-line {
        margin: 0;
        font-size: 0.95rem;
        color: var(--text-muted);
      }

      .checkpoint {
        display: grid;
        gap: clamp(18px, 3vw, 28px);
        grid-template-columns: 2fr 1fr;
      }

      .blueprint-card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 26px;
        padding: clamp(18px, 3vw, 28px);
        display: grid;
        gap: 18px;
        position: relative;
        box-shadow: 0 20px 38px rgba(5, 12, 32, 0.55);
      }

      .blueprint-card::before {
        content: "";
        position: absolute;
        inset: -1px;
        border-radius: inherit;
        padding: 2px;
        background: linear-gradient(130deg, rgba(255, 210, 72, 0.45), rgba(96, 162, 255, 0.35));
        -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
      }

      .case-banner {
        font-size: 0.9rem;
        letter-spacing: 0.22em;
        text-transform: uppercase;
        color: var(--accent);
      }

      .blueprint-header {
        display: grid;
        gap: 16px;
        grid-template-columns: 220px 1fr;
      }

      .holo-portrait {
        position: relative;
        aspect-ratio: 3 / 4;
        border-radius: 20px;
        overflow: hidden;
        background: linear-gradient(160deg, rgba(96, 162, 255, 0.32), rgba(11, 20, 80, 0.9));
        border: 2px solid rgba(77, 174, 255, 0.45);
        display: grid;
        place-items: center;
      }

      .holo-portrait svg,
      .holo-portrait img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .holo-portrait::after {
        content: "BADNIK ID";
        position: absolute;
        bottom: 8px;
        right: 10px;
        font-size: 0.55rem;
        letter-spacing: 0.26em;
        padding: 4px 9px;
        border-radius: 999px;
        background: rgba(9, 15, 38, 0.7);
      }

      .blueprint-meta {
        display: grid;
        gap: 12px;
      }

      .blueprint-meta h2 {
        margin: 0;
        font-size: clamp(1.8rem, 3vw, 2.2rem);
        letter-spacing: 0.06em;
      }

      .blueprint-meta p {
        margin: 0;
        color: var(--text-muted);
        font-size: 0.95rem;
      }

      dl.readout {
        margin: 0;
        display: grid;
        gap: 12px 18px;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }

      dl.readout dt {
        font-size: 0.72rem;
        text-transform: uppercase;
        letter-spacing: 0.2em;
        color: var(--text-muted);
      }

      dl.readout dd {
        margin: 2px 0 0;
        font-family: "IBM Plex Mono", "SFMono-Regular", monospace;
        background: rgba(12, 20, 60, 0.8);
        border-radius: 12px;
        padding: 8px 10px;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      .intel-panel {
        background: var(--panel-alt);
        border: 1px solid rgba(96, 162, 255, 0.28);
        border-radius: 24px;
        padding: clamp(18px, 3vw, 28px);
        display: grid;
        gap: 18px;
        box-shadow: 0 20px 32px rgba(5, 12, 32, 0.45);
      }

      .intel-panel h2 {
        margin: 0;
        font-size: 1.3rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
      }

      .rules-list {
        margin: 0;
        padding-left: 20px;
        display: grid;
        gap: 10px;
      }

      .rules-list li {
        line-height: 1.5;
      }

      .intel-output {
        background: rgba(0, 18, 64, 0.78);
        border: 1px solid rgba(96, 162, 255, 0.28);
        border-radius: 14px;
        min-height: 76px;
        padding: 12px 14px;
        display: grid;
        gap: 8px;
        font-family: "IBM Plex Mono", "SFMono-Regular", monospace;
      }

      .intel-output div {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .intel-output div::before {
        content: "⚠";
      }

      .log-grid {
        display: grid;
        gap: clamp(18px, 3vw, 28px);
        grid-template-columns: 1.4fr 1fr;
      }

      .log-card,
      .docs-card {
        background: rgba(10, 16, 48, 0.85);
        border: 1px solid rgba(96, 162, 255, 0.25);
        border-radius: 22px;
        padding: clamp(18px, 3vw, 26px);
        display: grid;
        gap: 14px;
      }

      .log-card h3,
      .docs-card h3 {
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 0.18em;
        font-size: 1rem;
      }

      .log-stream {
        font-family: "IBM Plex Mono", "SFMono-Regular", monospace;
        display: grid;
        gap: 8px;
        max-height: 240px;
        overflow-y: auto;
      }

      .manifest {
        margin: 0;
        display: grid;
        gap: 12px;
      }

      .manifest div {
        display: grid;
        gap: 4px;
      }

      .story-chip {
        background: rgba(255, 210, 72, 0.12);
        border: 1px solid rgba(255, 210, 72, 0.24);
        border-radius: 14px;
        padding: 12px 14px;
        color: var(--accent);
        font-size: 0.9rem;
      }

      .premium-card,
      .upgrade-card {
        background: rgba(11, 14, 44, 0.92);
        border: 1px solid rgba(255, 210, 72, 0.28);
        border-radius: 24px;
        padding: clamp(18px, 3vw, 26px);
        display: grid;
        gap: 14px;
        box-shadow: 0 16px 28px rgba(8, 12, 32, 0.45);
      }

      .premium-card form {
        display: grid;
        gap: 14px;
      }

      .picker-row {
        display: grid;
        gap: 14px;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }

      label span {
        font-size: 0.75rem;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        color: var(--text-muted);
        display: block;
        margin-bottom: 6px;
      }

      input[type="color"] {
        width: 100%;
        height: 48px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: transparent;
        cursor: pointer;
      }

      .toggle {
        display: inline-flex;
        gap: 10px;
        align-items: center;
        font-size: 0.95rem;
        color: var(--text-muted);
      }

      .toggle input {
        width: 18px;
        height: 18px;
      }

      footer {
        text-align: center;
        color: var(--text-muted);
        font-size: 0.92rem;
      }

      .hidden {
        display: none !important;
      }

      @media (max-width: 1024px) {
        .checkpoint,
        .log-grid {
          grid-template-columns: 1fr;
        }

        .blueprint-header {
          grid-template-columns: 1fr;
        }

        .holo-portrait {
          max-width: 240px;
          justify-self: center;
          width: 100%;
        }
      }

      @media (max-width: 640px) {
        body {
          padding: 16px;
        }

        .controls {
          flex-direction: column;
          align-items: stretch;
        }

        .btn,
        .btn.secondary,
        .btn.danger {
          width: 100%;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <header>
        <h1>Badnik Border Patrol</h1>
        <p>
          The Eggnet Security Desk is online. Vet incoming badnik blueprints, reject counterfeit parts, and keep
          Doctor Eggman's flagship free of Sonic sabotage before launch.
        </p>
        <a class="backlink" href="https://www.vibecodedbyx.com" target="_blank" rel="noreferrer noopener"
          >⬅ Back to the livestream</a
        >
      </header>

      <main>
        <section class="hud" aria-label="Shift statistics">
          <div class="stat">
            <span class="label">Ring Score</span>
            <span class="value" id="score-value">0</span>
          </div>
          <div class="stat">
            <span class="label">Blueprints Cleared</span>
            <span class="value" id="cases-value">0 / 10</span>
          </div>
          <div class="stat">
            <span class="label">Accuracy</span>
            <span class="value small" id="accuracy-value">—</span>
          </div>
          <div class="stat">
            <span class="label">Warnings left</span>
            <span class="value small" id="warnings-value">3</span>
          </div>
          <div class="stat">
            <span class="label">Shift timer</span>
            <span class="value small" id="timer-value">75.0s</span>
          </div>
        </section>

        <div class="timer-track" aria-hidden="true">
          <div class="timer-fill" id="timer-fill"></div>
        </div>

        <div class="controls">
          <button class="btn" id="start-btn" type="button">Start security sweep</button>
          <button class="btn secondary" id="reset-btn" type="button" disabled>Reset station</button>
          <button class="btn secondary" id="skip-btn" type="button" disabled>Skip blueprint</button>
        </div>
        <p class="status-line" id="status-message">Station idle. Spin up the scanners when you're ready.</p>

        <section class="checkpoint">
          <div class="blueprint-card">
            <div class="case-banner" id="case-banner">Awaiting transmission…</div>
            <div class="blueprint-header">
              <div class="holo-portrait" id="holo-portrait" aria-hidden="true">❓</div>
              <div class="blueprint-meta">
                <h2 id="badnik-name">No blueprint loaded</h2>
                <p id="badnik-tagline">Connect to Eggnet to receive the next file.</p>
                <dl class="readout">
                  <div>
                    <dt>Model ID</dt>
                    <dd id="model-id">---- ----</dd>
                  </div>
                  <div>
                    <dt>Power Core</dt>
                    <dd id="power-core">—</dd>
                  </div>
                  <div>
                    <dt>Chaos Output</dt>
                    <dd id="chaos-output">—</dd>
                  </div>
                  <div>
                    <dt>Mission Zone</dt>
                    <dd id="mission-zone">—</dd>
                  </div>
                  <div>
                    <dt>Loadout</dt>
                    <dd id="loadout">—</dd>
                  </div>
                  <div>
                    <dt>Origin</dt>
                    <dd id="factory-origin">—</dd>
                  </div>
                </dl>
              </div>
            </div>
            <div class="story-chip" id="intel-chip">Transmission briefing will appear here once a sweep begins.</div>
            <div class="decision-buttons">
              <button class="btn" id="accept-btn" type="button" disabled>Approve badnik</button>
              <button class="btn danger" id="deny-btn" type="button" disabled>Scrap blueprint</button>
            </div>
          </div>

          <aside class="intel-panel">
            <h2>Eggnet Rule Stack</h2>
            <ol class="rules-list" id="rules-list">
              <li>Power cores must register at least <strong>120 ring units</strong>.</li>
              <li>Only <strong>Eggman Industries</strong> factories are certified.</li>
              <li>Chaos output spikes over <strong>150%</strong> are sabotage flags.</li>
              <li>Banned missions: <strong>Marble Garden</strong> &amp; <strong>Stardust Speedway</strong>.</li>
              <li>Loadouts must match the assigned mission profile.</li>
            </ol>
            <div>
              <h3>Desk Intel</h3>
              <div class="intel-output" id="intel-output">Enable Intel Mode (premium) to auto-highlight sabotage patterns.</div>
            </div>
            <div class="shift-notes">
              <h3>Shift briefing</h3>
              <p class="status-line">
                Clear 10 blueprints before Sonic breaches the hull. Three mistakes and the doctor locks you out of the Eggnet.
              </p>
            </div>
          </aside>
        </section>

        <section class="log-grid">
          <div class="log-card">
            <h3>Security Log</h3>
            <div class="log-stream" id="log-stream">
              <span>No transmissions recorded yet.</span>
            </div>
          </div>
          <div class="docs-card">
            <h3>Blueprint Notes</h3>
            <dl class="manifest">
              <div>
                <dt>Spark core notes</dt>
                <dd id="core-notes">—</dd>
              </div>
              <div>
                <dt>Quirk registry</dt>
                <dd id="quirk-registry">—</dd>
              </div>
              <div>
                <dt>Field chatter</dt>
                <dd id="field-chatter">—</dd>
              </div>
            </dl>
          </div>
        </section>

        <section class="premium-card hidden" id="premium-content">
          <h2>Premium Arsenal</h2>
          <p class="status-line">
            Subscribers unlock custom Eggnet theming and Intel Mode overlays that call out likely sabotage in the feed.
          </p>
          <form id="premium-form">
            <div class="picker-row">
              <label>
                <span>Desk aura</span>
                <input type="color" id="desk-color" name="desk" value="#102050" />
              </label>
              <label>
                <span>Accent neon</span>
                <input type="color" id="accent-color" name="accent" value="#ffd248" />
              </label>
            </div>
            <label class="toggle">
              <input type="checkbox" id="intel-toggle" />
              Engage Intel Mode (auto-sabotage hints)
            </label>
            <button class="btn" type="submit">Apply custom theme</button>
          </form>
        </section>

        <section class="upgrade-card" id="upgrade-button">
          <h2>Upgrade for Intel Mode</h2>
          <p class="status-line">
            Premium desk chiefs can recolor the command deck and get auto-scan overlays. Tap upgrade in the profile menu to
            enlist.
          </p>
        </section>
      </main>

      <footer>Built live on stream — share your best sabotage catch rate and tag @VibeCodedByX ⚙️🦔</footer>
    </div>

    <script type="module">
      import { supabaseSession, isUserPremium } from "../../supabase-config.js";

      const SHIFT_DURATION = 75_000;
      const CASES_PER_SHIFT = 10;
      const MAX_WARNINGS = 3;
      const RULES = [
        {
          id: "power",
          label: "Power core minimum",
          test: (bp) => bp.powerCore >= 120,
          message: (bp) => `Power core only ${bp.powerCore} ring units (< 120).`,
        },
        {
          id: "factory",
          label: "Certified factory",
          test: (bp) => bp.origin === "Eggman Industries",
          message: (bp) => `${bp.origin} is not Eggman-certified.`,
        },
        {
          id: "chaos",
          label: "Chaos stability",
          test: (bp) => bp.chaosOutput <= 150,
          message: (bp) => `Chaos output ${bp.chaosOutput}% exceeds safe 150%.`,
        },
        {
          id: "mission",
          label: "Mission blacklist",
          test: (bp) => !["Marble Garden", "Stardust Speedway"].includes(bp.missionZone),
          message: (bp) => `${bp.missionZone} deployments are frozen after last sabotage.`,
        },
        {
          id: "loadout",
          label: "Loadout mismatch",
          test: (bp) => REQUIRED_LOADOUTS[bp.missionZone]?.includes(bp.loadout) ?? true,
          message: (bp) => `Loadout "${bp.loadout}" is off-profile for ${bp.missionZone}.`,
        },
      ];

      const BADNIK_TYPES = [
        {
          id: "motobug",
          name: "Motobug v6",
          tagline: "Speedy patrol drone with exhaust thrusters.",
          icon: "🏍️",
          palette: {
            light: "#ff417d",
            dark: "#3a0b2f",
            accent: "#ffd248",
          },
        },
        {
          id: "buzz-bomber",
          name: "Buzz Bomber Neo",
          tagline: "Hover assault unit armed with stinger missiles.",
          icon: "🐝",
          palette: {
            light: "#ffae00",
            dark: "#251200",
            accent: "#4dd5ff",
          },
        },
        {
          id: "egg-pawn",
          name: "Egg Pawn Prime",
          tagline: "Multipurpose grunt with adaptive AI chips.",
          icon: "🤖",
          palette: {
            light: "#6e8bff",
            dark: "#0e1f5e",
            accent: "#ff5ca3",
          },
        },
        {
          id: "orbinaut",
          name: "Orbinaut Flux",
          tagline: "Defensive drone orbiting plasma mines.",
          icon: "🪐",
          palette: {
            light: "#9cfffb",
            dark: "#082b33",
            accent: "#ffd248",
          },
        },
        {
          id: "clucker",
          name: "Aquis Clucker",
          tagline: "Seafloor sentry perched in coral turrets.",
          icon: "🐔",
          palette: {
            light: "#ff8aa6",
            dark: "#2b0a17",
            accent: "#45ffe1",
          },
        },
      ];

      const MISSION_ZONES = [
        "Chemical Plant",
        "Angel Island",
        "Oil Ocean",
        "Hydrocity",
        "Marble Garden",
        "Stardust Speedway",
        "Press Garden",
        "Aquatic Ruin",
      ];

      const LOADOUTS = [
        "Drill claw",
        "Ring siphon",
        "Plasma stinger",
        "Spike mine array",
        "Steam cannon",
        "Buzz saw jets",
        "Chaos net",
        "Sand skimmer",
      ];

      const REQUIRED_LOADOUTS = {
        "Chemical Plant": ["Ring siphon", "Chaos net"],
        "Angel Island": ["Spike mine array", "Buzz saw jets"],
        "Oil Ocean": ["Steam cannon", "Sand skimmer"],
        "Hydrocity": ["Chaos net", "Spike mine array"],
        "Press Garden": ["Buzz saw jets", "Drill claw"],
        "Aquatic Ruin": ["Sand skimmer", "Chaos net"],
      };

      const CORE_NOTES = [
        "Heat sinks replaced after Flying Battery crash.",
        "Power couplers tuned for loop acceleration.",
        "Chaos capacitor shows faint crackle when idle.",
        "Oil Ocean residue scrubbed off primary joint.",
        "Rotor fins swapped for lighter alloy.",
      ];

      const QUIRK_REGISTRY = [
        "Occasionally chants \"Eggman\" when idling.",
        "Won't stop quoting Rouge's mission brief.",
        "Collects rings despite corporate policy.",
        "Paint job attracts Chao swarms.",
        "Keeps requesting vinyl soundtrack uploads.",
      ];

      const CHATTER = [
        "Team Shadow flagged counterfeit parts in this sector.",
        "Sonic sighted three zones away — accelerate review.",
        "Dr. Eggman wants stealthier jet trails by sundown.",
        "Rouge says G.U.N. intercepted a fake Egg Carrier badge.",
        "Metal Sonic uploaded a new firmware handshake test.",
      ];

      const sabotages = [
        (bp) => (bp.powerCore = Math.max(80, bp.powerCore - Math.floor(Math.random() * 70 + 20))),
        (bp) => (bp.origin = "Mystery Foundry"),
        (bp) => (bp.chaosOutput = Math.floor(160 + Math.random() * 40)),
        (bp) => (bp.missionZone = "Marble Garden"),
        (bp) => {
          const pool = LOADOUTS.filter((item) => !(REQUIRED_LOADOUTS[bp.missionZone] || []).includes(item));
          if (pool.length) bp.loadout = pool[Math.floor(Math.random() * pool.length)];
        },
      ];

      const elements = {
        startBtn: document.getElementById("start-btn"),
        resetBtn: document.getElementById("reset-btn"),
        skipBtn: document.getElementById("skip-btn"),
        acceptBtn: document.getElementById("accept-btn"),
        denyBtn: document.getElementById("deny-btn"),
        score: document.getElementById("score-value"),
        cases: document.getElementById("cases-value"),
        accuracy: document.getElementById("accuracy-value"),
        warnings: document.getElementById("warnings-value"),
        timer: document.getElementById("timer-value"),
        timerFill: document.getElementById("timer-fill"),
        status: document.getElementById("status-message"),
        banner: document.getElementById("case-banner"),
        portrait: document.getElementById("holo-portrait"),
        name: document.getElementById("badnik-name"),
        tagline: document.getElementById("badnik-tagline"),
        modelId: document.getElementById("model-id"),
        powerCore: document.getElementById("power-core"),
        chaosOutput: document.getElementById("chaos-output"),
        missionZone: document.getElementById("mission-zone"),
        loadout: document.getElementById("loadout"),
        origin: document.getElementById("factory-origin"),
        intelChip: document.getElementById("intel-chip"),
        log: document.getElementById("log-stream"),
        coreNotes: document.getElementById("core-notes"),
        quirkRegistry: document.getElementById("quirk-registry"),
        fieldChatter: document.getElementById("field-chatter"),
        intelOutput: document.getElementById("intel-output"),
        premiumPanel: document.getElementById("premium-content"),
        upgradeCard: document.getElementById("upgrade-button"),
        premiumForm: document.getElementById("premium-form"),
        deskColor: document.getElementById("desk-color"),
        accentColor: document.getElementById("accent-color"),
        intelToggle: document.getElementById("intel-toggle"),
      };

      const state = {
        queue: [],
        index: 0,
        score: 0,
        correct: 0,
        reviewed: 0,
        warnings: 0,
        playing: false,
        timeLeft: SHIFT_DURATION,
        shiftEndsAt: 0,
        raf: null,
        premium: false,
        intelMode: false,
        highScore: 0,
      };

      function nowStamp() {
        return new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
      }

      function resetPortrait() {
        elements.portrait.innerHTML = "❓";
        elements.portrait.style.background = "linear-gradient(160deg, rgba(96,162,255,0.32), rgba(11,20,80,0.9))";
      }

      function logEvent(text) {
        const entry = document.createElement("span");
        entry.textContent = `[${nowStamp()}] ${text}`;
        elements.log.prepend(entry);
        if (elements.log.children.length > 25) {
          elements.log.removeChild(elements.log.lastElementChild);
        }
        if (elements.log.children.length > 1 && elements.log.lastElementChild.textContent.includes("No transmissions")) {
          elements.log.removeChild(elements.log.lastElementChild);
        }
      }

      function randomItem(list) {
        return list[Math.floor(Math.random() * list.length)];
      }

      function pad(num, size = 3) {
        return num.toString().padStart(size, "0");
      }

      function composeModelId(type) {
        return `${type.id.toUpperCase()}-${pad(Math.floor(Math.random() * 999))}-${pad(Math.floor(Math.random() * 999))}`;
      }

      function buildBlueprint(index) {
        const type = randomItem(BADNIK_TYPES);
        const missionZone = randomItem(MISSION_ZONES);
        const baseLoadouts = REQUIRED_LOADOUTS[missionZone] || LOADOUTS;
        const loadout = randomItem(baseLoadouts);
        const blueprint = {
          type,
          modelId: composeModelId(type),
          missionZone,
          loadout,
          powerCore: Math.floor(120 + Math.random() * 80),
          chaosOutput: Math.floor(90 + Math.random() * 50),
          origin: "Eggman Industries",
          intel: randomItem(CHATTER),
          quirk: randomItem(QUIRK_REGISTRY),
          coreNote: randomItem(CORE_NOTES),
        };

        const sabotageChance = Math.random();
        if (sabotageChance < 0.55) {
          randomItem(sabotages)(blueprint);
        }

        const failures = RULES.filter((rule) => !rule.test(blueprint));
        return {
          id: `case-${Date.now()}-${index}`,
          blueprint,
          failures,
        };
      }

      function buildQueue() {
        return Array.from({ length: CASES_PER_SHIFT }, (_, idx) => buildBlueprint(idx));
      }

      function updateHUD() {
        elements.score.textContent = state.score.toString();
        const total = state.queue.length || CASES_PER_SHIFT;
        elements.cases.textContent = `${state.reviewed} / ${total}`;
        elements.warnings.textContent = Math.max(0, MAX_WARNINGS - state.warnings).toString();
        const accuracy = state.reviewed > 0 ? Math.round((state.correct / state.reviewed) * 100) : null;
        elements.accuracy.textContent = accuracy === null ? "—" : `${accuracy}%`;
        elements.timer.textContent = `${(state.timeLeft / 1000).toFixed(1)}s`;
        if (elements.timerFill) {
          const ratio = Math.max(0, Math.min(1, state.timeLeft / SHIFT_DURATION));
          elements.timerFill.style.transform = `scaleX(${ratio})`;
          elements.timerFill.style.opacity = ratio === 0 ? "0.25" : "1";
        }
      }

      function drawPortrait(blueprint) {
        const { type } = blueprint;
        const svg = `
          <svg viewBox="0 0 260 320" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="bg-${type.id}" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="${type.palette.dark}" />
                <stop offset="1" stop-color="${type.palette.light}" />
              </linearGradient>
              <filter id="glow-${type.id}" x="-30%" y="-30%" width="160%" height="160%">
                <feGaussianBlur stdDeviation="6" result="glow" />
                <feMerge>
                  <feMergeNode in="glow" />
                  <feMergeNode in="SourceGraphic" />
                </feMerge>
              </filter>
            </defs>
            <rect width="260" height="320" fill="url(#bg-${type.id})" />
            <g filter="url(#glow-${type.id})" transform="translate(30 30)">
              <rect x="-10" y="-10" width="220" height="280" rx="32" fill="rgba(5, 12, 32, 0.45)" stroke="${type.palette.accent}" stroke-width="3" />
              <text x="20" y="36" font-size="42" fill="${type.palette.accent}">${type.icon}</text>
              <text x="20" y="86" font-size="20" fill="white" font-family="'Chakra Petch', sans-serif">${type.name}</text>
              <text x="20" y="112" font-size="12" fill="rgba(255,255,255,0.7)" font-family="'Chakra Petch', sans-serif">${blueprint.missionZone}</text>
              <rect x="12" y="140" width="176" height="96" rx="18" fill="rgba(255,255,255,0.06)" stroke="${type.palette.accent}" stroke-width="2" />
              <text x="24" y="172" font-size="12" fill="rgba(255,255,255,0.72)" font-family="'IBM Plex Mono', monospace">Power ${blueprint.powerCore}u</text>
              <text x="24" y="192" font-size="12" fill="rgba(255,255,255,0.72)" font-family="'IBM Plex Mono', monospace">Chaos ${blueprint.chaosOutput}%</text>
              <text x="24" y="212" font-size="12" fill="rgba(255,255,255,0.72)" font-family="'IBM Plex Mono', monospace">Loadout ${blueprint.loadout}</text>
              <text x="24" y="256" font-size="14" fill="rgba(255,255,255,0.86)" font-family="'Chakra Petch', sans-serif">${type.tagline}</text>
            </g>
          </svg>
        `;
        elements.portrait.innerHTML = svg;
      }

      function renderCase() {
        const current = state.queue[state.index];
        if (!current) {
          elements.banner.textContent = "Awaiting transmission…";
          elements.name.textContent = "No blueprint loaded";
          elements.tagline.textContent = "Connect to Eggnet to receive the next file.";
          elements.modelId.textContent = "---- ----";
          elements.powerCore.textContent = "—";
          elements.chaosOutput.textContent = "—";
          elements.missionZone.textContent = "—";
          elements.loadout.textContent = "—";
          elements.origin.textContent = "—";
          elements.intelChip.textContent = "Transmission briefing will appear here once a sweep begins.";
          elements.coreNotes.textContent = "—";
          elements.quirkRegistry.textContent = "—";
          elements.fieldChatter.textContent = "—";
          resetPortrait();
          elements.acceptBtn.disabled = true;
          elements.denyBtn.disabled = true;
          elements.skipBtn.disabled = true;
          updateIntel();
          return;
        }

        const { blueprint, failures } = current;
        elements.banner.textContent = `Transmission ${state.index + 1}/${state.queue.length}`;
        elements.name.textContent = blueprint.type.name;
        elements.tagline.textContent = blueprint.type.tagline;
        elements.modelId.textContent = blueprint.modelId;
        elements.powerCore.textContent = `${blueprint.powerCore} ring units`;
        elements.chaosOutput.textContent = `${blueprint.chaosOutput}% flux`;
        elements.missionZone.textContent = blueprint.missionZone;
        elements.loadout.textContent = blueprint.loadout;
        elements.origin.textContent = blueprint.origin;
        elements.intelChip.textContent = `${blueprint.intel}`;
        elements.coreNotes.textContent = blueprint.coreNote;
        elements.quirkRegistry.textContent = blueprint.quirk;
        elements.fieldChatter.textContent = CHATTER[Math.floor(Math.random() * CHATTER.length)];
        drawPortrait(blueprint);

        const controlsDisabled = !state.playing;
        elements.acceptBtn.disabled = controlsDisabled;
        elements.denyBtn.disabled = controlsDisabled;
        elements.skipBtn.disabled = controlsDisabled;
        updateIntel(failures);
      }

      function updateIntel(failures = []) {
        if (!state.premium || !state.intelMode) {
          elements.intelOutput.textContent = state.premium
            ? "Intel Mode disabled. Flip the toggle to auto-list sabotage." : "Enable Intel Mode (premium) to auto-highlight sabotage patterns.";
          return;
        }
        if (!state.queue[state.index]) {
          elements.intelOutput.textContent = "Intel Mode ready. Start the sweep to receive sabotage hints.";
          return;
        }
        if (!failures.length) {
          elements.intelOutput.textContent = "No sabotage detected. Blueprint passes current rule stack.";
          return;
        }
        elements.intelOutput.innerHTML = failures
          .map((failure) => `<div>${failure.message(state.queue[state.index].blueprint)}</div>`)
          .join("");
      }

      function shiftLoop(timestamp) {
        if (!state.playing) return;
        if (!state.shiftEndsAt) {
          state.shiftEndsAt = timestamp + SHIFT_DURATION;
        }
        state.timeLeft = Math.max(0, state.shiftEndsAt - timestamp);
        updateHUD();
        if (state.timeLeft <= 0) {
          endShift("time");
          return;
        }
        state.raf = requestAnimationFrame(shiftLoop);
      }

      function scoreDecision(correct, failures) {
        if (correct) {
          const bonus = Math.max(1, failures.length);
          state.score += 150 + bonus * 30;
          state.correct += 1;
        } else {
          state.score = Math.max(0, state.score - 120);
          state.warnings += 1;
        }
      }

      function advanceCase() {
        state.index += 1;
        if (state.index >= state.queue.length) {
          endShift("queue");
        } else {
          renderCase();
          updateHUD();
        }
      }

      function handleDecision(decision) {
        if (!state.playing) return;
        const current = state.queue[state.index];
        if (!current) return;

        const shouldApprove = current.failures.length === 0;
        const correct = (decision === "approve" && shouldApprove) || (decision === "deny" && !shouldApprove);
        scoreDecision(correct, current.failures);
        state.reviewed += 1;
        updateHUD();

        if (correct) {
          elements.status.textContent = "Solid call. Eggnet routing the next file.";
          logEvent(`✔ Blueprint ${state.index + 1} cleared. Score +${150 + Math.max(1, current.failures.length) * 30}.`);
        } else {
          const firstIssue = current.failures[0]?.message(current.blueprint) ?? "Incorrect decision.";
          elements.status.textContent = `Warning logged: ${firstIssue}`;
          logEvent(`✖ Blueprint ${state.index + 1} flagged. Reason: ${firstIssue}`);
        }

        if (state.warnings >= MAX_WARNINGS) {
          endShift("warnings");
          return;
        }

        advanceCase();
      }

      function skipBlueprint() {
        if (!state.playing) return;
        const current = state.queue[state.index];
        if (!current) return;
        logEvent(`↷ Blueprint ${state.index + 1} skipped. Ring penalty applied.`);
        state.score = Math.max(0, state.score - 60);
        state.reviewed += 1;
        elements.status.textContent = "Blueprint skipped. Eggman will want answers.";
        advanceCase();
      }

      function startShift() {
        Object.assign(state, {
          queue: buildQueue(),
          index: 0,
          score: 0,
          correct: 0,
          reviewed: 0,
          warnings: 0,
          playing: true,
          timeLeft: SHIFT_DURATION,
          shiftEndsAt: 0,
        });
        elements.startBtn.disabled = true;
        elements.resetBtn.disabled = false;
        elements.skipBtn.disabled = false;
        elements.status.textContent = "Security sweep live. Scrutinize every spec.";
        elements.log.innerHTML = "";
        logEvent("Security sweep initiated. Dr. Eggman is monitoring your performance.");
        renderCase();
        updateHUD();
        cancelAnimationFrame(state.raf);
        state.raf = requestAnimationFrame(shiftLoop);
      }

      function endShift(reason) {
        state.playing = false;
        cancelAnimationFrame(state.raf);
        elements.startBtn.disabled = false;
        elements.acceptBtn.disabled = true;
        elements.denyBtn.disabled = true;
        elements.skipBtn.disabled = true;
        elements.resetBtn.disabled = false;

        let statusMessage = "Sweep complete.";
        if (reason === "time") statusMessage = "Timer expired. Sonic breached the perimeter!";
        if (reason === "warnings") statusMessage = "Three warnings triggered. Eggnet revoked access.";
        if (reason === "queue") statusMessage = "Entire queue cleared. Eggman applauds begrudgingly.";

        elements.status.textContent = `${statusMessage} Final score ${state.score}.`;
        logEvent(`Sweep ended (${reason}). Final score ${state.score}. Accuracy ${elements.accuracy.textContent}.`);

        if (state.score > state.highScore) {
          state.highScore = state.score;
          logEvent(`🏆 New personal best recorded: ${state.score} ring points.`);
        }

        renderCase();
        updateHUD();
      }

      function hardReset() {
        cancelAnimationFrame(state.raf);
        elements.startBtn.disabled = false;
        elements.resetBtn.disabled = true;
        elements.skipBtn.disabled = true;
        elements.acceptBtn.disabled = true;
        elements.denyBtn.disabled = true;
        state.playing = false;
        state.queue = [];
        state.index = 0;
        state.score = 0;
        state.correct = 0;
        state.reviewed = 0;
        state.warnings = 0;
        state.timeLeft = SHIFT_DURATION;
        state.shiftEndsAt = 0;
        state.raf = null;
        elements.status.textContent = "Station idle. Spin up the scanners when you're ready.";
        elements.log.innerHTML = "<span>No transmissions recorded yet.</span>";
        resetPortrait();
        renderCase();
        updateHUD();
      }

      function applyPremiumTheme(event) {
        event.preventDefault();
        if (!state.premium) {
          elements.status.textContent = "Premium required for desk theming.";
          return;
        }
        const desk = elements.deskColor.value;
        const accent = elements.accentColor.value;
        document.documentElement.style.setProperty("--panel", desk + "d0");
        document.documentElement.style.setProperty("--accent", accent);
        document.documentElement.style.setProperty("--accent-soft", `${hexToRgba(accent, 0.18)}`);
        elements.status.textContent = "Custom desk applied.";
        logEvent(`Desk aura shifted to ${desk}, accent ${accent}.`);
        updateIntel(state.queue[state.index]?.failures ?? []);
      }

      function hexToRgba(hex, alpha = 0.22) {
        let normalized = hex.replace("#", "");
        if (normalized.length === 3) {
          normalized = normalized
            .split("")
            .map((char) => char + char)
            .join("");
        }
        const num = parseInt(normalized, 16);
        const r = (num >> 16) & 255;
        const g = (num >> 8) & 255;
        const b = num & 255;
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      }

      function toggleIntelMode(event) {
        if (!state.premium) {
          event.target.checked = false;
          elements.status.textContent = "Premium required for Intel Mode.";
          return;
        }
        state.intelMode = event.target.checked;
        logEvent(state.intelMode ? "Intel Mode engaged." : "Intel Mode disengaged.");
        updateIntel(state.queue[state.index]?.failures ?? []);
      }

      async function initAuth() {
        try {
          await supabaseSession();
        } catch (error) {
          console.error("Session error", error);
          elements.status.textContent = "Auth hiccup — refresh if Intel Mode fails.";
        }
        try {
          state.premium = await isUserPremium();
        } catch (error) {
          console.error("Premium lookup failed", error);
          state.premium = false;
        }

        if (state.premium) {
          elements.premiumPanel.classList.remove("hidden");
          elements.upgradeCard.classList.add("hidden");
          elements.premiumPanel.style.display = "block";
          elements.upgradeCard.style.display = "none";
          elements.status.textContent = "Premium systems online. Customize the desk or engage Intel Mode.";
        } else {
          elements.premiumPanel.classList.add("hidden");
          elements.upgradeCard.classList.remove("hidden");
          elements.premiumPanel.style.display = "none";
          elements.upgradeCard.style.display = "block";
        }
      }

      elements.startBtn.addEventListener("click", startShift);
      elements.resetBtn.addEventListener("click", hardReset);
      elements.skipBtn.addEventListener("click", skipBlueprint);
      elements.acceptBtn.addEventListener("click", () => handleDecision("approve"));
      elements.denyBtn.addEventListener("click", () => handleDecision("deny"));
      elements.premiumForm.addEventListener("submit", applyPremiumTheme);
      elements.intelToggle.addEventListener("change", toggleIntelMode);

      window.addEventListener("blur", () => {
        if (state.playing) {
          endShift("focus");
          logEvent("Sweep auto-paused — Eggnet lost focus.");
        }
      });

      initAuth();
      renderCase();
      updateHUD();
    </script>
  </body>
</html>
