<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Meteor Mash — Orbit Gate Inspector</title>
    <meta name="description" content="Review off-world passports, spot forged credentials, and decide who gets clearance into the Orbital Sanctuary.">
    <meta property="og:title" content="Meteor Mash — Orbit Gate Inspector">
    <meta property="og:description" content="Can you keep the Orbital Sanctuary secure? Inspect passports, catch forged docs, and make the right call under pressure.">
    <meta property="og:type" content="website">
    <meta property="og:image" content="./og-image.svg">
    <meta property="og:url" content="https://app.vibecodedbyx.com/meteor-mash/">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Meteor Mash — Orbit Gate Inspector">
    <meta name="twitter:description" content="Keep the border secure by spotting forgeries and expired visas in this fast-paced checkpoint challenge.">
    <meta name="twitter:image" content="./og-image.svg">
    <link rel="icon" href="./favicon.svg" type="image/svg+xml">
    <meta name="theme-color" content="#071431">
    <style>
      :root {
        color-scheme: dark;
        font-family: "Space Grotesk", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        --bg: radial-gradient(circle at 18% -20%, rgba(113, 146, 255, 0.25), transparent 60%),
          radial-gradient(circle at 80% 120%, rgba(255, 112, 173, 0.32), transparent 60%),
          #040712;
        --desk-surface: #111b3b;
        --card-surface: rgba(19, 29, 58, 0.92);
        --panel-surface: rgba(9, 15, 35, 0.86);
        --accent: #5bd7ff;
        --accent-soft: rgba(91, 215, 255, 0.16);
        --success: #79fcd0;
        --danger: #ff7d95;
        --warning: #ffd166;
        --text-primary: #f6f7ff;
        --text-muted: rgba(244, 247, 255, 0.66);
        --border: rgba(255, 255, 255, 0.08);
        --photo-fallback: linear-gradient(135deg, rgba(91, 215, 255, 0.35), rgba(168, 122, 255, 0.55));
        --nebula-blue: rgba(91, 215, 255, 0.55);
        --nebula-magenta: rgba(255, 136, 209, 0.55);
        --grid-line: rgba(91, 215, 255, 0.1);
        --scanline: linear-gradient(
          rgba(255, 255, 255, 0.04) 0,
          rgba(255, 255, 255, 0.04) 1px,
          transparent 1px,
          transparent 2px
        );
      }
      *, *::before, *::after {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        min-height: 100vh;
        background: var(--bg);
        color: var(--text-primary);
        display: flex;
        justify-content: center;
        align-items: stretch;
        padding: clamp(16px, 4vw, 40px);
      }
      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), transparent 65%);
        pointer-events: none;
      }
      body::after {
        content: "";
        position: fixed;
        inset: 0;
        background-image: radial-gradient(circle at 10% 15%, rgba(91, 215, 255, 0.22), transparent 55%),
          radial-gradient(circle at 80% 25%, rgba(255, 112, 173, 0.16), transparent 55%),
          radial-gradient(circle at 50% 90%, rgba(91, 255, 209, 0.12), transparent 55%),
          url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140' viewBox='0 0 140 140'%3E%3Cg fill='rgba(255,255,255,0.18)'%3E%3Ccircle cx='7' cy='7' r='1.4'/%3E%3Ccircle cx='70' cy='35' r='0.9'/%3E%3Ccircle cx='105' cy='110' r='1.2'/%3E%3Ccircle cx='28' cy='84' r='1.1'/%3E%3Ccircle cx='120' cy='45' r='0.8'/%3E%3C/g%3E%3C/svg%3E");
        opacity: 0.55;
        mix-blend-mode: screen;
        pointer-events: none;
      }
      .app {
        width: min(1120px, 100%);
        display: grid;
        gap: clamp(16px, 3vw, 28px);
        position: relative;
        z-index: 0;
      }
      .app::before {
        content: "";
        position: absolute;
        inset: -32px;
        background-image: repeating-linear-gradient(
            90deg,
            transparent,
            transparent 42px,
            var(--grid-line) 42px,
            var(--grid-line) 43px
          ),
          repeating-linear-gradient(
            0deg,
            transparent,
            transparent 42px,
            var(--grid-line) 42px,
            var(--grid-line) 43px
          );
        opacity: 0.25;
        border-radius: 40px;
        filter: blur(0.4px);
        pointer-events: none;
      }
      header {
        display: grid;
        gap: 12px;
        text-align: center;
      }
      header h1 {
        margin: 0;
        font-size: clamp(2.2rem, 6vw, 3.4rem);
        letter-spacing: 0.03em;
      }
      header p.lead {
        margin: 0 auto;
        max-width: 640px;
        color: var(--text-muted);
        line-height: 1.6;
      }
      .backlink {
        color: rgba(255, 255, 255, 0.82);
        text-decoration: none;
        font-size: 0.95rem;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        justify-self: center;
        border-radius: 999px;
        padding: 6px 14px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.12);
        transition: background 0.2s ease, transform 0.2s ease, border-color 0.2s ease;
      }
      .backlink:hover,
      .backlink:focus-visible {
        background: rgba(255, 255, 255, 0.18);
        border-color: rgba(255, 255, 255, 0.24);
        transform: translateY(-1px);
        outline: none;
      }
      main {
        display: grid;
        gap: clamp(18px, 3vw, 28px);
      }
      .hud {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 14px;
        position: relative;
      }
      .stat {
        background: linear-gradient(135deg, rgba(91, 215, 255, 0.08), rgba(168, 122, 255, 0.08)), var(--panel-surface);
        border: 1px solid rgba(91, 215, 255, 0.24);
        border-radius: 18px;
        padding: 14px 16px;
        display: grid;
        gap: 4px;
        box-shadow: 0 12px 24px rgba(4, 12, 32, 0.38);
        position: relative;
        overflow: hidden;
      }
      .stat .label {
        text-transform: uppercase;
        letter-spacing: 0.14em;
        font-size: 0.68rem;
        color: var(--text-muted);
      }
      .stat .value {
        font-size: 1.6rem;
        font-weight: 600;
      }
      .stat .value.small {
        font-size: 1.1rem;
      }
      .stat::after {
        content: "";
        position: absolute;
        inset: 0;
        background: var(--scanline);
        mix-blend-mode: screen;
        opacity: 0.65;
        pointer-events: none;
      }
      .timer-track {
        position: relative;
        height: 10px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.18);
        overflow: hidden;
        box-shadow: inset 0 0 12px rgba(4, 10, 26, 0.5);
      }
      .timer-fill {
        position: absolute;
        inset: 0;
        transform-origin: left;
        background: linear-gradient(90deg, rgba(91, 215, 255, 0.9), rgba(255, 136, 209, 0.8));
        width: 100%;
        transform: scaleX(1);
        transition: transform 0.18s ease-out;
      }
      .controls {
        display: flex;
        justify-content: center;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
      }
      .btn {
        background: linear-gradient(135deg, rgba(91, 215, 255, 0.9), rgba(103, 123, 255, 0.9));
        color: #0b132b;
        border: none;
        border-radius: 12px;
        padding: 12px 22px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease, filter 0.15s ease;
      }
      .btn.secondary {
        background: rgba(255, 255, 255, 0.08);
        color: var(--text-primary);
        border: 1px solid rgba(255, 255, 255, 0.14);
      }
      .btn.danger {
        background: linear-gradient(135deg, rgba(255, 125, 149, 0.94), rgba(255, 169, 132, 0.88));
        color: #25060f;
      }
      .btn[disabled] {
        cursor: not-allowed;
        opacity: 0.6;
        filter: grayscale(0.35);
      }
      .btn:not([disabled]):hover,
      .btn:not([disabled]):focus-visible {
        transform: translateY(-1px);
        box-shadow: 0 12px 24px rgba(87, 128, 255, 0.25);
        outline: none;
      }
      .status-line {
        text-align: center;
        color: var(--text-muted);
        margin: 6px 0 0;
      }
      .checkpoint {
        display: grid;
        grid-template-columns: minmax(0, 1.05fr) minmax(0, 0.85fr);
        gap: clamp(18px, 3vw, 28px);
        align-items: start;
      }
      .passport-wrapper {
        display: grid;
        gap: 16px;
        background: linear-gradient(150deg, rgba(14, 24, 52, 0.92), rgba(6, 10, 28, 0.92));
        border-radius: 26px;
        padding: clamp(18px, 3vw, 26px);
        border: 1px solid rgba(91, 215, 255, 0.18);
        box-shadow: inset 0 0 24px rgba(0, 0, 0, 0.45), 0 18px 40px rgba(3, 8, 18, 0.6);
        position: relative;
        overflow: hidden;
      }
      .passport-wrapper::before {
        content: "";
        position: absolute;
        inset: -120px;
        background: radial-gradient(circle at 20% 20%, var(--nebula-blue), transparent 55%),
          radial-gradient(circle at 80% 70%, var(--nebula-magenta), transparent 55%);
        opacity: 0.35;
        filter: blur(0.6px);
        pointer-events: none;
      }
      .case-banner {
        font-size: 1.1rem;
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--text-muted);
      }
      .passport-card {
        position: relative;
        background: linear-gradient(160deg, rgba(30, 60, 130, 0.85), rgba(10, 20, 60, 0.9));
        border-radius: 26px;
        padding: clamp(20px, 3.3vw, 32px);
        border: 1px solid rgba(91, 215, 255, 0.32);
        display: grid;
        gap: 18px;
        box-shadow: 0 18px 40px rgba(4, 10, 32, 0.55), inset 0 0 0 1px rgba(255, 255, 255, 0.05);
        overflow: hidden;
      }
      .passport-card::before {
        content: "";
        position: absolute;
        inset: -120px;
        background: radial-gradient(circle, rgba(91, 215, 255, 0.18), transparent 55%);
        filter: blur(0.4px);
        opacity: 0;
        transition: opacity 0.4s ease;
      }
      .passport-card:hover::before {
        opacity: 1;
      }
      .passport-header {
        display: flex;
        gap: clamp(16px, 3vw, 28px);
        align-items: center;
      }
      .portrait {
        position: relative;
        width: clamp(104px, 24vw, 152px);
        aspect-ratio: 3 / 4;
        border-radius: 22px;
        overflow: hidden;
        background: var(--photo-fallback);
        border: 2px solid rgba(91, 215, 255, 0.38);
        box-shadow: 0 16px 28px rgba(4, 12, 32, 0.65);
        isolation: isolate;
      }
      .portrait::before {
        content: "";
        position: absolute;
        inset: 0;
        background: var(--scanline);
        mix-blend-mode: screen;
        opacity: 0.55;
        pointer-events: none;
        z-index: 2;
      }
      .portrait::after {
        content: "ID ARCHIVE";
        position: absolute;
        bottom: 6px;
        right: 8px;
        font-size: 0.58rem;
        letter-spacing: 0.24em;
        color: rgba(255, 255, 255, 0.7);
        background: rgba(4, 7, 18, 0.55);
        padding: 3px 8px;
        border-radius: 999px;
        z-index: 3;
      }
      .portrait img {
        display: block;
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: relative;
        z-index: 1;
      }
      .portrait .villain-overlay {
        position: absolute;
        inset: 0;
        mix-blend-mode: screen;
        background: radial-gradient(circle at 50% 20%, rgba(255, 255, 255, 0.25), transparent 55%),
          radial-gradient(circle at 50% 80%, rgba(91, 215, 255, 0.18), transparent 65%);
        opacity: 0.9;
        z-index: 1;
        pointer-events: none;
      }
      .portrait .villain-sigil {
        position: absolute;
        top: 8px;
        left: 10px;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: rgba(4, 7, 18, 0.58);
        padding: 4px 8px;
        border-radius: 999px;
        color: rgba(255, 255, 255, 0.85);
        z-index: 3;
        letter-spacing: 0.12em;
      }
      .portrait.empty {
        display: grid;
        place-items: center;
        background: rgba(255, 255, 255, 0.04);
        border: 2px dashed rgba(91, 215, 255, 0.35);
        color: rgba(244, 247, 255, 0.75);
        font-size: clamp(1.6rem, 5vw, 2.4rem);
        font-weight: 600;
      }
      .portrait.empty::before,
      .portrait.empty::after {
        display: none;
      }
      .villain-sigil span:first-child {
        font-size: 1.1rem;
      }
      .villain-sigil span:last-child {
        font-size: 0.62rem;
        text-transform: uppercase;
        letter-spacing: 0.24em;
      }
      .passport-header h2 {
        margin: 0;
        font-size: 1.6rem;
      }
      .passport-header p {
        margin: 2px 0 0;
        color: var(--text-muted);
      }
      dl.fields {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 12px 18px;
        margin: 0;
      }
      dl.fields dt {
        font-size: 0.72rem;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        color: var(--text-muted);
      }
      dl.fields dd {
        margin: 4px 0 0;
        font-size: 1.05rem;
        font-weight: 600;
      }
      .document-note {
        font-size: 0.95rem;
        color: var(--text-muted);
        line-height: 1.5;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 16px;
        padding: 12px 14px;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .decision-buttons {
        display: flex;
        gap: 12px;
        justify-content: center;
      }
      .intel-panel {
        display: grid;
        gap: 18px;
        background: linear-gradient(170deg, rgba(19, 29, 58, 0.88), rgba(9, 16, 32, 0.88));
        border-radius: 26px;
        padding: clamp(18px, 3vw, 26px);
        border: 1px solid rgba(91, 215, 255, 0.22);
        box-shadow: 0 16px 38px rgba(4, 10, 30, 0.55);
      }
      .intel-panel h2 {
        margin: 0;
        font-size: 1.3rem;
      }
      .rules-list {
        margin: 0;
        padding: 0 0 0 18px;
        line-height: 1.6;
        color: var(--text-muted);
      }
      .intel-readout {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 14px 16px;
        display: grid;
        gap: 8px;
      }
      .intel-readout h3,
      .shift-notes h3,
      .log-card h3,
      .documents-card h3 {
        margin: 0;
        font-size: 1.1rem;
      }
      .intel-output {
        color: var(--text-muted);
        font-size: 0.95rem;
        line-height: 1.5;
      }
      .log-area {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: clamp(16px, 3vw, 24px);
      }
      .log-card,
      .documents-card {
        background: linear-gradient(170deg, rgba(19, 29, 58, 0.88), rgba(9, 16, 32, 0.88));
        border: 1px solid rgba(91, 215, 255, 0.22);
        border-radius: 24px;
        padding: clamp(18px, 3vw, 24px);
        display: grid;
        gap: 14px;
        box-shadow: 0 16px 38px rgba(4, 10, 30, 0.55);
      }
      .log-stream {
        display: grid;
        gap: 8px;
        max-height: 220px;
        overflow-y: auto;
        font-size: 0.95rem;
      }
      .log-stream span {
        padding: 10px 12px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: rgba(244, 247, 255, 0.85);
      }
      dl.manifest {
        margin: 0;
        display: grid;
        gap: 12px;
      }
      dl.manifest dt {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.18em;
        color: var(--text-muted);
      }
      dl.manifest dd {
        margin: 4px 0 0;
        font-size: 1.05rem;
        font-weight: 600;
      }
      .story-snippet {
        font-size: 0.95rem;
        color: var(--text-muted);
        line-height: 1.5;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 16px;
        padding: 12px 14px;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .premium-card,
      .upgrade-card {
        background: linear-gradient(170deg, rgba(19, 29, 58, 0.88), rgba(9, 16, 32, 0.88));
        border: 1px solid rgba(91, 215, 255, 0.22);
        border-radius: 24px;
        padding: clamp(18px, 3vw, 26px);
        display: grid;
        gap: 14px;
        box-shadow: 0 16px 38px rgba(4, 10, 30, 0.55);
      }
      .premium-card form {
        display: grid;
        gap: 12px 16px;
      }
      .picker-row {
        display: grid;
        gap: 10px;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }
      label span {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.18em;
        color: var(--text-muted);
        display: block;
        margin-bottom: 6px;
      }
      input[type="color"] {
        width: 100%;
        height: 44px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        border-radius: 14px;
        background: transparent;
        cursor: pointer;
      }
      .toggle {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        font-size: 0.95rem;
        color: var(--text-muted);
      }
      .toggle input {
        width: 18px;
        height: 18px;
      }
      footer {
        text-align: center;
        color: var(--text-muted);
        font-size: 0.9rem;
      }
      .hidden {
        display: none !important;
      }
      @media (max-width: 1024px) {
        .checkpoint {
          grid-template-columns: 1fr;
        }
      }
      @media (max-width: 640px) {
        body {
          padding: 14px;
        }
        .passport-header {
          flex-direction: column;
          align-items: flex-start;
        }
        .decision-buttons {
          flex-direction: column;
        }
        .btn {
          width: 100%;
        }
        .log-area {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header>
        <h1>Meteor Mash: Orbit Gate Inspector</h1>
        <p class="lead">
          Welcome to Checkpoint Helios. Review each traveler's passport, cross-check their story,
          and decide whether they can enter the Orbital Sanctuary. Three mistakes and Command pulls your badge.
        </p>
        <a class="backlink" href="https://www.vibecodedbyx.com" target="_blank" rel="noreferrer noopener">⬅ Back to the livestream</a>
      </header>

      <main>
        <section class="hud">
          <div class="stat">
            <span class="label">Score</span>
            <span class="value" id="score-value">0</span>
          </div>
          <div class="stat">
            <span class="label">Cases</span>
            <span class="value" id="cases-value">0 / 12</span>
          </div>
          <div class="stat">
            <span class="label">Accuracy</span>
            <span class="value small" id="accuracy-value">—</span>
          </div>
          <div class="stat">
            <span class="label">Strikes Left</span>
            <span class="value small" id="strikes-value">3</span>
          </div>
          <div class="stat">
            <span class="label">Shift Timer</span>
            <span class="value small" id="timer-value">90.0s</span>
          </div>
        </section>

        <div class="timer-track" aria-hidden="true">
          <div class="timer-fill" id="timer-fill"></div>
        </div>

        <div class="controls">
          <button class="btn" id="start-btn" type="button">Start shift</button>
          <button class="btn secondary" id="reset-btn" type="button" disabled>Reset desk</button>
          <button class="btn secondary" id="skip-btn" type="button" disabled>Skip case</button>
        </div>
        <p class="status-line" id="status-message">Checkpoint idle. Spin up the scanners when you're ready.</p>

        <section class="checkpoint">
          <div class="passport-wrapper">
            <div class="case-banner" id="banner">Awaiting assignment…</div>
            <div class="passport-card" aria-live="polite">
              <div class="passport-header">
                <div class="portrait empty" id="traveler-photo">?</div>
                <div>
                  <h2 id="traveler-name">No file loaded</h2>
                  <p id="traveler-home">—</p>
                </div>
              </div>
              <dl class="fields">
                <div>
                  <dt>Document ID</dt>
                  <dd id="passport-id">----</dd>
                </div>
                <div>
                  <dt>Expiry</dt>
                  <dd id="expiry-date">----</dd>
                </div>
                <div>
                  <dt>Clearance</dt>
                  <dd id="clearance-level">----</dd>
                </div>
                <div>
                  <dt>Visa Type</dt>
                  <dd id="visa-type">----</dd>
                </div>
                <div>
                  <dt>Entry Stamp</dt>
                  <dd id="entry-stamp">----</dd>
                </div>
                <div>
                  <dt>Reason</dt>
                  <dd id="reason-detail">----</dd>
                </div>
              </dl>
              <div class="document-note" id="document-note">Desk notes will appear here once a case is active.</div>
            </div>
            <div class="decision-buttons">
              <button class="btn" id="accept-btn" type="button" disabled>Admit traveler</button>
              <button class="btn danger" id="deny-btn" type="button" disabled>Reject traveler</button>
            </div>
          </div>

          <aside class="intel-panel">
            <h2>Entry Briefing</h2>
            <ol class="rules-list" id="rules-list">
              <li>Passport expiry must be on or after <strong>2247-07-18</strong>.</li>
              <li>Only <strong>AURORA</strong> entry stamps are honored at Helios Gate.</li>
              <li>Workers need <strong>Clearance Level 2+</strong>. Visitors from the Quake Belt need Level 3.</li>
              <li>Any active warrants or missing cargo manifests mean instant denial.</li>
            </ol>
            <div class="intel-readout">
              <h3>Desk Intel</h3>
              <div class="intel-output" id="intel-output">Enable Intel Mode (premium) to receive automated cross-checks.</div>
            </div>
            <div class="shift-notes">
              <h3>Shift Notes</h3>
              <p class="status-line">
                Process 12 cases before the timer hits zero. Three wrong calls and Command shutters the lane.
              </p>
            </div>
          </aside>
        </section>

        <section class="log-area">
          <div class="log-card">
            <h3>Border Log</h3>
            <div class="log-stream" id="log">
              <span>No activity yet. Your decisions will be logged here.</span>
            </div>
          </div>
          <div class="documents-card">
            <h3>Supplemental Docs</h3>
            <dl class="manifest">
              <div>
                <dt>Declared Goods</dt>
                <dd id="cargo-detail">----</dd>
              </div>
              <div>
                <dt>Manifest Status</dt>
                <dd id="manifest-status">----</dd>
              </div>
              <div>
                <dt>Additional Notes</dt>
                <dd id="additional-notes">----</dd>
              </div>
            </dl>
            <div class="story-snippet" id="story-snippet">Travelers' stories and inconsistencies will appear here.</div>
          </div>
        </section>

        <section class="premium-card hidden" id="premium-content">
          <h2>Premium Deck — Customize Your Checkpoint</h2>
          <p class="status-line">Tailor your desk lighting and deploy Intel Mode for automatic cross-check highlights.</p>
          <form id="premium-form">
            <div class="picker-row">
              <label>
                <span>Desk surface</span>
                <input type="color" id="desk-color" name="desk" value="#111b3b">
              </label>
              <label>
                <span>Accent glow</span>
                <input type="color" id="accent-color" name="accent" value="#5bd7ff">
              </label>
            </div>
            <label class="toggle">
              <input type="checkbox" id="intel-mode">
              Enable Intel Mode (auto-identify likely violations)
            </label>
            <button class="btn" type="submit">Apply premium layout</button>
          </form>
        </section>

        <section class="upgrade-card" id="upgrade-button">
          <h2>Upgrade to premium for Intel Mode</h2>
          <p class="status-line">Subscribers unlock desk theming and AI-assisted violation hints.</p>
        </section>
      </main>

      <footer>
        Built live on stream — share your best acceptance streak and tag @VibeCodedByX 👮‍♂️🛂
      </footer>
    </div>

    <script type="module">
      import { supabaseSession, isUserPremium } from "../../supabase-config.js";

      const SHIFT_DURATION = 90_000;
      const CASES_PER_SHIFT = 12;
      const SHIFT_DATE = new Date("2247-07-18");
      const MAX_STRIKES = 3;
      const RULE_MANIFEST = [
        {
          id: "expiry",
          label: "Expired passport",
          test: (p) => new Date(p.expiry) >= SHIFT_DATE,
          hint: (p) => `Document expired on ${p.expiry}.`,
        },
        {
          id: "stamp",
          label: "Invalid entry stamp",
          test: (p) => p.entryStamp === "AURORA",
          hint: (p) => `Stamp shows ${p.entryStamp}, not AURORA.`,
        },
        {
          id: "clearance",
          label: "Insufficient clearance",
          test: (p) => {
            if (p.reason === "Work" && p.clearance < 2) return false;
            if (p.homeworld === "Quake Belt" && p.clearance < 3) return false;
            return true;
          },
          hint: (p) => `Clearance ${p.clearance} fails requirements for ${p.reason === "Work" ? "work" : p.homeworld}.`,
        },
        {
          id: "warrant",
          label: "Active warrant",
          test: (p) => !p.hasWarrant,
          hint: () => "Active warrant pinged in the system.",
        },
        {
          id: "manifest",
          label: "Missing manifest",
          test: (p) => p.manifestStatus === "Filed",
          hint: () => "Cargo manifest missing or incomplete.",
        },
      ];

      const NAMES = [
        "Astra Kepler",
        "Milo Andara",
        "Ren Vega",
        "Nyra Sol",
        "Cassian Holt",
        "Eli Orrin",
        "Juno Farrow",
        "Lira Mendez",
        "Pax Karo",
        "Zadie Quill",
        "Thorne Vale",
        "Mara Lune",
        "Orry Talus",
        "Ila Storm",
      ];
      const HOMEWORLDS = [
        "Helios Prime",
        "Quake Belt",
        "Lumen Station",
        "Ceto Colony",
        "Orion Drift",
        "Rhea Outpost",
        "Vale Sprawl",
        "Icarus Fringe",
      ];
      const VISA_TYPES = ["Transit", "Work", "Research", "Diplomatic", "Visit"];
      const STAMP_CODES = ["AURORA", "TIDE", "NOVA", "VOID"];
      const CARGO_OPTIONS = ["Medical supplies", "Holo art crates", "Grain capsules", "Starforge tools", "Personal effects", "No declared cargo"];
      const NOTES_BANK = [
        "Mentioned a sister already inside the Sanctuary.",
        "Arrived with an escort drone still cooling outside.",
        "Sweating despite the checkpoint chill.",
        "Claims to have lost clearance badge last cycle.",
        "Presents a handwritten note from Embassy liaison.",
        "Insists on catching the next lift to the upper promenade.",
      ];
      const STORIES = [
        "Requesting re-entry after a two-cycle survey mission.",
        "Says the Quake Belt aftershocks wiped their archives.",
        "Insists the work contract starts in under an hour.",
        "Bringing rare seeds for the Sanctuary gardens.",
        "Escaping a dust storm that breached dome seals.",
        "Touring the orbital museum before heading coreward.",
      ];

      const VILLAIN_ARCHIVE = [
        {
          id: "egg-sentinel",
          codename: "EGG SENTINEL",
          icon: "🥚",
          tagline: "Moustached mech commander with vortex boosters.",
          palette: {
            bg: "#040b1d",
            panel: "#1d2f68",
            mask: "#ff5d63",
            accent: "#ffd25b",
            detail: "#ffe7b8",
            glow: "#53d7ff",
            eye: "#040a1a",
            moustache: "#ffae3d",
            grid: "rgba(255, 210, 91, 0.12)",
          },
          draw: ({ palette, glowId }) => `
            <g transform="translate(22 24)">
              <rect x="0" y="0" width="216" height="272" rx="32" fill="${palette.panel}" stroke="${palette.accent}" stroke-width="4" />
              <rect x="12" y="14" width="192" height="238" rx="28" fill="rgba(255, 255, 255, 0.06)" />
              <g transform="translate(26 44)">
                <ellipse cx="84" cy="70" rx="82" ry="68" fill="${palette.mask}" />
                <circle cx="84" cy="112" r="20" fill="${palette.detail}" stroke="${palette.accent}" stroke-width="6" />
                <circle cx="52" cy="86" r="26" fill="${palette.detail}" stroke="${palette.glow}" stroke-width="4" />
                <circle cx="116" cy="86" r="26" fill="${palette.detail}" stroke="${palette.glow}" stroke-width="4" />
                <circle cx="52" cy="86" r="11" fill="${palette.eye}" />
                <circle cx="116" cy="86" r="11" fill="${palette.eye}" />
                <path d="M20 132 Q84 96 148 132 Q112 168 84 172 Q56 168 20 132" fill="${palette.moustache}" />
                <path d="M30 60 Q84 18 138 60" stroke="${palette.detail}" stroke-width="9" stroke-linecap="round" />
              </g>
              <path d="M46 214 H170" stroke="${palette.glow}" stroke-width="6" stroke-linecap="round" opacity="0.8" />
              <circle cx="108" cy="234" r="14" fill="${palette.detail}" stroke="${palette.accent}" stroke-width="4" />
              <circle cx="140" cy="234" r="14" fill="${palette.detail}" stroke="${palette.accent}" stroke-width="4" />
            </g>
          `,
        },
        {
          id: "metal-viper",
          codename: "METAL VIPER",
          icon: "⚙️",
          tagline: "Chrome coil hunter tuned for Mach 4 chases.",
          palette: {
            bg: "#030617",
            panel: "#0b1a3f",
            shell: "#1b4d8b",
            plates: "#051131",
            accent: "#62f3ff",
            detail: "#9ddcff",
            eye: "#d3f9ff",
            glow: "#62f3ff",
            grid: "rgba(98, 243, 255, 0.12)",
          },
          draw: ({ palette }) => `
            <g transform="translate(26 30)">
              <rect x="0" y="0" width="208" height="260" rx="30" fill="${palette.panel}" stroke="${palette.accent}" stroke-width="3" />
              <path d="M12 220 L104 36 L196 220 Z" fill="${palette.shell}" stroke="${palette.glow}" stroke-width="4" />
              <g transform="translate(40 82)">
                <rect x="0" y="0" width="128" height="86" rx="18" fill="${palette.plates}" stroke="${palette.accent}" stroke-width="4" />
                <line x1="8" y1="44" x2="120" y2="44" stroke="${palette.glow}" stroke-width="3" stroke-dasharray="8 8" />
                <polygon points="20,68 64,18 108,68" fill="${palette.shell}" />
                <circle cx="36" cy="46" r="20" fill="${palette.detail}" />
                <circle cx="92" cy="46" r="20" fill="${palette.detail}" />
                <circle cx="36" cy="46" r="9" fill="${palette.eye}" />
                <circle cx="92" cy="46" r="9" fill="${palette.eye}" />
              </g>
              <path d="M52 230 C70 200 138 200 156 230" stroke="${palette.accent}" stroke-width="10" stroke-linecap="round" fill="none" />
              <path d="M52 230 Q104 250 156 230" stroke="${palette.glow}" stroke-width="3" fill="none" opacity="0.7" />
              <circle cx="104" cy="188" r="18" fill="${palette.shell}" stroke="${palette.accent}" stroke-width="3" />
              <line x1="104" y1="170" x2="104" y2="206" stroke="${palette.glow}" stroke-width="4" stroke-linecap="round" />
            </g>
          `,
        },
        {
          id: "shadow-wraith",
          codename: "SHADOW WRAITH",
          icon: "🌑",
          tagline: "Cloaked teleporter that stalks the neon rails.",
          palette: {
            bg: "#080416",
            panel: "#1b1638",
            cloak: "#341c7c",
            accent: "#b280ff",
            detail: "#ffe0fe",
            eye: "#ff4fae",
            glow: "#b280ff",
            grid: "rgba(178, 128, 255, 0.14)",
          },
          draw: ({ palette }) => `
            <g transform="translate(18 32)">
              <rect x="0" y="0" width="224" height="256" rx="32" fill="${palette.panel}" stroke="${palette.glow}" stroke-width="3" />
              <path d="M12 220 Q112 120 212 220" fill="${palette.cloak}" />
              <path d="M48 60 Q112 12 176 60 Q160 130 112 146 Q64 130 48 60" fill="${palette.cloak}" />
              <circle cx="112" cy="96" r="52" fill="${palette.panel}" stroke="${palette.glow}" stroke-width="4" />
              <ellipse cx="96" cy="90" rx="18" ry="22" fill="${palette.detail}" />
              <ellipse cx="128" cy="90" rx="18" ry="22" fill="${palette.detail}" />
              <ellipse cx="96" cy="90" rx="8" ry="12" fill="${palette.eye}" />
              <ellipse cx="128" cy="90" rx="8" ry="12" fill="${palette.eye}" />
              <path d="M82 122 Q112 144 142 122" stroke="${palette.detail}" stroke-width="5" stroke-linecap="round" />
              <path d="M88 60 L112 42 L136 60" stroke="${palette.glow}" stroke-width="4" stroke-linecap="round" />
              <circle cx="112" cy="178" r="30" fill="${palette.panel}" stroke="${palette.glow}" stroke-width="4" />
              <path d="M92 182 Q112 196 132 182" stroke="${palette.detail}" stroke-width="4" stroke-linecap="round" />
              <path d="M82 210 H142" stroke="${palette.glow}" stroke-width="6" stroke-linecap="round" opacity="0.7" />
            </g>
          `,
        },
        {
          id: "chaos-warden",
          codename: "CHAOS WARDEN",
          icon: "💧",
          tagline: "Gelid shapeshifter rippling with Chaos energy.",
          palette: {
            bg: "#02121d",
            panel: "#08354c",
            body: "#1aa7ff",
            accent: "#52fff6",
            detail: "#cbfff9",
            eye: "#091322",
            glow: "#52fff6",
            grid: "rgba(82, 255, 246, 0.14)",
          },
          draw: ({ palette }) => `
            <g transform="translate(20 28)">
              <rect x="0" y="0" width="220" height="264" rx="34" fill="${palette.panel}" stroke="${palette.accent}" stroke-width="3" />
              <path d="M34 222 Q110 146 186 222" fill="${palette.body}" opacity="0.82" />
              <path d="M44 204 Q110 128 176 204" fill="${palette.body}" opacity="0.9" />
              <circle cx="110" cy="116" r="72" fill="${palette.body}" />
              <path d="M60 116 Q110 72 160 116" stroke="${palette.detail}" stroke-width="12" stroke-linecap="round" opacity="0.75" />
              <circle cx="84" cy="118" r="22" fill="${palette.detail}" />
              <circle cx="136" cy="118" r="22" fill="${palette.detail}" />
              <circle cx="84" cy="118" r="10" fill="${palette.eye}" />
              <circle cx="136" cy="118" r="10" fill="${palette.eye}" />
              <path d="M82 156 Q110 176 138 156" stroke="${palette.detail}" stroke-width="6" stroke-linecap="round" />
              <path d="M52 78 Q110 26 168 78" stroke="${palette.accent}" stroke-width="10" stroke-linecap="round" />
              <circle cx="110" cy="214" r="34" fill="${palette.body}" stroke="${palette.accent}" stroke-width="4" />
              <path d="M92 214 Q110 230 128 214" stroke="${palette.detail}" stroke-width="4" stroke-linecap="round" />
            </g>
          `,
        },
        {
          id: "buzz-ronin",
          codename: "BUZZ RONIN",
          icon: "🐝",
          tagline: "Hover-lancer with electrified stingers.",
          palette: {
            bg: "#050308",
            panel: "#20140f",
            armor: "#ffb430",
            stripe: "#ff8030",
            accent: "#ffe08a",
            detail: "#fff7cc",
            eye: "#1a0404",
            glow: "#ffe08a",
            grid: "rgba(255, 180, 48, 0.16)",
          },
          draw: ({ palette }) => `
            <g transform="translate(18 26)">
              <rect x="0" y="0" width="224" height="268" rx="34" fill="${palette.panel}" stroke="${palette.accent}" stroke-width="3" />
              <path d="M56 60 L168 60 L196 132 L112 210 L28 132 Z" fill="${palette.armor}" stroke="${palette.accent}" stroke-width="4" />
              <path d="M56 102 L168 102" stroke="${palette.stripe}" stroke-width="30" stroke-linecap="round" />
              <circle cx="84" cy="94" r="20" fill="${palette.detail}" />
              <circle cx="140" cy="94" r="20" fill="${palette.detail}" />
              <circle cx="84" cy="94" r="8" fill="${palette.eye}" />
              <circle cx="140" cy="94" r="8" fill="${palette.eye}" />
              <path d="M84 60 Q112 38 140 60" stroke="${palette.detail}" stroke-width="6" stroke-linecap="round" />
              <path d="M70 138 Q112 166 154 138" stroke="${palette.detail}" stroke-width="10" stroke-linecap="round" />
              <path d="M48 164 Q112 198 176 164" stroke="${palette.accent}" stroke-width="6" stroke-linecap="round" opacity="0.75" />
              <path d="M28 220 Q112 166 196 220" fill="${palette.stripe}" opacity="0.8" />
            </g>
          `,
        },
        {
          id: "emerald-hex",
          codename: "EMERALD HEX",
          icon: "💚",
          tagline: "Chaos sorcerer amplifying the Master shards.",
          palette: {
            bg: "#03150d",
            panel: "#0f2c1f",
            cloak: "#19b487",
            accent: "#6cffd5",
            detail: "#c5ffef",
            eye: "#011f12",
            glow: "#6cffd5",
            grid: "rgba(108, 255, 213, 0.14)",
          },
          draw: ({ palette }) => `
            <g transform="translate(20 28)">
              <rect x="0" y="0" width="220" height="264" rx="30" fill="${palette.panel}" stroke="${palette.accent}" stroke-width="3" />
              <path d="M12 208 Q110 116 208 208" fill="${palette.cloak}" opacity="0.85" />
              <path d="M36 68 Q110 8 184 68 Q168 152 110 184 Q52 152 36 68" fill="${palette.cloak}" />
              <circle cx="110" cy="112" r="56" fill="${palette.detail}" stroke="${palette.accent}" stroke-width="4" />
              <ellipse cx="94" cy="106" rx="18" ry="20" fill="${palette.cloak}" />
              <ellipse cx="126" cy="106" rx="18" ry="20" fill="${palette.cloak}" />
              <circle cx="94" cy="106" r="8" fill="${palette.eye}" />
              <circle cx="126" cy="106" r="8" fill="${palette.eye}" />
              <path d="M88 140 Q110 154 132 140" stroke="${palette.cloak}" stroke-width="6" stroke-linecap="round" />
              <path d="M70 84 Q110 56 150 84" stroke="${palette.accent}" stroke-width="6" stroke-linecap="round" />
              <path d="M94 48 L110 30 L126 48" stroke="${palette.detail}" stroke-width="4" stroke-linecap="round" />
              <circle cx="110" cy="200" r="30" fill="${palette.cloak}" stroke="${palette.detail}" stroke-width="4" />
              <path d="M94 200 Q110 214 126 200" stroke="${palette.detail}" stroke-width="4" stroke-linecap="round" />
            </g>
          `,
        },
      ];

      const els = {
        startBtn: document.getElementById("start-btn"),
        resetBtn: document.getElementById("reset-btn"),
        skipBtn: document.getElementById("skip-btn"),
        acceptBtn: document.getElementById("accept-btn"),
        denyBtn: document.getElementById("deny-btn"),
        score: document.getElementById("score-value"),
        cases: document.getElementById("cases-value"),
        accuracy: document.getElementById("accuracy-value"),
        strikes: document.getElementById("strikes-value"),
        timer: document.getElementById("timer-value"),
        timerFill: document.getElementById("timer-fill"),
        banner: document.getElementById("banner"),
        status: document.getElementById("status-message"),
        log: document.getElementById("log"),
        travelerPhoto: document.getElementById("traveler-photo"),
        travelerName: document.getElementById("traveler-name"),
        travelerHome: document.getElementById("traveler-home"),
        passportId: document.getElementById("passport-id"),
        expiryDate: document.getElementById("expiry-date"),
        clearance: document.getElementById("clearance-level"),
        visa: document.getElementById("visa-type"),
        stamp: document.getElementById("entry-stamp"),
        reason: document.getElementById("reason-detail"),
        note: document.getElementById("document-note"),
        cargo: document.getElementById("cargo-detail"),
        manifestStatus: document.getElementById("manifest-status"),
        additional: document.getElementById("additional-notes"),
        story: document.getElementById("story-snippet"),
        intelOutput: document.getElementById("intel-output"),
        premiumSection: document.getElementById("premium-content"),
        upgradeSection: document.getElementById("upgrade-button"),
        premiumForm: document.getElementById("premium-form"),
        deskColor: document.getElementById("desk-color"),
        accentColor: document.getElementById("accent-color"),
        intelMode: document.getElementById("intel-mode"),
      };

      const state = {
        playing: false,
        queue: [],
        caseIndex: 0,
        score: 0,
        strikes: 0,
        casesReviewed: 0,
        correct: 0,
        timeLeft: SHIFT_DURATION,
        shiftEndsAt: 0,
        highScore: 0,
        premium: false,
        intelMode: false,
      };

      let rafId = null;

      function setStatus(text) {
        els.status.textContent = text;
      }

      function logEvent(text) {
        const now = new Date();
        const stamp = now.toLocaleTimeString([], { hour: "numeric", minute: "2-digit", second: "2-digit" });
        const entry = document.createElement("span");
        entry.textContent = `[${stamp}] ${text}`;
        els.log.prepend(entry);
        while (els.log.children.length > 25) {
          els.log.lastElementChild.remove();
        }
      }

      function randomItem(list) {
        return list[Math.floor(Math.random() * list.length)];
      }

      function pad(num, size = 3) {
        return num.toString().padStart(size, "0");
      }

      function createDocumentId() {
        return `HX-${pad(Math.floor(Math.random() * 999))}-${pad(Math.floor(Math.random() * 999))}`;
      }

      function randomFutureDate() {
        const start = new Date("2247-07-01").getTime();
        const end = new Date("2248-06-30").getTime();
        const time = start + Math.random() * (end - start);
        return new Date(time);
      }

      function randomPastDate() {
        const start = new Date("2246-01-01").getTime();
        const end = new Date("2247-06-01").getTime();
        const time = start + Math.random() * (end - start);
        return new Date(time);
      }

      function formatDate(date) {
        return date.toISOString().slice(0, 10);
      }

      function evaluatePassport(passport) {
        const failures = RULE_MANIFEST.filter((rule) => !rule.test(passport)).map((rule) => rule.hint(passport));
        return {
          valid: failures.length === 0,
          failures,
        };
      }

      function maybeCorrupt(passport) {
        const tweaks = [
          () => (passport.expiry = formatDate(randomPastDate())),
          () => (passport.entryStamp = randomItem(STAMP_CODES.filter((code) => code !== "AURORA"))),
          () => {
            if (passport.reason === "Work") {
              passport.clearance = 1;
            } else {
              passport.reason = "Work";
              passport.clearance = 1;
            }
          },
          () => {
            passport.homeworld = "Quake Belt";
            passport.clearance = 1;
          },
          () => {
            passport.hasWarrant = true;
          },
          () => {
            passport.manifestStatus = "Missing";
          },
        ];
        randomItem(tweaks)();
      }

      function createCase(index) {
        const portrait = randomItem(VILLAIN_ARCHIVE);
        const passport = {
          name: randomItem(NAMES),
          homeworld: randomItem(HOMEWORLDS),
          documentId: createDocumentId(),
          expiry: formatDate(randomFutureDate()),
          clearance: Math.ceil(Math.random() * 3),
          visa: randomItem(VISA_TYPES),
          entryStamp: Math.random() < 0.78 ? "AURORA" : randomItem(STAMP_CODES),
          reason: randomItem(["Work", "Visit", "Transit", "Research"]),
          cargo: randomItem(CARGO_OPTIONS),
          manifestStatus: Math.random() < 0.85 ? "Filed" : "Missing",
          additionalNotes: randomItem(NOTES_BANK),
          story: randomItem(STORIES),
          hasWarrant: Math.random() < 0.08,
          alias: portrait.codename,
        };

        let evaluation = evaluatePassport(passport);
        if (evaluation.valid && Math.random() < 0.45) {
          maybeCorrupt(passport);
          evaluation = evaluatePassport(passport);
        }
        if (!evaluation.valid && Math.random() < 0.2) {
          passport.manifestStatus = "Filed";
          evaluation = evaluatePassport(passport);
        }

        return {
          id: `case-${Date.now()}-${index}-${Math.floor(Math.random() * 9999)}`,
          passport,
          evaluation,
          portrait,
        };
      }

      function buildQueue() {
        return Array.from({ length: CASES_PER_SHIFT }, (_, idx) => createCase(idx));
      }

      function updateHUD() {
        els.score.textContent = state.score.toString();
        const total = state.queue.length || CASES_PER_SHIFT;
        els.cases.textContent = `${state.casesReviewed} / ${total}`;
        const accuracy = state.casesReviewed > 0 ? Math.round((state.correct / state.casesReviewed) * 100) : null;
        els.accuracy.textContent = accuracy !== null ? `${accuracy}%` : "—";
        const strikesLeft = Math.max(0, MAX_STRIKES - state.strikes);
        els.strikes.textContent = strikesLeft.toString();
        els.timer.textContent = `${(state.timeLeft / 1000).toFixed(1)}s`;
        if (els.timerFill) {
          const ratio = Math.max(0, Math.min(1, state.timeLeft / SHIFT_DURATION));
          els.timerFill.style.transform = `scaleX(${ratio})`;
          els.timerFill.style.opacity = ratio === 0 ? "0.25" : "1";
        }
      }

      function composeVillainSVG(profile) {
        const palette = profile.palette;
        const gridId = `grid-${profile.id}`;
        const glowId = `glow-${profile.id}`;
        const accentId = `accent-${profile.id}`;
        const shapes = profile.draw({ palette, glowId, accentId });
        const svg = `
          <svg width="260" height="320" viewBox="0 0 260 320" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="${glowId}" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="${palette.glow}" stop-opacity="0.05" />
                <stop offset="1" stop-color="${palette.glow}" stop-opacity="0.32" />
              </linearGradient>
              <linearGradient id="${accentId}" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0" stop-color="${palette.accent || palette.glow}" stop-opacity="0.85" />
                <stop offset="1" stop-color="${palette.detail || palette.accent || palette.glow}" stop-opacity="0.18" />
              </linearGradient>
              <pattern id="${gridId}" width="36" height="36" patternUnits="userSpaceOnUse">
                <rect width="36" height="36" fill="none" />
                <path d="M0 0H36M0 0V36" stroke="${palette.grid}" stroke-width="0.6" />
                <circle cx="18" cy="18" r="1.8" fill="${palette.glow}" opacity="0.32" />
              </pattern>
            </defs>
            <rect width="260" height="320" fill="${palette.bg}" />
            <rect width="260" height="320" fill="url(#${gridId})" opacity="0.22" />
            <rect x="20" y="20" width="220" height="280" rx="36" fill="url(#${glowId})" opacity="0.45" />
            <rect x="28" y="32" width="204" height="256" rx="28" fill="url(#${accentId})" opacity="0.32" />
            ${shapes}
            <text x="24" y="300" fill="${palette.detail || "#f6f7ff"}" font-size="12" font-family="'Space Grotesk','Inter',sans-serif" letter-spacing="4">${profile.codename}</text>
            <text x="24" y="44" fill="${palette.glow}" font-size="20" font-family="'Space Grotesk','Inter',sans-serif" opacity="0.8">${profile.icon}</text>
          </svg>
        `;
        return `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(svg)}`;
      }

      function renderVillainPortrait(caseFile) {
        if (!caseFile || !caseFile.portrait) {
          resetPortrait();
          return;
        }
        const node = els.travelerPhoto;
        node.classList.remove("empty");
        node.textContent = "";
        node.style.background = "transparent";
        const img = document.createElement("img");
        img.src = composeVillainSVG(caseFile.portrait);
        img.alt = `${caseFile.portrait.codename} dossier portrait for ${caseFile.passport.name}`;
        node.appendChild(img);
        const overlay = document.createElement("div");
        overlay.className = "villain-overlay";
        node.appendChild(overlay);
        const sigil = document.createElement("div");
        sigil.className = "villain-sigil";
        const iconSpan = document.createElement("span");
        iconSpan.textContent = caseFile.portrait.icon;
        iconSpan.setAttribute("aria-hidden", "true");
        const codeSpan = document.createElement("span");
        codeSpan.textContent = caseFile.portrait.codename;
        sigil.append(iconSpan, codeSpan);
        node.appendChild(sigil);
      }

      function resetPortrait() {
        const node = els.travelerPhoto;
        node.classList.add("empty");
        node.style.background = "rgba(255, 255, 255, 0.04)";
        node.textContent = "?";
      }

      function applyPhotoStyling(name) {
        const palette = ["#58d5ff", "#ff6d8c", "#9e7bff", "#5ff2c6", "#ffdf6d"];
        const color = palette[name.charCodeAt(0) % palette.length];
        els.travelerPhoto.style.background = `linear-gradient(135deg, ${color}, rgba(255, 255, 255, 0.4))`;
        els.travelerPhoto.textContent = name
          .split(" ")
          .map((part) => part[0])
          .join("")
          .slice(0, 2)
          .toUpperCase();
      }

      function renderCase() {
        const current = state.queue[state.caseIndex];
        if (!current) {
          els.banner.textContent = "Awaiting assignment…";
          els.travelerName.textContent = "No file loaded";
          els.travelerHome.textContent = "—";
          els.passportId.textContent = "----";
          els.expiryDate.textContent = "----";
          els.clearance.textContent = "----";
          els.visa.textContent = "----";
          els.stamp.textContent = "----";
          els.reason.textContent = "----";
          els.note.textContent = "Desk notes will appear here once a case is active.";
          els.cargo.textContent = "----";
          els.manifestStatus.textContent = "----";
          els.additional.textContent = "----";
          els.story.textContent = "Travelers' stories and inconsistencies will appear here.";
          resetPortrait();
          els.acceptBtn.disabled = true;
          els.denyBtn.disabled = true;
          els.skipBtn.disabled = true;
          updateIntel();
          return;
        }

        const { passport } = current;
        els.banner.textContent = `Case ${state.caseIndex + 1}/${state.queue.length} • ${current.portrait.codename}`;
        els.travelerName.textContent = passport.name;
        els.travelerHome.textContent = `${passport.homeworld} — ${passport.reason} entry`;
        els.passportId.textContent = passport.documentId;
        els.expiryDate.textContent = passport.expiry;
        els.clearance.textContent = `Level ${passport.clearance}`;
        els.visa.textContent = passport.visa;
        els.stamp.textContent = passport.entryStamp;
        els.reason.textContent = passport.reason;
        els.note.textContent = `Alias: ${current.portrait.codename} — ${passport.additionalNotes}`;
        els.cargo.textContent = passport.cargo;
        els.manifestStatus.textContent = passport.manifestStatus;
        els.additional.textContent = passport.hasWarrant ? "Active warrant flagged." : "No warrants detected.";
        els.story.textContent = `${passport.story} // Intel: ${current.portrait.tagline}`;
        renderVillainPortrait(current);

        const buttonsDisabled = !state.playing;
        els.acceptBtn.disabled = buttonsDisabled;
        els.denyBtn.disabled = buttonsDisabled;
        els.skipBtn.disabled = buttonsDisabled;
        updateIntel();
      }

      function updateIntel() {
        const current = state.queue[state.caseIndex];
        if (!current) {
          els.intelOutput.textContent = state.premium && state.intelMode
            ? "Intel Mode ready. Start a shift to receive automated checks."
            : "Enable Intel Mode (premium) to receive automated cross-checks.";
          return;
        }
        if (!state.premium || !state.intelMode) {
          els.intelOutput.textContent = "Manual inspection only. Premium Intel Mode reveals likely violations.";
          return;
        }
        if (current.evaluation.failures.length === 0) {
          els.intelOutput.textContent = "No discrepancies detected. All rules satisfied.";
        } else {
          els.intelOutput.innerHTML = current.evaluation.failures
            .map((issue) => `<div>⚠️ ${issue}</div>`)
            .join("");
        }
      }

      function shiftLoop(timestamp) {
        if (!state.playing) {
          return;
        }
        if (!state.shiftEndsAt) {
          state.shiftEndsAt = timestamp + SHIFT_DURATION;
        }
        state.timeLeft = Math.max(0, state.shiftEndsAt - timestamp);
        updateHUD();
        if (state.timeLeft <= 0) {
          endShift("time");
          return;
        }
        rafId = requestAnimationFrame(shiftLoop);
      }

      function adjustScore(correct, evaluation) {
        if (correct) {
          const bonus = Math.max(1, evaluation.failures.length);
          state.score += 120 + bonus * 20;
        } else {
          state.score = Math.max(0, state.score - 80);
        }
      }

      function handleDecision(decision) {
        if (!state.playing) return;
        const current = state.queue[state.caseIndex];
        if (!current) return;

        const shouldAdmit = current.evaluation.valid;
        const correct = (decision === "accept" && shouldAdmit) || (decision === "deny" && !shouldAdmit);
        adjustScore(correct, current.evaluation);
        state.casesReviewed += 1;
        if (correct) {
          state.correct += 1;
          setStatus("Good call. Keep the line moving.");
          logEvent(`✔️ Case ${state.caseIndex + 1}: ${current.passport.name} decision correct.`);
        } else {
          state.strikes += 1;
          const reason = current.evaluation.failures[0] || "Unnecessary denial.";
          setStatus(`Strike logged: ${reason}`);
          logEvent(`✖️ Case ${state.caseIndex + 1}: ${current.passport.name} decision incorrect — ${reason}`);
        }

        if (els.log.children[els.log.children.length - 1]?.textContent?.includes("No activity yet")) {
          els.log.lastElementChild.remove();
        }

        if (state.strikes >= MAX_STRIKES) {
          endShift("strikes");
          return;
        }

        state.caseIndex += 1;
        if (state.caseIndex >= state.queue.length) {
          endShift("queue");
          return;
        }
        updateHUD();
        renderCase();
      }

      function skipCase() {
        if (!state.playing) return;
        const current = state.queue[state.caseIndex];
        if (!current) return;
        logEvent(`↷ Case ${state.caseIndex + 1} skipped. Penalty applied.`);
        state.score = Math.max(0, state.score - 50);
        state.casesReviewed += 1;
        if (els.log.children[els.log.children.length - 1]?.textContent?.includes("No activity yet")) {
          els.log.lastElementChild.remove();
        }
        state.caseIndex += 1;
        if (state.caseIndex >= state.queue.length) {
          endShift("queue");
          return;
        }
        setStatus("Case skipped. Watch your backlog.");
        updateHUD();
        renderCase();
      }

      function startShift() {
        state.playing = true;
        state.queue = buildQueue();
        state.caseIndex = 0;
        state.score = 0;
        state.strikes = 0;
        state.casesReviewed = 0;
        state.correct = 0;
        state.timeLeft = SHIFT_DURATION;
        state.shiftEndsAt = 0;
        els.startBtn.disabled = true;
        els.resetBtn.disabled = false;
        els.skipBtn.disabled = false;
        setStatus("Shift active. Inspect every detail.");
        els.banner.textContent = "Case 1 of 12";
        logEvent("Shift opened. Scanners calibrated.");
        renderCase();
        updateHUD();
        cancelAnimationFrame(rafId);
        rafId = requestAnimationFrame(shiftLoop);
      }

      function endShift(reason) {
        state.playing = false;
        cancelAnimationFrame(rafId);
        els.startBtn.disabled = false;
        els.resetBtn.disabled = false;
        els.acceptBtn.disabled = true;
        els.denyBtn.disabled = true;
        els.skipBtn.disabled = true;
        const finalScore = state.score;
        let message = "";
        if (reason === "time") {
          message = `Shift time elapsed. Final score ${finalScore}.`;
        } else if (reason === "strikes") {
          message = `Three strikes recorded. Final score ${finalScore}.`;
        } else if (reason === "focus") {
          message = `Focus lost. Console paused at ${finalScore}.`;
        } else {
          message = `Queue clear. Final score ${finalScore}.`;
        }
        setStatus(`${message} Reset the desk or start another shift.`);
        logEvent(`Shift closed (${reason}). Score: ${finalScore}. Accuracy: ${els.accuracy.textContent}.`);
        if (finalScore > state.highScore) {
          state.highScore = finalScore;
          logEvent(`New personal best logged: ${finalScore} pts.`);
        }
        renderCase();
        updateHUD();
      }

      function hardReset() {
        cancelAnimationFrame(rafId);
        Object.assign(state, {
          playing: false,
          queue: [],
          caseIndex: 0,
          score: 0,
          strikes: 0,
          casesReviewed: 0,
          correct: 0,
          timeLeft: SHIFT_DURATION,
          shiftEndsAt: 0,
        });
        els.startBtn.disabled = false;
        els.resetBtn.disabled = true;
        els.acceptBtn.disabled = true;
        els.denyBtn.disabled = true;
        els.skipBtn.disabled = true;
        els.banner.textContent = "Desk idle. Ready for new cases.";
        setStatus("Checkpoint idle. Spin up the scanners when you're ready.");
        logEvent("Desk reset. Queue cleared.");
        renderCase();
        updateHUD();
      }

      function applyPremiumMods(event) {
        event.preventDefault();
        if (!state.premium) {
          setStatus("Premium unlock required for Intel Mode and theming.");
          return;
        }
        const desk = els.deskColor.value;
        const accent = els.accentColor.value;
        document.documentElement.style.setProperty("--desk-surface", desk);
        document.documentElement.style.setProperty("--accent", accent);
        document.documentElement.style.setProperty("--accent-soft", hexToRgba(accent, 0.18));
        setStatus("Premium layout applied. Stay sharp, Inspector.");
        logEvent(`Desk recolored to ${desk}, accent ${accent}.`);
        updateIntel();
      }

      function hexToRgba(hex, alpha = 0.55) {
        let normalized = hex.trim();
        if (normalized.startsWith("#")) {
          normalized = normalized.slice(1);
        }
        if (normalized.length === 3) {
          normalized = normalized
            .split("")
            .map((char) => char + char)
            .join("");
        }
        const bigint = parseInt(normalized, 16);
        const r = (bigint >> 16) & 255;
        const g = (bigint >> 8) & 255;
        const b = bigint & 255;
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      }

      function toggleIntelMode(event) {
        if (!state.premium) {
          event.target.checked = false;
          setStatus("Premium unlock required for Intel Mode.");
          return;
        }
        state.intelMode = event.target.checked;
        setStatus(state.intelMode ? "Intel Mode engaged. Violations will be highlighted." : "Intel Mode disabled.");
        logEvent(state.intelMode ? "Intel Mode activated." : "Intel Mode deactivated.");
        updateIntel();
      }

      async function initAuth() {
        try {
          await supabaseSession();
        } catch (error) {
          console.error(error);
          setStatus("Auth hiccup — refresh if passport data fails to load.");
        }
        try {
          state.premium = await isUserPremium();
        } catch (error) {
          console.error("Premium check failed", error);
          state.premium = false;
        }
        if (state.premium) {
          els.premiumSection.classList.remove("hidden");
          els.upgradeSection.classList.add("hidden");
          setStatus("Premium systems are online. Customize your desk and engage Intel Mode.");
        } else {
          els.premiumSection.classList.add("hidden");
          els.upgradeSection.classList.remove("hidden");
        }
      }

      els.startBtn.addEventListener("click", startShift);
      els.resetBtn.addEventListener("click", hardReset);
      els.skipBtn.addEventListener("click", skipCase);
      els.acceptBtn.addEventListener("click", () => handleDecision("accept"));
      els.denyBtn.addEventListener("click", () => handleDecision("deny"));
      els.premiumForm.addEventListener("submit", applyPremiumMods);
      els.intelMode.addEventListener("change", toggleIntelMode);

      window.addEventListener("blur", () => {
        if (state.playing) {
          endShift("focus");
          logEvent("Shift auto-paused because window lost focus.");
        }
      });

      initAuth();
      renderCase();
      updateHUD();
    </script>
  </body>
</html>
