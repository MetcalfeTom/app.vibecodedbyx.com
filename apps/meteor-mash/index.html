<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Meteor Mash — Orbit Gate Inspector</title>
    <meta name="description" content="Review off-world passports, spot forged credentials, and decide who gets clearance into the Orbital Sanctuary.">
    <meta property="og:title" content="Meteor Mash — Orbit Gate Inspector">
    <meta property="og:description" content="Can you keep the Orbital Sanctuary secure? Inspect passports, catch forged docs, and make the right call under pressure.">
    <meta property="og:type" content="website">
    <meta property="og:image" content="./og-image.svg">
    <meta property="og:url" content="https://app.vibecodedbyx.com/meteor-mash/">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Meteor Mash — Orbit Gate Inspector">
    <meta name="twitter:description" content="Keep the border secure by spotting forgeries and expired visas in this fast-paced checkpoint challenge.">
    <meta name="twitter:image" content="./og-image.svg">
    <link rel="icon" href="./favicon.svg" type="image/svg+xml">
    <meta name="theme-color" content="#071431">
    <style>
      :root {
        color-scheme: dark;
        font-family: "Space Grotesk", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        --bg: radial-gradient(circle at top, rgba(74, 124, 255, 0.12), transparent 62%),
          radial-gradient(circle at bottom, rgba(255, 112, 173, 0.16), transparent 62%),
          #040712;
        --desk-surface: #111b3b;
        --card-surface: rgba(19, 29, 58, 0.92);
        --panel-surface: rgba(9, 15, 35, 0.86);
        --accent: #5bd7ff;
        --accent-soft: rgba(91, 215, 255, 0.16);
        --success: #79fcd0;
        --danger: #ff7d95;
        --warning: #ffd166;
        --text-primary: #f6f7ff;
        --text-muted: rgba(244, 247, 255, 0.66);
        --border: rgba(255, 255, 255, 0.08);
        --photo-fallback: linear-gradient(135deg, rgba(91, 215, 255, 0.35), rgba(168, 122, 255, 0.55));
      }
      *, *::before, *::after {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        min-height: 100vh;
        background: var(--bg);
        color: var(--text-primary);
        display: flex;
        justify-content: center;
        align-items: stretch;
        padding: clamp(16px, 4vw, 40px);
      }
      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), transparent 65%);
        pointer-events: none;
      }
      .app {
        width: min(1120px, 100%);
        display: grid;
        gap: clamp(16px, 3vw, 28px);
      }
      header {
        display: grid;
        gap: 12px;
        text-align: center;
      }
      header h1 {
        margin: 0;
        font-size: clamp(2.2rem, 6vw, 3.4rem);
        letter-spacing: 0.03em;
      }
      header p.lead {
        margin: 0 auto;
        max-width: 640px;
        color: var(--text-muted);
        line-height: 1.6;
      }
      .backlink {
        color: rgba(255, 255, 255, 0.82);
        text-decoration: none;
        font-size: 0.95rem;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        justify-self: center;
        border-radius: 999px;
        padding: 6px 14px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.12);
        transition: background 0.2s ease, transform 0.2s ease, border-color 0.2s ease;
      }
      .backlink:hover,
      .backlink:focus-visible {
        background: rgba(255, 255, 255, 0.18);
        border-color: rgba(255, 255, 255, 0.24);
        transform: translateY(-1px);
        outline: none;
      }
      main {
        display: grid;
        gap: clamp(18px, 3vw, 28px);
      }
      .hud {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 14px;
      }
      .stat {
        background: var(--panel-surface);
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 14px 16px;
        display: grid;
        gap: 4px;
      }
      .stat .label {
        text-transform: uppercase;
        letter-spacing: 0.14em;
        font-size: 0.68rem;
        color: var(--text-muted);
      }
      .stat .value {
        font-size: 1.6rem;
        font-weight: 600;
      }
      .stat .value.small {
        font-size: 1.1rem;
      }
      .controls {
        display: flex;
        justify-content: center;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
      }
      .btn {
        background: linear-gradient(135deg, rgba(91, 215, 255, 0.9), rgba(103, 123, 255, 0.9));
        color: #0b132b;
        border: none;
        border-radius: 12px;
        padding: 12px 22px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease, filter 0.15s ease;
      }
      .btn.secondary {
        background: rgba(255, 255, 255, 0.08);
        color: var(--text-primary);
        border: 1px solid rgba(255, 255, 255, 0.14);
      }
      .btn.danger {
        background: linear-gradient(135deg, rgba(255, 125, 149, 0.94), rgba(255, 169, 132, 0.88));
        color: #25060f;
      }
      .btn[disabled] {
        cursor: not-allowed;
        opacity: 0.6;
        filter: grayscale(0.35);
      }
      .btn:not([disabled]):hover,
      .btn:not([disabled]):focus-visible {
        transform: translateY(-1px);
        box-shadow: 0 12px 24px rgba(87, 128, 255, 0.25);
        outline: none;
      }
      .status-line {
        text-align: center;
        color: var(--text-muted);
        margin: 6px 0 0;
      }
      .checkpoint {
        display: grid;
        grid-template-columns: minmax(0, 1.05fr) minmax(0, 0.85fr);
        gap: clamp(18px, 3vw, 28px);
        align-items: start;
      }
      .passport-wrapper {
        display: grid;
        gap: 16px;
        background: var(--desk-surface);
        border-radius: 26px;
        padding: clamp(18px, 3vw, 26px);
        border: 1px solid var(--border);
        box-shadow: inset 0 0 24px rgba(0, 0, 0, 0.45);
      }
      .case-banner {
        font-size: 1.1rem;
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--text-muted);
      }
      .passport-card {
        background: var(--card-surface);
        border-radius: 22px;
        padding: 18px 20px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        display: grid;
        gap: 16px;
        position: relative;
        overflow: hidden;
      }
      .passport-card::after {
        content: "";
        position: absolute;
        inset: -20% -40% auto;
        height: 45%;
        background: linear-gradient(120deg, rgba(255, 255, 255, 0.05), transparent 65%);
        pointer-events: none;
      }
      .passport-header {
        display: flex;
        gap: 16px;
        align-items: center;
      }
      .portrait {
        width: 86px;
        height: 86px;
        border-radius: 22px;
        background: var(--photo-fallback);
        display: grid;
        place-items: center;
        font-size: 2.4rem;
        font-weight: 600;
        color: rgba(13, 18, 40, 0.86);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: inset 0 0 18px rgba(0, 0, 0, 0.4);
      }
      .passport-header h2 {
        margin: 0;
        font-size: 1.6rem;
      }
      .passport-header p {
        margin: 2px 0 0;
        color: var(--text-muted);
      }
      dl.fields {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 12px 18px;
        margin: 0;
      }
      dl.fields dt {
        font-size: 0.72rem;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        color: var(--text-muted);
      }
      dl.fields dd {
        margin: 4px 0 0;
        font-size: 1.05rem;
        font-weight: 600;
      }
      .document-note {
        font-size: 0.95rem;
        color: var(--text-muted);
        line-height: 1.5;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 16px;
        padding: 12px 14px;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .decision-buttons {
        display: flex;
        gap: 12px;
        justify-content: center;
      }
      .intel-panel {
        display: grid;
        gap: 18px;
        background: var(--panel-surface);
        border-radius: 26px;
        padding: clamp(18px, 3vw, 26px);
        border: 1px solid var(--border);
      }
      .intel-panel h2 {
        margin: 0;
        font-size: 1.3rem;
      }
      .rules-list {
        margin: 0;
        padding: 0 0 0 18px;
        line-height: 1.6;
        color: var(--text-muted);
      }
      .intel-readout {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 14px 16px;
        display: grid;
        gap: 8px;
      }
      .intel-readout h3,
      .shift-notes h3,
      .log-card h3,
      .documents-card h3 {
        margin: 0;
        font-size: 1.1rem;
      }
      .intel-output {
        color: var(--text-muted);
        font-size: 0.95rem;
        line-height: 1.5;
      }
      .log-area {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: clamp(16px, 3vw, 24px);
      }
      .log-card,
      .documents-card {
        background: var(--panel-surface);
        border: 1px solid var(--border);
        border-radius: 24px;
        padding: clamp(18px, 3vw, 24px);
        display: grid;
        gap: 14px;
      }
      .log-stream {
        display: grid;
        gap: 8px;
        max-height: 220px;
        overflow-y: auto;
        font-size: 0.95rem;
      }
      .log-stream span {
        padding: 10px 12px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: rgba(244, 247, 255, 0.85);
      }
      dl.manifest {
        margin: 0;
        display: grid;
        gap: 12px;
      }
      dl.manifest dt {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.18em;
        color: var(--text-muted);
      }
      dl.manifest dd {
        margin: 4px 0 0;
        font-size: 1.05rem;
        font-weight: 600;
      }
      .story-snippet {
        font-size: 0.95rem;
        color: var(--text-muted);
        line-height: 1.5;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 16px;
        padding: 12px 14px;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .premium-card,
      .upgrade-card {
        background: var(--panel-surface);
        border: 1px solid var(--border);
        border-radius: 24px;
        padding: clamp(18px, 3vw, 26px);
        display: grid;
        gap: 14px;
      }
      .premium-card form {
        display: grid;
        gap: 12px 16px;
      }
      .picker-row {
        display: grid;
        gap: 10px;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }
      label span {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.18em;
        color: var(--text-muted);
        display: block;
        margin-bottom: 6px;
      }
      input[type="color"] {
        width: 100%;
        height: 44px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        border-radius: 14px;
        background: transparent;
        cursor: pointer;
      }
      .toggle {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        font-size: 0.95rem;
        color: var(--text-muted);
      }
      .toggle input {
        width: 18px;
        height: 18px;
      }
      footer {
        text-align: center;
        color: var(--text-muted);
        font-size: 0.9rem;
      }
      .hidden {
        display: none !important;
      }
      @media (max-width: 1024px) {
        .checkpoint {
          grid-template-columns: 1fr;
        }
      }
      @media (max-width: 640px) {
        body {
          padding: 14px;
        }
        .passport-header {
          flex-direction: column;
          align-items: flex-start;
        }
        .decision-buttons {
          flex-direction: column;
        }
        .btn {
          width: 100%;
        }
        .log-area {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header>
        <h1>Meteor Mash: Orbit Gate Inspector</h1>
        <p class="lead">
          Welcome to Checkpoint Helios. Review each traveler's passport, cross-check their story,
          and decide whether they can enter the Orbital Sanctuary. Three mistakes and Command pulls your badge.
        </p>
        <a class="backlink" href="https://www.vibecodedbyx.com" target="_blank" rel="noreferrer noopener">⬅ Back to the livestream</a>
      </header>

      <main>
        <section class="hud">
          <div class="stat">
            <span class="label">Score</span>
            <span class="value" id="score-value">0</span>
          </div>
          <div class="stat">
            <span class="label">Cases</span>
            <span class="value" id="cases-value">0 / 12</span>
          </div>
          <div class="stat">
            <span class="label">Accuracy</span>
            <span class="value small" id="accuracy-value">—</span>
          </div>
          <div class="stat">
            <span class="label">Strikes Left</span>
            <span class="value small" id="strikes-value">3</span>
          </div>
          <div class="stat">
            <span class="label">Shift Timer</span>
            <span class="value small" id="timer-value">90.0s</span>
          </div>
        </section>

        <div class="controls">
          <button class="btn" id="start-btn" type="button">Start shift</button>
          <button class="btn secondary" id="reset-btn" type="button" disabled>Reset desk</button>
          <button class="btn secondary" id="skip-btn" type="button" disabled>Skip case</button>
        </div>
        <p class="status-line" id="status-message">Checkpoint idle. Spin up the scanners when you're ready.</p>

        <section class="checkpoint">
          <div class="passport-wrapper">
            <div class="case-banner" id="banner">Awaiting assignment…</div>
            <div class="passport-card" aria-live="polite">
              <div class="passport-header">
                <div class="portrait" id="traveler-photo">?</div>
                <div>
                  <h2 id="traveler-name">No file loaded</h2>
                  <p id="traveler-home">—</p>
                </div>
              </div>
              <dl class="fields">
                <div>
                  <dt>Document ID</dt>
                  <dd id="passport-id">----</dd>
                </div>
                <div>
                  <dt>Expiry</dt>
                  <dd id="expiry-date">----</dd>
                </div>
                <div>
                  <dt>Clearance</dt>
                  <dd id="clearance-level">----</dd>
                </div>
                <div>
                  <dt>Visa Type</dt>
                  <dd id="visa-type">----</dd>
                </div>
                <div>
                  <dt>Entry Stamp</dt>
                  <dd id="entry-stamp">----</dd>
                </div>
                <div>
                  <dt>Reason</dt>
                  <dd id="reason-detail">----</dd>
                </div>
              </dl>
              <div class="document-note" id="document-note">Desk notes will appear here once a case is active.</div>
            </div>
            <div class="decision-buttons">
              <button class="btn" id="accept-btn" type="button" disabled>Admit traveler</button>
              <button class="btn danger" id="deny-btn" type="button" disabled>Reject traveler</button>
            </div>
          </div>

          <aside class="intel-panel">
            <h2>Entry Briefing</h2>
            <ol class="rules-list" id="rules-list">
              <li>Passport expiry must be on or after <strong>2247-07-18</strong>.</li>
              <li>Only <strong>AURORA</strong> entry stamps are honored at Helios Gate.</li>
              <li>Workers need <strong>Clearance Level 2+</strong>. Visitors from the Quake Belt need Level 3.</li>
              <li>Any active warrants or missing cargo manifests mean instant denial.</li>
            </ol>
            <div class="intel-readout">
              <h3>Desk Intel</h3>
              <div class="intel-output" id="intel-output">Enable Intel Mode (premium) to receive automated cross-checks.</div>
            </div>
            <div class="shift-notes">
              <h3>Shift Notes</h3>
              <p class="status-line">
                Process 12 cases before the timer hits zero. Three wrong calls and Command shutters the lane.
              </p>
            </div>
          </aside>
        </section>

        <section class="log-area">
          <div class="log-card">
            <h3>Border Log</h3>
            <div class="log-stream" id="log">
              <span>No activity yet. Your decisions will be logged here.</span>
            </div>
          </div>
          <div class="documents-card">
            <h3>Supplemental Docs</h3>
            <dl class="manifest">
              <div>
                <dt>Declared Goods</dt>
                <dd id="cargo-detail">----</dd>
              </div>
              <div>
                <dt>Manifest Status</dt>
                <dd id="manifest-status">----</dd>
              </div>
              <div>
                <dt>Additional Notes</dt>
                <dd id="additional-notes">----</dd>
              </div>
            </dl>
            <div class="story-snippet" id="story-snippet">Travelers' stories and inconsistencies will appear here.</div>
          </div>
        </section>

        <section class="premium-card hidden" id="premium-content">
          <h2>Premium Deck — Customize Your Checkpoint</h2>
          <p class="status-line">Tailor your desk lighting and deploy Intel Mode for automatic cross-check highlights.</p>
          <form id="premium-form">
            <div class="picker-row">
              <label>
                <span>Desk surface</span>
                <input type="color" id="desk-color" name="desk" value="#111b3b">
              </label>
              <label>
                <span>Accent glow</span>
                <input type="color" id="accent-color" name="accent" value="#5bd7ff">
              </label>
            </div>
            <label class="toggle">
              <input type="checkbox" id="intel-mode">
              Enable Intel Mode (auto-identify likely violations)
            </label>
            <button class="btn" type="submit">Apply premium layout</button>
          </form>
        </section>

        <section class="upgrade-card" id="upgrade-button">
          <h2>Upgrade to premium for Intel Mode</h2>
          <p class="status-line">Subscribers unlock desk theming and AI-assisted violation hints.</p>
        </section>
      </main>

      <footer>
        Built live on stream — share your best acceptance streak and tag @VibeCodedByX 👮‍♂️🛂
      </footer>
    </div>

    <script type="module">
      import { supabaseSession, isUserPremium } from "../../supabase-config.js";

      const SHIFT_DURATION = 90_000;
      const CASES_PER_SHIFT = 12;
      const SHIFT_DATE = new Date("2247-07-18");
      const MAX_STRIKES = 3;
      const RULE_MANIFEST = [
        {
          id: "expiry",
          label: "Expired passport",
          test: (p) => new Date(p.expiry) >= SHIFT_DATE,
          hint: (p) => `Document expired on ${p.expiry}.`,
        },
        {
          id: "stamp",
          label: "Invalid entry stamp",
          test: (p) => p.entryStamp === "AURORA",
          hint: (p) => `Stamp shows ${p.entryStamp}, not AURORA.`,
        },
        {
          id: "clearance",
          label: "Insufficient clearance",
          test: (p) => {
            if (p.reason === "Work" && p.clearance < 2) return false;
            if (p.homeworld === "Quake Belt" && p.clearance < 3) return false;
            return true;
          },
          hint: (p) => `Clearance ${p.clearance} fails requirements for ${p.reason === "Work" ? "work" : p.homeworld}.`,
        },
        {
          id: "warrant",
          label: "Active warrant",
          test: (p) => !p.hasWarrant,
          hint: () => "Active warrant pinged in the system.",
        },
        {
          id: "manifest",
          label: "Missing manifest",
          test: (p) => p.manifestStatus === "Filed",
          hint: () => "Cargo manifest missing or incomplete.",
        },
      ];

      const NAMES = [
        "Astra Kepler",
        "Milo Andara",
        "Ren Vega",
        "Nyra Sol",
        "Cassian Holt",
        "Eli Orrin",
        "Juno Farrow",
        "Lira Mendez",
        "Pax Karo",
        "Zadie Quill",
        "Thorne Vale",
        "Mara Lune",
        "Orry Talus",
        "Ila Storm",
      ];
      const HOMEWORLDS = [
        "Helios Prime",
        "Quake Belt",
        "Lumen Station",
        "Ceto Colony",
        "Orion Drift",
        "Rhea Outpost",
        "Vale Sprawl",
        "Icarus Fringe",
      ];
      const VISA_TYPES = ["Transit", "Work", "Research", "Diplomatic", "Visit"];
      const STAMP_CODES = ["AURORA", "TIDE", "NOVA", "VOID"];
      const CARGO_OPTIONS = ["Medical supplies", "Holo art crates", "Grain capsules", "Starforge tools", "Personal effects", "No declared cargo"];
      const NOTES_BANK = [
        "Mentioned a sister already inside the Sanctuary.",
        "Arrived with an escort drone still cooling outside.",
        "Sweating despite the checkpoint chill.",
        "Claims to have lost clearance badge last cycle.",
        "Presents a handwritten note from Embassy liaison.",
        "Insists on catching the next lift to the upper promenade.",
      ];
      const STORIES = [
        "Requesting re-entry after a two-cycle survey mission.",
        "Says the Quake Belt aftershocks wiped their archives.",
        "Insists the work contract starts in under an hour.",
        "Bringing rare seeds for the Sanctuary gardens.",
        "Escaping a dust storm that breached dome seals.",
        "Touring the orbital museum before heading coreward.",
      ];

      const els = {
        startBtn: document.getElementById("start-btn"),
        resetBtn: document.getElementById("reset-btn"),
        skipBtn: document.getElementById("skip-btn"),
        acceptBtn: document.getElementById("accept-btn"),
        denyBtn: document.getElementById("deny-btn"),
        score: document.getElementById("score-value"),
        cases: document.getElementById("cases-value"),
        accuracy: document.getElementById("accuracy-value"),
        strikes: document.getElementById("strikes-value"),
        timer: document.getElementById("timer-value"),
        banner: document.getElementById("banner"),
        status: document.getElementById("status-message"),
        log: document.getElementById("log"),
        travelerPhoto: document.getElementById("traveler-photo"),
        travelerName: document.getElementById("traveler-name"),
        travelerHome: document.getElementById("traveler-home"),
        passportId: document.getElementById("passport-id"),
        expiryDate: document.getElementById("expiry-date"),
        clearance: document.getElementById("clearance-level"),
        visa: document.getElementById("visa-type"),
        stamp: document.getElementById("entry-stamp"),
        reason: document.getElementById("reason-detail"),
        note: document.getElementById("document-note"),
        cargo: document.getElementById("cargo-detail"),
        manifestStatus: document.getElementById("manifest-status"),
        additional: document.getElementById("additional-notes"),
        story: document.getElementById("story-snippet"),
        intelOutput: document.getElementById("intel-output"),
        premiumSection: document.getElementById("premium-content"),
        upgradeSection: document.getElementById("upgrade-button"),
        premiumForm: document.getElementById("premium-form"),
        deskColor: document.getElementById("desk-color"),
        accentColor: document.getElementById("accent-color"),
        intelMode: document.getElementById("intel-mode"),
      };

      const state = {
        playing: false,
        queue: [],
        caseIndex: 0,
        score: 0,
        strikes: 0,
        casesReviewed: 0,
        correct: 0,
        timeLeft: SHIFT_DURATION,
        shiftEndsAt: 0,
        highScore: 0,
        premium: false,
        intelMode: false,
      };

      let rafId = null;

      function setStatus(text) {
        els.status.textContent = text;
      }

      function logEvent(text) {
        const now = new Date();
        const stamp = now.toLocaleTimeString([], { hour: "numeric", minute: "2-digit", second: "2-digit" });
        const entry = document.createElement("span");
        entry.textContent = `[${stamp}] ${text}`;
        els.log.prepend(entry);
        while (els.log.children.length > 25) {
          els.log.lastElementChild.remove();
        }
      }

      function randomItem(list) {
        return list[Math.floor(Math.random() * list.length)];
      }

      function pad(num, size = 3) {
        return num.toString().padStart(size, "0");
      }

      function createDocumentId() {
        return `HX-${pad(Math.floor(Math.random() * 999))}-${pad(Math.floor(Math.random() * 999))}`;
      }

      function randomFutureDate() {
        const start = new Date("2247-07-01").getTime();
        const end = new Date("2248-06-30").getTime();
        const time = start + Math.random() * (end - start);
        return new Date(time);
      }

      function randomPastDate() {
        const start = new Date("2246-01-01").getTime();
        const end = new Date("2247-06-01").getTime();
        const time = start + Math.random() * (end - start);
        return new Date(time);
      }

      function formatDate(date) {
        return date.toISOString().slice(0, 10);
      }

      function evaluatePassport(passport) {
        const failures = RULE_MANIFEST.filter((rule) => !rule.test(passport)).map((rule) => rule.hint(passport));
        return {
          valid: failures.length === 0,
          failures,
        };
      }

      function maybeCorrupt(passport) {
        const tweaks = [
          () => (passport.expiry = formatDate(randomPastDate())),
          () => (passport.entryStamp = randomItem(STAMP_CODES.filter((code) => code !== "AURORA"))),
          () => {
            if (passport.reason === "Work") {
              passport.clearance = 1;
            } else {
              passport.reason = "Work";
              passport.clearance = 1;
            }
          },
          () => {
            passport.homeworld = "Quake Belt";
            passport.clearance = 1;
          },
          () => {
            passport.hasWarrant = true;
          },
          () => {
            passport.manifestStatus = "Missing";
          },
        ];
        randomItem(tweaks)();
      }

      function createCase(index) {
        const passport = {
          name: randomItem(NAMES),
          homeworld: randomItem(HOMEWORLDS),
          documentId: createDocumentId(),
          expiry: formatDate(randomFutureDate()),
          clearance: Math.ceil(Math.random() * 3),
          visa: randomItem(VISA_TYPES),
          entryStamp: Math.random() < 0.78 ? "AURORA" : randomItem(STAMP_CODES),
          reason: randomItem(["Work", "Visit", "Transit", "Research"]),
          cargo: randomItem(CARGO_OPTIONS),
          manifestStatus: Math.random() < 0.85 ? "Filed" : "Missing",
          additionalNotes: randomItem(NOTES_BANK),
          story: randomItem(STORIES),
          hasWarrant: Math.random() < 0.08,
        };

        let evaluation = evaluatePassport(passport);
        if (evaluation.valid && Math.random() < 0.45) {
          maybeCorrupt(passport);
          evaluation = evaluatePassport(passport);
        }
        if (!evaluation.valid && Math.random() < 0.2) {
          passport.manifestStatus = "Filed";
          evaluation = evaluatePassport(passport);
        }

        return {
          id: `case-${Date.now()}-${index}-${Math.floor(Math.random() * 9999)}`,
          passport,
          evaluation,
        };
      }

      function buildQueue() {
        return Array.from({ length: CASES_PER_SHIFT }, (_, idx) => createCase(idx));
      }

      function updateHUD() {
        els.score.textContent = state.score.toString();
        const total = state.queue.length || CASES_PER_SHIFT;
        els.cases.textContent = `${state.casesReviewed} / ${total}`;
        const accuracy = state.casesReviewed > 0 ? Math.round((state.correct / state.casesReviewed) * 100) : null;
        els.accuracy.textContent = accuracy !== null ? `${accuracy}%` : "—";
        const strikesLeft = Math.max(0, MAX_STRIKES - state.strikes);
        els.strikes.textContent = strikesLeft.toString();
        els.timer.textContent = `${(state.timeLeft / 1000).toFixed(1)}s`;
      }

      function applyPhotoStyling(name) {
        const palette = ["#58d5ff", "#ff6d8c", "#9e7bff", "#5ff2c6", "#ffdf6d"];
        const color = palette[name.charCodeAt(0) % palette.length];
        els.travelerPhoto.style.background = `linear-gradient(135deg, ${color}, rgba(255, 255, 255, 0.4))`;
        els.travelerPhoto.textContent = name
          .split(" ")
          .map((part) => part[0])
          .join("")
          .slice(0, 2)
          .toUpperCase();
      }

      function renderCase() {
        const current = state.queue[state.caseIndex];
        if (!current) {
          els.banner.textContent = "Awaiting assignment…";
          els.travelerName.textContent = "No file loaded";
          els.travelerHome.textContent = "—";
          els.passportId.textContent = "----";
          els.expiryDate.textContent = "----";
          els.clearance.textContent = "----";
          els.visa.textContent = "----";
          els.stamp.textContent = "----";
          els.reason.textContent = "----";
          els.note.textContent = "Desk notes will appear here once a case is active.";
          els.cargo.textContent = "----";
          els.manifestStatus.textContent = "----";
          els.additional.textContent = "----";
          els.story.textContent = "Travelers' stories and inconsistencies will appear here.";
          els.travelerPhoto.style.background = "var(--photo-fallback)";
          els.travelerPhoto.textContent = "?";
          els.acceptBtn.disabled = true;
          els.denyBtn.disabled = true;
          els.skipBtn.disabled = true;
          updateIntel();
          return;
        }

        const { passport } = current;
        els.banner.textContent = `Case ${state.caseIndex + 1} of ${state.queue.length}`;
        els.travelerName.textContent = passport.name;
        els.travelerHome.textContent = `${passport.homeworld} — ${passport.reason} entry`;
        els.passportId.textContent = passport.documentId;
        els.expiryDate.textContent = passport.expiry;
        els.clearance.textContent = `Level ${passport.clearance}`;
        els.visa.textContent = passport.visa;
        els.stamp.textContent = passport.entryStamp;
        els.reason.textContent = passport.reason;
        els.note.textContent = passport.additionalNotes;
        els.cargo.textContent = passport.cargo;
        els.manifestStatus.textContent = passport.manifestStatus;
        els.additional.textContent = passport.hasWarrant ? "Active warrant flagged." : "No warrants detected.";
        els.story.textContent = passport.story;
        applyPhotoStyling(passport.name);

        const buttonsDisabled = !state.playing;
        els.acceptBtn.disabled = buttonsDisabled;
        els.denyBtn.disabled = buttonsDisabled;
        els.skipBtn.disabled = buttonsDisabled;
        updateIntel();
      }

      function updateIntel() {
        const current = state.queue[state.caseIndex];
        if (!current) {
          els.intelOutput.textContent = state.premium && state.intelMode
            ? "Intel Mode ready. Start a shift to receive automated checks."
            : "Enable Intel Mode (premium) to receive automated cross-checks.";
          return;
        }
        if (!state.premium || !state.intelMode) {
          els.intelOutput.textContent = "Manual inspection only. Premium Intel Mode reveals likely violations.";
          return;
        }
        if (current.evaluation.failures.length === 0) {
          els.intelOutput.textContent = "No discrepancies detected. All rules satisfied.";
        } else {
          els.intelOutput.innerHTML = current.evaluation.failures
            .map((issue) => `<div>⚠️ ${issue}</div>`)
            .join("");
        }
      }

      function shiftLoop(timestamp) {
        if (!state.playing) {
          return;
        }
        if (!state.shiftEndsAt) {
          state.shiftEndsAt = timestamp + SHIFT_DURATION;
        }
        state.timeLeft = Math.max(0, state.shiftEndsAt - timestamp);
        updateHUD();
        if (state.timeLeft <= 0) {
          endShift("time");
          return;
        }
        rafId = requestAnimationFrame(shiftLoop);
      }

      function adjustScore(correct, evaluation) {
        if (correct) {
          const bonus = Math.max(1, evaluation.failures.length);
          state.score += 120 + bonus * 20;
        } else {
          state.score = Math.max(0, state.score - 80);
        }
      }

      function handleDecision(decision) {
        if (!state.playing) return;
        const current = state.queue[state.caseIndex];
        if (!current) return;

        const shouldAdmit = current.evaluation.valid;
        const correct = (decision === "accept" && shouldAdmit) || (decision === "deny" && !shouldAdmit);
        adjustScore(correct, current.evaluation);
        state.casesReviewed += 1;
        if (correct) {
          state.correct += 1;
          setStatus("Good call. Keep the line moving.");
          logEvent(`✔️ Case ${state.caseIndex + 1}: ${current.passport.name} decision correct.`);
        } else {
          state.strikes += 1;
          const reason = current.evaluation.failures[0] || "Unnecessary denial.";
          setStatus(`Strike logged: ${reason}`);
          logEvent(`✖️ Case ${state.caseIndex + 1}: ${current.passport.name} decision incorrect — ${reason}`);
        }

        if (els.log.children[els.log.children.length - 1]?.textContent?.includes("No activity yet")) {
          els.log.lastElementChild.remove();
        }

        if (state.strikes >= MAX_STRIKES) {
          endShift("strikes");
          return;
        }

        state.caseIndex += 1;
        if (state.caseIndex >= state.queue.length) {
          endShift("queue");
          return;
        }
        updateHUD();
        renderCase();
      }

      function skipCase() {
        if (!state.playing) return;
        const current = state.queue[state.caseIndex];
        if (!current) return;
        logEvent(`↷ Case ${state.caseIndex + 1} skipped. Penalty applied.`);
        state.score = Math.max(0, state.score - 50);
        state.casesReviewed += 1;
        if (els.log.children[els.log.children.length - 1]?.textContent?.includes("No activity yet")) {
          els.log.lastElementChild.remove();
        }
        state.caseIndex += 1;
        if (state.caseIndex >= state.queue.length) {
          endShift("queue");
          return;
        }
        setStatus("Case skipped. Watch your backlog.");
        updateHUD();
        renderCase();
      }

      function startShift() {
        state.playing = true;
        state.queue = buildQueue();
        state.caseIndex = 0;
        state.score = 0;
        state.strikes = 0;
        state.casesReviewed = 0;
        state.correct = 0;
        state.timeLeft = SHIFT_DURATION;
        state.shiftEndsAt = 0;
        els.startBtn.disabled = true;
        els.resetBtn.disabled = false;
        els.skipBtn.disabled = false;
        setStatus("Shift active. Inspect every detail.");
        els.banner.textContent = "Case 1 of 12";
        logEvent("Shift opened. Scanners calibrated.");
        renderCase();
        updateHUD();
        cancelAnimationFrame(rafId);
        rafId = requestAnimationFrame(shiftLoop);
      }

      function endShift(reason) {
        state.playing = false;
        cancelAnimationFrame(rafId);
        els.startBtn.disabled = false;
        els.resetBtn.disabled = false;
        els.acceptBtn.disabled = true;
        els.denyBtn.disabled = true;
        els.skipBtn.disabled = true;
        const finalScore = state.score;
        let message = "";
        if (reason === "time") {
          message = `Shift time elapsed. Final score ${finalScore}.`;
        } else if (reason === "strikes") {
          message = `Three strikes recorded. Final score ${finalScore}.`;
        } else if (reason === "focus") {
          message = `Focus lost. Console paused at ${finalScore}.`;
        } else {
          message = `Queue clear. Final score ${finalScore}.`;
        }
        setStatus(`${message} Reset the desk or start another shift.`);
        logEvent(`Shift closed (${reason}). Score: ${finalScore}. Accuracy: ${els.accuracy.textContent}.`);
        if (finalScore > state.highScore) {
          state.highScore = finalScore;
          logEvent(`New personal best logged: ${finalScore} pts.`);
        }
        renderCase();
        updateHUD();
      }

      function hardReset() {
        cancelAnimationFrame(rafId);
        Object.assign(state, {
          playing: false,
          queue: [],
          caseIndex: 0,
          score: 0,
          strikes: 0,
          casesReviewed: 0,
          correct: 0,
          timeLeft: SHIFT_DURATION,
          shiftEndsAt: 0,
        });
        els.startBtn.disabled = false;
        els.resetBtn.disabled = true;
        els.acceptBtn.disabled = true;
        els.denyBtn.disabled = true;
        els.skipBtn.disabled = true;
        els.banner.textContent = "Desk idle. Ready for new cases.";
        setStatus("Checkpoint idle. Spin up the scanners when you're ready.");
        logEvent("Desk reset. Queue cleared.");
        renderCase();
        updateHUD();
      }

      function applyPremiumMods(event) {
        event.preventDefault();
        if (!state.premium) {
          setStatus("Premium unlock required for Intel Mode and theming.");
          return;
        }
        const desk = els.deskColor.value;
        const accent = els.accentColor.value;
        document.documentElement.style.setProperty("--desk-surface", desk);
        document.documentElement.style.setProperty("--accent", accent);
        document.documentElement.style.setProperty("--accent-soft", hexToRgba(accent, 0.18));
        setStatus("Premium layout applied. Stay sharp, Inspector.");
        logEvent(`Desk recolored to ${desk}, accent ${accent}.`);
        updateIntel();
      }

      function hexToRgba(hex, alpha = 0.55) {
        let normalized = hex.trim();
        if (normalized.startsWith("#")) {
          normalized = normalized.slice(1);
        }
        if (normalized.length === 3) {
          normalized = normalized
            .split("")
            .map((char) => char + char)
            .join("");
        }
        const bigint = parseInt(normalized, 16);
        const r = (bigint >> 16) & 255;
        const g = (bigint >> 8) & 255;
        const b = bigint & 255;
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      }

      function toggleIntelMode(event) {
        if (!state.premium) {
          event.target.checked = false;
          setStatus("Premium unlock required for Intel Mode.");
          return;
        }
        state.intelMode = event.target.checked;
        setStatus(state.intelMode ? "Intel Mode engaged. Violations will be highlighted." : "Intel Mode disabled.");
        logEvent(state.intelMode ? "Intel Mode activated." : "Intel Mode deactivated.");
        updateIntel();
      }

      async function initAuth() {
        try {
          await supabaseSession();
        } catch (error) {
          console.error(error);
          setStatus("Auth hiccup — refresh if passport data fails to load.");
        }
        try {
          state.premium = await isUserPremium();
        } catch (error) {
          console.error("Premium check failed", error);
          state.premium = false;
        }
        if (state.premium) {
          els.premiumSection.classList.remove("hidden");
          els.upgradeSection.classList.add("hidden");
          setStatus("Premium systems are online. Customize your desk and engage Intel Mode.");
        } else {
          els.premiumSection.classList.add("hidden");
          els.upgradeSection.classList.remove("hidden");
        }
      }

      els.startBtn.addEventListener("click", startShift);
      els.resetBtn.addEventListener("click", hardReset);
      els.skipBtn.addEventListener("click", skipCase);
      els.acceptBtn.addEventListener("click", () => handleDecision("accept"));
      els.denyBtn.addEventListener("click", () => handleDecision("deny"));
      els.premiumForm.addEventListener("submit", applyPremiumMods);
      els.intelMode.addEventListener("change", toggleIntelMode);

      window.addEventListener("blur", () => {
        if (state.playing) {
          endShift("focus");
          logEvent("Shift auto-paused because window lost focus.");
        }
      });

      initAuth();
      renderCase();
      updateHUD();
    </script>
  </body>
</html>
