<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>SKULL ROCK BEACON - Burn the Ghost Fog</title>
  <link rel="icon" href="https://emojicdn.elk.sh/üíÄ">
  <meta property="og:title" content="SKULL ROCK BEACON - Burn the Ghost Fog">
  <meta property="og:description" content="Wield the cursed lantern to banish the spirits of Davy Jones!">
  <meta property="og:url" content="https://app.sloppy.live/lighthouse">
  <meta property="og:image" content="https://emojicdn.elk.sh/üè¥‚Äç‚ò†Ô∏è?style=apple&size=512">
  <link href="https://fonts.googleapis.com/css2?family=Pirata+One&family=IM+Fell+English+SC&display=swap" rel="stylesheet">
  <script type="module">
    import { supabaseSession } from '/supabase-config.js';
    window.supabaseSession = supabaseSession;
  </script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      min-height: 100vh;
      background: #050508;
      font-family: 'IM Fell English SC', serif;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .game-container {
      position: relative;
      width: 100vw;
      height: 100vh;
    }
    canvas { display: block; width: 100%; height: 100%; cursor: none; }
    .hud {
      position: absolute;
      top: 15px;
      left: 20px;
      right: 20px;
      display: flex;
      justify-content: space-between;
      pointer-events: none;
      z-index: 10;
    }
    .title {
      font-family: 'Pirata One', cursive;
      font-size: 1.4rem;
      color: #7cfc00;
      text-shadow: 0 0 20px #7cfc0055, 2px 2px 0 #000;
      letter-spacing: 0.1em;
    }
    .stats {
      text-align: right;
    }
    .score {
      font-size: 1rem;
      color: #7cfc00;
      text-shadow: 0 0 15px #7cfc0055;
    }
    .fog-count {
      font-size: 0.8rem;
      color: #98fb98;
      text-shadow: 0 0 10px #98fb9855;
      margin-top: 5px;
    }
    .power-bar {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 250px;
      height: 20px;
      background: rgba(0,0,0,0.6);
      border: 2px solid #7cfc00;
      border-radius: 10px;
      overflow: hidden;
    }
    .power-fill {
      height: 100%;
      background: linear-gradient(90deg, #228b22, #7cfc00);
      transition: width 0.1s;
      box-shadow: 0 0 15px #7cfc00;
    }
    .power-label {
      position: absolute;
      bottom: 45px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.7rem;
      color: #7cfc00;
      letter-spacing: 0.2em;
    }
    .overlay {
      position: absolute;
      inset: 0;
      background: rgba(5, 5, 8, 0.97);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      transition: opacity 0.5s;
    }
    .overlay.hidden { opacity: 0; pointer-events: none; }
    .overlay-title {
      font-family: 'Pirata One', cursive;
      font-size: 2.5rem;
      color: #7cfc00;
      text-shadow: 0 0 30px #7cfc00, 0 0 60px #228b22;
      margin-bottom: 15px;
    }
    .overlay-sub {
      font-size: 0.9rem;
      color: #556b2f;
      margin-bottom: 30px;
      text-align: center;
      max-width: 300px;
    }
    .btn {
      font-family: 'Pirata One', cursive;
      font-size: 1.2rem;
      padding: 15px 40px;
      background: transparent;
      border: 2px solid #7cfc00;
      color: #7cfc00;
      cursor: pointer;
      letter-spacing: 0.1em;
      transition: all 0.2s;
    }
    .btn:hover {
      background: #7cfc00;
      color: #0a0a0f;
      box-shadow: 0 0 30px #7cfc0055;
    }
    .final-score {
      font-family: 'Pirata One', cursive;
      font-size: 3rem;
      color: #7cfc00;
      text-shadow: 0 0 20px #7cfc0055;
      margin: 10px 0 5px;
    }
    .final-fog {
      font-size: 1rem;
      color: #98fb98;
      margin-bottom: 15px;
    }
    .submit-section {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    .name-input {
      font-family: 'IM Fell English SC', serif;
      font-size: 0.9rem;
      padding: 10px 15px;
      background: rgba(0,0,0,0.5);
      border: 2px solid #7cfc00;
      color: #7cfc00;
      width: 140px;
      outline: none;
    }
    .name-input::placeholder { color: #2e4a1e; }
    .btn-small {
      font-size: 1rem;
      padding: 10px 20px;
    }
    .leaderboard {
      background: rgba(0,0,0,0.4);
      border: 1px solid #7cfc00;
      padding: 10px 15px;
      margin-bottom: 15px;
      min-width: 280px;
    }
    .lb-title {
      font-family: 'Pirata One', cursive;
      font-size: 1rem;
      color: #7cfc00;
      letter-spacing: 0.15em;
      margin-bottom: 8px;
      text-align: center;
    }
    .lb-list {
      font-size: 0.75rem;
      color: #556b2f;
    }
    .lb-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid rgba(124,252,0,0.2);
    }
    .lb-row:last-child { border-bottom: none; }
    .lb-name { color: #7cfc00; }
    .lb-time { color: #98fb98; }
    .lb-fog { color: #556b2f; font-size: 0.65rem; }
    .back-link {
      position: fixed;
      bottom: 5px;
      right: 10px;
      color: #7cfc0055;
      text-decoration: none;
      font-size: 0.65rem;
    }
    .back-link:hover { color: #7cfc00; }
  </style>
</head>
<body>
  <div class="game-container">
    <canvas id="canvas"></canvas>
    <div class="hud">
      <div class="title">üíÄ SKULL ROCK BEACON</div>
      <div class="stats">
        <div class="score">HAUNTED: <span id="time">0</span>s</div>
        <div class="fog-count">SPIRITS BANISHED: <span id="fogCount">0</span></div>
      </div>
    </div>
    <div class="power-label">üî• CURSED FLAME</div>
    <div class="power-bar">
      <div class="power-fill" id="powerFill" style="width: 100%"></div>
    </div>
    <div class="overlay" id="startOverlay">
      <div class="overlay-title">üíÄ SKULL ROCK BEACON üíÄ</div>
      <div class="overlay-sub">The ghost fog rises from Davy Jones' locker! Aim yer cursed lantern to burn the spirits back to the depths!</div>
      <button class="btn" id="startBtn">LIGHT THE FLAME</button>
    </div>
    <div class="overlay hidden" id="gameOverOverlay">
      <div class="overlay-title">üëª THE FOG CLAIMS YE üëª</div>
      <div class="final-score" id="finalTime">0s</div>
      <div class="final-fog">Spirits Banished: <span id="finalFog">0</span></div>
      <div class="submit-section" id="submitSection">
        <input type="text" id="playerName" class="name-input" placeholder="Yer name" maxlength="12">
        <button class="btn btn-small" id="submitBtn">LOG SCORE</button>
      </div>
      <div class="leaderboard" id="leaderboard">
        <div class="lb-title">‚ò† BRAVEST KEEPERS ‚ò†</div>
        <div class="lb-list" id="lbList"></div>
      </div>
      <button class="btn" id="restartBtn">FACE THE FOG</button>
    </div>
  </div>
  <a href="https://sloppy.live" class="back-link">‚Üê sloppy.live</a>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let gameRunning = false;
let frameCount = 0;
let survivalTime = 0;
let flamePower = 100;
let beamAngle = 0;
let targetAngle = 0;
let mouseX = 0, mouseY = 0;
let spiritsBanished = 0;
let supabaseClient = null;
let userId = null;

const beacon = { x: 0, y: 0 };
const GHOST_FOG = [];
const FLAME_PARTICLES = [];
const SPIRITS = [];
const MAX_FOG = 40;

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  beacon.x = canvas.width / 2;
  beacon.y = canvas.height / 2 + 30;
}

function spawnGhostFog() {
  if (GHOST_FOG.length >= MAX_FOG) return;

  const angle = Math.random() * Math.PI * 2;
  const dist = Math.max(canvas.width, canvas.height) * 0.7;

  GHOST_FOG.push({
    x: beacon.x + Math.cos(angle) * dist,
    y: beacon.y + Math.sin(angle) * dist,
    size: 60 + Math.random() * 50,
    speed: 0.3 + Math.random() * 0.4 + survivalTime * 0.005,
    alpha: 0.4 + Math.random() * 0.3,
    wobble: Math.random() * Math.PI * 2,
    pulsePhase: Math.random() * Math.PI * 2,
    hasSkull: Math.random() < 0.3
  });
}

function spawnSpirit(x, y) {
  SPIRITS.push({
    x, y,
    vx: (Math.random() - 0.5) * 4,
    vy: -2 - Math.random() * 3,
    size: 15 + Math.random() * 10,
    alpha: 1,
    rotation: Math.random() * Math.PI * 2
  });
}

function spawnFlameParticle(x, y) {
  FLAME_PARTICLES.push({
    x, y,
    vx: (Math.random() - 0.5) * 3,
    vy: (Math.random() - 0.5) * 3 - 1,
    size: 3 + Math.random() * 5,
    alpha: 1,
    color: Math.random() > 0.5 ? '#7cfc00' : '#98fb98'
  });
}

function isInBeam(x, y) {
  const dx = x - beacon.x;
  const dy = y - beacon.y;
  const angle = Math.atan2(dy, dx);
  const dist = Math.sqrt(dx*dx + dy*dy);

  let angleDiff = angle - beamAngle;
  while (angleDiff > Math.PI) angleDiff -= Math.PI * 2;
  while (angleDiff < -Math.PI) angleDiff += Math.PI * 2;

  const beamWidth = 0.35;
  const beamLength = 450 * (flamePower / 100);

  return Math.abs(angleDiff) < beamWidth && dist < beamLength && dist > 70;
}

function update() {
  if (!gameRunning) return;

  frameCount++;
  if (frameCount % 60 === 0) {
    survivalTime++;
    document.getElementById('time').textContent = survivalTime;
  }

  // Spawn fog (more over time)
  const spawnRate = Math.max(4, 15 - Math.floor(survivalTime / 8));
  if (frameCount % spawnRate === 0) {
    spawnGhostFog();
  }

  // Update beam angle
  const dx = mouseX - beacon.x;
  const dy = mouseY - beacon.y;
  targetAngle = Math.atan2(dy, dx);

  let angleDiff = targetAngle - beamAngle;
  while (angleDiff > Math.PI) angleDiff -= Math.PI * 2;
  while (angleDiff < -Math.PI) angleDiff += Math.PI * 2;
  beamAngle += angleDiff * 0.08;

  // Update fog
  let fogNearBeacon = 0;
  for (let i = GHOST_FOG.length - 1; i >= 0; i--) {
    const fog = GHOST_FOG[i];

    // Drift toward beacon
    const dx = beacon.x - fog.x;
    const dy = beacon.y - fog.y;
    const dist = Math.sqrt(dx*dx + dy*dy);

    fog.wobble += 0.015;
    fog.pulsePhase += 0.03;
    fog.x += (dx / dist) * fog.speed + Math.sin(fog.wobble) * 0.8;
    fog.y += (dy / dist) * fog.speed + Math.cos(fog.wobble * 0.7) * 0.5;

    // Check if in beam - fog burns away
    if (isInBeam(fog.x, fog.y) && flamePower > 0) {
      fog.alpha -= 0.02;
      fog.size -= 0.5;

      if (Math.random() < 0.15) {
        spawnFlameParticle(fog.x, fog.y);
      }

      if (fog.alpha <= 0 || fog.size <= 15) {
        if (fog.hasSkull) {
          spawnSpirit(fog.x, fog.y);
        }
        GHOST_FOG.splice(i, 1);
        spiritsBanished++;
        document.getElementById('fogCount').textContent = spiritsBanished;
        continue;
      }
    }

    // Check if touching beacon
    if (dist < 50) {
      fogNearBeacon++;
    }
  }

  // Drain power when fog reaches beacon
  if (fogNearBeacon > 0) {
    flamePower -= fogNearBeacon * 0.12;
  } else {
    flamePower = Math.min(100, flamePower + 0.04);
  }

  document.getElementById('powerFill').style.width = flamePower + '%';

  // Game over
  if (flamePower <= 0) {
    gameOver();
  }

  // Update flame particles
  for (let i = FLAME_PARTICLES.length - 1; i >= 0; i--) {
    const p = FLAME_PARTICLES[i];
    p.x += p.vx;
    p.y += p.vy;
    p.vy -= 0.05;
    p.alpha -= 0.025;
    if (p.alpha <= 0) FLAME_PARTICLES.splice(i, 1);
  }

  // Update spirits
  for (let i = SPIRITS.length - 1; i >= 0; i--) {
    const s = SPIRITS[i];
    s.x += s.vx;
    s.y += s.vy;
    s.rotation += 0.1;
    s.alpha -= 0.015;
    if (s.alpha <= 0) SPIRITS.splice(i, 1);
  }
}

function drawSkullRock() {
  ctx.save();
  ctx.translate(beacon.x, beacon.y);

  // Eerie glow
  const baseGlow = ctx.createRadialGradient(0, 0, 20, 0, 0, 120);
  baseGlow.addColorStop(0, 'rgba(124, 252, 0, 0.15)');
  baseGlow.addColorStop(1, 'transparent');
  ctx.fillStyle = baseGlow;
  ctx.beginPath();
  ctx.arc(0, 0, 120, 0, Math.PI * 2);
  ctx.fill();

  // Rock base
  ctx.fillStyle = '#1a1a1a';
  ctx.beginPath();
  ctx.ellipse(0, 60, 70, 25, 0, 0, Math.PI * 2);
  ctx.fill();

  // Skull rock formation
  const skullGrad = ctx.createRadialGradient(-10, -10, 0, 0, 0, 60);
  skullGrad.addColorStop(0, '#4a4a4a');
  skullGrad.addColorStop(0.5, '#2a2a2a');
  skullGrad.addColorStop(1, '#1a1a1a');
  ctx.fillStyle = skullGrad;

  // Skull shape
  ctx.beginPath();
  ctx.moveTo(-45, 50);
  ctx.quadraticCurveTo(-55, 20, -50, -10);
  ctx.quadraticCurveTo(-45, -40, -25, -50);
  ctx.quadraticCurveTo(0, -60, 25, -50);
  ctx.quadraticCurveTo(45, -40, 50, -10);
  ctx.quadraticCurveTo(55, 20, 45, 50);
  ctx.quadraticCurveTo(25, 55, 0, 50);
  ctx.quadraticCurveTo(-25, 55, -45, 50);
  ctx.fill();

  // Left eye socket
  ctx.fillStyle = '#0a0a0a';
  ctx.beginPath();
  ctx.ellipse(-20, -15, 12, 15, -0.2, 0, Math.PI * 2);
  ctx.fill();

  // Right eye socket
  ctx.beginPath();
  ctx.ellipse(20, -15, 12, 15, 0.2, 0, Math.PI * 2);
  ctx.fill();

  // Eye glow (eerie green)
  const eyeGlow = flamePower / 100;
  ctx.fillStyle = `rgba(124, 252, 0, ${eyeGlow * 0.5})`;
  ctx.shadowColor = '#7cfc00';
  ctx.shadowBlur = 15;
  ctx.beginPath();
  ctx.ellipse(-20, -15, 6, 8, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.beginPath();
  ctx.ellipse(20, -15, 6, 8, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.shadowBlur = 0;

  // Nose hole
  ctx.fillStyle = '#0a0a0a';
  ctx.beginPath();
  ctx.moveTo(-5, 5);
  ctx.lineTo(5, 5);
  ctx.lineTo(0, 18);
  ctx.closePath();
  ctx.fill();

  // Teeth
  ctx.fillStyle = '#3a3a3a';
  for (let i = -3; i <= 3; i++) {
    ctx.fillRect(i * 8 - 3, 28, 6, 12);
  }
  ctx.fillStyle = '#0a0a0a';
  ctx.fillRect(-28, 28, 56, 2);

  // Lantern post
  ctx.fillStyle = '#2a2a2a';
  ctx.fillRect(-4, -50, 8, 30);

  // Lantern cage
  ctx.strokeStyle = '#3a3a3a';
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(-15, -70);
  ctx.lineTo(-15, -50);
  ctx.lineTo(15, -50);
  ctx.lineTo(15, -70);
  ctx.stroke();

  // Lantern top
  ctx.fillStyle = '#2a2a2a';
  ctx.beginPath();
  ctx.moveTo(-18, -70);
  ctx.lineTo(0, -85);
  ctx.lineTo(18, -70);
  ctx.closePath();
  ctx.fill();

  // Cursed flame
  const flameIntensity = flamePower / 100;
  const flicker = Math.sin(frameCount * 0.3) * 3;

  // Outer flame glow
  const flameGlow = ctx.createRadialGradient(0, -60, 5, 0, -60, 40);
  flameGlow.addColorStop(0, `rgba(124, 252, 0, ${flameIntensity * 0.8})`);
  flameGlow.addColorStop(0.5, `rgba(50, 205, 50, ${flameIntensity * 0.4})`);
  flameGlow.addColorStop(1, 'transparent');
  ctx.fillStyle = flameGlow;
  ctx.beginPath();
  ctx.arc(0, -60, 40, 0, Math.PI * 2);
  ctx.fill();

  // Flame shape
  ctx.fillStyle = `rgba(124, 252, 0, ${flameIntensity})`;
  ctx.shadowColor = '#7cfc00';
  ctx.shadowBlur = 25;
  ctx.beginPath();
  ctx.moveTo(-10, -50);
  ctx.quadraticCurveTo(-12 + flicker, -65, 0, -75 - flicker);
  ctx.quadraticCurveTo(12 - flicker, -65, 10, -50);
  ctx.closePath();
  ctx.fill();

  // Inner flame
  ctx.fillStyle = `rgba(200, 255, 200, ${flameIntensity * 0.8})`;
  ctx.beginPath();
  ctx.moveTo(-5, -52);
  ctx.quadraticCurveTo(-6 + flicker * 0.5, -62, 0, -68 - flicker * 0.5);
  ctx.quadraticCurveTo(6 - flicker * 0.5, -62, 5, -52);
  ctx.closePath();
  ctx.fill();
  ctx.shadowBlur = 0;

  // Hanging hook
  ctx.strokeStyle = '#3a3a3a';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.arc(0, -88, 5, 0, Math.PI);
  ctx.stroke();

  ctx.restore();
}

function drawBeam() {
  const beamLength = 450 * (flamePower / 100);
  const beamWidth = 0.35;

  ctx.save();
  ctx.translate(beacon.x, beacon.y - 60);
  ctx.rotate(beamAngle);

  // Beam gradient - ghostly green fire
  const beamGrad = ctx.createLinearGradient(0, 0, beamLength, 0);
  beamGrad.addColorStop(0, `rgba(124, 252, 0, ${0.5 * flamePower / 100})`);
  beamGrad.addColorStop(0.3, `rgba(50, 205, 50, ${0.25 * flamePower / 100})`);
  beamGrad.addColorStop(1, 'transparent');

  ctx.fillStyle = beamGrad;
  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.lineTo(beamLength, -Math.tan(beamWidth) * beamLength);
  ctx.lineTo(beamLength, Math.tan(beamWidth) * beamLength);
  ctx.closePath();
  ctx.fill();

  // Beam core
  const coreGrad = ctx.createLinearGradient(0, 0, beamLength * 0.6, 0);
  coreGrad.addColorStop(0, `rgba(200, 255, 200, ${0.35 * flamePower / 100})`);
  coreGrad.addColorStop(1, 'transparent');

  ctx.fillStyle = coreGrad;
  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.lineTo(beamLength * 0.6, -Math.tan(beamWidth * 0.25) * beamLength * 0.6);
  ctx.lineTo(beamLength * 0.6, Math.tan(beamWidth * 0.25) * beamLength * 0.6);
  ctx.closePath();
  ctx.fill();

  ctx.restore();
}

function drawGhostFog(fog) {
  ctx.save();
  ctx.translate(fog.x, fog.y);
  ctx.globalAlpha = fog.alpha;

  const pulse = 1 + Math.sin(fog.pulsePhase) * 0.1;
  const size = fog.size * pulse;

  // Fog glow
  const fogGlow = ctx.createRadialGradient(0, 0, 0, 0, 0, size);
  fogGlow.addColorStop(0, 'rgba(100, 120, 100, 0.6)');
  fogGlow.addColorStop(0.5, 'rgba(70, 90, 70, 0.3)');
  fogGlow.addColorStop(1, 'transparent');
  ctx.fillStyle = fogGlow;
  ctx.beginPath();
  ctx.arc(0, 0, size, 0, Math.PI * 2);
  ctx.fill();

  // Wispy tendrils
  ctx.strokeStyle = 'rgba(120, 140, 120, 0.4)';
  ctx.lineWidth = 2;
  for (let i = 0; i < 4; i++) {
    const angle = (i / 4) * Math.PI * 2 + fog.wobble;
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.quadraticCurveTo(
      Math.cos(angle + 0.5) * size * 0.5,
      Math.sin(angle + 0.5) * size * 0.5,
      Math.cos(angle) * size * 0.8,
      Math.sin(angle) * size * 0.8
    );
    ctx.stroke();
  }

  // Skull face in fog (if haunted)
  if (fog.hasSkull) {
    ctx.fillStyle = 'rgba(150, 170, 150, 0.5)';
    // Eyes
    ctx.beginPath();
    ctx.arc(-8, -5, 5, 0, Math.PI * 2);
    ctx.arc(8, -5, 5, 0, Math.PI * 2);
    ctx.fill();
    // Mouth
    ctx.beginPath();
    ctx.arc(0, 8, 8, 0, Math.PI);
    ctx.fill();
  }

  ctx.restore();
}

function drawFog() {
  for (const fog of GHOST_FOG) {
    drawGhostFog(fog);
  }
  ctx.globalAlpha = 1;
}

function drawFlameParticles() {
  for (const p of FLAME_PARTICLES) {
    ctx.globalAlpha = p.alpha;
    ctx.fillStyle = p.color;
    ctx.shadowColor = p.color;
    ctx.shadowBlur = 8;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
    ctx.fill();
  }
  ctx.globalAlpha = 1;
  ctx.shadowBlur = 0;
}

function drawSpirits() {
  for (const s of SPIRITS) {
    ctx.save();
    ctx.translate(s.x, s.y);
    ctx.rotate(s.rotation);
    ctx.globalAlpha = s.alpha;

    // Spirit glow
    ctx.fillStyle = 'rgba(124, 252, 0, 0.3)';
    ctx.beginPath();
    ctx.arc(0, 0, s.size * 1.5, 0, Math.PI * 2);
    ctx.fill();

    // Spirit form
    ctx.fillStyle = '#7cfc00';
    ctx.font = `${s.size}px serif`;
    ctx.fillText('üëª', -s.size/2, s.size/3);

    ctx.restore();
  }
  ctx.globalAlpha = 1;
}

function render() {
  // Dark haunted sky
  const skyGrad = ctx.createLinearGradient(0, 0, 0, canvas.height);
  skyGrad.addColorStop(0, '#050508');
  skyGrad.addColorStop(0.5, '#0a0a12');
  skyGrad.addColorStop(1, '#0d1015');
  ctx.fillStyle = skyGrad;
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Faint stars
  ctx.fillStyle = '#fff';
  for (let i = 0; i < 80; i++) {
    const x = (i * 137) % canvas.width;
    const y = (i * 89) % (canvas.height * 0.5);
    const twinkle = 0.15 + Math.sin(frameCount * 0.03 + i) * 0.15;
    ctx.globalAlpha = twinkle;
    ctx.beginPath();
    ctx.arc(x, y, 0.8, 0, Math.PI * 2);
    ctx.fill();
  }
  ctx.globalAlpha = 1;

  // Sickly moon
  ctx.fillStyle = '#9acd32';
  ctx.shadowColor = '#9acd32';
  ctx.shadowBlur = 40;
  ctx.globalAlpha = 0.7;
  ctx.beginPath();
  ctx.arc(canvas.width - 100, 80, 35, 0, Math.PI * 2);
  ctx.fill();
  ctx.shadowBlur = 0;
  ctx.globalAlpha = 1;

  // Dark ocean
  const oceanGrad = ctx.createLinearGradient(0, canvas.height - 120, 0, canvas.height);
  oceanGrad.addColorStop(0, '#0a1510');
  oceanGrad.addColorStop(1, '#050a08');
  ctx.fillStyle = oceanGrad;
  ctx.beginPath();
  ctx.moveTo(0, canvas.height);
  for (let x = 0; x <= canvas.width; x += 20) {
    const y = canvas.height - 60 + Math.sin(x * 0.015 + frameCount * 0.02) * 12;
    ctx.lineTo(x, y);
  }
  ctx.lineTo(canvas.width, canvas.height);
  ctx.fill();

  // Wave lines
  ctx.strokeStyle = 'rgba(80, 100, 80, 0.25)';
  ctx.lineWidth = 1;
  for (let row = 0; row < 3; row++) {
    ctx.beginPath();
    for (let x = 0; x <= canvas.width; x += 10) {
      const y = canvas.height - 45 + row * 15 + Math.sin(x * 0.02 + frameCount * 0.015 + row) * 6;
      if (x === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    }
    ctx.stroke();
  }

  // Draw order
  drawFog();
  drawBeam();
  drawSkullRock();
  drawFlameParticles();
  drawSpirits();

  // Fog overlay creeping in
  const fogOverlay = ctx.createRadialGradient(
    canvas.width/2, canvas.height/2, canvas.height * 0.15,
    canvas.width/2, canvas.height/2, canvas.height
  );
  fogOverlay.addColorStop(0, 'transparent');
  fogOverlay.addColorStop(1, `rgba(60, 80, 60, ${0.4 + (100 - flamePower) * 0.004})`);
  ctx.fillStyle = fogOverlay;
  ctx.fillRect(0, 0, canvas.width, canvas.height);
}

function gameLoop() {
  update();
  render();
  requestAnimationFrame(gameLoop);
}

function startGame() {
  document.getElementById('startOverlay').classList.add('hidden');
  document.getElementById('gameOverOverlay').classList.add('hidden');

  GHOST_FOG.length = 0;
  FLAME_PARTICLES.length = 0;
  SPIRITS.length = 0;
  frameCount = 0;
  survivalTime = 0;
  flamePower = 100;
  beamAngle = -Math.PI / 2;
  spiritsBanished = 0;

  document.getElementById('time').textContent = '0';
  document.getElementById('fogCount').textContent = '0';
  document.getElementById('powerFill').style.width = '100%';
  document.getElementById('submitSection').style.display = 'flex';

  gameRunning = true;
}

function gameOver() {
  gameRunning = false;
  document.getElementById('finalTime').textContent = survivalTime + 's';
  document.getElementById('finalFog').textContent = spiritsBanished;
  document.getElementById('gameOverOverlay').classList.remove('hidden');
  loadLeaderboard();
}

async function loadLeaderboard() {
  const lbList = document.getElementById('lbList');
  lbList.innerHTML = '<div style="color:#2e4a1e">Loading...</div>';

  try {
    if (!supabaseClient) {
      const session = await window.supabaseSession();
      supabaseClient = session.client;
      userId = session.user.id;
    }

    const { data, error } = await supabaseClient
      .from('lighthouse_scores')
      .select('player_name, survival_time, fog_destroyed')
      .order('survival_time', { ascending: false })
      .limit(5);

    if (error) throw error;

    if (!data || data.length === 0) {
      lbList.innerHTML = '<div style="color:#2e4a1e">No scores yet - be the first!</div>';
      return;
    }

    lbList.innerHTML = data.map((row, i) => `
      <div class="lb-row">
        <span class="lb-name">${i+1}. ${row.player_name || 'Anonymous'}</span>
        <span><span class="lb-time">${row.survival_time}s</span> <span class="lb-fog">(${row.fog_destroyed} banished)</span></span>
      </div>
    `).join('');
  } catch (e) {
    console.error('Leaderboard error:', e);
    lbList.innerHTML = '<div style="color:#2e4a1e">Could not load scores</div>';
  }
}

async function submitScore() {
  const nameInput = document.getElementById('playerName');
  const name = nameInput.value.trim() || 'Anonymous';

  try {
    if (!supabaseClient) {
      const session = await window.supabaseSession();
      supabaseClient = session.client;
      userId = session.user.id;
    }

    const { error } = await supabaseClient
      .from('lighthouse_scores')
      .insert({
        player_name: name,
        survival_time: survivalTime,
        fog_destroyed: spiritsBanished,
        user_id: userId
      });

    if (error) throw error;

    document.getElementById('submitSection').style.display = 'none';
    loadLeaderboard();
  } catch (e) {
    console.error('Submit error:', e);
    alert('Could not save score');
  }
}

// Events
document.getElementById('startBtn').addEventListener('click', startGame);
document.getElementById('restartBtn').addEventListener('click', startGame);
document.getElementById('submitBtn').addEventListener('click', submitScore);

canvas.addEventListener('mousemove', e => {
  mouseX = e.clientX;
  mouseY = e.clientY;
});

canvas.addEventListener('touchmove', e => {
  e.preventDefault();
  mouseX = e.touches[0].clientX;
  mouseY = e.touches[0].clientY;
});

canvas.addEventListener('touchstart', e => {
  e.preventDefault();
  mouseX = e.touches[0].clientX;
  mouseY = e.touches[0].clientY;
});

window.addEventListener('resize', resize);

resize();
mouseX = canvas.width / 2;
mouseY = 0;
gameLoop();
</script>
<script src="/apps/sloppy-header/sloppy-bar.js"></script>
<script src="/vibelib-extended.js"></script>
<script>
  // Compatibility Patch for Legacy Apps
  window.addEventListener("load", () => {
    if (window.SloppyKarma && window.VibeLib.Economy) {
      // Redirect old calls to new engine
      window.SloppyKarma.track = window.VibeLib.Economy.track;
    }
  });
</script>
</body>
</html>
