<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Pirate Lighthouse - Warn the Ships</title>
  <link rel="icon" href="https://emojicdn.elk.sh/üè¥‚Äç‚ò†Ô∏è">
  <meta property="og:title" content="Pirate Lighthouse - Warn the Ships">
  <meta property="og:description" content="Keep yer light burning to save ships from Davy Jones!">
  <meta property="og:url" content="https://sloppy.live/lighthouse">
  <meta property="og:image" content="https://emojicdn.elk.sh/üè¥‚Äç‚ò†Ô∏è?style=apple&size=512">
  <link href="https://fonts.googleapis.com/css2?family=Pirata+One&family=IM+Fell+English+SC&display=swap" rel="stylesheet">
  <script type="module">
    import { supabaseSession } from '/supabase-config.js';
    window.supabaseSession = supabaseSession;
  </script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      min-height: 100vh;
      background: #0a0a12;
      font-family: 'IM Fell English SC', serif;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .game-container {
      position: relative;
      width: 100vw;
      height: 100vh;
    }
    canvas { display: block; width: 100%; height: 100%; cursor: none; }
    .hud {
      position: absolute;
      top: 15px;
      left: 20px;
      right: 20px;
      display: flex;
      justify-content: space-between;
      pointer-events: none;
      z-index: 10;
    }
    .title {
      font-family: 'Pirata One', cursive;
      font-size: 1.4rem;
      color: #d4a84b;
      text-shadow: 0 0 20px #d4a84b55, 2px 2px 0 #000;
      letter-spacing: 0.1em;
    }
    .stats {
      text-align: right;
    }
    .score {
      font-size: 1rem;
      color: #d4a84b;
      text-shadow: 0 0 15px #d4a84b55;
    }
    .fog-count {
      font-size: 0.8rem;
      color: #c9a959;
      text-shadow: 0 0 10px #c9a95955;
      margin-top: 5px;
    }
    .power-bar {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 250px;
      height: 20px;
      background: rgba(0,0,0,0.6);
      border: 2px solid #d4a84b;
      border-radius: 10px;
      overflow: hidden;
    }
    .power-fill {
      height: 100%;
      background: linear-gradient(90deg, #d4a84b, #ff8c00);
      transition: width 0.1s;
      box-shadow: 0 0 15px #d4a84b;
    }
    .power-label {
      position: absolute;
      bottom: 45px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.7rem;
      color: #d4a84b;
      letter-spacing: 0.2em;
    }
    .overlay {
      position: absolute;
      inset: 0;
      background: rgba(10, 5, 0, 0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      transition: opacity 0.5s;
    }
    .overlay.hidden { opacity: 0; pointer-events: none; }
    .overlay-title {
      font-family: 'Pirata One', cursive;
      font-size: 2.5rem;
      color: #d4a84b;
      text-shadow: 0 0 30px #d4a84b, 0 0 60px #8b4513;
      margin-bottom: 15px;
    }
    .overlay-sub {
      font-size: 0.9rem;
      color: #8b7355;
      margin-bottom: 30px;
    }
    .btn {
      font-family: 'Pirata One', cursive;
      font-size: 1.2rem;
      padding: 15px 40px;
      background: transparent;
      border: 2px solid #d4a84b;
      color: #d4a84b;
      cursor: pointer;
      letter-spacing: 0.1em;
      transition: all 0.2s;
    }
    .btn:hover {
      background: #d4a84b;
      color: #1a0f0a;
      box-shadow: 0 0 30px #d4a84b55;
    }
    .final-score {
      font-family: 'Pirata One', cursive;
      font-size: 3rem;
      color: #ffd700;
      text-shadow: 0 0 20px #ffd70055;
      margin: 10px 0 5px;
    }
    .final-fog {
      font-size: 1rem;
      color: #c9a959;
      margin-bottom: 15px;
    }
    .submit-section {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    .name-input {
      font-family: 'IM Fell English SC', serif;
      font-size: 0.9rem;
      padding: 10px 15px;
      background: rgba(0,0,0,0.5);
      border: 2px solid #d4a84b;
      color: #d4a84b;
      width: 140px;
      outline: none;
    }
    .name-input::placeholder { color: #5c3a1e; }
    .btn-small {
      font-size: 1rem;
      padding: 10px 20px;
    }
    .leaderboard {
      background: rgba(0,0,0,0.4);
      border: 1px solid #d4a84b;
      padding: 10px 15px;
      margin-bottom: 15px;
      min-width: 280px;
    }
    .lb-title {
      font-family: 'Pirata One', cursive;
      font-size: 1rem;
      color: #d4a84b;
      letter-spacing: 0.15em;
      margin-bottom: 8px;
      text-align: center;
    }
    .lb-list {
      font-size: 0.75rem;
      color: #8b7355;
    }
    .lb-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid rgba(212,168,75,0.2);
    }
    .lb-row:last-child { border-bottom: none; }
    .lb-name { color: #ffd700; }
    .lb-time { color: #d4a84b; }
    .lb-fog { color: #8b7355; font-size: 0.65rem; }
    .back-link {
      position: fixed;
      bottom: 5px;
      right: 10px;
      color: #d4a84b55;
      text-decoration: none;
      font-size: 0.65rem;
    }
    .back-link:hover { color: #d4a84b; }
  </style>
</head>
<body>
  <div class="game-container">
    <canvas id="canvas"></canvas>
    <div class="hud">
      <div class="title">üè¥‚Äç‚ò†Ô∏è PIRATE LIGHTHOUSE</div>
      <div class="stats">
        <div class="score">WATCH: <span id="time">0</span>s</div>
        <div class="fog-count">SHIPS SAVED: <span id="fogCount">0</span></div>
      </div>
    </div>
    <div class="power-label">‚õΩ OIL RESERVES</div>
    <div class="power-bar">
      <div class="power-fill" id="powerFill" style="width: 100%"></div>
    </div>
    <div class="overlay" id="startOverlay">
      <div class="overlay-title">‚öì PIRATE LIGHTHOUSE ‚öì</div>
      <div class="overlay-sub">Aim yer light to warn ships from the cursed fog!</div>
      <button class="btn" id="startBtn">MAN THE LIGHT</button>
    </div>
    <div class="overlay hidden" id="gameOverOverlay">
      <div class="overlay-title">üíÄ DAVY JONES CLAIMS YE üíÄ</div>
      <div class="final-score" id="finalTime">0s</div>
      <div class="final-fog">Ships Saved: <span id="finalFog">0</span></div>
      <div class="submit-section" id="submitSection">
        <input type="text" id="playerName" class="name-input" placeholder="Yer name" maxlength="12">
        <button class="btn btn-small" id="submitBtn">LOG SCORE</button>
      </div>
      <div class="leaderboard" id="leaderboard">
        <div class="lb-title">‚ò† FINEST KEEPERS ‚ò†</div>
        <div class="lb-list" id="lbList"></div>
      </div>
      <button class="btn" id="restartBtn">SAIL AGAIN</button>
    </div>
  </div>
  <a href="https://sloppy.live" class="back-link">‚Üê sloppy.live</a>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let gameRunning = false;
let frameCount = 0;
let survivalTime = 0;
let lightPower = 100;
let beamAngle = 0;
let targetAngle = 0;
let mouseX = 0, mouseY = 0;
let shipsDestroyed = 0;
let supabaseClient = null;
let userId = null;

const lighthouse = { x: 0, y: 0 };
const GHOST_SHIPS = [];
const LIGHT_PARTICLES = [];
const MAX_SHIPS = 25;

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  lighthouse.x = canvas.width / 2;
  lighthouse.y = canvas.height / 2 + 50;
}

function spawnGhostShip() {
  if (GHOST_SHIPS.length >= MAX_SHIPS) return;

  const angle = Math.random() * Math.PI * 2;
  const dist = Math.max(canvas.width, canvas.height) * 0.7;

  GHOST_SHIPS.push({
    x: lighthouse.x + Math.cos(angle) * dist,
    y: lighthouse.y + Math.sin(angle) * dist,
    size: 40 + Math.random() * 30,
    speed: 0.4 + Math.random() * 0.4,
    alpha: 0.6 + Math.random() * 0.3,
    wobble: Math.random() * Math.PI * 2,
    rotation: angle + Math.PI // Face lighthouse
  });
}

function spawnLightParticle(x, y) {
  LIGHT_PARTICLES.push({
    x, y,
    vx: (Math.random() - 0.5) * 3,
    vy: (Math.random() - 0.5) * 3,
    size: 2 + Math.random() * 4,
    alpha: 1,
    color: Math.random() > 0.5 ? '#ffd700' : '#ff8c00'
  });
}

function isInBeam(x, y) {
  const dx = x - lighthouse.x;
  const dy = y - lighthouse.y;
  const angle = Math.atan2(dy, dx);
  const dist = Math.sqrt(dx*dx + dy*dy);

  let angleDiff = angle - beamAngle;
  while (angleDiff > Math.PI) angleDiff -= Math.PI * 2;
  while (angleDiff < -Math.PI) angleDiff += Math.PI * 2;

  const beamWidth = 0.4;
  const beamLength = 400 * (lightPower / 100);

  return Math.abs(angleDiff) < beamWidth && dist < beamLength && dist > 80;
}

function update() {
  if (!gameRunning) return;

  frameCount++;
  if (frameCount % 60 === 0) {
    survivalTime++;
    document.getElementById('time').textContent = survivalTime;
  }

  // Spawn ships (more over time)
  const spawnRate = Math.max(3, 12 - Math.floor(survivalTime / 10));
  if (frameCount % spawnRate === 0) {
    spawnGhostShip();
  }

  // Update beam angle
  const dx = mouseX - lighthouse.x;
  const dy = mouseY - lighthouse.y;
  targetAngle = Math.atan2(dy, dx);

  let angleDiff = targetAngle - beamAngle;
  while (angleDiff > Math.PI) angleDiff -= Math.PI * 2;
  while (angleDiff < -Math.PI) angleDiff += Math.PI * 2;
  beamAngle += angleDiff * 0.1;

  // Update ships
  let shipsNearLighthouse = 0;
  for (let i = GHOST_SHIPS.length - 1; i >= 0; i--) {
    const ship = GHOST_SHIPS[i];

    // Move toward lighthouse
    const dx = lighthouse.x - ship.x;
    const dy = lighthouse.y - ship.y;
    const dist = Math.sqrt(dx*dx + dy*dy);

    ship.wobble += 0.02;
    ship.x += (dx / dist) * ship.speed + Math.sin(ship.wobble) * 0.5;
    ship.y += (dy / dist) * ship.speed + Math.cos(ship.wobble * 0.7) * 0.3;
    ship.rotation = Math.atan2(dy, dx) + Math.PI;

    // Check if in beam - ships are SAVED when hit by light
    if (isInBeam(ship.x, ship.y) && lightPower > 0) {
      ship.alpha -= 0.025;
      ship.size -= 0.3;

      if (Math.random() < 0.1) {
        spawnLightParticle(ship.x, ship.y);
      }

      if (ship.alpha <= 0 || ship.size <= 10) {
        GHOST_SHIPS.splice(i, 1);
        shipsDestroyed++;
        document.getElementById('fogCount').textContent = shipsDestroyed;
        continue;
      }
    }

    // Check if touching lighthouse (crashed!)
    if (dist < 60) {
      shipsNearLighthouse++;
    }
  }

  // Drain power when ships crash
  if (shipsNearLighthouse > 0) {
    lightPower -= shipsNearLighthouse * 0.15;
  } else {
    lightPower = Math.min(100, lightPower + 0.05);
  }

  document.getElementById('powerFill').style.width = lightPower + '%';

  // Game over
  if (lightPower <= 0) {
    gameOver();
  }

  // Update light particles
  for (let i = LIGHT_PARTICLES.length - 1; i >= 0; i--) {
    const p = LIGHT_PARTICLES[i];
    p.x += p.vx;
    p.y += p.vy;
    p.alpha -= 0.03;
    if (p.alpha <= 0) LIGHT_PARTICLES.splice(i, 1);
  }
}

function drawLighthouse() {
  ctx.save();
  ctx.translate(lighthouse.x, lighthouse.y);

  // Base glow
  const baseGlow = ctx.createRadialGradient(0, 0, 20, 0, 0, 100);
  baseGlow.addColorStop(0, 'rgba(212, 168, 75, 0.2)');
  baseGlow.addColorStop(1, 'transparent');
  ctx.fillStyle = baseGlow;
  ctx.beginPath();
  ctx.arc(0, 0, 100, 0, Math.PI * 2);
  ctx.fill();

  // Rock base
  ctx.fillStyle = '#2a1810';
  ctx.beginPath();
  ctx.ellipse(0, 55, 50, 20, 0, 0, Math.PI * 2);
  ctx.fill();

  // Tower body - stone texture
  const stoneGrad = ctx.createLinearGradient(-25, 50, 25, 50);
  stoneGrad.addColorStop(0, '#3d2817');
  stoneGrad.addColorStop(0.5, '#5c3a1e');
  stoneGrad.addColorStop(1, '#3d2817');
  ctx.fillStyle = stoneGrad;
  ctx.beginPath();
  ctx.moveTo(-25, 50);
  ctx.lineTo(-18, -40);
  ctx.lineTo(18, -40);
  ctx.lineTo(25, 50);
  ctx.closePath();
  ctx.fill();

  // Tower stripes (red and white like classic lighthouse)
  ctx.fillStyle = '#8b0000';
  for (let y = -30; y < 40; y += 30) {
    ctx.beginPath();
    const w1 = 18 + (y + 40) * 0.08;
    const w2 = 18 + (y + 55) * 0.08;
    ctx.moveTo(-w1, y);
    ctx.lineTo(w1, y);
    ctx.lineTo(w2, y + 15);
    ctx.lineTo(-w2, y + 15);
    ctx.closePath();
    ctx.fill();
  }

  // Light housing - brass/gold
  const brassGrad = ctx.createLinearGradient(-25, -60, 25, -35);
  brassGrad.addColorStop(0, '#b8860b');
  brassGrad.addColorStop(0.5, '#d4a84b');
  brassGrad.addColorStop(1, '#8b6914');
  ctx.fillStyle = brassGrad;
  ctx.fillRect(-25, -60, 50, 25);

  // Light source
  const lightGlow = ctx.createRadialGradient(0, -48, 5, 0, -48, 30);
  lightGlow.addColorStop(0, `rgba(255, 200, 50, ${lightPower / 100})`);
  lightGlow.addColorStop(0.5, `rgba(255, 140, 0, ${lightPower / 200})`);
  lightGlow.addColorStop(1, 'transparent');
  ctx.fillStyle = lightGlow;
  ctx.beginPath();
  ctx.arc(0, -48, 30, 0, Math.PI * 2);
  ctx.fill();

  ctx.fillStyle = '#ffd700';
  ctx.shadowColor = '#ffa500';
  ctx.shadowBlur = 20;
  ctx.beginPath();
  ctx.arc(0, -48, 10, 0, Math.PI * 2);
  ctx.fill();
  ctx.shadowBlur = 0;

  // Top dome - copper
  ctx.fillStyle = '#8b4513';
  ctx.beginPath();
  ctx.arc(0, -60, 20, Math.PI, 0);
  ctx.fill();

  // Flag pole
  ctx.strokeStyle = '#4a2c0f';
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(0, -60);
  ctx.lineTo(0, -90);
  ctx.stroke();

  // Jolly Roger flag
  ctx.fillStyle = '#1a1a1a';
  ctx.fillRect(2, -88, 20, 15);
  ctx.fillStyle = '#fff';
  ctx.font = '10px serif';
  ctx.fillText('‚ò†', 7, -78);

  ctx.restore();
}

function drawBeam() {
  const beamLength = 400 * (lightPower / 100);
  const beamWidth = 0.4;

  ctx.save();
  ctx.translate(lighthouse.x, lighthouse.y - 48);
  ctx.rotate(beamAngle);

  // Beam gradient - warm gold light
  const beamGrad = ctx.createLinearGradient(0, 0, beamLength, 0);
  beamGrad.addColorStop(0, `rgba(255, 200, 50, ${0.6 * lightPower / 100})`);
  beamGrad.addColorStop(0.3, `rgba(255, 140, 0, ${0.3 * lightPower / 100})`);
  beamGrad.addColorStop(1, 'transparent');

  ctx.fillStyle = beamGrad;
  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.lineTo(beamLength, -Math.tan(beamWidth) * beamLength);
  ctx.lineTo(beamLength, Math.tan(beamWidth) * beamLength);
  ctx.closePath();
  ctx.fill();

  // Beam core
  const coreGrad = ctx.createLinearGradient(0, 0, beamLength * 0.7, 0);
  coreGrad.addColorStop(0, `rgba(255, 255, 200, ${0.4 * lightPower / 100})`);
  coreGrad.addColorStop(1, 'transparent');

  ctx.fillStyle = coreGrad;
  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.lineTo(beamLength * 0.7, -Math.tan(beamWidth * 0.3) * beamLength * 0.7);
  ctx.lineTo(beamLength * 0.7, Math.tan(beamWidth * 0.3) * beamLength * 0.7);
  ctx.closePath();
  ctx.fill();

  ctx.restore();
}

function drawGhostShip(ship) {
  ctx.save();
  ctx.translate(ship.x, ship.y);
  ctx.rotate(ship.rotation);
  ctx.globalAlpha = ship.alpha;

  const s = ship.size / 50;

  // Ghostly glow
  const ghostGlow = ctx.createRadialGradient(0, 0, 0, 0, 0, ship.size);
  ghostGlow.addColorStop(0, 'rgba(100, 150, 100, 0.3)');
  ghostGlow.addColorStop(1, 'transparent');
  ctx.fillStyle = ghostGlow;
  ctx.beginPath();
  ctx.arc(0, 0, ship.size, 0, Math.PI * 2);
  ctx.fill();

  // Hull - ghostly green
  ctx.fillStyle = 'rgba(60, 100, 60, 0.8)';
  ctx.beginPath();
  ctx.moveTo(-25 * s, 0);
  ctx.quadraticCurveTo(-20 * s, 15 * s, 0, 18 * s);
  ctx.quadraticCurveTo(20 * s, 15 * s, 30 * s, 0);
  ctx.quadraticCurveTo(20 * s, -10 * s, 0, -12 * s);
  ctx.quadraticCurveTo(-20 * s, -10 * s, -25 * s, 0);
  ctx.fill();

  // Mast
  ctx.strokeStyle = 'rgba(80, 60, 40, 0.8)';
  ctx.lineWidth = 3 * s;
  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.lineTo(0, -35 * s);
  ctx.stroke();

  // Tattered sail
  ctx.fillStyle = 'rgba(150, 150, 140, 0.6)';
  ctx.beginPath();
  ctx.moveTo(0, -30 * s);
  ctx.quadraticCurveTo(15 * s, -20 * s, 12 * s, -5 * s);
  ctx.lineTo(0, -5 * s);
  ctx.closePath();
  ctx.fill();

  // Skull on sail
  ctx.fillStyle = 'rgba(200, 200, 200, 0.7)';
  ctx.font = `${12 * s}px serif`;
  ctx.fillText('üíÄ', -3 * s, -15 * s);

  ctx.restore();
}

function drawShips() {
  for (const ship of GHOST_SHIPS) {
    drawGhostShip(ship);
  }
  ctx.globalAlpha = 1;
}

function drawLightParticles() {
  for (const p of LIGHT_PARTICLES) {
    ctx.globalAlpha = p.alpha;
    ctx.fillStyle = p.color;
    ctx.shadowColor = p.color;
    ctx.shadowBlur = 10;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
    ctx.fill();
  }
  ctx.globalAlpha = 1;
  ctx.shadowBlur = 0;
}

function render() {
  // Night sky
  const skyGrad = ctx.createLinearGradient(0, 0, 0, canvas.height);
  skyGrad.addColorStop(0, '#0a0a15');
  skyGrad.addColorStop(0.6, '#1a1520');
  skyGrad.addColorStop(1, '#0d1a2a');
  ctx.fillStyle = skyGrad;
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Stars
  ctx.fillStyle = '#fff';
  for (let i = 0; i < 100; i++) {
    const x = (i * 137) % canvas.width;
    const y = (i * 89) % (canvas.height * 0.6);
    const twinkle = 0.3 + Math.sin(frameCount * 0.05 + i) * 0.3;
    ctx.globalAlpha = twinkle;
    ctx.beginPath();
    ctx.arc(x, y, 1, 0, Math.PI * 2);
    ctx.fill();
  }
  ctx.globalAlpha = 1;

  // Moon
  ctx.fillStyle = '#fffacd';
  ctx.shadowColor = '#fffacd';
  ctx.shadowBlur = 30;
  ctx.beginPath();
  ctx.arc(canvas.width - 100, 80, 40, 0, Math.PI * 2);
  ctx.fill();
  ctx.shadowBlur = 0;

  // Ocean waves
  const oceanGrad = ctx.createLinearGradient(0, canvas.height - 150, 0, canvas.height);
  oceanGrad.addColorStop(0, '#0a2030');
  oceanGrad.addColorStop(1, '#061520');
  ctx.fillStyle = oceanGrad;
  ctx.beginPath();
  ctx.moveTo(0, canvas.height);
  for (let x = 0; x <= canvas.width; x += 20) {
    const y = canvas.height - 80 + Math.sin(x * 0.02 + frameCount * 0.03) * 15;
    ctx.lineTo(x, y);
  }
  ctx.lineTo(canvas.width, canvas.height);
  ctx.fill();

  // Wave highlights
  ctx.strokeStyle = 'rgba(100, 150, 180, 0.3)';
  ctx.lineWidth = 2;
  for (let row = 0; row < 3; row++) {
    ctx.beginPath();
    for (let x = 0; x <= canvas.width; x += 10) {
      const y = canvas.height - 60 + row * 20 + Math.sin(x * 0.03 + frameCount * 0.02 + row) * 8;
      if (x === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    }
    ctx.stroke();
  }

  // Draw order matters
  drawShips();
  drawBeam();
  drawLighthouse();
  drawLightParticles();

  // Fog overlay
  const fogGrad = ctx.createRadialGradient(
    canvas.width/2, canvas.height/2, canvas.height * 0.2,
    canvas.width/2, canvas.height/2, canvas.height
  );
  fogGrad.addColorStop(0, 'transparent');
  fogGrad.addColorStop(1, 'rgba(50, 60, 50, 0.5)');
  ctx.fillStyle = fogGrad;
  ctx.fillRect(0, 0, canvas.width, canvas.height);
}

function gameLoop() {
  update();
  render();
  requestAnimationFrame(gameLoop);
}

function startGame() {
  document.getElementById('startOverlay').classList.add('hidden');
  document.getElementById('gameOverOverlay').classList.add('hidden');

  GHOST_SHIPS.length = 0;
  LIGHT_PARTICLES.length = 0;
  frameCount = 0;
  survivalTime = 0;
  lightPower = 100;
  beamAngle = -Math.PI / 2;
  shipsDestroyed = 0;

  document.getElementById('time').textContent = '0';
  document.getElementById('fogCount').textContent = '0';
  document.getElementById('powerFill').style.width = '100%';
  document.getElementById('submitSection').style.display = 'flex';

  gameRunning = true;
}

function gameOver() {
  gameRunning = false;
  document.getElementById('finalTime').textContent = survivalTime + 's';
  document.getElementById('finalFog').textContent = shipsDestroyed;
  document.getElementById('gameOverOverlay').classList.remove('hidden');
  loadLeaderboard();
}

async function loadLeaderboard() {
  const lbList = document.getElementById('lbList');
  lbList.innerHTML = '<div style="color:#5c3a1e">Loading...</div>';

  try {
    if (!supabaseClient) {
      const session = await window.supabaseSession();
      supabaseClient = session.client;
      userId = session.user.id;
    }

    const { data, error } = await supabaseClient
      .from('lighthouse_scores')
      .select('player_name, survival_time, fog_destroyed')
      .order('survival_time', { ascending: false })
      .limit(5);

    if (error) throw error;

    if (!data || data.length === 0) {
      lbList.innerHTML = '<div style="color:#5c3a1e">No scores yet - be the first!</div>';
      return;
    }

    lbList.innerHTML = data.map((row, i) => `
      <div class="lb-row">
        <span class="lb-name">${i+1}. ${row.player_name || 'Anonymous'}</span>
        <span><span class="lb-time">${row.survival_time}s</span> <span class="lb-fog">(${row.fog_destroyed} saved)</span></span>
      </div>
    `).join('');
  } catch (e) {
    console.error('Leaderboard error:', e);
    lbList.innerHTML = '<div style="color:#5c3a1e">Could not load scores</div>';
  }
}

async function submitScore() {
  const nameInput = document.getElementById('playerName');
  const name = nameInput.value.trim() || 'Anonymous';

  try {
    if (!supabaseClient) {
      const session = await window.supabaseSession();
      supabaseClient = session.client;
      userId = session.user.id;
    }

    const { error } = await supabaseClient
      .from('lighthouse_scores')
      .insert({
        player_name: name,
        survival_time: survivalTime,
        fog_destroyed: shipsDestroyed,
        user_id: userId
      });

    if (error) throw error;

    document.getElementById('submitSection').style.display = 'none';
    loadLeaderboard();
  } catch (e) {
    console.error('Submit error:', e);
    alert('Could not save score');
  }
}

// Events
document.getElementById('startBtn').addEventListener('click', startGame);
document.getElementById('restartBtn').addEventListener('click', startGame);
document.getElementById('submitBtn').addEventListener('click', submitScore);

canvas.addEventListener('mousemove', e => {
  mouseX = e.clientX;
  mouseY = e.clientY;
});

canvas.addEventListener('touchmove', e => {
  e.preventDefault();
  mouseX = e.touches[0].clientX;
  mouseY = e.touches[0].clientY;
});

canvas.addEventListener('touchstart', e => {
  e.preventDefault();
  mouseX = e.touches[0].clientX;
  mouseY = e.touches[0].clientY;
});

window.addEventListener('resize', resize);

resize();
mouseX = canvas.width / 2;
mouseY = 0;
gameLoop();
</script>
</body>
</html>
