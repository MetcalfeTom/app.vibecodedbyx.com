<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>NEON LIGHTHOUSE - Fight the Fog</title>
  <link rel="icon" href="https://emojicdn.elk.sh/ðŸ—¼">
  <meta property="og:title" content="NEON LIGHTHOUSE - Fight the Fog">
  <meta property="og:description" content="Rotate your beam to push back the encroaching fog!">
  <meta property="og:url" content="https://sloppy.live/lighthouse">
  <meta property="og:image" content="https://emojicdn.elk.sh/ðŸŒ«ï¸?style=apple&size=512">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  <script type="module">
    import { supabaseSession } from '/supabase-config.js';
    window.supabaseSession = supabaseSession;
  </script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      min-height: 100vh;
      background: #0a0a12;
      font-family: 'Orbitron', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .game-container {
      position: relative;
      width: 100vw;
      height: 100vh;
    }
    canvas { display: block; width: 100%; height: 100%; cursor: none; }
    .hud {
      position: absolute;
      top: 15px;
      left: 20px;
      right: 20px;
      display: flex;
      justify-content: space-between;
      pointer-events: none;
      z-index: 10;
    }
    .title {
      font-size: 1.2rem;
      color: #0ff;
      text-shadow: 0 0 20px #0ff;
      letter-spacing: 0.15em;
    }
    .stats {
      text-align: right;
    }
    .score {
      font-size: 1rem;
      color: #ff0;
      text-shadow: 0 0 15px #ff0;
    }
    .fog-count {
      font-size: 0.8rem;
      color: #0ff;
      text-shadow: 0 0 10px #0ff;
      margin-top: 5px;
    }
    .power-bar {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 250px;
      height: 20px;
      background: rgba(0,0,0,0.6);
      border: 2px solid #0ff;
      border-radius: 10px;
      overflow: hidden;
    }
    .power-fill {
      height: 100%;
      background: linear-gradient(90deg, #0ff, #0f0);
      transition: width 0.1s;
      box-shadow: 0 0 15px #0ff;
    }
    .power-label {
      position: absolute;
      bottom: 45px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.7rem;
      color: #0ff;
      letter-spacing: 0.2em;
    }
    .overlay {
      position: absolute;
      inset: 0;
      background: rgba(5, 5, 15, 0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      transition: opacity 0.5s;
    }
    .overlay.hidden { opacity: 0; pointer-events: none; }
    .overlay-title {
      font-size: 2.5rem;
      color: #0ff;
      text-shadow: 0 0 30px #0ff, 0 0 60px #08f;
      margin-bottom: 15px;
    }
    .overlay-sub {
      font-size: 0.9rem;
      color: #888;
      margin-bottom: 30px;
    }
    .btn {
      font-family: 'Orbitron', sans-serif;
      font-size: 1rem;
      padding: 15px 40px;
      background: transparent;
      border: 2px solid #0ff;
      color: #0ff;
      cursor: pointer;
      letter-spacing: 0.1em;
      transition: all 0.2s;
    }
    .btn:hover {
      background: #0ff;
      color: #0a0a12;
      box-shadow: 0 0 30px #0ff;
    }
    .final-score {
      font-size: 3rem;
      color: #ff0;
      text-shadow: 0 0 20px #ff0;
      margin: 10px 0 5px;
    }
    .final-fog {
      font-size: 1rem;
      color: #0ff;
      margin-bottom: 15px;
    }
    .submit-section {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    .name-input {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.9rem;
      padding: 10px 15px;
      background: rgba(0,0,0,0.5);
      border: 2px solid #0ff;
      color: #0ff;
      width: 140px;
      outline: none;
    }
    .name-input::placeholder { color: #066; }
    .btn-small {
      font-size: 0.8rem;
      padding: 10px 20px;
    }
    .leaderboard {
      background: rgba(0,0,0,0.4);
      border: 1px solid #0ff;
      padding: 10px 15px;
      margin-bottom: 15px;
      min-width: 280px;
    }
    .lb-title {
      font-size: 0.8rem;
      color: #0ff;
      letter-spacing: 0.15em;
      margin-bottom: 8px;
      text-align: center;
    }
    .lb-list {
      font-size: 0.75rem;
      color: #aaa;
    }
    .lb-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid rgba(0,255,255,0.1);
    }
    .lb-row:last-child { border-bottom: none; }
    .lb-name { color: #ff0; }
    .lb-time { color: #0ff; }
    .lb-fog { color: #888; font-size: 0.65rem; }
    .back-link {
      position: fixed;
      bottom: 5px;
      right: 10px;
      color: #0ff;
      text-decoration: none;
      font-size: 0.65rem;
      opacity: 0.4;
    }
  </style>
</head>
<body>
  <div class="game-container">
    <canvas id="canvas"></canvas>
    <div class="hud">
      <div class="title">ðŸ—¼ NEON LIGHTHOUSE</div>
      <div class="stats">
        <div class="score">SURVIVED: <span id="time">0</span>s</div>
        <div class="fog-count">FOG CLEARED: <span id="fogCount">0</span></div>
      </div>
    </div>
    <div class="power-label">LIGHT POWER</div>
    <div class="power-bar">
      <div class="power-fill" id="powerFill" style="width: 100%"></div>
    </div>
    <div class="overlay" id="startOverlay">
      <div class="overlay-title">NEON LIGHTHOUSE</div>
      <div class="overlay-sub">Move mouse/touch to aim â€¢ Fight back the fog!</div>
      <button class="btn" id="startBtn">BEGIN WATCH</button>
    </div>
    <div class="overlay hidden" id="gameOverOverlay">
      <div class="overlay-title">THE FOG CONSUMES</div>
      <div class="final-score" id="finalTime">0s</div>
      <div class="final-fog">Fog Cleared: <span id="finalFog">0</span></div>
      <div class="submit-section" id="submitSection">
        <input type="text" id="playerName" class="name-input" placeholder="Your name" maxlength="12">
        <button class="btn btn-small" id="submitBtn">SUBMIT SCORE</button>
      </div>
      <div class="leaderboard" id="leaderboard">
        <div class="lb-title">TOP KEEPERS</div>
        <div class="lb-list" id="lbList"></div>
      </div>
      <button class="btn" id="restartBtn">TRY AGAIN</button>
    </div>
  </div>
  <a href="https://sloppy.live" class="back-link">sloppy.live</a>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let gameRunning = false;
let frameCount = 0;
let survivalTime = 0;
let lightPower = 100;
let beamAngle = 0;
let targetAngle = 0;
let mouseX = 0, mouseY = 0;
let fogDestroyed = 0;
let supabaseClient = null;
let userId = null;

const lighthouse = { x: 0, y: 0 };
const FOG_PARTICLES = [];
const LIGHT_PARTICLES = [];
const MAX_FOG = 300;

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  lighthouse.x = canvas.width / 2;
  lighthouse.y = canvas.height / 2 + 50;
}

function spawnFog() {
  if (FOG_PARTICLES.length >= MAX_FOG) return;
  
  const angle = Math.random() * Math.PI * 2;
  const dist = Math.max(canvas.width, canvas.height) * 0.7;
  
  FOG_PARTICLES.push({
    x: lighthouse.x + Math.cos(angle) * dist,
    y: lighthouse.y + Math.sin(angle) * dist,
    size: 30 + Math.random() * 50,
    speed: 0.3 + Math.random() * 0.5,
    alpha: 0.3 + Math.random() * 0.4,
    wobble: Math.random() * Math.PI * 2
  });
}

function spawnLightParticle(x, y) {
  LIGHT_PARTICLES.push({
    x, y,
    vx: (Math.random() - 0.5) * 3,
    vy: (Math.random() - 0.5) * 3,
    size: 2 + Math.random() * 4,
    alpha: 1,
    color: Math.random() > 0.5 ? '#0ff' : '#ff0'
  });
}

function isInBeam(x, y) {
  const dx = x - lighthouse.x;
  const dy = y - lighthouse.y;
  const angle = Math.atan2(dy, dx);
  const dist = Math.sqrt(dx*dx + dy*dy);
  
  let angleDiff = angle - beamAngle;
  while (angleDiff > Math.PI) angleDiff -= Math.PI * 2;
  while (angleDiff < -Math.PI) angleDiff += Math.PI * 2;
  
  const beamWidth = 0.4; // radians
  const beamLength = 400 * (lightPower / 100);
  
  return Math.abs(angleDiff) < beamWidth && dist < beamLength && dist > 80;
}

function update() {
  if (!gameRunning) return;
  
  frameCount++;
  if (frameCount % 60 === 0) {
    survivalTime++;
    document.getElementById('time').textContent = survivalTime;
  }
  
  // Spawn fog (more over time)
  const spawnRate = Math.max(2, 10 - Math.floor(survivalTime / 10));
  if (frameCount % spawnRate === 0) {
    spawnFog();
  }
  
  // Update beam angle
  const dx = mouseX - lighthouse.x;
  const dy = mouseY - lighthouse.y;
  targetAngle = Math.atan2(dy, dx);
  
  let angleDiff = targetAngle - beamAngle;
  while (angleDiff > Math.PI) angleDiff -= Math.PI * 2;
  while (angleDiff < -Math.PI) angleDiff += Math.PI * 2;
  beamAngle += angleDiff * 0.1;
  
  // Update fog
  let fogNearLighthouse = 0;
  for (let i = FOG_PARTICLES.length - 1; i >= 0; i--) {
    const fog = FOG_PARTICLES[i];
    
    // Move toward lighthouse
    const dx = lighthouse.x - fog.x;
    const dy = lighthouse.y - fog.y;
    const dist = Math.sqrt(dx*dx + dy*dy);
    
    fog.wobble += 0.02;
    fog.x += (dx / dist) * fog.speed + Math.sin(fog.wobble) * 0.5;
    fog.y += (dy / dist) * fog.speed + Math.cos(fog.wobble * 0.7) * 0.5;
    
    // Check if in beam
    if (isInBeam(fog.x, fog.y) && lightPower > 0) {
      fog.alpha -= 0.02;
      fog.size -= 0.5;
      
      if (Math.random() < 0.1) {
        spawnLightParticle(fog.x, fog.y);
      }
      
      if (fog.alpha <= 0 || fog.size <= 5) {
        FOG_PARTICLES.splice(i, 1);
        fogDestroyed++;
        document.getElementById('fogCount').textContent = fogDestroyed;
        continue;
      }
    }
    
    // Check if touching lighthouse
    if (dist < 60) {
      fogNearLighthouse++;
    }
  }
  
  // Drain power when fog is near
  if (fogNearLighthouse > 0) {
    lightPower -= fogNearLighthouse * 0.1;
  } else {
    lightPower = Math.min(100, lightPower + 0.05);
  }
  
  document.getElementById('powerFill').style.width = lightPower + '%';
  
  // Game over
  if (lightPower <= 0) {
    gameOver();
  }
  
  // Update light particles
  for (let i = LIGHT_PARTICLES.length - 1; i >= 0; i--) {
    const p = LIGHT_PARTICLES[i];
    p.x += p.vx;
    p.y += p.vy;
    p.alpha -= 0.03;
    if (p.alpha <= 0) LIGHT_PARTICLES.splice(i, 1);
  }
}

function drawLighthouse() {
  ctx.save();
  ctx.translate(lighthouse.x, lighthouse.y);
  
  // Base glow
  const baseGlow = ctx.createRadialGradient(0, 0, 20, 0, 0, 100);
  baseGlow.addColorStop(0, 'rgba(0, 255, 255, 0.2)');
  baseGlow.addColorStop(1, 'transparent');
  ctx.fillStyle = baseGlow;
  ctx.beginPath();
  ctx.arc(0, 0, 100, 0, Math.PI * 2);
  ctx.fill();
  
  // Tower body
  ctx.fillStyle = '#1a1a2e';
  ctx.beginPath();
  ctx.moveTo(-25, 50);
  ctx.lineTo(-20, -40);
  ctx.lineTo(20, -40);
  ctx.lineTo(25, 50);
  ctx.closePath();
  ctx.fill();
  
  // Tower stripes
  ctx.strokeStyle = '#0ff';
  ctx.lineWidth = 2;
  for (let y = -30; y < 40; y += 15) {
    ctx.beginPath();
    const w = 20 + (y + 40) * 0.1;
    ctx.moveTo(-w, y);
    ctx.lineTo(w, y);
    ctx.stroke();
  }
  
  // Light housing
  ctx.fillStyle = '#2a2a3e';
  ctx.fillRect(-25, -60, 50, 25);
  
  // Light source
  const lightGlow = ctx.createRadialGradient(0, -48, 5, 0, -48, 30);
  lightGlow.addColorStop(0, `rgba(255, 255, 0, ${lightPower / 100})`);
  lightGlow.addColorStop(0.5, `rgba(0, 255, 255, ${lightPower / 200})`);
  lightGlow.addColorStop(1, 'transparent');
  ctx.fillStyle = lightGlow;
  ctx.beginPath();
  ctx.arc(0, -48, 30, 0, Math.PI * 2);
  ctx.fill();
  
  ctx.fillStyle = '#ff0';
  ctx.shadowColor = '#ff0';
  ctx.shadowBlur = 20;
  ctx.beginPath();
  ctx.arc(0, -48, 10, 0, Math.PI * 2);
  ctx.fill();
  ctx.shadowBlur = 0;
  
  // Top dome
  ctx.fillStyle = '#1a1a2e';
  ctx.beginPath();
  ctx.arc(0, -60, 20, Math.PI, 0);
  ctx.fill();
  
  ctx.restore();
}

function drawBeam() {
  const beamLength = 400 * (lightPower / 100);
  const beamWidth = 0.4;
  
  ctx.save();
  ctx.translate(lighthouse.x, lighthouse.y - 48);
  ctx.rotate(beamAngle);
  
  // Beam gradient
  const beamGrad = ctx.createLinearGradient(0, 0, beamLength, 0);
  beamGrad.addColorStop(0, `rgba(255, 255, 0, ${0.6 * lightPower / 100})`);
  beamGrad.addColorStop(0.3, `rgba(0, 255, 255, ${0.3 * lightPower / 100})`);
  beamGrad.addColorStop(1, 'transparent');
  
  ctx.fillStyle = beamGrad;
  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.lineTo(beamLength, -Math.tan(beamWidth) * beamLength);
  ctx.lineTo(beamLength, Math.tan(beamWidth) * beamLength);
  ctx.closePath();
  ctx.fill();
  
  // Beam core
  const coreGrad = ctx.createLinearGradient(0, 0, beamLength * 0.7, 0);
  coreGrad.addColorStop(0, `rgba(255, 255, 255, ${0.4 * lightPower / 100})`);
  coreGrad.addColorStop(1, 'transparent');
  
  ctx.fillStyle = coreGrad;
  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.lineTo(beamLength * 0.7, -Math.tan(beamWidth * 0.3) * beamLength * 0.7);
  ctx.lineTo(beamLength * 0.7, Math.tan(beamWidth * 0.3) * beamLength * 0.7);
  ctx.closePath();
  ctx.fill();
  
  ctx.restore();
}

function drawFog() {
  for (const fog of FOG_PARTICLES) {
    ctx.globalAlpha = fog.alpha;
    
    const fogGrad = ctx.createRadialGradient(fog.x, fog.y, 0, fog.x, fog.y, fog.size);
    fogGrad.addColorStop(0, 'rgba(100, 100, 120, 0.8)');
    fogGrad.addColorStop(0.5, 'rgba(60, 60, 80, 0.5)');
    fogGrad.addColorStop(1, 'transparent');
    
    ctx.fillStyle = fogGrad;
    ctx.beginPath();
    ctx.arc(fog.x, fog.y, fog.size, 0, Math.PI * 2);
    ctx.fill();
  }
  ctx.globalAlpha = 1;
}

function drawLightParticles() {
  for (const p of LIGHT_PARTICLES) {
    ctx.globalAlpha = p.alpha;
    ctx.fillStyle = p.color;
    ctx.shadowColor = p.color;
    ctx.shadowBlur = 10;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
    ctx.fill();
  }
  ctx.globalAlpha = 1;
  ctx.shadowBlur = 0;
}

function render() {
  // Dark background
  ctx.fillStyle = '#050510';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  // Stars
  ctx.fillStyle = '#fff';
  for (let i = 0; i < 100; i++) {
    const x = (i * 137) % canvas.width;
    const y = (i * 89) % canvas.height;
    const twinkle = 0.3 + Math.sin(frameCount * 0.05 + i) * 0.3;
    ctx.globalAlpha = twinkle;
    ctx.beginPath();
    ctx.arc(x, y, 1, 0, Math.PI * 2);
    ctx.fill();
  }
  ctx.globalAlpha = 1;
  
  // Ocean waves at bottom
  ctx.fillStyle = '#0a1520';
  ctx.beginPath();
  ctx.moveTo(0, canvas.height);
  for (let x = 0; x <= canvas.width; x += 20) {
    const y = canvas.height - 50 + Math.sin(x * 0.02 + frameCount * 0.03) * 10;
    ctx.lineTo(x, y);
  }
  ctx.lineTo(canvas.width, canvas.height);
  ctx.fill();
  
  // Draw order matters
  drawFog();
  drawBeam();
  drawLighthouse();
  drawLightParticles();
  
  // Vignette
  const vignette = ctx.createRadialGradient(
    canvas.width/2, canvas.height/2, canvas.height * 0.3,
    canvas.width/2, canvas.height/2, canvas.height
  );
  vignette.addColorStop(0, 'transparent');
  vignette.addColorStop(1, 'rgba(0, 0, 0, 0.7)');
  ctx.fillStyle = vignette;
  ctx.fillRect(0, 0, canvas.width, canvas.height);
}

function gameLoop() {
  update();
  render();
  requestAnimationFrame(gameLoop);
}

function startGame() {
  document.getElementById('startOverlay').classList.add('hidden');
  document.getElementById('gameOverOverlay').classList.add('hidden');

  FOG_PARTICLES.length = 0;
  LIGHT_PARTICLES.length = 0;
  frameCount = 0;
  survivalTime = 0;
  lightPower = 100;
  beamAngle = -Math.PI / 2;
  fogDestroyed = 0;

  document.getElementById('time').textContent = '0';
  document.getElementById('fogCount').textContent = '0';
  document.getElementById('powerFill').style.width = '100%';
  document.getElementById('submitSection').style.display = 'flex';

  gameRunning = true;
}

function gameOver() {
  gameRunning = false;
  document.getElementById('finalTime').textContent = survivalTime + 's';
  document.getElementById('finalFog').textContent = fogDestroyed;
  document.getElementById('gameOverOverlay').classList.remove('hidden');
  loadLeaderboard();
}

async function loadLeaderboard() {
  const lbList = document.getElementById('lbList');
  lbList.innerHTML = '<div style="color:#666">Loading...</div>';

  try {
    if (!supabaseClient) {
      const session = await window.supabaseSession();
      supabaseClient = session.client;
      userId = session.user.id;
    }

    const { data, error } = await supabaseClient
      .from('lighthouse_scores')
      .select('player_name, survival_time, fog_destroyed')
      .order('survival_time', { ascending: false })
      .limit(5);

    if (error) throw error;

    if (!data || data.length === 0) {
      lbList.innerHTML = '<div style="color:#666">No scores yet - be the first!</div>';
      return;
    }

    lbList.innerHTML = data.map((row, i) => `
      <div class="lb-row">
        <span class="lb-name">${i+1}. ${row.player_name || 'Anonymous'}</span>
        <span><span class="lb-time">${row.survival_time}s</span> <span class="lb-fog">(${row.fog_destroyed} fog)</span></span>
      </div>
    `).join('');
  } catch (e) {
    console.error('Leaderboard error:', e);
    lbList.innerHTML = '<div style="color:#666">Could not load scores</div>';
  }
}

async function submitScore() {
  const nameInput = document.getElementById('playerName');
  const name = nameInput.value.trim() || 'Anonymous';

  try {
    if (!supabaseClient) {
      const session = await window.supabaseSession();
      supabaseClient = session.client;
      userId = session.user.id;
    }

    const { error } = await supabaseClient
      .from('lighthouse_scores')
      .insert({
        player_name: name,
        survival_time: survivalTime,
        fog_destroyed: fogDestroyed,
        user_id: userId
      });

    if (error) throw error;

    document.getElementById('submitSection').style.display = 'none';
    loadLeaderboard();
  } catch (e) {
    console.error('Submit error:', e);
    alert('Could not save score');
  }
}

// Events
document.getElementById('startBtn').addEventListener('click', startGame);
document.getElementById('restartBtn').addEventListener('click', startGame);
document.getElementById('submitBtn').addEventListener('click', submitScore);

canvas.addEventListener('mousemove', e => {
  mouseX = e.clientX;
  mouseY = e.clientY;
});

canvas.addEventListener('touchmove', e => {
  e.preventDefault();
  mouseX = e.touches[0].clientX;
  mouseY = e.touches[0].clientY;
});

canvas.addEventListener('touchstart', e => {
  e.preventDefault();
  mouseX = e.touches[0].clientX;
  mouseY = e.touches[0].clientY;
});

window.addEventListener('resize', resize);

resize();
mouseX = canvas.width / 2;
mouseY = 0;
gameLoop();
</script>
</body>
</html>
