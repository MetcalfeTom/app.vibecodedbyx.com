<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ðŸš€ ABSURD STARSHIP BRIDGE â€” Chaotic Control Center</title>
  <link rel="icon" href="https://emojicdn.elk.sh/ðŸš€">

  <!-- Open Graph Meta Tags -->
  <meta property="og:title" content="ðŸš€ ABSURD STARSHIP BRIDGE â€” Chaotic Control Center">
  <meta property="og:description" content="Mash buttons. Twist knobs. Engage improbable drives. An absurd, interactive starship control center built live.">
  <meta property="og:url" content="https://app.vibecodedbyx.com/absurd-control-center">
  <meta property="og:image" content="https://app.vibecodedbyx.com/absurd-control-center/control-center-preview.png">
  <meta property="og:type" content="website">

  <style>
    :root {
      --bg: #030614;
      --panel: #0b1026;
      --panel2: #0e1430;
      --acc: #00f0ff;
      --acc2: #ff3cf3;
      --ok: #11d36d;
      --warn: #ffcc00;
      --err: #ff2b55;
      --grid-gap: 12px;
      --glass: rgba(255,255,255,0.06);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: radial-gradient(1200px 800px at 70% -10%, #111a42 0%, transparent 60%),
                  radial-gradient(1000px 600px at 20% 120%, #1b1138 0%, transparent 60%),
                  var(--bg);
      color: #cfe9ff;
      font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      overflow: hidden;
    }

    /* Starfield */
    .stars, .stars2, .stars3 {
      position: fixed; inset: 0; pointer-events: none; z-index: 0;
      background-repeat: repeat;
      background-position: 0 0;
      animation: drift linear infinite;
      opacity: .5;
    }
    .stars { background-image: radial-gradient(2px 2px at 20px 30px, #fff 40%, transparent 42%), radial-gradient(2px 2px at 120px 80px, #aef 40%, transparent 42%); background-size: 200px 200px; animation-duration: 120s; }
    .stars2 { background-image: radial-gradient(1px 1px at 60px 90px, #9ff 50%, transparent 52%), radial-gradient(1px 1px at 160px 140px, #fff 50%, transparent 52%); background-size: 240px 240px; animation-duration: 80s; opacity:.35; }
    .stars3 { background-image: radial-gradient(1px 1px at 10px 40px, #aaf 50%, transparent 52%), radial-gradient(1px 1px at 110px 100px, #ddf 50%, transparent 52%); background-size: 300px 300px; animation-duration: 60s; opacity:.25; }
    @keyframes drift { from { background-position: 0 0; } to { background-position: 0 1000px; } }

    /* Layout */
    .wrap {
      position: relative; z-index: 1;
      height: 100vh; width: 100vw; padding: 14px; display: grid;
      grid-template-columns: 1.1fr 1fr 1fr 1.1fr; grid-template-rows: auto 0.9fr 1fr auto;
      gap: var(--grid-gap);
    }
    @media (max-width: 1200px) {
      .wrap { grid-template-columns: 1fr 1fr; grid-template-rows: auto 0.6fr 1fr 1fr auto; }
      .viewscreen { grid-column: 1 / -1; }
    }
    @media (max-width: 820px) {
      .wrap { grid-template-columns: 1fr; grid-template-rows: auto 0.6fr repeat(4, auto) 1fr auto; overflow: auto; }
    }

    .titlebar {
      grid-column: 1 / -1;
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 14px; background: linear-gradient(135deg, var(--panel), var(--panel2));
      border: 1px solid #1b2352; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .titlebar h1 { margin: 0; font-size: clamp(16px, 2.4vw, 28px); letter-spacing: .08em; }
    .badge { font-size: 12px; padding: 6px 10px; border-radius: 999px; background: var(--glass); border: 1px solid #2a3770; }

    /* Mode bar (tabs) */
    .modebar { grid-column: 1 / -1; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; padding: 8px 10px; background: linear-gradient(135deg, var(--panel), var(--panel2)); border: 1px solid #1b2352; border-radius: 10px; box-shadow: 0 6px 16px rgba(0,0,0,.25); }
    .chip { padding: 6px 10px; border: 1px solid #2a3770; background: var(--glass); border-radius: 999px; cursor: pointer; user-select: none; font-size: 12px; color:#cfe9ff; }
    .chip.active { background: rgba(0,255,255,0.1); box-shadow: 0 0 12px rgba(0,255,255,.25) inset; }

    .workbar { grid-column: 1 / -1; display:none; gap:8px; padding: 6px 8px; align-items:center; }
    .workbar .chip { font-size: 11px; }

    /* Components dropdown */
    #compMenu { position:absolute; z-index:9999; display:none; background: linear-gradient(180deg, #0a1030, #0b0f2a); border:1px solid #2a3770; border-radius:10px; padding:10px; color:#cfe9ff; box-shadow: 0 20px 60px rgba(0,0,0,.45); }
    #compMenu h3 { margin:0 0 6px; font-size:12px; letter-spacing:.1em; color:#9bc9ff; }
    #compMenu label { display:flex; align-items:center; gap:8px; font-size:12px; margin:4px 0; cursor:pointer; }
    #compMenu .row { display:flex; gap:8px; margin-top:8px; }

    .panel {
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid #1b2352; border-radius: 12px; padding: 12px; min-height: 120px;
      box-shadow: 0 8px 24px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
      position: relative; z-index: 1;
    }
    .panel h2 { margin: 0 0 10px; font-size: 14px; letter-spacing: .2em; color: #9bc9ff; }
    .row { display: flex; gap: 10px; align-items: stretch; }
    .col { flex: 1; }

    /* LEDs */
    .led { width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; box-shadow: 0 0 10px currentColor; display: inline-block; vertical-align: middle; }
    .ok { color: var(--ok); }
    .warn { color: var(--warn); }
    .err { color: var(--err); }

    /* Toggle switches */
    .toggle { display: inline-flex; align-items: center; gap: 8px; padding: 8px 10px; background: var(--glass); border: 1px solid #2a3770; border-radius: 10px; cursor: pointer; user-select: none; }
    .switch {
      --w: 42px; --h: 22px; position: relative; width: var(--w); height: var(--h);
      background: #0c1536; border: 1px solid #2a3770; border-radius: 999px; transition: .2s ease;
    }
    .knob { position: absolute; top: 2px; left: 2px; width: 18px; height: 18px; border-radius: 50%; background: linear-gradient(#d6f9ff, #7cd3ff); box-shadow: 0 2px 8px rgba(0,0,0,.4); transition: .2s ease; }
    .switch.on { background: #082a2a; box-shadow: inset 0 0 14px #00fff7; }
    .switch.on .knob { transform: translateX(20px); }

    /* Sliders */
    .slider { appearance: none; width: 100%; height: 10px; border-radius: 999px; background: #122052; outline: none; border: 1px solid #2a3770; }
    .slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: radial-gradient(#fff, #9cf); border: 1px solid #5aa9ff; box-shadow: 0 0 14px #48f; cursor: pointer; }

    /* Radar */
    #radar { width: 100%; aspect-ratio: 1 / 1; background: radial-gradient(closest-side, #071a1a, #051010 60%, transparent 61%), repeating-radial-gradient(#0c4040 0 1px, transparent 1px 20px); border: 1px solid #214; border-radius: 12px; }

    /* Viewscreen (CRT) */
    .viewscreen { grid-column: 1 / -1; display:grid; grid-template-columns: 1fr 300px; gap: var(--grid-gap); z-index: 0; }
    .crt {
      position: relative; background: #02060f; border: 1px solid #223; border-radius: 12px; overflow: hidden;
      box-shadow: inset 0 -40px 80px rgba(0,0,0,.45);
    }
    .crt .scanlines { position:absolute; inset:0; pointer-events:none; background: repeating-linear-gradient(transparent, transparent 2px, rgba(255,255,255,.03) 3px); mix-blend-mode: screen; z-index: 0; }
    #viewscreen { width: 100%; height: 100%; display:block; }
    .ship-stats { display:grid; grid-template-rows: auto 1fr; gap: 10px; }
    .stat {
      background: var(--glass); border: 1px solid #2a3770; border-radius: 10px; padding: 10px; font-size: 13px;
    }
    .bar { height: 8px; background:#112; border-radius: 99px; overflow:hidden; border:1px solid #2a3770; }
    .bar > i { display:block; height:100%; background: linear-gradient(90deg, #29ffd3, #0099ff); width: 50%; }

    /* Big red button */
    .brb { display: grid; place-items: center; padding: 12px; }
    .brb button { position: relative; z-index: 10; width: 160px; height: 160px; border-radius: 50%; border: 0; background: radial-gradient(circle at 35% 35%, #ff6b6b, #b8002a); box-shadow: inset 0 6px 12px rgba(255,255,255,.35), inset 0 -10px 22px rgba(0,0,0,.5), 0 16px 40px rgba(255,0,64,.35); color: #ffd5de; font-size: 18px; letter-spacing: .2em; cursor: pointer; transition: transform .05s ease; }
    .brb button:active { transform: translateY(2px) scale(.98); }
    .brb small { color: #ff9fb2; letter-spacing: .3em; }

    /* Terminal */
    .term { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: #080d20; border: 1px solid #222d66; border-radius: 10px; padding: 8px 10px; height: 160px; overflow: auto; box-shadow: inset 0 0 24px rgba(0,0,0,.35); }
    .line { white-space: pre; }
    .muted { opacity: .7; }

    /* Overlay meltdown */
    .overlay { position: fixed; inset: 0; background: rgba(255,0,70,.06); backdrop-filter: blur(3px); display: none; place-items: center; z-index: 3; }
    .overlay .card { background: #12000a; border: 1px solid #ff8aa6; color: #ffdfe7; padding: 22px; border-radius: 12px; width: min(540px, 90vw); box-shadow: 0 30px 80px rgba(255,0,64,.25); text-align: center; }
    .glitch { position: relative; display: inline-block; font-weight: 900; font-size: 28px; letter-spacing: .15em; }
    .glitch::before, .glitch::after { content: attr(data-txt); position: absolute; inset: 0; mix-blend-mode: screen; }
    .glitch::before { color: #ff3cf3; transform: translateX(-2px); animation: g1 .7s infinite alternate; }
    .glitch::after { color: #00f0ff; transform: translateX(2px); animation: g2 .7s infinite alternate; }
    @keyframes g1 { to { transform: translateX(-4px); } }
    @keyframes g2 { to { transform: translateX(4px); } }

    /* Backlink */
    .backlink { grid-column: 1 / -1; text-align: center; color: #9bc9ff; font-size: 12px; opacity: .9; }
    .backlink a { color: #bfe2ff; }

    /* Oscilloscope */
    #scope { width:100%; height:160px; display:block; background:#01050e; border:1px solid #213; border-radius:8px; }

    /* Power matrix */
    .matrix { display:grid; grid-template-columns: repeat(10, 1fr); gap:4px; }
    .cell { aspect-ratio: 1/1; background:#0a1638; border:1px solid #2a3770; border-radius:4px; box-shadow: inset 0 0 10px rgba(0,0,0,.4); cursor:pointer; }
    .cell.on { background: radial-gradient(circle at 30% 30%, #4ff, #09a); box-shadow: 0 0 12px #0ff inset, 0 0 14px rgba(0,255,255,.35); }
    .statline { display:flex; gap:10px; align-items:center; font-size:12px; color:#9bc9ff; }

    /* Windowed panels */
    .win { position: absolute !important; resize: both; overflow: auto; }
    .win h2 { cursor: move; user-select: none; }
  </style>
</head>
<body>
  <div class="stars"></div>
  <div class="stars2"></div>
  <div class="stars3"></div>

  <div class="wrap">
    <div class="titlebar">
      <h1>ABSURD STARSHIP BRIDGE</h1>
      <div>
        <span class="badge">SHIP ID: XS-âˆž-CHAOS</span>
        <span class="badge" id="clock">00:00:00</span>
      </div>
    </div>

    <div class="modebar" id="modebar">
      <div class="chip active" data-mode="bridge">Bridge</div>
      <div class="chip" data-mode="nav">Navigation</div>
      <div class="chip" data-mode="command">Command</div>
      <div class="chip" data-mode="systems">Systems</div>
      <div class="chip" data-mode="engineering">Engineering</div>
      <div class="chip" data-mode="sensors">Sensors</div>
      <div class="chip" data-mode="comms">Comms</div>
      <div class="chip" data-mode="all">All</div>
      <div class="chip" data-mode="hybrid">Hybrid</div>
      <div class="chip" data-action="tile">Tile</div>
      <div class="chip" data-action="cascade">Cascade</div>
      <div class="chip" data-action="reset">Reset</div>
      <div class="chip" data-action="lock">Lock</div>
      <div class="chip" data-action="components" id="componentsBtn">Components â–¾</div>
    </div>

    <div class="workbar" id="workbar">
      <div class="chip" data-work="nav">Nav</div>
      <div class="chip" data-work="systems">Systems</div>
      <div class="chip" data-work="engineering">Eng</div>
      <div class="chip" data-work="sensors">Sensors</div>
    </div>

    <!-- Components dropdown (populated by JS) -->
    <div id="compMenu"></div>

    <!-- Top viewscreen spanning full width -->
    <div class="panel viewscreen" data-pane="bridge">
      <div class="crt">
        <canvas id="viewscreen"></canvas>
        <div class="scanlines"></div>
      </div>
      <div class="ship-stats">
        <div class="stat">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>REACTOR LOAD</div><div id="reactorPct">64%</div>
          </div>
          <div class="bar"><i id="reactorBar" style="width:64%"></i></div>
        </div>
        <div class="stat">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>SHIELDS</div><div id="shieldsPct">42%</div>
          </div>
          <div class="bar"><i id="shieldsBar" style="width:42%;background:linear-gradient(90deg,#00ffa8,#00b3ff)"></i></div>
        </div>
        <div class="stat">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>CHAOS</div><div id="chaosPct">13%</div>
          </div>
          <div class="bar"><i id="chaosBar" style="width:13%;background:linear-gradient(90deg,#ff3cf3,#ff8253)"></i></div>
        </div>
      </div>
    </div>

    <div class="panel col" id="panel-nav" data-pane="nav">
      <h2>NAVIGATION â€” WARP TO INCONVENIENT COORDINATES</h2>
      <div class="row">
        <div class="col">
          <label class="toggle" id="t-warp"><span class="led ok"></span>Warp Field</label>
        </div>
        <div class="col">
          <label class="toggle" id="t-stability"><span class="led warn"></span>Stability Dampers</label>
        </div>
      </div>
      <div style="margin-top:10px">
        <div style="display:flex;align-items:center;gap:10px;">
          <div style="width:110px;opacity:.8">Warp Factor</div>
          <input type="range" min="0" max="10" step="1" value="3" class="slider" id="warpFactor">
          <div id="warpReadout" style="min-width:56px;text-align:right;">WF 3</div>
        </div>
      </div>
      <div style="margin-top:10px;display:grid;grid-template-columns: 1fr 1fr; gap:10px;">
        <div class="panel" style="padding:8px;">
          <h2 style="margin-bottom:6px">RADAR â€” THINGS</h2>
          <canvas id="radar"></canvas>
        </div>
        <div class="panel" style="padding:8px;">
          <h2 style="margin-bottom:6px">ANOMALY DIAL</h2>
          <input type="range" min="0" max="100" value="42" class="slider" id="anomaly">
          <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
            <label class="toggle" id="t-ludicrous"><span class="led ok"></span>Ludicrous Mode</label>
            <label class="toggle" id="t-improb"><span class="led warn"></span>Improbability</label>
            <label class="toggle" id="t-caffe"><span class="led ok"></span>Coffee Feed</label>
          </div>
        </div>
      </div>
    </div>

    <div class="panel col" id="panel-center" data-pane="command">
      <h2>GIGANTIC BUTTON â€” DO NOT PRESS</h2>
      <div class="brb">
        <button id="doNotPress">DO NOT PRESS</button>
        <small>Seriously. It voids the spacecraft warranty.</small>
      </div>
      <div class="panel" style="margin-top:12px;">
        <h2>EVENT LOG</h2>
        <div class="term" id="log"></div>
      </div>
    </div>

    <div class="panel col" id="panel-right" data-pane="systems">
      <h2>SUBSYSTEMS â€” TOTALLY NORMAL</h2>
      <div style="display:grid;grid-template-columns:1fr; gap:8px;">
        <label class="toggle" id="t-shields"><span class="led ok"></span>Shields (makes noises)</label>
        <label class="toggle" id="t-cloak"><span class="led warn"></span>Budget Cloak</label>
        <label class="toggle" id="t-tractor"><span class="led ok"></span>Tractor (for snacks)</label>
        <label class="toggle" id="t-spork"><span class="led err"></span>Spork Array</label>
        <div class="panel" style="padding:8px;">
          <h2 style="margin-bottom:6px">TRANSLATOR</h2>
          <div style="display:flex;gap:6px;align-items:center;">
            <input id="alienText" placeholder="Type human words" style="flex:1; background:#0b1333;border:1px solid #2a3770;border-radius:8px;color:#cfe9ff;padding:8px 10px;">
            <button id="translate" style="background:#11225c;color:#cfe9ff;border:1px solid #2a3770;border-radius:8px;padding:8px 10px;">Translate</button>
          </div>
          <div id="alienOut" style="margin-top:8px;opacity:.9"></div>
        </div>
      </div>
    </div>

    <!-- Bottom row: Engineering, Sensors, Comms -->
    <div class="panel" id="panel-eng" data-pane="engineering">
      <h2>ENGINEERING â€” POWER MATRIX</h2>
      <div class="matrix" id="matrix"></div>
      <div class="statline" style="margin-top:8px;">
        <span class="led ok"></span><span>Active Nodes: <b id="nodesOn">0</b>/100</span>
        <span style="margin-left:auto;">Grid Load: <b id="gridLoad">0%</b></span>
      </div>
    </div>

    <div class="panel" id="panel-sensors" data-pane="sensors">
      <h2>SENSORS â€” OSCILLOSCOPE</h2>
      <canvas id="scope"></canvas>
    </div>

    <div class="panel" id="panel-comms" data-pane="comms">
      <h2>COMMS â€” TRANSMISSIONS</h2>
      <div style="display:flex;gap:8px;">
        <button id="ping" style="background:#11225c;color:#cfe9ff;border:1px solid #2a3770;border-radius:8px;padding:8px 10px;">Send Ping</button>
        <button id="distress" style="background:#3f0f1f;color:#ffd5de;border:1px solid #6a1f39;border-radius:8px;padding:8px 10px;">Send Distress</button>
      </div>
      <div class="term" id="comms" style="height:120px;margin-top:8px;"></div>
    </div>

    <div class="backlink">Built absurdly live at <a href="https://www.vibecodedbyx.com" target="_blank">VibeCodedByX.com</a></div>
  </div>

  <div class="overlay" id="overlay">
    <div class="card">
      <div class="glitch" data-txt="WARRANTY VOIDED">WARRANTY VOIDED</div>
      <p style="margin:8px 0 0">The ship is now powered by pure audacity.</p>
      <button id="ack" style="margin-top:12px;background:#1c2b6a;color:#cfe9ff;border:1px solid #2a3770;border-radius:8px;padding:10px 14px;cursor:pointer;">Acknowledge</button>
    </div>
  </div>

  <script type="module">
    import { initRadar } from './js/radar.js';
    import { initViewscreen } from './js/viewscreen.js';
    import { initScope } from './js/scope.js';
    import { initComms } from './js/comms.js';
    import { initTranslator } from './js/translator.js';
    // Simple time
    const clockEl = document.getElementById('clock');
    setInterval(() => { const d = new Date(); clockEl.textContent = d.toLocaleTimeString(); }, 500);

    // Audio system (soft bleeps)
    let ac; const ensureAC = () => { if (!ac) ac = new (window.AudioContext || window.webkitAudioContext)(); if (ac.state === 'suspended') ac.resume(); };
    function beep(freq = 440, dur = 0.07, type='square') { try { ensureAC(); const o = ac.createOscillator(); o.type = type; o.frequency.value = freq; const g = ac.createGain(); g.gain.value = 0.03; o.connect(g).connect(ac.destination); o.start(); o.stop(ac.currentTime + dur); } catch(e){} }

    // Log
    const log = document.getElementById('log');
    function logLine(msg, cls='') {
      const el = document.createElement('div'); el.className = 'line ' + cls; el.textContent = '['+new Date().toLocaleTimeString()+'] ' + msg; log.prepend(el);
    }

    // Toggles (persisted)
    function wireToggle(id, onMsg, offMsg, toneOn=640, toneOff=320) {
      const el = document.getElementById(id);
      const sw = document.createElement('div'); sw.className = 'switch'; sw.innerHTML = '<div class="knob"></div>';
      el.appendChild(sw);
      let on = localStorage.getItem('toggle_'+id) === '1';
      sw.classList.toggle('on', on);
      el.addEventListener('click', () => {
        on = !on; sw.classList.toggle('on', on); beep(on ? toneOn : toneOff, 0.08, 'sine');
        logLine((on? 'ENGAGED: ' : 'DISENGAGED: ') + (on ? onMsg : offMsg), on ? '' : 'muted');
        localStorage.setItem('toggle_'+id, on ? '1' : '0');
      });
    }

    wireToggle('t-warp', 'Warp Field', 'Warp Field');
    wireToggle('t-stability', 'Stability Dampers', 'Stability Dampers', 540, 280);
    wireToggle('t-ludicrous', 'Ludicrous Mode', 'Ludicrous Mode', 880, 220);
    wireToggle('t-improb', 'Improbability Drive', 'Improbability Drive', 740, 260);
    wireToggle('t-caffe', 'Espresso Feed', 'Espresso Feed', 660, 200);
    wireToggle('t-shields', 'Shield Envelope', 'Shield Envelope', 520, 200);
    wireToggle('t-cloak', 'Cloak (budget)', 'Cloak (budget)', 400, 180);
    wireToggle('t-tractor', 'Tractor Beam', 'Tractor Beam', 480, 220);
    wireToggle('t-spork', 'Spork Array', 'Spork Array', 300, 160);

    // Sliders
    const warp = document.getElementById('warpFactor');
    const warpRO = document.getElementById('warpReadout');
    warp.addEventListener('input', () => { warpRO.textContent = 'WF ' + warp.value; beep(200 + warp.value*40, 0.03, 'triangle'); });

    const anomaly = document.getElementById('anomaly');
    anomaly.addEventListener('input', () => { const j = Math.random(); if (j > 0.96) logLine('ANOMALY SPIKE x' + (1 + Math.random()*9).toFixed(1) + ' (harmless)'); });

    // Radar
    initRadar(document.getElementById('radar'));

    // Viewscreen animation (nebula + streaks)
    initViewscreen(document.getElementById('viewscreen'));

    // Engineering power matrix
    const matrix = document.getElementById('matrix');
    const nodes = []; for (let i=0;i<100;i++){ const c = document.createElement('div'); c.className='cell'; matrix.appendChild(c); nodes.push(c); }
    const nodesOnEl = document.getElementById('nodesOn'); const gridLoadEl = document.getElementById('gridLoad');
    function updateMatrixStats(){ const on = nodes.filter(n=>n.classList.contains('on')).length; nodesOnEl.textContent = on; const load = Math.round(on/100*100); gridLoadEl.textContent = load+'%'; reactor(load); }
    nodes.forEach((c,i)=>{ c.addEventListener('click', ()=>{ c.classList.toggle('on'); beep(300 + (i%10)*10, .03, 'triangle'); updateMatrixStats(); }); });
    function reactor(load){ document.getElementById('reactorPct').textContent = load+'%'; document.getElementById('reactorBar').style.width = load+'%'; document.getElementById('chaosPct').textContent = Math.max(0, Math.min(100, Math.round((load-60)*1.2)))+'%'; document.getElementById('chaosBar').style.width = Math.max(0, Math.min(100, Math.round((load-60)*1.2)))+'%'; }
    updateMatrixStats();

    // Oscilloscope
    initScope(document.getElementById('scope'));

    // Shields % tick from toggle and radar intensity
    setInterval(()=>{ const on = localStorage.getItem('toggle_t-shields')==='1'; const base = on? 50:20; const jitter = Math.floor(Math.random()*20); const v = Math.min(100, base + jitter); document.getElementById('shieldsPct').textContent = v+'%'; document.getElementById('shieldsBar').style.width = v+'%'; }, 1200);

    // Comms
    initComms({ commsEl: document.getElementById('comms'), pingBtn: document.getElementById('ping'), distressBtn: document.getElementById('distress'), beep });

    // Do Not Press
    const overlay = document.getElementById('overlay');
    document.getElementById('doNotPress').addEventListener('click', () => {
      beep(120, .2, 'sawtooth'); beep(180, .2, 'sawtooth'); beep(90, .4, 'square');
      overlay.style.display = 'grid';
      logLine('BUTTON PRESSED â€” initiating chaos subroutineâ€¦');
      setTimeout(()=>logLine('Warranty: void. Thrill levels: adequate.'), 600);
    });
    document.getElementById('ack').addEventListener('click', () => { overlay.style.display = 'none'; beep(520, .06, 'sine'); });

    // Translator â€” absurd mapping
    initTranslator({ inputEl: document.getElementById('alienText'), buttonEl: document.getElementById('translate'), outputEl: document.getElementById('alienOut'), beep });

    // Warm welcome
    const bootLines = [
      'Bridge online. Running preposterous diagnosticsâ€¦',
      'Quantum foam: pleasantly bubbly.',
      'Snacks inventory: dangerously low.',
      'Awaiting captain chaos.'
    ];
    let i=0; const bootIv = setInterval(()=>{ if(i>=bootLines.length) return clearInterval(bootIv); logLine(bootLines[i++]); }, 400);

    // Window manager
    const modebar = document.getElementById('modebar');
    const workbar = document.getElementById('workbar');
    const compMenu = document.getElementById('compMenu');
    const componentsBtn = document.getElementById('componentsBtn');
    const panes = Array.from(document.querySelectorAll('[data-pane]'));
    panes.forEach(p => p.classList.add('win'));
    let dragging = null, dragOffsetX = 0, dragOffsetY = 0, zTop = 50, layoutLocked = false;

    function bringFront(el){ el.style.zIndex = ++zTop; }

    function bindDrag(win){
      const head = win.querySelector('h2'); if(!head) return;
      head.addEventListener('mousedown', (e)=>{
        if (layoutLocked) return;
        dragging = win; bringFront(win);
        const rect = win.getBoundingClientRect();
        dragOffsetX = e.clientX - rect.left; dragOffsetY = e.clientY - rect.top;
        document.addEventListener('mousemove', onDrag);
        document.addEventListener('mouseup', endDrag, { once: true });
      });
    }
    function onDrag(e){ if(!dragging) return; const pad = 8; const maxX = window.innerWidth - pad - dragging.offsetWidth; const maxY = window.innerHeight - pad - dragging.offsetHeight; let x = e.clientX - dragOffsetX; let y = e.clientY - dragOffsetY; x = Math.max(pad, Math.min(maxX, x)); y = Math.max(100, Math.min(maxY, y)); dragging.style.left = x + 'px'; dragging.style.top = y + 'px'; }
    function endDrag(){ document.removeEventListener('mousemove', onDrag); if (dragging) bringFront(dragging); saveLayout(); dragging = null; }

    panes.forEach(p => bindDrag(p));

    function placeDefaults(){
      const topBarH = document.querySelector('.titlebar').getBoundingClientRect().height + document.getElementById('modebar').getBoundingClientRect().height + 16;
      const W = window.innerWidth, H = window.innerHeight - topBarH - 20;
      const positions = {
        bridge: { x: 12, y: topBarH + 8, w: Math.min(W-24, W*0.66), h: Math.min(H*0.5, 360) },
        nav: { x: 12, y: topBarH + 20 + (H*0.5), w: Math.min(W*0.45, 560), h: 280 },
        command: { x: Math.min(W*0.48, 620), y: topBarH + 20 + (H*0.5), w: Math.min(W*0.48, 560), h: 280 },
        systems: { x: Math.min(W*0.70, 820), y: topBarH + 8, w: Math.min(W*0.28, 380), h: 360 },
        engineering: { x: Math.min(W*0.70, 820), y: topBarH + 380, w: Math.min(W*0.28, 380), h: 260 },
        sensors: { x: Math.min(W*0.38, 480), y: topBarH + 8, w: Math.min(W*0.30, 420), h: 180 },
        comms: { x: Math.min(W*0.38, 480), y: topBarH + 200, w: Math.min(W*0.30, 420), h: 180 },
      };
      panes.forEach(p => {
        const key = p.dataset.pane; const conf = positions[key] || { x: 20, y: topBarH + 20, w: 400, h: 260 };
        p.style.left = conf.x + 'px'; p.style.top = conf.y + 'px'; p.style.width = conf.w + 'px'; p.style.height = conf.h + 'px';
        bringFront(p);
      });
      saveLayout();
    }

    // Layout persistence
    const LKEY = 'bridge_layout_v1';
    function saveLayout(){ const s={}; panes.forEach(p=>{ s[p.dataset.pane] = { left:p.style.left, top:p.style.top, width:p.style.width, height:p.style.height, z:p.style.zIndex }; }); localStorage.setItem(LKEY, JSON.stringify(s)); }
    function loadLayout(){ try{ return JSON.parse(localStorage.getItem(LKEY)||'{}'); } catch(e){ return {}; } }
    function applySavedLayout(){ const s = loadLayout(); Object.entries(s).forEach(([k,v])=>{ const p = panes.find(pp=>pp.dataset.pane===k); if(!p) return; if(v.left) p.style.left=v.left; if(v.top) p.style.top=v.top; if(v.width) p.style.width=v.width; if(v.height) p.style.height=v.height; if(v.z) p.style.zIndex=v.z; }); }

    function tileLayout(){
      const visible = panes.filter(p => p.style.display !== 'none');
      const topBarH = document.querySelector('.titlebar').getBoundingClientRect().height + document.getElementById('modebar').getBoundingClientRect().height + 16;
      const areaW = window.innerWidth - 16, areaH = window.innerHeight - topBarH - 16;
      const n = visible.length; const cols = Math.ceil(Math.sqrt(n)); const rows = Math.ceil(n / cols);
      const cellW = Math.floor(areaW / cols) - 12; const cellH = Math.floor(areaH / rows) - 12;
      visible.forEach((p, i) => { const c = i % cols, r = Math.floor(i / cols); p.style.left = (8 + c*(cellW+12)) + 'px'; p.style.top = (topBarH + 8 + r*(cellH+12)) + 'px'; p.style.width = cellW + 'px'; p.style.height = cellH + 'px'; });
      saveLayout();
    }
    function cascadeLayout(){
      const visible = panes.filter(p => p.style.display !== 'none');
      const topBarH = document.querySelector('.titlebar').getBoundingClientRect().height + document.getElementById('modebar').getBoundingClientRect().height + 16;
      let x=20,y=topBarH+20; visible.forEach((p,i)=>{ p.style.left = x + 'px'; p.style.top = y + 'px'; p.style.width = '520px'; p.style.height = '300px'; x+=30; y+=24; if (x>window.innerWidth-540) x=20; if (y>window.innerHeight-340) y=topBarH+20; });
      saveLayout();
    }

    // Component visibility state
    const componentsList = [
      { key:'bridge', label:'Viewscreen' },
      { key:'nav', label:'Navigation' },
      { key:'command', label:'Command' },
      { key:'systems', label:'Systems' },
      { key:'engineering', label:'Engineering' },
      { key:'sensors', label:'Sensors' },
      { key:'comms', label:'Comms' },
    ];
    function defaultCompState(){ const s={}; componentsList.forEach(c=>s[c.key]=true); return s; }
    function getCompState(){ try{ return Object.assign(defaultCompState(), JSON.parse(localStorage.getItem('bridge_components')||'{}')); } catch(e){ return defaultCompState(); } }
    function saveCompState(s){ localStorage.setItem('bridge_components', JSON.stringify(s)); }
    function applyComponentVisibility(){ const s = getCompState(); panes.forEach(p=>{ p.style.display = s[p.dataset.pane] ? '' : 'none'; }); }

    function renderCompMenu(){
      const s = getCompState();
      compMenu.innerHTML = '';
      const rect = componentsBtn.getBoundingClientRect();
      compMenu.style.left = Math.min(window.innerWidth - 240, rect.left) + 'px';
      compMenu.style.top = (rect.bottom + 8) + 'px';
      const head = document.createElement('h3'); head.textContent = 'Components'; compMenu.appendChild(head);
      componentsList.forEach(c=>{
        const lab = document.createElement('label');
        const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !!s[c.key]; cb.addEventListener('change', ()=>{ s[c.key]=cb.checked; saveCompState(s); if (document.querySelector('.chip.active')?.dataset.mode === 'all') { applyComponentVisibility(); tileLayout(); } });
        lab.appendChild(cb); lab.appendChild(document.createTextNode(c.label)); compMenu.appendChild(lab);
      });
      const row = document.createElement('div'); row.className='row';
      const allBtn = document.createElement('div'); allBtn.className='chip'; allBtn.textContent='Show All'; allBtn.addEventListener('click', ()=>{ const s=defaultCompState(); saveCompState(s); renderCompMenu(); if (document.querySelector('.chip.active')?.dataset.mode === 'all') { applyComponentVisibility(); tileLayout(); } });
      const noneBtn = document.createElement('div'); noneBtn.className='chip'; noneBtn.textContent='Hide All'; noneBtn.addEventListener('click', ()=>{ const s={}; componentsList.forEach(c=>s[c.key]=false); saveCompState(s); renderCompMenu(); if (document.querySelector('.chip.active')?.dataset.mode === 'all') { applyComponentVisibility(); tileLayout(); } });
      row.appendChild(allBtn); row.appendChild(noneBtn); compMenu.appendChild(row);
    }
    componentsBtn.addEventListener('click', (e)=>{ e.stopPropagation(); renderCompMenu(); compMenu.style.display = compMenu.style.display==='block' ? 'none':'block'; });
    document.addEventListener('click', ()=>{ compMenu.style.display = 'none'; });

    // Mode switching: filter visible panes (multi-pane supported)
    let activeWork = 'nav';
    function setMode(mode){
      document.querySelectorAll('.chip').forEach(c=>{ if(c.dataset.mode){ c.classList.toggle('active', c.dataset.mode===mode); }});
      if (mode === 'hybrid') {
        workbar.style.display = 'flex';
        panes.forEach(p => { p.style.display = (p.dataset.pane==='bridge' || p.dataset.pane==='command' || p.dataset.pane==='comms' || p.dataset.pane===activeWork) ? '' : 'none'; });
        layoutLocked = true; placeHybrid();
      } else {
        workbar.style.display = 'none'; layoutLocked = false;
        if (mode === 'all') applyComponentVisibility(); else panes.forEach(p => { p.style.display = (p.dataset.pane===mode) ? '' : 'none'; });
        if (mode !== 'all') cascadeLayout(); else tileLayout();
      }
    }
    modebar.addEventListener('click', (e)=>{
      const chip = e.target.closest('.chip'); if(!chip) return;
      if (chip.dataset.action === 'tile') { tileLayout(); return; }
      if (chip.dataset.action === 'cascade') { cascadeLayout(); return; }
      if (chip.dataset.action === 'reset') { localStorage.removeItem('bridge_layout_v1'); placeDefaults(); return; }
      if (chip.dataset.action === 'lock') { layoutLocked = !layoutLocked; chip.classList.toggle('active', layoutLocked); return; }
      if (chip.dataset.mode) setMode(chip.dataset.mode);
    });
    window.addEventListener('resize', ()=>{ if (document.querySelector('.chip.active')?.dataset.mode === 'all') tileLayout(); });

    // Initialize layout
    placeDefaults();
    applySavedLayout();
    applyComponentVisibility();
    setMode('all');
    
    // Persist changes when panes are resized
    const paneObserver = new ResizeObserver(()=>{ if(!layoutLocked) saveLayout(); });
    panes.forEach(p=>paneObserver.observe(p));

    // Workbar handling for Hybrid mode
    function placeHybrid(){
      const topBarH = document.querySelector('.titlebar').getBoundingClientRect().height + document.getElementById('modebar').getBoundingClientRect().height + workbar.getBoundingClientRect().height + 24;
      const W = window.innerWidth - 20, H = window.innerHeight - topBarH - 20;
      const br = document.querySelector('[data-pane="bridge"]');
      const cmd = document.querySelector('[data-pane="command"]');
      const comm = document.querySelector('[data-pane="comms"]');
      const work = document.querySelector('[data-pane="'+activeWork+'"]');
      if (!br || !cmd || !comm || !work) return;
      br.style.left = '12px'; br.style.top = (topBarH - H - 8 + 8 - (H)) + 'px'; // reset top baseline
      br.style.left = '12px'; br.style.top = (document.querySelector('.titlebar').getBoundingClientRect().bottom + document.getElementById('modebar').getBoundingClientRect().height + workbar.getBoundingClientRect().height + 12) + 'px';
      br.style.width = Math.round(W*0.62) + 'px'; br.style.height = Math.round(H*0.52) + 'px';
      cmd.style.left = Math.round(W*0.65) + 'px'; cmd.style.top = br.style.top; cmd.style.width = Math.round(W*0.33) + 'px'; cmd.style.height = Math.round(H*0.34) + 'px';
      work.style.left = '12px'; work.style.top = (parseInt(br.style.top) + Math.round(H*0.52) + 12) + 'px'; work.style.width = Math.round(W*0.62) + 'px'; work.style.height = Math.round(H*0.44) + 'px';
      comm.style.left = Math.round(W*0.65) + 'px'; comm.style.top = work.style.top; comm.style.width = Math.round(W*0.33) + 'px'; comm.style.height = Math.round(H*0.44) + 'px';
      [br, cmd, work, comm].forEach(bringFront);
    }
    workbar.addEventListener('click', (e)=>{
      const c = e.target.closest('.chip'); if (!c) return; activeWork = c.dataset.work; setMode('hybrid');
    });
  </script>
</body>
</html>
