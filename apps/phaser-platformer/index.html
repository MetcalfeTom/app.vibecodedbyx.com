<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Super Mario Bros Clone - Classic Platformer</title>
<link rel="icon" href="https://emojicdn.elk.sh/üçÑ">
<meta property="og:title" content="Super Mario Bros Clone - Play Now">
<meta property="og:description" content="Jump, collect coins, stomp enemies, and reach the castle in this authentic Mario experience">
<meta property="og:url" content="https://app.vibecodedbyx.com/phaser-platformer">
<meta property="og:image" content="https://image.pollinations.ai/prompt/Super%20Mario%20Bros%20classic%20level%201-1%20pixel%20art%20retro%20gaming?width=1200&height=630&referrer=vibecodedbyx.com">
<script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
font-family:'Courier New',monospace;
background:#5c94fc;
display:flex;
justify-content:center;
align-items:center;
min-height:100vh;
padding:20px;
}
#game-container{
max-width:100%;
box-shadow:0 10px 50px rgba(0,0,0,.5);
image-rendering:pixelated;
image-rendering:crisp-edges;
}
.hud{
position:absolute;
top:10px;
left:10px;
font-size:16px;
font-weight:bold;
color:#fff;
text-shadow:2px 2px 0 #000;
z-index:100;
font-family:'Courier New',monospace;
}
.back-link{
position:absolute;
bottom:10px;
left:50%;
transform:translateX(-50%);
background:rgba(0,0,0,.8);
padding:8px 16px;
border-radius:5px;
font-size:12px;
z-index:100;
}
.back-link a{
color:#fff;
text-decoration:none;
}
.back-link a:hover{
color:#ffeb3b;
}
</style>
</head>
<body>
<div id="game-container"></div>
<div class="hud">
<div>MARIO</div>
<div id="score">000000</div>
<div style="margin-top:10px">
<span id="coins">√ó00</span> WORLD TIME
</div>
<div>
<span id="world">1-1</span> <span id="time">400</span>
</div>
<div style="margin-top:10px">
LIVES: <span id="lives">√ó3</span>
</div>
</div>
<div class="back-link">
<a href="https://www.vibecodedbyx.com" target="_blank">‚Üê Back to VibeCodedByX</a>
</div>

<script>
// ==============================================
// AGENT 1: Mario Character & Animations
// ==============================================
// Mario sprite with red shirt, blue overalls
// States: small, big, fire
// Animations: walk, run, jump, crouch

// ==============================================
// AGENT 2: Blocks & Coins
// ==============================================
// Question blocks spawn coins when hit
// Brick blocks break for big Mario
// Coin rotation animation

// ==============================================
// AGENT 3: Enemies
// ==============================================
// Goombas walk and can be stomped
// Koopa Troopas retreat into shell
// Shell kicking mechanics

// ==============================================
// AGENT 4: Power-ups
// ==============================================
// Super Mushroom (grow)
// Fire Flower (fireballs)
// Power-up spawning from blocks

// ==============================================
// AGENT 5: Pipes
// ==============================================
// Green pipes with entry/exit
// Pipe entry animation

// ==============================================
// AGENT 6: Mario Physics
// ==============================================
// Run button (shift), sprint
// Variable jump height
// Momentum and skidding

// ==============================================
// AGENT 7: Level Design
// ==============================================
// Classic 1-1 style layout
// Platforms, pits, stairs
// Castle at end

// ==============================================
// AGENT 8: Audio
// ==============================================
// Jump, coin, power-up sounds
// Background music

// ==============================================
// AGENT 9: Level End
// ==============================================
// Flag pole slide
// Castle entry

// ==============================================
// AGENT 10: HUD
// ==============================================
// Score, coins, world, time, lives

const config={
type:Phaser.AUTO,
width:800,
height:600,
parent:'game-container',
backgroundColor:'#5c94fc',
physics:{
default:'arcade',
arcade:{
gravity:{y:1200},
debug:false
}
},
scene:{
preload:preload,
create:create,
update:update
},
callbacks:{
postBoot:function(game){
game.events.on('error',function(error){
console.error('Phaser Error:',error);
});
}
}
};

let game;
try{
console.log('Starting Phaser game...');
game=new Phaser.Game(config);
console.log('Phaser game created successfully');
}catch(e){
console.error('Error creating Phaser game:',e);
}

// Game state
let player,cursors,shiftKey,platforms,bricks,questionBlocks,coins,enemies,powerups,pipes,flag,castle;
let score=0,coinCount=0,lives=3,time=400,world='1-1';
let marioState='small'; // small, big, fire
let isRunning=false,canJump=true;
let fireballs,fireCooldown=false;
let gameOver=false,levelComplete=false;
let soundEffects={};
let currentScene; // Store scene reference

function preload(){
console.log('Preload function called - creating sprites');
// Create Mario sprite (Agent 1)
createMarioSprite(this);

// Create block sprites (Agent 2)
createBlockSprites(this);

// Create enemy sprites (Agent 3)
createEnemySprites(this);

// Create power-up sprites (Agent 4)
createPowerupSprites(this);

// Create pipe sprites (Agent 5)
createPipeSprites(this);

// Create other sprites
createMiscSprites(this);
}

function createMarioSprite(scene){
// Small Mario - red shirt, blue overalls
const smallMario=[
'........',
'...RRR..',
'..RRRRR.',
'..bbbRb.',
'..bRbbbb',
'.bbbbbb.',
'..bbb...',
'.bb.bb..'
];

// Big Mario
const bigMario=[
'...RRR..',
'..RRRRR.',
'..bbbRb.',
'..bRbbbb',
'..bbbbbb',
'..Rbbbb.',
'..RRRR..',
'.bbRRbb.',
'bbbRRbbb',
'bbbRRbbb',
'..bbb...',
'.bb.bb..',
'bb...bb.'
];

// Fire Mario (red/white)
const fireMario=[
'...RRR..',
'..RRRRR.',
'..WWWRW.',
'..WRWWWW',
'..WWWWWW',
'..RWWWW.',
'..RRRR..',
'.WWRRww.',
'WWWRRWWW',
'WWWRRWWW',
'..WWW...',
'.WW.WW..',
'WW...WW.'
];

// Generate textures
scene.textures.generate('mario-small',{
data:smallMario.map(row=>row.replace(/R/g,'c').replace(/b/g,'1')),
pixelWidth:4,
pixelHeight:4
});

scene.textures.generate('mario-big',{
data:bigMario.map(row=>row.replace(/R/g,'c').replace(/b/g,'1').replace(/W/g,'f')),
pixelWidth:3,
pixelHeight:3
});

scene.textures.generate('mario-fire',{
data:fireMario.map(row=>row.replace(/R/g,'c').replace(/W/g,'f').replace(/w/g,'e')),
pixelWidth:3,
pixelHeight:3
});
}

function createBlockSprites(scene){
// Question block (yellow with ?)
scene.textures.generate('question-block',{
data:['eeeeeeee','e666666e','e6....6e','e6.@@.6e','e6.@@.6e','e6....6e','e666666e','eeeeeeee'],
pixelWidth:4,
pixelHeight:4
});

// Brick block (orange/brown)
scene.textures.generate('brick-block',{
data:['aa.aa.aa','aaaaaaaa','aaaaaaaa','.aa.aa..','aa.aa.aa','aaaaaaaa','aaaaaaaa','.aa.aa..'],
pixelWidth:4,
pixelHeight:4
});

// Ground block (brown)
scene.textures.generate('ground-block',{
data:['88888888','88888888','88888888','88888888','88888888','88888888','88888888','88888888'],
pixelWidth:4,
pixelHeight:4
});

// Coin
scene.textures.generate('coin',{
data:['..6666..','..6666..','.666666.','66666666','66666666','.666666.','..6666..','..6666..'],
pixelWidth:3,
pixelHeight:3
});

// Hit block (gray)
scene.textures.generate('hit-block',{
data:['77777777','77777777','77777777','77777777','77777777','77777777','77777777','77777777'],
pixelWidth:4,
pixelHeight:4
});
}

function createEnemySprites(scene){
// Goomba (brown mushroom enemy)
scene.textures.generate('goomba',{
data:['..aaaa..','..aaaa..','aaaaaaaa','aaffaffa','aaaaaaaa','..aaaa..','..a..a..'],
pixelWidth:4,
pixelHeight:4
});

// Goomba squished
scene.textures.generate('goomba-dead',{
data:['........','........','........','aaffaffa','aaaaaaaa','aaaaaaaa'],
pixelWidth:4,
pixelHeight:4
});

// Koopa (green turtle)
scene.textures.generate('koopa',{
data:['..222...','..222...','..222...','2fffff2.','22ff2f22','2222222.','..22.22.','.22..22.'],
pixelWidth:4,
pixelHeight:4
});

// Koopa shell
scene.textures.generate('koopa-shell',{
data:['........','.222222.','22ffff22','22f22f22','2222222.','.222222.'],
pixelWidth:4,
pixelHeight:4
});
}

function createPowerupSprites(scene){
// Super Mushroom (red with white dots)
scene.textures.generate('mushroom',{
data:['..cccc..','..cccc..','.ccffcc.','cccccccc','cccccccc','..ffff..','..ffff..'],
pixelWidth:4,
pixelHeight:4
});

// Fire Flower (orange with white petals)
scene.textures.generate('fire-flower',{
data:['f.c..c.f','ff.cc.ff','.ffccff.','.c9999c.','.c9999c.','..c99c..','...c....','...c....'],
pixelWidth:4,
pixelHeight:4
});

// Fireball
scene.textures.generate('fireball',{
data:['..cc..','..cc..','.cccc.','cccccc','.cccc.','..cc..','..cc..'],
pixelWidth:3,
pixelHeight:3
});
}

function createPipeSprites(scene){
// Pipe top (green)
scene.textures.generate('pipe-top',{
data:[
'22222222',
'2ffffff2',
'2ffffff2',
'22222222',
'22222222',
'2ffffff2',
'2ffffff2',
'22222222'
],
pixelWidth:4,
pixelHeight:4
});

// Pipe body
scene.textures.generate('pipe-body',{
data:[
'22222222',
'2ffffff2',
'2ffffff2',
'22222222'
],
pixelWidth:4,
pixelHeight:4
});
}

function createMiscSprites(scene){
// Flag pole
scene.textures.generate('flag-pole',{
data:['7','7','7','7','7','7','7','7'],
pixelWidth:3,
pixelHeight:8
});

// Flag
scene.textures.generate('flag',{
data:['cccc','cccc','cccc','cccc'],
pixelWidth:4,
pixelHeight:4
});

// Castle
scene.textures.generate('castle',{
data:[
'88.88.88',
'88.88.88',
'88888888',
'88.88.88',
'88....88',
'88....88',
'88.cc.88',
'88.cc.88'
],
pixelWidth:6,
pixelHeight:6
});

// Cloud
scene.textures.generate('cloud',{
data:[
'..fff...',
'.fffff..',
'ffffffff',
'ffffffff',
'.ffffff.'
],
pixelWidth:4,
pixelHeight:4
});

// Bush
scene.textures.generate('bush',{
data:[
'..2.2..',
'.22222.',
'2222222',
'2222222'
],
pixelWidth:4,
pixelHeight:4
});

// Hill
scene.textures.generate('hill',{
data:[
'....2....',
'...222...',
'..22222..',
'.2222222.',
'222222222'
],
pixelWidth:4,
pixelHeight:4
});
}

function create(){
console.log('Create function called - initializing game');
currentScene=this; // Store scene reference
this.cameras.main.setBounds(0,0,6400,600);
this.physics.world.setBounds(0,0,6400,600);

// Create decorative background elements
createBackground(this);

// Create ground (Agent 7)
createGround(this);

// Create platforms and level layout (Agent 7)
createLevel(this);

// Create blocks (Agent 2)
createBlocks(this);

// Create pipes (Agent 5)
createPipes(this);

// Create coins (Agent 2)
createCoins(this);

// Create enemies (Agent 3)
createEnemies(this);

// Create player (Agent 1, 6)
createPlayer(this);

// Create flag and castle (Agent 9)
createLevelEnd(this);

// Setup fireballs group (Agent 4)
fireballs=this.physics.add.group();

// Setup input (Agent 6)
cursors=this.input.keyboard.createCursorKeys();
cursors.space=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
shiftKey=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SHIFT);

// Camera follows Mario
this.cameras.main.startFollow(player,true,0.1,0.1);
this.cameras.main.setDeadzone(200,200);

// Timer (Agent 10)
this.time.addEvent({
delay:1000,
callback:updateTimer,
callbackScope:this,
loop:true
});

// Setup sounds (Agent 8)
setupSounds(this);

updateHUD();
}

function createBackground(scene){
// Add clouds
for(let i=0;i<10;i++){
const cloud=scene.add.sprite(
Phaser.Math.Between(100,6000),
Phaser.Math.Between(80,200),
'cloud'
);
cloud.setScale(3);
cloud.setScrollFactor(0.3);
}

// Add hills
for(let i=0;i<8;i++){
const hill=scene.add.sprite(
i*800+200,
520,
'hill'
);
hill.setScale(6);
hill.setScrollFactor(0.6);
hill.setTint(0x00aa00);
}

// Add bushes
for(let i=0;i<15;i++){
const bush=scene.add.sprite(
i*400+150,
540,
'bush'
);
bush.setScale(4);
bush.setTint(0x00cc00);
}
}

function createGround(scene){
platforms=scene.physics.add.staticGroup();

// Create ground across entire level
for(let i=0;i<200;i++){
const x=i*32;
platforms.create(x,576,'ground-block').setScale(4).refreshBody();
platforms.create(x,576+32,'ground-block').setScale(4).refreshBody();
}

// Add some pits
for(let x=1600;x<1800;x+=32){
platforms.children.entries.forEach(p=>{
if(p.x>=x&&p.x<x+200){
p.destroy();
}
});
}
}

function createLevel(scene){
// Platforms and stairs
const platformData=[
{x:800,y:450,w:6},
{x:1200,y:350,w:4},
{x:1600,y:400,w:5},
{x:2000,y:300,w:4},
{x:2400,y:450,w:6},
{x:3000,y:380,w:5},
{x:3500,y:320,w:4},
{x:4000,y:450,w:8},
{x:4800,y:400,w:6}
];

platformData.forEach(p=>{
for(let i=0;i<p.w;i++){
platforms.create(p.x+i*32,p.y,'brick-block')
.setScale(4).refreshBody();
}
});

// Create stairs near end
for(let i=0;i<4;i++){
for(let j=0;j<=i;j++){
platforms.create(5400+i*32,544-j*32,'ground-block')
.setScale(4).refreshBody();
}
}
for(let i=0;i<4;i++){
for(let j=0;j<=3-i;j++){
platforms.create(5528+i*32,544-j*32,'ground-block')
.setScale(4).refreshBody();
}
}
}

function createBlocks(scene){
// Question blocks that spawn coins/powerups
questionBlocks=scene.physics.add.staticGroup();

const qBlockPositions=[
{x:400,y:350,type:'coin'},
{x:600,y:350,type:'mushroom'},
{x:800,y:250,type:'coin'},
{x:1000,y:350,type:'coin'},
{x:1400,y:250,type:'coin'},
{x:1800,y:300,type:'coin'},
{x:2200,y:250,type:'coin'},
{x:2600,y:300,type:'fire-flower'},
{x:3200,y:280,type:'coin'},
{x:3600,y:300,type:'coin'},
{x:4200,y:350,type:'coin'},
{x:4600,y:250,type:'mushroom'}
];

qBlockPositions.forEach(pos=>{
const block=questionBlocks.create(pos.x,pos.y,'question-block');
block.setScale(4);
block.refreshBody();
block.powerupType=pos.type;
block.isHit=false;
block.setTint(0xffcc00);
});

// Brick blocks
bricks=scene.physics.add.staticGroup();
const brickPositions=[
{x:440,y:350},{x:480,y:350},{x:520,y:350},{x:560,y:350},
{x:640,y:350},{x:680,y:350},
{x:1040,y:350},{x:1080,y:350},{x:1120,y:350},
{x:2240,y:250},{x:2280,y:250},{x:2320,y:250}
];

brickPositions.forEach(pos=>{
const brick=bricks.create(pos.x,pos.y,'brick-block');
brick.setScale(4);
brick.refreshBody();
brick.setTint(0xcc6600);
});
}

function createPipes(scene){
pipes=scene.physics.add.staticGroup();

const pipeData=[
{x:900,h:2},
{x:1800,h:3},
{x:2800,h:2},
{x:3800,h:3},
{x:4600,h:2}
];

pipeData.forEach(p=>{
// Pipe top
const top=pipes.create(p.x,544-p.h*32,'pipe-top');
top.setScale(4,2);
top.refreshBody();
top.setTint(0x00cc00);
top.canEnter=true;
top.pipeHeight=p.h;

// Pipe body
for(let i=1;i<p.h;i++){
const body=pipes.create(p.x,544-i*32+16,'pipe-body');
body.setScale(4,4);
body.refreshBody();
body.setTint(0x00cc00);
}
});
}

function createCoins(scene){
coins=scene.physics.add.group();

// Floating coins
const coinPositions=[
{x:450,y:300},{x:490,y:300},{x:530,y:300},
{x:1050,y:280},{x:1090,y:280},
{x:1500,y:350},{x:1540,y:350},{x:1580,y:350},
{x:2500,y:400},{x:2540,y:400},{x:2580,y:400},
{x:3300,y:250},{x:3340,y:250},{x:3380,y:250},{x:3420,y:250}
];

coinPositions.forEach(pos=>{
const coin=coins.create(pos.x,pos.y,'coin');
coin.setScale(3);
coin.setTint(0xffcc00);
coin.body.setAllowGravity(false);
});
}

function createEnemies(scene){
enemies=scene.physics.add.group();

// Goombas
const goombaPositions=[
{x:700,y:500},{x:1100,y:500},{x:1500,y:500},
{x:2200,y:500},{x:2600,y:500},{x:3100,y:500},
{x:3600,y:500},{x:4100,y:500},{x:4500,y:500}
];

goombaPositions.forEach(pos=>{
const goomba=enemies.create(pos.x,pos.y,'goomba');
goomba.setScale(3);
goomba.setTint(0x8b4513);
goomba.setVelocityX(-50);
goomba.enemyType='goomba';
goomba.isDead=false;
});

// Koopas
const koopaPositions=[
{x:1300,y:500},{x:2400,y:500},{x:3400,y:500},{x:4800,y:500}
];

koopaPositions.forEach(pos=>{
const koopa=enemies.create(pos.x,pos.y,'koopa');
koopa.setScale(3);
koopa.setTint(0x00cc00);
koopa.setVelocityX(-60);
koopa.enemyType='koopa';
koopa.isShell=false;
koopa.shellTimer=0;
});
}

function createPlayer(scene){
player=scene.physics.add.sprite(100,500,'mario-small');
player.setScale(3);
player.setBounce(0);
player.setCollideWorldBounds(true);
player.body.setSize(24,24);
player.body.setGravityY(0); // Use world gravity
player.body.setMaxVelocity(300,1000);

// Collisions
scene.physics.add.collider(player,platforms);
scene.physics.add.collider(player,bricks);
scene.physics.add.collider(player,questionBlocks);
scene.physics.add.collider(player,pipes,handlePipeCollision,null,scene);

// Enemy collisions
scene.physics.add.collider(enemies,platforms);
scene.physics.add.collider(enemies,bricks);
scene.physics.add.collider(enemies,questionBlocks);
scene.physics.add.collider(enemies,pipes);
scene.physics.add.collider(enemies,enemies);
scene.physics.add.overlap(player,enemies,handleEnemyCollision,null,scene);

// Coin collection
scene.physics.add.overlap(player,coins,collectCoin,null,scene);

// Powerup collisions
powerups=scene.physics.add.group();
scene.physics.add.collider(powerups,platforms);
scene.physics.add.collider(powerups,bricks);
scene.physics.add.overlap(player,powerups,collectPowerup,null,scene);

// Fireball collisions
scene.physics.add.collider(fireballs,platforms,destroyFireball,null,scene);
scene.physics.add.collider(fireballs,bricks,destroyFireball,null,scene);
scene.physics.add.overlap(fireballs,enemies,fireballHitEnemy,null,scene);
}

function createLevelEnd(scene){
// Flag pole
flag=scene.physics.add.staticGroup();
const pole=flag.create(5900,400,'flag-pole');
pole.setScale(2,15);
pole.refreshBody();
pole.setTint(0x888888);

const flagSprite=flag.create(5920,250,'flag');
flagSprite.setScale(4);
flagSprite.refreshBody();
flagSprite.setTint(0xff0000);

// Castle
castle=scene.add.sprite(6100,460,'castle');
castle.setScale(8);
castle.setTint(0x888888);

// Flag collision
scene.physics.add.overlap(player,flag,handleFlagTouch,null,scene);
}

function setupSounds(scene){
// Create simple beep sounds using Web Audio API
const audioContext=new(window.AudioContext||window.webkitAudioContext)();

soundEffects.jump=()=>playBeep(audioContext,400,0.1);
soundEffects.coin=()=>playBeep(audioContext,800,0.1);
soundEffects.powerup=()=>playBeep(audioContext,600,0.2);
soundEffects.stomp=()=>playBeep(audioContext,200,0.1);
soundEffects.kick=()=>playBeep(audioContext,300,0.1);
soundEffects.fireball=()=>playBeep(audioContext,500,0.1);
soundEffects.hit=()=>playBeep(audioContext,100,0.3);
soundEffects.flagpole=()=>playBeep(audioContext,1000,0.5);
}

function playBeep(ctx,freq,duration){
const osc=ctx.createOscillator();
const gain=ctx.createGain();
osc.connect(gain);
gain.connect(ctx.destination);
osc.frequency.value=freq;
gain.gain.value=0.1;
osc.start();
setTimeout(()=>osc.stop(),duration*1000);
}

function update(){
if(gameOver||levelComplete)return;

// Debug: Check if game is working
if(typeof window.debugOnce==='undefined'){
console.log('Update called - game is running');
console.log('Player exists:',!!player);
console.log('Controls initialized:',!!cursors,!!shiftKey);
if(cursors){
console.log('Arrow keys:',!!cursors.left,!!cursors.right,!!cursors.up,!!cursors.down,!!cursors.space);
}
if(player){
console.log('Player position:',player.x,player.y);
console.log('Player velocity:',player.body?.velocity.x,player.body?.velocity.y);
}
window.debugOnce=true;
}

// Agent 6: Mario Physics & Controls
handlePlayerMovement(this);

// Agent 1: Mario animations
updateMarioAnimation();

// Agent 2: Animate coins
if(coins&&coins.children){
coins.children.iterate(coin=>{
if(coin&&coin.active){
coin.angle+=3;
}
});
}

// Agent 3: Enemy AI
updateEnemies();

// Agent 4: Fireball shooting
handleFireball(this);

// Update fireballs
if(fireballs&&fireballs.children){
fireballs.children.iterate(fb=>{
if(fb&&fb.active){
fb.angle+=10;
if(fb.x<player.x-400||fb.x>player.x+400){
fb.destroy();
}
}
});
}

// Check for block hits from below
checkBlockHits(this);

// Check if Mario fell in pit
if(player.y>600){
loseLife(this);
}
}

function handlePlayerMovement(scene){
if(!player||!player.body||!cursors)return;

const onGround=player.body.touching.down||player.body.blocked.down;

// Running (Agent 6)
isRunning=shiftKey&&shiftKey.isDown;
const maxSpeed=isRunning?250:160;
const acceleration=isRunning?15:10;

// Horizontal movement
if(cursors.left.isDown){
const newVel=Math.max(player.body.velocity.x-acceleration,-maxSpeed);
player.setVelocityX(newVel);
player.flipX=true;
}else if(cursors.right.isDown){
const newVel=Math.min(player.body.velocity.x+acceleration,maxSpeed);
player.setVelocityX(newVel);
player.flipX=false;
}else{
// Deceleration
const friction=onGround?0.85:0.95;
player.setVelocityX(player.body.velocity.x*friction);
}

// Variable jump (Agent 6)
if(cursors.up.isDown&&onGround&&canJump){
const jumpPower=marioState==='small'?-500:-550;
player.setVelocityY(jumpPower);
canJump=false;
if(soundEffects.jump)soundEffects.jump();
}

// Jump height control
if(!cursors.up.isDown&&player.body.velocity.y<-100){
player.setVelocityY(player.body.velocity.y*0.5);
}

if(!cursors.up.isDown){
canJump=true;
}

// Crouch (big Mario only)
if(cursors.down.isDown&&onGround&&marioState!=='small'){
player.body.setSize(24,20);
}else{
if(marioState==='small'){
player.body.setSize(24,24);
}else{
player.body.setSize(24,36);
}
}
}

function updateMarioAnimation(){
// Simple animation via tint changes based on movement
if(Math.abs(player.body.velocity.x)>5){
player.angle=0;
}
}

function updateEnemies(){
if(!enemies)return;
enemies.children.iterate(enemy=>{
if(!enemy||!enemy.active||!enemy.body)return;

// Goombas walk back and forth
if(enemy.enemyType==='goomba'&&!enemy.isDead){
if(enemy.body.blocked&&enemy.body.blocked.left){
enemy.setVelocityX(50);
}else if(enemy.body.blocked&&enemy.body.blocked.right){
enemy.setVelocityX(-50);
}
enemy.flipX=enemy.body.velocity.x>0;
}

// Koopas
if(enemy.enemyType==='koopa'&&!enemy.isShell){
if(enemy.body.blocked&&enemy.body.blocked.left){
enemy.setVelocityX(60);
}else if(enemy.body.blocked&&enemy.body.blocked.right){
enemy.setVelocityX(-60);
}
enemy.flipX=enemy.body.velocity.x>0;
}

// Moving shells
if(enemy.enemyType==='koopa'&&enemy.isShell&&enemy.body.velocity&&Math.abs(enemy.body.velocity.x)>10){
enemy.angle+=20;

// Hit other enemies
enemies.children.iterate(other=>{
if(!other||!other.active)return;
if(other!==enemy&&other.active&&
Phaser.Math.Distance.Between(enemy.x,enemy.y,other.x,other.y)<40){
killEnemy(other,this);
}
});
}

// Shell timer
if(enemy.isShell&&enemy.shellTimer>0){
enemy.shellTimer--;
if(enemy.shellTimer===0&&enemy.body.velocity&&Math.abs(enemy.body.velocity.x)<5){
// Koopa comes back out
enemy.setTexture('koopa');
enemy.setTint(0x00cc00);
enemy.isShell=false;
enemy.setVelocityX(-60);
}
}
});
}

function handleFireball(scene){
if(!cursors||!cursors.space||!fireballs||!player)return;

if(marioState==='fire'&&Phaser.Input.Keyboard.JustDown(cursors.space)&&!fireCooldown){
const fb=fireballs.create(
player.x+(player.flipX?-20:20),
player.y,
'fireball'
);
if(!fb)return;
fb.setScale(2);
fb.setVelocityX(player.flipX?-300:300);
fb.setVelocityY(-200);
fb.setBounce(0.7);
fb.setTint(0xff6600);
if(soundEffects.fireball)soundEffects.fireball();

fireCooldown=true;
setTimeout(()=>fireCooldown=false,300);
}
}

function checkBlockHits(scene){
if(!player||!player.body||!questionBlocks||!bricks)return;

// Check if Mario hit a block from below
const checkBlock=(block)=>{
if(!block||!block.active||!block.texture)return;

const marioTop=player.y-player.displayHeight/2;
const blockBottom=block.y+block.displayHeight/2;

if(player.body.velocity.y<0&&
Math.abs(player.x-block.x)<20&&
Math.abs(marioTop-blockBottom)<10){

if(block.texture.key==='question-block'&&!block.isHit){
hitQuestionBlock(block,scene);
}else if(block.texture.key==='brick-block'&&marioState!=='small'){
breakBrick(block,scene);
}

// Bump animation
if(scene&&scene.tweens){
scene.tweens.add({
targets:block,
y:block.y-10,
duration:100,
yoyo:true
});
}

player.setVelocityY(0);
}
};

if(questionBlocks.children)questionBlocks.children.iterate(checkBlock);
if(bricks.children)bricks.children.iterate(checkBlock);
}

function hitQuestionBlock(block,scene){
if(!block||!coins)return;

block.isHit=true;
block.setTexture('hit-block');
block.setTint(0x888888);

if(block.powerupType==='coin'){
// Spawn coin
const coin=coins.create(block.x,block.y-40,'coin');
if(!coin)return;
coin.setScale(3);
coin.setTint(0xffcc00);
if(coin.body)coin.body.setAllowGravity(false);

if(scene&&scene.tweens){
scene.tweens.add({
targets:coin,
y:block.y-80,
alpha:0,
duration:500,
onComplete:()=>{
if(coin&&coin.destroy)coin.destroy();
}
});
}

coinCount++;
score+=100;
if(soundEffects.coin)soundEffects.coin();
}else if(block.powerupType==='mushroom'||block.powerupType==='fire-flower'){
spawnPowerup(block,scene);
}

updateHUD();
}

function breakBrick(block,scene){
if(!block||!scene||!scene.add)return;

// Brick breaks into pieces
const pieces=[];
for(let i=0;i<4;i++){
const piece=scene.add.rectangle(
block.x+(i%2===0?-8:8),
block.y+(i<2?-8:8),
8,8,0xcc6600
);
if(!piece)continue;
pieces.push(piece);

if(scene&&scene.tweens){
scene.tweens.add({
targets:piece,
x:piece.x+(i%2===0?-50:50),
y:piece.y-100,
angle:360,
alpha:0,
duration:800,
onComplete:()=>{
if(piece&&piece.destroy)piece.destroy();
}
});
}
}

block.destroy();
if(soundEffects.stomp)soundEffects.stomp();
score+=50;
updateHUD();
}

function spawnPowerup(block,scene){
if(!block||!powerups)return;

let powerup;

if(block.powerupType==='mushroom'){
powerup=powerups.create(block.x,block.y-40,'mushroom');
if(!powerup)return;
powerup.setScale(3);
powerup.setTint(0xff0000);
powerup.powerType='mushroom';
powerup.setVelocityX(80);
}else if(block.powerupType==='fire-flower'){
powerup=powerups.create(block.x,block.y-40,'fire-flower');
if(!powerup)return;
powerup.setScale(3);
powerup.setTint(0xff6600);
powerup.powerType='fire-flower';
if(powerup.body)powerup.body.setAllowGravity(false);
}

if(soundEffects.powerup)soundEffects.powerup();
}

function collectCoin(player,coin){
if(!coin||!coin.active)return;
coin.destroy();
coinCount++;
score+=100;
if(soundEffects.coin)soundEffects.coin();
updateHUD();
}

function collectPowerup(player,powerup){
if(!powerup||!powerup.active)return;

if(powerup.powerType==='mushroom'&&marioState==='small'){
// Transform to big Mario
marioState='big';
player.setTexture('mario-big');
player.setScale(3);
player.body.setSize(24,36);
player.y-=12;
}else if(powerup.powerType==='fire-flower'){
// Transform to fire Mario
marioState='fire';
player.setTexture('mario-fire');
player.setScale(3);
if(marioState==='small'){
player.body.setSize(24,36);
player.y-=12;
}
}

powerup.destroy();
score+=1000;
if(soundEffects.powerup)soundEffects.powerup();
updateHUD();
}

function handleEnemyCollision(player,enemy){
if(!enemy||!enemy.active||enemy.isDead)return;
if(!player||!player.body||!enemy.body)return;

// Check if Mario is falling on enemy
if(player.body.velocity.y>0&&player.y<enemy.y-10){
// Stomp enemy
stompEnemy(player,enemy,this);
}else{
// Mario gets hit
hitMario(this);
}
}

function stompEnemy(player,enemy,scene){
player.setVelocityY(-300);

if(enemy.enemyType==='goomba'){
enemy.isDead=true;
enemy.setTexture('goomba-dead');
enemy.setVelocityX(0);
setTimeout(()=>enemy.destroy(),500);
soundEffects.stomp();
score+=100;
}else if(enemy.enemyType==='koopa'&&!enemy.isShell){
// Koopa becomes shell
enemy.isShell=true;
enemy.setTexture('koopa-shell');
enemy.setTint(0x00aa00);
enemy.setVelocityX(0);
enemy.shellTimer=180; // 3 seconds to emerge
soundEffects.stomp();
score+=100;
}else if(enemy.enemyType==='koopa'&&enemy.isShell){
// Kick shell
const kickDir=player.x<enemy.x?1:-1;
enemy.setVelocityX(kickDir*300);
soundEffects.kick();
score+=200;
}

updateHUD();
}

function killEnemy(enemy,scene){
if(!enemy||!enemy.active)return;
enemy.destroy();
score+=100;
soundEffects.stomp();
updateHUD();
}

function destroyFireball(fireball){
if(!fireball||!fireball.active)return;
fireball.destroy();
}

function fireballHitEnemy(fireball,enemy){
if(!fireball||!fireball.active)return;
if(!enemy||!enemy.active)return;
fireball.destroy();
killEnemy(enemy,this);
}

function hitMario(scene){
if(marioState==='big'||marioState==='fire'){
// Downgrade Mario
marioState='small';
player.setTexture('mario-small');
player.setScale(3);
player.body.setSize(24,24);

// Invincibility frames
player.setAlpha(0.5);
const originalTint=player.tint;

let flicker=setInterval(()=>{
player.setAlpha(player.alpha===0.5?1:0.5);
},100);

setTimeout(()=>{
clearInterval(flicker);
player.setAlpha(1);
},2000);

soundEffects.hit();
}else{
// Small Mario dies
loseLife(scene);
}
}

function loseLife(scene){
if(!currentScene)return;

lives--;
updateHUD();

if(lives<=0){
// Game over
gameOver=true;
player.setVelocity(0,-400);
player.setTint(0xff0000);

setTimeout(()=>{
const gameOverText=currentScene.add.text(player.x,300,'GAME OVER',{
fontSize:'64px',
fill:'#fff',
stroke:'#000',
strokeThickness:8,
fontFamily:'Courier New'
}).setOrigin(0.5).setScrollFactor(0);

gameOverText.setPosition(400,300);

setTimeout(()=>{
score=0;
coinCount=0;
lives=3;
time=400;
marioState='small';
gameOver=false;
currentScene.scene.restart();
},3000);
},1000);
}else{
// Respawn
setTimeout(()=>{
player.setPosition(100,500);
player.setVelocity(0,0);
marioState='small';
player.setTexture('mario-small');
player.setScale(3);
player.setAlpha(1);
},1000);
}

if(soundEffects.hit)soundEffects.hit();
}

function handlePipeCollision(player,pipe){
if(!pipe||!cursors)return;
// Allow pipe entry with down arrow
if(pipe.canEnter&&cursors.down.isDown&&player.body&&player.body.touching.down){
// Animate Mario going into pipe
player.setVelocityY(50);
player.setAlpha(0);

setTimeout(()=>{
player.setPosition(pipe.x,pipe.y-100);
player.setAlpha(1);
score+=500;
updateHUD();
},1000);
}
}

function handleFlagTouch(player,flagObj){
if(levelComplete||!currentScene)return;

levelComplete=true;
player.setVelocityX(0);

if(soundEffects.flagpole)soundEffects.flagpole();

// Slide down flag
currentScene.tweens.add({
targets:player,
y:520,
duration:1500,
onComplete:()=>{
// Walk to castle
player.flipX=false;
currentScene.tweens.add({
targets:player,
x:6100,
duration:2000,
onComplete:()=>{
// Level complete
score+=5000;
updateHUD();

const completeText=currentScene.add.text(400,300,'LEVEL COMPLETE!',{
fontSize:'48px',
fill:'#fff',
stroke:'#000',
strokeThickness:6,
fontFamily:'Courier New'
}).setOrigin(0.5).setScrollFactor(0);

setTimeout(()=>{
// Could load next level here
currentScene.scene.restart();
levelComplete=false;
time=400;
},3000);
}
});
}
});
}

function updateTimer(){
if(!gameOver&&!levelComplete&&time>0){
time--;
updateHUD();

if(time<=0){
loseLife(this);
}
}
}

function updateHUD(){
document.getElementById('score').textContent=score.toString().padStart(6,'0');
document.getElementById('coins').textContent='√ó'+coinCount.toString().padStart(2,'0');
document.getElementById('world').textContent=world;
document.getElementById('time').textContent=time.toString();
document.getElementById('lives').textContent='√ó'+lives;
}
</script>
</body>
</html>
