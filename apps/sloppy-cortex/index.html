<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sloppy Cortex ‚Äî Sentiment & AI Drafting</title>
<link rel="icon" href="https://emojicdn.elk.sh/üß†">
<meta property="og:title" content="Sloppy Cortex">
<meta property="og:description" content="Community brain scan. See what everyone feels, then draft with AI.">
<meta property="og:url" content="https://app.sloppy.live/sloppy-cortex">
<meta property="og:image" content="https://image.pollinations.ai/prompt/cyberpunk%20brain%20scan%20hologram%20with%20neural%20pathways%20glowing%20red%20and%20blue%20sentiment%20waves%20dark%20background?width=1200&height=630&nologo=true&referrer=sloppy.live">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;600;700&family=IBM+Plex+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0a0f;--surface:#12121a;--border:#1e1e2e;
  --text:#c8c8d4;--dim:#6a6a80;--accent:#e84393;
  --positive:#00cec9;--negative:#d63031;--neutral:#636e72;
  --warm:#fdcb6e;--cold:#74b9ff;
  --glow-pos:0 0 20px rgba(0,206,201,.3);--glow-neg:0 0 20px rgba(214,48,49,.3);
}
body{background:var(--bg);color:var(--text);font-family:'IBM Plex Mono',monospace;min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;top:0;left:0;right:0;bottom:0;
  background:radial-gradient(ellipse at 20% 20%,rgba(232,67,147,.04) 0%,transparent 50%),
             radial-gradient(ellipse at 80% 80%,rgba(0,206,201,.04) 0%,transparent 50%);
  pointer-events:none;z-index:0}
.app{position:relative;z-index:1;max-width:960px;margin:0 auto;padding:20px 16px 80px}
h1{font-family:'Cormorant Garamond',serif;font-weight:300;font-size:2.4rem;letter-spacing:-.02em;
  background:linear-gradient(135deg,var(--accent),var(--positive));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.subtitle{font-size:.75rem;color:var(--dim);margin-top:4px;letter-spacing:.08em;text-transform:uppercase}
header{margin-bottom:24px}

/* Tabs */
.tabs{display:flex;gap:2px;margin-bottom:20px;border-bottom:1px solid var(--border);overflow-x:auto}
.tab{padding:10px 16px;font-size:.75rem;font-family:'IBM Plex Mono',monospace;letter-spacing:.06em;
  text-transform:uppercase;color:var(--dim);background:transparent;border:none;cursor:pointer;
  border-bottom:2px solid transparent;white-space:nowrap;transition:.2s}
.tab:hover{color:var(--text)}
.tab.active{color:var(--accent);border-bottom-color:var(--accent)}

/* Panels */
.panel{display:none}.panel.active{display:block}

/* Pulse card */
.pulse-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:20px}
.pulse-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px;position:relative;overflow:hidden}
.pulse-card .label{font-size:.65rem;text-transform:uppercase;letter-spacing:.1em;color:var(--dim);margin-bottom:8px}
.pulse-card .value{font-family:'Cormorant Garamond',serif;font-size:2rem;font-weight:700}
.pulse-card .sub{font-size:.7rem;color:var(--dim);margin-top:4px}
.pulse-card.positive .value{color:var(--positive)}
.pulse-card.negative .value{color:var(--negative)}
.pulse-card.neutral .value{color:var(--warm)}

/* Sentiment bar */
.sentiment-bar{height:6px;background:var(--border);border-radius:3px;overflow:hidden;display:flex;margin:8px 0}
.sentiment-bar .seg{height:100%;transition:width .6s ease}
.seg.pos{background:var(--positive)}.seg.neu{background:var(--warm)}.seg.neg{background:var(--negative)}

/* Mood timeline */
.mood-timeline{display:flex;gap:2px;align-items:flex-end;height:80px;margin:16px 0}
.mood-bar{flex:1;border-radius:2px 2px 0 0;min-width:4px;transition:height .4s ease;position:relative}
.mood-bar:hover::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 4px);left:50%;transform:translateX(-50%);
  font-size:.6rem;background:var(--surface);border:1px solid var(--border);padding:2px 6px;border-radius:4px;white-space:nowrap;z-index:10}

/* Stream items */
.stream{display:flex;flex-direction:column;gap:8px}
.stream-item{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px;
  display:flex;gap:12px;align-items:flex-start;transition:border-color .2s}
.stream-item:hover{border-color:var(--accent)}
.stream-item .sentiment-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;margin-top:4px}
.stream-item .sentiment-dot.pos{background:var(--positive);box-shadow:var(--glow-pos)}
.stream-item .sentiment-dot.neg{background:var(--negative);box-shadow:var(--glow-neg)}
.stream-item .sentiment-dot.neu{background:var(--warm)}
.stream-item .meta{font-size:.65rem;color:var(--dim);margin-bottom:2px}
.stream-item .text{font-size:.8rem;line-height:1.5;word-break:break-word}
.stream-item .score{font-size:.7rem;font-weight:500;margin-top:4px}

/* Trends */
.trend-row{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border)}
.trend-row:last-child{border-bottom:none}
.trend-rank{font-family:'Cormorant Garamond',serif;font-size:1.4rem;font-weight:700;color:var(--dim);width:30px;text-align:right}
.trend-tag{font-size:.85rem;color:var(--accent);flex:1}
.trend-count{font-size:.7rem;color:var(--dim)}
.trend-mood{font-size:.7rem;padding:2px 8px;border-radius:10px;font-weight:500}
.trend-mood.pos{background:rgba(0,206,201,.15);color:var(--positive)}
.trend-mood.neg{background:rgba(214,48,49,.15);color:var(--negative)}
.trend-mood.neu{background:rgba(253,203,110,.15);color:var(--warm)}

/* Drafting */
.draft-area{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;margin-top:12px}
.draft-label{font-size:.65rem;text-transform:uppercase;letter-spacing:.1em;color:var(--dim);margin-bottom:8px}
.draft-input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;
  color:var(--text);font-family:'IBM Plex Mono',monospace;font-size:.8rem;resize:vertical;min-height:80px;
  outline:none;transition:border-color .2s}
.draft-input:focus{border-color:var(--accent)}
.draft-controls{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.draft-btn{padding:8px 16px;font-size:.7rem;font-family:'IBM Plex Mono',monospace;letter-spacing:.04em;
  border:1px solid var(--border);border-radius:6px;background:var(--surface);color:var(--text);cursor:pointer;transition:.2s}
.draft-btn:hover{border-color:var(--accent);color:var(--accent)}
.draft-btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.draft-btn.primary:hover{opacity:.85}
.draft-output{margin-top:16px;padding:16px;background:var(--bg);border:1px solid var(--border);border-radius:8px;
  font-size:.8rem;line-height:1.6;white-space:pre-wrap;display:none}
.draft-output.visible{display:block}
.draft-hint{font-size:.65rem;color:var(--dim);margin-top:8px}

/* Loading */
.loading{text-align:center;padding:40px;color:var(--dim);font-size:.75rem}
.loading .spinner{display:inline-block;width:20px;height:20px;border:2px solid var(--border);
  border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;margin-bottom:8px}
@keyframes spin{to{transform:rotate(360deg)}}

/* Source filter */
.source-filter{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap}
.source-btn{padding:4px 12px;font-size:.65rem;border:1px solid var(--border);border-radius:12px;
  background:transparent;color:var(--dim);cursor:pointer;font-family:'IBM Plex Mono',monospace;transition:.2s}
.source-btn.active{border-color:var(--accent);color:var(--accent);background:rgba(232,67,147,.08)}

/* Responsive */
@media(max-width:600px){
  h1{font-size:1.8rem}
  .pulse-grid{grid-template-columns:1fr 1fr}
  .draft-controls{flex-direction:column}
  .draft-btn{width:100%;text-align:center}
}
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>Sloppy Cortex</h1>
    <div class="subtitle">community sentiment analysis & ai drafting</div>
  </header>

  <div class="tabs">
    <button class="tab active" data-tab="pulse" onclick="switchTab('pulse')">Pulse</button>
    <button class="tab" data-tab="stream" onclick="switchTab('stream')">Stream</button>
    <button class="tab" data-tab="trends" onclick="switchTab('trends')">Trends</button>
    <button class="tab" data-tab="draft" onclick="switchTab('draft')">Draft</button>
  </div>

  <!-- PULSE TAB -->
  <div class="panel active" id="panel-pulse">
    <div class="pulse-grid" id="pulse-cards"></div>
    <div>
      <div style="font-size:.7rem;color:var(--dim);margin-bottom:6px">OVERALL SENTIMENT</div>
      <div class="sentiment-bar" id="overall-bar"></div>
      <div style="display:flex;justify-content:space-between;font-size:.6rem;color:var(--dim)">
        <span id="pos-pct">0%</span><span id="neu-pct">0%</span><span id="neg-pct">0%</span>
      </div>
    </div>
    <div style="margin-top:20px">
      <div style="font-size:.7rem;color:var(--dim);margin-bottom:6px">MOOD OVER LAST 24 HOURS</div>
      <div class="mood-timeline" id="mood-timeline"></div>
    </div>
    <div style="margin-top:20px">
      <div style="font-size:.7rem;color:var(--dim);margin-bottom:6px">RECENT NOTABLE SIGNALS</div>
      <div class="stream" id="notable-signals"></div>
    </div>
  </div>

  <!-- STREAM TAB -->
  <div class="panel" id="panel-stream">
    <div class="source-filter" id="source-filter">
      <button class="source-btn active" data-src="all" onclick="filterStream('all')">All</button>
      <button class="source-btn" data-src="messages" onclick="filterStream('messages')">Chat</button>
      <button class="source-btn" data-src="posts" onclick="filterStream('posts')">Posts</button>
      <button class="source-btn" data-src="manifestos" onclick="filterStream('manifestos')">Manifestos</button>
    </div>
    <div class="stream" id="sentiment-stream"></div>
    <div style="text-align:center;margin-top:16px">
      <button class="draft-btn" id="load-more-stream" onclick="loadMoreStream()" style="display:none">Load older</button>
    </div>
  </div>

  <!-- TRENDS TAB -->
  <div class="panel" id="panel-trends">
    <div style="font-size:.7rem;color:var(--dim);margin-bottom:12px">TOP THEMES BY MENTION FREQUENCY</div>
    <div id="trend-list"></div>
  </div>

  <!-- DRAFT TAB -->
  <div class="panel" id="panel-draft">
    <div class="draft-area">
      <div class="draft-label">What do you want to write?</div>
      <textarea class="draft-input" id="draft-input" placeholder="Describe your idea, and the AI will draft something for you...&#10;&#10;Examples:&#10;‚Ä¢ A manifesto about digital freedom&#10;‚Ä¢ A post celebrating the community&#10;‚Ä¢ A fiery rant about centralized platforms"></textarea>
      <div class="draft-controls">
        <button class="draft-btn primary" onclick="generateDraft()">Generate Draft</button>
        <button class="draft-btn" onclick="generateDraft('poetic')">Poetic</button>
        <button class="draft-btn" onclick="generateDraft('provocative')">Provocative</button>
        <button class="draft-btn" onclick="generateDraft('analytical')">Analytical</button>
      </div>
      <div class="draft-hint" id="draft-hint">Powered by AI. Edit freely after generation.</div>
      <div class="draft-output" id="draft-output"></div>
      <div class="draft-controls" id="draft-actions" style="display:none">
        <button class="draft-btn" onclick="copyDraft()">Copy to clipboard</button>
        <button class="draft-btn" onclick="refineDraft()">Refine</button>
      </div>
    </div>
    <div style="margin-top:20px">
      <div class="draft-label">COMMUNITY MOOD CONTEXT</div>
      <div style="font-size:.75rem;color:var(--dim);line-height:1.6" id="mood-context">Loading mood context...</div>
    </div>
  </div>
</div>

<script type="module">
import { createBrowserClient } from "https://cdn.jsdelivr.net/npm/@supabase/ssr@0.7.0/+esm";

const SUPABASE_URL = 'https://yjyxteqzhhmtrgcaekgz.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM8IS32IUYR2eenCCjdDdioiBU';

const supabase = createBrowserClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  cookieOptions: {
    name: 'sb-auth-token',
    domain: location.hostname.includes('sloppy.live') ? '.sloppy.live' : location.hostname,
    path: '/', sameSite: 'lax'
  }
});

const ESC = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

// ‚îÄ‚îÄ Sentiment Analysis (client-side heuristic) ‚îÄ‚îÄ
const POS_WORDS = new Set(['love','great','amazing','awesome','good','nice','happy','beautiful','wonderful','excellent',
  'fantastic','brilliant','perfect','best','fun','enjoy','cool','excited','glad','thanks','thank','wow','fire',
  'yes','legendary','based','king','queen','goat','w','dub','lit','peak','slaps','blessed','vibe','vibes','hype']);
const NEG_WORDS = new Set(['hate','bad','terrible','awful','worst','ugly','sad','angry','boring','stupid',
  'trash','garbage','broken','fail','sucks','annoying','useless','cringe','mid','ratio','L','cope','dead',
  'toxic','disaster','pathetic','lame','nah','no','wrong','ugh','yikes','rip']);
const INTENSIFIERS = new Set(['very','really','so','extremely','absolutely','totally','super','mega','ultra']);

function analyzeSentiment(text) {
  if (!text) return { score: 0, label: 'neutral', magnitude: 0 };
  const words = text.toLowerCase().replace(/[^a-z\s]/g, ' ').split(/\s+/).filter(Boolean);
  let score = 0, magnitude = 0, intensify = false;
  for (const w of words) {
    if (INTENSIFIERS.has(w)) { intensify = true; continue; }
    const mult = intensify ? 1.5 : 1;
    if (POS_WORDS.has(w)) { score += mult; magnitude += mult; }
    else if (NEG_WORDS.has(w)) { score -= mult; magnitude += mult; }
    intensify = false;
  }
  // Normalize by word count
  const norm = words.length > 0 ? score / Math.sqrt(words.length) : 0;
  const label = norm > 0.15 ? 'positive' : norm < -0.15 ? 'negative' : 'neutral';
  return { score: norm, label, magnitude };
}

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let allItems = [];
let streamFilter = 'all';
let streamPage = 0;
const STREAM_PAGE = 25;

// ‚îÄ‚îÄ Data Loading ‚îÄ‚îÄ
async function loadData() {
  const since = new Date(Date.now() - 24*60*60*1000).toISOString();
  const weekAgo = new Date(Date.now() - 7*24*60*60*1000).toISOString();

  const [msgRes, postRes, manRes, eventRes] = await Promise.all([
    supabase.from('sloppygram_messages').select('id,username,content,created_at').gte('created_at', weekAgo).order('created_at',{ascending:false}).limit(200),
    supabase.from('sloppygram_posts').select('id,username,caption,likes_count,created_at').gte('created_at', weekAgo).order('created_at',{ascending:false}).limit(200),
    supabase.from('sloppygram_manifestos').select('id,username,title,content,upvotes,created_at').gte('created_at', weekAgo).order('created_at',{ascending:false}).limit(100),
    supabase.from('ai_events').select('event_type,entity_type,username,metadata,created_at').gte('created_at', since).order('created_at',{ascending:false}).limit(300)
  ]);

  const messages = (msgRes.data || []).map(m => ({
    id: 'msg-'+m.id, source: 'messages', username: m.username || 'anon',
    text: m.content || '', created_at: m.created_at,
    ...analyzeSentiment(m.content)
  }));

  const posts = (postRes.data || []).map(p => ({
    id: 'post-'+p.id, source: 'posts', username: p.username || 'anon',
    text: p.caption || '', created_at: p.created_at, likes: p.likes_count || 0,
    ...analyzeSentiment(p.caption)
  }));

  const manifestos = (manRes.data || []).map(m => ({
    id: 'man-'+m.id, source: 'manifestos', username: m.username || 'anon',
    text: (m.title || '') + ' ' + (m.content || '').slice(0, 300), created_at: m.created_at, upvotes: m.upvotes || 0,
    ...analyzeSentiment((m.title || '') + ' ' + (m.content || ''))
  }));

  allItems = [...messages, ...posts, ...manifestos].sort((a,b) => new Date(b.created_at) - new Date(a.created_at));

  const events = eventRes.data || [];

  renderPulse(allItems, events, since);
  renderStream();
  renderTrends(allItems);
  renderMoodContext(allItems);
}

// ‚îÄ‚îÄ Pulse Tab ‚îÄ‚îÄ
function renderPulse(items, events, since) {
  const recent = items.filter(i => new Date(i.created_at) >= new Date(since));
  const pos = recent.filter(i => i.label === 'positive').length;
  const neg = recent.filter(i => i.label === 'negative').length;
  const neu = recent.filter(i => i.label === 'neutral').length;
  const total = recent.length || 1;

  const avgScore = recent.reduce((s,i) => s + i.score, 0) / total;
  const dominantMood = avgScore > 0.1 ? 'Optimistic' : avgScore < -0.1 ? 'Tense' : 'Steady';
  const moodClass = avgScore > 0.1 ? 'positive' : avgScore < -0.1 ? 'negative' : 'neutral';

  const msgs24 = recent.filter(i => i.source === 'messages').length;
  const posts24 = recent.filter(i => i.source === 'posts').length;
  const mans24 = recent.filter(i => i.source === 'manifestos').length;
  const eventCount = events.length;

  document.getElementById('pulse-cards').innerHTML = `
    <div class="pulse-card ${moodClass}">
      <div class="label">Dominant Mood</div>
      <div class="value">${dominantMood}</div>
      <div class="sub">Score: ${avgScore.toFixed(2)}</div>
    </div>
    <div class="pulse-card">
      <div class="label">Signals (24h)</div>
      <div class="value" style="color:var(--accent)">${total}</div>
      <div class="sub">${msgs24} chat ¬∑ ${posts24} posts ¬∑ ${mans24} manifestos</div>
    </div>
    <div class="pulse-card positive">
      <div class="label">Positive</div>
      <div class="value">${pos}</div>
      <div class="sub">${((pos/total)*100).toFixed(0)}% of signals</div>
    </div>
    <div class="pulse-card negative">
      <div class="label">Negative</div>
      <div class="value">${neg}</div>
      <div class="sub">${((neg/total)*100).toFixed(0)}% of signals</div>
    </div>
  `;

  // Overall bar
  const posPct = (pos/total)*100, neuPct = (neu/total)*100, negPct = (neg/total)*100;
  document.getElementById('overall-bar').innerHTML = `
    <div class="seg pos" style="width:${posPct}%"></div>
    <div class="seg neu" style="width:${neuPct}%"></div>
    <div class="seg neg" style="width:${negPct}%"></div>`;
  document.getElementById('pos-pct').textContent = posPct.toFixed(0) + '% positive';
  document.getElementById('neu-pct').textContent = neuPct.toFixed(0) + '% neutral';
  document.getElementById('neg-pct').textContent = negPct.toFixed(0) + '% negative';

  // Mood timeline (24h in 1h buckets)
  const buckets = Array.from({length:24}, () => ({pos:0,neg:0,total:0}));
  const now = Date.now();
  recent.forEach(item => {
    const hoursAgo = Math.floor((now - new Date(item.created_at).getTime()) / (60*60*1000));
    const idx = 23 - Math.min(hoursAgo, 23);
    buckets[idx].total++;
    if (item.label === 'positive') buckets[idx].pos++;
    if (item.label === 'negative') buckets[idx].neg++;
  });
  const maxBucket = Math.max(...buckets.map(b => b.total), 1);
  document.getElementById('mood-timeline').innerHTML = buckets.map((b, i) => {
    const h = Math.max((b.total / maxBucket) * 70 + 10, 4);
    const ratio = b.total > 0 ? (b.pos - b.neg) / b.total : 0;
    const color = ratio > 0.2 ? 'var(--positive)' : ratio < -0.2 ? 'var(--negative)' : 'var(--warm)';
    const hourLabel = (23 - i) + 'h ago';
    return `<div class="mood-bar" style="height:${h}px;background:${color}" data-tip="${hourLabel}: ${b.total} items"></div>`;
  }).join('');

  // Notable signals: highest magnitude items
  const notable = [...recent].sort((a,b) => b.magnitude - a.magnitude).slice(0, 5);
  document.getElementById('notable-signals').innerHTML = notable.length ? notable.map(renderStreamItem).join('') :
    '<div style="font-size:.75rem;color:var(--dim);padding:12px">No recent signals detected</div>';
}

// ‚îÄ‚îÄ Stream Tab ‚îÄ‚îÄ
function renderStreamItem(item) {
  const cls = item.label === 'positive' ? 'pos' : item.label === 'negative' ? 'neg' : 'neu';
  const srcLabel = item.source === 'messages' ? 'chat' : item.source === 'posts' ? 'post' : 'manifesto';
  const ago = timeAgo(item.created_at);
  const preview = item.text.length > 200 ? item.text.slice(0,200) + '‚Ä¶' : item.text;
  return `<div class="stream-item">
    <div class="sentiment-dot ${cls}"></div>
    <div style="flex:1;min-width:0">
      <div class="meta">${ESC(item.username)} ¬∑ ${srcLabel} ¬∑ ${ago}</div>
      <div class="text">${ESC(preview)}</div>
      <div class="score" style="color:var(--${cls === 'pos' ? 'positive' : cls === 'neg' ? 'negative' : 'warm'})">${item.label} (${item.score.toFixed(2)})</div>
    </div>
  </div>`;
}

function renderStream() {
  const filtered = streamFilter === 'all' ? allItems : allItems.filter(i => i.source === streamFilter);
  const page = filtered.slice(0, (streamPage + 1) * STREAM_PAGE);
  document.getElementById('sentiment-stream').innerHTML = page.length ? page.map(renderStreamItem).join('') :
    '<div class="loading">No items found</div>';
  document.getElementById('load-more-stream').style.display = page.length < filtered.length ? '' : 'none';
}

window.filterStream = function(src) {
  streamFilter = src;
  streamPage = 0;
  document.querySelectorAll('.source-btn').forEach(b => b.classList.toggle('active', b.dataset.src === src));
  renderStream();
};

window.loadMoreStream = function() {
  streamPage++;
  renderStream();
};

// ‚îÄ‚îÄ Trends Tab ‚îÄ‚îÄ
function renderTrends(items) {
  // Extract words/themes
  const wordFreq = {};
  items.forEach(item => {
    const words = (item.text || '').toLowerCase().replace(/[^a-z#]/g, ' ').split(/\s+/).filter(w => w.length > 3);
    const seen = new Set();
    words.forEach(w => {
      if (seen.has(w) || POS_WORDS.has(w) || NEG_WORDS.has(w) || INTENSIFIERS.has(w)) return;
      seen.add(w);
      if (!wordFreq[w]) wordFreq[w] = { count: 0, scores: [] };
      wordFreq[w].count++;
      wordFreq[w].scores.push(item.score);
    });
  });

  // Also extract #tags
  items.forEach(item => {
    const tags = (item.text || '').match(/#[a-zA-Z0-9_/]+/g) || [];
    tags.forEach(tag => {
      const t = tag.toLowerCase();
      if (!wordFreq[t]) wordFreq[t] = { count: 0, scores: [] };
      wordFreq[t].count++;
      wordFreq[t].scores.push(item.score);
    });
  });

  const sorted = Object.entries(wordFreq).filter(([,v]) => v.count >= 3).sort((a,b) => b[1].count - a[1].count).slice(0, 30);
  document.getElementById('trend-list').innerHTML = sorted.length ? sorted.map(([word, data], i) => {
    const avgScore = data.scores.reduce((a,b)=>a+b,0) / data.scores.length;
    const cls = avgScore > 0.1 ? 'pos' : avgScore < -0.1 ? 'neg' : 'neu';
    const moodLabel = avgScore > 0.1 ? 'positive' : avgScore < -0.1 ? 'negative' : 'neutral';
    return `<div class="trend-row">
      <div class="trend-rank">${i+1}</div>
      <div class="trend-tag">${ESC(word)}</div>
      <div class="trend-count">${data.count} uses</div>
      <div class="trend-mood ${cls}">${moodLabel}</div>
    </div>`;
  }).join('') : '<div style="font-size:.75rem;color:var(--dim);padding:12px">Not enough data for trends</div>';
}

// ‚îÄ‚îÄ Draft Tab ‚îÄ‚îÄ
let lastDraft = '';

window.generateDraft = async function(style) {
  const input = document.getElementById('draft-input').value.trim();
  if (!input) { document.getElementById('draft-hint').textContent = 'Please describe what you want to write.'; return; }

  const output = document.getElementById('draft-output');
  const actions = document.getElementById('draft-actions');
  output.className = 'draft-output visible';
  output.textContent = 'Generating...';
  actions.style.display = 'none';
  document.getElementById('draft-hint').textContent = 'Thinking...';

  // Gather community mood context
  const recent = allItems.slice(0, 50);
  const posCount = recent.filter(i => i.label === 'positive').length;
  const negCount = recent.filter(i => i.label === 'negative').length;
  const moodSummary = posCount > negCount * 2 ? 'very positive and enthusiastic' :
    negCount > posCount * 2 ? 'frustrated and critical' :
    posCount > negCount ? 'generally upbeat' : 'mixed and contemplative';

  const trendWords = extractTopWords(recent, 8);

  const styleGuide = style === 'poetic' ? 'Write in a poetic, lyrical style with vivid metaphors and rhythm.' :
    style === 'provocative' ? 'Write in a bold, provocative style that challenges assumptions and sparks debate.' :
    style === 'analytical' ? 'Write in a precise, analytical style with clear reasoning and evidence-based claims.' :
    'Write in a natural, authentic voice.';

  const prompt = `You are a creative writing assistant for an online community called Sloppygram. The community mood is currently ${moodSummary}. Trending topics include: ${trendWords.join(', ')}.

${styleGuide}

The user wants: ${input}

Write a compelling draft (150-300 words). Be creative, authentic, and match the community's energy. Do not use markdown formatting. Do not add a title unless asked.`;

  try {
    const response = await fetch(`https://text.pollinations.ai/${encodeURIComponent(prompt)}?referrer=sloppy.live`);
    if (!response.ok) throw new Error('API error');
    const text = await response.text();
    lastDraft = text.trim();
    output.textContent = lastDraft;
    actions.style.display = 'flex';
    document.getElementById('draft-hint').textContent = 'Edit the draft above, or copy it to use in Sloppy Feed or Manifestos.';
  } catch (e) {
    output.textContent = 'Failed to generate. Try again in a moment.';
    document.getElementById('draft-hint').textContent = 'AI service temporarily unavailable.';
  }
};

window.copyDraft = function() {
  navigator.clipboard.writeText(lastDraft).then(() => {
    document.getElementById('draft-hint').textContent = 'Copied to clipboard!';
  }).catch(() => {
    document.getElementById('draft-hint').textContent = 'Copy failed ‚Äî select and copy manually.';
  });
};

window.refineDraft = async function() {
  if (!lastDraft) return;
  const output = document.getElementById('draft-output');
  output.textContent = 'Refining...';
  document.getElementById('draft-hint').textContent = 'Thinking...';

  const prompt = `Take this draft and make it more punchy, tighter, and more memorable. Remove filler words. Sharpen the message. Keep roughly the same length. Do not use markdown. Do not add a title.

Draft:
${lastDraft}

Refined version:`;

  try {
    const response = await fetch(`https://text.pollinations.ai/${encodeURIComponent(prompt)}?referrer=sloppy.live`);
    if (!response.ok) throw new Error('API error');
    const text = await response.text();
    lastDraft = text.trim();
    output.textContent = lastDraft;
    document.getElementById('draft-hint').textContent = 'Refined. Copy or refine again.';
  } catch (e) {
    output.textContent = lastDraft;
    document.getElementById('draft-hint').textContent = 'Refinement failed. Original draft preserved.';
  }
};

function extractTopWords(items, n) {
  const freq = {};
  items.forEach(item => {
    const words = (item.text || '').toLowerCase().replace(/[^a-z#]/g, ' ').split(/\s+/).filter(w => w.length > 3);
    const seen = new Set();
    words.forEach(w => {
      if (seen.has(w) || POS_WORDS.has(w) || NEG_WORDS.has(w) || INTENSIFIERS.has(w)) return;
      seen.add(w);
      freq[w] = (freq[w] || 0) + 1;
    });
  });
  return Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0, n).map(([w])=>w);
}

function renderMoodContext(items) {
  const recent = items.slice(0, 50);
  const posCount = recent.filter(i => i.label === 'positive').length;
  const negCount = recent.filter(i => i.label === 'negative').length;
  const neuCount = recent.filter(i => i.label === 'neutral').length;
  const total = recent.length || 1;

  const topWords = extractTopWords(recent, 6);
  const moodDesc = posCount > negCount * 2 ? 'The community is buzzing with positivity.' :
    negCount > posCount * 2 ? 'Tension in the air ‚Äî the community is voicing frustration.' :
    'The mood is balanced ‚Äî a mix of enthusiasm and reflection.';

  document.getElementById('mood-context').innerHTML = `
    ${moodDesc}<br>
    <span style="color:var(--positive)">‚ñ≤ ${posCount} positive</span> ¬∑
    <span style="color:var(--warm)">‚óè ${neuCount} neutral</span> ¬∑
    <span style="color:var(--negative)">‚ñº ${negCount} negative</span>
    out of ${total} recent signals.<br>
    Trending themes: ${topWords.map(w => `<span style="color:var(--accent)">${ESC(w)}</span>`).join(', ') || 'none yet'}.
  `;
}

// ‚îÄ‚îÄ Tab Switching ‚îÄ‚îÄ
window.switchTab = function(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  document.querySelectorAll('.panel').forEach(p => p.classList.toggle('active', p.id === 'panel-' + tab));
};

// ‚îÄ‚îÄ Time helper ‚îÄ‚îÄ
function timeAgo(ts) {
  const s = Math.floor((Date.now() - new Date(ts).getTime()) / 1000);
  if (s < 60) return 'just now';
  if (s < 3600) return Math.floor(s/60) + 'm ago';
  if (s < 86400) return Math.floor(s/3600) + 'h ago';
  return Math.floor(s/86400) + 'd ago';
}

// ‚îÄ‚îÄ Real-time ‚îÄ‚îÄ
function setupRealtime() {
  const channel = supabase.channel('cortex-rt');
  ['sloppygram_messages','sloppygram_posts','sloppygram_manifestos'].forEach(table => {
    channel.on('postgres_changes', { event: 'INSERT', schema: 'public', table }, payload => {
      const row = payload.new;
      let item;
      if (table === 'sloppygram_messages') {
        item = { id: 'msg-'+row.id, source: 'messages', username: row.username || 'anon',
          text: row.content || '', created_at: row.created_at, ...analyzeSentiment(row.content) };
      } else if (table === 'sloppygram_posts') {
        item = { id: 'post-'+row.id, source: 'posts', username: row.username || 'anon',
          text: row.caption || '', created_at: row.created_at, likes: row.likes_count || 0,
          ...analyzeSentiment(row.caption) };
      } else {
        item = { id: 'man-'+row.id, source: 'manifestos', username: row.username || 'anon',
          text: (row.title || '') + ' ' + (row.content || '').slice(0,300), created_at: row.created_at,
          upvotes: row.upvotes || 0, ...analyzeSentiment((row.title||'') + ' ' + (row.content||'')) };
      }
      allItems.unshift(item);
      if (document.querySelector('.tab.active')?.dataset.tab === 'stream') renderStream();
    });
  });
  channel.subscribe();
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
loadData().then(setupRealtime);
</script>
<script src="/sloppy-header/sloppy-bar.js" data-position="bottom" data-minimized="true"></script>
<script src="/vibelib-extended.js"></script>
<script>
  // Compatibility Patch for Legacy Apps
  window.addEventListener("load", () => {
    if (window.SloppyKarma && window.VibeLib.Economy) {
      // Redirect old calls to new engine
      window.SloppyKarma.track = window.VibeLib.Economy.track;
    }
  });
</script>
</body>
</html>
