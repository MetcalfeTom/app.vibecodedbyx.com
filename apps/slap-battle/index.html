<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slap Battle - Turn-Based Fighting Game</title>
    <link rel="icon" href="https://emojicdn.elk.sh/üëã" type="image/x-icon">

    <!-- OG Tags -->
    <meta property="og:title" content="Slap Battle - Turn-Based Fighting Game">
    <meta property="og:description" content="Swipe faster for stronger hits! Take turns in this anime-style fighting game!">
    <meta property="og:url" content="https://app.vibecodedbyx.com/slap-battle">
    <meta property="og:image" content="https://app.vibecodedbyx.com/slap-battle/og-image.png">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
            height: 100vh;
            overflow: hidden;
            user-select: none;
            touch-action: none;
        }

        .game-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .header {
            background: rgba(0,0,0,0.3);
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
        }

        .arena {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .player {
            width: 45%;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            transition: all 0.3s;
        }

        .player.left {
            align-items: flex-start;
        }

        .player.right {
            align-items: flex-end;
        }

        .player.active {
            transform: scale(1.05);
        }

        .player.inactive {
            opacity: 0.5;
        }

        .health-bar-container {
            width: 100%;
            height: 30px;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
            border: 3px solid white;
        }

        .health-bar {
            height: 100%;
            background: linear-gradient(90deg, #4ade80 0%, #22c55e 100%);
            transition: width 0.5s ease, background 0.3s;
            border-radius: 15px;
        }

        .health-bar.low {
            background: linear-gradient(90deg, #fbbf24 0%, #f59e0b 100%);
        }

        .health-bar.critical {
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
        }

        .health-text {
            position: absolute;
            width: 100%;
            text-align: center;
            line-height: 24px;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .character {
            font-size: 8em;
            margin: 20px 0;
            animation: idle 2s ease-in-out infinite;
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3));
        }

        @keyframes idle {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(2deg); }
        }

        .character.hit {
            animation: shake 0.3s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(-20px) rotate(-15deg); }
            75% { transform: translateX(20px) rotate(15deg); }
        }

        .character.attack {
            animation: attack 0.3s ease-out;
        }

        @keyframes attack {
            0% { transform: scale(1); }
            50% { transform: scale(1.3) translateX(30px); }
            100% { transform: scale(1); }
        }

        .name-tag {
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .name-tag.active {
            background: #4ade80;
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .turn-indicator {
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: #4ade80;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            white-space: nowrap;
        }

        .damage-popup {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3em;
            font-weight: bold;
            color: #ff4444;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            opacity: 0;
            pointer-events: none;
            animation: damageAnim 1s ease-out;
        }

        @keyframes damageAnim {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -100%) scale(1.5); }
            100% { opacity: 0; transform: translate(-50%, -150%) scale(1); }
        }

        .swipe-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3em;
            opacity: 0;
            pointer-events: none;
            animation: swipeAnim 0.5s ease-out;
        }

        @keyframes swipeAnim {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(0.5); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(2); }
        }

        .game-over {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 1000;
        }

        .game-over.show {
            display: flex;
        }

        .game-over h2 {
            font-size: 3em;
            margin-bottom: 20px;
        }

        .game-over .winner {
            font-size: 5em;
            margin: 20px 0;
        }

        .game-over button {
            background: #4ade80;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: bold;
        }

        .game-over button:hover {
            background: #22c55e;
        }

        .instructions {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
            font-size: 0.9em;
        }

        .vs {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3em;
            font-weight: bold;
            color: white;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .backlink {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 100;
        }

        .backlink a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .character {
                font-size: 6em;
            }

            .vs {
                font-size: 2em;
            }

            .instructions {
                font-size: 0.8em;
                padding: 10px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container" id="gameContainer">
        <div class="header">
            SLAP BATTLE - TAKE TURNS!
        </div>

        <div class="backlink">
            <a href="https://www.vibecodedbyx.com">‚Üê Back</a>
        </div>

        <div class="arena" id="arena">
            <!-- Player 1 (Left) -->
            <div class="player left active" id="player1Container">
                <div class="name-tag active" id="name1">Sakura</div>
                <div class="health-bar-container">
                    <div class="health-bar" id="health1" style="width: 100%;"></div>
                    <div class="health-text" id="healthText1">100</div>
                </div>
                <div class="character" id="char1">üßö‚Äç‚ôÄÔ∏è</div>
                <div class="turn-indicator" id="turn1">YOUR TURN!</div>
            </div>

            <div class="vs">VS</div>

            <!-- Player 2 (Right) -->
            <div class="player right inactive" id="player2Container">
                <div class="name-tag" id="name2">Yuki</div>
                <div class="health-bar-container">
                    <div class="health-bar" id="health2" style="width: 100%;"></div>
                    <div class="health-text" id="healthText2">100</div>
                </div>
                <div class="character" id="char2">üë∏</div>
                <div class="turn-indicator" id="turn2" style="display: none;">YOUR TURN!</div>
            </div>
        </div>

        <div class="instructions">
            <strong>Take turns!</strong><br>
            <strong>Mobile:</strong> Swipe FAST for more damage!<br>
            <strong>Desktop:</strong> Press A or D (faster = stronger)
        </div>

        <div class="game-over" id="gameOver">
            <h2>GAME OVER!</h2>
            <div class="winner" id="winnerChar"></div>
            <p id="winnerText"></p>
            <button onclick="resetGame()">Play Again</button>
        </div>
    </div>

    <script src="../../supabase-config.js"></script>
    <script>
        let player1Health = 100;
        let player2Health = 100;
        let touchStartX = 0;
        let touchStartY = 0;
        let touchStartTime = 0;
        let gameActive = true;
        const minSwipeDistance = 50;
        const baseDamage = 10;
        const maxDamage = 30;
        let currentTurn = 1; // 1 for player 1, 2 for player 2

        const arena = document.getElementById('arena');
        const char1 = document.getElementById('char1');
        const char2 = document.getElementById('char2');
        const health1 = document.getElementById('health1');
        const health2 = document.getElementById('health2');
        const healthText1 = document.getElementById('healthText1');
        const healthText2 = document.getElementById('healthText2');
        const gameOver = document.getElementById('gameOver');
        const player1Container = document.getElementById('player1Container');
        const player2Container = document.getElementById('player2Container');
        const name1 = document.getElementById('name1');
        const name2 = document.getElementById('name2');
        const turn1 = document.getElementById('turn1');
        const turn2 = document.getElementById('turn2');

        // Touch event handlers
        arena.addEventListener('touchstart', handleTouchStart, false);
        arena.addEventListener('touchmove', handleTouchMove, false);
        arena.addEventListener('touchend', handleTouchEnd, false);

        // Mouse events for desktop
        arena.addEventListener('mousedown', handleMouseDown, false);
        arena.addEventListener('mouseup', handleMouseUp, false);

        // Keyboard events for desktop
        document.addEventListener('keydown', handleKeyPress, false);

        let mouseStartX = 0;
        let mouseStartTime = 0;

        function handleMouseDown(e) {
            mouseStartX = e.clientX;
            mouseStartTime = Date.now();
        }

        function handleMouseUp(e) {
            const deltaX = e.clientX - mouseStartX;
            const deltaTime = Date.now() - mouseStartTime;
            const velocity = Math.abs(deltaX) / (deltaTime / 1000); // pixels per second

            if (Math.abs(deltaX) > minSwipeDistance) {
                if (currentTurn === 1 && deltaX > 0) {
                    // Player 1's turn, swipe right
                    const damage = calculateDamage(velocity, 1);
                    attackPlayer(2, damage);
                    showSwipeIndicator('üí•', 'right');
                } else if (currentTurn === 2 && deltaX < 0) {
                    // Player 2's turn, swipe left
                    const damage = calculateDamage(velocity, 2);
                    attackPlayer(1, damage);
                    showSwipeIndicator('üí•', 'left');
                }
            }
        }

        function handleKeyPress(e) {
            if (!gameActive) return;

            // Simulate velocity for keyboard (medium-high speed)
            const keyVelocity = 600;

            if ((e.key === 'd' || e.key === 'D' || e.key === 'ArrowRight') && currentTurn === 1) {
                // Player 1 attacks
                const damage = calculateDamage(keyVelocity, 1);
                attackPlayer(2, damage);
                showSwipeIndicator('üí•', 'right');
            } else if ((e.key === 'a' || e.key === 'A' || e.key === 'ArrowLeft') && currentTurn === 2) {
                // Player 2 attacks
                const damage = calculateDamage(keyVelocity, 2);
                attackPlayer(1, damage);
                showSwipeIndicator('üí•', 'left');
            }
        }

        function handleTouchStart(e) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            touchStartTime = Date.now();
        }

        function handleTouchMove(e) {
            e.preventDefault();
        }

        function handleTouchEnd(e) {
            if (!gameActive) return;

            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            const touchEndTime = Date.now();

            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            const deltaTime = touchEndTime - touchStartTime;

            // Calculate swipe velocity (pixels per second)
            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
            const velocity = distance / (deltaTime / 1000);

            // Check if swipe is primarily horizontal
            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > minSwipeDistance) {
                if (deltaX > 0 && currentTurn === 1) {
                    // Swipe right - Player 1 attacks Player 2
                    const damage = calculateDamage(velocity, 1);
                    attackPlayer(2, damage);
                    showSwipeIndicator('üí•', 'right');
                } else if (deltaX < 0 && currentTurn === 2) {
                    // Swipe left - Player 2 attacks Player 1
                    const damage = calculateDamage(velocity, 2);
                    attackPlayer(1, damage);
                    showSwipeIndicator('üí•', 'left');
                }
            }
        }

        function calculateDamage(velocity, player) {
            // Player 1 has disadvantage - needs to swipe faster for same damage
            let adjustedVelocity = velocity;
            if (player === 1) {
                adjustedVelocity = velocity * 0.7; // Player 1 disadvantage: 30% velocity penalty
            }

            // Map velocity to damage - MORE SENSITIVE to speed differences
            // Lower threshold (800 instead of 1500) means swipe speed matters more
            const normalizedVelocity = Math.min(adjustedVelocity / 800, 1); // normalize to 0-1
            const baseDamageCalc = baseDamage + (normalizedVelocity * (maxDamage - baseDamage));

            // Add randomness: ¬±20% variance
            const randomFactor = 0.8 + (Math.random() * 0.4); // Random between 0.8 and 1.2
            const damage = baseDamageCalc * randomFactor;

            return Math.round(damage);
        }

        function attackPlayer(target, damage) {
            if (!gameActive) return;

            if (target === 1) {
                // Player 2 attacks Player 1
                player1Health = Math.max(0, player1Health - damage);
                updateHealth(1, player1Health);
                showDamagePopup(damage, 'left');
                char1.classList.add('hit');
                char2.classList.add('attack');
                setTimeout(() => {
                    char1.classList.remove('hit');
                    char2.classList.remove('attack');
                }, 300);
            } else {
                // Player 1 attacks Player 2
                player2Health = Math.max(0, player2Health - damage);
                updateHealth(2, player2Health);
                showDamagePopup(damage, 'right');
                char2.classList.add('hit');
                char1.classList.add('attack');
                setTimeout(() => {
                    char2.classList.remove('hit');
                    char1.classList.remove('attack');
                }, 300);
            }

            if (!checkGameOver()) {
                switchTurn();
            }
        }

        function switchTurn() {
            currentTurn = currentTurn === 1 ? 2 : 1;

            if (currentTurn === 1) {
                player1Container.classList.add('active');
                player1Container.classList.remove('inactive');
                player2Container.classList.add('inactive');
                player2Container.classList.remove('active');
                name1.classList.add('active');
                name2.classList.remove('active');
                turn1.style.display = 'block';
                turn2.style.display = 'none';
            } else {
                player2Container.classList.add('active');
                player2Container.classList.remove('inactive');
                player1Container.classList.add('inactive');
                player1Container.classList.remove('active');
                name2.classList.add('active');
                name1.classList.remove('active');
                turn2.style.display = 'block';
                turn1.style.display = 'none';
            }
        }

        function updateHealth(player, health) {
            const healthBar = player === 1 ? health1 : health2;
            const healthText = player === 1 ? healthText1 : healthText2;

            healthBar.style.width = health + '%';
            healthText.textContent = Math.round(health);

            // Change color based on health
            healthBar.classList.remove('low', 'critical');
            if (health <= 30) {
                healthBar.classList.add('critical');
            } else if (health <= 50) {
                healthBar.classList.add('low');
            }
        }

        function showDamagePopup(damage, side) {
            const popup = document.createElement('div');
            popup.className = 'damage-popup';
            popup.textContent = `-${damage}`;
            popup.style.left = side === 'left' ? '25%' : '75%';
            arena.appendChild(popup);
            setTimeout(() => popup.remove(), 1000);
        }

        function showSwipeIndicator(emoji, direction) {
            const indicator = document.createElement('div');
            indicator.className = 'swipe-indicator';
            indicator.textContent = emoji;
            indicator.style.left = direction === 'right' ? '75%' : '25%';
            arena.appendChild(indicator);
            setTimeout(() => indicator.remove(), 500);
        }

        function checkGameOver() {
            if (player1Health <= 0) {
                endGame(2);
                return true;
            } else if (player2Health <= 0) {
                endGame(1);
                return true;
            }
            return false;
        }

        function endGame(winner) {
            gameActive = false;
            const winnerChar = winner === 1 ? 'üßö‚Äç‚ôÄÔ∏è' : 'üë∏';
            const winnerName = winner === 1 ? 'Sakura' : 'Yuki';

            document.getElementById('winnerChar').textContent = winnerChar;
            document.getElementById('winnerText').textContent = `${winnerName} Wins!`;
            gameOver.classList.add('show');

            turn1.style.display = 'none';
            turn2.style.display = 'none';
        }

        function resetGame() {
            player1Health = 100;
            player2Health = 100;
            gameActive = true;
            currentTurn = 1;

            updateHealth(1, 100);
            updateHealth(2, 100);

            player1Container.classList.add('active');
            player1Container.classList.remove('inactive');
            player2Container.classList.add('inactive');
            player2Container.classList.remove('active');
            name1.classList.add('active');
            name2.classList.remove('active');
            turn1.style.display = 'block';
            turn2.style.display = 'none';

            gameOver.classList.remove('show');
        }

        // Optional: Supabase auth
        if (typeof supabase !== 'undefined') {
            supabase.auth.getSession().then(({ data: { session } }) => {
                if (session) {
                    console.log('User logged in:', session.user.id);
                }
            });
        }
    </script>
</body>
</html>
