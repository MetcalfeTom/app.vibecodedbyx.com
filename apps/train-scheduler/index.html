<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>M√§rklin Train Scheduler</title>
  <link rel="icon" href="https://emojicdn.elk.sh/üöÇ">
  <meta property="og:title" content="M√§rklin Train Scheduler">
  <meta property="og:description" content="Real-time train scheduling with priority tasks and track switching">
  <meta property="og:url" content="https://app.sloppy.live/train-scheduler">
  <meta property="og:image" content="https://emojicdn.elk.sh/üöÇ?style=apple&size=512">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=IBM+Plex+Sans:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #0d1117;
      --panel: #161b22;
      --border: #30363d;
      --green: #3fb950;
      --yellow: #d29922;
      --red: #f85149;
      --blue: #58a6ff;
      --purple: #a371f7;
      --cyan: #39c5cf;
      --text: #c9d1d9;
      --muted: #8b949e;
    }

    body {
      background: var(--bg);
      font-family: 'IBM Plex Sans', sans-serif;
      color: var(--text);
      min-height: 100vh;
    }

    .container {
      display: grid;
      grid-template-columns: 1fr 400px;
      grid-template-rows: auto 1fr auto;
      height: 100vh;
      gap: 1px;
      background: var(--border);
    }

    @media (max-width: 1000px) {
      .container {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto 1fr auto;
      }
    }

    /* Header */
    header {
      grid-column: 1 / -1;
      background: var(--panel);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo h1 {
      font-size: 1.3rem;
      font-weight: 600;
    }

    .logo span {
      color: var(--yellow);
    }

    .status-bar {
      display: flex;
      gap: 20px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: blink 1s ease-in-out infinite;
    }

    .status-dot.running { background: var(--green); }
    .status-dot.warning { background: var(--yellow); }
    .status-dot.error { background: var(--red); }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Track Visualization */
    .track-panel {
      background: var(--panel);
      padding: 20px;
      overflow: hidden;
    }

    .track-canvas {
      width: 100%;
      height: 100%;
      min-height: 400px;
    }

    /* Side Panel */
    .side-panel {
      background: var(--panel);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
    }

    .tab {
      flex: 1;
      padding: 12px;
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-family: inherit;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .tab:hover {
      color: var(--text);
      background: rgba(255,255,255,0.05);
    }

    .tab.active {
      color: var(--blue);
      border-bottom: 2px solid var(--blue);
    }

    .tab-content {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Task Queue */
    .task-queue {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .task {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px 12px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
    }

    .task.running {
      border-color: var(--green);
      background: rgba(63, 185, 80, 0.1);
    }

    .task.waiting {
      border-color: var(--yellow);
    }

    .task.blocked {
      border-color: var(--red);
      opacity: 0.6;
    }

    .task-info {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .task-name {
      font-weight: 700;
    }

    .task-meta {
      color: var(--muted);
      font-size: 0.7rem;
    }

    .task-priority {
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 700;
    }

    .priority-high { background: var(--red); color: white; }
    .priority-medium { background: var(--yellow); color: black; }
    .priority-low { background: var(--blue); color: white; }

    /* Code Display */
    .code-block {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .code-header {
      background: rgba(255,255,255,0.05);
      padding: 8px 12px;
      font-size: 0.75rem;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
    }

    .code-content {
      padding: 12px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      line-height: 1.5;
      overflow-x: auto;
      white-space: pre;
    }

    .code-content .keyword { color: var(--purple); }
    .code-content .type { color: var(--cyan); }
    .code-content .function { color: var(--blue); }
    .code-content .string { color: var(--green); }
    .code-content .number { color: var(--yellow); }
    .code-content .comment { color: var(--muted); }
    .code-content .macro { color: var(--red); }

    /* Switches Panel */
    .switches-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .switch-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .switch-card:hover {
      border-color: var(--blue);
    }

    .switch-card.active {
      border-color: var(--green);
      background: rgba(63, 185, 80, 0.1);
    }

    .switch-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .switch-id {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 700;
    }

    .switch-state {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 3px;
    }

    .switch-state.straight {
      background: var(--green);
      color: white;
    }

    .switch-state.diverge {
      background: var(--yellow);
      color: black;
    }

    .switch-visual {
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    /* Controls */
    .controls {
      grid-column: 1 / -1;
      background: var(--panel);
      padding: 15px 20px;
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn {
      background: var(--blue);
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.9rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn:hover {
      filter: brightness(1.1);
    }

    .btn.danger { background: var(--red); }
    .btn.success { background: var(--green); }
    .btn.warning { background: var(--yellow); color: black; }
    .btn.secondary { background: var(--border); }

    .speed-control {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.85rem;
    }

    .speed-control input {
      width: 120px;
    }

    /* Log */
    .log-panel {
      max-height: 150px;
      overflow-y: auto;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      flex: 1;
    }

    .log-entry {
      padding: 4px 0;
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 10px;
    }

    .log-time {
      color: var(--muted);
      min-width: 80px;
    }

    .log-level {
      min-width: 50px;
    }

    .log-level.info { color: var(--blue); }
    .log-level.warn { color: var(--yellow); }
    .log-level.error { color: var(--red); }
    .log-level.task { color: var(--green); }

    /* Train Info */
    .train-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .train-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
    }

    .train-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .train-name {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .train-speed {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      color: var(--cyan);
    }

    .train-bar {
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
    }

    .train-bar-fill {
      height: 100%;
      background: var(--green);
      transition: width 0.3s;
    }

    .train-meta {
      margin-top: 8px;
      font-size: 0.75rem;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
    }

    .back-link {
      position: fixed;
      bottom: 10px;
      right: 10px;
      color: var(--muted);
      text-decoration: none;
      font-size: 0.7rem;
      z-index: 100;
    }

    .back-link:hover { color: var(--blue); }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <span style="font-size: 1.5rem;">üöÇ</span>
        <h1><span>M√§rklin</span> Train Scheduler</h1>
      </div>
      <div class="status-bar">
        <div class="status-item">
          <div class="status-dot running" id="rtos-status"></div>
          <span>RTOS: <span id="rtos-state">Running</span></span>
        </div>
        <div class="status-item">
          <span>Tick: <span id="tick-counter">0</span></span>
        </div>
        <div class="status-item">
          <span>Tasks: <span id="active-tasks">0</span>/8</span>
        </div>
      </div>
    </header>

    <div class="track-panel">
      <canvas class="track-canvas" id="track-canvas"></canvas>
    </div>

    <div class="side-panel">
      <div class="tabs">
        <button class="tab active" onclick="showTab('tasks')">Tasks</button>
        <button class="tab" onclick="showTab('switches')">Switches</button>
        <button class="tab" onclick="showTab('code')">Code</button>
        <button class="tab" onclick="showTab('trains')">Trains</button>
      </div>

      <div class="tab-content active" id="tab-tasks">
        <h3 style="margin-bottom: 12px; font-size: 0.9rem;">Priority Task Queue</h3>
        <div class="task-queue" id="task-queue"></div>
      </div>

      <div class="tab-content" id="tab-switches">
        <h3 style="margin-bottom: 12px; font-size: 0.9rem;">Track Switches (Weichen)</h3>
        <div class="switches-grid" id="switches-grid"></div>
      </div>

      <div class="tab-content" id="tab-code">
        <div class="code-block">
          <div class="code-header">
            <span>scheduler.c</span>
            <span>Embedded C</span>
          </div>
          <div class="code-content" id="code-scheduler"></div>
        </div>
        <div class="code-block">
          <div class="code-header">
            <span>marklin_protocol.c</span>
            <span>DCC Protocol</span>
          </div>
          <div class="code-content" id="code-protocol"></div>
        </div>
      </div>

      <div class="tab-content" id="tab-trains">
        <div class="train-list" id="train-list"></div>
      </div>
    </div>

    <div class="controls">
      <button class="btn success" id="start-btn" onclick="toggleSimulation()">
        <span>‚ñ∂</span> Start
      </button>
      <button class="btn warning" onclick="emergencyStop()">
        <span>‚ö†</span> E-Stop
      </button>
      <button class="btn secondary" onclick="addTrain()">
        <span>+</span> Add Train
      </button>
      <button class="btn secondary" onclick="resetSimulation()">
        <span>‚Ü∫</span> Reset
      </button>
      <div class="speed-control">
        <label>Sim Speed:</label>
        <input type="range" id="speed-slider" min="1" max="10" value="5">
        <span id="speed-value">1x</span>
      </div>
      <div class="log-panel" id="log-panel"></div>
    </div>
  </div>

  <a href="https://sloppy.live" class="back-link">‚Üê sloppy.live</a>

  <script>
    // ==========================================
    // EMBEDDED C SIMULATION - M√§rklin Controller
    // ==========================================

    // Simulated embedded system constants
    const TICK_RATE_MS = 100;
    const MAX_TASKS = 8;
    const MAX_TRAINS = 4;
    const MAX_SWITCHES = 6;

    // Priority levels (lower = higher priority)
    const PRIORITY = {
      EMERGENCY: 0,
      COLLISION: 1,
      SWITCH: 2,
      SPEED: 3,
      SENSOR: 4,
      IDLE: 7
    };

    // Task states
    const TASK_STATE = {
      READY: 'ready',
      RUNNING: 'running',
      BLOCKED: 'blocked',
      WAITING: 'waiting'
    };

    // Track switch states
    const SWITCH_STATE = {
      STRAIGHT: 0,
      DIVERGE: 1
    };

    // System state
    let state = {
      running: false,
      tick: 0,
      trains: [],
      switches: [],
      tasks: [],
      taskQueue: [],
      logs: [],
      emergencyStop: false
    };

    // Canvas
    const canvas = document.getElementById('track-canvas');
    const ctx = canvas.getContext('2d');

    // Track layout definition
    const trackLayout = {
      segments: [
        { id: 'main1', type: 'straight', x1: 50, y1: 200, x2: 200, y2: 200 },
        { id: 'main2', type: 'straight', x1: 250, y1: 200, x2: 450, y2: 200 },
        { id: 'main3', type: 'straight', x1: 500, y1: 200, x2: 700, y2: 200 },
        { id: 'siding1', type: 'curve', x1: 200, y1: 200, x2: 250, y2: 120, cp: { x: 250, y: 200 } },
        { id: 'siding2', type: 'straight', x1: 250, y1: 120, x2: 500, y2: 120 },
        { id: 'siding3', type: 'curve', x1: 500, y1: 120, x2: 550, y2: 200, cp: { x: 500, y: 200 } },
        { id: 'loop1', type: 'curve', x1: 700, y1: 200, x2: 650, y2: 300, cp: { x: 700, y: 300 } },
        { id: 'loop2', type: 'straight', x1: 650, y1: 300, x2: 100, y2: 300 },
        { id: 'loop3', type: 'curve', x1: 100, y1: 300, x2: 50, y2: 200, cp: { x: 50, y: 300 } }
      ],
      switches: [
        { id: 'SW1', x: 200, y: 200, state: SWITCH_STATE.STRAIGHT, angle: 0 },
        { id: 'SW2', x: 500, y: 200, state: SWITCH_STATE.STRAIGHT, angle: 0 },
        { id: 'SW3', x: 500, y: 120, state: SWITCH_STATE.STRAIGHT, angle: 180 },
        { id: 'SW4', x: 700, y: 200, state: SWITCH_STATE.STRAIGHT, angle: 90 },
        { id: 'SW5', x: 50, y: 200, state: SWITCH_STATE.STRAIGHT, angle: -90 },
        { id: 'SW6', x: 250, y: 120, state: SWITCH_STATE.STRAIGHT, angle: 0 }
      ],
      sensors: [
        { id: 'S1', x: 100, y: 200, triggered: false },
        { id: 'S2', x: 350, y: 200, triggered: false },
        { id: 'S3', x: 600, y: 200, triggered: false },
        { id: 'S4', x: 375, y: 120, triggered: false },
        { id: 'S5', x: 375, y: 300, triggered: false }
      ]
    };

    // Initialize switches
    function initSwitches() {
      state.switches = trackLayout.switches.map(sw => ({
        ...sw,
        lastChange: 0,
        locked: false
      }));
      renderSwitches();
    }

    // Initialize a train
    function createTrain(id, color) {
      return {
        id,
        name: `Train ${id}`,
        color,
        position: Math.random() * 0.8,
        speed: 0,
        targetSpeed: 0,
        direction: 1,
        track: 'main',
        emergency: false
      };
    }

    // Priority-based task scheduler (simulating embedded RTOS)
    class Task {
      constructor(name, priority, handler, period = 0) {
        this.name = name;
        this.priority = priority;
        this.handler = handler;
        this.period = period;
        this.nextRun = 0;
        this.state = TASK_STATE.READY;
        this.wcet = 0; // Worst-case execution time
        this.deadline = 0;
      }
    }

    // Scheduler - Rate Monotonic inspired
    function schedulerTick() {
      state.tick++;

      // Update ready tasks
      state.tasks.forEach(task => {
        if (task.period > 0 && state.tick >= task.nextRun) {
          task.state = TASK_STATE.READY;
        }
      });

      // Sort by priority (lower number = higher priority)
      const readyTasks = state.tasks
        .filter(t => t.state === TASK_STATE.READY)
        .sort((a, b) => a.priority - b.priority);

      // Run highest priority task
      if (readyTasks.length > 0) {
        const task = readyTasks[0];
        task.state = TASK_STATE.RUNNING;

        try {
          task.handler();
          task.wcet = Math.max(task.wcet, 1);
        } catch (e) {
          log('error', `Task ${task.name} failed: ${e.message}`);
        }

        task.state = TASK_STATE.WAITING;
        if (task.period > 0) {
          task.nextRun = state.tick + task.period;
        }
      }

      renderTaskQueue();
      updateStatusBar();
    }

    // Task handlers
    function collisionDetectionTask() {
      // Check for potential collisions
      for (let i = 0; i < state.trains.length; i++) {
        for (let j = i + 1; j < state.trains.length; j++) {
          const t1 = state.trains[i];
          const t2 = state.trains[j];
          if (t1.track === t2.track) {
            const dist = Math.abs(t1.position - t2.position);
            if (dist < 0.1) {
              log('warn', `Collision risk: ${t1.name} ‚Üî ${t2.name}`);
              t1.targetSpeed = 0;
              t2.targetSpeed = 0;
            }
          }
        }
      }
    }

    function switchControlTask() {
      // Process pending switch commands
      state.switches.forEach(sw => {
        if (sw.pending !== undefined && !sw.locked) {
          const oldState = sw.state;
          sw.state = sw.pending;
          sw.lastChange = state.tick;
          sw.pending = undefined;
          log('task', `Switch ${sw.id}: ${oldState ? 'DIV' : 'STR'} ‚Üí ${sw.state ? 'DIV' : 'STR'}`);
          renderSwitches();
        }
      });
    }

    function speedControlTask() {
      // Gradual speed changes (acceleration/deceleration)
      state.trains.forEach(train => {
        if (train.emergency) {
          train.speed = Math.max(0, train.speed - 20);
        } else if (train.speed < train.targetSpeed) {
          train.speed = Math.min(train.targetSpeed, train.speed + 5);
        } else if (train.speed > train.targetSpeed) {
          train.speed = Math.max(train.targetSpeed, train.speed - 5);
        }
      });
    }

    function sensorPollingTask() {
      // Check sensor states
      trackLayout.sensors.forEach(sensor => {
        const wasTriggered = sensor.triggered;
        sensor.triggered = state.trains.some(train => {
          const trainX = getTrainPosition(train).x;
          return Math.abs(trainX - sensor.x) < 30;
        });
        if (sensor.triggered && !wasTriggered) {
          log('info', `Sensor ${sensor.id} triggered`);
        }
      });
    }

    function trainMovementTask() {
      state.trains.forEach(train => {
        if (train.speed > 0) {
          train.position += (train.speed / 1000) * train.direction;
          if (train.position > 1) train.position = 0;
          if (train.position < 0) train.position = 1;
        }
      });
    }

    // Initialize scheduler tasks
    function initScheduler() {
      state.tasks = [
        new Task('EMERGENCY', PRIORITY.EMERGENCY, () => {
          if (state.emergencyStop) {
            state.trains.forEach(t => { t.emergency = true; t.targetSpeed = 0; });
          }
        }, 1),
        new Task('COLLISION', PRIORITY.COLLISION, collisionDetectionTask, 2),
        new Task('SWITCH_CTRL', PRIORITY.SWITCH, switchControlTask, 3),
        new Task('SPEED_CTRL', PRIORITY.SPEED, speedControlTask, 2),
        new Task('SENSOR_POLL', PRIORITY.SENSOR, sensorPollingTask, 5),
        new Task('TRAIN_MOVE', PRIORITY.IDLE, trainMovementTask, 1)
      ];
    }

    // Get train visual position
    function getTrainPosition(train) {
      const t = train.position;
      if (train.track === 'main') {
        return { x: 50 + t * 650, y: 200 };
      } else if (train.track === 'siding') {
        return { x: 250 + t * 250, y: 120 };
      } else {
        return { x: 100 + t * 550, y: 300 };
      }
    }

    // Rendering
    function resizeCanvas() {
      canvas.width = canvas.parentElement.clientWidth;
      canvas.height = canvas.parentElement.clientHeight;
    }

    function render() {
      const w = canvas.width;
      const h = canvas.height;

      // Clear
      ctx.fillStyle = '#0d1117';
      ctx.fillRect(0, 0, w, h);

      // Scale for responsive
      const scale = Math.min(w / 800, h / 400);
      ctx.save();
      ctx.translate(w / 2 - 375 * scale, h / 2 - 200 * scale);
      ctx.scale(scale, scale);

      // Draw tracks
      ctx.strokeStyle = '#30363d';
      ctx.lineWidth = 8;
      ctx.lineCap = 'round';

      // Main line
      ctx.beginPath();
      ctx.moveTo(50, 200);
      ctx.lineTo(700, 200);
      ctx.stroke();

      // Siding
      ctx.beginPath();
      ctx.moveTo(200, 200);
      ctx.quadraticCurveTo(225, 200, 250, 120);
      ctx.lineTo(500, 120);
      ctx.quadraticCurveTo(525, 200, 550, 200);
      ctx.stroke();

      // Loop
      ctx.beginPath();
      ctx.moveTo(700, 200);
      ctx.quadraticCurveTo(700, 300, 650, 300);
      ctx.lineTo(100, 300);
      ctx.quadraticCurveTo(50, 300, 50, 200);
      ctx.stroke();

      // Draw active track in green
      ctx.strokeStyle = '#3fb950';
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.moveTo(50, 200);
      ctx.lineTo(700, 200);
      ctx.stroke();

      // Draw switches
      state.switches.forEach(sw => {
        ctx.fillStyle = sw.state === SWITCH_STATE.STRAIGHT ? '#3fb950' : '#d29922';
        ctx.beginPath();
        ctx.arc(sw.x, sw.y, 8, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = '#fff';
        ctx.font = '10px JetBrains Mono';
        ctx.textAlign = 'center';
        ctx.fillText(sw.id, sw.x, sw.y - 15);
      });

      // Draw sensors
      trackLayout.sensors.forEach(sensor => {
        ctx.fillStyle = sensor.triggered ? '#f85149' : '#8b949e';
        ctx.fillRect(sensor.x - 5, sensor.y - 3, 10, 6);
      });

      // Draw trains
      state.trains.forEach(train => {
        const pos = getTrainPosition(train);

        // Train body
        ctx.fillStyle = train.color;
        ctx.shadowColor = train.color;
        ctx.shadowBlur = train.speed > 0 ? 10 : 0;
        ctx.beginPath();
        ctx.roundRect(pos.x - 25, pos.y - 10, 50, 20, 5);
        ctx.fill();
        ctx.shadowBlur = 0;

        // Train ID
        ctx.fillStyle = '#000';
        ctx.font = 'bold 12px JetBrains Mono';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(train.id, pos.x, pos.y);

        // Speed indicator
        if (train.speed > 0) {
          ctx.fillStyle = '#fff';
          ctx.font = '10px JetBrains Mono';
          ctx.fillText(`${train.speed}%`, pos.x, pos.y - 20);
        }
      });

      ctx.restore();

      if (state.running) {
        requestAnimationFrame(render);
      }
    }

    // UI Updates
    function renderTaskQueue() {
      const container = document.getElementById('task-queue');
      container.innerHTML = state.tasks
        .sort((a, b) => a.priority - b.priority)
        .map(task => `
          <div class="task ${task.state}">
            <div class="task-info">
              <span class="task-name">${task.name}</span>
              <span class="task-meta">Period: ${task.period} ticks | WCET: ${task.wcet}ms</span>
            </div>
            <span class="task-priority priority-${task.priority <= 1 ? 'high' : task.priority <= 3 ? 'medium' : 'low'}">
              P${task.priority}
            </span>
          </div>
        `).join('');
    }

    function renderSwitches() {
      const container = document.getElementById('switches-grid');
      container.innerHTML = state.switches.map(sw => `
        <div class="switch-card ${sw.state === SWITCH_STATE.STRAIGHT ? '' : 'active'}"
             onclick="toggleSwitch('${sw.id}')">
          <div class="switch-header">
            <span class="switch-id">${sw.id}</span>
            <span class="switch-state ${sw.state === SWITCH_STATE.STRAIGHT ? 'straight' : 'diverge'}">
              ${sw.state === SWITCH_STATE.STRAIGHT ? 'STRAIGHT' : 'DIVERGE'}
            </span>
          </div>
          <div class="switch-visual">
            ${sw.state === SWITCH_STATE.STRAIGHT ? '‚îÅ‚îÅ‚îÅ' : '‚îÅ‚ï±'}
          </div>
        </div>
      `).join('');
    }

    function renderTrains() {
      const container = document.getElementById('train-list');
      container.innerHTML = state.trains.map(train => `
        <div class="train-card">
          <div class="train-header">
            <span class="train-name">
              <span style="color: ${train.color}">‚óè</span> ${train.name}
            </span>
            <span class="train-speed">${train.speed}%</span>
          </div>
          <div class="train-bar">
            <div class="train-bar-fill" style="width: ${train.speed}%; background: ${train.color}"></div>
          </div>
          <div class="train-meta">
            <span>Track: ${train.track}</span>
            <span>Pos: ${(train.position * 100).toFixed(1)}%</span>
          </div>
          <div style="margin-top: 10px; display: flex; gap: 5px;">
            <button class="btn secondary" style="padding: 5px 10px; font-size: 0.75rem;"
                    onclick="setTrainSpeed(${train.id}, 0)">Stop</button>
            <button class="btn secondary" style="padding: 5px 10px; font-size: 0.75rem;"
                    onclick="setTrainSpeed(${train.id}, 50)">50%</button>
            <button class="btn secondary" style="padding: 5px 10px; font-size: 0.75rem;"
                    onclick="setTrainSpeed(${train.id}, 100)">100%</button>
          </div>
        </div>
      `).join('');
    }

    function updateStatusBar() {
      document.getElementById('tick-counter').textContent = state.tick;
      document.getElementById('active-tasks').textContent =
        state.tasks.filter(t => t.state !== TASK_STATE.WAITING).length;
    }

    function log(level, message) {
      const time = `${Math.floor(state.tick / 10)}.${state.tick % 10}s`;
      state.logs.unshift({ time, level, message });
      if (state.logs.length > 50) state.logs.pop();

      const container = document.getElementById('log-panel');
      container.innerHTML = state.logs.slice(0, 10).map(l => `
        <div class="log-entry">
          <span class="log-time">[${l.time}]</span>
          <span class="log-level ${l.level}">${l.level.toUpperCase()}</span>
          <span>${l.message}</span>
        </div>
      `).join('');
    }

    // Code display
    function renderCode() {
      document.getElementById('code-scheduler').innerHTML = `<span class="comment">/* Priority-Based Real-Time Scheduler */</span>
<span class="macro">#define</span> MAX_TASKS 8
<span class="macro">#define</span> TICK_RATE_MS 100

<span class="keyword">typedef</span> <span class="keyword">struct</span> {
    <span class="type">uint8_t</span>  priority;    <span class="comment">// 0 = highest</span>
    <span class="type">uint16_t</span> period;      <span class="comment">// ticks</span>
    <span class="type">uint16_t</span> deadline;
    <span class="type">void</span>     (*handler)(<span class="type">void</span>);
    <span class="type">TaskState</span> state;
} <span class="type">Task_t</span>;

<span class="type">void</span> <span class="function">scheduler_tick</span>(<span class="type">void</span>) {
    <span class="type">Task_t</span>* highest = <span class="number">NULL</span>;

    <span class="comment">// Find highest priority ready task</span>
    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i < task_count; i++) {
        <span class="keyword">if</span> (tasks[i].state == READY) {
            <span class="keyword">if</span> (!highest ||
                tasks[i].priority < highest->priority) {
                highest = &tasks[i];
            }
        }
    }

    <span class="keyword">if</span> (highest) {
        highest->state = RUNNING;
        highest-><span class="function">handler</span>();
        highest->state = WAITING;
        highest->next_run = tick + highest->period;
    }
}`;

      document.getElementById('code-protocol').innerHTML = `<span class="comment">/* M√§rklin Digital Protocol (DCC-like) */</span>
<span class="macro">#define</span> DCC_PREAMBLE  <span class="number">0xFF</span>
<span class="macro">#define</span> CMD_SPEED     <span class="number">0x40</span>
<span class="macro">#define</span> CMD_SWITCH    <span class="number">0x80</span>
<span class="macro">#define</span> CMD_ESTOP     <span class="number">0x00</span>

<span class="type">void</span> <span class="function">send_speed_cmd</span>(<span class="type">uint8_t</span> addr, <span class="type">uint8_t</span> speed) {
    <span class="type">uint8_t</span> packet[<span class="number">4</span>];
    packet[<span class="number">0</span>] = DCC_PREAMBLE;
    packet[<span class="number">1</span>] = addr;
    packet[<span class="number">2</span>] = CMD_SPEED | (speed & <span class="number">0x1F</span>);
    packet[<span class="number">3</span>] = packet[<span class="number">1</span>] ^ packet[<span class="number">2</span>]; <span class="comment">// XOR checksum</span>

    <span class="function">dcc_transmit</span>(packet, <span class="number">4</span>);
}

<span class="type">void</span> <span class="function">set_switch</span>(<span class="type">uint8_t</span> addr, <span class="type">SwitchState</span> state) {
    <span class="comment">// Real-time constraint: 50ms max latency</span>
    <span class="type">uint8_t</span> packet[<span class="number">4</span>];
    packet[<span class="number">0</span>] = DCC_PREAMBLE;
    packet[<span class="number">1</span>] = <span class="number">0x80</span> | addr;  <span class="comment">// Accessory address</span>
    packet[<span class="number">2</span>] = CMD_SWITCH | state;
    packet[<span class="number">3</span>] = packet[<span class="number">1</span>] ^ packet[<span class="number">2</span>];

    <span class="function">dcc_transmit</span>(packet, <span class="number">4</span>);
}`;
    }

    // Controls
    let simInterval = null;

    function toggleSimulation() {
      state.running = !state.running;
      const btn = document.getElementById('start-btn');

      if (state.running) {
        btn.innerHTML = '<span>‚è∏</span> Pause';
        btn.classList.remove('success');
        btn.classList.add('warning');
        simInterval = setInterval(schedulerTick, TICK_RATE_MS / getSpeed());
        render();
        log('info', 'Simulation started');
      } else {
        btn.innerHTML = '<span>‚ñ∂</span> Start';
        btn.classList.remove('warning');
        btn.classList.add('success');
        clearInterval(simInterval);
        log('info', 'Simulation paused');
      }
    }

    function emergencyStop() {
      state.emergencyStop = true;
      log('error', 'EMERGENCY STOP ACTIVATED');
      document.getElementById('rtos-status').classList.remove('running');
      document.getElementById('rtos-status').classList.add('error');
      document.getElementById('rtos-state').textContent = 'E-STOP';
    }

    function addTrain() {
      if (state.trains.length >= MAX_TRAINS) {
        log('warn', 'Maximum trains reached');
        return;
      }
      const colors = ['#3fb950', '#58a6ff', '#d29922', '#a371f7'];
      const id = state.trains.length + 1;
      state.trains.push(createTrain(id, colors[id - 1]));
      state.trains[state.trains.length - 1].targetSpeed = 30;
      renderTrains();
      log('info', `Train ${id} added to layout`);
    }

    function resetSimulation() {
      state.running = false;
      state.tick = 0;
      state.emergencyStop = false;
      state.trains = [];
      state.logs = [];
      clearInterval(simInterval);

      initSwitches();
      initScheduler();
      addTrain();

      document.getElementById('start-btn').innerHTML = '<span>‚ñ∂</span> Start';
      document.getElementById('start-btn').classList.remove('warning');
      document.getElementById('start-btn').classList.add('success');
      document.getElementById('rtos-status').classList.remove('error');
      document.getElementById('rtos-status').classList.add('running');
      document.getElementById('rtos-state').textContent = 'Ready';
      document.getElementById('log-panel').innerHTML = '';

      renderTaskQueue();
      renderTrains();
      render();
      log('info', 'System reset complete');
    }

    function toggleSwitch(id) {
      const sw = state.switches.find(s => s.id === id);
      if (sw) {
        sw.pending = sw.state === SWITCH_STATE.STRAIGHT ? SWITCH_STATE.DIVERGE : SWITCH_STATE.STRAIGHT;
        log('task', `Switch ${id} command queued`);
      }
    }

    function setTrainSpeed(id, speed) {
      const train = state.trains.find(t => t.id === id);
      if (train) {
        train.targetSpeed = speed;
        train.emergency = false;
        log('task', `Train ${id} speed ‚Üí ${speed}%`);
      }
    }

    function getSpeed() {
      return parseInt(document.getElementById('speed-slider').value);
    }

    function showTab(tabId) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelector(`.tab-content#tab-${tabId}`).classList.add('active');
      document.querySelector(`.tab[onclick="showTab('${tabId}')"]`).classList.add('active');
    }

    // Speed slider
    document.getElementById('speed-slider').addEventListener('input', (e) => {
      document.getElementById('speed-value').textContent = e.target.value + 'x';
      if (state.running) {
        clearInterval(simInterval);
        simInterval = setInterval(schedulerTick, TICK_RATE_MS / getSpeed());
      }
    });

    // Initialize
    window.addEventListener('resize', () => {
      resizeCanvas();
      if (!state.running) render();
    });

    resizeCanvas();
    initSwitches();
    initScheduler();
    renderCode();
    renderTaskQueue();
    addTrain();
    render();
    log('info', 'M√§rklin controller initialized');
  </script>
<script src="/sloppy-header/sloppy-bar.js"></script>
<script src="/vibelib-extended.js"></script>
<script>
  // Compatibility Patch for Legacy Apps
  window.addEventListener("load", () => {
    if (window.SloppyKarma && window.VibeLib.Economy) {
      // Redirect old calls to new engine
      window.SloppyKarma.track = window.VibeLib.Economy.track;
    }
  });
</script>
</body>
</html>
