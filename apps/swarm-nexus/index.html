<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swarm Intelligence Nexus</title>
    <link rel="icon" href="https://emojicdn.elk.sh/üêù">

    <meta property="og:title" content="Swarm Intelligence Nexus">
    <meta property="og:description" content="Collective decision engine. Propose and vote on global system upgrades together.">
    <meta property="og:url" content="https://sloppy.live/swarm-nexus">
    <meta property="og:image" content="https://sloppy.live/swarm-nexus/og-image.png">
    <meta property="og:type" content="website">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;600;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #0a0a12;
            --panel: #12121a;
            --border: #2a2a3a;
            --text: #e0e0e0;
            --text-dim: #888;
            --accent: #f59e0b;
            --accent-glow: rgba(245, 158, 11, 0.3);
            --success: #22c55e;
            --danger: #ef4444;
            --info: #3b82f6;
            --purple: #8b5cf6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Exo 2', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Hexagonal background pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0L60 17.32v34.64L30 69.28 0 51.96V17.32L30 0z' fill='none' stroke='%23f59e0b' stroke-opacity='0.05'/%3E%3C/svg%3E");
            background-size: 60px 60px;
            pointer-events: none;
            opacity: 0.5;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px 20px;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), var(--purple), var(--accent));
            animation: headerGlow 3s ease-in-out infinite;
        }

        @keyframes headerGlow {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .logo {
            font-size: 3rem;
            margin-bottom: 10px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .title {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(90deg, var(--accent), #fcd34d, var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 2px;
        }

        .subtitle {
            font-size: 0.9rem;
            color: var(--text-dim);
            margin-top: 8px;
        }

        /* Stats Bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--panel);
            border: 1px solid var(--border);
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }

        .stat-card:hover {
            border-color: var(--accent);
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--accent);
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 18px;
            background: var(--panel);
            border: 1px solid var(--border);
            color: var(--text-dim);
            font-family: 'Exo 2', sans-serif;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            border-color: var(--accent);
            color: var(--text);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, var(--accent), #d97706);
            border-color: var(--accent);
            color: #000;
            font-weight: 600;
        }

        .create-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--accent), #d97706);
            border: none;
            color: #000;
            font-family: 'Exo 2', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: auto;
        }

        .create-btn:hover {
            box-shadow: 0 0 25px var(--accent-glow);
            transform: translateY(-2px);
        }

        /* Proposals Grid */
        .proposals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .proposal-card {
            background: var(--panel);
            border: 1px solid var(--border);
            padding: 20px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .proposal-card:hover {
            border-color: var(--accent);
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        }

        .proposal-card.passed {
            border-color: var(--success);
        }

        .proposal-card.failed {
            border-color: var(--danger);
            opacity: 0.7;
        }

        .proposal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .proposal-category {
            font-size: 0.7rem;
            padding: 4px 10px;
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .proposal-status {
            font-size: 0.7rem;
            padding: 4px 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .proposal-status.active {
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: var(--info);
        }

        .proposal-status.passed {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: var(--success);
        }

        .proposal-status.failed {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--danger);
        }

        .proposal-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .proposal-desc {
            font-size: 0.85rem;
            color: var(--text-dim);
            line-height: 1.5;
            margin-bottom: 15px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .proposal-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-bottom: 15px;
        }

        .proposal-timer {
            color: var(--accent);
            font-family: 'JetBrains Mono', monospace;
        }

        .proposal-timer.urgent {
            color: var(--danger);
            animation: urgentPulse 1s ease-in-out infinite;
        }

        @keyframes urgentPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Consensus Bar */
        .consensus-bar {
            height: 8px;
            background: var(--border);
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
        }

        .consensus-for {
            height: 100%;
            background: linear-gradient(90deg, var(--success), #4ade80);
            position: absolute;
            left: 0;
            transition: width 0.5s ease;
        }

        .consensus-against {
            height: 100%;
            background: linear-gradient(90deg, #f87171, var(--danger));
            position: absolute;
            right: 0;
            transition: width 0.5s ease;
        }

        .consensus-threshold {
            position: absolute;
            left: 66.67%;
            top: -4px;
            bottom: -4px;
            width: 2px;
            background: var(--accent);
        }

        .vote-counts {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            margin-bottom: 15px;
        }

        .vote-for {
            color: var(--success);
            font-weight: 600;
        }

        .vote-against {
            color: var(--danger);
            font-weight: 600;
        }

        /* Vote Buttons */
        .vote-actions {
            display: flex;
            gap: 10px;
        }

        .vote-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid;
            background: transparent;
            font-family: 'Exo 2', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .vote-btn.for {
            border-color: var(--success);
            color: var(--success);
        }

        .vote-btn.for:hover, .vote-btn.for.voted {
            background: var(--success);
            color: #000;
        }

        .vote-btn.against {
            border-color: var(--danger);
            color: var(--danger);
        }

        .vote-btn.against:hover, .vote-btn.against.voted {
            background: var(--danger);
            color: #fff;
        }

        .vote-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Create Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.hidden {
            display: none;
        }

        .modal {
            background: var(--panel);
            border: 2px solid var(--accent);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--accent);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            font-family: 'Exo 2', sans-serif;
            font-size: 0.95rem;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-select {
            cursor: pointer;
        }

        .submit-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--accent), #d97706);
            border: none;
            color: #000;
            font-family: 'Exo 2', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .submit-btn:hover {
            box-shadow: 0 0 25px var(--accent-glow);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* User Badge */
        .user-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--panel);
            border: 1px solid var(--border);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 100;
        }

        .user-avatar {
            font-size: 1.3rem;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .user-power {
            font-size: 0.7rem;
            color: var(--accent);
        }

        /* Swarm Visualization */
        .swarm-viz {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 150px;
            height: 150px;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .swarm-center {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            animation: swarmPulse 2s ease-in-out infinite;
        }

        @keyframes swarmPulse {
            0%, 100% { box-shadow: 0 0 20px var(--accent-glow); }
            50% { box-shadow: 0 0 40px var(--accent-glow), 0 0 60px rgba(139, 92, 246, 0.2); }
        }

        .swarm-particles {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .swarm-particle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            animation: orbit 4s linear infinite;
        }

        @keyframes orbit {
            from { transform: rotate(0deg) translateX(50px) rotate(0deg); }
            to { transform: rotate(360deg) translateX(50px) rotate(-360deg); }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--panel);
            border: 1px solid var(--accent);
            padding: 12px 24px;
            font-size: 0.9rem;
            z-index: 1001;
            animation: toastIn 0.3s ease-out;
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-dim);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Back link */
        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            color: var(--text-dim);
            text-decoration: none;
            font-size: 0.85rem;
            z-index: 100;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: var(--accent);
        }

        /* Discussion Modal */
        .discussion-modal {
            max-width: 600px;
        }

        .discussion-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .discussion-proposal-title {
            font-size: 0.9rem;
            color: var(--accent);
            font-weight: 600;
        }

        .discussion-body {
            max-height: 400px;
            overflow-y: auto;
            padding: 0;
        }

        .comments-list {
            padding: 15px 20px;
        }

        .comment-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .comment-item:last-child {
            border-bottom: none;
        }

        .comment-avatar {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .comment-content {
            flex: 1;
            min-width: 0;
        }

        .comment-meta {
            display: flex;
            gap: 10px;
            font-size: 0.75rem;
            margin-bottom: 6px;
        }

        .comment-username {
            color: var(--accent);
            font-weight: 600;
        }

        .comment-time {
            color: var(--text-dim);
        }

        .comment-text {
            font-size: 0.85rem;
            color: var(--text);
            line-height: 1.5;
            word-break: break-word;
        }

        .comment-input-area {
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
        }

        .comment-input {
            flex: 1;
            padding: 10px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            font-family: 'Exo 2', sans-serif;
            font-size: 0.85rem;
            resize: none;
        }

        .comment-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .comment-submit {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--accent), #d97706);
            border: none;
            color: #000;
            font-family: 'Exo 2', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .comment-submit:hover {
            box-shadow: 0 0 15px var(--accent-glow);
        }

        .no-comments {
            text-align: center;
            padding: 30px;
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        .discuss-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 8px 14px;
            font-family: 'Exo 2', sans-serif;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
            width: 100%;
        }

        .discuss-btn:hover {
            border-color: var(--purple);
            color: var(--purple);
        }

        .comment-count {
            color: var(--accent);
            font-weight: 600;
        }

        /* Pass Notification */
        .pass-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.95), rgba(22, 163, 74, 0.95));
            border: 2px solid var(--success);
            padding: 40px 50px;
            text-align: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .pass-notification.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
        }

        .pass-notification-icon {
            font-size: 4rem;
            margin-bottom: 15px;
            animation: celebratePulse 0.6s ease-in-out infinite;
        }

        @keyframes celebratePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .pass-notification-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: #fff;
            margin-bottom: 10px;
        }

        .pass-notification-desc {
            font-size: 0.95rem;
            color: rgba(255,255,255,0.9);
        }

        .pass-notification-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .title { font-size: 1.5rem; }
            .proposals-grid { grid-template-columns: 1fr; }
            .controls { flex-direction: column; }
            .create-btn { margin-left: 0; width: 100%; }
            .swarm-viz { display: none; }
            .user-badge { top: auto; bottom: 10px; right: 10px; }
            .pass-notification { padding: 30px; width: 90%; }
        }
    </style>
</head>
<body>
    <a href="https://sloppy.live" class="back-link">‚Üê Back to sloppy.live</a>

    <div class="user-badge" id="userBadge">
        <span class="user-avatar" id="userAvatar">üë§</span>
        <div class="user-info">
            <span class="user-name" id="userName">Anonymous</span>
            <span class="user-power">‚ö° <span id="userPower">1</span> voting power</span>
        </div>
    </div>

    <div class="swarm-viz">
        <div class="swarm-particles" id="swarmParticles"></div>
        <div class="swarm-center">üêù</div>
    </div>

    <div class="app-container">
        <header class="header">
            <div class="logo">üêù</div>
            <h1 class="title">SWARM INTELLIGENCE NEXUS</h1>
            <p class="subtitle">Collective decision engine for global system upgrades</p>
        </header>

        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-value" id="statActive">0</div>
                <div class="stat-label">Active Proposals</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statPassed">0</div>
                <div class="stat-label">Implemented</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statVoters">0</div>
                <div class="stat-label">Total Voters</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statConsensus">0%</div>
                <div class="stat-label">Avg Consensus</div>
            </div>
        </div>

        <div class="controls">
            <div class="filter-group">
                <button class="filter-btn active" data-filter="all" onclick="filterProposals('all')">All</button>
                <button class="filter-btn" data-filter="active" onclick="filterProposals('active')">üîµ Active</button>
                <button class="filter-btn" data-filter="passed" onclick="filterProposals('passed')">‚úÖ Passed</button>
                <button class="filter-btn" data-filter="failed" onclick="filterProposals('failed')">‚ùå Failed</button>
            </div>
            <div class="filter-group">
                <button class="filter-btn" data-category="feature" onclick="filterByCategory('feature')">üöÄ Features</button>
                <button class="filter-btn" data-category="ui" onclick="filterByCategory('ui')">üé® UI/UX</button>
                <button class="filter-btn" data-category="rules" onclick="filterByCategory('rules')">üìú Rules</button>
                <button class="filter-btn" data-category="integration" onclick="filterByCategory('integration')">üîó Integration</button>
            </div>
            <button class="create-btn" onclick="openCreateModal()">+ New Proposal</button>
        </div>

        <div class="proposals-grid" id="proposalsGrid">
            <div class="empty-state">
                <div class="empty-state-icon">üêù</div>
                <p>Loading proposals...</p>
            </div>
        </div>
    </div>

    <!-- Create Modal -->
    <div class="modal-overlay hidden" id="createModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">üêù New Proposal</span>
                <button class="modal-close" onclick="closeCreateModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="propCategory">
                        <option value="feature">üöÄ New Feature</option>
                        <option value="ui">üé® UI/UX Improvement</option>
                        <option value="rules">üìú Rule Change</option>
                        <option value="integration">üîó Integration</option>
                        <option value="other">üí° Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-input" id="propTitle" placeholder="Short, clear proposal title..." maxlength="100">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="propDesc" placeholder="Describe your proposal in detail. What problem does it solve? How should it work?"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Voting Period</label>
                    <select class="form-select" id="propDuration">
                        <option value="1">1 Hour (Quick Poll)</option>
                        <option value="24" selected>24 Hours (Standard)</option>
                        <option value="72">3 Days (Major Change)</option>
                        <option value="168">1 Week (Critical)</option>
                    </select>
                </div>
                <button class="submit-btn" id="submitBtn" onclick="submitProposal()">üêù Submit to the Swarm</button>
            </div>
        </div>
    </div>

    <!-- Discussion Modal -->
    <div class="modal-overlay hidden" id="discussionModal">
        <div class="modal discussion-modal">
            <div class="modal-header">
                <span class="modal-title">üí¨ Discussion</span>
                <button class="modal-close" onclick="closeDiscussionModal()">√ó</button>
            </div>
            <div class="discussion-header">
                <span class="discussion-proposal-title" id="discussionProposalTitle"></span>
            </div>
            <div class="discussion-body">
                <div class="comments-list" id="commentsList">
                    <div class="no-comments">Loading comments...</div>
                </div>
            </div>
            <div class="comment-input-area">
                <input type="text" class="comment-input" id="commentInput" placeholder="Share your thoughts..." maxlength="500">
                <button class="comment-submit" onclick="submitComment()">Send</button>
            </div>
        </div>
    </div>

    <!-- Pass Notification -->
    <div class="pass-notification" id="passNotification">
        <button class="pass-notification-close" onclick="closePassNotification()">√ó</button>
        <div class="pass-notification-icon">üéâ</div>
        <div class="pass-notification-title">Proposal Passed!</div>
        <div class="pass-notification-desc" id="passNotificationDesc"></div>
    </div>

    <script src="/supabase-config.js"></script>
    <script>
        let proposals = [];
        let votes = {};
        let myVotes = {};
        let currentUser = null;
        let userProfile = { username: 'Anonymous', avatar: 'üë§' };
        let userPower = 1;
        let currentFilter = 'all';
        let currentCategory = null;
        let currentDiscussionProposal = null;
        let commentCounts = {};
        let seenPassedProposals = JSON.parse(localStorage.getItem('swarm_seen_passed') || '[]');

        // Initialize
        async function init() {
            await initAuth();
            await loadUserPower();
            await loadCommentCounts();
            await loadProposals();
            initSwarmParticles();
            startTimerUpdates();
            subscribeToChanges();
            checkForNewPassedProposals();
        }

        // Auth
        async function initAuth() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    await loadUserProfile();
                } else {
                    const { data, error } = await supabase.auth.signInAnonymously();
                    if (data?.user) {
                        currentUser = data.user;
                    }
                }
            } catch (err) {
                console.error('Auth error:', err);
            }
            updateUserBadge();
        }

        async function loadUserProfile() {
            if (!currentUser) return;
            try {
                const { data } = await supabase
                    .from('sloppygram_messages')
                    .select('username, avatar')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (data && data.length > 0) {
                    userProfile.username = data[0].username || 'Anonymous';
                    userProfile.avatar = data[0].avatar || 'üë§';
                }
            } catch (err) {
                console.error('Error loading profile:', err);
            }
        }

        // Calculate voting power based on karma
        async function loadUserPower() {
            if (!currentUser || userProfile.username === 'Anonymous') {
                userPower = 1;
                return;
            }

            try {
                // Base power
                let power = 1;

                // Check karma from sloppygram activity
                const [msgRes, postRes, doodleRes] = await Promise.all([
                    supabase.from('sloppygram_messages').select('id', { count: 'exact', head: true }).eq('username', userProfile.username),
                    supabase.from('sloppygram_posts').select('id', { count: 'exact', head: true }).eq('username', userProfile.username),
                    supabase.from('sloppygram_messages').select('id', { count: 'exact', head: true }).eq('username', userProfile.username).eq('message_type', 'drawing')
                ]);

                const messages = msgRes.count || 0;
                const posts = postRes.count || 0;
                const doodles = doodleRes.count || 0;

                // Calculate power: base + activity bonuses
                power += Math.floor(messages / 10); // +1 per 10 messages
                power += Math.floor(posts / 5);     // +1 per 5 posts
                power += Math.floor(doodles / 3);   // +1 per 3 doodles

                // Cap at 20
                userPower = Math.min(20, power);
            } catch (err) {
                console.error('Error calculating power:', err);
                userPower = 1;
            }

            updateUserBadge();
        }

        function updateUserBadge() {
            document.getElementById('userName').textContent = userProfile.username;
            document.getElementById('userAvatar').textContent = userProfile.avatar;
            document.getElementById('userPower').textContent = userPower;
        }

        // Load proposals
        async function loadProposals() {
            try {
                const { data: props, error } = await supabase
                    .from('swarm_proposals')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                proposals = props || [];

                // Load my votes
                if (currentUser) {
                    const { data: myVotesData } = await supabase
                        .from('swarm_votes')
                        .select('proposal_id, vote_type')
                        .eq('user_id', currentUser.id);

                    myVotes = {};
                    (myVotesData || []).forEach(v => {
                        myVotes[v.proposal_id] = v.vote_type;
                    });
                }

                // Load all votes for stats
                const { data: allVotes } = await supabase
                    .from('swarm_votes')
                    .select('proposal_id, username');

                votes = {};
                const uniqueVoters = new Set();
                (allVotes || []).forEach(v => {
                    votes[v.proposal_id] = (votes[v.proposal_id] || 0) + 1;
                    uniqueVoters.add(v.username);
                });

                updateStats(uniqueVoters.size);
                renderProposals();

            } catch (err) {
                console.error('Error loading proposals:', err);
            }
        }

        // Update stats
        function updateStats(voterCount) {
            const active = proposals.filter(p => p.status === 'active').length;
            const passed = proposals.filter(p => p.status === 'passed' || p.status === 'implemented').length;

            let totalConsensus = 0;
            let consensusCount = 0;
            proposals.forEach(p => {
                const total = (p.votes_for || 0) + (p.votes_against || 0);
                if (total > 0) {
                    const forPct = (p.votes_for || 0) / total * 100;
                    totalConsensus += Math.max(forPct, 100 - forPct); // Take majority side
                    consensusCount++;
                }
            });

            document.getElementById('statActive').textContent = active;
            document.getElementById('statPassed').textContent = passed;
            document.getElementById('statVoters').textContent = voterCount;
            document.getElementById('statConsensus').textContent = consensusCount > 0
                ? Math.round(totalConsensus / consensusCount) + '%'
                : '0%';
        }

        // Render proposals
        function renderProposals() {
            const grid = document.getElementById('proposalsGrid');

            let filtered = proposals;

            // Apply status filter
            if (currentFilter !== 'all') {
                filtered = filtered.filter(p => p.status === currentFilter);
            }

            // Apply category filter
            if (currentCategory) {
                filtered = filtered.filter(p => p.category === currentCategory);
            }

            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üêù</div>
                        <p>No proposals found</p>
                        <p style="font-size:0.8rem;margin-top:8px;">Be the first to propose something!</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filtered.map(p => renderProposalCard(p)).join('');
        }

        function renderProposalCard(p) {
            const votesFor = p.votes_for || 0;
            const votesAgainst = p.votes_against || 0;
            const totalVotes = votesFor + votesAgainst;
            const forPct = totalVotes > 0 ? (votesFor / totalVotes * 100) : 50;
            const againstPct = 100 - forPct;

            const myVote = myVotes[p.proposal_id];
            const isActive = p.status === 'active';
            const hasVoted = !!myVote;

            // Calculate time remaining
            let timerHtml = '';
            if (isActive && p.voting_ends_at) {
                const endTime = new Date(p.voting_ends_at).getTime();
                const now = Date.now();
                const remaining = endTime - now;

                if (remaining <= 0) {
                    timerHtml = '<span class="proposal-timer">Voting ended</span>';
                } else {
                    const hours = Math.floor(remaining / (1000 * 60 * 60));
                    const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                    const isUrgent = remaining < 60 * 60 * 1000; // Less than 1 hour
                    timerHtml = `<span class="proposal-timer ${isUrgent ? 'urgent' : ''}" data-ends="${p.voting_ends_at}">${hours}h ${minutes}m left</span>`;
                }
            }

            const categoryEmojis = {
                feature: 'üöÄ',
                ui: 'üé®',
                rules: 'üìú',
                integration: 'üîó',
                other: 'üí°'
            };

            return `
                <div class="proposal-card ${p.status}">
                    <div class="proposal-header">
                        <span class="proposal-category">${categoryEmojis[p.category] || 'üí°'} ${p.category}</span>
                        <span class="proposal-status ${p.status}">${p.status}</span>
                    </div>
                    <h3 class="proposal-title">${escapeHtml(p.title)}</h3>
                    <p class="proposal-desc">${escapeHtml(p.description)}</p>
                    <div class="proposal-meta">
                        <span>by ${escapeHtml(p.proposer_username)}</span>
                        ${timerHtml}
                    </div>
                    <div class="consensus-bar">
                        <div class="consensus-for" style="width: ${forPct}%"></div>
                        <div class="consensus-against" style="width: ${againstPct}%"></div>
                        <div class="consensus-threshold" title="66% needed to pass"></div>
                    </div>
                    <div class="vote-counts">
                        <span class="vote-for">‚úì ${votesFor} for</span>
                        <span class="vote-against">‚úó ${votesAgainst} against</span>
                    </div>
                    ${isActive ? `
                        <div class="vote-actions">
                            <button class="vote-btn for ${myVote === 'for' ? 'voted' : ''}"
                                    onclick="vote('${p.proposal_id}', 'for')"
                                    ${hasVoted ? 'disabled' : ''}>
                                ${myVote === 'for' ? '‚úì Voted For' : 'üëç Vote For'}
                            </button>
                            <button class="vote-btn against ${myVote === 'against' ? 'voted' : ''}"
                                    onclick="vote('${p.proposal_id}', 'against')"
                                    ${hasVoted ? 'disabled' : ''}>
                                ${myVote === 'against' ? '‚úì Voted Against' : 'üëé Vote Against'}
                            </button>
                        </div>
                    ` : `
                        <div style="text-align:center;font-size:0.8rem;color:var(--text-dim);">
                            ${p.status === 'passed' ? '‚úÖ This proposal passed and will be implemented' : '‚ùå This proposal did not reach consensus'}
                        </div>
                    `}
                    <button class="discuss-btn" onclick="openDiscussion('${p.proposal_id}')">
                        üí¨ Discussion <span class="comment-count">(${commentCounts[p.proposal_id] || 0})</span>
                    </button>
                </div>
            `;
        }

        // Vote
        async function vote(proposalId, voteType) {
            if (!currentUser) {
                showToast('Please sign in to vote');
                return;
            }

            if (myVotes[proposalId]) {
                showToast('You have already voted on this proposal');
                return;
            }

            try {
                // Insert vote
                const { error: voteError } = await supabase
                    .from('swarm_votes')
                    .insert({
                        proposal_id: proposalId,
                        username: userProfile.username,
                        vote_type: voteType,
                        voting_power: userPower,
                        reason: null,
                        user_id: currentUser.id
                    });

                if (voteError) throw voteError;

                // Update proposal counts
                const proposal = proposals.find(p => p.proposal_id === proposalId);
                if (proposal) {
                    const field = voteType === 'for' ? 'votes_for' : 'votes_against';
                    const newCount = (proposal[field] || 0) + userPower;

                    await supabase
                        .from('swarm_proposals')
                        .update({ [field]: newCount })
                        .eq('proposal_id', proposalId);

                    // Check if voting ended and update status
                    await checkProposalStatus(proposalId);
                }

                myVotes[proposalId] = voteType;
                showToast(`üêù Vote recorded with ${userPower} voting power!`);
                await loadProposals();

            } catch (err) {
                console.error('Error voting:', err);
                showToast('Error recording vote');
            }
        }

        // Check if proposal should be finalized
        async function checkProposalStatus(proposalId) {
            const proposal = proposals.find(p => p.proposal_id === proposalId);
            if (!proposal || proposal.status !== 'active') return;

            const endTime = new Date(proposal.voting_ends_at).getTime();
            if (Date.now() < endTime) return; // Voting still active

            const votesFor = proposal.votes_for || 0;
            const votesAgainst = proposal.votes_against || 0;
            const total = votesFor + votesAgainst;

            if (total === 0) return;

            const forPct = votesFor / total;
            const newStatus = forPct >= 0.6667 ? 'passed' : 'failed'; // 66.67% threshold

            await supabase
                .from('swarm_proposals')
                .update({ status: newStatus })
                .eq('proposal_id', proposalId);
        }

        // Filter
        function filterProposals(filter) {
            currentFilter = filter;
            currentCategory = null;

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter || (!btn.dataset.filter && !btn.dataset.category));
            });

            renderProposals();
        }

        function filterByCategory(category) {
            if (currentCategory === category) {
                currentCategory = null;
            } else {
                currentCategory = category;
            }

            document.querySelectorAll('.filter-btn[data-category]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.category === currentCategory);
            });

            renderProposals();
        }

        // Create modal
        function openCreateModal() {
            document.getElementById('createModal').classList.remove('hidden');
        }

        function closeCreateModal() {
            document.getElementById('createModal').classList.add('hidden');
            document.getElementById('propTitle').value = '';
            document.getElementById('propDesc').value = '';
        }

        // Submit proposal
        async function submitProposal() {
            if (!currentUser) {
                showToast('Please sign in to submit proposals');
                return;
            }

            const title = document.getElementById('propTitle').value.trim();
            const description = document.getElementById('propDesc').value.trim();
            const category = document.getElementById('propCategory').value;
            const duration = parseInt(document.getElementById('propDuration').value);

            if (!title || !description) {
                showToast('Please fill in all fields');
                return;
            }

            if (title.length < 10) {
                showToast('Title must be at least 10 characters');
                return;
            }

            if (description.length < 30) {
                showToast('Description must be at least 30 characters');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            try {
                const proposalId = 'prop_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
                const votingEnds = new Date(Date.now() + duration * 60 * 60 * 1000);

                const { error } = await supabase
                    .from('swarm_proposals')
                    .insert({
                        proposal_id: proposalId,
                        title: title,
                        description: description,
                        category: category,
                        proposer_username: userProfile.username,
                        status: 'active',
                        votes_for: 0,
                        votes_against: 0,
                        voting_ends_at: votingEnds.toISOString(),
                        implementation_notes: null,
                        priority: 0,
                        user_id: currentUser.id
                    });

                if (error) throw error;

                showToast('üêù Proposal submitted to the Swarm!');
                closeCreateModal();
                await loadProposals();

            } catch (err) {
                console.error('Error submitting proposal:', err);
                showToast('Error submitting proposal');
            }

            submitBtn.disabled = false;
            submitBtn.textContent = 'üêù Submit to the Swarm';
        }

        // Real-time subscription
        function subscribeToChanges() {
            supabase
                .channel('swarm-changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'swarm_proposals' }, (payload) => {
                    loadProposals().then(() => {
                        // Check if a proposal just passed
                        if (payload.new && payload.new.status === 'passed' && payload.old && payload.old.status === 'active') {
                            showPassNotification(payload.new);
                            seenPassedProposals.push(payload.new.proposal_id);
                            localStorage.setItem('swarm_seen_passed', JSON.stringify(seenPassedProposals));
                        }
                    });
                })
                .on('postgres_changes', { event: '*', schema: 'public', table: 'swarm_votes' }, () => {
                    loadProposals();
                })
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'swarm_proposal_comments' }, (payload) => {
                    // Update comment count
                    if (payload.new) {
                        commentCounts[payload.new.proposal_id] = (commentCounts[payload.new.proposal_id] || 0) + 1;
                        renderProposals();
                        // If discussion modal is open for this proposal, reload comments
                        if (currentDiscussionProposal === payload.new.proposal_id) {
                            loadComments(payload.new.proposal_id);
                        }
                    }
                })
                .subscribe();
        }

        // Timer updates
        function startTimerUpdates() {
            setInterval(() => {
                document.querySelectorAll('.proposal-timer[data-ends]').forEach(timer => {
                    const endTime = new Date(timer.dataset.ends).getTime();
                    const remaining = endTime - Date.now();

                    if (remaining <= 0) {
                        timer.textContent = 'Voting ended';
                        timer.classList.remove('urgent');
                        // Reload to update status
                        loadProposals();
                    } else {
                        const hours = Math.floor(remaining / (1000 * 60 * 60));
                        const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                        timer.textContent = `${hours}h ${minutes}m left`;
                        timer.classList.toggle('urgent', remaining < 60 * 60 * 1000);
                    }
                });
            }, 60000); // Update every minute
        }

        // Swarm particles
        function initSwarmParticles() {
            const container = document.getElementById('swarmParticles');
            const colors = ['#f59e0b', '#fcd34d', '#8b5cf6', '#a78bfa'];

            for (let i = 0; i < 8; i++) {
                const particle = document.createElement('div');
                particle.className = 'swarm-particle';
                particle.style.background = colors[i % colors.length];
                particle.style.animationDelay = `${i * 0.5}s`;
                particle.style.animationDuration = `${3 + Math.random() * 2}s`;
                container.appendChild(particle);
            }
        }

        // Utilities
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message) {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.remove(), 3000);
        }

        // Load comment counts for all proposals
        async function loadCommentCounts() {
            try {
                const { data, error } = await supabase
                    .from('swarm_proposal_comments')
                    .select('proposal_id');

                if (error) throw error;

                commentCounts = {};
                (data || []).forEach(c => {
                    commentCounts[c.proposal_id] = (commentCounts[c.proposal_id] || 0) + 1;
                });
            } catch (err) {
                console.error('Error loading comment counts:', err);
            }
        }

        // Discussion modal functions
        async function openDiscussion(proposalId) {
            currentDiscussionProposal = proposalId;
            const proposal = proposals.find(p => p.proposal_id === proposalId);
            if (!proposal) return;

            document.getElementById('discussionProposalTitle').textContent = proposal.title;
            document.getElementById('discussionModal').classList.remove('hidden');
            document.getElementById('commentInput').value = '';

            await loadComments(proposalId);
        }

        function closeDiscussionModal() {
            document.getElementById('discussionModal').classList.add('hidden');
            currentDiscussionProposal = null;
        }

        async function loadComments(proposalId) {
            const listEl = document.getElementById('commentsList');
            listEl.innerHTML = '<div class="no-comments">Loading...</div>';

            try {
                const { data, error } = await supabase
                    .from('swarm_proposal_comments')
                    .select('*')
                    .eq('proposal_id', proposalId)
                    .order('created_at', { ascending: true });

                if (error) throw error;

                if (!data || data.length === 0) {
                    listEl.innerHTML = '<div class="no-comments">No comments yet. Be the first to share your thoughts!</div>';
                    return;
                }

                listEl.innerHTML = data.map(c => `
                    <div class="comment-item">
                        <span class="comment-avatar">${escapeHtml(c.avatar) || 'üë§'}</span>
                        <div class="comment-content">
                            <div class="comment-meta">
                                <span class="comment-username">${escapeHtml(c.username)}</span>
                                <span class="comment-time">${formatTime(c.created_at)}</span>
                            </div>
                            <div class="comment-text">${escapeHtml(c.content)}</div>
                        </div>
                    </div>
                `).join('');

                // Scroll to bottom
                const body = document.querySelector('.discussion-body');
                body.scrollTop = body.scrollHeight;

            } catch (err) {
                console.error('Error loading comments:', err);
                listEl.innerHTML = '<div class="no-comments">Error loading comments</div>';
            }
        }

        async function submitComment() {
            if (!currentUser || !currentDiscussionProposal) {
                showToast('Please sign in to comment');
                return;
            }

            const input = document.getElementById('commentInput');
            const content = input.value.trim();

            if (!content) {
                showToast('Please enter a comment');
                return;
            }

            if (content.length < 3) {
                showToast('Comment too short');
                return;
            }

            try {
                const commentId = 'cmt_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);

                const { error } = await supabase
                    .from('swarm_proposal_comments')
                    .insert({
                        comment_id: commentId,
                        proposal_id: currentDiscussionProposal,
                        username: userProfile.username,
                        avatar: userProfile.avatar,
                        content: content,
                        user_id: currentUser.id
                    });

                if (error) throw error;

                input.value = '';
                commentCounts[currentDiscussionProposal] = (commentCounts[currentDiscussionProposal] || 0) + 1;
                await loadComments(currentDiscussionProposal);
                renderProposals(); // Update comment count in card

                showToast('üí¨ Comment posted!');

            } catch (err) {
                console.error('Error posting comment:', err);
                showToast('Error posting comment');
            }
        }

        // Handle Enter key in comment input
        document.getElementById('commentInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                submitComment();
            }
        });

        function formatTime(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;
            const mins = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (mins < 1) return 'just now';
            if (mins < 60) return `${mins}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        }

        // Pass notification functions
        function checkForNewPassedProposals() {
            const passedProposals = proposals.filter(p => p.status === 'passed');
            const newPassed = passedProposals.filter(p => !seenPassedProposals.includes(p.proposal_id));

            if (newPassed.length > 0) {
                // Show notification for the most recent one
                const latest = newPassed[0];
                showPassNotification(latest);

                // Mark all as seen
                newPassed.forEach(p => seenPassedProposals.push(p.proposal_id));
                localStorage.setItem('swarm_seen_passed', JSON.stringify(seenPassedProposals));
            }
        }

        function showPassNotification(proposal) {
            const desc = document.getElementById('passNotificationDesc');
            desc.textContent = `"${proposal.title}" reached consensus and will be implemented!`;
            document.getElementById('passNotification').classList.add('show');

            // Auto-close after 8 seconds
            setTimeout(() => closePassNotification(), 8000);
        }

        function closePassNotification() {
            document.getElementById('passNotification').classList.remove('show');
        }

        // Initialize
        init();
    </script>
    <script src="/apps/sloppy-header/sloppy-bar.js" defer></script>
</body>
</html>
