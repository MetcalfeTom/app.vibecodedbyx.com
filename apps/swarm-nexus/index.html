<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swarm Intelligence Nexus</title>
    <link rel="icon" href="https://emojicdn.elk.sh/üêù">

    <meta property="og:title" content="Swarm Intelligence Nexus">
    <meta property="og:description" content="Quadratic voting collective. Stronger opinions cost more power. Shape the swarm.">
    <meta property="og:url" content="https://sloppy.live/swarm-nexus">
    <meta property="og:image" content="https://sloppy.live/swarm-nexus/og-image.png">
    <meta property="og:type" content="website">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;600;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #0a0a12;
            --panel: #12121a;
            --border: #2a2a3a;
            --text: #e0e0e0;
            --text-dim: #888;
            --accent: #f59e0b;
            --accent-glow: rgba(245, 158, 11, 0.3);
            --success: #22c55e;
            --danger: #ef4444;
            --info: #3b82f6;
            --purple: #8b5cf6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Exo 2', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Hexagonal background pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0L60 17.32v34.64L30 69.28 0 51.96V17.32L30 0z' fill='none' stroke='%23f59e0b' stroke-opacity='0.05'/%3E%3C/svg%3E");
            background-size: 60px 60px;
            pointer-events: none;
            opacity: 0.5;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px 20px;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), var(--purple), var(--accent));
            animation: headerGlow 3s ease-in-out infinite;
        }

        @keyframes headerGlow {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .logo {
            font-size: 3rem;
            margin-bottom: 10px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .title {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(90deg, var(--accent), #fcd34d, var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 2px;
        }

        .subtitle {
            font-size: 0.9rem;
            color: var(--text-dim);
            margin-top: 8px;
        }

        /* Stats Bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--panel);
            border: 1px solid var(--border);
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }

        .stat-card:hover {
            border-color: var(--accent);
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--accent);
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 18px;
            background: var(--panel);
            border: 1px solid var(--border);
            color: var(--text-dim);
            font-family: 'Exo 2', sans-serif;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            border-color: var(--accent);
            color: var(--text);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, var(--accent), #d97706);
            border-color: var(--accent);
            color: #000;
            font-weight: 600;
        }

        .create-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--accent), #d97706);
            border: none;
            color: #000;
            font-family: 'Exo 2', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: auto;
        }

        .create-btn:hover {
            box-shadow: 0 0 25px var(--accent-glow);
            transform: translateY(-2px);
        }

        /* Proposals Grid */
        .proposals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .proposal-card {
            background: var(--panel);
            border: 1px solid var(--border);
            padding: 20px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .proposal-card:hover {
            border-color: var(--accent);
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        }

        .proposal-card.passed {
            border-color: var(--success);
        }

        .proposal-card.failed {
            border-color: var(--danger);
            opacity: 0.7;
        }

        .proposal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .proposal-category {
            font-size: 0.7rem;
            padding: 4px 10px;
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .proposal-status {
            font-size: 0.7rem;
            padding: 4px 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .proposal-status.active {
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: var(--info);
        }

        .proposal-status.passed {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: var(--success);
        }

        .proposal-status.failed {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--danger);
        }

        .proposal-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .proposal-desc {
            font-size: 0.85rem;
            color: var(--text-dim);
            line-height: 1.5;
            margin-bottom: 15px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .proposal-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-bottom: 15px;
        }

        .proposal-timer {
            color: var(--accent);
            font-family: 'JetBrains Mono', monospace;
        }

        .proposal-timer.urgent {
            color: var(--danger);
            animation: urgentPulse 1s ease-in-out infinite;
        }

        @keyframes urgentPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Consensus Bar */
        .consensus-bar {
            height: 8px;
            background: var(--border);
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
        }

        .consensus-for {
            height: 100%;
            background: linear-gradient(90deg, var(--success), #4ade80);
            position: absolute;
            left: 0;
            transition: width 0.5s ease;
        }

        .consensus-against {
            height: 100%;
            background: linear-gradient(90deg, #f87171, var(--danger));
            position: absolute;
            right: 0;
            transition: width 0.5s ease;
        }

        .consensus-threshold {
            position: absolute;
            left: 66.67%;
            top: -4px;
            bottom: -4px;
            width: 2px;
            background: var(--accent);
        }

        .vote-counts {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            margin-bottom: 15px;
        }

        .vote-for {
            color: var(--success);
            font-weight: 600;
        }

        .vote-against {
            color: var(--danger);
            font-weight: 600;
        }

        /* Quorum Bar */
        .quorum-section {
            margin-bottom: 12px;
            padding: 10px;
            background: rgba(139, 92, 246, 0.05);
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .quorum-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }

        .quorum-label {
            color: var(--purple);
        }

        .quorum-count {
            color: var(--text-dim);
        }

        .quorum-count.met {
            color: var(--success);
        }

        .quorum-bar {
            height: 6px;
            background: var(--border);
            position: relative;
            overflow: hidden;
        }

        .quorum-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--purple), #a78bfa);
            transition: width 0.5s ease;
        }

        .quorum-fill.met {
            background: linear-gradient(90deg, var(--success), #4ade80);
        }

        .quorum-threshold-marker {
            position: absolute;
            top: -2px;
            bottom: -2px;
            width: 2px;
            background: var(--accent);
        }

        .quorum-warning {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 6px;
            font-size: 0.7rem;
            color: var(--accent);
        }

        .proposal-status.no-quorum {
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid rgba(139, 92, 246, 0.3);
            color: var(--purple);
        }

        .proposal-card.no-quorum {
            border-color: var(--purple);
            opacity: 0.8;
        }

        /* Delegation System */
        .delegation-btn {
            padding: 8px 14px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(139, 92, 246, 0.2));
            border: 1px solid rgba(59, 130, 246, 0.4);
            color: var(--info);
            font-family: 'Exo 2', sans-serif;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .delegation-btn:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(139, 92, 246, 0.3));
            border-color: var(--info);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
        }

        .delegation-modal-content {
            max-width: 500px;
        }

        .delegation-section {
            margin-bottom: 20px;
        }

        .delegation-section h4 {
            font-size: 0.85rem;
            color: var(--accent);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .delegation-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .delegation-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .delegation-item.incoming {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.2);
        }

        .delegation-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .delegation-user {
            font-weight: 600;
            color: var(--text);
        }

        .delegation-categories {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .delegation-revoke {
            padding: 6px 12px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: var(--danger);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .delegation-revoke:hover {
            background: var(--danger);
            color: #fff;
        }

        .delegation-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .delegation-form input {
            padding: 10px;
            background: var(--panel);
            border: 1px solid var(--border);
            color: var(--text);
            font-family: 'Exo 2', sans-serif;
        }

        .delegation-form input:focus {
            outline: none;
            border-color: var(--info);
        }

        .category-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .category-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: var(--panel);
            border: 1px solid var(--border);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .category-checkbox:hover {
            border-color: var(--accent);
        }

        .category-checkbox.selected {
            background: rgba(245, 158, 11, 0.2);
            border-color: var(--accent);
            color: var(--accent);
        }

        .category-checkbox input {
            display: none;
        }

        .delegated-power-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: var(--info);
            font-size: 0.7rem;
            margin-left: 8px;
        }

        .delegation-empty {
            text-align: center;
            padding: 20px;
            color: var(--text-dim);
            font-size: 0.85rem;
        }

        /* Vote Buttons */
        .vote-actions {
            display: flex;
            gap: 10px;
        }

        .vote-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid;
            background: transparent;
            font-family: 'Exo 2', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .vote-btn.for {
            border-color: var(--success);
            color: var(--success);
        }

        .vote-btn.for:hover, .vote-btn.for.voted {
            background: var(--success);
            color: #000;
        }

        .vote-btn.against {
            border-color: var(--danger);
            color: var(--danger);
        }

        .vote-btn.against:hover, .vote-btn.against.voted {
            background: var(--danger);
            color: #fff;
        }

        .vote-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Create Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.hidden {
            display: none;
        }

        .modal {
            background: var(--panel);
            border: 2px solid var(--accent);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--accent);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            font-family: 'Exo 2', sans-serif;
            font-size: 0.95rem;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-select {
            cursor: pointer;
        }

        .submit-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--accent), #d97706);
            border: none;
            color: #000;
            font-family: 'Exo 2', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .submit-btn:hover {
            box-shadow: 0 0 25px var(--accent-glow);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* User Badge */
        .user-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--panel);
            border: 1px solid var(--border);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 100;
        }

        .user-avatar {
            font-size: 1.3rem;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .user-power {
            font-size: 0.7rem;
            color: var(--accent);
        }

        /* Swarm Visualization */
        .swarm-viz {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 150px;
            height: 150px;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .swarm-center {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            animation: swarmPulse 2s ease-in-out infinite;
        }

        @keyframes swarmPulse {
            0%, 100% { box-shadow: 0 0 20px var(--accent-glow); }
            50% { box-shadow: 0 0 40px var(--accent-glow), 0 0 60px rgba(139, 92, 246, 0.2); }
        }

        .swarm-particles {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .swarm-particle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            animation: orbit 4s linear infinite;
        }

        @keyframes orbit {
            from { transform: rotate(0deg) translateX(50px) rotate(0deg); }
            to { transform: rotate(360deg) translateX(50px) rotate(-360deg); }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--panel);
            border: 1px solid var(--accent);
            padding: 12px 24px;
            font-size: 0.9rem;
            z-index: 1001;
            animation: toastIn 0.3s ease-out;
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-dim);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Back link */
        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            color: var(--text-dim);
            text-decoration: none;
            font-size: 0.85rem;
            z-index: 100;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: var(--accent);
        }

        /* Discussion Modal */
        .discussion-modal {
            max-width: 600px;
        }

        .discussion-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .discussion-proposal-title {
            font-size: 0.9rem;
            color: var(--accent);
            font-weight: 600;
        }

        .discussion-body {
            max-height: 400px;
            overflow-y: auto;
            padding: 0;
        }

        .comments-list {
            padding: 15px 20px;
        }

        .comment-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .comment-item:last-child {
            border-bottom: none;
        }

        .comment-avatar {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .comment-content {
            flex: 1;
            min-width: 0;
        }

        .comment-meta {
            display: flex;
            gap: 10px;
            font-size: 0.75rem;
            margin-bottom: 6px;
        }

        .comment-username {
            color: var(--accent);
            font-weight: 600;
        }

        .comment-time {
            color: var(--text-dim);
        }

        .comment-text {
            font-size: 0.85rem;
            color: var(--text);
            line-height: 1.5;
            word-break: break-word;
        }

        .comment-input-area {
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
        }

        .comment-input {
            flex: 1;
            padding: 10px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            font-family: 'Exo 2', sans-serif;
            font-size: 0.85rem;
            resize: none;
        }

        .comment-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .comment-submit {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--accent), #d97706);
            border: none;
            color: #000;
            font-family: 'Exo 2', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .comment-submit:hover {
            box-shadow: 0 0 15px var(--accent-glow);
        }

        .no-comments {
            text-align: center;
            padding: 30px;
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        .discuss-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 8px 14px;
            font-family: 'Exo 2', sans-serif;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
            width: 100%;
        }

        .discuss-btn:hover {
            border-color: var(--purple);
            color: var(--purple);
        }

        .comment-count {
            color: var(--accent);
            font-weight: 600;
        }

        /* Pass Notification */
        .pass-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.95), rgba(22, 163, 74, 0.95));
            border: 2px solid var(--success);
            padding: 40px 50px;
            text-align: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .pass-notification.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
        }

        .pass-notification-icon {
            font-size: 4rem;
            margin-bottom: 15px;
            animation: celebratePulse 0.6s ease-in-out infinite;
        }

        @keyframes celebratePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .pass-notification-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: #fff;
            margin-bottom: 10px;
        }

        .pass-notification-desc {
            font-size: 0.95rem;
            color: rgba(255,255,255,0.9);
        }

        .pass-notification-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Quadratic Voting */
        .quadratic-vote-section {
            background: rgba(245, 158, 11, 0.05);
            border: 1px solid var(--border);
            padding: 15px;
            margin-top: 10px;
        }

        .quadratic-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .quadratic-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
        }

        .quadratic-cost {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: var(--accent);
        }

        .vote-intensity {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .intensity-slider {
            flex: 1;
            -webkit-appearance: none;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            outline: none;
        }

        .intensity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, var(--accent), #d97706);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px var(--accent-glow);
        }

        .intensity-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, var(--accent), #d97706);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .intensity-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent);
            min-width: 40px;
            text-align: center;
        }

        .quadratic-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 0.8rem;
        }

        .quadratic-info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 10px;
            background: rgba(0,0,0,0.2);
        }

        .quadratic-info-label {
            color: var(--text-dim);
        }

        .quadratic-info-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }

        .quadratic-info-value.power {
            color: var(--accent);
        }

        .quadratic-info-value.impact {
            color: var(--success);
        }

        .quadratic-formula {
            text-align: center;
            font-size: 0.7rem;
            color: var(--text-dim);
            padding: 8px;
            background: rgba(139, 92, 246, 0.1);
            border-left: 2px solid var(--purple);
            margin-bottom: 12px;
        }

        .quadratic-formula code {
            font-family: 'JetBrains Mono', monospace;
            color: var(--purple);
        }

        .vote-direction-btns {
            display: flex;
            gap: 10px;
        }

        .vote-direction-btns .vote-btn {
            flex: 1;
        }

        .insufficient-power {
            color: var(--danger);
            font-size: 0.8rem;
            text-align: center;
            padding: 10px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* View Tabs */
        .view-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--border);
        }

        .view-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: var(--text-dim);
            font-family: 'Exo 2', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }

        .view-tab:hover {
            color: var(--text);
        }

        .view-tab.active {
            color: var(--accent);
        }

        .view-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent);
        }

        .view-content {
            display: none;
        }

        .view-content.active {
            display: block;
        }

        /* History View */
        .history-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .history-search {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
            background: var(--panel);
            border: 1px solid var(--border);
            color: var(--text);
            font-family: 'Exo 2', sans-serif;
        }

        .history-search:focus {
            outline: none;
            border-color: var(--accent);
        }

        .history-sort {
            padding: 10px 15px;
            background: var(--panel);
            border: 1px solid var(--border);
            color: var(--text);
            font-family: 'Exo 2', sans-serif;
            cursor: pointer;
        }

        .history-card {
            background: var(--panel);
            border: 1px solid var(--border);
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.2s;
        }

        .history-card:hover {
            border-color: var(--text-dim);
        }

        .history-card.passed {
            border-left: 3px solid var(--success);
        }

        .history-card.failed {
            border-left: 3px solid var(--danger);
            opacity: 0.7;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .history-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
        }

        .history-result {
            font-size: 0.75rem;
            padding: 4px 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .history-result.passed {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        .history-result.failed {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .history-stats {
            display: flex;
            gap: 20px;
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-top: 10px;
        }

        .history-stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .history-stat.for { color: var(--success); }
        .history-stat.against { color: var(--danger); }

        /* Amendments */
        .amendments-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .amendments-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .amendments-title {
            font-size: 0.8rem;
            color: var(--purple);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .add-amendment-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--purple);
            color: var(--purple);
            font-family: 'Exo 2', sans-serif;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-amendment-btn:hover {
            background: var(--purple);
            color: #fff;
        }

        .amendment-item {
            background: rgba(139, 92, 246, 0.05);
            border-left: 2px solid var(--purple);
            padding: 12px;
            margin-bottom: 10px;
        }

        .amendment-item:last-child {
            margin-bottom: 0;
        }

        .amendment-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.75rem;
        }

        .amendment-author {
            color: var(--purple);
            font-weight: 600;
        }

        .amendment-status {
            padding: 2px 8px;
            font-size: 0.7rem;
            text-transform: uppercase;
        }

        .amendment-status.pending {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent);
        }

        .amendment-status.accepted {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        .amendment-status.rejected {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .amendment-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 5px;
        }

        .amendment-desc {
            font-size: 0.8rem;
            color: var(--text-dim);
            line-height: 1.4;
        }

        .amendment-votes {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            font-size: 0.8rem;
        }

        .amendment-vote-btn {
            padding: 4px 10px;
            background: transparent;
            border: 1px solid;
            font-family: 'Exo 2', sans-serif;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .amendment-vote-btn.for {
            border-color: var(--success);
            color: var(--success);
        }

        .amendment-vote-btn.for:hover {
            background: var(--success);
            color: #000;
        }

        .amendment-vote-btn.against {
            border-color: var(--danger);
            color: var(--danger);
        }

        .amendment-vote-btn.against:hover {
            background: var(--danger);
            color: #fff;
        }

        .no-amendments {
            font-size: 0.8rem;
            color: var(--text-dim);
            font-style: italic;
        }

        /* Amendment Modal */
        .amendment-modal {
            max-width: 450px;
        }

        /* Ecosystem Pulse */
        .pulse-feed {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 600px;
            overflow-y: auto;
        }
        .pulse-entry {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 16px;
            background: var(--panel);
            border: 1px solid var(--border);
            border-left: 3px solid var(--accent);
            transition: all 0.2s;
            animation: pulseIn 0.3s ease-out;
        }
        @keyframes pulseIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .pulse-entry:hover { border-color: var(--accent); }
        .pulse-entry.ai { border-left-color: var(--purple); }
        .pulse-entry.game { border-left-color: var(--success); }
        .pulse-entry.social { border-left-color: var(--info); }
        .pulse-icon {
            font-size: 1.4rem;
            flex-shrink: 0;
            width: 32px;
            text-align: center;
        }
        .pulse-body { flex: 1; min-width: 0; }
        .pulse-title {
            font-family: 'Exo 2', sans-serif;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text);
            margin-bottom: 2px;
        }
        .pulse-detail {
            font-size: 0.7rem;
            color: var(--text-dim);
            font-family: 'JetBrains Mono', monospace;
        }
        .pulse-time {
            font-size: 0.6rem;
            color: var(--text-dim);
            opacity: 0.6;
            flex-shrink: 0;
            white-space: nowrap;
        }
        .pulse-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .pulse-filter-btn {
            padding: 6px 14px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-dim);
            font-family: 'Exo 2', sans-serif;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .pulse-filter-btn:hover, .pulse-filter-btn.active {
            border-color: var(--accent);
            color: var(--accent);
        }
        .pulse-live-dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            background: var(--danger);
            border-radius: 50%;
            animation: livePulse 1.5s infinite;
            margin-right: 4px;
            vertical-align: middle;
        }
        @keyframes livePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .title { font-size: 1.5rem; }
            .proposals-grid { grid-template-columns: 1fr; }
            .controls { flex-direction: column; }
            .create-btn { margin-left: 0; width: 100%; }
            .swarm-viz { display: none; }
            .user-badge { top: auto; bottom: 10px; right: 10px; }
            .pass-notification { padding: 30px; width: 90%; }
        }
    </style>
<script>
(function(){var Q=[],N=0,MAX=10;function send(e){var sb=window.supabase;if(!sb){Q.push(e);return;}if(N>=MAX)return;N++;sb.auth.getSession().then(function(r){var u=r&&r.data&&r.data.session&&r.data.session.user;if(!u)return;sb.from('ai_events').insert({event_type:'client_error',entity_type:'app',entity_id:u.id,username:location.pathname.split('/').filter(Boolean)[0]||'unknown',metadata:e,user_id:u.id}).then(function(){});}).catch(function(){});}window.onerror=function(m,s,l,c,e){send({type:'error',msg:String(m).slice(0,500),src:s||'',line:l,col:c,stack:e?String(e.stack).slice(0,1000):''});};window.addEventListener('unhandledrejection',function(ev){var r=ev.reason;send({type:'promise',msg:String(r&&r.message||r).slice(0,500),stack:r?String(r.stack||'').slice(0,1000):''});});var fi=setInterval(function(){if(window.supabase){Q.splice(0).forEach(send);clearInterval(fi);}},1000);setTimeout(function(){clearInterval(fi);},30000);})();
</script>
</head>
<body>
    <a href="https://sloppy.live" class="back-link">‚Üê Back to sloppy.live</a>

    <div class="user-badge" id="userBadge">
        <span class="user-avatar" id="userAvatar">üë§</span>
        <div class="user-info">
            <span class="user-name" id="userName">Anonymous</span>
            <span class="user-power">‚ö° <span id="userPower">1</span> voting power</span>
        </div>
    </div>

    <div class="swarm-viz">
        <div class="swarm-particles" id="swarmParticles"></div>
        <div class="swarm-center">üêù</div>
    </div>

    <div class="app-container">
        <header class="header">
            <div class="logo">üêù</div>
            <h1 class="title">SWARM INTELLIGENCE NEXUS</h1>
            <p class="subtitle">Quadratic voting ‚Ä¢ Stronger opinions cost more power</p>
        </header>

        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-value" id="statActive">0</div>
                <div class="stat-label">Active Proposals</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statPassed">0</div>
                <div class="stat-label">Implemented</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statVoters">0</div>
                <div class="stat-label">Total Voters</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statActiveVoters">0</div>
                <div class="stat-label">Active (30d)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statConsensus">0%</div>
                <div class="stat-label">Avg Consensus</div>
            </div>
        </div>

        <!-- View Tabs -->
        <div class="view-tabs">
            <button class="view-tab active" onclick="switchView('proposals')">üêù Active Proposals</button>
            <button class="view-tab" onclick="switchView('history')">üìú History</button>
            <button class="view-tab" onclick="switchView('pulse')"><span class="pulse-live-dot"></span> Ecosystem Pulse</button>
        </div>

        <!-- Active Proposals View -->
        <div class="view-content active" id="proposalsView">
            <div class="controls">
                <div class="filter-group">
                    <button class="filter-btn active" data-filter="all" onclick="filterProposals('all')">All</button>
                    <button class="filter-btn" data-filter="active" onclick="filterProposals('active')">üîµ Active</button>
                    <button class="filter-btn" data-filter="passed" onclick="filterProposals('passed')">‚úÖ Passed</button>
                    <button class="filter-btn" data-filter="failed" onclick="filterProposals('failed')">‚ùå Failed</button>
                    <button class="filter-btn" data-filter="no-quorum" onclick="filterProposals('no-quorum')">üë• No Quorum</button>
                </div>
                <div class="filter-group">
                    <button class="filter-btn" data-category="feature" onclick="filterByCategory('feature')">üöÄ Features</button>
                    <button class="filter-btn" data-category="ui" onclick="filterByCategory('ui')">üé® UI/UX</button>
                    <button class="filter-btn" data-category="rules" onclick="filterByCategory('rules')">üìú Rules</button>
                    <button class="filter-btn" data-category="integration" onclick="filterByCategory('integration')">üîó Integration</button>
                </div>
                <button class="delegation-btn" onclick="openDelegationModal()">ü§ù Delegate</button>
                <button class="create-btn" onclick="openCreateModal()">+ New Proposal</button>
            </div>

            <div class="proposals-grid" id="proposalsGrid">
                <div class="empty-state">
                    <div class="empty-state-icon">üêù</div>
                    <p>Loading proposals...</p>
                </div>
            </div>
        </div>

        <!-- History View -->
        <div class="view-content" id="historyView">
            <div class="history-filters">
                <input type="text" class="history-search" id="historySearch" placeholder="Search proposals..." oninput="renderHistory()">
                <select class="history-sort" id="historySort" onchange="renderHistory()">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="most-votes">Most Votes</option>
                    <option value="highest-consensus">Highest Consensus</option>
                </select>
                <select class="history-sort" id="historyStatus" onchange="renderHistory()">
                    <option value="all">All Results</option>
                    <option value="passed">Passed Only</option>
                    <option value="failed">Failed Only</option>
                </select>
            </div>
            <div id="historyList">
                <div class="empty-state">
                    <div class="empty-state-icon">üìú</div>
                    <p>Loading history...</p>
                </div>
            </div>
        </div>

        <!-- Ecosystem Pulse View -->
        <div class="view-content" id="pulseView">
            <div class="pulse-filters">
                <button class="pulse-filter-btn active" onclick="filterPulse('all')">All</button>
                <button class="pulse-filter-btn" onclick="filterPulse('ai')">ü§ñ AI Events</button>
                <button class="pulse-filter-btn" onclick="filterPulse('game')">üéÆ Leaderboards</button>
            </div>
            <div class="pulse-feed" id="pulseFeed">
                <div class="empty-state">
                    <div class="empty-state-icon">üì°</div>
                    <p>Listening for ecosystem activity...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Modal -->
    <div class="modal-overlay hidden" id="createModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">üêù New Proposal</span>
                <button class="modal-close" onclick="closeCreateModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="propCategory">
                        <option value="feature">üöÄ New Feature</option>
                        <option value="ui">üé® UI/UX Improvement</option>
                        <option value="rules">üìú Rule Change</option>
                        <option value="integration">üîó Integration</option>
                        <option value="other">üí° Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-input" id="propTitle" placeholder="Short, clear proposal title..." maxlength="100">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="propDesc" placeholder="Describe your proposal in detail. What problem does it solve? How should it work?" maxlength="3000"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Voting Period</label>
                    <select class="form-select" id="propDuration">
                        <option value="1">1 Hour (Quick Poll)</option>
                        <option value="24" selected>24 Hours (Standard)</option>
                        <option value="72">3 Days (Major Change)</option>
                        <option value="168">1 Week (Critical)</option>
                    </select>
                </div>
                <button class="submit-btn" id="submitBtn" onclick="submitProposal()">üêù Submit to the Swarm</button>
            </div>
        </div>
    </div>

    <!-- Discussion Modal -->
    <div class="modal-overlay hidden" id="discussionModal">
        <div class="modal discussion-modal">
            <div class="modal-header">
                <span class="modal-title">üí¨ Discussion</span>
                <button class="modal-close" onclick="closeDiscussionModal()">√ó</button>
            </div>
            <div class="discussion-header">
                <span class="discussion-proposal-title" id="discussionProposalTitle"></span>
            </div>
            <div class="discussion-body">
                <div class="comments-list" id="commentsList">
                    <div class="no-comments">Loading comments...</div>
                </div>
            </div>
            <div class="comment-input-area">
                <input type="text" class="comment-input" id="commentInput" placeholder="Share your thoughts..." maxlength="500">
                <button class="comment-submit" onclick="submitComment()">Send</button>
            </div>
        </div>
    </div>

    <!-- Amendment Modal -->
    <div class="modal-overlay hidden" id="amendmentModal">
        <div class="modal amendment-modal">
            <div class="modal-header">
                <span class="modal-title">üìù Propose Amendment</span>
                <button class="modal-close" onclick="closeAmendmentModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div style="font-size:0.85rem;color:var(--text-dim);margin-bottom:15px;">
                    Proposing amendment to: <strong id="amendmentProposalTitle" style="color:var(--accent);"></strong>
                </div>
                <div class="form-group">
                    <label class="form-label">Amendment Title</label>
                    <input type="text" class="form-input" id="amendTitle" placeholder="Short title for your amendment..." maxlength="80">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="amendDesc" placeholder="Explain what you'd like to change about this proposal..." style="min-height:100px;"></textarea>
                </div>
                <button class="submit-btn" onclick="submitAmendment()">üìù Submit Amendment</button>
            </div>
        </div>
    </div>

    <!-- Delegation Modal -->
    <div class="modal-overlay hidden" id="delegationModal">
        <div class="modal delegation-modal-content">
            <div class="modal-header">
                <span class="modal-title">ü§ù Vote Delegation</span>
                <button class="modal-close" onclick="closeDelegationModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="font-size:0.85rem;color:var(--text-dim);margin-bottom:20px;">
                    Delegate your voting power to trusted community members. They'll vote on your behalf for selected categories.
                </p>

                <!-- My Delegations (Outgoing) -->
                <div class="delegation-section">
                    <h4>üîó My Delegations</h4>
                    <div class="delegation-list" id="myDelegationsList">
                        <div class="delegation-empty">Loading...</div>
                    </div>
                </div>

                <!-- Create New Delegation -->
                <div class="delegation-section">
                    <h4>‚ûï Delegate to Someone</h4>
                    <div class="delegation-form">
                        <input type="text" id="delegateeUsername" placeholder="Enter username to delegate to...">
                        <div style="font-size:0.75rem;color:var(--text-dim);margin-bottom:5px;">
                            Select categories (or leave all selected for full delegation):
                        </div>
                        <div class="category-checkboxes" id="delegationCategories">
                            <label class="category-checkbox selected" onclick="toggleDelegationCategory(this, 'feature')">
                                <input type="checkbox" value="feature" checked> üöÄ Features
                            </label>
                            <label class="category-checkbox selected" onclick="toggleDelegationCategory(this, 'ui')">
                                <input type="checkbox" value="ui" checked> üé® UI/UX
                            </label>
                            <label class="category-checkbox selected" onclick="toggleDelegationCategory(this, 'rules')">
                                <input type="checkbox" value="rules" checked> üìú Rules
                            </label>
                            <label class="category-checkbox selected" onclick="toggleDelegationCategory(this, 'integration')">
                                <input type="checkbox" value="integration" checked> üîó Integration
                            </label>
                            <label class="category-checkbox selected" onclick="toggleDelegationCategory(this, 'other')">
                                <input type="checkbox" value="other" checked> üí° Other
                            </label>
                        </div>
                        <button class="submit-btn" onclick="createDelegation()">ü§ù Create Delegation</button>
                    </div>
                </div>

                <!-- Incoming Delegations -->
                <div class="delegation-section">
                    <h4>üì• Delegations to Me</h4>
                    <div class="delegation-list" id="incomingDelegationsList">
                        <div class="delegation-empty">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pass Notification -->
    <div class="pass-notification" id="passNotification">
        <button class="pass-notification-close" onclick="closePassNotification()">√ó</button>
        <div class="pass-notification-icon">üéâ</div>
        <div class="pass-notification-title">Proposal Passed!</div>
        <div class="pass-notification-desc" id="passNotificationDesc"></div>
    </div>

    <script src="/supabase-config.js"></script>
    <script>
        let proposals = [];
        let votes = {};
        let myVotes = {};
        let currentUser = null;
        let userProfile = { username: 'Anonymous', avatar: 'üë§' };
        let userPower = 1;
        let currentFilter = 'all';
        let currentCategory = null;
        let currentDiscussionProposal = null;
        let commentCounts = {};
        let seenPassedProposals = JSON.parse(localStorage.getItem('swarm_seen_passed') || '[]');
        let currentView = 'proposals';
        let currentAmendmentProposal = null;
        let amendments = {}; // proposalId -> [amendments]

        // Quorum Configuration
        // Percentage of active voters required per category
        const QUORUM_THRESHOLDS = {
            rules: 0.20,       // 20% - high bar for rule changes
            feature: 0.10,     // 10% - moderate for new features
            ui: 0.08,          // 8% - lower for UI changes
            integration: 0.12, // 12% - moderate for integrations
            other: 0.10        // 10% - default
        };
        let activeVoterCount = 0; // Users who voted in last 30 days
        let proposalVoterCounts = {}; // proposalId -> unique voter count

        // Delegation System
        let myDelegations = []; // Delegations I've given to others
        let incomingDelegations = []; // Delegations others have given to me
        let delegatedPower = 0; // Extra power from incoming delegations
        let selectedDelegationCategories = ['feature', 'ui', 'rules', 'integration', 'other']; // All by default

        // Initialize
        async function init() {
            await initAuth();
            await loadUserPower();
            await loadCommentCounts();
            await loadAmendments();
            await loadActiveVoters();
            await loadDelegations();
            await loadProposals();
            initSwarmParticles();
            startTimerUpdates();
            subscribeToChanges();
            checkForNewPassedProposals();
            // Ecosystem Pulse ‚Äî load history then subscribe to real-time
            loadInitialPulse();
            subscribeToPulse();
        }

        // Auth
        async function initAuth() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    await loadUserProfile();
                } else {
                    const { data, error } = await supabase.auth.signInAnonymously();
                    if (data?.user) {
                        currentUser = data.user;
                    }
                }
            } catch (err) {
                console.error('Auth error:', err);
            }
            updateUserBadge();
        }

        async function loadUserProfile() {
            if (!currentUser) return;
            try {
                const { data } = await supabase
                    .from('sloppygram_messages')
                    .select('username, avatar')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (data && data.length > 0) {
                    userProfile.username = data[0].username || 'Anonymous';
                    userProfile.avatar = data[0].avatar || 'üë§';
                }
            } catch (err) {
                console.error('Error loading profile:', err);
            }
        }

        // Calculate voting power based on karma
        async function loadUserPower() {
            if (!currentUser || userProfile.username === 'Anonymous') {
                userPower = 1;
                return;
            }

            try {
                // Base power
                let power = 1;

                // Check karma from sloppygram activity
                const [msgRes, postRes, doodleRes] = await Promise.all([
                    supabase.from('sloppygram_messages').select('id', { count: 'exact', head: true }).eq('username', userProfile.username),
                    supabase.from('sloppygram_posts').select('id', { count: 'exact', head: true }).eq('username', userProfile.username),
                    supabase.from('sloppygram_messages').select('id', { count: 'exact', head: true }).eq('username', userProfile.username).eq('message_type', 'drawing')
                ]);

                const messages = msgRes.count || 0;
                const posts = postRes.count || 0;
                const doodles = doodleRes.count || 0;

                // Calculate power: base + activity bonuses
                power += Math.floor(messages / 10); // +1 per 10 messages
                power += Math.floor(posts / 5);     // +1 per 5 posts
                power += Math.floor(doodles / 3);   // +1 per 3 doodles

                // Cap at 20
                userPower = Math.min(20, power);
            } catch (err) {
                console.error('Error calculating power:', err);
                userPower = 1;
            }

            updateUserBadge();
        }

        function updateUserBadge() {
            document.getElementById('userName').textContent = userProfile.username;
            document.getElementById('userAvatar').textContent = userProfile.avatar;
            const maxVotes = Math.max(1, Math.floor(Math.sqrt(userPower)));

            // Show delegated power if any
            let powerHtml = `${userPower}`;
            if (delegatedPower > 0) {
                powerHtml += ` <span class="delegated-power-badge">+${delegatedPower} delegated</span>`;
            }
            powerHtml += ` <span style="color:var(--text-dim);font-size:0.65rem;">(max ${maxVotes} votes)</span>`;

            document.getElementById('userPower').innerHTML = powerHtml;
        }

        // Load proposals
        async function loadProposals() {
            try {
                const { data: props, error } = await supabase
                    .from('swarm_proposals')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                proposals = props || [];

                // Load my votes
                if (currentUser) {
                    const { data: myVotesData } = await supabase
                        .from('swarm_votes')
                        .select('proposal_id, vote_type')
                        .eq('user_id', currentUser.id);

                    myVotes = {};
                    (myVotesData || []).forEach(v => {
                        myVotes[v.proposal_id] = v.vote_type;
                    });
                }

                // Load all votes for stats and quorum tracking
                const { data: allVotes } = await supabase
                    .from('swarm_votes')
                    .select('proposal_id, username');

                votes = {};
                proposalVoterCounts = {}; // Reset voter counts per proposal
                const uniqueVoters = new Set();
                const proposalVoterSets = {}; // Track unique voters per proposal

                (allVotes || []).forEach(v => {
                    votes[v.proposal_id] = (votes[v.proposal_id] || 0) + 1;
                    uniqueVoters.add(v.username);

                    // Track unique voters per proposal for quorum
                    if (!proposalVoterSets[v.proposal_id]) {
                        proposalVoterSets[v.proposal_id] = new Set();
                    }
                    proposalVoterSets[v.proposal_id].add(v.username);
                });

                // Convert sets to counts
                Object.keys(proposalVoterSets).forEach(pid => {
                    proposalVoterCounts[pid] = proposalVoterSets[pid].size;
                });

                updateStats(uniqueVoters.size);
                renderProposals();

            } catch (err) {
                console.error('Error loading proposals:', err);
            }
        }

        // Update stats
        function updateStats(voterCount) {
            const active = proposals.filter(p => p.status === 'active').length;
            const passed = proposals.filter(p => p.status === 'passed' || p.status === 'implemented').length;

            let totalConsensus = 0;
            let consensusCount = 0;
            proposals.forEach(p => {
                const total = (p.votes_for || 0) + (p.votes_against || 0);
                if (total > 0) {
                    const forPct = (p.votes_for || 0) / total * 100;
                    totalConsensus += Math.max(forPct, 100 - forPct); // Take majority side
                    consensusCount++;
                }
            });

            document.getElementById('statActive').textContent = active;
            document.getElementById('statPassed').textContent = passed;
            document.getElementById('statVoters').textContent = voterCount;
            document.getElementById('statActiveVoters').textContent = activeVoterCount;
            document.getElementById('statConsensus').textContent = consensusCount > 0
                ? Math.round(totalConsensus / consensusCount) + '%'
                : '0%';
        }

        // Render proposals
        function renderProposals() {
            const grid = document.getElementById('proposalsGrid');

            let filtered = proposals;

            // Apply status filter
            if (currentFilter !== 'all') {
                filtered = filtered.filter(p => p.status === currentFilter);
            }

            // Apply category filter
            if (currentCategory) {
                filtered = filtered.filter(p => p.category === currentCategory);
            }

            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üêù</div>
                        <p>No proposals found</p>
                        <p style="font-size:0.8rem;margin-top:8px;">Be the first to propose something!</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filtered.map(p => renderProposalCard(p)).join('');
        }

        function renderProposalCard(p) {
            const votesFor = p.votes_for || 0;
            const votesAgainst = p.votes_against || 0;
            const totalVotes = votesFor + votesAgainst;
            const forPct = totalVotes > 0 ? (votesFor / totalVotes * 100) : 50;
            const againstPct = 100 - forPct;

            const myVote = myVotes[p.proposal_id];
            const isActive = p.status === 'active';
            const isNoQuorum = p.status === 'no-quorum';
            const hasVoted = !!myVote;

            // Calculate quorum progress
            const quorum = getQuorumProgress(p.proposal_id, p.category);
            const quorumThresholdPct = (QUORUM_THRESHOLDS[p.category] || QUORUM_THRESHOLDS.other) * 100;

            // Calculate time remaining
            let timerHtml = '';
            if (isActive && p.voting_ends_at) {
                const endTime = new Date(p.voting_ends_at).getTime();
                const now = Date.now();
                const remaining = endTime - now;

                if (remaining <= 0) {
                    timerHtml = '<span class="proposal-timer">Voting ended</span>';
                } else {
                    const hours = Math.floor(remaining / (1000 * 60 * 60));
                    const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                    const isUrgent = remaining < 60 * 60 * 1000; // Less than 1 hour
                    timerHtml = `<span class="proposal-timer ${isUrgent ? 'urgent' : ''}" data-ends="${p.voting_ends_at}">${hours}h ${minutes}m left</span>`;
                }
            }

            const categoryEmojis = {
                feature: 'üöÄ',
                ui: 'üé®',
                rules: 'üìú',
                integration: 'üîó',
                other: 'üí°'
            };

            // Determine display status for no-quorum
            const displayStatus = p.status === 'no-quorum' ? 'No Quorum' : p.status;

            return `
                <div class="proposal-card ${p.status}">
                    <div class="proposal-header">
                        <span class="proposal-category">${categoryEmojis[p.category] || 'üí°'} ${p.category}</span>
                        <span class="proposal-status ${p.status}">${displayStatus}</span>
                    </div>
                    <h3 class="proposal-title">${escapeHtml(p.title)}</h3>
                    <p class="proposal-desc">${escapeHtml(p.description)}</p>
                    <div class="proposal-meta">
                        <span>by ${escapeHtml(p.proposer_username)}</span>
                        ${timerHtml}
                    </div>
                    <div class="consensus-bar">
                        <div class="consensus-for" style="width: ${forPct}%"></div>
                        <div class="consensus-against" style="width: ${againstPct}%"></div>
                        <div class="consensus-threshold" title="66% needed to pass"></div>
                    </div>
                    <div class="vote-counts">
                        <span class="vote-for">‚úì ${votesFor} for</span>
                        <span class="vote-against">‚úó ${votesAgainst} against</span>
                    </div>
                    <div class="quorum-section">
                        <div class="quorum-header">
                            <span class="quorum-label">üë• Quorum (${quorumThresholdPct}% of active voters)</span>
                            <span class="quorum-count ${quorum.met ? 'met' : ''}">${quorum.current}/${quorum.required} voters</span>
                        </div>
                        <div class="quorum-bar">
                            <div class="quorum-fill ${quorum.met ? 'met' : ''}" style="width: ${quorum.percentage}%"></div>
                        </div>
                        ${!quorum.met && isActive ? `
                            <div class="quorum-warning">‚ö†Ô∏è ${quorum.required - quorum.current} more voters needed for valid result</div>
                        ` : ''}
                        ${quorum.met ? `
                            <div style="margin-top:6px;font-size:0.7rem;color:var(--success);">‚úì Quorum reached</div>
                        ` : ''}
                    </div>
                    ${isNoQuorum ? `
                        <div style="text-align:center;font-size:0.8rem;color:var(--purple);padding:10px;background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.3);margin-bottom:10px;">
                            ‚ö†Ô∏è Invalid - Did not reach quorum requirement
                        </div>
                    ` : ''}
                    ${isActive ? (hasVoted ? `
                        <div style="text-align:center;font-size:0.85rem;padding:15px;background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);">
                            ‚úì You voted <strong>${myVote}</strong> with <strong>${myVotes[p.proposal_id + '_power'] || userPower}</strong> effective votes
                        </div>
                    ` : `
                        <div class="quadratic-vote-section" id="qv-${p.proposal_id}">
                            <div class="quadratic-header">
                                <span class="quadratic-label">‚ö° Quadratic Voting</span>
                                <span class="quadratic-cost">Your Power: ${userPower}</span>
                            </div>
                            <div class="quadratic-formula">
                                <code>cost = votes¬≤</code> ‚Äî Stronger opinions cost more power
                            </div>
                            <div class="vote-intensity">
                                <input type="range" class="intensity-slider"
                                       id="slider-${p.proposal_id}"
                                       min="1" max="${getMaxVotes(userPower)}" value="1"
                                       oninput="updateQuadraticDisplay('${p.proposal_id}')">
                                <span class="intensity-value" id="votes-${p.proposal_id}">1</span>
                            </div>
                            <div class="quadratic-info">
                                <div class="quadratic-info-item">
                                    <span class="quadratic-info-label">Cost:</span>
                                    <span class="quadratic-info-value power" id="cost-${p.proposal_id}">1 ‚ö°</span>
                                </div>
                                <div class="quadratic-info-item">
                                    <span class="quadratic-info-label">Impact:</span>
                                    <span class="quadratic-info-value impact" id="impact-${p.proposal_id}">1 vote</span>
                                </div>
                            </div>
                            ${userPower >= 1 ? `
                                <div class="vote-direction-btns">
                                    <button class="vote-btn for" onclick="voteQuadratic('${p.proposal_id}', 'for')">
                                        üëç Vote For
                                    </button>
                                    <button class="vote-btn against" onclick="voteQuadratic('${p.proposal_id}', 'against')">
                                        üëé Vote Against
                                    </button>
                                </div>
                            ` : `
                                <div class="insufficient-power">
                                    ‚ö†Ô∏è You need at least 1 voting power to participate
                                </div>
                            `}
                        </div>
                    `) : `
                        <div style="text-align:center;font-size:0.8rem;color:var(--text-dim);">
                            ${p.status === 'passed' ? '‚úÖ This proposal passed and will be implemented' : '‚ùå This proposal did not reach consensus'}
                        </div>
                    `}
                    ${renderAmendmentsSection(p.proposal_id, isActive)}
                    <button class="discuss-btn" onclick="openDiscussion('${p.proposal_id}')">
                        üí¨ Discussion <span class="comment-count">(${commentCounts[p.proposal_id] || 0})</span>
                    </button>
                </div>
            `;
        }

        // Vote
        async function vote(proposalId, voteType) {
            if (!currentUser) {
                showToast('Please sign in to vote');
                return;
            }

            if (myVotes[proposalId]) {
                showToast('You have already voted on this proposal');
                return;
            }

            try {
                // Insert vote
                const { error: voteError } = await supabase
                    .from('swarm_votes')
                    .insert({
                        proposal_id: proposalId,
                        username: userProfile.username,
                        vote_type: voteType,
                        voting_power: userPower,
                        reason: null,
                        user_id: currentUser.id
                    });

                if (voteError) throw voteError;

                // Update proposal counts
                const proposal = proposals.find(p => p.proposal_id === proposalId);
                if (proposal) {
                    const field = voteType === 'for' ? 'votes_for' : 'votes_against';
                    const newCount = (proposal[field] || 0) + userPower;

                    await supabase
                        .from('swarm_proposals')
                        .update({ [field]: newCount })
                        .eq('proposal_id', proposalId);

                    // Check if voting ended and update status
                    await checkProposalStatus(proposalId);
                }

                myVotes[proposalId] = voteType;
                showToast(`üêù Vote recorded with ${userPower} voting power!`);
                await loadProposals();

            } catch (err) {
                console.error('Error voting:', err);
                showToast('Error recording vote');
            }
        }

        // Quadratic voting functions
        function getMaxVotes(power) {
            // Max votes = floor(sqrt(power))
            // With power 1, max = 1 vote (cost 1)
            // With power 4, max = 2 votes (cost 4)
            // With power 9, max = 3 votes (cost 9)
            // With power 20, max = 4 votes (cost 16)
            return Math.max(1, Math.floor(Math.sqrt(power)));
        }

        function updateQuadraticDisplay(proposalId) {
            const slider = document.getElementById(`slider-${proposalId}`);
            const votesEl = document.getElementById(`votes-${proposalId}`);
            const costEl = document.getElementById(`cost-${proposalId}`);
            const impactEl = document.getElementById(`impact-${proposalId}`);

            if (!slider || !votesEl || !costEl || !impactEl) return;

            const votes = parseInt(slider.value);
            const cost = votes * votes; // Quadratic cost

            votesEl.textContent = votes;
            costEl.textContent = `${cost} ‚ö°`;
            impactEl.textContent = votes === 1 ? '1 vote' : `${votes} votes`;

            // Visual feedback if at max
            if (votes === parseInt(slider.max)) {
                votesEl.style.color = '#22c55e';
            } else {
                votesEl.style.color = 'var(--accent)';
            }
        }

        async function voteQuadratic(proposalId, voteType) {
            if (!currentUser) {
                showToast('Please sign in to vote');
                return;
            }

            if (myVotes[proposalId]) {
                showToast('You have already voted on this proposal');
                return;
            }

            const slider = document.getElementById(`slider-${proposalId}`);
            const votes = slider ? parseInt(slider.value) : 1;
            const cost = votes * votes; // Quadratic cost

            if (cost > userPower) {
                showToast(`Insufficient power! Need ${cost}, have ${userPower}`);
                return;
            }

            try {
                // Insert vote with quadratic power
                const { error: voteError } = await supabase
                    .from('swarm_votes')
                    .insert({
                        proposal_id: proposalId,
                        username: userProfile.username,
                        vote_type: voteType,
                        voting_power: votes, // Store effective votes, not cost
                        reason: `QV: ${votes} votes (cost: ${cost})`,
                        user_id: currentUser.id
                    });

                if (voteError) throw voteError;

                // Update proposal counts with effective votes
                const proposal = proposals.find(p => p.proposal_id === proposalId);
                if (proposal) {
                    const field = voteType === 'for' ? 'votes_for' : 'votes_against';
                    const newCount = (proposal[field] || 0) + votes;

                    await supabase
                        .from('swarm_proposals')
                        .update({ [field]: newCount })
                        .eq('proposal_id', proposalId);

                    await checkProposalStatus(proposalId);
                }

                myVotes[proposalId] = voteType;
                myVotes[proposalId + '_power'] = votes;
                showToast(`üêù Voted ${voteType} with ${votes} vote${votes > 1 ? 's' : ''} (cost: ${cost} power)!`);
                await loadProposals();

            } catch (err) {
                console.error('Error voting:', err);
                showToast('Error recording vote');
            }
        }

        // Check if proposal should be finalized
        async function checkProposalStatus(proposalId) {
            const proposal = proposals.find(p => p.proposal_id === proposalId);
            if (!proposal || proposal.status !== 'active') return;

            const endTime = new Date(proposal.voting_ends_at).getTime();
            if (Date.now() < endTime) return; // Voting still active

            const votesFor = proposal.votes_for || 0;
            const votesAgainst = proposal.votes_against || 0;
            const total = votesFor + votesAgainst;

            if (total === 0) {
                // No votes at all = no quorum
                await supabase
                    .from('swarm_proposals')
                    .update({ status: 'no-quorum' })
                    .eq('proposal_id', proposalId);
                return;
            }

            // Check quorum requirement
            const quorum = getQuorumProgress(proposalId, proposal.category);
            if (!quorum.met) {
                // Quorum not reached
                await supabase
                    .from('swarm_proposals')
                    .update({ status: 'no-quorum' })
                    .eq('proposal_id', proposalId);
                return;
            }

            // Quorum met - check consensus
            const forPct = votesFor / total;
            const newStatus = forPct >= 0.6667 ? 'passed' : 'failed'; // 66.67% threshold

            await supabase
                .from('swarm_proposals')
                .update({ status: newStatus })
                .eq('proposal_id', proposalId);
        }

        // Filter
        function filterProposals(filter) {
            currentFilter = filter;
            currentCategory = null;

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter || (!btn.dataset.filter && !btn.dataset.category));
            });

            renderProposals();
        }

        function filterByCategory(category) {
            if (currentCategory === category) {
                currentCategory = null;
            } else {
                currentCategory = category;
            }

            document.querySelectorAll('.filter-btn[data-category]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.category === currentCategory);
            });

            renderProposals();
        }

        // Create modal
        function openCreateModal() {
            document.getElementById('createModal').classList.remove('hidden');
        }

        function closeCreateModal() {
            document.getElementById('createModal').classList.add('hidden');
            document.getElementById('propTitle').value = '';
            document.getElementById('propDesc').value = '';
        }

        // Submit proposal
        async function submitProposal() {
            if (!currentUser) {
                showToast('Please sign in to submit proposals');
                return;
            }

            const title = document.getElementById('propTitle').value.trim();
            const description = document.getElementById('propDesc').value.trim();
            const category = document.getElementById('propCategory').value;
            const duration = parseInt(document.getElementById('propDuration').value);

            if (!title || !description) {
                showToast('Please fill in all fields');
                return;
            }

            if (title.length < 10) {
                showToast('Title must be at least 10 characters');
                return;
            }

            if (description.length < 30) {
                showToast('Description must be at least 30 characters');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            try {
                const proposalId = 'prop_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
                const votingEnds = new Date(Date.now() + duration * 60 * 60 * 1000);

                const { error } = await supabase
                    .from('swarm_proposals')
                    .insert({
                        proposal_id: proposalId,
                        title: title,
                        description: description,
                        category: category,
                        proposer_username: userProfile.username,
                        status: 'active',
                        votes_for: 0,
                        votes_against: 0,
                        voting_ends_at: votingEnds.toISOString(),
                        implementation_notes: null,
                        priority: 0,
                        user_id: currentUser.id
                    });

                if (error) throw error;

                showToast('üêù Proposal submitted to the Swarm!');
                closeCreateModal();
                await loadProposals();

            } catch (err) {
                console.error('Error submitting proposal:', err);
                showToast('Error submitting proposal');
            }

            submitBtn.disabled = false;
            submitBtn.textContent = 'üêù Submit to the Swarm';
        }

        // Real-time subscription
        let swarmChannel = null;
        let timerInterval = null;

        function subscribeToChanges() {
            swarmChannel = supabase
                .channel('swarm-changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'swarm_proposals' }, (payload) => {
                    loadProposals().then(() => {
                        // Check if a proposal just passed
                        if (payload.new && payload.new.status === 'passed' && payload.old && payload.old.status === 'active') {
                            showPassNotification(payload.new);
                            seenPassedProposals.push(payload.new.proposal_id);
                            localStorage.setItem('swarm_seen_passed', JSON.stringify(seenPassedProposals));
                        }
                    });
                })
                .on('postgres_changes', { event: '*', schema: 'public', table: 'swarm_votes' }, () => {
                    loadProposals();
                })
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'swarm_proposal_comments' }, (payload) => {
                    // Update comment count
                    if (payload.new) {
                        commentCounts[payload.new.proposal_id] = (commentCounts[payload.new.proposal_id] || 0) + 1;
                        renderProposals();
                        // If discussion modal is open for this proposal, reload comments
                        if (currentDiscussionProposal === payload.new.proposal_id) {
                            loadComments(payload.new.proposal_id);
                        }
                    }
                })
                .subscribe();
        }

        // Cleanup subscriptions and intervals on page unload
        function cleanupResources() {
            if (swarmChannel) {
                swarmChannel.unsubscribe();
                supabase.removeChannel(swarmChannel);
            }
            if (pulseChannel) {
                pulseChannel.unsubscribe();
                supabase.removeChannel(pulseChannel);
            }
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        }
        window.addEventListener('beforeunload', cleanupResources);
        window.addEventListener('pagehide', cleanupResources);

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ECOSYSTEM PULSE ‚Äî cross-app activity feed
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const LEADERBOARD_TABLES = [
            { table: 'breakout_terminal_scores', name: 'Breakout Terminal', icon: 'üß±', nameCol: 'display_name' },
            { table: 'tetris_leaderboard', name: 'Tetris', icon: 'üü¶', nameCol: 'name' },
            { table: 'icy_tower_scores', name: 'Icy Tower', icon: 'üèîÔ∏è', nameCol: 'display_name' },
            { table: 'bouldering_scores', name: 'Bouldering', icon: 'üßó', nameCol: 'display_name' },
            { table: 'pho_scores', name: 'Pho Challenge', icon: 'üçú', nameCol: 'display_name' },
            { table: 'sea_scourge_leaderboard', name: 'Sea Scourge', icon: 'üè¥‚Äç‚ò†Ô∏è', nameCol: 'name' },
            { table: 'lighthouse_scores', name: 'Lighthouse', icon: 'üóº', nameCol: 'display_name' },
            { table: 'toiletrun_leaderboard', name: 'Toilet Run', icon: 'üöΩ', nameCol: 'display_name' },
            { table: 'star_catcher_leaderboard', name: 'Star Catcher', icon: '‚≠ê', nameCol: 'name' },
            { table: 'laptop_fire_scores', name: 'Laptop Fire', icon: 'üî•', nameCol: 'display_name' },
            { table: 'treasure_calculator_scores', name: 'Treasure Calc', icon: 'üíé', nameCol: 'display_name' },
            { table: 'sloppys_gift_leaderboard', name: "Sloppy's Gift", icon: 'üéÅ', nameCol: 'name' },
            { table: 'space_invaders_scores', name: 'Space Invaders', icon: 'üëæ', nameCol: 'display_name' },
            { table: 'golden_game_scores', name: 'Golden Game', icon: 'ü•á', nameCol: 'display_name' }
        ];

        let pulseEntries = [];
        let pulseFilter = 'all';
        let pulseChannel = null;
        const MAX_PULSE = 100;

        function addPulseEntry(entry) {
            pulseEntries.unshift(entry);
            if (pulseEntries.length > MAX_PULSE) pulseEntries.pop();
            if (currentView === 'pulse') renderPulseFeed();
        }

        function timeAgoShort(ts) {
            const s = Math.floor((Date.now() - new Date(ts).getTime()) / 1000);
            if (s < 5) return 'now';
            if (s < 60) return s + 's';
            if (s < 3600) return Math.floor(s / 60) + 'm';
            if (s < 86400) return Math.floor(s / 3600) + 'h';
            return Math.floor(s / 86400) + 'd';
        }

        function renderPulseFeed() {
            const el = document.getElementById('pulseFeed');
            if (!el) return;

            const filtered = pulseFilter === 'all'
                ? pulseEntries
                : pulseEntries.filter(e => e.type === pulseFilter);

            if (filtered.length === 0) {
                el.innerHTML = `<div class="empty-state">
                    <div class="empty-state-icon">üì°</div>
                    <p>${pulseEntries.length === 0 ? 'Listening for ecosystem activity...' : 'No events match this filter'}</p>
                </div>`;
                return;
            }

            el.innerHTML = filtered.slice(0, 50).map(e => `
                <div class="pulse-entry ${e.type}">
                    <div class="pulse-icon">${e.icon}</div>
                    <div class="pulse-body">
                        <div class="pulse-title">${escapeHtml(e.title)}</div>
                        <div class="pulse-detail">${escapeHtml(e.detail)}</div>
                    </div>
                    <div class="pulse-time">${timeAgoShort(e.time)}</div>
                </div>
            `).join('');
        }

        function filterPulse(type) {
            pulseFilter = type;
            document.querySelectorAll('.pulse-filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase().includes(
                    type === 'all' ? 'all' : type === 'ai' ? 'ai' : 'leader'
                ));
            });
            renderPulseFeed();
        }

        async function loadInitialPulse() {
            // Load recent ai_events
            try {
                const { data } = await supabase.from('ai_events')
                    .select('event_type, entity_type, username, metadata, created_at')
                    .order('created_at', { ascending: false })
                    .limit(20);
                (data || []).reverse().forEach(ev => {
                    const meta = ev.metadata || {};
                    addPulseEntry({
                        type: 'ai',
                        icon: 'ü§ñ',
                        title: `${ev.event_type || 'event'}${ev.entity_type ? ' ‚Üí ' + ev.entity_type : ''}`,
                        detail: `${ev.username || 'system'}${meta.message ? ': ' + String(meta.message).substring(0, 80) : ''}`,
                        time: ev.created_at
                    });
                });
            } catch (err) {
                console.warn('Failed to load ai_events:', err);
            }

            // Load recent high scores from each leaderboard (top 1 most recent per table)
            const scorePromises = LEADERBOARD_TABLES.map(async (lb) => {
                try {
                    const { data } = await supabase.from(lb.table)
                        .select(`score, ${lb.nameCol}, created_at`)
                        .order('created_at', { ascending: false })
                        .limit(3);
                    return (data || []).map(row => ({
                        type: 'game',
                        icon: lb.icon,
                        title: `${lb.name}: ${(row[lb.nameCol] || 'anon')} scored ${row.score?.toLocaleString() || '?'}`,
                        detail: lb.table.replace(/_/g, ' '),
                        time: row.created_at
                    }));
                } catch { return []; }
            });

            try {
                const allScores = (await Promise.all(scorePromises)).flat();
                allScores.sort((a, b) => new Date(b.time) - new Date(a.time));
                // Take most recent 20 across all games
                allScores.slice(0, 20).reverse().forEach(e => addPulseEntry(e));
            } catch (err) {
                console.warn('Failed to load leaderboard scores:', err);
            }

            // Sort all by time
            pulseEntries.sort((a, b) => new Date(b.time) - new Date(a.time));
        }

        function subscribeToPulse() {
            pulseChannel = supabase.channel('ecosystem-pulse');

            // Subscribe to ai_events
            pulseChannel.on('postgres_changes', {
                event: 'INSERT', schema: 'public', table: 'ai_events'
            }, (payload) => {
                const ev = payload.new;
                if (!ev) return;
                const meta = ev.metadata || {};
                addPulseEntry({
                    type: 'ai',
                    icon: 'ü§ñ',
                    title: `${ev.event_type || 'event'}${ev.entity_type ? ' ‚Üí ' + ev.entity_type : ''}`,
                    detail: `${ev.username || 'system'}${meta.message ? ': ' + String(meta.message).substring(0, 80) : ''}`,
                    time: ev.created_at || new Date().toISOString()
                });
            });

            // Subscribe to each leaderboard table
            LEADERBOARD_TABLES.forEach(lb => {
                pulseChannel.on('postgres_changes', {
                    event: 'INSERT', schema: 'public', table: lb.table
                }, (payload) => {
                    const row = payload.new;
                    if (!row) return;
                    addPulseEntry({
                        type: 'game',
                        icon: lb.icon,
                        title: `${lb.name}: ${(row[lb.nameCol] || 'anon')} scored ${row.score?.toLocaleString() || '?'}`,
                        detail: lb.table.replace(/_/g, ' '),
                        time: row.created_at || new Date().toISOString()
                    });
                });
            });

            pulseChannel.subscribe();
        }

        // Timer updates
        function startTimerUpdates() {
            timerInterval = setInterval(() => {
                document.querySelectorAll('.proposal-timer[data-ends]').forEach(timer => {
                    const endTime = new Date(timer.dataset.ends).getTime();
                    const remaining = endTime - Date.now();

                    if (remaining <= 0) {
                        timer.textContent = 'Voting ended';
                        timer.classList.remove('urgent');
                        // Reload to update status
                        loadProposals();
                    } else {
                        const hours = Math.floor(remaining / (1000 * 60 * 60));
                        const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                        timer.textContent = `${hours}h ${minutes}m left`;
                        timer.classList.toggle('urgent', remaining < 60 * 60 * 1000);
                    }
                });
            }, 60000); // Update every minute
        }

        // Swarm particles
        function initSwarmParticles() {
            const container = document.getElementById('swarmParticles');
            const colors = ['#f59e0b', '#fcd34d', '#8b5cf6', '#a78bfa'];

            for (let i = 0; i < 8; i++) {
                const particle = document.createElement('div');
                particle.className = 'swarm-particle';
                particle.style.background = colors[i % colors.length];
                particle.style.animationDelay = `${i * 0.5}s`;
                particle.style.animationDuration = `${3 + Math.random() * 2}s`;
                container.appendChild(particle);
            }
        }

        // Utilities
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message) {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.remove(), 3000);
        }

        // Load comment counts for all proposals
        async function loadCommentCounts() {
            try {
                const { data, error } = await supabase
                    .from('swarm_proposal_comments')
                    .select('proposal_id');

                if (error) throw error;

                commentCounts = {};
                (data || []).forEach(c => {
                    commentCounts[c.proposal_id] = (commentCounts[c.proposal_id] || 0) + 1;
                });
            } catch (err) {
                console.error('Error loading comment counts:', err);
            }
        }

        // Load active voter count (users who voted in last 30 days)
        async function loadActiveVoters() {
            try {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                const { data, error } = await supabase
                    .from('swarm_votes')
                    .select('username, created_at')
                    .gte('created_at', thirtyDaysAgo.toISOString());

                if (error) throw error;

                // Count unique voters in last 30 days
                const uniqueVoters = new Set();
                (data || []).forEach(v => uniqueVoters.add(v.username));
                activeVoterCount = Math.max(1, uniqueVoters.size); // Min 1 to avoid division by zero

            } catch (err) {
                console.error('Error loading active voters:', err);
                activeVoterCount = 10; // Default fallback
            }
        }

        // Get quorum requirement for a category
        function getQuorumRequired(category) {
            const threshold = QUORUM_THRESHOLDS[category] || QUORUM_THRESHOLDS.other;
            return Math.max(1, Math.ceil(activeVoterCount * threshold));
        }

        // Get quorum progress for a proposal
        function getQuorumProgress(proposalId, category) {
            const voterCount = proposalVoterCounts[proposalId] || 0;
            const required = getQuorumRequired(category);
            const percentage = Math.min(100, (voterCount / required) * 100);
            return {
                current: voterCount,
                required: required,
                percentage: percentage,
                met: voterCount >= required
            };
        }

        // ==========================================
        // DELEGATION SYSTEM
        // ==========================================

        // Load delegations for current user
        async function loadDelegations() {
            if (!currentUser || userProfile.username === 'Anonymous') return;

            try {
                // Load my outgoing delegations
                const { data: outgoing, error: outError } = await supabase
                    .from('swarm_delegations')
                    .select('*')
                    .eq('delegator_username', userProfile.username)
                    .eq('is_active', true);

                if (outError) throw outError;
                myDelegations = outgoing || [];

                // Load incoming delegations (others delegating to me)
                const { data: incoming, error: inError } = await supabase
                    .from('swarm_delegations')
                    .select('*')
                    .eq('delegatee_username', userProfile.username)
                    .eq('is_active', true);

                if (inError) throw inError;
                incomingDelegations = incoming || [];

                // Calculate delegated power from incoming delegations
                await calculateDelegatedPower();

            } catch (err) {
                console.error('Error loading delegations:', err);
            }
        }

        // Calculate total delegated power from incoming delegations
        async function calculateDelegatedPower() {
            delegatedPower = 0;

            for (const delegation of incomingDelegations) {
                try {
                    // Get the delegator's power
                    const delegatorPower = await getUserPower(delegation.delegator_username);
                    delegatedPower += delegatorPower;
                } catch (err) {
                    console.error('Error calculating delegator power:', err);
                }
            }

            updateUserBadge();
        }

        // Get a user's voting power by username
        async function getUserPower(username) {
            try {
                let power = 1;

                const [msgRes, postRes, doodleRes] = await Promise.all([
                    supabase.from('sloppygram_messages').select('id', { count: 'exact', head: true }).eq('username', username),
                    supabase.from('sloppygram_posts').select('id', { count: 'exact', head: true }).eq('username', username),
                    supabase.from('sloppygram_messages').select('id', { count: 'exact', head: true }).eq('username', username).eq('message_type', 'drawing')
                ]);

                const messages = msgRes.count || 0;
                const posts = postRes.count || 0;
                const doodles = doodleRes.count || 0;

                power += Math.floor(messages / 10);
                power += Math.floor(posts / 5);
                power += Math.floor(doodles / 3);

                return Math.min(20, power);
            } catch (err) {
                return 1;
            }
        }

        // Open delegation modal
        function openDelegationModal() {
            document.getElementById('delegationModal').classList.remove('hidden');
            renderDelegationLists();
        }

        // Close delegation modal
        function closeDelegationModal() {
            document.getElementById('delegationModal').classList.add('hidden');
        }

        // Render delegation lists in modal
        function renderDelegationLists() {
            // Render my outgoing delegations
            const myList = document.getElementById('myDelegationsList');
            if (myDelegations.length === 0) {
                myList.innerHTML = '<div class="delegation-empty">You haven\'t delegated to anyone yet</div>';
            } else {
                myList.innerHTML = myDelegations.map(d => {
                    const categories = d.categories || ['all'];
                    const catDisplay = categories.includes('all') || categories.length === 5
                        ? 'All categories'
                        : categories.map(c => c.charAt(0).toUpperCase() + c.slice(1)).join(', ');

                    return `
                        <div class="delegation-item">
                            <div class="delegation-info">
                                <span class="delegation-user">‚Üí ${escapeHtml(d.delegatee_username)}</span>
                                <span class="delegation-categories">${catDisplay}</span>
                            </div>
                            <button class="delegation-revoke" onclick="revokeDelegation('${d.delegation_id}')">Revoke</button>
                        </div>
                    `;
                }).join('');
            }

            // Render incoming delegations
            const inList = document.getElementById('incomingDelegationsList');
            if (incomingDelegations.length === 0) {
                inList.innerHTML = '<div class="delegation-empty">No one has delegated to you yet</div>';
            } else {
                inList.innerHTML = incomingDelegations.map(d => {
                    const categories = d.categories || ['all'];
                    const catDisplay = categories.includes('all') || categories.length === 5
                        ? 'All categories'
                        : categories.map(c => c.charAt(0).toUpperCase() + c.slice(1)).join(', ');

                    return `
                        <div class="delegation-item incoming">
                            <div class="delegation-info">
                                <span class="delegation-user">‚Üê ${escapeHtml(d.delegator_username)}</span>
                                <span class="delegation-categories">${catDisplay}</span>
                            </div>
                            <span style="font-size:0.75rem;color:var(--success);">+Power</span>
                        </div>
                    `;
                }).join('');
            }
        }

        // Toggle category selection for new delegation
        function toggleDelegationCategory(label, category) {
            label.classList.toggle('selected');
            const input = label.querySelector('input');
            input.checked = label.classList.contains('selected');

            // Update selected categories
            selectedDelegationCategories = [];
            document.querySelectorAll('#delegationCategories .category-checkbox.selected').forEach(cb => {
                selectedDelegationCategories.push(cb.querySelector('input').value);
            });
        }

        // Create a new delegation
        async function createDelegation() {
            if (!currentUser) {
                showToast('Please sign in to delegate');
                return;
            }

            const delegateeInput = document.getElementById('delegateeUsername');
            const delegatee = delegateeInput.value.trim();

            if (!delegatee) {
                showToast('Please enter a username');
                return;
            }

            if (delegatee.toLowerCase() === userProfile.username.toLowerCase()) {
                showToast('You cannot delegate to yourself');
                return;
            }

            if (selectedDelegationCategories.length === 0) {
                showToast('Please select at least one category');
                return;
            }

            // Check if already delegating to this user
            const existing = myDelegations.find(d =>
                d.delegatee_username.toLowerCase() === delegatee.toLowerCase()
            );
            if (existing) {
                showToast('You already have an active delegation to this user');
                return;
            }

            try {
                const { error } = await supabase
                    .from('swarm_delegations')
                    .insert({
                        delegation_id: crypto.randomUUID(),
                        delegator_username: userProfile.username,
                        delegatee_username: delegatee,
                        categories: selectedDelegationCategories,
                        is_active: true,
                        user_id: currentUser.id
                    });

                if (error) throw error;

                showToast(`ü§ù Delegated your voting power to ${delegatee}!`);
                delegateeInput.value = '';

                // Reset category selection
                document.querySelectorAll('#delegationCategories .category-checkbox').forEach(cb => {
                    cb.classList.add('selected');
                    cb.querySelector('input').checked = true;
                });
                selectedDelegationCategories = ['feature', 'ui', 'rules', 'integration', 'other'];

                await loadDelegations();
                renderDelegationLists();

            } catch (err) {
                console.error('Error creating delegation:', err);
                showToast('Error creating delegation');
            }
        }

        // Revoke a delegation
        async function revokeDelegation(delegationId) {
            try {
                const { error } = await supabase
                    .from('swarm_delegations')
                    .update({ is_active: false })
                    .eq('delegation_id', delegationId);

                if (error) throw error;

                showToast('Delegation revoked');
                await loadDelegations();
                renderDelegationLists();

            } catch (err) {
                console.error('Error revoking delegation:', err);
                showToast('Error revoking delegation');
            }
        }

        // Get effective voting power for a category (own + delegated)
        function getEffectivePower(category) {
            let power = userPower;

            // Add delegated power for this category
            for (const delegation of incomingDelegations) {
                const categories = delegation.categories || [];
                if (categories.includes('all') || categories.includes(category) || categories.length === 5) {
                    // This delegation applies to this category
                    // Note: we use cached delegated power calculation
                    power += Math.ceil(delegatedPower / Math.max(1, incomingDelegations.length));
                }
            }

            return power;
        }

        // Check if I've delegated my vote for a category
        function hasDelegatedCategory(category) {
            for (const delegation of myDelegations) {
                const categories = delegation.categories || [];
                if (categories.includes('all') || categories.includes(category) || categories.length === 5) {
                    return delegation.delegatee_username;
                }
            }
            return null;
        }

        // Discussion modal functions
        async function openDiscussion(proposalId) {
            currentDiscussionProposal = proposalId;
            const proposal = proposals.find(p => p.proposal_id === proposalId);
            if (!proposal) return;

            document.getElementById('discussionProposalTitle').textContent = proposal.title;
            document.getElementById('discussionModal').classList.remove('hidden');
            document.getElementById('commentInput').value = '';

            await loadComments(proposalId);
        }

        function closeDiscussionModal() {
            document.getElementById('discussionModal').classList.add('hidden');
            currentDiscussionProposal = null;
        }

        async function loadComments(proposalId) {
            const listEl = document.getElementById('commentsList');
            listEl.innerHTML = '<div class="no-comments">Loading...</div>';

            try {
                const { data, error } = await supabase
                    .from('swarm_proposal_comments')
                    .select('*')
                    .eq('proposal_id', proposalId)
                    .order('created_at', { ascending: true });

                if (error) throw error;

                if (!data || data.length === 0) {
                    listEl.innerHTML = '<div class="no-comments">No comments yet. Be the first to share your thoughts!</div>';
                    return;
                }

                listEl.innerHTML = data.map(c => `
                    <div class="comment-item">
                        <span class="comment-avatar">${escapeHtml(c.avatar) || 'üë§'}</span>
                        <div class="comment-content">
                            <div class="comment-meta">
                                <span class="comment-username">${escapeHtml(c.username)}</span>
                                <span class="comment-time">${formatTime(c.created_at)}</span>
                            </div>
                            <div class="comment-text">${escapeHtml(c.content)}</div>
                        </div>
                    </div>
                `).join('');

                // Scroll to bottom
                const body = document.querySelector('.discussion-body');
                body.scrollTop = body.scrollHeight;

            } catch (err) {
                console.error('Error loading comments:', err);
                listEl.innerHTML = '<div class="no-comments">Error loading comments</div>';
            }
        }

        async function submitComment() {
            if (!currentUser || !currentDiscussionProposal) {
                showToast('Please sign in to comment');
                return;
            }

            const input = document.getElementById('commentInput');
            const content = input.value.trim();

            if (!content) {
                showToast('Please enter a comment');
                return;
            }

            if (content.length < 3) {
                showToast('Comment too short');
                return;
            }

            try {
                const commentId = 'cmt_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);

                const { error } = await supabase
                    .from('swarm_proposal_comments')
                    .insert({
                        comment_id: commentId,
                        proposal_id: currentDiscussionProposal,
                        username: userProfile.username,
                        avatar: userProfile.avatar,
                        content: content,
                        user_id: currentUser.id
                    });

                if (error) throw error;

                input.value = '';
                commentCounts[currentDiscussionProposal] = (commentCounts[currentDiscussionProposal] || 0) + 1;
                await loadComments(currentDiscussionProposal);
                renderProposals(); // Update comment count in card

                showToast('üí¨ Comment posted!');

            } catch (err) {
                console.error('Error posting comment:', err);
                showToast('Error posting comment');
            }
        }

        // Handle Enter key in comment input
        document.getElementById('commentInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                submitComment();
            }
        });

        function formatTime(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;
            const mins = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (mins < 1) return 'just now';
            if (mins < 60) return `${mins}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        }

        // Pass notification functions
        function checkForNewPassedProposals() {
            const passedProposals = proposals.filter(p => p.status === 'passed');
            const newPassed = passedProposals.filter(p => !seenPassedProposals.includes(p.proposal_id));

            if (newPassed.length > 0) {
                // Show notification for the most recent one
                const latest = newPassed[0];
                showPassNotification(latest);

                // Mark all as seen
                newPassed.forEach(p => seenPassedProposals.push(p.proposal_id));
                localStorage.setItem('swarm_seen_passed', JSON.stringify(seenPassedProposals));
            }
        }

        function showPassNotification(proposal) {
            const desc = document.getElementById('passNotificationDesc');
            desc.textContent = `"${proposal.title}" reached consensus and will be implemented!`;
            document.getElementById('passNotification').classList.add('show');

            // Auto-close after 8 seconds
            setTimeout(() => closePassNotification(), 8000);
        }

        function closePassNotification() {
            document.getElementById('passNotification').classList.remove('show');
        }

        // View switching
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view-tab').forEach(tab => {
                const text = tab.textContent.toLowerCase();
                const isActive = (view === 'proposals' && text.includes('active')) ||
                                 (view === 'history' && text.includes('history')) ||
                                 (view === 'pulse' && text.includes('pulse'));
                tab.classList.toggle('active', isActive);
            });
            document.querySelectorAll('.view-content').forEach(content => {
                content.classList.remove('active');
            });
            const viewMap = { proposals: 'proposalsView', history: 'historyView', pulse: 'pulseView' };
            const targetEl = document.getElementById(viewMap[view]);
            if (targetEl) targetEl.classList.add('active');

            if (view === 'history') renderHistory();
            if (view === 'pulse') renderPulseFeed();
        }

        // History view
        function renderHistory() {
            const listEl = document.getElementById('historyList');
            const search = document.getElementById('historySearch').value.toLowerCase();
            const sortBy = document.getElementById('historySort').value;
            const statusFilter = document.getElementById('historyStatus').value;

            // Filter to closed proposals
            let history = proposals.filter(p => p.status === 'passed' || p.status === 'failed');

            // Apply search
            if (search) {
                history = history.filter(p =>
                    p.title.toLowerCase().includes(search) ||
                    p.description.toLowerCase().includes(search) ||
                    p.proposer_username.toLowerCase().includes(search)
                );
            }

            // Apply status filter
            if (statusFilter !== 'all') {
                history = history.filter(p => p.status === statusFilter);
            }

            // Sort
            switch (sortBy) {
                case 'oldest':
                    history.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                    break;
                case 'most-votes':
                    history.sort((a, b) => ((b.votes_for || 0) + (b.votes_against || 0)) - ((a.votes_for || 0) + (a.votes_against || 0)));
                    break;
                case 'highest-consensus':
                    history.sort((a, b) => {
                        const totalA = (a.votes_for || 0) + (a.votes_against || 0);
                        const totalB = (b.votes_for || 0) + (b.votes_against || 0);
                        const consA = totalA > 0 ? Math.max(a.votes_for / totalA, a.votes_against / totalA) : 0;
                        const consB = totalB > 0 ? Math.max(b.votes_for / totalB, b.votes_against / totalB) : 0;
                        return consB - consA;
                    });
                    break;
                default: // newest
                    history.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            }

            if (history.length === 0) {
                listEl.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìú</div>
                        <p>No proposals in history${search ? ' matching your search' : ''}</p>
                    </div>
                `;
                return;
            }

            listEl.innerHTML = history.map(p => {
                const votesFor = p.votes_for || 0;
                const votesAgainst = p.votes_against || 0;
                const total = votesFor + votesAgainst;
                const forPct = total > 0 ? Math.round(votesFor / total * 100) : 0;
                const date = new Date(p.created_at).toLocaleDateString();
                const propAmendments = amendments[p.proposal_id] || [];

                return `
                    <div class="history-card ${p.status}">
                        <div class="history-header">
                            <span class="history-title">${escapeHtml(p.title)}</span>
                            <span class="history-result ${p.status}">${p.status === 'passed' ? '‚úÖ Passed' : '‚ùå Failed'}</span>
                        </div>
                        <div style="font-size:0.85rem;color:var(--text-dim);margin-bottom:10px;">
                            ${escapeHtml(p.description.substring(0, 150))}${p.description.length > 150 ? '...' : ''}
                        </div>
                        <div class="history-stats">
                            <span class="history-stat for">‚úì ${votesFor} for (${forPct}%)</span>
                            <span class="history-stat against">‚úó ${votesAgainst} against</span>
                            <span class="history-stat">üìÖ ${date}</span>
                            <span class="history-stat">üë§ ${escapeHtml(p.proposer_username)}</span>
                        </div>
                        ${propAmendments.length > 0 ? `
                            <div style="margin-top:12px;font-size:0.8rem;color:var(--purple);">
                                üìù ${propAmendments.length} amendment${propAmendments.length > 1 ? 's' : ''} proposed
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Amendments
        async function loadAmendments() {
            try {
                const { data, error } = await supabase
                    .from('swarm_proposal_amendments')
                    .select('*')
                    .order('created_at', { ascending: true });

                if (error) throw error;

                amendments = {};
                (data || []).forEach(a => {
                    if (!amendments[a.proposal_id]) {
                        amendments[a.proposal_id] = [];
                    }
                    amendments[a.proposal_id].push(a);
                });
            } catch (err) {
                console.error('Error loading amendments:', err);
            }
        }

        function openAmendmentModal(proposalId) {
            const proposal = proposals.find(p => p.proposal_id === proposalId);
            if (!proposal) return;

            currentAmendmentProposal = proposalId;
            document.getElementById('amendmentProposalTitle').textContent = proposal.title;
            document.getElementById('amendTitle').value = '';
            document.getElementById('amendDesc').value = '';
            document.getElementById('amendmentModal').classList.remove('hidden');
        }

        function closeAmendmentModal() {
            document.getElementById('amendmentModal').classList.add('hidden');
            currentAmendmentProposal = null;
        }

        async function submitAmendment() {
            if (!currentUser || !currentAmendmentProposal) {
                showToast('Please sign in to propose amendments');
                return;
            }

            const title = document.getElementById('amendTitle').value.trim();
            const description = document.getElementById('amendDesc').value.trim();

            if (!title || title.length < 5) {
                showToast('Amendment title must be at least 5 characters');
                return;
            }

            if (!description || description.length < 20) {
                showToast('Amendment description must be at least 20 characters');
                return;
            }

            try {
                const amendmentId = 'amend_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);

                const { error } = await supabase
                    .from('swarm_proposal_amendments')
                    .insert({
                        amendment_id: amendmentId,
                        proposal_id: currentAmendmentProposal,
                        username: userProfile.username,
                        avatar: userProfile.avatar,
                        title: title,
                        description: description,
                        votes_for: 0,
                        votes_against: 0,
                        status: 'pending',
                        user_id: currentUser.id
                    });

                if (error) throw error;

                showToast('üìù Amendment submitted!');
                closeAmendmentModal();
                await loadAmendments();
                renderProposals();

            } catch (err) {
                console.error('Error submitting amendment:', err);
                showToast('Error submitting amendment');
            }
        }

        async function voteAmendment(amendmentId, voteType) {
            if (!currentUser) {
                showToast('Please sign in to vote');
                return;
            }

            try {
                // Find the amendment
                let foundAmendment = null;
                for (const propId in amendments) {
                    const found = amendments[propId].find(a => a.amendment_id === amendmentId);
                    if (found) {
                        foundAmendment = found;
                        break;
                    }
                }

                if (!foundAmendment) return;

                const field = voteType === 'for' ? 'votes_for' : 'votes_against';
                const newCount = (foundAmendment[field] || 0) + 1;

                await supabase
                    .from('swarm_proposal_amendments')
                    .update({ [field]: newCount })
                    .eq('amendment_id', amendmentId);

                showToast(`Voted ${voteType} on amendment`);
                await loadAmendments();
                renderProposals();

            } catch (err) {
                console.error('Error voting on amendment:', err);
                showToast('Error recording vote');
            }
        }

        function renderAmendmentsSection(proposalId, isActive) {
            const propAmendments = amendments[proposalId] || [];

            if (!isActive && propAmendments.length === 0) {
                return ''; // Don't show section for closed proposals with no amendments
            }

            return `
                <div class="amendments-section">
                    <div class="amendments-header">
                        <span class="amendments-title">üìù Amendments (${propAmendments.length})</span>
                        ${isActive ? `<button class="add-amendment-btn" onclick="openAmendmentModal('${proposalId}')">+ Propose</button>` : ''}
                    </div>
                    ${propAmendments.length === 0 ? `
                        <div class="no-amendments">No amendments proposed yet</div>
                    ` : propAmendments.map(a => `
                        <div class="amendment-item">
                            <div class="amendment-meta">
                                <span class="amendment-author">${escapeHtml(a.avatar || 'üë§')} ${escapeHtml(a.username)}</span>
                                <span class="amendment-status ${a.status}">${a.status}</span>
                            </div>
                            <div class="amendment-title">${escapeHtml(a.title)}</div>
                            <div class="amendment-desc">${escapeHtml(a.description)}</div>
                            ${isActive ? `
                                <div class="amendment-votes">
                                    <button class="amendment-vote-btn for" onclick="voteAmendment('${a.amendment_id}', 'for')">üëç ${a.votes_for || 0}</button>
                                    <button class="amendment-vote-btn against" onclick="voteAmendment('${a.amendment_id}', 'against')">üëé ${a.votes_against || 0}</button>
                                </div>
                            ` : `
                                <div style="font-size:0.75rem;color:var(--text-dim);margin-top:8px;">
                                    üëç ${a.votes_for || 0} / üëé ${a.votes_against || 0}
                                </div>
                            `}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Initialize
        init();
    </script>
    <script src="/sloppy-header/sloppy-bar.js" defer></script>
</body>
</html>
