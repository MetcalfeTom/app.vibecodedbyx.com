<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Search Bridge - Secure Query Processor</title>
  <link rel="icon" href="https://emojicdn.elk.sh/%F0%9F%94%8D">
  <meta property="og:title" content="Search Bridge">
  <meta property="og:description" content="Secure query processor for the logic core">
  <meta property="og:url" content="https://sloppy.live/search-bridge">
  <meta property="og:image" content="https://sloppy.live/search-bridge/og-image.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@300;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <style>
    :root {
      --bg-primary: #0a0c10;
      --bg-secondary: #12151c;
      --bg-tertiary: #1a1f2a;
      --accent-cyan: #00d4ff;
      --accent-green: #00ff88;
      --accent-yellow: #ffcc00;
      --accent-red: #ff4466;
      --text-primary: #e8eaed;
      --text-secondary: #9aa0a6;
      --text-muted: #5f6368;
      --border: #2d3748;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'IBM Plex Sans', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    .logo h1 {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    .status-bar {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.75rem;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      color: var(--text-secondary);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent-green);
      animation: pulse 2s infinite;
    }

    .status-dot.warning { background: var(--accent-yellow); }
    .status-dot.error { background: var(--accent-red); }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .main {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 340px;
      gap: 1px;
      background: var(--border);
    }

    .search-panel {
      background: var(--bg-primary);
      padding: 2rem;
      display: flex;
      flex-direction: column;
    }

    .search-box {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .search-input-wrapper {
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }

    .search-input {
      flex: 1;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.875rem 1rem;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.9rem;
      color: var(--text-primary);
      outline: none;
      transition: border-color 0.2s;
    }

    .search-input:focus {
      border-color: var(--accent-cyan);
    }

    .search-input::placeholder {
      color: var(--text-muted);
    }

    .search-btn {
      background: linear-gradient(135deg, var(--accent-cyan), #0099cc);
      border: none;
      border-radius: 8px;
      padding: 0.875rem 1.5rem;
      font-family: 'IBM Plex Mono', monospace;
      font-weight: 500;
      font-size: 0.85rem;
      color: var(--bg-primary);
      cursor: pointer;
      transition: transform 0.1s, opacity 0.2s;
    }

    .search-btn:hover { opacity: 0.9; }
    .search-btn:active { transform: scale(0.98); }
    .search-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .filters {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }

    .filter-chip {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 0.4rem 0.8rem;
      font-size: 0.75rem;
      font-family: 'IBM Plex Mono', monospace;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-chip:hover,
    .filter-chip.active {
      border-color: var(--accent-cyan);
      color: var(--accent-cyan);
    }

    .results-area {
      flex: 1;
      overflow-y: auto;
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border);
    }

    .results-count {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .result-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      transition: border-color 0.2s;
    }

    .result-card:hover {
      border-color: var(--accent-cyan);
    }

    .result-source {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.7rem;
      color: var(--accent-cyan);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
    }

    .result-title {
      font-weight: 500;
      font-size: 0.95rem;
      margin-bottom: 0.4rem;
    }

    .result-snippet {
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .result-meta {
      display: flex;
      gap: 1rem;
      margin-top: 0.75rem;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .sidebar {
      background: var(--bg-secondary);
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      overflow-y: auto;
    }

    .panel {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1rem;
    }

    .panel-title {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--accent-green);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .security-layer {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.8rem;
    }

    .security-layer:last-child { border-bottom: none; }

    .security-icon {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      background: var(--bg-secondary);
    }

    .security-icon.active {
      background: var(--accent-green);
      color: var(--bg-primary);
    }

    .audit-log {
      max-height: 200px;
      overflow-y: auto;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 0.7rem;
    }

    .audit-entry {
      padding: 0.4rem 0;
      border-bottom: 1px solid var(--border);
      color: var(--text-secondary);
    }

    .audit-entry:last-child { border-bottom: none; }

    .audit-time {
      color: var(--text-muted);
    }

    .audit-action {
      color: var(--accent-cyan);
    }

    .rate-meter {
      height: 6px;
      background: var(--bg-secondary);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 0.5rem;
    }

    .rate-fill {
      height: 100%;
      background: var(--accent-green);
      transition: width 0.3s;
    }

    .rate-fill.warning { background: var(--accent-yellow); }
    .rate-fill.danger { background: var(--accent-red); }

    .rate-info {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 0.4rem;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 300px;
      color: var(--text-muted);
      text-align: center;
    }

    .empty-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .back-link {
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .back-link:hover { color: var(--accent-cyan); }

    .highlight {
      background: rgba(0, 212, 255, 0.2);
      padding: 0 2px;
      border-radius: 2px;
    }

    @media (max-width: 768px) {
      .main {
        grid-template-columns: 1fr;
      }
      .sidebar {
        display: none;
      }
      .header {
        flex-direction: column;
        gap: 0.75rem;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">
      <div class="logo-icon">üîç</div>
      <h1>Search Bridge</h1>
    </div>
    <div class="status-bar">
      <div class="status-item">
        <span class="status-dot" id="sanitizerStatus"></span>
        <span>DOMPurify</span>
      </div>
      <div class="status-item">
        <span class="status-dot" id="rateLimitStatus"></span>
        <span>Rate Limiter</span>
      </div>
      <div class="status-item">
        <span class="status-dot" id="auditStatus"></span>
        <span>Audit Logger</span>
      </div>
      <a href="https://sloppy.live" class="back-link">‚Üê sloppy.live</a>
    </div>
  </header>

  <main class="main">
    <div class="search-panel">
      <div class="search-box">
        <div class="search-input-wrapper">
          <input type="text" class="search-input" id="queryInput" placeholder="Enter search query..." maxlength="256" autocomplete="off">
          <button class="search-btn" id="searchBtn">SEARCH</button>
        </div>
        <div class="filters">
          <span class="filter-chip active" data-source="all">All Sources</span>
          <span class="filter-chip" data-source="messages">Messages</span>
          <span class="filter-chip" data-source="posts">Posts</span>
          <span class="filter-chip" data-source="manifestos">Manifestos</span>
          <span class="filter-chip" data-source="feedback">Feedback</span>
        </div>
      </div>

      <div class="results-area">
        <div class="results-header">
          <span class="results-count" id="resultsCount">Ready to search</span>
        </div>
        <div id="resultsContainer">
          <div class="empty-state">
            <div class="empty-icon">üîê</div>
            <p>Enter a query to search the internal data sources.<br>All inputs are sanitized and rate-limited.</p>
          </div>
        </div>
      </div>
    </div>

    <aside class="sidebar">
      <div class="panel">
        <div class="panel-title">üõ°Ô∏è Security Layers</div>
        <div class="security-layer">
          <div class="security-icon active" id="layer1">‚úì</div>
          <span>Input Sanitization (DOMPurify)</span>
        </div>
        <div class="security-layer">
          <div class="security-icon active" id="layer2">‚úì</div>
          <span>Query Length Limit (256 chars)</span>
        </div>
        <div class="security-layer">
          <div class="security-icon active" id="layer3">‚úì</div>
          <span>Pattern Validation</span>
        </div>
        <div class="security-layer">
          <div class="security-icon active" id="layer4">‚úì</div>
          <span>Output Escaping</span>
        </div>
        <div class="security-layer">
          <div class="security-icon active" id="layer5">‚úì</div>
          <span>Rate Limiting (10/min)</span>
        </div>
        <div class="security-layer">
          <div class="security-icon active" id="layer6">‚úì</div>
          <span>Audit Trail Logging</span>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">üìä Rate Limit</div>
        <div class="rate-meter">
          <div class="rate-fill" id="rateFill" style="width: 0%"></div>
        </div>
        <div class="rate-info">
          <span id="rateUsed">0 / 10</span>
          <span id="rateReset">Resets in 60s</span>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">üìã Audit Log</div>
        <div class="audit-log" id="auditLog">
          <div class="audit-entry">
            <span class="audit-time">[INIT]</span>
            <span class="audit-action">Search Bridge online</span>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">üîß Logic Core Output</div>
        <pre style="font-size: 0.65rem; color: var(--text-secondary); white-space: pre-wrap;" id="coreOutput">{
  "mode": "DETERMINISTIC",
  "confidence": 1.0,
  "variance": 0.0,
  "status": "STANDBY"
}</pre>
      </div>
    </aside>
  </main>

  <script type="module">
    import supabase from '/supabase-config.js';

    // ==========================================
    // SECURITY CONFIGURATION
    // ==========================================
    const SECURITY_CONFIG = {
      maxQueryLength: 256,
      rateLimit: 10,
      rateLimitWindow: 60000, // 1 minute
      maxResults: 50,
      forbiddenPatterns: [
        /<script/i,
        /javascript:/i,
        /data:/i,
        /vbscript:/i,
        /on\w+\s*=/i,
        /eval\s*\(/i,
        /expression\s*\(/i,
        /url\s*\(/i,
        /import\s*\(/i,
        /fetch\s*\(/i,
        /XMLHttpRequest/i,
        /__proto__/i,
        /constructor\s*\[/i,
        /\$\{/,
        /`.*`/
      ]
    };

    // ==========================================
    // STATE MANAGEMENT
    // ==========================================
    const state = {
      rateLimit: {
        count: 0,
        resetTime: Date.now() + SECURITY_CONFIG.rateLimitWindow
      },
      auditLog: [],
      currentSource: 'all',
      cognitiveOutput: {
        mode: 'DETERMINISTIC',
        confidence: 1.0,
        variance: 0.0,
        status: 'STANDBY',
        lastQuery: null
      }
    };

    // ==========================================
    // SANITIZATION LAYER
    // ==========================================
    function sanitizeInput(input) {
      if (typeof input !== 'string') return '';

      // Step 1: Trim and enforce length limit
      let sanitized = input.trim().slice(0, SECURITY_CONFIG.maxQueryLength);

      // Step 2: Check for forbidden patterns
      for (const pattern of SECURITY_CONFIG.forbiddenPatterns) {
        if (pattern.test(sanitized)) {
          logAudit('BLOCKED', `Forbidden pattern detected: ${pattern.source.slice(0, 20)}`);
          return null; // Return null to indicate blocked query
        }
      }

      // Step 3: DOMPurify sanitization
      sanitized = DOMPurify.sanitize(sanitized, {
        ALLOWED_TAGS: [],
        ALLOWED_ATTR: [],
        KEEP_CONTENT: true
      });

      // Step 4: Additional character filtering
      sanitized = sanitized
        .replace(/[<>'"`;]/g, '') // Remove dangerous chars
        .replace(/\s+/g, ' ')     // Normalize whitespace
        .trim();

      return sanitized;
    }

    function sanitizeOutput(text) {
      if (typeof text !== 'string') return '';
      return DOMPurify.sanitize(text, {
        ALLOWED_TAGS: ['span'],
        ALLOWED_ATTR: ['class']
      });
    }

    function escapeForDisplay(text) {
      if (typeof text !== 'string') return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ==========================================
    // RATE LIMITING
    // ==========================================
    function checkRateLimit() {
      const now = Date.now();

      // Reset if window expired
      if (now > state.rateLimit.resetTime) {
        state.rateLimit.count = 0;
        state.rateLimit.resetTime = now + SECURITY_CONFIG.rateLimitWindow;
      }

      if (state.rateLimit.count >= SECURITY_CONFIG.rateLimit) {
        logAudit('RATE_LIMITED', 'Request blocked - limit exceeded');
        return false;
      }

      state.rateLimit.count++;
      updateRateMeter();
      return true;
    }

    function updateRateMeter() {
      const fill = document.getElementById('rateFill');
      const used = document.getElementById('rateUsed');
      const reset = document.getElementById('rateReset');

      const pct = (state.rateLimit.count / SECURITY_CONFIG.rateLimit) * 100;
      fill.style.width = `${pct}%`;
      fill.className = 'rate-fill' + (pct > 80 ? ' danger' : pct > 50 ? ' warning' : '');

      used.textContent = `${state.rateLimit.count} / ${SECURITY_CONFIG.rateLimit}`;

      const remaining = Math.max(0, Math.ceil((state.rateLimit.resetTime - Date.now()) / 1000));
      reset.textContent = `Resets in ${remaining}s`;
    }

    // ==========================================
    // AUDIT LOGGING
    // ==========================================
    function logAudit(action, detail) {
      const entry = {
        timestamp: new Date().toISOString(),
        action,
        detail: detail?.slice(0, 100) // Truncate detail
      };

      state.auditLog.push(entry);
      if (state.auditLog.length > 100) state.auditLog.shift();

      renderAuditLog();
      console.log('[Audit]', action, detail);
    }

    function renderAuditLog() {
      const container = document.getElementById('auditLog');
      const entries = state.auditLog.slice(-10).reverse();

      container.innerHTML = entries.map(e => `
        <div class="audit-entry">
          <span class="audit-time">[${e.action}]</span>
          <span class="audit-action">${escapeForDisplay(e.detail || '')}</span>
        </div>
      `).join('');
    }

    // ==========================================
    // SEARCH EXECUTION
    // ==========================================
    async function executeSearch(query) {
      // Security Gate 1: Sanitize input
      const sanitizedQuery = sanitizeInput(query);
      if (sanitizedQuery === null) {
        showError('Query blocked by security filter');
        return;
      }

      if (!sanitizedQuery) {
        showError('Please enter a valid search query');
        return;
      }

      // Security Gate 2: Rate limit
      if (!checkRateLimit()) {
        showError('Rate limit exceeded. Please wait before searching again.');
        return;
      }

      logAudit('SEARCH', `Query: "${sanitizedQuery.slice(0, 50)}..."`);

      updateCognitiveState('ACTIVE', sanitizedQuery);
      document.getElementById('searchBtn').disabled = true;
      document.getElementById('resultsCount').textContent = 'Searching...';

      try {
        const results = await searchDataSources(sanitizedQuery, state.currentSource);
        renderResults(results, sanitizedQuery);

        updateCognitiveState('VERIFIED', sanitizedQuery, results.length);
        logAudit('RESULTS', `Found ${results.length} results`);

      } catch (err) {
        console.error('[Search Error]', err);
        logAudit('ERROR', err.message);
        showError('Search failed. Please try again.');
        updateCognitiveState('ERROR', sanitizedQuery);
      } finally {
        document.getElementById('searchBtn').disabled = false;
      }
    }

    async function searchDataSources(query, source) {
      const results = [];
      const searchTerm = `%${query}%`;

      const sources = {
        messages: async () => {
          const { data } = await supabase
            .from('sloppygram_messages')
            .select('id, content, username, created_at')
            .ilike('content', searchTerm)
            .limit(SECURITY_CONFIG.maxResults);
          return (data || []).map(r => ({
            source: 'MESSAGES',
            title: `Message from ${r.username || 'Anonymous'}`,
            snippet: r.content,
            meta: { id: r.id, date: r.created_at }
          }));
        },
        posts: async () => {
          const { data } = await supabase
            .from('sloppygram_posts')
            .select('id, text, username, created_at')
            .ilike('text', searchTerm)
            .limit(SECURITY_CONFIG.maxResults);
          return (data || []).map(r => ({
            source: 'POSTS',
            title: `Post by ${r.username || 'Anonymous'}`,
            snippet: r.text,
            meta: { id: r.id, date: r.created_at }
          }));
        },
        manifestos: async () => {
          const { data } = await supabase
            .from('sloppygram_manifestos')
            .select('id, title, content, author_name, created_at')
            .or(`title.ilike.${searchTerm},content.ilike.${searchTerm}`)
            .limit(SECURITY_CONFIG.maxResults);
          return (data || []).map(r => ({
            source: 'MANIFESTOS',
            title: r.title || 'Untitled Manifesto',
            snippet: r.content,
            meta: { id: r.id, author: r.author_name, date: r.created_at }
          }));
        },
        feedback: async () => {
          const { data } = await supabase
            .from('feedback')
            .select('id, title, description, created_at')
            .or(`title.ilike.${searchTerm},description.ilike.${searchTerm}`)
            .limit(SECURITY_CONFIG.maxResults);
          return (data || []).map(r => ({
            source: 'FEEDBACK',
            title: r.title || 'Feedback',
            snippet: r.description,
            meta: { id: r.id, date: r.created_at }
          }));
        }
      };

      // Execute searches based on selected source
      if (source === 'all') {
        const allResults = await Promise.all(Object.values(sources).map(fn => fn()));
        results.push(...allResults.flat());
      } else if (sources[source]) {
        const sourceResults = await sources[source]();
        results.push(...sourceResults);
      }

      // Sort by date (most recent first)
      results.sort((a, b) => new Date(b.meta?.date || 0) - new Date(a.meta?.date || 0));

      return results.slice(0, SECURITY_CONFIG.maxResults);
    }

    // ==========================================
    // RENDERING
    // ==========================================
    function renderResults(results, query) {
      const container = document.getElementById('resultsContainer');
      const countEl = document.getElementById('resultsCount');

      countEl.textContent = `${results.length} result${results.length !== 1 ? 's' : ''} found`;

      if (results.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üîç</div>
            <p>No results found for "${escapeForDisplay(query)}"</p>
          </div>
        `;
        return;
      }

      container.innerHTML = results.map(r => {
        const snippet = highlightQuery(sanitizeOutput(r.snippet || '').slice(0, 200), query);
        const date = r.meta?.date ? new Date(r.meta.date).toLocaleDateString() : '';

        return `
          <div class="result-card">
            <div class="result-source">${escapeForDisplay(r.source)}</div>
            <div class="result-title">${escapeForDisplay(r.title)}</div>
            <div class="result-snippet">${snippet}</div>
            <div class="result-meta">
              ${r.meta?.author ? `<span>By: ${escapeForDisplay(r.meta.author)}</span>` : ''}
              ${date ? `<span>${date}</span>` : ''}
              <span>ID: ${escapeForDisplay(String(r.meta?.id || 'N/A'))}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    function highlightQuery(text, query) {
      if (!query) return text;
      const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const regex = new RegExp(`(${escapedQuery})`, 'gi');
      return text.replace(regex, '<span class="highlight">$1</span>');
    }

    function showError(message) {
      const container = document.getElementById('resultsContainer');
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">‚ö†Ô∏è</div>
          <p style="color: var(--accent-red);">${escapeForDisplay(message)}</p>
        </div>
      `;
      document.getElementById('resultsCount').textContent = 'Error';
    }

    // ==========================================
    // COGNITIVE STATE OUTPUT
    // ==========================================
    function updateCognitiveState(status, query, resultCount = 0) {
      state.cognitiveOutput = {
        mode: 'DETERMINISTIC',
        confidence: status === 'ERROR' ? 0.5 : 1.0,
        variance: 0.0,
        status: status,
        lastQuery: query?.slice(0, 50),
        resultCount: resultCount,
        timestamp: new Date().toISOString()
      };

      document.getElementById('coreOutput').textContent = JSON.stringify(state.cognitiveOutput, null, 2);
    }

    // ==========================================
    // EVENT HANDLERS
    // ==========================================
    document.getElementById('searchBtn').addEventListener('click', () => {
      executeSearch(document.getElementById('queryInput').value);
    });

    document.getElementById('queryInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        executeSearch(e.target.value);
      }
    });

    document.querySelectorAll('.filter-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        state.currentSource = chip.dataset.source;
        logAudit('FILTER', `Source: ${state.currentSource}`);
      });
    });

    // ==========================================
    // INITIALIZATION
    // ==========================================
    function init() {
      // Verify DOMPurify loaded
      if (typeof DOMPurify === 'undefined') {
        document.getElementById('sanitizerStatus').classList.add('error');
        logAudit('ERROR', 'DOMPurify failed to load');
        return;
      }

      logAudit('INIT', 'All security layers active');

      // Start rate limit timer
      setInterval(updateRateMeter, 1000);

      console.log('[Search Bridge] Secure query processor initialized');
      console.log('[Security] DOMPurify:', typeof DOMPurify !== 'undefined' ? 'ACTIVE' : 'MISSING');
      console.log('[Security] Rate Limit:', SECURITY_CONFIG.rateLimit, 'per', SECURITY_CONFIG.rateLimitWindow / 1000, 's');
    }

    init();
  </script>
</body>
</html>
