<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Dash to the Dunny</title>
  <link rel="icon" href="https://emojicdn.elk.sh/üöΩ">

  <meta property="og:title" content="Dash to the Dunny">
  <meta property="og:description" content="Navigate a crowded party before it's too late!">
  <meta property="og:url" content="https://sloppy.live/dunny-dash">
  <meta property="og:image" content="https://sloppy.live/dunny-dash/og-image.png">
  <meta property="og:type" content="website">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #1a0a2e;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: 'Press Start 2P', monospace;
      overflow: hidden;
      image-rendering: pixelated;
    }

    #game-container {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    #urgency-bar-container {
      width: 320px;
      height: 24px;
      background: #2a1a4e;
      border: 4px solid #ff6b9d;
      position: relative;
    }

    #urgency-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #ffeb3b, #ff9800, #f44336);
      transition: width 0.1s linear;
    }

    #urgency-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #fff;
      font-size: 8px;
      text-shadow: 1px 1px 0 #000;
      white-space: nowrap;
    }

    canvas {
      border: 4px solid #ff6b9d;
      background: #2d1b4e;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }

    #mobile-controls {
      display: none;
      gap: 8px;
      margin-top: 12px;
    }

    .ctrl-row {
      display: flex;
      justify-content: center;
      gap: 8px;
    }

    .ctrl-btn {
      width: 56px;
      height: 56px;
      background: #ff6b9d;
      border: 3px solid #fff;
      color: #fff;
      font-family: 'Press Start 2P', monospace;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
    }

    .ctrl-btn:active {
      background: #d4507a;
      transform: scale(0.95);
    }

    .ctrl-placeholder {
      width: 56px;
      height: 56px;
      visibility: hidden;
    }

    #start-screen, #win-screen, #lose-screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(26, 10, 46, 0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
      padding: 20px;
      text-align: center;
    }

    .screen-title {
      color: #ff6b9d;
      font-size: 16px;
      margin-bottom: 16px;
      text-shadow: 2px 2px 0 #000;
    }

    .screen-emoji {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .screen-text {
      color: #fff;
      font-size: 8px;
      line-height: 1.8;
      margin-bottom: 20px;
      max-width: 280px;
    }

    .play-btn {
      background: #ff6b9d;
      border: 3px solid #fff;
      color: #fff;
      font-family: 'Press Start 2P', monospace;
      font-size: 10px;
      padding: 12px 24px;
      cursor: pointer;
      transition: transform 0.1s;
    }

    .play-btn:hover {
      transform: scale(1.05);
    }

    .play-btn:active {
      transform: scale(0.95);
    }

    #win-screen { display: none; }
    #lose-screen { display: none; }

    .win-title { color: #4caf50; }
    .lose-title { color: #f44336; }

    #level-display {
      color: #ff6b9d;
      font-size: 10px;
      margin-bottom: 8px;
    }

    .back-link {
      position: fixed;
      bottom: 12px;
      left: 12px;
      color: #ff6b9d;
      font-size: 8px;
      text-decoration: none;
      opacity: 0.7;
    }

    .back-link:hover {
      opacity: 1;
    }

    @media (max-width: 600px) {
      #mobile-controls {
        display: flex;
        flex-direction: column;
      }
    }

    @media (pointer: coarse) {
      #mobile-controls {
        display: flex;
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div id="game-container">
    <div id="level-display">LEVEL 1</div>
    <div id="urgency-bar-container">
      <div id="urgency-bar"></div>
      <div id="urgency-label">GOTTA GO!</div>
    </div>
    <canvas id="game" width="320" height="320"></canvas>

    <div id="mobile-controls">
      <div class="ctrl-row">
        <div class="ctrl-placeholder"></div>
        <button class="ctrl-btn" data-dir="up">‚ñ≤</button>
        <div class="ctrl-placeholder"></div>
      </div>
      <div class="ctrl-row">
        <button class="ctrl-btn" data-dir="left">‚óÄ</button>
        <button class="ctrl-btn" data-dir="down">‚ñº</button>
        <button class="ctrl-btn" data-dir="right">‚ñ∂</button>
      </div>
    </div>

    <div id="start-screen">
      <div class="screen-emoji">üöΩ</div>
      <div class="screen-title">DASH TO THE DUNNY</div>
      <div class="screen-text">
        You've had too many drinks at the party!<br><br>
        Navigate through the crowd to reach the bathroom before it's too late!<br><br>
        Use WASD or Arrow Keys to move
      </div>
      <button class="play-btn" id="start-btn">START</button>
    </div>

    <div id="win-screen">
      <div class="screen-emoji">üòå</div>
      <div class="screen-title win-title">SWEET RELIEF!</div>
      <div class="screen-text">
        You made it just in time!<br><br>
        But the drinks keep flowing...
      </div>
      <button class="play-btn" id="next-btn">NEXT LEVEL</button>
    </div>

    <div id="lose-screen">
      <div class="screen-emoji">üò±</div>
      <div class="screen-title lose-title">OH NO!</div>
      <div class="screen-text">
        You didn't make it in time...<br><br>
        The party is ruined!
      </div>
      <button class="play-btn" id="retry-btn">TRY AGAIN</button>
    </div>
  </div>

  <a href="https://sloppy.live" class="back-link">‚Üê sloppy.live</a>

  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const TILE = 16;
    const COLS = 20;
    const ROWS = 20;

    // Game state
    let level = 1;
    let urgency = 0;
    let urgencyRate = 0.15;
    let gameState = 'start'; // start, playing, win, lose
    let player = { x: 1, y: 18, moving: false };
    let bathroom = { x: 18, y: 1 };
    let partygoers = [];
    let obstacles = [];
    let lastTime = 0;
    let moveDelay = 0;

    // Colors
    const COLORS = {
      floor: '#2d1b4e',
      wall: '#1a0a2e',
      player: '#4fc3f7',
      playerDark: '#0288d1',
      bathroom: '#4caf50',
      bathroomDark: '#2e7d32',
      partygoer: ['#ff6b9d', '#ffeb3b', '#ff9800', '#9c27b0', '#e91e63'],
      obstacle: '#5d4e7a',
      disco: ['#ff6b9d', '#4fc3f7', '#ffeb3b', '#9c27b0']
    };

    // Partygoer sprites (simple pixel patterns)
    function drawPixelPerson(x, y, color, frame) {
      ctx.fillStyle = color;
      // Head
      ctx.fillRect(x + 5, y + 1, 6, 6);
      // Body
      ctx.fillRect(x + 4, y + 7, 8, 6);
      // Legs (animate)
      if (frame % 2 === 0) {
        ctx.fillRect(x + 4, y + 13, 3, 3);
        ctx.fillRect(x + 9, y + 13, 3, 3);
      } else {
        ctx.fillRect(x + 5, y + 13, 3, 3);
        ctx.fillRect(x + 8, y + 13, 3, 3);
      }
    }

    function drawPlayer(x, y, frame) {
      // Player is more urgent looking
      ctx.fillStyle = COLORS.player;
      // Head (sweating)
      ctx.fillRect(x + 5, y + 1, 6, 6);
      // Sweat drop
      ctx.fillStyle = '#fff';
      ctx.fillRect(x + 12, y + 3, 2, 3);
      // Body
      ctx.fillStyle = COLORS.playerDark;
      ctx.fillRect(x + 4, y + 7, 8, 6);
      // Legs (running animation)
      ctx.fillStyle = COLORS.player;
      if (frame % 4 < 2) {
        ctx.fillRect(x + 3, y + 13, 3, 3);
        ctx.fillRect(x + 10, y + 13, 3, 3);
      } else {
        ctx.fillRect(x + 5, y + 13, 3, 3);
        ctx.fillRect(x + 8, y + 13, 3, 3);
      }
    }

    function drawBathroom(x, y) {
      // Toilet
      ctx.fillStyle = COLORS.bathroom;
      ctx.fillRect(x + 2, y + 2, 12, 12);
      ctx.fillStyle = COLORS.bathroomDark;
      ctx.fillRect(x + 4, y + 4, 8, 8);
      ctx.fillStyle = '#fff';
      ctx.fillRect(x + 5, y + 5, 6, 4);
      // Glow effect
      ctx.fillStyle = 'rgba(76, 175, 80, 0.3)';
      ctx.fillRect(x - 2, y - 2, 20, 20);
    }

    function drawObstacle(x, y) {
      // Table/couch
      ctx.fillStyle = COLORS.obstacle;
      ctx.fillRect(x + 1, y + 4, 14, 8);
      ctx.fillStyle = '#4a3d6a';
      ctx.fillRect(x + 2, y + 5, 12, 6);
    }

    function generateLevel() {
      partygoers = [];
      obstacles = [];

      // Number of obstacles and partygoers increases with level
      const numObstacles = Math.min(3 + level, 10);
      const numPartygoers = Math.min(8 + level * 3, 30);

      // Place obstacles
      for (let i = 0; i < numObstacles; i++) {
        let ox, oy;
        let attempts = 0;
        do {
          ox = Math.floor(Math.random() * (COLS - 4)) + 2;
          oy = Math.floor(Math.random() * (ROWS - 4)) + 2;
          attempts++;
        } while (attempts < 50 && (
          isNearPlayer(ox, oy) ||
          isNearBathroom(ox, oy) ||
          obstacles.some(o => Math.abs(o.x - ox) < 3 && Math.abs(o.y - oy) < 3)
        ));

        if (attempts < 50) {
          obstacles.push({ x: ox, y: oy });
        }
      }

      // Place partygoers
      for (let i = 0; i < numPartygoers; i++) {
        let px, py;
        let attempts = 0;
        do {
          px = Math.floor(Math.random() * (COLS - 2)) + 1;
          py = Math.floor(Math.random() * (ROWS - 2)) + 1;
          attempts++;
        } while (attempts < 50 && (
          isNearPlayer(px, py) ||
          isNearBathroom(px, py) ||
          isOnObstacle(px, py) ||
          partygoers.some(p => p.x === px && p.y === py)
        ));

        if (attempts < 50) {
          partygoers.push({
            x: px,
            y: py,
            color: COLORS.partygoer[Math.floor(Math.random() * COLORS.partygoer.length)],
            moveTimer: Math.random() * 2000,
            frame: Math.floor(Math.random() * 4)
          });
        }
      }

      // Adjust urgency rate based on level
      urgencyRate = 0.12 + level * 0.03;
    }

    function isNearPlayer(x, y) {
      return Math.abs(x - player.x) < 3 && Math.abs(y - player.y) < 3;
    }

    function isNearBathroom(x, y) {
      return Math.abs(x - bathroom.x) < 3 && Math.abs(y - bathroom.y) < 3;
    }

    function isOnObstacle(x, y) {
      return obstacles.some(o =>
        x >= o.x - 1 && x <= o.x + 1 &&
        y >= o.y - 1 && y <= o.y + 1
      );
    }

    function canMoveTo(x, y) {
      // Check bounds
      if (x < 0 || x >= COLS || y < 0 || y >= ROWS) return false;
      // Check obstacles
      if (isOnObstacle(x, y)) return false;
      // Check partygoers
      if (partygoers.some(p => p.x === x && p.y === y)) return false;
      return true;
    }

    function movePartygoers(dt) {
      partygoers.forEach(p => {
        p.moveTimer -= dt;
        if (p.moveTimer <= 0) {
          p.moveTimer = 1000 + Math.random() * 2000;
          p.frame = (p.frame + 1) % 4;

          // Random movement
          const dirs = [[0, -1], [0, 1], [-1, 0], [1, 0], [0, 0], [0, 0]];
          const dir = dirs[Math.floor(Math.random() * dirs.length)];
          const nx = p.x + dir[0];
          const ny = p.y + dir[1];

          if (nx > 0 && nx < COLS - 1 && ny > 0 && ny < ROWS - 1 &&
              !isOnObstacle(nx, ny) &&
              !isNearBathroom(nx, ny) &&
              !(nx === player.x && ny === player.y) &&
              !partygoers.some(other => other !== p && other.x === nx && other.y === ny)) {
            p.x = nx;
            p.y = ny;
          }
        }
      });
    }

    let discoFrame = 0;

    function draw(time) {
      const dt = time - lastTime;
      lastTime = time;

      if (gameState === 'playing') {
        urgency += urgencyRate * dt / 1000;
        document.getElementById('urgency-bar').style.width = Math.min(urgency, 100) + '%';

        // Update urgency label
        const label = document.getElementById('urgency-label');
        if (urgency > 80) label.textContent = "CAN'T HOLD IT!";
        else if (urgency > 60) label.textContent = "HURRY!!!";
        else if (urgency > 40) label.textContent = "GETTING URGENT!";
        else label.textContent = "GOTTA GO!";

        if (urgency >= 100) {
          gameState = 'lose';
          document.getElementById('lose-screen').style.display = 'flex';
        }

        movePartygoers(dt);
        moveDelay = Math.max(0, moveDelay - dt);
      }

      // Clear
      ctx.fillStyle = COLORS.floor;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Disco floor effect
      discoFrame = (discoFrame + dt * 0.003) % 4;
      for (let x = 0; x < COLS; x++) {
        for (let y = 0; y < ROWS; y++) {
          if ((x + y + Math.floor(discoFrame)) % 4 === 0) {
            ctx.fillStyle = 'rgba(255, 107, 157, 0.1)';
            ctx.fillRect(x * TILE, y * TILE, TILE, TILE);
          }
        }
      }

      // Draw walls (border)
      ctx.fillStyle = COLORS.wall;
      for (let i = 0; i < COLS; i++) {
        ctx.fillRect(i * TILE, 0, TILE, 2);
        ctx.fillRect(i * TILE, (ROWS - 1) * TILE + 14, TILE, 2);
      }
      for (let i = 0; i < ROWS; i++) {
        ctx.fillRect(0, i * TILE, 2, TILE);
        ctx.fillRect((COLS - 1) * TILE + 14, i * TILE, 2, TILE);
      }

      // Draw bathroom
      drawBathroom(bathroom.x * TILE, bathroom.y * TILE);

      // Draw obstacles
      obstacles.forEach(o => drawObstacle(o.x * TILE, o.y * TILE));

      // Draw partygoers
      partygoers.forEach(p => drawPixelPerson(p.x * TILE, p.y * TILE, p.color, p.frame));

      // Draw player
      drawPlayer(player.x * TILE, player.y * TILE, Math.floor(time / 150));

      requestAnimationFrame(draw);
    }

    function movePlayer(dx, dy) {
      if (gameState !== 'playing' || moveDelay > 0) return;

      const nx = player.x + dx;
      const ny = player.y + dy;

      if (canMoveTo(nx, ny)) {
        player.x = nx;
        player.y = ny;
        moveDelay = 100;

        // Check win condition
        if (player.x === bathroom.x && player.y === bathroom.y) {
          gameState = 'win';
          document.getElementById('win-screen').style.display = 'flex';
        }
      }
    }

    // Keyboard controls
    const keys = {};
    document.addEventListener('keydown', e => {
      if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'w', 'a', 's', 'd'].includes(e.key)) {
        e.preventDefault();
        keys[e.key] = true;
      }
    });

    document.addEventListener('keyup', e => {
      keys[e.key] = false;
    });

    // Process held keys
    function processInput() {
      if (gameState === 'playing') {
        if (keys['ArrowUp'] || keys['w']) movePlayer(0, -1);
        else if (keys['ArrowDown'] || keys['s']) movePlayer(0, 1);
        else if (keys['ArrowLeft'] || keys['a']) movePlayer(-1, 0);
        else if (keys['ArrowRight'] || keys['d']) movePlayer(1, 0);
      }
      requestAnimationFrame(processInput);
    }

    // Mobile controls
    document.querySelectorAll('.ctrl-btn').forEach(btn => {
      const dir = btn.dataset.dir;

      const handleMove = () => {
        if (dir === 'up') movePlayer(0, -1);
        if (dir === 'down') movePlayer(0, 1);
        if (dir === 'left') movePlayer(-1, 0);
        if (dir === 'right') movePlayer(1, 0);
      };

      btn.addEventListener('touchstart', e => {
        e.preventDefault();
        handleMove();
      });

      btn.addEventListener('mousedown', handleMove);
    });

    // Start/restart
    function startGame() {
      player = { x: 1, y: 18 };
      urgency = 0;
      document.getElementById('urgency-bar').style.width = '0%';
      document.getElementById('level-display').textContent = 'LEVEL ' + level;
      generateLevel();
      gameState = 'playing';
    }

    document.getElementById('start-btn').addEventListener('click', () => {
      document.getElementById('start-screen').style.display = 'none';
      level = 1;
      startGame();
    });

    document.getElementById('next-btn').addEventListener('click', () => {
      document.getElementById('win-screen').style.display = 'none';
      level++;
      startGame();
    });

    document.getElementById('retry-btn').addEventListener('click', () => {
      document.getElementById('lose-screen').style.display = 'none';
      level = 1;
      startGame();
    });

    // Init
    requestAnimationFrame(draw);
    requestAnimationFrame(processInput);
  </script>
<script src="/sloppy-header/sloppy-bar.js"></script>
</body>
</html>
