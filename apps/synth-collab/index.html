<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Synth Collab - Neon Jam Session</title>
  <meta name="description" content="Collaborative neon synthesizer with shared pads">
  <meta property="og:title" content="Synth Collab">
  <meta property="og:description" content="Real-time collaborative synthesizer with neon visuals">
  <meta property="og:url" content="https://sloppy.live/synth-collab">
  <meta property="og:image" content="https://sloppy.live/synth-collab/og-image.png">
  <link rel="icon" href="https://emojicdn.elk.sh/ðŸŽ¹">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      min-height: 100vh;
      background: #050508;
      font-family: 'Orbitron', sans-serif;
      color: #fff;
      overflow-x: hidden;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: 900;
      letter-spacing: 3px;
      background: linear-gradient(135deg, #0ff, #f0f, #ff0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.7rem;
      color: #888;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #0f0;
      box-shadow: 0 0 10px #0f0;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .players {
      display: flex;
      gap: 5px;
    }

    .player-dot {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6rem;
      font-weight: bold;
      color: #000;
    }

    /* Visualizers */
    .visualizers {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .visualizer {
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 15px;
      position: relative;
    }

    .visualizer-label {
      position: absolute;
      top: 10px;
      left: 15px;
      font-size: 0.6rem;
      color: #666;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    .visualizer canvas {
      width: 100%;
      height: 120px;
      display: block;
    }

    /* Controls */
    .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .control-label {
      font-size: 0.6rem;
      color: #888;
      letter-spacing: 1px;
    }

    select, input[type="range"] {
      background: #111;
      border: 1px solid #333;
      color: #0ff;
      font-family: 'Orbitron', sans-serif;
      font-size: 0.7rem;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
    }

    select:focus, input:focus {
      outline: none;
      border-color: #0ff;
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
    }

    input[type="range"] {
      width: 100px;
      height: 6px;
      padding: 0;
      -webkit-appearance: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: linear-gradient(135deg, #0ff, #f0f);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 10px #0ff;
    }

    /* Pad Grid */
    .pad-section {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 16px;
      padding: 25px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .pad-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      max-width: 600px;
      margin: 0 auto;
    }

    .pad {
      aspect-ratio: 1;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: all 0.1s;
      position: relative;
      overflow: hidden;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .pad::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      opacity: 0;
      transition: opacity 0.1s;
    }

    .pad:hover {
      transform: scale(1.02);
    }

    .pad.active {
      transform: scale(0.95);
    }

    .pad.active::before {
      opacity: 1;
    }

    .pad-note {
      font-size: 1.5rem;
      font-weight: 700;
      z-index: 1;
      text-shadow: 0 0 10px currentColor;
    }

    .pad-key {
      font-size: 0.6rem;
      opacity: 0.5;
      margin-top: 5px;
      z-index: 1;
    }

    .pad-player {
      position: absolute;
      bottom: 8px;
      right: 8px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      font-size: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .pad.remote-active .pad-player {
      opacity: 1;
    }

    /* Pad colors */
    .pad[data-color="cyan"] {
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(0, 255, 255, 0.1));
      border: 2px solid rgba(0, 255, 255, 0.4);
      color: #0ff;
    }
    .pad[data-color="cyan"]::before {
      background: radial-gradient(circle, rgba(0, 255, 255, 0.6), transparent);
      box-shadow: 0 0 40px #0ff;
    }

    .pad[data-color="magenta"] {
      background: linear-gradient(135deg, rgba(255, 0, 255, 0.2), rgba(255, 0, 255, 0.1));
      border: 2px solid rgba(255, 0, 255, 0.4);
      color: #f0f;
    }
    .pad[data-color="magenta"]::before {
      background: radial-gradient(circle, rgba(255, 0, 255, 0.6), transparent);
      box-shadow: 0 0 40px #f0f;
    }

    .pad[data-color="yellow"] {
      background: linear-gradient(135deg, rgba(255, 255, 0, 0.2), rgba(255, 255, 0, 0.1));
      border: 2px solid rgba(255, 255, 0, 0.4);
      color: #ff0;
    }
    .pad[data-color="yellow"]::before {
      background: radial-gradient(circle, rgba(255, 255, 0, 0.6), transparent);
      box-shadow: 0 0 40px #ff0;
    }

    .pad[data-color="green"] {
      background: linear-gradient(135deg, rgba(0, 255, 128, 0.2), rgba(0, 255, 128, 0.1));
      border: 2px solid rgba(0, 255, 128, 0.4);
      color: #0f8;
    }
    .pad[data-color="green"]::before {
      background: radial-gradient(circle, rgba(0, 255, 128, 0.6), transparent);
      box-shadow: 0 0 40px #0f8;
    }

    /* Activity log */
    .activity {
      margin-top: 20px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      max-height: 80px;
      overflow-y: auto;
    }

    .activity-item {
      font-size: 0.65rem;
      color: #666;
      margin: 4px 0;
    }

    .activity-item span {
      color: #0ff;
    }

    .back-link {
      display: block;
      text-align: center;
      margin-top: 20px;
      color: #333;
      text-decoration: none;
      font-size: 0.65rem;
      letter-spacing: 2px;
    }

    .back-link:hover {
      color: #0ff;
    }

    @media (max-width: 600px) {
      .visualizers {
        grid-template-columns: 1fr;
      }
      .pad-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
      }
      .pad-note { font-size: 1.2rem; }
      h1 { font-size: 1.2rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        <span style="font-size: 1.5rem;">ðŸŽ¹</span>
        <h1>SYNTH COLLAB</h1>
      </div>
      <div class="status">
        <div class="status-dot"></div>
        <span id="playerCount">1 player</span>
        <div class="players" id="playerAvatars"></div>
      </div>
    </div>

    <div class="visualizers">
      <div class="visualizer">
        <span class="visualizer-label">Waveform</span>
        <canvas id="waveformCanvas"></canvas>
      </div>
      <div class="visualizer">
        <span class="visualizer-label">Frequency</span>
        <canvas id="frequencyCanvas"></canvas>
      </div>
    </div>

    <div class="controls">
      <div class="control-group">
        <span class="control-label">WAVEFORM</span>
        <select id="waveform">
          <option value="sine">Sine</option>
          <option value="square">Square</option>
          <option value="sawtooth" selected>Sawtooth</option>
          <option value="triangle">Triangle</option>
        </select>
      </div>
      <div class="control-group">
        <span class="control-label">ATTACK</span>
        <input type="range" id="attack" min="0" max="500" value="10">
      </div>
      <div class="control-group">
        <span class="control-label">RELEASE</span>
        <input type="range" id="release" min="50" max="2000" value="500">
      </div>
      <div class="control-group">
        <span class="control-label">FILTER</span>
        <input type="range" id="filter" min="100" max="10000" value="5000">
      </div>
      <div class="control-group">
        <span class="control-label">REVERB</span>
        <input type="range" id="reverb" min="0" max="100" value="30">
      </div>
    </div>

    <div class="pad-section">
      <div class="pad-grid" id="padGrid"></div>
    </div>

    <div class="activity" id="activity">
      <div class="activity-item">ðŸŽ¹ Session started. Tap pads or use keyboard!</div>
    </div>

    <a href="https://sloppy.live" class="back-link">SLOPPY.LIVE</a>
  </div>

  <script type="module">
    import { supabaseSession } from '/supabase-config.js';

    // Audio context
    let audioCtx = null;
    let analyser = null;
    let filter = null;
    let convolver = null;
    let masterGain = null;
    const activeOscillators = {};

    // Pad configuration
    const pads = [
      { note: 'C4', freq: 261.63, key: '1', color: 'cyan' },
      { note: 'D4', freq: 293.66, key: '2', color: 'cyan' },
      { note: 'E4', freq: 329.63, key: '3', color: 'cyan' },
      { note: 'F4', freq: 349.23, key: '4', color: 'cyan' },
      { note: 'G4', freq: 392.00, key: 'q', color: 'magenta' },
      { note: 'A4', freq: 440.00, key: 'w', color: 'magenta' },
      { note: 'B4', freq: 493.88, key: 'e', color: 'magenta' },
      { note: 'C5', freq: 523.25, key: 'r', color: 'magenta' },
      { note: 'D5', freq: 587.33, key: 'a', color: 'yellow' },
      { note: 'E5', freq: 659.25, key: 's', color: 'yellow' },
      { note: 'F5', freq: 698.46, key: 'd', color: 'yellow' },
      { note: 'G5', freq: 783.99, key: 'f', color: 'yellow' },
      { note: 'A5', freq: 880.00, key: 'z', color: 'green' },
      { note: 'B5', freq: 987.77, key: 'x', color: 'green' },
      { note: 'C6', freq: 1046.50, key: 'c', color: 'green' },
      { note: 'D6', freq: 1174.66, key: 'v', color: 'green' }
    ];

    // Player info
    let playerId = Math.random().toString(36).substr(2, 6);
    let playerColor = `hsl(${Math.random() * 360}, 80%, 60%)`;
    let supabase = null;
    let channel = null;

    // Initialize audio
    function initAudio() {
      if (audioCtx) return;

      audioCtx = new (window.AudioContext || window.webkitAudioContext)();

      // Create nodes
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;

      filter = audioCtx.createBiquadFilter();
      filter.type = 'lowpass';
      filter.frequency.value = 5000;

      masterGain = audioCtx.createGain();
      masterGain.gain.value = 0.5;

      // Simple reverb using delay
      convolver = audioCtx.createDelay();
      convolver.delayTime.value = 0.1;
      const reverbGain = audioCtx.createGain();
      reverbGain.gain.value = 0.3;

      // Connect nodes
      filter.connect(masterGain);
      masterGain.connect(analyser);
      analyser.connect(audioCtx.destination);

      // Reverb path
      masterGain.connect(convolver);
      convolver.connect(reverbGain);
      reverbGain.connect(audioCtx.destination);

      startVisualizers();
    }

    // Play note
    function playNote(padIndex, remote = false, remotePlayer = null) {
      initAudio();

      const pad = pads[padIndex];
      const id = `${padIndex}-${remote ? remotePlayer : 'local'}`;

      if (activeOscillators[id]) return;

      const waveform = document.getElementById('waveform').value;
      const attackTime = document.getElementById('attack').value / 1000;

      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      osc.type = waveform;
      osc.frequency.value = pad.freq;

      gain.gain.setValueAtTime(0, audioCtx.currentTime);
      gain.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + attackTime);

      osc.connect(gain);
      gain.connect(filter);

      osc.start();
      activeOscillators[id] = { osc, gain };

      // Visual feedback
      const padEl = document.querySelector(`[data-index="${padIndex}"]`);
      if (padEl) {
        if (remote) {
          padEl.classList.add('remote-active');
          const playerDot = padEl.querySelector('.pad-player');
          if (playerDot) {
            playerDot.style.background = players[remotePlayer]?.color || '#fff';
          }
        } else {
          padEl.classList.add('active');
        }
      }

      // Broadcast if local
      if (!remote && channel) {
        channel.send({
          type: 'broadcast',
          event: 'pad',
          payload: { action: 'start', pad: padIndex, player: playerId }
        });
      }
    }

    // Stop note
    function stopNote(padIndex, remote = false, remotePlayer = null) {
      const id = `${padIndex}-${remote ? remotePlayer : 'local'}`;
      const active = activeOscillators[id];

      if (!active) return;

      const releaseTime = document.getElementById('release').value / 1000;

      active.gain.gain.cancelScheduledValues(audioCtx.currentTime);
      active.gain.gain.setValueAtTime(active.gain.gain.value, audioCtx.currentTime);
      active.gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + releaseTime);

      setTimeout(() => {
        active.osc.stop();
        active.osc.disconnect();
        active.gain.disconnect();
      }, releaseTime * 1000 + 50);

      delete activeOscillators[id];

      // Visual feedback
      const padEl = document.querySelector(`[data-index="${padIndex}"]`);
      if (padEl) {
        padEl.classList.remove(remote ? 'remote-active' : 'active');
      }

      // Broadcast if local
      if (!remote && channel) {
        channel.send({
          type: 'broadcast',
          event: 'pad',
          payload: { action: 'stop', pad: padIndex, player: playerId }
        });
      }
    }

    // Create pad grid
    function createPadGrid() {
      const grid = document.getElementById('padGrid');

      pads.forEach((pad, index) => {
        const el = document.createElement('div');
        el.className = 'pad';
        el.dataset.index = index;
        el.dataset.color = pad.color;
        el.innerHTML = `
          <span class="pad-note">${pad.note}</span>
          <span class="pad-key">${pad.key.toUpperCase()}</span>
          <div class="pad-player"></div>
        `;

        // Mouse events
        el.addEventListener('mousedown', (e) => {
          e.preventDefault();
          playNote(index);
        });
        el.addEventListener('mouseup', () => stopNote(index));
        el.addEventListener('mouseleave', () => stopNote(index));

        // Touch events
        el.addEventListener('touchstart', (e) => {
          e.preventDefault();
          playNote(index);
        });
        el.addEventListener('touchend', () => stopNote(index));

        grid.appendChild(el);
      });
    }

    // Keyboard input
    const keyMap = {};
    pads.forEach((pad, index) => {
      keyMap[pad.key.toLowerCase()] = index;
    });

    document.addEventListener('keydown', (e) => {
      if (e.repeat) return;
      const index = keyMap[e.key.toLowerCase()];
      if (index !== undefined) {
        playNote(index);
      }
    });

    document.addEventListener('keyup', (e) => {
      const index = keyMap[e.key.toLowerCase()];
      if (index !== undefined) {
        stopNote(index);
      }
    });

    // Filter control
    document.getElementById('filter').addEventListener('input', (e) => {
      if (filter) filter.frequency.value = e.target.value;
    });

    // Visualizers
    function startVisualizers() {
      const waveformCanvas = document.getElementById('waveformCanvas');
      const frequencyCanvas = document.getElementById('frequencyCanvas');
      const waveCtx = waveformCanvas.getContext('2d');
      const freqCtx = frequencyCanvas.getContext('2d');

      function resize() {
        [waveformCanvas, frequencyCanvas].forEach(c => {
          c.width = c.offsetWidth * 2;
          c.height = c.offsetHeight * 2;
        });
      }
      resize();
      window.addEventListener('resize', resize);

      const bufferLength = analyser.frequencyBinCount;
      const timeData = new Uint8Array(bufferLength);
      const freqData = new Uint8Array(bufferLength);

      function draw() {
        requestAnimationFrame(draw);

        // Waveform
        analyser.getByteTimeDomainData(timeData);
        waveCtx.fillStyle = '#050508';
        waveCtx.fillRect(0, 0, waveformCanvas.width, waveformCanvas.height);

        waveCtx.lineWidth = 2;
        waveCtx.strokeStyle = '#0ff';
        waveCtx.shadowColor = '#0ff';
        waveCtx.shadowBlur = 10;
        waveCtx.beginPath();

        const sliceWidth = waveformCanvas.width / bufferLength;
        let x = 0;

        for (let i = 0; i < bufferLength; i++) {
          const v = timeData[i] / 128.0;
          const y = v * waveformCanvas.height / 2;

          if (i === 0) waveCtx.moveTo(x, y);
          else waveCtx.lineTo(x, y);

          x += sliceWidth;
        }

        waveCtx.lineTo(waveformCanvas.width, waveformCanvas.height / 2);
        waveCtx.stroke();

        // Frequency
        analyser.getByteFrequencyData(freqData);
        freqCtx.fillStyle = '#050508';
        freqCtx.fillRect(0, 0, frequencyCanvas.width, frequencyCanvas.height);

        const barWidth = frequencyCanvas.width / 64;

        for (let i = 0; i < 64; i++) {
          const value = freqData[i * 4];
          const barHeight = (value / 255) * frequencyCanvas.height;
          const hue = (i / 64) * 300;

          freqCtx.fillStyle = `hsl(${hue}, 100%, 50%)`;
          freqCtx.shadowColor = `hsl(${hue}, 100%, 50%)`;
          freqCtx.shadowBlur = 10;
          freqCtx.fillRect(
            i * barWidth,
            frequencyCanvas.height - barHeight,
            barWidth - 2,
            barHeight
          );
        }
      }

      draw();
    }

    // Multiplayer
    const players = {};

    async function initMultiplayer() {
      try {
        const session = await supabaseSession();
        supabase = session.client;

        channel = supabase.channel('synth-collab', {
          config: { presence: { key: playerId } }
        });

        // Track presence
        channel.on('presence', { event: 'sync' }, () => {
          const state = channel.presenceState();
          updatePlayers(state);
        });

        channel.on('presence', { event: 'join' }, ({ key, newPresences }) => {
          addActivity(`Player ${key.slice(0, 4)} joined`);
        });

        channel.on('presence', { event: 'leave' }, ({ key }) => {
          addActivity(`Player ${key.slice(0, 4)} left`);
        });

        // Handle pad events
        channel.on('broadcast', { event: 'pad' }, ({ payload }) => {
          if (payload.player === playerId) return;

          if (payload.action === 'start') {
            playNote(payload.pad, true, payload.player);
          } else {
            stopNote(payload.pad, true, payload.player);
          }
        });

        await channel.subscribe(async (status) => {
          if (status === 'SUBSCRIBED') {
            await channel.track({ color: playerColor, joined: Date.now() });
          }
        });

      } catch (err) {
        console.error('Multiplayer init error:', err);
      }
    }

    function updatePlayers(state) {
      const ids = Object.keys(state);
      document.getElementById('playerCount').textContent =
        `${ids.length} player${ids.length !== 1 ? 's' : ''}`;

      const avatars = document.getElementById('playerAvatars');
      avatars.innerHTML = ids.slice(0, 8).map(id => {
        const p = state[id][0];
        players[id] = { color: p.color };
        return `<div class="player-dot" style="background:${p.color}">${id.slice(0,2).toUpperCase()}</div>`;
      }).join('');
    }

    function addActivity(text) {
      const activity = document.getElementById('activity');
      const item = document.createElement('div');
      item.className = 'activity-item';
      item.innerHTML = `<span>${new Date().toLocaleTimeString()}</span> ${text}`;
      activity.insertBefore(item, activity.firstChild);

      // Keep only last 20
      while (activity.children.length > 20) {
        activity.removeChild(activity.lastChild);
      }
    }

    // Init
    createPadGrid();
    initMultiplayer();

    // Initial visualizer (silent)
    initAudio();
  </script>
</body>
</html>
