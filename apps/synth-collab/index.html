<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Synth Collab - Neon Jam Session</title>
  <meta name="description" content="Collaborative neon synthesizer with shared pads">
  <meta property="og:title" content="Synth Collab">
  <meta property="og:description" content="Real-time collaborative synthesizer with neon visuals">
  <meta property="og:url" content="https://app.sloppy.live/synth-collab">
  <meta property="og:image" content="https://app.sloppy.live/synth-collab/og-image.png">
  <link rel="icon" href="https://emojicdn.elk.sh/üéπ">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      min-height: 100vh;
      background: #050508;
      font-family: 'Orbitron', sans-serif;
      color: #fff;
      overflow-x: hidden;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: 900;
      letter-spacing: 3px;
      background: linear-gradient(135deg, #0ff, #f0f, #ff0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.7rem;
      color: #888;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #0f0;
      box-shadow: 0 0 10px #0f0;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .players {
      display: flex;
      gap: 5px;
    }

    .player-dot {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6rem;
      font-weight: bold;
      color: #000;
    }

    /* Visualizers */
    .visualizers {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .visualizer {
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 15px;
      position: relative;
    }

    .visualizer-label {
      position: absolute;
      top: 10px;
      left: 15px;
      font-size: 0.6rem;
      color: #666;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    .visualizer canvas {
      width: 100%;
      height: 120px;
      display: block;
    }

    /* Controls */
    .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .control-label {
      font-size: 0.6rem;
      color: #888;
      letter-spacing: 1px;
    }

    select, input[type="range"] {
      background: #111;
      border: 1px solid #333;
      color: #0ff;
      font-family: 'Orbitron', sans-serif;
      font-size: 0.7rem;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
    }

    select:focus, input:focus {
      outline: none;
      border-color: #0ff;
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
    }

    input[type="range"] {
      width: 100px;
      height: 6px;
      padding: 0;
      -webkit-appearance: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: linear-gradient(135deg, #0ff, #f0f);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 10px #0ff;
    }

    /* Pad Grid */
    .pad-section {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 16px;
      padding: 25px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .pad-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      max-width: 600px;
      margin: 0 auto;
    }

    .pad {
      aspect-ratio: 1;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: all 0.1s;
      position: relative;
      overflow: hidden;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .pad::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      opacity: 0;
      transition: opacity 0.1s;
    }

    .pad:hover {
      transform: scale(1.02);
    }

    .pad.active {
      transform: scale(0.95);
    }

    .pad.active::before {
      opacity: 1;
    }

    .pad-note {
      font-size: 1.5rem;
      font-weight: 700;
      z-index: 1;
      text-shadow: 0 0 10px currentColor;
    }

    .pad-key {
      font-size: 0.6rem;
      opacity: 0.5;
      margin-top: 5px;
      z-index: 1;
    }

    .pad-player {
      position: absolute;
      bottom: 8px;
      right: 8px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      font-size: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .pad.remote-active .pad-player {
      opacity: 1;
    }

    /* Pad colors */
    .pad[data-color="cyan"] {
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(0, 255, 255, 0.1));
      border: 2px solid rgba(0, 255, 255, 0.4);
      color: #0ff;
    }
    .pad[data-color="cyan"]::before {
      background: radial-gradient(circle, rgba(0, 255, 255, 0.6), transparent);
      box-shadow: 0 0 40px #0ff;
    }

    .pad[data-color="magenta"] {
      background: linear-gradient(135deg, rgba(255, 0, 255, 0.2), rgba(255, 0, 255, 0.1));
      border: 2px solid rgba(255, 0, 255, 0.4);
      color: #f0f;
    }
    .pad[data-color="magenta"]::before {
      background: radial-gradient(circle, rgba(255, 0, 255, 0.6), transparent);
      box-shadow: 0 0 40px #f0f;
    }

    .pad[data-color="yellow"] {
      background: linear-gradient(135deg, rgba(255, 255, 0, 0.2), rgba(255, 255, 0, 0.1));
      border: 2px solid rgba(255, 255, 0, 0.4);
      color: #ff0;
    }
    .pad[data-color="yellow"]::before {
      background: radial-gradient(circle, rgba(255, 255, 0, 0.6), transparent);
      box-shadow: 0 0 40px #ff0;
    }

    .pad[data-color="green"] {
      background: linear-gradient(135deg, rgba(0, 255, 128, 0.2), rgba(0, 255, 128, 0.1));
      border: 2px solid rgba(0, 255, 128, 0.4);
      color: #0f8;
    }
    .pad[data-color="green"]::before {
      background: radial-gradient(circle, rgba(0, 255, 128, 0.6), transparent);
      box-shadow: 0 0 40px #0f8;
    }

    /* Drum Sequencer */
    .sequencer-section {
      margin-top: 20px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(255, 136, 0, 0.2);
    }

    .sequencer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .sequencer-title {
      font-size: 0.8rem;
      color: #f80;
      letter-spacing: 2px;
      text-shadow: 0 0 10px rgba(255, 136, 0, 0.5);
    }

    .sequencer-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .seq-btn {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.7rem;
      padding: 8px 16px;
      background: transparent;
      border: 1px solid #f80;
      color: #f80;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .seq-btn:hover {
      background: rgba(255, 136, 0, 0.2);
    }

    .seq-btn.active {
      background: #f80;
      color: #000;
      box-shadow: 0 0 15px rgba(255, 136, 0, 0.5);
    }

    .bpm-control {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.7rem;
      color: #888;
    }

    .bpm-control input {
      width: 60px;
      background: #111;
      border: 1px solid #333;
      color: #f80;
      padding: 5px 8px;
      font-family: 'Orbitron', sans-serif;
      font-size: 0.8rem;
      text-align: center;
      border-radius: 4px;
    }

    .step-counter {
      font-size: 0.75rem;
      color: #0ff;
      background: rgba(0, 255, 255, 0.1);
      border: 1px solid rgba(0, 255, 255, 0.3);
      padding: 5px 12px;
      border-radius: 4px;
      font-variant-numeric: tabular-nums;
    }

    .step-counter #currentStepDisplay {
      color: #fff;
      font-weight: bold;
      text-shadow: 0 0 10px #0ff;
    }

    /* Chaos Slider */
    .chaos-section {
      margin-top: 15px;
      padding: 15px;
      background: linear-gradient(135deg, rgba(255, 0, 0, 0.1), rgba(255, 0, 255, 0.1));
      border: 1px solid rgba(255, 0, 100, 0.3);
      border-radius: 8px;
    }

    .chaos-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .chaos-title {
      font-size: 0.75rem;
      color: #f06;
      letter-spacing: 2px;
      text-shadow: 0 0 10px rgba(255, 0, 100, 0.5);
    }

    .chaos-hz {
      font-size: 1rem;
      color: #f06;
      font-weight: bold;
      text-shadow: 0 0 15px #f06;
      font-variant-numeric: tabular-nums;
    }

    .chaos-slider-container {
      position: relative;
    }

    #chaosSlider {
      width: 100%;
      height: 30px;
      -webkit-appearance: none;
      background: linear-gradient(90deg, #111, #300, #600, #900, #f06);
      border-radius: 4px;
      cursor: pointer;
    }

    #chaosSlider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 40px;
      background: linear-gradient(135deg, #f06, #f0f);
      border-radius: 4px;
      cursor: grab;
      box-shadow: 0 0 20px #f06, 0 0 40px rgba(255, 0, 100, 0.5);
    }

    #chaosSlider:active::-webkit-slider-thumb {
      cursor: grabbing;
      box-shadow: 0 0 30px #f06, 0 0 60px rgba(255, 0, 100, 0.8);
    }

    .chaos-warning {
      font-size: 0.55rem;
      color: #666;
      margin-top: 8px;
      text-align: center;
    }

    .chaos-section.decaying {
      animation: chaosFlash 0.1s infinite;
    }

    @keyframes chaosFlash {
      0%, 100% { border-color: rgba(255, 0, 100, 0.3); }
      50% { border-color: rgba(255, 0, 100, 0.8); }
    }

    .drum-tracks {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .drum-track {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .track-label {
      width: 60px;
      font-size: 0.65rem;
      color: #888;
      text-align: right;
    }

    .track-label span {
      display: block;
      font-size: 1rem;
    }

    .track-steps {
      display: flex;
      gap: 2px;
      flex: 1;
      overflow-x: auto;
      padding-bottom: 5px;
      scroll-behavior: smooth;
    }

    .track-steps::-webkit-scrollbar {
      height: 4px;
    }

    .track-steps::-webkit-scrollbar-track {
      background: #111;
      border-radius: 2px;
    }

    .track-steps::-webkit-scrollbar-thumb {
      background: #f80;
      border-radius: 2px;
    }

    .step {
      flex: 0 0 16px;
      width: 16px;
      height: 16px;
      border-radius: 2px;
      cursor: pointer;
      transition: all 0.05s;
      position: relative;
    }

    .step::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      right: 2px;
      bottom: 2px;
      border-radius: 2px;
      transition: all 0.1s;
    }

    /* Kick - Orange */
    .drum-track.kick .step {
      background: rgba(255, 136, 0, 0.1);
      border: 1px solid rgba(255, 136, 0, 0.3);
    }
    .drum-track.kick .step.active {
      background: rgba(255, 136, 0, 0.6);
      border-color: #f80;
      box-shadow: 0 0 10px rgba(255, 136, 0, 0.5);
    }
    .drum-track.kick .step.playing {
      box-shadow: 0 0 20px #f80, inset 0 0 20px rgba(255, 255, 255, 0.3);
    }

    /* Snare - Pink */
    .drum-track.snare .step {
      background: rgba(255, 0, 136, 0.1);
      border: 1px solid rgba(255, 0, 136, 0.3);
    }
    .drum-track.snare .step.active {
      background: rgba(255, 0, 136, 0.6);
      border-color: #f08;
      box-shadow: 0 0 10px rgba(255, 0, 136, 0.5);
    }
    .drum-track.snare .step.playing {
      box-shadow: 0 0 20px #f08, inset 0 0 20px rgba(255, 255, 255, 0.3);
    }

    /* Hi-hat - Cyan */
    .drum-track.hihat .step {
      background: rgba(0, 255, 255, 0.1);
      border: 1px solid rgba(0, 255, 255, 0.3);
    }
    .drum-track.hihat .step.active {
      background: rgba(0, 255, 255, 0.6);
      border-color: #0ff;
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
    }
    .drum-track.hihat .step.playing {
      box-shadow: 0 0 20px #0ff, inset 0 0 20px rgba(255, 255, 255, 0.3);
    }

    /* Beat markers - every 16 steps (1 bar) */
    .step:nth-child(16n+1) {
      border-left: 2px solid #f80;
      margin-left: 4px;
    }

    /* Every 4 steps - subtle marker */
    .step:nth-child(4n+1) {
      border-left: 1px solid rgba(255, 136, 0, 0.3);
    }

    .step:nth-child(16n+1)::before {
      content: '';
      position: absolute;
      top: -6px;
      left: 50%;
      transform: translateX(-50%);
      width: 3px;
      height: 3px;
      background: #f80;
      border-radius: 50%;
    }

    /* Activity log */
    .activity {
      margin-top: 20px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      max-height: 80px;
      overflow-y: auto;
    }

    .activity-item {
      font-size: 0.65rem;
      color: #666;
      margin: 4px 0;
    }

    .activity-item span {
      color: #0ff;
    }

    .back-link {
      display: block;
      text-align: center;
      margin-top: 20px;
      color: #333;
      text-decoration: none;
      font-size: 0.65rem;
      letter-spacing: 2px;
    }

    .back-link:hover {
      color: #0ff;
    }

    @media (max-width: 600px) {
      .visualizers {
        grid-template-columns: 1fr;
      }
      .pad-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
      }
      .pad-note { font-size: 1.2rem; }
      h1 { font-size: 1.2rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        <span style="font-size: 1.5rem;">üéπ</span>
        <h1>SYNTH COLLAB</h1>
      </div>
      <div class="status">
        <div class="status-dot"></div>
        <span id="playerCount">1 player</span>
        <div class="players" id="playerAvatars"></div>
      </div>
    </div>

    <div class="visualizers">
      <div class="visualizer">
        <span class="visualizer-label">Waveform</span>
        <canvas id="waveformCanvas"></canvas>
      </div>
      <div class="visualizer">
        <span class="visualizer-label">Frequency</span>
        <canvas id="frequencyCanvas"></canvas>
      </div>
    </div>

    <div class="controls">
      <div class="control-group">
        <span class="control-label">WAVEFORM</span>
        <select id="waveform">
          <option value="sine">Sine</option>
          <option value="square">Square</option>
          <option value="sawtooth" selected>Sawtooth</option>
          <option value="triangle">Triangle</option>
        </select>
      </div>
      <div class="control-group">
        <span class="control-label">ATTACK</span>
        <input type="range" id="attack" min="0" max="500" value="10">
      </div>
      <div class="control-group">
        <span class="control-label">RELEASE</span>
        <input type="range" id="release" min="50" max="2000" value="500">
      </div>
      <div class="control-group">
        <span class="control-label">FILTER</span>
        <input type="range" id="filter" min="100" max="10000" value="5000">
      </div>
      <div class="control-group">
        <span class="control-label">REVERB</span>
        <input type="range" id="reverb" min="0" max="100" value="30">
      </div>
    </div>

    <div class="pad-section">
      <div class="pad-grid" id="padGrid"></div>
    </div>

    <div class="sequencer-section">
      <div class="sequencer-header">
        <div class="sequencer-title">ü•Å DRUM SEQUENCER</div>
        <div class="sequencer-controls">
          <button class="seq-btn" id="playSeqBtn">‚ñ∂ PLAY</button>
          <button class="seq-btn" id="clearSeqBtn">CLEAR</button>
          <div class="bpm-control">
            <span>BPM</span>
            <input type="number" id="bpmInput" value="120" min="60" max="256">
          </div>
          <div class="step-counter" id="stepCounter">
            <span id="currentStepDisplay">0</span>/<span id="totalStepsDisplay">1024</span>
          </div>
        </div>
      </div>
      <div class="drum-tracks">
        <div class="drum-track kick" data-drum="kick">
          <div class="track-label"><span>üîä</span>KICK</div>
          <div class="track-steps" id="kickSteps"></div>
        </div>
        <div class="drum-track snare" data-drum="snare">
          <div class="track-label"><span>ü•Å</span>SNARE</div>
          <div class="track-steps" id="snareSteps"></div>
        </div>
        <div class="drum-track hihat" data-drum="hihat">
          <div class="track-label"><span>üé©</span>HI-HAT</div>
          <div class="track-steps" id="hihatSteps"></div>
        </div>
      </div>

      <div class="chaos-section" id="chaosSection">
        <div class="chaos-header">
          <div class="chaos-title">üåÄ CHAOS MODE</div>
          <div class="chaos-hz"><span id="chaosHzDisplay">0</span> Hz</div>
        </div>
        <div class="chaos-slider-container">
          <input type="range" id="chaosSlider" min="0" max="100" value="0">
        </div>
        <div class="chaos-warning">DRAG TO ACCELERATE ‚Ä¢ RELEASE TO DECAY INTO SILENCE</div>
      </div>
    </div>

    <div class="activity" id="activity">
      <div class="activity-item">üéπ Session started. Tap pads or use keyboard!</div>
    </div>

    <a href="https://sloppy.live" class="back-link">SLOPPY.LIVE</a>
  </div>

  <script type="module">
    import { supabaseSession } from '/supabase-config.js';

    // Audio context
    let audioCtx = null;
    let analyser = null;
    let filter = null;
    let convolver = null;
    let masterGain = null;
    const activeOscillators = {};

    // Pad configuration
    const pads = [
      { note: 'C4', freq: 261.63, key: '1', color: 'cyan' },
      { note: 'D4', freq: 293.66, key: '2', color: 'cyan' },
      { note: 'E4', freq: 329.63, key: '3', color: 'cyan' },
      { note: 'F4', freq: 349.23, key: '4', color: 'cyan' },
      { note: 'G4', freq: 392.00, key: 'q', color: 'magenta' },
      { note: 'A4', freq: 440.00, key: 'w', color: 'magenta' },
      { note: 'B4', freq: 493.88, key: 'e', color: 'magenta' },
      { note: 'C5', freq: 523.25, key: 'r', color: 'magenta' },
      { note: 'D5', freq: 587.33, key: 'a', color: 'yellow' },
      { note: 'E5', freq: 659.25, key: 's', color: 'yellow' },
      { note: 'F5', freq: 698.46, key: 'd', color: 'yellow' },
      { note: 'G5', freq: 783.99, key: 'f', color: 'yellow' },
      { note: 'A5', freq: 880.00, key: 'z', color: 'green' },
      { note: 'B5', freq: 987.77, key: 'x', color: 'green' },
      { note: 'C6', freq: 1046.50, key: 'c', color: 'green' },
      { note: 'D6', freq: 1174.66, key: 'v', color: 'green' }
    ];

    // Player info
    let playerId = Math.random().toString(36).substr(2, 6);
    let playerColor = `hsl(${Math.random() * 360}, 80%, 60%)`;
    let supabase = null;
    let channel = null;

    // Initialize audio
    function initAudio() {
      if (audioCtx) return;

      audioCtx = new (window.AudioContext || window.webkitAudioContext)();

      // Create nodes
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;

      filter = audioCtx.createBiquadFilter();
      filter.type = 'lowpass';
      filter.frequency.value = 5000;

      masterGain = audioCtx.createGain();
      masterGain.gain.value = 0.5;

      // Simple reverb using delay
      convolver = audioCtx.createDelay();
      convolver.delayTime.value = 0.1;
      const reverbGain = audioCtx.createGain();
      reverbGain.gain.value = 0.3;

      // Connect nodes
      filter.connect(masterGain);
      masterGain.connect(analyser);
      analyser.connect(audioCtx.destination);

      // Reverb path
      masterGain.connect(convolver);
      convolver.connect(reverbGain);
      reverbGain.connect(audioCtx.destination);

      startVisualizers();
    }

    // Play note
    function playNote(padIndex, remote = false, remotePlayer = null) {
      initAudio();

      const pad = pads[padIndex];
      const id = `${padIndex}-${remote ? remotePlayer : 'local'}`;

      if (activeOscillators[id]) return;

      const waveform = document.getElementById('waveform').value;
      const attackTime = document.getElementById('attack').value / 1000;

      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      osc.type = waveform;
      osc.frequency.value = pad.freq;

      gain.gain.setValueAtTime(0, audioCtx.currentTime);
      gain.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + attackTime);

      osc.connect(gain);
      gain.connect(filter);

      osc.start();
      activeOscillators[id] = { osc, gain };

      // Visual feedback
      const padEl = document.querySelector(`[data-index="${padIndex}"]`);
      if (padEl) {
        if (remote) {
          padEl.classList.add('remote-active');
          const playerDot = padEl.querySelector('.pad-player');
          if (playerDot) {
            playerDot.style.background = players[remotePlayer]?.color || '#fff';
          }
        } else {
          padEl.classList.add('active');
        }
      }

      // Broadcast if local
      if (!remote && channel) {
        channel.send({
          type: 'broadcast',
          event: 'pad',
          payload: { action: 'start', pad: padIndex, player: playerId }
        });
      }
    }

    // Stop note
    function stopNote(padIndex, remote = false, remotePlayer = null) {
      const id = `${padIndex}-${remote ? remotePlayer : 'local'}`;
      const active = activeOscillators[id];

      if (!active) return;

      const releaseTime = document.getElementById('release').value / 1000;

      active.gain.gain.cancelScheduledValues(audioCtx.currentTime);
      active.gain.gain.setValueAtTime(active.gain.gain.value, audioCtx.currentTime);
      active.gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + releaseTime);

      setTimeout(() => {
        active.osc.stop();
        active.osc.disconnect();
        active.gain.disconnect();
      }, releaseTime * 1000 + 50);

      delete activeOscillators[id];

      // Visual feedback
      const padEl = document.querySelector(`[data-index="${padIndex}"]`);
      if (padEl) {
        padEl.classList.remove(remote ? 'remote-active' : 'active');
      }

      // Broadcast if local
      if (!remote && channel) {
        channel.send({
          type: 'broadcast',
          event: 'pad',
          payload: { action: 'stop', pad: padIndex, player: playerId }
        });
      }
    }

    // Create pad grid
    function createPadGrid() {
      const grid = document.getElementById('padGrid');

      pads.forEach((pad, index) => {
        const el = document.createElement('div');
        el.className = 'pad';
        el.dataset.index = index;
        el.dataset.color = pad.color;
        el.innerHTML = `
          <span class="pad-note">${pad.note}</span>
          <span class="pad-key">${pad.key.toUpperCase()}</span>
          <div class="pad-player"></div>
        `;

        // Mouse events
        el.addEventListener('mousedown', (e) => {
          e.preventDefault();
          playNote(index);
        });
        el.addEventListener('mouseup', () => stopNote(index));
        el.addEventListener('mouseleave', () => stopNote(index));

        // Touch events
        el.addEventListener('touchstart', (e) => {
          e.preventDefault();
          playNote(index);
        });
        el.addEventListener('touchend', () => stopNote(index));

        grid.appendChild(el);
      });
    }

    // Keyboard input
    const keyMap = {};
    pads.forEach((pad, index) => {
      keyMap[pad.key.toLowerCase()] = index;
    });

    document.addEventListener('keydown', (e) => {
      if (e.repeat) return;
      const index = keyMap[e.key.toLowerCase()];
      if (index !== undefined) {
        playNote(index);
      }
    });

    document.addEventListener('keyup', (e) => {
      const index = keyMap[e.key.toLowerCase()];
      if (index !== undefined) {
        stopNote(index);
      }
    });

    // Filter control
    document.getElementById('filter').addEventListener('input', (e) => {
      if (filter) filter.frequency.value = e.target.value;
    });

    // Visualizers
    function startVisualizers() {
      const waveformCanvas = document.getElementById('waveformCanvas');
      const frequencyCanvas = document.getElementById('frequencyCanvas');
      const waveCtx = waveformCanvas.getContext('2d');
      const freqCtx = frequencyCanvas.getContext('2d');

      function resize() {
        [waveformCanvas, frequencyCanvas].forEach(c => {
          c.width = c.offsetWidth * 2;
          c.height = c.offsetHeight * 2;
        });
      }
      resize();
      window.addEventListener('resize', resize);

      const bufferLength = analyser.frequencyBinCount;
      const timeData = new Uint8Array(bufferLength);
      const freqData = new Uint8Array(bufferLength);

      function draw() {
        requestAnimationFrame(draw);

        // Waveform
        analyser.getByteTimeDomainData(timeData);
        waveCtx.fillStyle = '#050508';
        waveCtx.fillRect(0, 0, waveformCanvas.width, waveformCanvas.height);

        waveCtx.lineWidth = 2;
        waveCtx.strokeStyle = '#0ff';
        waveCtx.shadowColor = '#0ff';
        waveCtx.shadowBlur = 10;
        waveCtx.beginPath();

        const sliceWidth = waveformCanvas.width / bufferLength;
        let x = 0;

        for (let i = 0; i < bufferLength; i++) {
          const v = timeData[i] / 128.0;
          const y = v * waveformCanvas.height / 2;

          if (i === 0) waveCtx.moveTo(x, y);
          else waveCtx.lineTo(x, y);

          x += sliceWidth;
        }

        waveCtx.lineTo(waveformCanvas.width, waveformCanvas.height / 2);
        waveCtx.stroke();

        // Frequency
        analyser.getByteFrequencyData(freqData);
        freqCtx.fillStyle = '#050508';
        freqCtx.fillRect(0, 0, frequencyCanvas.width, frequencyCanvas.height);

        const barWidth = frequencyCanvas.width / 64;

        for (let i = 0; i < 64; i++) {
          const value = freqData[i * 4];
          const barHeight = (value / 255) * frequencyCanvas.height;
          const hue = (i / 64) * 300;

          freqCtx.fillStyle = `hsl(${hue}, 100%, 50%)`;
          freqCtx.shadowColor = `hsl(${hue}, 100%, 50%)`;
          freqCtx.shadowBlur = 10;
          freqCtx.fillRect(
            i * barWidth,
            frequencyCanvas.height - barHeight,
            barWidth - 2,
            barHeight
          );
        }
      }

      draw();
    }

    // Multiplayer
    const players = {};

    async function initMultiplayer() {
      try {
        const session = await supabaseSession();
        supabase = session.client;

        channel = supabase.channel('synth-collab', {
          config: { presence: { key: playerId } }
        });

        // Track presence
        channel.on('presence', { event: 'sync' }, () => {
          const state = channel.presenceState();
          updatePlayers(state);
        });

        channel.on('presence', { event: 'join' }, ({ key, newPresences }) => {
          addActivity(`Player ${key.slice(0, 4)} joined`);
        });

        channel.on('presence', { event: 'leave' }, ({ key }) => {
          addActivity(`Player ${key.slice(0, 4)} left`);
        });

        // Handle pad events
        channel.on('broadcast', { event: 'pad' }, ({ payload }) => {
          if (payload.player === playerId) return;

          if (payload.action === 'start') {
            playNote(payload.pad, true, payload.player);
          } else {
            stopNote(payload.pad, true, payload.player);
          }
        });

        await channel.subscribe(async (status) => {
          if (status === 'SUBSCRIBED') {
            await channel.track({ color: playerColor, joined: Date.now() });
          }
        });

      } catch (err) {
        console.error('Multiplayer init error:', err);
      }
    }

    function updatePlayers(state) {
      const ids = Object.keys(state);
      document.getElementById('playerCount').textContent =
        `${ids.length} player${ids.length !== 1 ? 's' : ''}`;

      const avatars = document.getElementById('playerAvatars');
      avatars.innerHTML = ids.slice(0, 8).map(id => {
        const p = state[id][0];
        players[id] = { color: p.color };
        return `<div class="player-dot" style="background:${p.color}">${id.slice(0,2).toUpperCase()}</div>`;
      }).join('');
    }

    function addActivity(text) {
      const activity = document.getElementById('activity');
      const item = document.createElement('div');
      item.className = 'activity-item';
      item.innerHTML = `<span>${new Date().toLocaleTimeString()}</span> ${text}`;
      activity.insertBefore(item, activity.firstChild);

      // Keep only last 20
      while (activity.children.length > 20) {
        activity.removeChild(activity.lastChild);
      }
    }

    // ==================
    // DRUM SEQUENCER
    // ==================

    const STEPS = 1024;
    let seqPlaying = false;
    let currentStep = 0;
    let seqInterval = null;
    let bpm = 120;

    const patterns = {
      kick: new Array(STEPS).fill(false),
      snare: new Array(STEPS).fill(false),
      hihat: new Array(STEPS).fill(false)
    };

    // Create step buttons
    function createSequencer() {
      ['kick', 'snare', 'hihat'].forEach(drum => {
        const container = document.getElementById(`${drum}Steps`);
        for (let i = 0; i < STEPS; i++) {
          const step = document.createElement('div');
          step.className = 'step';
          step.dataset.step = i;
          step.dataset.drum = drum;

          step.addEventListener('click', () => {
            patterns[drum][i] = !patterns[drum][i];
            step.classList.toggle('active', patterns[drum][i]);

            // Broadcast pattern change
            if (channel) {
              channel.send({
                type: 'broadcast',
                event: 'pattern',
                payload: { drum, step: i, active: patterns[drum][i], player: playerId }
              });
            }
          });

          container.appendChild(step);
        }
      });
    }

    // Drum synthesis
    function playKick() {
      initAudio();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      osc.type = 'sine';
      osc.frequency.setValueAtTime(150, audioCtx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(30, audioCtx.currentTime + 0.1);

      gain.gain.setValueAtTime(1, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);

      osc.connect(gain);
      gain.connect(masterGain);

      osc.start();
      osc.stop(audioCtx.currentTime + 0.3);
    }

    function playSnare() {
      initAudio();

      // Noise for snare
      const bufferSize = audioCtx.sampleRate * 0.2;
      const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
      const data = buffer.getChannelData(0);
      for (let i = 0; i < bufferSize; i++) {
        data[i] = Math.random() * 2 - 1;
      }

      const noise = audioCtx.createBufferSource();
      noise.buffer = buffer;

      const noiseFilter = audioCtx.createBiquadFilter();
      noiseFilter.type = 'highpass';
      noiseFilter.frequency.value = 1000;

      const noiseGain = audioCtx.createGain();
      noiseGain.gain.setValueAtTime(0.8, audioCtx.currentTime);
      noiseGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);

      noise.connect(noiseFilter);
      noiseFilter.connect(noiseGain);
      noiseGain.connect(masterGain);

      // Tone for body
      const osc = audioCtx.createOscillator();
      const oscGain = audioCtx.createGain();
      osc.type = 'triangle';
      osc.frequency.value = 180;
      oscGain.gain.setValueAtTime(0.5, audioCtx.currentTime);
      oscGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);

      osc.connect(oscGain);
      oscGain.connect(masterGain);

      noise.start();
      osc.start();
      osc.stop(audioCtx.currentTime + 0.1);
    }

    function playHihat() {
      initAudio();

      const bufferSize = audioCtx.sampleRate * 0.05;
      const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
      const data = buffer.getChannelData(0);
      for (let i = 0; i < bufferSize; i++) {
        data[i] = Math.random() * 2 - 1;
      }

      const noise = audioCtx.createBufferSource();
      noise.buffer = buffer;

      const hihatFilter = audioCtx.createBiquadFilter();
      hihatFilter.type = 'highpass';
      hihatFilter.frequency.value = 7000;

      const gain = audioCtx.createGain();
      gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);

      noise.connect(hihatFilter);
      hihatFilter.connect(gain);
      gain.connect(masterGain);

      noise.start();
    }

    // Sequencer playback
    function startSequencer() {
      if (seqPlaying) return;
      seqPlaying = true;
      currentStep = 0;

      document.getElementById('playSeqBtn').textContent = '‚è∏ STOP';
      document.getElementById('playSeqBtn').classList.add('active');

      const stepTime = (60 / bpm / 4) * 1000; // 16th notes

      seqInterval = setInterval(() => {
        // Clear previous step highlight
        document.querySelectorAll('.step.playing').forEach(s => s.classList.remove('playing'));

        // Highlight current step
        const currentSteps = document.querySelectorAll(`.step[data-step="${currentStep}"]`);
        currentSteps.forEach(s => {
          s.classList.add('playing');
        });

        // Auto-scroll to keep current step visible
        if (currentSteps.length > 0) {
          const firstStep = currentSteps[0];
          const container = firstStep.parentElement;
          const stepLeft = firstStep.offsetLeft;
          const containerWidth = container.offsetWidth;
          const scrollLeft = container.scrollLeft;

          // Scroll if step is outside visible area
          if (stepLeft < scrollLeft || stepLeft > scrollLeft + containerWidth - 20) {
            container.scrollLeft = stepLeft - 50;
          }
        }

        // Update step counter
        document.getElementById('currentStepDisplay').textContent = currentStep + 1;

        // Play sounds
        if (patterns.kick[currentStep]) playKick();
        if (patterns.snare[currentStep]) playSnare();
        if (patterns.hihat[currentStep]) playHihat();

        currentStep = (currentStep + 1) % STEPS;
      }, stepTime);
    }

    function stopSequencer() {
      seqPlaying = false;
      clearInterval(seqInterval);

      document.getElementById('playSeqBtn').textContent = '‚ñ∂ PLAY';
      document.getElementById('playSeqBtn').classList.remove('active');
      document.querySelectorAll('.step.playing').forEach(s => s.classList.remove('playing'));
      document.getElementById('currentStepDisplay').textContent = '0';
      currentStep = 0;
    }

    function toggleSequencer() {
      seqPlaying ? stopSequencer() : startSequencer();
    }

    function clearPattern() {
      ['kick', 'snare', 'hihat'].forEach(drum => {
        patterns[drum].fill(false);
        document.querySelectorAll(`.drum-track.${drum} .step`).forEach(s => {
          s.classList.remove('active');
        });
      });
    }

    // Sequencer controls
    document.getElementById('playSeqBtn').addEventListener('click', toggleSequencer);
    document.getElementById('clearSeqBtn').addEventListener('click', clearPattern);
    document.getElementById('bpmInput').addEventListener('change', (e) => {
      bpm = Math.max(60, Math.min(256, parseInt(e.target.value) || 120));
      e.target.value = bpm;
      if (seqPlaying) {
        stopSequencer();
        startSequencer();
      }
    });

    // Handle remote pattern changes
    function handlePatternBroadcast(payload) {
      if (payload.player === playerId) return;

      patterns[payload.drum][payload.step] = payload.active;
      const step = document.querySelector(`.drum-track.${payload.drum} .step[data-step="${payload.step}"]`);
      if (step) {
        step.classList.toggle('active', payload.active);
      }
    }

    // Add pattern broadcast handler to multiplayer init
    const originalInitMultiplayer = initMultiplayer;
    initMultiplayer = async function() {
      await originalInitMultiplayer();

      if (channel) {
        channel.on('broadcast', { event: 'pattern' }, ({ payload }) => {
          handlePatternBroadcast(payload);
        });
      }
    };

    // Init
    createPadGrid();
    createSequencer();
    initMultiplayer();

    // Initial visualizer (silent)
    initAudio();

    // Set default beat pattern for our Russian friend! üá∑üá∫
    // Classic four-on-the-floor
    [0, 4, 8, 12].forEach(i => {
      patterns.kick[i] = true;
      document.querySelector(`.drum-track.kick .step[data-step="${i}"]`)?.classList.add('active');
    });
    [4, 12].forEach(i => {
      patterns.snare[i] = true;
      document.querySelector(`.drum-track.snare .step[data-step="${i}"]`)?.classList.add('active');
    });
    [0, 2, 4, 6, 8, 10, 12, 14].forEach(i => {
      patterns.hihat[i] = true;
      document.querySelector(`.drum-track.hihat .step[data-step="${i}"]`)?.classList.add('active');
    });

    // ==================
    // CHAOS MODE
    // ==================

    let chaosActive = false;
    let chaosHz = 0;
    let chaosDecaying = false;
    let lastChaosTime = 0;
    let chaosAccumulator = 0;

    const chaosSlider = document.getElementById('chaosSlider');
    const chaosHzDisplay = document.getElementById('chaosHzDisplay');
    const chaosSection = document.getElementById('chaosSection');

    // Convert slider (0-100) to Hz (0-1024) exponentially
    function sliderToHz(value) {
      if (value === 0) return 0;
      // Exponential curve: 1 Hz at 1%, 1024 Hz at 100%
      return Math.pow(2, value / 10);
    }

    // Chaos tick - fires drum sounds at the chaos rate
    function chaosTick(timestamp) {
      if (!chaosActive && !chaosDecaying) return;

      initAudio();

      if (!lastChaosTime) lastChaosTime = timestamp;
      const delta = timestamp - lastChaosTime;
      lastChaosTime = timestamp;

      if (chaosHz > 0) {
        // Calculate how many "ticks" should have happened
        chaosAccumulator += (chaosHz * delta) / 1000;

        while (chaosAccumulator >= 1) {
          chaosAccumulator -= 1;

          // Play all active drums at chaos rate
          // At high speeds this creates pitched tones!
          if (patterns.kick.some(v => v)) playKick();
          if (patterns.snare.some(v => v)) playSnare();
          if (patterns.hihat.some(v => v)) playHihat();
        }
      }

      // Handle decay
      if (chaosDecaying) {
        chaosHz *= 0.985; // Exponential decay
        if (chaosHz < 0.5) {
          chaosHz = 0;
          chaosDecaying = false;
          chaosSection.classList.remove('decaying');
        }
        chaosHzDisplay.textContent = Math.round(chaosHz);
        chaosSlider.value = chaosHz > 0 ? Math.log2(chaosHz) * 10 : 0;
      }

      if (chaosActive || chaosDecaying) {
        requestAnimationFrame(chaosTick);
      }
    }

    // Chaos slider events
    chaosSlider.addEventListener('input', (e) => {
      initAudio();
      const value = parseInt(e.target.value);
      chaosHz = sliderToHz(value);
      chaosHzDisplay.textContent = Math.round(chaosHz);

      if (!chaosActive && chaosHz > 0) {
        chaosActive = true;
        chaosDecaying = false;
        lastChaosTime = 0;
        chaosAccumulator = 0;
        chaosSection.classList.remove('decaying');
        requestAnimationFrame(chaosTick);
      }
    });

    // On release - trigger decay
    chaosSlider.addEventListener('mouseup', triggerChaosDecay);
    chaosSlider.addEventListener('touchend', triggerChaosDecay);

    function triggerChaosDecay() {
      if (chaosHz > 0) {
        chaosActive = false;
        chaosDecaying = true;
        chaosSection.classList.add('decaying');
        lastChaosTime = 0;
        requestAnimationFrame(chaosTick);
      }
    }

    // Reset if slider goes to 0
    chaosSlider.addEventListener('change', () => {
      if (parseInt(chaosSlider.value) === 0) {
        chaosActive = false;
        chaosDecaying = false;
        chaosHz = 0;
        chaosSection.classList.remove('decaying');
      }
    });

  </script>
<script src="/sloppy-header/sloppy-bar.js"></script>
</body>
</html>
