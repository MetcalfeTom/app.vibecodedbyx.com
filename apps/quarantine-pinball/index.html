<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Cannonball Pinball - Iron & Powder</title>
  <link rel="icon" href="https://emojicdn.elk.sh/ðŸ’£">
  <meta property="og:title" content="Cannonball Pinball">
  <meta property="og:description" content="Heavy iron shots bouncing off oak railings and gunpowder barrels!">
  <meta property="og:url" content="https://app.sloppy.live/quarantine-pinball">
  <meta property="og:image" content="https://app.sloppy.live/quarantine-pinball/og-image.png">
  <link href="https://fonts.googleapis.com/css2?family=Pirata+One&family=IM+Fell+English+SC&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #0a0806;
      overflow: hidden;
      font-family: 'IM Fell English SC', serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      touch-action: none;
    }
    #game-container {
      position: relative;
      max-width: 500px;
      width: 100%;
    }
    canvas {
      display: block;
      width: 100%;
      border: 6px solid #4a3520;
      border-radius: 8px;
      box-shadow: 0 0 40px rgba(74, 53, 32, 0.6), inset 0 0 60px rgba(30, 20, 10, 0.8);
    }
    #ui {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      display: flex;
      justify-content: space-between;
      pointer-events: none;
      z-index: 10;
    }
    .score-box {
      background: rgba(20, 12, 8, 0.95);
      border: 3px solid #5c3a1e;
      border-radius: 5px;
      padding: 8px 15px;
      color: #c9a227;
      text-shadow: 0 0 8px rgba(201, 162, 39, 0.4);
    }
    .score-label {
      font-size: 10px;
      opacity: 0.7;
      font-family: 'Pirata One', cursive;
      letter-spacing: 1px;
    }
    .score-value {
      font-size: 24px;
      font-family: 'Pirata One', cursive;
    }
    #lives {
      color: #8b4513;
      text-shadow: 0 0 10px rgba(139, 69, 19, 0.5);
    }
    #message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #c9a227;
      text-shadow: 2px 2px 0 #1a0f0a, 0 0 20px rgba(201, 162, 39, 0.5);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 20;
    }
    #message.show { opacity: 1; }
    #message h2 {
      font-size: 32px;
      margin-bottom: 10px;
      font-family: 'Pirata One', cursive;
    }
    #message p {
      font-size: 14px;
    }
    #start-btn {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, #5c3a1e, #8b5a2b);
      border: 4px solid #3d2512;
      color: #c9a227;
      padding: 15px 40px;
      font-family: 'Pirata One', cursive;
      font-size: 20px;
      cursor: pointer;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.7);
      transition: all 0.3s;
      z-index: 30;
    }
    #start-btn:hover {
      transform: translate(-50%, -50%) scale(1.05);
      box-shadow: 0 6px 30px rgba(139, 69, 19, 0.5);
    }
    #controls-hint {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      color: #5c4a3a;
      font-size: 11px;
      pointer-events: none;
    }
    #backlink {
      position: fixed;
      bottom: 10px;
      right: 10px;
      color: #5c4a3a;
      text-decoration: none;
      font-size: 12px;
      opacity: 0.5;
      z-index: 100;
    }
    #mobile-controls {
      display: none;
      position: absolute;
      bottom: 60px;
      left: 0;
      right: 0;
      justify-content: space-between;
      padding: 0 10px;
      z-index: 20;
    }
    .flipper-btn {
      width: 80px;
      height: 60px;
      background: rgba(92, 58, 30, 0.4);
      border: 3px solid #8b5a2b;
      border-radius: 8px;
      color: #c9a227;
      font-size: 24px;
      font-family: 'Pirata One', cursive;
    }
    .flipper-btn:active {
      background: rgba(139, 90, 43, 0.5);
    }
    @media (max-width: 600px) {
      #mobile-controls { display: flex; }
      #controls-hint { display: none; }
    }
  </style>
</head>
<body>
  <div id="game-container">
    <canvas id="game"></canvas>
    <div id="ui">
      <div class="score-box">
        <div class="score-label">PLUNDER</div>
        <div class="score-value" id="score">0</div>
      </div>
      <div class="score-box">
        <div class="score-label">IRON SHOTS</div>
        <div class="score-value" id="lives">âš«âš«âš«</div>
      </div>
    </div>
    <div id="message">
      <h2>FIRE IN THE HOLD!</h2>
      <p>Press SPACE or tap to launch cannonball</p>
    </div>
    <button id="start-btn">LOAD CANNONS!</button>
    <div id="controls-hint">A/LEFT = Port Plank â€¢ D/RIGHT = Starboard Plank â€¢ SPACE = Fire</div>
    <div id="mobile-controls">
      <button class="flipper-btn" id="left-btn">â—€</button>
      <button class="flipper-btn" id="right-btn">â–¶</button>
    </div>
  </div>
  <a id="backlink" href="https://sloppy.live">sloppy.live</a>

  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    const W = 500;
    const H = 700;
    canvas.width = W;
    canvas.height = H;

    let gameStarted = false;
    let score = 0;
    let lives = 3;
    let balls = [];
    let particles = [];
    let sparks = [];
    let smokeTrails = [];

    // Oak plank flippers
    const flippers = {
      left: {
        x: 150, y: 620, length: 75,
        angle: 0.4, targetAngle: 0.4, restAngle: 0.4, activeAngle: -0.6
      },
      right: {
        x: 350, y: 620, length: 75,
        angle: Math.PI - 0.4, targetAngle: Math.PI - 0.4,
        restAngle: Math.PI - 0.4, activeAngle: Math.PI + 0.6
      }
    };

    // Gunpowder barrels as bumpers
    const barrels = [
      { x: 150, y: 200, radius: 38, points: 150, fuse: Math.random() * Math.PI * 2 },
      { x: 350, y: 200, radius: 38, points: 150, fuse: Math.random() * Math.PI * 2 },
      { x: 250, y: 290, radius: 45, points: 200, fuse: Math.random() * Math.PI * 2 },
      { x: 120, y: 380, radius: 30, points: 100, fuse: Math.random() * Math.PI * 2 },
      { x: 380, y: 380, radius: 30, points: 100, fuse: Math.random() * Math.PI * 2 },
      { x: 250, y: 450, radius: 32, points: 125, fuse: Math.random() * Math.PI * 2 }
    ];

    // Gold coin targets
    const targets = [];
    for (let i = 0; i < 5; i++) {
      targets.push({
        x: 100 + i * 75, y: 120, width: 35, height: 18,
        hit: false, rotation: 0
      });
    }

    // Iron anchor obstacles
    const anchors = [
      { x: 80, y: 500 },
      { x: 420, y: 500 }
    ];

    const launcher = { x: 475, y: 600, power: 0, charging: false };

    const keys = {};
    window.addEventListener('keydown', e => {
      keys[e.code] = true;
      if (e.code === 'Space') e.preventDefault();
    });
    window.addEventListener('keyup', e => {
      keys[e.code] = false;
      if (e.code === 'Space' && launcher.charging) launchBall();
    });

    document.getElementById('left-btn').addEventListener('touchstart', e => { e.preventDefault(); keys['KeyA'] = true; });
    document.getElementById('left-btn').addEventListener('touchend', e => { e.preventDefault(); keys['KeyA'] = false; });
    document.getElementById('right-btn').addEventListener('touchstart', e => { e.preventDefault(); keys['KeyD'] = true; });
    document.getElementById('right-btn').addEventListener('touchend', e => { e.preventDefault(); keys['KeyD'] = false; });

    canvas.addEventListener('touchstart', e => {
      if (!gameStarted) return;
      const rect = canvas.getBoundingClientRect();
      const x = (e.touches[0].clientX - rect.left) / rect.width * W;
      if (x > W * 0.8) launcher.charging = true;
    });

    canvas.addEventListener('touchend', e => {
      if (launcher.charging) launchBall();
    });

    document.getElementById('start-btn').addEventListener('click', startGame);

    function startGame() {
      document.getElementById('start-btn').style.display = 'none';
      gameStarted = true;
      score = 0;
      lives = 3;
      balls = [];
      targets.forEach(t => t.hit = false);
      spawnBall();
      updateUI();
    }

    function spawnBall() {
      balls.push({
        x: launcher.x, y: launcher.y - 20,
        vx: 0, vy: 0, radius: 14,
        launched: false, rotation: 0, weight: 1.2
      });
    }

    function launchBall() {
      launcher.charging = false;
      const power = Math.max(18, launcher.power * 0.35);
      balls.forEach(ball => {
        if (!ball.launched) {
          ball.vy = -power;
          ball.vx = -3 + Math.random() * -2;
          ball.launched = true;
          createSparks(ball.x, ball.y + 20, 8);
        }
      });
      launcher.power = 0;
    }

    function createParticles(x, y, color, count = 10) {
      for (let i = 0; i < count; i++) {
        const angle = Math.random() * Math.PI * 2;
        const speed = 3 + Math.random() * 5;
        particles.push({
          x, y, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed,
          life: 1, color, size: 3 + Math.random() * 5, type: 'dust'
        });
      }
    }

    function createSparks(x, y, count = 5) {
      for (let i = 0; i < count; i++) {
        const angle = -Math.PI/2 + (Math.random() - 0.5) * Math.PI;
        const speed = 4 + Math.random() * 6;
        sparks.push({
          x, y, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed,
          life: 1, size: 2 + Math.random() * 3
        });
      }
    }

    function createExplosion(x, y) {
      // Fire particles
      for (let i = 0; i < 20; i++) {
        const angle = Math.random() * Math.PI * 2;
        const speed = 5 + Math.random() * 8;
        particles.push({
          x, y, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed,
          life: 1, color: `hsl(${20 + Math.random() * 30}, 100%, ${50 + Math.random() * 30}%)`,
          size: 5 + Math.random() * 8, type: 'fire'
        });
      }
      // Smoke
      for (let i = 0; i < 8; i++) {
        const angle = Math.random() * Math.PI * 2;
        const speed = 2 + Math.random() * 3;
        particles.push({
          x, y, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed - 2,
          life: 1.5, color: '#555', size: 10 + Math.random() * 15, type: 'smoke'
        });
      }
    }

    function addSmokeTrail(x, y) {
      if (Math.random() > 0.3) return;
      smokeTrails.push({
        x, y, life: 1, size: 4 + Math.random() * 4
      });
    }

    function update() {
      if (!gameStarted) return;

      // Flipper physics
      flippers.left.targetAngle = keys['KeyA'] || keys['ArrowLeft'] ? flippers.left.activeAngle : flippers.left.restAngle;
      flippers.right.targetAngle = keys['KeyD'] || keys['ArrowRight'] ? flippers.right.activeAngle : flippers.right.restAngle;

      flippers.left.angle += (flippers.left.targetAngle - flippers.left.angle) * 0.35;
      flippers.right.angle += (flippers.right.targetAngle - flippers.right.angle) * 0.35;

      // Launcher charging
      if (keys['Space'] && balls.some(b => !b.launched)) {
        launcher.charging = true;
        launcher.power = Math.min(100, launcher.power + 2.5);
      }

      // Ball physics - heavier feel
      balls.forEach(ball => {
        if (!ball.launched) return;

        // Heavier gravity for iron ball
        ball.vy += 0.32 * ball.weight;
        ball.x += ball.vx;
        ball.y += ball.vy;
        ball.rotation += ball.vx * 0.04;

        // Smoke trail when moving fast
        const speed = Math.sqrt(ball.vx * ball.vx + ball.vy * ball.vy);
        if (speed > 8) addSmokeTrail(ball.x, ball.y);

        // Oak railing walls - bouncier wood
        if (ball.x < ball.radius + 25) {
          ball.x = ball.radius + 25;
          ball.vx *= -0.75;
          createParticles(ball.x, ball.y, '#8b6914', 5);
        }
        if (ball.x > W - ball.radius - 25) {
          ball.x = W - ball.radius - 25;
          ball.vx *= -0.75;
          createParticles(ball.x, ball.y, '#8b6914', 5);
        }
        if (ball.y < ball.radius + 25) {
          ball.y = ball.radius + 25;
          ball.vy *= -0.75;
          createParticles(ball.x, ball.y, '#8b6914', 5);
        }

        // Gunpowder barrel collisions
        barrels.forEach(barrel => {
          const dx = ball.x - barrel.x;
          const dy = ball.y - barrel.y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          const minDist = ball.radius + barrel.radius;

          if (dist < minDist) {
            const angle = Math.atan2(dy, dx);
            const force = 14;
            ball.vx = Math.cos(angle) * force;
            ball.vy = Math.sin(angle) * force;
            ball.x = barrel.x + Math.cos(angle) * minDist;
            ball.y = barrel.y + Math.sin(angle) * minDist;

            score += barrel.points;
            createExplosion(barrel.x, barrel.y);
            barrel.flash = 1;
            barrel.shake = 1;
          }
        });

        // Gold coin targets
        targets.forEach(target => {
          if (target.hit) return;
          if (ball.x > target.x - target.width/2 && ball.x < target.x + target.width/2 &&
              ball.y > target.y - target.height/2 && ball.y < target.y + target.height/2) {
            target.hit = true;
            ball.vy *= -1;
            score += 250;
            createParticles(target.x, target.y, '#ffd700', 15);
            createSparks(target.x, target.y, 10);

            if (targets.every(t => t.hit)) {
              targets.forEach(t => t.hit = false);
              score += 2000;
              createExplosion(W/2, 120);
            }
          }
        });

        // Anchor obstacles
        anchors.forEach(anchor => {
          const dx = ball.x - anchor.x;
          const dy = ball.y - anchor.y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist < ball.radius + 25) {
            const angle = Math.atan2(dy, dx);
            ball.vx = Math.cos(angle) * 8;
            ball.vy = Math.sin(angle) * 8;
            ball.x = anchor.x + Math.cos(angle) * (ball.radius + 27);
            ball.y = anchor.y + Math.sin(angle) * (ball.radius + 27);
            createParticles(anchor.x, anchor.y, '#4a4a4a', 8);
            score += 50;
          }
        });

        // Oak plank flippers
        [flippers.left, flippers.right].forEach((flipper, idx) => {
          const endX = flipper.x + Math.cos(flipper.angle) * flipper.length;
          const endY = flipper.y + Math.sin(flipper.angle) * flipper.length;

          const A = ball.x - flipper.x;
          const B = ball.y - flipper.y;
          const C = endX - flipper.x;
          const D = endY - flipper.y;

          const dot = A * C + B * D;
          const len_sq = C * C + D * D;
          let t = Math.max(0, Math.min(1, dot / len_sq));

          const closestX = flipper.x + t * C;
          const closestY = flipper.y + t * D;

          const dx = ball.x - closestX;
          const dy = ball.y - closestY;
          const dist = Math.sqrt(dx * dx + dy * dy);

          if (dist < ball.radius + 10) {
            const isMoving = Math.abs(flipper.angle - flipper.targetAngle) > 0.1;
            const bounceForce = isMoving ? 20 : 9;

            const angle = Math.atan2(dy, dx);
            ball.vx = Math.cos(angle) * bounceForce + (isMoving ? (idx === 0 ? 6 : -6) : 0);
            ball.vy = Math.sin(angle) * bounceForce - 4;

            ball.x = closestX + Math.cos(angle) * (ball.radius + 12);
            ball.y = closestY + Math.sin(angle) * (ball.radius + 12);

            createParticles(closestX, closestY, '#a67c52', 10);
            if (isMoving) createSparks(closestX, closestY, 5);
          }
        });

        // Heavier friction for iron ball
        ball.vx *= 0.992;
        ball.vy *= 0.992;

        // Speed limit
        if (speed > 28) {
          ball.vx = (ball.vx / speed) * 28;
          ball.vy = (ball.vy / speed) * 28;
        }
      });

      // Ball lost
      balls = balls.filter(ball => {
        if (ball.y > H + 50) {
          lives--;
          updateUI();
          if (lives <= 0) gameOver();
          return false;
        }
        return true;
      });

      if (balls.length === 0 && lives > 0) spawnBall();

      // Update barrels
      barrels.forEach(b => {
        b.fuse += 0.05;
        if (b.flash) b.flash *= 0.85;
        if (b.flash < 0.01) b.flash = 0;
        if (b.shake) b.shake *= 0.9;
        if (b.shake < 0.01) b.shake = 0;
      });

      // Update target rotation
      targets.forEach(t => t.rotation += 0.02);

      // Update particles
      particles = particles.filter(p => {
        p.x += p.vx;
        p.y += p.vy;
        if (p.type === 'smoke') {
          p.vy -= 0.05;
          p.vx *= 0.98;
        } else {
          p.vy += 0.15;
        }
        p.life -= p.type === 'smoke' ? 0.015 : 0.025;
        return p.life > 0;
      });

      // Update sparks
      sparks = sparks.filter(s => {
        s.x += s.vx;
        s.y += s.vy;
        s.vy += 0.2;
        s.life -= 0.04;
        return s.life > 0;
      });

      // Update smoke trails
      smokeTrails = smokeTrails.filter(s => {
        s.life -= 0.05;
        s.size *= 1.02;
        return s.life > 0;
      });

      updateUI();
    }

    function updateUI() {
      document.getElementById('score').textContent = score.toLocaleString();
      document.getElementById('lives').textContent = 'âš«'.repeat(Math.max(0, lives));
    }

    function gameOver() {
      gameStarted = false;
      const msg = document.getElementById('message');
      msg.querySelector('h2').textContent = 'POWDER KEG EMPTY!';
      msg.querySelector('p').textContent = `Plunder collected: ${score.toLocaleString()}`;
      msg.classList.add('show');

      setTimeout(() => {
        msg.classList.remove('show');
        document.getElementById('start-btn').style.display = 'block';
        document.getElementById('start-btn').textContent = 'RELOAD!';
      }, 3000);
    }

    function drawOakRailing(x1, y1, x2, y2, thickness) {
      ctx.save();

      // Main oak beam
      const gradient = ctx.createLinearGradient(x1, y1, x2, y2);
      gradient.addColorStop(0, '#5c3a1e');
      gradient.addColorStop(0.3, '#8b6914');
      gradient.addColorStop(0.5, '#a67c52');
      gradient.addColorStop(0.7, '#8b6914');
      gradient.addColorStop(1, '#5c3a1e');

      ctx.strokeStyle = gradient;
      ctx.lineWidth = thickness;
      ctx.lineCap = 'round';
      ctx.beginPath();
      ctx.moveTo(x1, y1);
      ctx.lineTo(x2, y2);
      ctx.stroke();

      // Wood grain lines
      ctx.strokeStyle = 'rgba(60, 40, 20, 0.4)';
      ctx.lineWidth = 1;
      const length = Math.sqrt((x2-x1)**2 + (y2-y1)**2);
      const angle = Math.atan2(y2-y1, x2-x1);

      for (let i = 0; i < length; i += 15) {
        const ox = x1 + Math.cos(angle) * i;
        const oy = y1 + Math.sin(angle) * i;
        ctx.beginPath();
        ctx.moveTo(ox - Math.sin(angle) * thickness/3, oy + Math.cos(angle) * thickness/3);
        ctx.lineTo(ox + Math.sin(angle) * thickness/3, oy - Math.cos(angle) * thickness/3);
        ctx.stroke();
      }

      // Iron bands
      ctx.fillStyle = '#3a3a3a';
      ctx.strokeStyle = '#555';
      ctx.lineWidth = 2;

      for (let i = 0; i < length; i += 60) {
        const bx = x1 + Math.cos(angle) * i;
        const by = y1 + Math.sin(angle) * i;
        ctx.save();
        ctx.translate(bx, by);
        ctx.rotate(angle);
        ctx.fillRect(-5, -thickness/2 - 2, 10, thickness + 4);
        ctx.strokeRect(-5, -thickness/2 - 2, 10, thickness + 4);
        ctx.restore();
      }

      ctx.restore();
    }

    function drawGunpowderBarrel(barrel) {
      ctx.save();
      ctx.translate(barrel.x, barrel.y);

      // Shake effect
      if (barrel.shake) {
        ctx.translate(
          (Math.random() - 0.5) * barrel.shake * 8,
          (Math.random() - 0.5) * barrel.shake * 8
        );
      }

      const r = barrel.radius;
      const flash = barrel.flash || 0;

      // Barrel shadow
      ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
      ctx.beginPath();
      ctx.ellipse(3, 5, r, r * 0.4, 0, 0, Math.PI * 2);
      ctx.fill();

      // Main barrel body
      const bodyGrad = ctx.createRadialGradient(-r/3, -r/3, 0, 0, 0, r);
      bodyGrad.addColorStop(0, flash > 0.5 ? '#ff6600' : '#6b4423');
      bodyGrad.addColorStop(0.5, flash > 0.3 ? '#ff4400' : '#4a2f17');
      bodyGrad.addColorStop(1, '#2a1a0f');

      ctx.fillStyle = bodyGrad;
      ctx.beginPath();
      ctx.arc(0, 0, r, 0, Math.PI * 2);
      ctx.fill();

      // Barrel staves (vertical lines)
      ctx.strokeStyle = 'rgba(30, 20, 10, 0.6)';
      ctx.lineWidth = 2;
      for (let i = 0; i < 8; i++) {
        const angle = (i / 8) * Math.PI * 2;
        ctx.beginPath();
        ctx.moveTo(Math.cos(angle) * r * 0.3, Math.sin(angle) * r * 0.3);
        ctx.lineTo(Math.cos(angle) * r * 0.95, Math.sin(angle) * r * 0.95);
        ctx.stroke();
      }

      // Iron bands
      ctx.strokeStyle = '#555';
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.arc(0, 0, r * 0.5, 0, Math.PI * 2);
      ctx.stroke();
      ctx.beginPath();
      ctx.arc(0, 0, r * 0.85, 0, Math.PI * 2);
      ctx.stroke();

      // Band rivets
      ctx.fillStyle = '#666';
      for (let ring = 0; ring < 2; ring++) {
        const ringR = ring === 0 ? r * 0.5 : r * 0.85;
        for (let i = 0; i < 6; i++) {
          const angle = (i / 6) * Math.PI * 2;
          ctx.beginPath();
          ctx.arc(Math.cos(angle) * ringR, Math.sin(angle) * ringR, 3, 0, Math.PI * 2);
          ctx.fill();
        }
      }

      // Skull and crossbones danger symbol
      ctx.fillStyle = flash > 0.5 ? '#fff' : '#c9a227';
      ctx.font = `${r * 0.8}px serif`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('â˜ ', 0, 0);

      // Fuse spark
      const fuseX = Math.cos(barrel.fuse) * r * 0.3;
      const fuseY = -r - 5;
      ctx.fillStyle = '#ff6600';
      ctx.shadowColor = '#ff6600';
      ctx.shadowBlur = 10 + Math.sin(Date.now() * 0.02) * 5;
      ctx.beginPath();
      ctx.arc(fuseX, fuseY, 4 + Math.sin(Date.now() * 0.03) * 2, 0, Math.PI * 2);
      ctx.fill();

      // Fuse rope
      ctx.shadowBlur = 0;
      ctx.strokeStyle = '#3d2512';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(0, -r * 0.5);
      ctx.quadraticCurveTo(fuseX * 0.5, fuseY + r * 0.3, fuseX, fuseY);
      ctx.stroke();

      ctx.restore();
    }

    function drawCannonball(x, y, radius, rotation) {
      ctx.save();
      ctx.translate(x, y);
      ctx.rotate(rotation);

      // Heavy shadow
      ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
      ctx.shadowBlur = 15;
      ctx.shadowOffsetX = 3;
      ctx.shadowOffsetY = 3;

      // Iron ball gradient
      const gradient = ctx.createRadialGradient(-radius/3, -radius/3, 0, 0, 0, radius);
      gradient.addColorStop(0, '#5a5a5a');
      gradient.addColorStop(0.4, '#3a3a3a');
      gradient.addColorStop(0.7, '#252525');
      gradient.addColorStop(1, '#0a0a0a');

      ctx.fillStyle = gradient;
      ctx.beginPath();
      ctx.arc(0, 0, radius, 0, Math.PI * 2);
      ctx.fill();

      // Highlight
      ctx.fillStyle = 'rgba(255, 255, 255, 0.15)';
      ctx.beginPath();
      ctx.arc(-radius/3, -radius/3, radius/3, 0, Math.PI * 2);
      ctx.fill();

      // Iron texture
      ctx.strokeStyle = 'rgba(80, 80, 80, 0.3)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.arc(0, 0, radius * 0.7, 0, Math.PI * 2);
      ctx.stroke();

      ctx.restore();
    }

    function drawAnchor(x, y) {
      ctx.save();
      ctx.translate(x, y);

      ctx.fillStyle = '#4a4a4a';
      ctx.strokeStyle = '#333';
      ctx.lineWidth = 3;

      // Ring at top
      ctx.beginPath();
      ctx.arc(0, -15, 8, 0, Math.PI * 2);
      ctx.stroke();

      // Shaft
      ctx.fillRect(-4, -10, 8, 35);
      ctx.strokeRect(-4, -10, 8, 35);

      // Cross bar
      ctx.fillRect(-18, 5, 36, 6);
      ctx.strokeRect(-18, 5, 36, 6);

      // Left fluke
      ctx.beginPath();
      ctx.moveTo(-15, 25);
      ctx.lineTo(-25, 15);
      ctx.lineTo(-18, 8);
      ctx.closePath();
      ctx.fill();
      ctx.stroke();

      // Right fluke
      ctx.beginPath();
      ctx.moveTo(15, 25);
      ctx.lineTo(25, 15);
      ctx.lineTo(18, 8);
      ctx.closePath();
      ctx.fill();
      ctx.stroke();

      ctx.restore();
    }

    function draw() {
      // Dark hold background
      const bgGrad = ctx.createRadialGradient(W/2, H/2, 0, W/2, H/2, H);
      bgGrad.addColorStop(0, '#1a1410');
      bgGrad.addColorStop(1, '#0a0806');
      ctx.fillStyle = bgGrad;
      ctx.fillRect(0, 0, W, H);

      // Smoke trails
      smokeTrails.forEach(s => {
        ctx.globalAlpha = s.life * 0.3;
        ctx.fillStyle = '#444';
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
        ctx.fill();
      });
      ctx.globalAlpha = 1;

      // Wood plank floor pattern
      ctx.fillStyle = '#2a1a10';
      for (let i = 0; i < H; i += 50) {
        ctx.fillRect(0, i, W, 48);
        ctx.strokeStyle = '#1a0f08';
        ctx.lineWidth = 2;
        ctx.strokeRect(0, i, W, 48);
      }

      // Wood grain
      ctx.strokeStyle = 'rgba(60, 40, 20, 0.2)';
      ctx.lineWidth = 1;
      for (let i = 0; i < W; i += 80) {
        ctx.beginPath();
        ctx.moveTo(i, 0);
        ctx.lineTo(i, H);
        ctx.stroke();
      }

      // Skull watermark
      ctx.save();
      ctx.translate(W/2, H/2 - 30);
      ctx.globalAlpha = 0.06;
      ctx.font = '180px serif';
      ctx.textAlign = 'center';
      ctx.fillStyle = '#c9a227';
      ctx.fillText('â˜ ', 0, 60);
      ctx.globalAlpha = 1;
      ctx.restore();

      // Oak railing walls
      drawOakRailing(25, 0, 25, H, 24);
      drawOakRailing(W - 25, 0, W - 25, 480, 24);
      drawOakRailing(0, 25, W, 25, 24);

      // Launcher channel railing
      drawOakRailing(450, 530, 450, H, 20);

      // Gold coin targets
      targets.forEach(target => {
        ctx.save();
        ctx.translate(target.x, target.y);

        if (!target.hit) {
          ctx.rotate(Math.sin(target.rotation) * 0.1);

          // Coin glow
          ctx.shadowColor = '#ffd700';
          ctx.shadowBlur = 15;

          // Gold coin
          const coinGrad = ctx.createLinearGradient(-target.width/2, 0, target.width/2, 0);
          coinGrad.addColorStop(0, '#c9a227');
          coinGrad.addColorStop(0.3, '#ffd700');
          coinGrad.addColorStop(0.5, '#fff8dc');
          coinGrad.addColorStop(0.7, '#ffd700');
          coinGrad.addColorStop(1, '#c9a227');

          ctx.fillStyle = coinGrad;
          ctx.beginPath();
          ctx.ellipse(0, 0, target.width/2, target.height/2, 0, 0, Math.PI * 2);
          ctx.fill();

          ctx.strokeStyle = '#8b6914';
          ctx.lineWidth = 2;
          ctx.stroke();
        } else {
          ctx.globalAlpha = 0.3;
          ctx.fillStyle = '#3a3020';
          ctx.beginPath();
          ctx.ellipse(0, 0, target.width/2, target.height/2, 0, 0, Math.PI * 2);
          ctx.fill();
        }

        ctx.restore();
      });
      ctx.shadowBlur = 0;

      // Gunpowder barrels
      barrels.forEach(barrel => drawGunpowderBarrel(barrel));

      // Anchors
      anchors.forEach(anchor => drawAnchor(anchor.x, anchor.y));

      // Oak plank flippers
      [flippers.left, flippers.right].forEach(flipper => {
        const endX = flipper.x + Math.cos(flipper.angle) * flipper.length;
        const endY = flipper.y + Math.sin(flipper.angle) * flipper.length;

        // Flipper shadow
        ctx.shadowColor = 'rgba(0, 0, 0, 0.4)';
        ctx.shadowBlur = 8;
        ctx.shadowOffsetY = 4;

        // Oak plank
        const plankGrad = ctx.createLinearGradient(flipper.x, flipper.y, endX, endY);
        plankGrad.addColorStop(0, '#5c3a1e');
        plankGrad.addColorStop(0.3, '#8b6914');
        plankGrad.addColorStop(0.5, '#a67c52');
        plankGrad.addColorStop(0.7, '#8b6914');
        plankGrad.addColorStop(1, '#5c3a1e');

        ctx.strokeStyle = plankGrad;
        ctx.lineWidth = 20;
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(flipper.x, flipper.y);
        ctx.lineTo(endX, endY);
        ctx.stroke();

        // Wood grain
        ctx.strokeStyle = 'rgba(40, 25, 10, 0.5)';
        ctx.lineWidth = 1;
        const midX = (flipper.x + endX) / 2;
        const midY = (flipper.y + endY) / 2;
        ctx.beginPath();
        ctx.moveTo(flipper.x, flipper.y);
        ctx.lineTo(endX, endY);
        ctx.stroke();

        // Iron pivot
        ctx.shadowBlur = 0;
        ctx.fillStyle = '#4a4a4a';
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(flipper.x, flipper.y, 12, 0, Math.PI * 2);
        ctx.fill();
        ctx.stroke();

        // Pivot rivet
        ctx.fillStyle = '#666';
        ctx.beginPath();
        ctx.arc(flipper.x, flipper.y, 5, 0, Math.PI * 2);
        ctx.fill();
      });
      ctx.shadowBlur = 0;

      // Cannon launcher
      ctx.fillStyle = '#2a1810';
      ctx.fillRect(455, 520, 40, H - 520);

      // Cannon barrel
      const cannonGrad = ctx.createLinearGradient(455, 0, 495, 0);
      cannonGrad.addColorStop(0, '#3a3a3a');
      cannonGrad.addColorStop(0.5, '#5a5a5a');
      cannonGrad.addColorStop(1, '#3a3a3a');
      ctx.fillStyle = cannonGrad;
      ctx.fillRect(460, 530, 30, 50);

      // Cannon mouth
      ctx.fillStyle = '#222';
      ctx.beginPath();
      ctx.ellipse(475, 530, 15, 8, 0, 0, Math.PI * 2);
      ctx.fill();

      // Power indicator
      if (launcher.charging) {
        const powerGrad = ctx.createLinearGradient(455, 550 - launcher.power, 455, 550);
        powerGrad.addColorStop(0, '#ff6600');
        powerGrad.addColorStop(1, '#ff3300');
        ctx.fillStyle = powerGrad;
        ctx.fillRect(458, 550 - launcher.power, 34, launcher.power);

        // Sparks
        if (Math.random() > 0.7) createSparks(475, 530, 2);
      }

      // Abyss warning
      ctx.fillStyle = '#1a0505';
      ctx.globalAlpha = 0.5 + Math.sin(Date.now() * 0.006) * 0.2;
      ctx.fillRect(60, H - 15, 330, 15);
      ctx.globalAlpha = 1;

      ctx.fillStyle = '#8b0000';
      ctx.font = '14px "IM Fell English SC"';
      ctx.textAlign = 'center';
      ctx.fillText('â˜  THE DEPTHS BELOW â˜ ', 225, H - 3);

      // Particles
      particles.forEach(p => {
        ctx.globalAlpha = Math.min(1, p.life);
        ctx.fillStyle = p.color;
        if (p.type === 'fire') {
          ctx.shadowColor = p.color;
          ctx.shadowBlur = 10;
        }
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size * (p.type === 'smoke' ? 1 : p.life), 0, Math.PI * 2);
        ctx.fill();
      });
      ctx.globalAlpha = 1;
      ctx.shadowBlur = 0;

      // Sparks
      sparks.forEach(s => {
        ctx.globalAlpha = s.life;
        ctx.fillStyle = `hsl(${30 + Math.random() * 20}, 100%, ${60 + s.life * 40}%)`;
        ctx.shadowColor = '#ff6600';
        ctx.shadowBlur = 5;
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.size * s.life, 0, Math.PI * 2);
        ctx.fill();
      });
      ctx.globalAlpha = 1;
      ctx.shadowBlur = 0;

      // Cannonballs
      balls.forEach(ball => {
        drawCannonball(ball.x, ball.y, ball.radius, ball.rotation);
      });

      // Title
      ctx.fillStyle = '#c9a227';
      ctx.shadowColor = 'rgba(201, 162, 39, 0.4)';
      ctx.shadowBlur = 12;
      ctx.font = 'bold 24px "Pirata One"';
      ctx.textAlign = 'center';
      ctx.fillText('CANNONBALL PINBALL', W/2, 60);
      ctx.shadowBlur = 0;
    }

    function gameLoop() {
      update();
      draw();
      requestAnimationFrame(gameLoop);
    }

    gameLoop();
  </script>
<script src="/apps/sloppy-header/sloppy-bar.js"></script>
<script src="/vibelib-extended.js"></script>
<script>
  // Compatibility Patch for Legacy Apps
  window.addEventListener("load", () => {
    if (window.SloppyKarma && window.VibeLib.Economy) {
      // Redirect old calls to new engine
      window.SloppyKarma.track = window.VibeLib.Economy.track;
    }
  });
</script>
</body>
</html>
