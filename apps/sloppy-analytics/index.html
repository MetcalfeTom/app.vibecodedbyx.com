<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SloppyID Network Analytics</title>
  <link rel="icon" href="https://emojicdn.elk.sh/üìä">
  <meta property="og:title" content="SloppyID Network Analytics">
  <meta property="og:description" content="Real-time teleport tracking and app popularity across the sloppy.live ecosystem">
  <meta property="og:url" content="https://app.sloppy.live/sloppy-analytics">
  <meta property="og:image" content="https://app.sloppy.live/sloppy-analytics/og-image.png">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #05050a;
      --bg-secondary: #0a0a12;
      --bg-card: #10101a;
      --border: #1a1a2a;
      --text-primary: #e0e0e0;
      --text-secondary: #666;
      --accent-purple: #aa66ff;
      --accent-pink: #ff66aa;
      --accent-cyan: #00ddff;
      --accent-green: #00ff88;
      --accent-yellow: #ffcc00;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'JetBrains Mono', monospace;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      padding-top: 50px;
    }

    .grid-bg {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image:
        radial-gradient(circle at 20% 50%, rgba(170, 102, 255, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 80% 50%, rgba(255, 102, 170, 0.03) 0%, transparent 50%),
        linear-gradient(rgba(170, 102, 255, 0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(170, 102, 255, 0.02) 1px, transparent 1px);
      background-size: 100% 100%, 100% 100%, 40px 40px, 40px 40px;
      pointer-events: none;
      z-index: 0;
    }

    .container {
      position: relative;
      z-index: 1;
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    header {
      text-align: center;
      margin-bottom: 40px;
    }

    h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: 2.5rem;
      font-weight: 900;
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink), var(--accent-cyan));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .metrics-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .metric-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .metric-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent-purple), var(--accent-pink));
    }

    .metric-value {
      font-family: 'Orbitron', sans-serif;
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .metric-label {
      color: var(--text-secondary);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 5px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    @media (max-width: 900px) {
      .grid-2 { grid-template-columns: 1fr; }
    }

    .panel {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }

    .panel-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 1rem;
      color: var(--accent-purple);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .panel-badge {
      background: var(--accent-purple);
      color: #fff;
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 10px;
    }

    .leaderboard-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }

    .leaderboard-item:last-child {
      border-bottom: none;
    }

    .rank {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
      width: 30px;
      text-align: center;
    }

    .rank.gold { color: #ffd700; }
    .rank.silver { color: #c0c0c0; }
    .rank.bronze { color: #cd7f32; }

    .app-name {
      flex: 1;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .app-count {
      font-family: 'Orbitron', sans-serif;
      color: var(--accent-cyan);
      font-weight: 600;
    }

    .bar-container {
      flex: 1;
      height: 8px;
      background: var(--bg-secondary);
      border-radius: 4px;
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-purple), var(--accent-pink));
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .feed-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.85rem;
    }

    .feed-item:last-child {
      border-bottom: none;
    }

    .feed-icon {
      font-size: 1.2rem;
    }

    .feed-text {
      flex: 1;
    }

    .feed-text .username {
      color: var(--accent-cyan);
      font-weight: 600;
    }

    .feed-text .arrow {
      color: var(--accent-pink);
      margin: 0 5px;
    }

    .feed-text .app {
      color: var(--accent-purple);
    }

    .feed-time {
      color: var(--text-secondary);
      font-size: 0.75rem;
    }

    .route-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }

    .route-path {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.85rem;
    }

    .route-from {
      color: var(--accent-cyan);
    }

    .route-arrow {
      color: var(--accent-pink);
    }

    .route-to {
      color: var(--accent-purple);
    }

    .route-count {
      font-family: 'Orbitron', sans-serif;
      color: var(--accent-green);
      font-weight: 600;
    }

    .chart-container {
      height: 200px;
      display: flex;
      align-items: flex-end;
      gap: 8px;
      padding-top: 20px;
    }

    .chart-bar {
      flex: 1;
      background: linear-gradient(180deg, var(--accent-purple), var(--accent-pink));
      border-radius: 4px 4px 0 0;
      min-height: 10px;
      position: relative;
      transition: height 0.5s ease;
    }

    .chart-bar:hover {
      opacity: 0.8;
    }

    .chart-bar-label {
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.6rem;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .chart-bar-value {
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.7rem;
      color: var(--accent-cyan);
      font-weight: 600;
    }

    .refresh-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.8rem;
      z-index: 100;
    }

    .pulse-dot {
      width: 8px;
      height: 8px;
      background: var(--accent-green);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 10px;
    }

    .backlink {
      text-align: center;
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .backlink a {
      color: var(--accent-cyan);
      text-decoration: none;
    }

    .time-filter {
      display: flex;
      gap: 8px;
    }

    .time-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 4px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.75rem;
      transition: all 0.2s;
    }

    .time-btn:hover, .time-btn.active {
      background: var(--accent-purple);
      border-color: var(--accent-purple);
      color: #fff;
    }
  </style>
</head>
<body>
  <div class="grid-bg"></div>
  <div class="container">
    <header>
      <h1>üìä Network Analytics</h1>
      <p class="subtitle">Real-time teleport tracking across the SloppyID ecosystem</p>
    </header>

    <div class="metrics-row">
      <div class="metric-card">
        <div class="metric-value" id="totalTeleports">--</div>
        <div class="metric-label">Total Teleports</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="uniqueUsers">--</div>
        <div class="metric-label">Unique Travelers</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="appsVisited">--</div>
        <div class="metric-label">Apps Visited</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="todayTeleports">--</div>
        <div class="metric-label">Today's Teleports</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="topDestination">--</div>
        <div class="metric-label">Top Destination</div>
      </div>
    </div>

    <div class="grid-2">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">üéØ Top Destinations</div>
          <div class="time-filter">
            <button class="time-btn active" onclick="setTimeFilter('all')">All</button>
            <button class="time-btn" onclick="setTimeFilter('day')">24h</button>
            <button class="time-btn" onclick="setTimeFilter('week')">7d</button>
          </div>
        </div>
        <div id="topDestinations">
          <div class="empty-state">
            <div class="empty-state-icon">üåÄ</div>
            <div>No teleports yet. Be the first!</div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">üöÄ Top Launch Points</div>
        </div>
        <div id="topSources">
          <div class="empty-state">
            <div class="empty-state-icon">üöÄ</div>
            <div>Waiting for teleport data...</div>
          </div>
        </div>
      </div>
    </div>

    <div class="grid-2">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">üõ§Ô∏è Popular Routes</div>
          <span class="panel-badge">Top 10</span>
        </div>
        <div id="popularRoutes">
          <div class="empty-state">
            <div class="empty-state-icon">üõ§Ô∏è</div>
            <div>No routes recorded yet</div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">‚ö° Live Feed</div>
          <span class="panel-badge" id="feedStatus">LIVE</span>
        </div>
        <div id="liveFeed">
          <div class="empty-state">
            <div class="empty-state-icon">‚ö°</div>
            <div>Waiting for teleports...</div>
          </div>
        </div>
      </div>
    </div>

    <div class="panel" style="margin-bottom: 30px;">
      <div class="panel-header">
        <div class="panel-title">üìà Teleports Over Time (Last 7 Days)</div>
      </div>
      <div class="chart-container" id="timeChart">
        <!-- Chart bars will be inserted here -->
      </div>
    </div>

    <div class="backlink">
      <a href="https://sloppy.live">‚Üê Back to sloppy.live</a>
    </div>
  </div>

  <div class="refresh-indicator">
    <div class="pulse-dot"></div>
    <span>Auto-refresh: <span id="refreshTimer">30</span>s</span>
  </div>

  <script src="/supabase-config.js"></script>
  <script>
    let timeFilter = 'all';
    let refreshInterval;
    let countdownInterval;
    let countdown = 30;

    async function init() {
      await loadAnalytics();
      setupRealtime();
      startAutoRefresh();
    }

    async function loadAnalytics() {
      try {
        // Get time filter
        let timeQuery = null;
        const now = new Date();
        if (timeFilter === 'day') {
          timeQuery = new Date(now - 24 * 60 * 60 * 1000).toISOString();
        } else if (timeFilter === 'week') {
          timeQuery = new Date(now - 7 * 24 * 60 * 60 * 1000).toISOString();
        }

        // Base query
        let query = supabase.from('sloppy_analytics').select('*').eq('event_type', 'teleport');
        if (timeQuery) {
          query = query.gte('created_at', timeQuery);
        }

        const { data: teleports, error } = await query.order('created_at', { ascending: false });

        if (error) throw error;

        // Calculate metrics
        const total = teleports.length;
        const uniqueUsers = new Set(teleports.map(t => t.username)).size;
        const appsVisited = new Set(teleports.map(t => t.destination_app)).size;

        // Today's teleports
        const todayStart = new Date();
        todayStart.setHours(0, 0, 0, 0);
        const todayTeleports = teleports.filter(t => new Date(t.created_at) >= todayStart).length;

        // Update metrics
        document.getElementById('totalTeleports').textContent = total.toLocaleString();
        document.getElementById('uniqueUsers').textContent = uniqueUsers;
        document.getElementById('appsVisited').textContent = appsVisited;
        document.getElementById('todayTeleports').textContent = todayTeleports;

        // Top destinations
        const destCounts = {};
        teleports.forEach(t => {
          destCounts[t.destination_app] = (destCounts[t.destination_app] || 0) + 1;
        });
        const topDests = Object.entries(destCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);

        if (topDests.length > 0) {
          document.getElementById('topDestination').textContent = topDests[0][0];
          renderLeaderboard('topDestinations', topDests, Math.max(...topDests.map(d => d[1])));
        }

        // Top sources
        const srcCounts = {};
        teleports.forEach(t => {
          srcCounts[t.source_app] = (srcCounts[t.source_app] || 0) + 1;
        });
        const topSrcs = Object.entries(srcCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
        if (topSrcs.length > 0) {
          renderLeaderboard('topSources', topSrcs, Math.max(...topSrcs.map(s => s[1])));
        }

        // Popular routes
        const routeCounts = {};
        teleports.forEach(t => {
          const route = `${t.source_app}‚Üí${t.destination_app}`;
          routeCounts[route] = (routeCounts[route] || 0) + 1;
        });
        const topRoutes = Object.entries(routeCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
        renderRoutes('popularRoutes', topRoutes);

        // Live feed
        renderFeed('liveFeed', teleports.slice(0, 15));

        // Time chart
        renderTimeChart(teleports);

      } catch (e) {
        console.error('Analytics error:', e);
      }
    }

    function renderLeaderboard(containerId, data, maxCount) {
      const container = document.getElementById(containerId);
      if (data.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üì≠</div><div>No data yet</div></div>`;
        return;
      }

      container.innerHTML = data.map((item, i) => {
        const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
        const barWidth = (item[1] / maxCount) * 100;
        return `
          <div class="leaderboard-item">
            <div class="rank ${rankClass}">${i + 1}</div>
            <div class="app-name">${item[0]}</div>
            <div class="bar-container">
              <div class="bar-fill" style="width: ${barWidth}%"></div>
            </div>
            <div class="app-count">${item[1]}</div>
          </div>
        `;
      }).join('');
    }

    function renderRoutes(containerId, routes) {
      const container = document.getElementById(containerId);
      if (routes.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üõ§Ô∏è</div><div>No routes yet</div></div>`;
        return;
      }

      container.innerHTML = routes.map(([route, count]) => {
        const [from, to] = route.split('‚Üí');
        return `
          <div class="route-item">
            <div class="route-path">
              <span class="route-from">${from}</span>
              <span class="route-arrow">‚Üí</span>
              <span class="route-to">${to}</span>
            </div>
            <div class="route-count">${count}x</div>
          </div>
        `;
      }).join('');
    }

    function renderFeed(containerId, teleports) {
      const container = document.getElementById(containerId);
      if (teleports.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ö°</div><div>Waiting for teleports...</div></div>`;
        return;
      }

      container.innerHTML = teleports.map(t => {
        const time = new Date(t.created_at);
        const timeStr = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        return `
          <div class="feed-item">
            <span class="feed-icon">üåÄ</span>
            <span class="feed-text">
              <span class="username">${t.username || 'Anon'}</span>
              <span class="arrow">‚Üí</span>
              <span class="app">${t.destination_app}</span>
            </span>
            <span class="feed-time">${timeStr}</span>
          </div>
        `;
      }).join('');
    }

    function renderTimeChart(teleports) {
      const container = document.getElementById('timeChart');
      const days = {};
      const now = new Date();

      // Initialize last 7 days
      for (let i = 6; i >= 0; i--) {
        const d = new Date(now);
        d.setDate(d.getDate() - i);
        const key = d.toISOString().split('T')[0];
        days[key] = 0;
      }

      // Count teleports per day
      teleports.forEach(t => {
        const day = t.created_at.split('T')[0];
        if (days[day] !== undefined) {
          days[day]++;
        }
      });

      const values = Object.values(days);
      const maxVal = Math.max(...values, 1);

      container.innerHTML = Object.entries(days).map(([date, count]) => {
        const height = (count / maxVal) * 150 + 10;
        const dayName = new Date(date).toLocaleDateString('en', { weekday: 'short' });
        return `
          <div class="chart-bar" style="height: ${height}px" title="${date}: ${count} teleports">
            <span class="chart-bar-value">${count}</span>
            <span class="chart-bar-label">${dayName}</span>
          </div>
        `;
      }).join('');
    }

    function setTimeFilter(filter) {
      timeFilter = filter;
      document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      loadAnalytics();
    }

    function setupRealtime() {
      supabase
        .channel('analytics-realtime')
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'sloppy_analytics'
        }, payload => {
          loadAnalytics();
          // Flash the feed badge
          const badge = document.getElementById('feedStatus');
          badge.style.background = '#00ff88';
          setTimeout(() => badge.style.background = '', 300);
        })
        .subscribe();
    }

    function startAutoRefresh() {
      // Refresh data every 30 seconds
      refreshInterval = setInterval(loadAnalytics, 30000);

      // Update countdown
      countdownInterval = setInterval(() => {
        countdown--;
        if (countdown <= 0) countdown = 30;
        document.getElementById('refreshTimer').textContent = countdown;
      }, 1000);
    }

    init();
  </script>
  <script src="/apps/sloppy-header/sloppy-bar.js"></script>
<script src="/vibelib-extended.js"></script>
<script>
  // Compatibility Patch for Legacy Apps
  window.addEventListener("load", () => {
    if (window.SloppyKarma && window.VibeLib.Economy) {
      // Redirect old calls to new engine
      window.SloppyKarma.track = window.VibeLib.Economy.track;
    }
  });
</script>
</body>
</html>
