<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hex Conquest - Neon Strategy</title>
  <link rel="icon" href="https://emojicdn.elk.sh/‚¨°">
  <meta property="og:title" content="Hex Conquest">
  <meta property="og:description" content="Turn-based hex strategy with resource management">
  <meta property="og:url" content="https://sloppy.live/hex-conquest">
  <meta property="og:image" content="https://emojicdn.elk.sh/‚¨°?style=apple&size=512">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #0a0a18 0%, #1a1a2e 100%);
      min-height: 100vh;
      font-family: 'Orbitron', sans-serif;
      color: #fff;
      overflow: hidden;
    }

    .game-container {
      display: flex;
      height: 100vh;
    }

    .sidebar {
      width: 280px;
      background: rgba(0, 0, 0, 0.6);
      border-right: 2px solid #ff00ff;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      overflow-y: auto;
    }

    .title {
      font-size: 1.3rem;
      font-weight: 800;
      text-align: center;
      color: #00ffff;
      text-shadow: 0 0 20px #00ffff;
      padding-bottom: 10px;
      border-bottom: 1px solid #333;
    }

    .resources {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .resource {
      background: rgba(255, 255, 255, 0.05);
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #333;
      text-align: center;
    }

    .resource-icon { font-size: 1.3rem; }
    .resource-value {
      font-size: 1.1rem;
      font-weight: 600;
      color: #ffff00;
      text-shadow: 0 0 10px #ffff00;
    }
    .resource-label {
      font-size: 0.6rem;
      color: #888;
      margin-top: 3px;
    }

    .turn-info {
      background: rgba(255, 0, 255, 0.1);
      border: 2px solid #ff00ff;
      border-radius: 10px;
      padding: 12px;
      text-align: center;
    }

    .turn-label { font-size: 0.7rem; color: #ff00ff; }
    .turn-number {
      font-size: 1.8rem;
      font-weight: 800;
      color: #fff;
      text-shadow: 0 0 15px #ff00ff;
    }

    .section-title {
      font-size: 0.75rem;
      color: #00ffff;
      border-bottom: 1px solid #00ffff;
      padding-bottom: 5px;
      margin-top: 5px;
    }

    .actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .action-btn {
      padding: 12px;
      background: rgba(0, 255, 255, 0.1);
      border: 2px solid #00ffff;
      color: #00ffff;
      font-family: 'Orbitron', sans-serif;
      font-size: 0.75rem;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .action-btn:hover:not(:disabled) {
      background: rgba(0, 255, 255, 0.3);
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
    }

    .action-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .action-btn.build { border-color: #00ff00; color: #00ff00; }
    .action-btn.build:hover:not(:disabled) { background: rgba(0, 255, 0, 0.2); }

    .action-btn.unit { border-color: #ff6600; color: #ff6600; }
    .action-btn.unit:hover:not(:disabled) { background: rgba(255, 102, 0, 0.2); }

    .cost { font-size: 0.65rem; opacity: 0.8; }

    .end-turn-btn {
      padding: 15px;
      background: linear-gradient(135deg, #ff00ff, #ff6600);
      border: none;
      color: #fff;
      font-family: 'Orbitron', sans-serif;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      border-radius: 10px;
      text-shadow: 0 0 10px rgba(0,0,0,0.5);
      margin-top: auto;
    }

    .end-turn-btn:hover {
      box-shadow: 0 0 30px #ff00ff;
      transform: scale(1.02);
    }

    .map-container {
      flex: 1;
      overflow: auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    canvas { display: block; }

    .selected-info {
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid #666;
      border-radius: 8px;
      padding: 10px;
      min-height: 80px;
    }

    .selected-title {
      font-size: 0.9rem;
      color: #ffff00;
      margin-bottom: 5px;
    }

    .selected-stats {
      font-size: 0.7rem;
      color: #aaa;
    }

    .message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      border: 3px solid #ff00ff;
      padding: 30px 50px;
      border-radius: 15px;
      text-align: center;
      z-index: 1000;
      display: none;
    }

    .message h2 {
      font-size: 2rem;
      color: #00ffff;
      text-shadow: 0 0 30px #00ffff;
    }

    .message p {
      margin-top: 15px;
      color: #888;
    }

    .message button {
      margin-top: 20px;
      padding: 12px 30px;
      background: #ff00ff;
      border: none;
      color: #fff;
      font-family: 'Orbitron', sans-serif;
      cursor: pointer;
      border-radius: 8px;
    }

    .backlink {
      position: fixed;
      bottom: 10px;
      right: 15px;
      color: rgba(255,255,255,0.3);
      font-size: 0.65rem;
      text-decoration: none;
      z-index: 100;
    }
    .backlink:hover { color: #00ffff; }

    @media (max-width: 700px) {
      .sidebar { width: 220px; padding: 10px; }
      .title { font-size: 1rem; }
    }
  </style>
</head>
<body>
  <div class="game-container">
    <div class="sidebar">
      <div class="title">HEX CONQUEST</div>

      <div class="turn-info">
        <div class="turn-label">TURN</div>
        <div class="turn-number" id="turn-num">1</div>
      </div>

      <div class="resources">
        <div class="resource">
          <div class="resource-icon">üí∞</div>
          <div class="resource-value" id="gold">100</div>
          <div class="resource-label">GOLD</div>
        </div>
        <div class="resource">
          <div class="resource-icon">ü™µ</div>
          <div class="resource-value" id="wood">50</div>
          <div class="resource-label">WOOD</div>
        </div>
        <div class="resource">
          <div class="resource-icon">üåæ</div>
          <div class="resource-value" id="food">50</div>
          <div class="resource-label">FOOD</div>
        </div>
        <div class="resource">
          <div class="resource-icon">‚öîÔ∏è</div>
          <div class="resource-value" id="units">1</div>
          <div class="resource-label">UNITS</div>
        </div>
      </div>

      <div class="section-title">BUILD STRUCTURES</div>
      <div class="actions">
        <button class="action-btn build" id="build-mine" onclick="startBuild('mine')">
          <span>‚õèÔ∏è Mine</span>
          <span class="cost">50ü™µ</span>
        </button>
        <button class="action-btn build" id="build-farm" onclick="startBuild('farm')">
          <span>üåæ Farm</span>
          <span class="cost">40ü™µ</span>
        </button>
        <button class="action-btn build" id="build-lumber" onclick="startBuild('lumber')">
          <span>ü™ì Lumber Mill</span>
          <span class="cost">30ü™µ</span>
        </button>
        <button class="action-btn build" id="build-tower" onclick="startBuild('tower')">
          <span>üóº Tower</span>
          <span class="cost">80ü™µ 40üí∞</span>
        </button>
      </div>

      <div class="section-title">RECRUIT UNITS</div>
      <div class="actions">
        <button class="action-btn unit" id="recruit-soldier" onclick="startRecruit('soldier')">
          <span>üó°Ô∏è Soldier</span>
          <span class="cost">30üí∞ 10üåæ</span>
        </button>
        <button class="action-btn unit" id="recruit-archer" onclick="startRecruit('archer')">
          <span>üèπ Archer</span>
          <span class="cost">40üí∞ 10üåæ</span>
        </button>
      </div>

      <div class="section-title">SELECTED</div>
      <div class="selected-info">
        <div class="selected-title" id="sel-title">Nothing selected</div>
        <div class="selected-stats" id="sel-stats"></div>
      </div>

      <button class="end-turn-btn" onclick="endTurn()">END TURN</button>
    </div>

    <div class="map-container">
      <canvas id="game"></canvas>
    </div>
  </div>

  <div class="message" id="message">
    <h2 id="msg-title">Victory!</h2>
    <p id="msg-text">You conquered the enemy!</p>
    <button onclick="restartGame()">Play Again</button>
  </div>

  <a href="https://sloppy.live" class="backlink">sloppy.live</a>

  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    // Hex settings
    const HEX_SIZE = 35;
    const HEX_WIDTH = HEX_SIZE * 2;
    const HEX_HEIGHT = Math.sqrt(3) * HEX_SIZE;
    const GRID_WIDTH = 12;
    const GRID_HEIGHT = 10;

    canvas.width = GRID_WIDTH * HEX_WIDTH * 0.75 + HEX_SIZE;
    canvas.height = GRID_HEIGHT * HEX_HEIGHT + HEX_HEIGHT / 2;

    // Game state
    let turn = 1;
    let resources = { gold: 100, wood: 50, food: 50 };
    let selectedHex = null;
    let selectedUnit = null;
    let buildMode = null;
    let recruitMode = null;
    let gameOver = false;

    // Hex grid
    const hexes = [];

    // Terrain types
    const TERRAIN = {
      plains: { color: '#1a2a1a', name: 'Plains' },
      forest: { color: '#0a3a0a', name: 'Forest', wood: 5 },
      mountain: { color: '#2a2a3a', name: 'Mountain' },
      water: { color: '#0a1a3a', name: 'Water', passable: false }
    };

    // Buildings
    const BUILDINGS = {
      base: { name: 'Base', icon: 'üè∞', hp: 100, gold: 10 },
      mine: { name: 'Mine', icon: '‚õèÔ∏è', hp: 50, gold: 15, cost: { wood: 50 } },
      farm: { name: 'Farm', icon: 'üåæ', hp: 40, food: 10, cost: { wood: 40 } },
      lumber: { name: 'Lumber Mill', icon: 'ü™ì', hp: 40, wood: 10, cost: { wood: 30 } },
      tower: { name: 'Tower', icon: 'üóº', hp: 80, attack: 20, range: 2, cost: { wood: 80, gold: 40 } }
    };

    // Units
    const UNITS = {
      soldier: { name: 'Soldier', icon: 'üó°Ô∏è', hp: 50, attack: 15, move: 2, cost: { gold: 30, food: 10 } },
      archer: { name: 'Archer', icon: 'üèπ', hp: 30, attack: 12, move: 2, range: 2, cost: { gold: 40, food: 10 } }
    };

    // Initialize hex grid
    function initGrid() {
      hexes.length = 0;

      for (let r = 0; r < GRID_HEIGHT; r++) {
        for (let q = 0; q < GRID_WIDTH; q++) {
          const offset = r % 2 === 1 ? HEX_WIDTH * 0.375 : 0;
          const x = q * HEX_WIDTH * 0.75 + HEX_SIZE + offset;
          const y = r * HEX_HEIGHT + HEX_HEIGHT / 2 + 10;

          // Random terrain
          let terrain = 'plains';
          const rand = Math.random();
          if (rand < 0.15) terrain = 'forest';
          else if (rand < 0.22) terrain = 'mountain';
          else if (rand < 0.28) terrain = 'water';

          hexes.push({
            q, r, x, y,
            terrain,
            building: null,
            unit: null,
            owner: null
          });
        }
      }

      // Player base (bottom left)
      const playerBase = hexes.find(h => h.q === 1 && h.r === GRID_HEIGHT - 2);
      if (playerBase) {
        playerBase.terrain = 'plains';
        playerBase.building = { type: 'base', hp: 100 };
        playerBase.owner = 'player';

        // Starting soldier
        const startHex = hexes.find(h => h.q === 2 && h.r === GRID_HEIGHT - 2);
        if (startHex) {
          startHex.terrain = 'plains';
          startHex.unit = { type: 'soldier', hp: 50, moved: false, attacked: false };
          startHex.owner = 'player';
        }
      }

      // Enemy base (top right)
      const enemyBase = hexes.find(h => h.q === GRID_WIDTH - 2 && h.r === 1);
      if (enemyBase) {
        enemyBase.terrain = 'plains';
        enemyBase.building = { type: 'base', hp: 100 };
        enemyBase.owner = 'enemy';

        // Enemy units
        const enemyHexes = [
          hexes.find(h => h.q === GRID_WIDTH - 3 && h.r === 1),
          hexes.find(h => h.q === GRID_WIDTH - 2 && h.r === 2)
        ];
        enemyHexes.forEach(h => {
          if (h) {
            h.terrain = 'plains';
            h.unit = { type: 'soldier', hp: 50, moved: false, attacked: false };
            h.owner = 'enemy';
          }
        });
      }
    }

    // Hex geometry
    function hexCorner(cx, cy, i) {
      const angle = (Math.PI / 180) * (60 * i - 30);
      return {
        x: cx + HEX_SIZE * Math.cos(angle),
        y: cy + HEX_SIZE * Math.sin(angle)
      };
    }

    function drawHex(hex, highlight = false) {
      const { x, y, terrain, building, unit, owner } = hex;

      ctx.beginPath();
      for (let i = 0; i < 6; i++) {
        const corner = hexCorner(x, y, i);
        if (i === 0) ctx.moveTo(corner.x, corner.y);
        else ctx.lineTo(corner.x, corner.y);
      }
      ctx.closePath();

      // Fill
      ctx.fillStyle = TERRAIN[terrain].color;
      ctx.fill();

      // Border
      let borderColor = '#333';
      if (owner === 'player') borderColor = '#00ffff';
      else if (owner === 'enemy') borderColor = '#ff0066';
      if (highlight) borderColor = '#ffff00';
      if (hex === selectedHex) borderColor = '#00ff00';

      ctx.strokeStyle = borderColor;
      ctx.lineWidth = highlight || hex === selectedHex ? 3 : 1;
      ctx.stroke();

      // Building
      if (building) {
        const bData = BUILDINGS[building.type];
        ctx.font = '20px serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(bData.icon, x, y - 5);

        // HP bar
        const hpPct = building.hp / bData.hp;
        ctx.fillStyle = '#333';
        ctx.fillRect(x - 15, y + 12, 30, 4);
        ctx.fillStyle = hpPct > 0.5 ? '#0f0' : hpPct > 0.25 ? '#ff0' : '#f00';
        ctx.fillRect(x - 15, y + 12, 30 * hpPct, 4);
      }

      // Unit
      if (unit) {
        const uData = UNITS[unit.type];
        ctx.font = '18px serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        // Unit background
        ctx.fillStyle = owner === 'player' ? 'rgba(0, 255, 255, 0.3)' : 'rgba(255, 0, 102, 0.3)';
        ctx.beginPath();
        ctx.arc(x, y + (building ? 0 : 0), 12, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillText(uData.icon, x, y + (building ? 0 : 0));

        // HP bar
        const hpPct = unit.hp / uData.hp;
        const barY = building ? y + 5 : y + 15;
        ctx.fillStyle = '#333';
        ctx.fillRect(x - 12, barY, 24, 3);
        ctx.fillStyle = hpPct > 0.5 ? '#0f0' : hpPct > 0.25 ? '#ff0' : '#f00';
        ctx.fillRect(x - 12, barY, 24 * hpPct, 3);

        // Moved indicator
        if (unit.moved) {
          ctx.fillStyle = 'rgba(100, 100, 100, 0.5)';
          ctx.beginPath();
          ctx.arc(x, y, 12, 0, Math.PI * 2);
          ctx.fill();
        }
      }

      // Resource indicator
      if (terrain === 'forest' && !building) {
        ctx.font = '10px serif';
        ctx.fillStyle = '#4a4';
        ctx.fillText('üå≤', x, y);
      }
    }

    function draw() {
      ctx.fillStyle = '#0a0a18';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Find valid move/attack hexes
      let moveHexes = [];
      let attackHexes = [];

      if (selectedUnit && selectedHex && !selectedUnit.moved) {
        moveHexes = getMovableHexes(selectedHex, UNITS[selectedUnit.type].move);
      }
      if (selectedUnit && selectedHex && !selectedUnit.attacked) {
        const range = UNITS[selectedUnit.type].range || 1;
        attackHexes = getAttackableHexes(selectedHex, range);
      }

      // Draw hexes
      hexes.forEach(hex => {
        const isMove = moveHexes.includes(hex);
        const isAttack = attackHexes.includes(hex);
        drawHex(hex, isMove || isAttack);

        if (isAttack && hex.unit && hex.owner === 'enemy') {
          // Red tint for attackable
          ctx.fillStyle = 'rgba(255, 0, 0, 0.2)';
          ctx.beginPath();
          for (let i = 0; i < 6; i++) {
            const corner = hexCorner(hex.x, hex.y, i);
            if (i === 0) ctx.moveTo(corner.x, corner.y);
            else ctx.lineTo(corner.x, corner.y);
          }
          ctx.closePath();
          ctx.fill();
        }
      });

      // Build mode indicator
      if (buildMode) {
        ctx.fillStyle = 'rgba(0, 255, 0, 0.3)';
        ctx.font = '14px Orbitron';
        ctx.fillText(`Place: ${BUILDINGS[buildMode].icon}`, 10, 20);
      }

      if (recruitMode) {
        ctx.fillStyle = 'rgba(255, 102, 0, 0.3)';
        ctx.font = '14px Orbitron';
        ctx.fillText(`Recruit: ${UNITS[recruitMode].icon}`, 10, 20);
      }
    }

    // Get hex at position
    function getHexAt(px, py) {
      let closest = null;
      let minDist = Infinity;

      hexes.forEach(hex => {
        const dx = px - hex.x;
        const dy = py - hex.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < HEX_SIZE && dist < minDist) {
          minDist = dist;
          closest = hex;
        }
      });

      return closest;
    }

    // Get hex neighbors
    function getNeighbors(hex) {
      const dirs = hex.r % 2 === 0 ?
        [[-1, 0], [0, -1], [1, -1], [1, 0], [1, 1], [0, 1]] :
        [[-1, 0], [-1, -1], [0, -1], [1, 0], [0, 1], [-1, 1]];

      return dirs.map(([dq, dr]) =>
        hexes.find(h => h.q === hex.q + dq && h.r === hex.r + dr)
      ).filter(h => h);
    }

    // Get hexes within range
    function getHexesInRange(hex, range) {
      const result = new Set();
      const visited = new Set([hex]);
      let frontier = [hex];

      for (let i = 0; i < range; i++) {
        const next = [];
        frontier.forEach(h => {
          getNeighbors(h).forEach(n => {
            if (!visited.has(n)) {
              visited.add(n);
              next.push(n);
              result.add(n);
            }
          });
        });
        frontier = next;
      }

      return Array.from(result);
    }

    // Get movable hexes
    function getMovableHexes(hex, range) {
      return getHexesInRange(hex, range).filter(h =>
        TERRAIN[h.terrain].passable !== false &&
        !h.unit &&
        h.terrain !== 'mountain'
      );
    }

    // Get attackable hexes
    function getAttackableHexes(hex, range) {
      return getHexesInRange(hex, range).filter(h =>
        h.unit && h.owner === 'enemy'
      );
    }

    // Handle click
    canvas.addEventListener('click', e => {
      if (gameOver) return;

      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      const hex = getHexAt(x, y);

      if (!hex) return;

      // Build mode
      if (buildMode) {
        if (hex.owner === 'player' && !hex.building && !hex.unit &&
            TERRAIN[hex.terrain].passable !== false && hex.terrain !== 'mountain') {
          const cost = BUILDINGS[buildMode].cost;
          if (canAfford(cost)) {
            spendResources(cost);
            hex.building = { type: buildMode, hp: BUILDINGS[buildMode].hp };
            hex.owner = 'player';
          }
        }
        buildMode = null;
        updateUI();
        draw();
        return;
      }

      // Recruit mode
      if (recruitMode) {
        const playerHexes = hexes.filter(h => h.owner === 'player' && h.building);
        const validHexes = [];
        playerHexes.forEach(h => {
          getNeighbors(h).forEach(n => {
            if (!n.unit && TERRAIN[n.terrain].passable !== false && n.terrain !== 'mountain') {
              validHexes.push(n);
            }
          });
        });

        if (validHexes.includes(hex)) {
          const cost = UNITS[recruitMode].cost;
          if (canAfford(cost)) {
            spendResources(cost);
            hex.unit = { type: recruitMode, hp: UNITS[recruitMode].hp, moved: true, attacked: true };
            hex.owner = 'player';
          }
        }
        recruitMode = null;
        updateUI();
        draw();
        return;
      }

      // Select unit or move
      if (selectedUnit && selectedHex) {
        // Try to attack
        if (hex.unit && hex.owner === 'enemy' && !selectedUnit.attacked) {
          const range = UNITS[selectedUnit.type].range || 1;
          const attackable = getAttackableHexes(selectedHex, range);
          if (attackable.includes(hex)) {
            combat(selectedHex, hex);
            selectedUnit = null;
            selectedHex = null;
            updateUI();
            draw();
            return;
          }
        }

        // Try to move
        if (!selectedUnit.moved) {
          const movable = getMovableHexes(selectedHex, UNITS[selectedUnit.type].move);
          if (movable.includes(hex)) {
            hex.unit = selectedUnit;
            hex.owner = 'player';
            selectedHex.unit = null;
            if (!selectedHex.building) selectedHex.owner = null;
            selectedUnit.moved = true;

            selectedHex = hex;
            updateSelection();
            draw();
            return;
          }
        }
      }

      // Select
      if (hex.unit && hex.owner === 'player') {
        selectedHex = hex;
        selectedUnit = hex.unit;
      } else if (hex.building && hex.owner === 'player') {
        selectedHex = hex;
        selectedUnit = null;
      } else {
        selectedHex = null;
        selectedUnit = null;
      }

      updateSelection();
      draw();
    });

    function combat(attackerHex, defenderHex) {
      const attacker = attackerHex.unit;
      const defender = defenderHex.unit;
      const attackerData = UNITS[attacker.type];
      const defenderData = UNITS[defender.type];

      // Attack
      defender.hp -= attackerData.attack;
      attacker.attacked = true;

      // Check if defender dies
      if (defender.hp <= 0) {
        defenderHex.unit = null;
        if (!defenderHex.building) defenderHex.owner = null;
      } else {
        // Counter attack (if in range)
        const defRange = defenderData.range || 1;
        const dist = getHexesInRange(defenderHex, defRange);
        if (dist.includes(attackerHex)) {
          attacker.hp -= Math.floor(defenderData.attack * 0.5);
          if (attacker.hp <= 0) {
            attackerHex.unit = null;
            if (!attackerHex.building) attackerHex.owner = null;
          }
        }
      }

      checkWinCondition();
    }

    function canAfford(cost) {
      if (!cost) return true;
      for (const [res, amt] of Object.entries(cost)) {
        if (resources[res] < amt) return false;
      }
      return true;
    }

    function spendResources(cost) {
      if (!cost) return;
      for (const [res, amt] of Object.entries(cost)) {
        resources[res] -= amt;
      }
    }

    function updateSelection() {
      const titleEl = document.getElementById('sel-title');
      const statsEl = document.getElementById('sel-stats');

      if (!selectedHex) {
        titleEl.textContent = 'Nothing selected';
        statsEl.textContent = '';
        return;
      }

      if (selectedUnit) {
        const data = UNITS[selectedUnit.type];
        titleEl.textContent = `${data.icon} ${data.name}`;
        statsEl.innerHTML = `HP: ${selectedUnit.hp}/${data.hp}<br>ATK: ${data.attack} | Move: ${data.move}`;
      } else if (selectedHex.building) {
        const data = BUILDINGS[selectedHex.building.type];
        titleEl.textContent = `${data.icon} ${data.name}`;
        statsEl.innerHTML = `HP: ${selectedHex.building.hp}/${data.hp}`;
      } else {
        titleEl.textContent = TERRAIN[selectedHex.terrain].name;
        statsEl.textContent = '';
      }
    }

    function updateUI() {
      document.getElementById('gold').textContent = resources.gold;
      document.getElementById('wood').textContent = resources.wood;
      document.getElementById('food').textContent = resources.food;
      document.getElementById('units').textContent = hexes.filter(h => h.unit && h.owner === 'player').length;
      document.getElementById('turn-num').textContent = turn;

      // Update button states
      document.getElementById('build-mine').disabled = !canAfford({ wood: 50 });
      document.getElementById('build-farm').disabled = !canAfford({ wood: 40 });
      document.getElementById('build-lumber').disabled = !canAfford({ wood: 30 });
      document.getElementById('build-tower').disabled = !canAfford({ wood: 80, gold: 40 });
      document.getElementById('recruit-soldier').disabled = !canAfford({ gold: 30, food: 10 });
      document.getElementById('recruit-archer').disabled = !canAfford({ gold: 40, food: 10 });
    }

    function startBuild(type) {
      buildMode = type;
      recruitMode = null;
    }

    function startRecruit(type) {
      recruitMode = type;
      buildMode = null;
    }

    function endTurn() {
      // Collect resources
      hexes.forEach(hex => {
        if (hex.owner === 'player' && hex.building) {
          const b = BUILDINGS[hex.building.type];
          if (b.gold) resources.gold += b.gold;
          if (b.wood) resources.wood += b.wood;
          if (b.food) resources.food += b.food;
        }
        if (hex.owner === 'player' && hex.terrain === 'forest') {
          resources.wood += 3;
        }
      });

      // Reset units
      hexes.forEach(hex => {
        if (hex.unit) {
          hex.unit.moved = false;
          hex.unit.attacked = false;
        }
      });

      // Enemy turn
      enemyTurn();

      turn++;
      selectedHex = null;
      selectedUnit = null;
      updateSelection();
      updateUI();
      draw();
    }

    function enemyTurn() {
      const enemyUnits = hexes.filter(h => h.unit && h.owner === 'enemy');
      const playerBase = hexes.find(h => h.building?.type === 'base' && h.owner === 'player');

      enemyUnits.forEach(hex => {
        const unit = hex.unit;
        const unitData = UNITS[unit.type];

        // Try to attack nearby player units/buildings
        const range = unitData.range || 1;
        const targets = getHexesInRange(hex, range).filter(h =>
          (h.unit || h.building) && h.owner === 'player'
        );

        if (targets.length > 0) {
          const target = targets[0];
          if (target.unit) {
            target.unit.hp -= unitData.attack;
            if (target.unit.hp <= 0) {
              target.unit = null;
              if (!target.building) target.owner = null;
            }
          } else if (target.building) {
            target.building.hp -= unitData.attack;
            if (target.building.hp <= 0) {
              target.building = null;
              target.owner = null;
            }
          }
        } else {
          // Move towards player base
          if (playerBase) {
            const movable = getMovableHexes(hex, unitData.move);
            if (movable.length > 0) {
              // Find closest to player base
              movable.sort((a, b) => {
                const distA = Math.abs(a.q - playerBase.q) + Math.abs(a.r - playerBase.r);
                const distB = Math.abs(b.q - playerBase.q) + Math.abs(b.r - playerBase.r);
                return distA - distB;
              });
              const target = movable[0];
              target.unit = unit;
              target.owner = 'enemy';
              hex.unit = null;
              if (!hex.building) hex.owner = null;
            }
          }
        }
      });

      // Spawn enemy unit every 5 turns
      if (turn % 5 === 0) {
        const enemyBase = hexes.find(h => h.building?.type === 'base' && h.owner === 'enemy');
        if (enemyBase) {
          const spawnHexes = getNeighbors(enemyBase).filter(h =>
            !h.unit && TERRAIN[h.terrain].passable !== false
          );
          if (spawnHexes.length > 0) {
            const spawn = spawnHexes[Math.floor(Math.random() * spawnHexes.length)];
            spawn.unit = { type: 'soldier', hp: 50, moved: true, attacked: true };
            spawn.owner = 'enemy';
          }
        }
      }

      checkWinCondition();
    }

    function checkWinCondition() {
      const playerBase = hexes.find(h => h.building?.type === 'base' && h.owner === 'player');
      const enemyBase = hexes.find(h => h.building?.type === 'base' && h.owner === 'enemy');

      if (!playerBase || (playerBase.building && playerBase.building.hp <= 0)) {
        showMessage('DEFEAT', 'Your base was destroyed!');
        gameOver = true;
      } else if (!enemyBase || (enemyBase.building && enemyBase.building.hp <= 0)) {
        showMessage('VICTORY', 'You conquered the enemy!');
        gameOver = true;
      }
    }

    function showMessage(title, text) {
      document.getElementById('msg-title').textContent = title;
      document.getElementById('msg-text').textContent = text;
      document.getElementById('message').style.display = 'block';
    }

    function restartGame() {
      document.getElementById('message').style.display = 'none';
      gameOver = false;
      turn = 1;
      resources = { gold: 100, wood: 50, food: 50 };
      selectedHex = null;
      selectedUnit = null;
      initGrid();
      updateUI();
      draw();
    }

    // Expose functions
    window.startBuild = startBuild;
    window.startRecruit = startRecruit;
    window.endTurn = endTurn;
    window.restartGame = restartGame;

    // Init
    initGrid();
    updateUI();
    draw();
  </script>
<script src="/sloppy-header/sloppy-bar.js"></script>
</body>
</html>
