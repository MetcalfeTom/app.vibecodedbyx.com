<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genealogist - DNA Heritage Archive</title>
    <meta property="og:title" content="Genealogist - DNA Heritage Archive">
    <meta property="og:description" content="Visualize the genetic lineage of forked content across the Archive of Synthesis">
    <meta property="og:url" content="https://app.sloppy.live/genealogist">
    <meta property="og:image" content="https://app.sloppy.live/genealogist/og-image.png">
    <link rel="icon" href="https://emojicdn.elk.sh/%F0%9F%A7%AC" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #111118;
            --bg-panel: #0d0d14;
            --border-dim: rgba(0, 255, 136, 0.15);
            --border-active: rgba(0, 255, 136, 0.4);
            --text-primary: #e0e0e8;
            --text-dim: rgba(255, 255, 255, 0.5);
            --text-muted: rgba(255, 255, 255, 0.3);
            --neon-green: #0f8;
            --neon-magenta: #f0f;
            --neon-cyan: #0cf;
            --neon-orange: #f80;
            --nucleotide-A: #0f0;
            --nucleotide-T: #f80;
            --nucleotide-C: #08f;
            --nucleotide-G: #f0f;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Header */
        .header {
            padding: 12px 20px;
            background: linear-gradient(180deg, rgba(0, 255, 136, 0.08) 0%, transparent 100%);
            border-bottom: 1px solid var(--border-dim);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-title .helix {
            font-size: 24px;
            animation: helixPulse 2s ease-in-out infinite;
        }

        @keyframes helixPulse {
            0%, 100% { transform: scale(1) rotate(0deg); opacity: 1; }
            50% { transform: scale(1.1) rotate(10deg); opacity: 0.8; }
        }

        .header-title h1 {
            font-size: 16px;
            font-weight: 500;
            letter-spacing: 2px;
            text-transform: uppercase;
            background: linear-gradient(90deg, var(--neon-green), var(--neon-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-subtitle {
            font-size: 10px;
            color: var(--text-dim);
            letter-spacing: 1px;
        }

        .header-controls {
            display: flex;
            gap: 8px;
        }

        .tab-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--border-dim);
            color: var(--text-dim);
            font-family: inherit;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .tab-btn:hover {
            border-color: var(--border-active);
            color: var(--text-primary);
        }

        .tab-btn.active {
            background: rgba(0, 255, 136, 0.1);
            border-color: var(--neon-green);
            color: var(--neon-green);
        }

        .search-box {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 10px;
            background: var(--bg-card);
            border: 1px solid var(--border-dim);
        }

        .search-box input {
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 12px;
            width: 120px;
            outline: none;
        }

        .search-box input::placeholder {
            color: var(--text-muted);
        }

        /* Main content */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Tree panel */
        .tree-panel {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: radial-gradient(ellipse at center, rgba(0, 255, 136, 0.03) 0%, transparent 70%);
        }

        .tree-svg {
            width: 100%;
            height: 100%;
            cursor: grab;
        }

        .tree-svg:active {
            cursor: grabbing;
        }

        /* Tree nodes */
        .tree-node {
            cursor: pointer;
            transition: transform 0.2s;
        }

        .tree-node:hover {
            transform: scale(1.05);
        }

        .node-body {
            fill: var(--bg-card);
            stroke: var(--border-dim);
            stroke-width: 1;
            transition: all 0.2s;
        }

        .tree-node:hover .node-body,
        .tree-node.selected .node-body {
            stroke: var(--neon-green);
            stroke-width: 2;
            filter: drop-shadow(0 0 8px rgba(0, 255, 136, 0.3));
        }

        .tree-node.selected .node-body {
            fill: rgba(0, 255, 136, 0.1);
        }

        .node-connector {
            fill: none;
            stroke: var(--border-dim);
            stroke-width: 1.5;
            stroke-dasharray: 4 2;
        }

        .node-connector.highlighted {
            stroke: var(--neon-green);
            stroke-width: 2;
            stroke-dasharray: none;
        }

        .node-helix {
            font-size: 14px;
        }

        .node-code {
            fill: var(--text-dim);
            font-size: 10px;
            font-family: 'JetBrains Mono', monospace;
        }

        .node-title {
            fill: var(--text-primary);
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
        }

        .nucleotide-A { fill: var(--nucleotide-A); }
        .nucleotide-T { fill: var(--nucleotide-T); }
        .nucleotide-C { fill: var(--nucleotide-C); }
        .nucleotide-G { fill: var(--nucleotide-G); }

        .node-children-badge {
            fill: var(--bg-dark);
            stroke: var(--neon-magenta);
            stroke-width: 1;
        }

        .node-children-count {
            fill: var(--neon-magenta);
            font-size: 9px;
            font-family: 'JetBrains Mono', monospace;
        }

        /* Detail panel */
        .detail-panel {
            width: 300px;
            background: var(--bg-panel);
            border-left: 1px solid var(--border-dim);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .detail-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-dim);
            background: linear-gradient(180deg, rgba(0, 255, 136, 0.05) 0%, transparent 100%);
        }

        .detail-header h2 {
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--neon-green);
            margin-bottom: 4px;
        }

        .detail-header .node-type {
            font-size: 10px;
            color: var(--text-dim);
        }

        .detail-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .detail-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            text-align: center;
            padding: 20px;
        }

        .detail-empty .helix {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .detail-section {
            margin-bottom: 20px;
        }

        .detail-label {
            font-size: 9px;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .detail-value {
            font-size: 13px;
            color: var(--text-primary);
            word-break: break-word;
        }

        .dna-full {
            background: linear-gradient(90deg, rgba(0, 255, 136, 0.1), rgba(0, 255, 255, 0.1));
            padding: 10px;
            border: 1px solid var(--border-dim);
            font-size: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            align-items: center;
        }

        .dna-full .separator {
            color: var(--text-muted);
            margin: 0 2px;
        }

        .dna-full .lineage-code {
            color: var(--neon-cyan);
        }

        .dna-full .generation {
            color: var(--neon-orange);
        }

        .dna-full .marker {
            color: var(--neon-magenta);
        }

        .dna-nucleotide {
            font-weight: 600;
        }

        .dna-nucleotide.A { color: var(--nucleotide-A); }
        .dna-nucleotide.T { color: var(--nucleotide-T); }
        .dna-nucleotide.C { color: var(--nucleotide-C); }
        .dna-nucleotide.G { color: var(--nucleotide-G); }

        .detail-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .meta-item {
            background: var(--bg-card);
            padding: 10px;
            border: 1px solid var(--border-dim);
        }

        .meta-item .label {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .meta-item .value {
            font-size: 12px;
            color: var(--text-primary);
            margin-top: 4px;
        }

        .lineage-info {
            background: var(--bg-card);
            padding: 12px;
            border: 1px solid var(--border-dim);
        }

        .lineage-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-dim);
        }

        .lineage-row:last-child {
            border-bottom: none;
        }

        .lineage-row .label {
            font-size: 10px;
            color: var(--text-dim);
        }

        .lineage-row .value {
            font-size: 11px;
        }

        .lineage-row .value.parent {
            color: var(--neon-orange);
            cursor: pointer;
        }

        .lineage-row .value.parent:hover {
            text-decoration: underline;
        }

        .lineage-row .value.children {
            color: var(--neon-cyan);
        }

        .view-btn {
            display: block;
            width: 100%;
            padding: 10px;
            background: transparent;
            border: 1px solid var(--neon-green);
            color: var(--neon-green);
            font-family: inherit;
            font-size: 11px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
            text-align: center;
            text-decoration: none;
            margin-top: 12px;
        }

        .view-btn:hover {
            background: rgba(0, 255, 136, 0.1);
        }

        /* Footer */
        .footer {
            padding: 8px 20px;
            border-top: 1px solid var(--border-dim);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 10px;
            color: var(--text-muted);
        }

        .footer a {
            color: var(--neon-green);
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .stats {
            display: flex;
            gap: 16px;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat .num {
            color: var(--neon-cyan);
        }

        /* Loading state */
        .loading {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-dark);
            z-index: 100;
        }

        .loading .helix {
            font-size: 64px;
            animation: helixSpin 1s linear infinite;
        }

        @keyframes helixSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 16px;
            font-size: 12px;
            color: var(--text-dim);
            letter-spacing: 2px;
        }

        /* Zoom controls */
        .zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .zoom-btn {
            width: 32px;
            height: 32px;
            background: var(--bg-card);
            border: 1px solid var(--border-dim);
            color: var(--text-primary);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .zoom-btn:hover {
            border-color: var(--neon-green);
            color: var(--neon-green);
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .header {
                flex-wrap: wrap;
                padding: 10px;
            }

            .header-controls {
                width: 100%;
                overflow-x: auto;
                padding-bottom: 4px;
            }

            .search-box {
                display: none;
            }

            .main-content {
                flex-direction: column;
            }

            .detail-panel {
                width: 100%;
                height: 40%;
                border-left: none;
                border-top: 1px solid var(--border-dim);
            }

            .tree-panel {
                height: 60%;
            }

            .zoom-controls {
                bottom: 10px;
                right: 10px;
            }
        }

        /* Empty state */
        .empty-tree {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
        }

        .empty-tree .helix {
            font-size: 80px;
            opacity: 0.2;
            margin-bottom: 20px;
        }

        .empty-tree p {
            font-size: 12px;
            text-align: center;
            max-width: 300px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="header-title">
                <span class="helix">üß¨</span>
                <div>
                    <h1>Genealogist</h1>
                    <div class="header-subtitle">Content DNA Heritage Archive</div>
                </div>
            </div>
            <div class="header-controls">
                <button class="tab-btn active" data-tab="manifestos">Manifestos</button>
                <button class="tab-btn" data-tab="cross-type">Cross-Type</button>
                <button class="tab-btn" data-tab="stats">Stats</button>
            </div>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search DNA...">
                <span>üîç</span>
            </div>
        </header>

        <main class="main-content">
            <div class="tree-panel" id="treePanel">
                <div class="loading" id="loading">
                    <span class="helix">üß¨</span>
                    <div class="loading-text">SEQUENCING HERITAGE...</div>
                </div>
                <svg class="tree-svg" id="treeSvg"></svg>
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoomIn">+</button>
                    <button class="zoom-btn" id="zoomOut">‚àí</button>
                    <button class="zoom-btn" id="zoomReset">‚åÇ</button>
                </div>
            </div>

            <aside class="detail-panel">
                <div class="detail-header">
                    <h2>Selected Node</h2>
                    <div class="node-type" id="detailType">-</div>
                </div>
                <div class="detail-content" id="detailContent">
                    <div class="detail-empty">
                        <span class="helix">üß¨</span>
                        <p>Select a node in the tree to view its DNA signature and lineage details</p>
                    </div>
                </div>
            </aside>
        </main>

        <footer class="footer">
            <a href="https://sloppy.live">‚Ü© sloppy.live</a>
            <div class="stats">
                <span class="stat">Nodes: <span class="num" id="totalNodes">0</span></span>
                <span class="stat">Lineages: <span class="num" id="totalLineages">0</span></span>
                <span class="stat">Depth: <span class="num" id="maxDepth">0</span></span>
            </div>
        </footer>
    </div>

    <script type="module">
        import { createBrowserClient } from "https://cdn.jsdelivr.net/npm/@supabase/ssr@0.7.0/+esm";

        const SUPABASE_URL = 'https://yjyxteqzhhmtrgcaekgz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM8IS32IUYR2eenCCjdDdioiBU';

        const getCookieDomain = () => {
            const hostname = window.location.hostname;
            if (hostname.includes('sloppy.live')) return '.sloppy.live';
            if (hostname.includes('vibecodedbyx.com')) return '.vibecodedbyx.com';
            return '.youreabsolutelyright.xyz';
        };

        const supabase = createBrowserClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            cookieOptions: {
                name: 'sb-auth-token',
                domain: getCookieDomain(),
                path: '/',
                sameSite: 'lax',
            },
        });

        // === DNA GENERATION FUNCTIONS ===

        function generateContentDNA(entity, type = 'msg') {
            const nucleotides = ['A', 'T', 'C', 'G'];
            const prefixes = { msg: 'M', doodle: 'D', post: 'P', manifesto: 'X' };

            let seed = (entity.id || 0) * 7919;
            const content = entity.content || entity.caption || entity.title || '';
            seed += content.split('').reduce((a, c) => a + c.charCodeAt(0), 0);
            seed += new Date(entity.created_at || Date.now()).getTime() % 100000;

            const seededRandom = () => {
                seed = (seed * 1103515245 + 12345) & 0x7fffffff;
                return seed / 0x7fffffff;
            };

            let dna = '';
            for (let i = 0; i < 8; i++) {
                if (i === 4) dna += '-';
                dna += nucleotides[Math.floor(seededRandom() * 4)];
            }

            const prefix = prefixes[type] || 'U';
            const idStr = String(entity.id || 0).padStart(4, '0');

            return {
                sequence: dna,
                code: `${prefix}${idStr}`,
                full: `${prefix}${idStr}::${dna}`
            };
        }

        function generateDNASignature(manifesto) {
            const nucleotides = ['A', 'T', 'C', 'G'];
            const markers = ['Œ±', 'Œ≤', 'Œ≥', 'Œ¥', 'Œµ', 'Œ∂', 'Œ∑', 'Œ∏'];

            let seed = manifesto.id * 7919;
            seed += (manifesto.title || '').split('').reduce((a, c) => a + c.charCodeAt(0), 0);
            seed += new Date(manifesto.created_at).getTime() % 100000;

            const seededRandom = () => {
                seed = (seed * 1103515245 + 12345) & 0x7fffffff;
                return seed / 0x7fffffff;
            };

            let dna = '';
            for (let i = 0; i < 12; i++) {
                if (i > 0 && i % 4 === 0) dna += '-';
                dna += nucleotides[Math.floor(seededRandom() * 4)];
            }

            const contentLen = (manifesto.content || '').length;
            const markerIdx = Math.floor((contentLen / 50) % markers.length);
            const structuralMarker = markers[markerIdx];

            const authorHash = (manifesto.username || 'anon').split('').reduce((a, c) => a + c.charCodeAt(0), 0);
            const lineageCode = String.fromCharCode(65 + (authorHash % 26)) + String.fromCharCode(65 + ((authorHash * 7) % 26));

            const generation = 'G' + String(manifesto.id).padStart(3, '0');

            return {
                sequence: dna,
                marker: structuralMarker,
                lineage: lineageCode,
                generation: generation,
                full: `${lineageCode}::${generation}::${structuralMarker}::${dna}`
            };
        }

        // === STATE ===
        let manifestos = [];
        let lineageMap = {}; // { manifestoId: { parentId, forkType } }
        let childrenMap = {}; // { parentId: [childIds] }
        let treeNodes = [];
        let selectedNode = null;
        let currentTab = 'manifestos';

        // SVG pan/zoom state
        let viewBox = { x: 0, y: 0, width: 1200, height: 800 };
        let isPanning = false;
        let panStart = { x: 0, y: 0 };
        let zoom = 1;

        // === DATA LOADING ===

        async function initAuth() {
            const sessRes = await supabase.auth.getSession();
            if (!sessRes.data.session) {
                await supabase.auth.signInAnonymously();
            }
        }

        async function loadData() {
            try {
                // Load manifestos
                const { data: manifestoData, error: mError } = await supabase
                    .from('sloppygram_manifestos')
                    .select('*')
                    .order('created_at', { ascending: true });

                if (mError) throw mError;
                manifestos = manifestoData || [];

                // Load lineage
                const { data: lineageData, error: lError } = await supabase
                    .from('sloppygram_manifesto_lineage')
                    .select('*');

                if (!lError && lineageData) {
                    lineageMap = {};
                    childrenMap = {};
                    lineageData.forEach(l => {
                        lineageMap[l.manifesto_id] = { parentId: l.parent_id, forkType: l.fork_type };
                        if (!childrenMap[l.parent_id]) childrenMap[l.parent_id] = [];
                        childrenMap[l.parent_id].push(l.manifesto_id);
                    });
                }

                buildTree();
                renderTree();
                updateStats();
                document.getElementById('loading').style.display = 'none';

            } catch (err) {
                console.error('Failed to load data:', err);
                document.querySelector('.loading-text').textContent = 'FAILED TO SEQUENCE';
            }
        }

        // === TREE BUILDING ===

        function buildTree() {
            treeNodes = [];

            // Find root nodes (no parent)
            const rootManifestos = manifestos.filter(m => !lineageMap[m.id]);

            // Build tree recursively
            function addNode(manifesto, depth, parentNode) {
                const dna = generateDNASignature(manifesto);
                const simpleDna = generateContentDNA(manifesto, 'manifesto');
                const children = childrenMap[manifesto.id] || [];

                const node = {
                    id: manifesto.id,
                    type: 'manifesto',
                    manifesto: manifesto,
                    dna: dna,
                    simpleDna: simpleDna,
                    depth: depth,
                    parentId: parentNode ? parentNode.id : null,
                    children: [],
                    childCount: children.length,
                    x: 0,
                    y: 0
                };

                treeNodes.push(node);

                // Add children recursively
                children.forEach(childId => {
                    const childManifesto = manifestos.find(m => m.id === childId);
                    if (childManifesto) {
                        const childNode = addNode(childManifesto, depth + 1, node);
                        node.children.push(childNode);
                    }
                });

                return node;
            }

            rootManifestos.forEach(m => addNode(m, 0, null));
        }

        // === TREE LAYOUT ===

        function calculateLayout() {
            const nodeWidth = 140;
            const nodeHeight = 60;
            const horizontalGap = 40;
            const verticalGap = 80;

            // Group by depth
            const depthGroups = {};
            let maxDepth = 0;

            treeNodes.forEach(node => {
                if (!depthGroups[node.depth]) depthGroups[node.depth] = [];
                depthGroups[node.depth].push(node);
                maxDepth = Math.max(maxDepth, node.depth);
            });

            // Position nodes
            Object.keys(depthGroups).forEach(depth => {
                const nodes = depthGroups[depth];
                const totalWidth = nodes.length * nodeWidth + (nodes.length - 1) * horizontalGap;
                const startX = (viewBox.width - totalWidth) / 2;

                nodes.forEach((node, i) => {
                    node.x = startX + i * (nodeWidth + horizontalGap) + nodeWidth / 2;
                    node.y = 80 + parseInt(depth) * (nodeHeight + verticalGap);
                    node.width = nodeWidth;
                    node.height = nodeHeight;
                });
            });

            // Center children under their parent
            for (let d = maxDepth - 1; d >= 0; d--) {
                const nodes = depthGroups[d] || [];
                nodes.forEach(node => {
                    if (node.children.length > 0) {
                        const childXs = node.children.map(c => c.x);
                        const centerX = (Math.min(...childXs) + Math.max(...childXs)) / 2;
                        // Don't move parent, keep original position
                    }
                });
            }
        }

        // === TREE RENDERING ===

        function renderTree() {
            calculateLayout();

            const svg = document.getElementById('treeSvg');
            svg.innerHTML = '';

            if (treeNodes.length === 0) {
                // Empty state
                const panel = document.getElementById('treePanel');
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'empty-tree';
                emptyDiv.innerHTML = `
                    <span class="helix">üß¨</span>
                    <p>No manifesto lineages found yet. Fork a manifesto in the Archive of Synthesis to start building the heritage tree.</p>
                `;
                panel.appendChild(emptyDiv);
                return;
            }

            // Set viewBox
            svg.setAttribute('viewBox', `${viewBox.x} ${viewBox.y} ${viewBox.width} ${viewBox.height}`);

            // Create defs for gradients
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            defs.innerHTML = `
                <linearGradient id="nodeGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:rgba(0,255,136,0.1)"/>
                    <stop offset="100%" style="stop-color:rgba(0,0,0,0)"/>
                </linearGradient>
            `;
            svg.appendChild(defs);

            // Draw connections first (behind nodes)
            treeNodes.forEach(node => {
                if (node.parentId) {
                    const parent = treeNodes.find(n => n.id === node.parentId);
                    if (parent) {
                        drawConnection(svg, parent, node);
                    }
                }
            });

            // Draw nodes
            treeNodes.forEach(node => {
                drawNode(svg, node);
            });
        }

        function drawConnection(svg, parent, child) {
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');

            const startX = parent.x;
            const startY = parent.y + parent.height / 2;
            const endX = child.x;
            const endY = child.y - child.height / 2;

            const midY = (startY + endY) / 2;

            path.setAttribute('d', `M ${startX} ${startY} C ${startX} ${midY}, ${endX} ${midY}, ${endX} ${endY}`);
            path.setAttribute('class', 'node-connector');
            path.setAttribute('data-parent', parent.id);
            path.setAttribute('data-child', child.id);

            svg.appendChild(path);
        }

        function drawNode(svg, node) {
            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.setAttribute('class', 'tree-node');
            g.setAttribute('data-id', node.id);
            g.setAttribute('transform', `translate(${node.x - node.width/2}, ${node.y - node.height/2})`);

            // Node body
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('class', 'node-body');
            rect.setAttribute('width', node.width);
            rect.setAttribute('height', node.height);
            rect.setAttribute('rx', 4);
            g.appendChild(rect);

            // Helix icon
            const helix = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            helix.setAttribute('class', 'node-helix');
            helix.setAttribute('x', 8);
            helix.setAttribute('y', 20);
            helix.textContent = 'üß¨';
            g.appendChild(helix);

            // DNA code
            const code = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            code.setAttribute('class', 'node-code');
            code.setAttribute('x', 28);
            code.setAttribute('y', 18);
            code.textContent = node.simpleDna.code;
            g.appendChild(code);

            // Title (truncated)
            const title = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            title.setAttribute('class', 'node-title');
            title.setAttribute('x', 8);
            title.setAttribute('y', 36);
            const titleText = node.manifesto.title || 'Untitled';
            title.textContent = titleText.length > 16 ? titleText.substring(0, 14) + '...' : titleText;
            g.appendChild(title);

            // Nucleotide sequence
            const nuclGroup = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            nuclGroup.setAttribute('x', 8);
            nuclGroup.setAttribute('y', 52);
            nuclGroup.setAttribute('font-size', '9');
            nuclGroup.setAttribute('font-family', 'JetBrains Mono, monospace');

            const seq = node.dna.sequence.replace(/-/g, '');
            seq.split('').forEach((char, i) => {
                const tspan = document.createElementNS('http://www.w3.org/2000/svg', 'tspan');
                tspan.setAttribute('class', `nucleotide-${char}`);
                tspan.textContent = char;
                nuclGroup.appendChild(tspan);
                if (i === 3 || i === 7) {
                    const sep = document.createElementNS('http://www.w3.org/2000/svg', 'tspan');
                    sep.setAttribute('fill', 'rgba(255,255,255,0.3)');
                    sep.textContent = '-';
                    nuclGroup.appendChild(sep);
                }
            });
            g.appendChild(nuclGroup);

            // Children badge
            if (node.childCount > 0) {
                const badgeG = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                badgeG.setAttribute('transform', `translate(${node.width - 20}, -8)`);

                const badge = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                badge.setAttribute('class', 'node-children-badge');
                badge.setAttribute('cx', 10);
                badge.setAttribute('cy', 10);
                badge.setAttribute('r', 10);
                badgeG.appendChild(badge);

                const countText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                countText.setAttribute('class', 'node-children-count');
                countText.setAttribute('x', 10);
                countText.setAttribute('y', 13);
                countText.setAttribute('text-anchor', 'middle');
                countText.textContent = node.childCount;
                badgeG.appendChild(countText);

                g.appendChild(badgeG);
            }

            // Click handler
            g.addEventListener('click', () => selectNode(node));

            svg.appendChild(g);
        }

        // === SELECTION & DETAIL ===

        function selectNode(node) {
            // Update visual selection
            document.querySelectorAll('.tree-node').forEach(el => el.classList.remove('selected'));
            const nodeEl = document.querySelector(`.tree-node[data-id="${node.id}"]`);
            if (nodeEl) nodeEl.classList.add('selected');

            // Highlight lineage path
            document.querySelectorAll('.node-connector').forEach(el => el.classList.remove('highlighted'));
            highlightLineage(node);

            selectedNode = node;
            renderDetail(node);
        }

        function highlightLineage(node) {
            // Highlight path to root
            let current = node;
            while (current && current.parentId) {
                const connector = document.querySelector(`.node-connector[data-child="${current.id}"]`);
                if (connector) connector.classList.add('highlighted');
                current = treeNodes.find(n => n.id === current.parentId);
            }

            // Highlight children paths
            function highlightChildren(n) {
                n.children.forEach(child => {
                    const connector = document.querySelector(`.node-connector[data-child="${child.id}"]`);
                    if (connector) connector.classList.add('highlighted');
                    highlightChildren(child);
                });
            }
            highlightChildren(node);
        }

        function renderDetail(node) {
            const content = document.getElementById('detailContent');
            const typeEl = document.getElementById('detailType');

            typeEl.textContent = `Manifesto ‚Ä¢ ${node.dna.generation}`;

            const parentNode = node.parentId ? treeNodes.find(n => n.id === node.parentId) : null;
            const created = new Date(node.manifesto.created_at).toLocaleDateString();

            // Build nucleotide HTML
            const nuclHtml = node.dna.sequence.split('').map(char => {
                if (char === '-') return '<span class="separator">-</span>';
                return `<span class="dna-nucleotide ${char}">${char}</span>`;
            }).join('');

            content.innerHTML = `
                <div class="detail-section">
                    <div class="detail-label">DNA Signature</div>
                    <div class="dna-full">
                        <span class="lineage-code">${node.dna.lineage}</span>
                        <span class="separator">::</span>
                        <span class="generation">${node.dna.generation}</span>
                        <span class="separator">::</span>
                        <span class="marker">${node.dna.marker}</span>
                        <span class="separator">::</span>
                        ${nuclHtml}
                    </div>
                </div>

                <div class="detail-section">
                    <div class="detail-label">Title</div>
                    <div class="detail-value">${escapeHtml(node.manifesto.title || 'Untitled')}</div>
                </div>

                <div class="detail-section">
                    <div class="detail-meta">
                        <div class="meta-item">
                            <div class="label">Author</div>
                            <div class="value">${escapeHtml(node.manifesto.username || 'Anonymous')}</div>
                        </div>
                        <div class="meta-item">
                            <div class="label">Created</div>
                            <div class="value">${created}</div>
                        </div>
                        <div class="meta-item">
                            <div class="label">Depth</div>
                            <div class="value">Level ${node.depth}</div>
                        </div>
                        <div class="meta-item">
                            <div class="label">Upvotes</div>
                            <div class="value">${node.manifesto.upvotes || 0}</div>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <div class="detail-label">Lineage</div>
                    <div class="lineage-info">
                        <div class="lineage-row">
                            <span class="label">Parent</span>
                            <span class="value ${parentNode ? 'parent' : ''}" ${parentNode ? `onclick="jumpToNode(${parentNode.id})"` : ''}>
                                ${parentNode ? parentNode.dna.generation : 'Root (Origin)'}
                            </span>
                        </div>
                        <div class="lineage-row">
                            <span class="label">Children</span>
                            <span class="value children">${node.childCount} fork${node.childCount !== 1 ? 's' : ''}</span>
                        </div>
                        <div class="lineage-row">
                            <span class="label">Fork Type</span>
                            <span class="value">${lineageMap[node.id]?.forkType || 'Origin'}</span>
                        </div>
                    </div>
                </div>

                <a href="https://app.sloppy.live/sloppygram#manifesto-${node.id}" target="_blank" class="view-btn">
                    View in Archive ‚Üí
                </a>
            `;
        }

        window.jumpToNode = function(nodeId) {
            const node = treeNodes.find(n => n.id === nodeId);
            if (node) selectNode(node);
        };

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // === STATS ===

        function updateStats() {
            document.getElementById('totalNodes').textContent = treeNodes.length;
            document.getElementById('totalLineages').textContent = Object.keys(lineageMap).length;

            let maxDepth = 0;
            treeNodes.forEach(n => { maxDepth = Math.max(maxDepth, n.depth); });
            document.getElementById('maxDepth').textContent = maxDepth + 1;
        }

        // === PAN & ZOOM ===

        function setupPanZoom() {
            const svg = document.getElementById('treeSvg');
            const panel = document.getElementById('treePanel');

            // Mouse pan
            svg.addEventListener('mousedown', (e) => {
                if (e.target === svg || e.target.tagName === 'rect') {
                    isPanning = true;
                    panStart = { x: e.clientX, y: e.clientY };
                    svg.style.cursor = 'grabbing';
                }
            });

            window.addEventListener('mousemove', (e) => {
                if (!isPanning) return;
                const dx = (e.clientX - panStart.x) / zoom;
                const dy = (e.clientY - panStart.y) / zoom;
                viewBox.x -= dx;
                viewBox.y -= dy;
                panStart = { x: e.clientX, y: e.clientY };
                svg.setAttribute('viewBox', `${viewBox.x} ${viewBox.y} ${viewBox.width} ${viewBox.height}`);
            });

            window.addEventListener('mouseup', () => {
                isPanning = false;
                svg.style.cursor = 'grab';
            });

            // Wheel zoom
            panel.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 1.1 : 0.9;
                applyZoom(delta, e.clientX, e.clientY);
            });

            // Zoom buttons
            document.getElementById('zoomIn').addEventListener('click', () => applyZoom(0.8));
            document.getElementById('zoomOut').addEventListener('click', () => applyZoom(1.2));
            document.getElementById('zoomReset').addEventListener('click', resetView);
        }

        function applyZoom(factor, cx, cy) {
            const newWidth = viewBox.width * factor;
            const newHeight = viewBox.height * factor;

            if (newWidth < 400 || newWidth > 4000) return;

            // Zoom toward center or mouse position
            const centerX = cx ? (viewBox.x + viewBox.width / 2) : viewBox.x + viewBox.width / 2;
            const centerY = cy ? (viewBox.y + viewBox.height / 2) : viewBox.y + viewBox.height / 2;

            viewBox.x = centerX - newWidth / 2;
            viewBox.y = centerY - newHeight / 2;
            viewBox.width = newWidth;
            viewBox.height = newHeight;
            zoom = 1200 / newWidth;

            document.getElementById('treeSvg').setAttribute('viewBox',
                `${viewBox.x} ${viewBox.y} ${viewBox.width} ${viewBox.height}`);
        }

        function resetView() {
            viewBox = { x: 0, y: 0, width: 1200, height: 800 };
            zoom = 1;
            document.getElementById('treeSvg').setAttribute('viewBox',
                `${viewBox.x} ${viewBox.y} ${viewBox.width} ${viewBox.height}`);
        }

        // === TABS ===

        function setupTabs() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentTab = btn.dataset.tab;
                    // For now, only manifestos tab is implemented
                    if (currentTab !== 'manifestos') {
                        alert('Coming soon: ' + currentTab + ' view');
                        btn.classList.remove('active');
                        document.querySelector('[data-tab="manifestos"]').classList.add('active');
                    }
                });
            });
        }

        // === SEARCH ===

        function setupSearch() {
            const input = document.getElementById('searchInput');
            input.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                if (!query) {
                    document.querySelectorAll('.tree-node').forEach(el => el.style.opacity = 1);
                    return;
                }

                treeNodes.forEach(node => {
                    const el = document.querySelector(`.tree-node[data-id="${node.id}"]`);
                    if (!el) return;

                    const matches =
                        node.dna.full.toLowerCase().includes(query) ||
                        (node.manifesto.title || '').toLowerCase().includes(query) ||
                        (node.manifesto.username || '').toLowerCase().includes(query);

                    el.style.opacity = matches ? 1 : 0.2;
                });
            });
        }

        // === INIT ===

        async function init() {
            await initAuth();
            setupPanZoom();
            setupTabs();
            setupSearch();
            await loadData();
        }

        init();
    </script>
<script src="/sloppy-header/sloppy-bar.js"></script>
</body>
</html>
