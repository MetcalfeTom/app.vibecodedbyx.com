<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vibe Livestream Hub ‚Äì Watch + Chat + Prompt</title>
  <meta name="description" content="Watch the VibeCodedByX livestream, chat in real time, and build prompts from chat messages to drive development." />
  <link rel="icon" href="https://emojicdn.elk.sh/üé•" type="image/png" />

  <!-- Open Graph -->
  <meta property="og:title" content="Vibe Livestream Hub ‚Äì Watch + Chat + Prompt" />
  <meta property="og:description" content="Watch the stream, chat live, and build prompts from chat messages." />
  <meta property="og:url" content="https://app.vibecodedbyx.com/livestream-hub" />
  <meta property="og:image" content="https://app.vibecodedbyx.com/livestream-hub/preview.png" />

  <style>
    :root {
      --bg1: #0b0c10;
      --bg2: #11131a;
      --panel: #171923;
      --muted: #a0aec0;
      --primary: #4dabf7;
      --ok: #69db7c;
      --danger: #ff8787;
      --border: #2a2e3a;
      --text: #e6edf3;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      display: flex;
      flex-direction: column;
    }
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 16px; border-bottom: 1px solid var(--border);
      background: rgba(0,0,0,0.25);
    }
    .title { font-weight: 800; letter-spacing: 0.2px; }
    .actions { display:flex; gap: 8px; align-items:center; }
    .btn {
      padding: 10px 14px; border: 1px solid var(--border); border-radius: 10px;
      background: #1f2330; color: #fff; cursor: pointer; font-weight: 700;
    }
    .btn.primary { background: var(--primary); border-color: #368df0; }
    .btn.primary:hover { filter: brightness(1.05); }
    .btn:hover { filter: brightness(1.08); }
    .link { color: var(--ok); text-decoration: none; font-weight: 700; }
    .link:hover { text-decoration: underline; }

    main { display: grid; grid-template-columns: 1.1fr 0.9fr; gap: 14px; padding: 14px; flex: 1; min-height: 0; }
    @media (max-width: 900px) {
      main { grid-template-columns: 1fr; }
    }

    .panel { background: var(--panel); border:1px solid var(--border); border-radius: 14px; display: flex; flex-direction: column; min-height: 0; }
    .panel h2 { margin: 0; padding: 12px 14px; border-bottom:1px solid var(--border); font-size: 1rem; letter-spacing: 0.15px; }

    .stream-wrap { position: relative; display:flex; align-items:center; justify-content:center; flex: 1; min-height: 260px; }
    .stream-note { color: var(--muted); padding: 12px 14px; text-align: center; }
    .stream-placeholder {
      width: 100%; aspect-ratio: 16/9; background: #0f1220;
      border-bottom-left-radius: 14px; border-bottom-right-radius: 14px;
      display: grid; place-items: center; border-top:1px solid var(--border);
    }
    .pill { background:#0e1726; border:1px solid var(--border); padding:8px 12px; border-radius: 999px; color: var(--muted); }

    .chat { display:flex; flex-direction:column; min-height:0; }
    .feed { flex:1; overflow:auto; padding: 10px 12px; display:flex; flex-direction:column; gap: 10px; }
    .msg { display:flex; gap: 10px; align-items:flex-start; border-bottom:1px dashed var(--border); padding-bottom:10px; }
    .swatch { width: 10px; height: 10px; border-radius:999px; margin-top:6px; }
    .meta { display:flex; gap: 8px; align-items:center; font-size: 0.92rem; }
    .name { font-weight: 800; }
    .premium { color: #ffd43b; }
    .content { margin-top: 4px; line-height: 1.3; }
    .select { margin-left: auto; }

    .composer { border-top:1px solid var(--border); padding: 10px; display:grid; grid-template-columns: 1fr auto; gap: 10px; }
    .row { display:flex; gap: 10px; align-items:center; flex-wrap: wrap; }
    .input, .textarea { background: #0e1220; border:1px solid var(--border); color:#fff; border-radius:10px; padding:10px 12px; }
    .input { min-width: 180px; }
    .textarea { width:100%; min-height: 44px; resize: vertical; }
    .hint { color: var(--muted); font-size: 0.9rem; }
    .error { color: var(--danger); font-size: 0.95rem; }
    .success { color: var(--ok); font-size: 0.95rem; }

    .prompt { display:flex; flex-direction:column; min-height:0; }
    .prompt-body { padding: 10px; display:flex; flex-direction:column; gap: 10px; }
    .prompt-preview { background: #0e1220; border:1px dashed var(--border); border-radius: 10px; padding: 10px; min-height: 120px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <header>
    <div class="title">üé• Vibe Livestream Hub</div>
    <div class="actions">
      <a class="btn" href="https://www.vibecodedbyx.com" target="_blank" rel="noopener">Open Stream ‚Üó</a>
      <a class="link" href="https://www.vibecodedbyx.com" target="_blank" rel="noopener">Back to VibeCodedByX.com</a>
    </div>
  </header>

  <main>
    <section class="panel stream">
      <h2>Live Stream</h2>
      <div class="stream-wrap">
        <div class="stream-placeholder">
          <div>
            <div class="pill">Embedding blocked by X-Frame-Options</div>
            <div class="stream-note" style="margin-top: 10px">Use ‚ÄúOpen Stream‚Äù above to watch in a new tab while you chat here.</div>
          </div>
        </div>
      </div>
    </section>

    <section class="panel chat">
      <h2>Live Chat</h2>
      <div id="feed" class="feed" aria-live="polite"></div>

      <div class="composer">
        <div class="row">
          <input id="displayName" class="input" placeholder="Display name" maxlength="24" />
          <input id="accent" type="color" value="#4dabf7" title="Accent color" />
          <span id="status" class="hint">Signed in as guest‚Ä¶</span>
        </div>
        <div class="row" style="grid-column: 1 / -1;">
          <textarea id="message" class="textarea" placeholder="Say something helpful (or select messages to build a prompt)‚Ä¶" maxlength="240"></textarea>
          <button id="send" class="btn primary">Send</button>
        </div>
        <div id="err" class="error" style="display:none"></div>
      </div>
    </section>

    <section class="panel prompt">
      <h2>Prompt Builder</h2>
      <div class="prompt-body">
        <div class="hint">Select messages in chat to include. We‚Äôll concatenate newest ‚Üí oldest, capped at ~1,000 chars.</div>
        <div id="promptPreview" class="prompt-preview"></div>
        <div class="row">
          <button id="copy" class="btn">Copy Prompt</button>
          <span id="copyMsg" class="success" style="display:none">Copied!</span>
        </div>
      </div>
    </section>
  </main>

  <!-- Elements referenced by shared supabase-config.js -->
  <div id="premium-content" style="display:none"></div>
  <button id="upgrade-button" style="display:none"></button>

  <script type="module">
    import supabase, { supabaseSession, isUserPremium } from "./supabase-config.js";

    const feed = document.getElementById('feed');
    const displayNameInput = document.getElementById('displayName');
    const accentInput = document.getElementById('accent');
    const statusEl = document.getElementById('status');
    const messageInput = document.getElementById('message');
    const sendBtn = document.getElementById('send');
    const errEl = document.getElementById('err');
    const promptPreview = document.getElementById('promptPreview');
    const copyBtn = document.getElementById('copy');
    const copyMsg = document.getElementById('copyMsg');

    let user = null;
    let premium = false;
    let selectedIds = new Set();

    function fmtTime(iso) {
      try { return new Date(iso).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); } catch { return ''; }
    }

    function renderPrompt() {
      // Gather selected messages newest->oldest; cap length
      const nodes = [...feed.querySelectorAll('.msg')];
      const chosen = nodes.filter(n => selectedIds.has(Number(n.dataset.id)))
        .map(n => `@${n.dataset.name}: ${n.dataset.content}`);
      let text = '';
      for (const chunk of chosen) {
        if ((text + '\n' + chunk).length > 1000) break;
        text = text ? text + '\n' + chunk : chunk;
      }
      promptPreview.textContent = text || 'Select messages to build a prompt‚Ä¶';
    }

    function addMessage(row, { prepend = true } = {}) {
      const div = document.createElement('div');
      div.className = 'msg';
      div.dataset.id = row.id;
      div.dataset.name = row.display_name || 'anon';
      div.dataset.content = row.content || '';

      const swatch = document.createElement('div');
      swatch.className = 'swatch';
      if (row.accent_color) swatch.style.background = row.accent_color;

      const meta = document.createElement('div');
      meta.style.flex = '1';
      const nameLine = document.createElement('div');
      nameLine.className = 'meta';
      const nameEl = document.createElement('span');
      nameEl.className = 'name';
      nameEl.textContent = row.display_name || 'Anonymous';
      nameLine.appendChild(nameEl);
      if (row.is_premium) {
        const badge = document.createElement('span');
        badge.className = 'premium';
        badge.textContent = '‚òÖ premium';
        nameLine.appendChild(badge);
      }
      const time = document.createElement('span');
      time.className = 'hint';
      time.textContent = fmtTime(row.created_at);
      nameLine.appendChild(time);

      const content = document.createElement('div');
      content.className = 'content';
      content.textContent = row.content || '';

      meta.appendChild(nameLine);
      meta.appendChild(content);

      const select = document.createElement('input');
      select.type = 'checkbox';
      select.className = 'select';
      select.addEventListener('change', () => {
        const id = Number(row.id);
        if (select.checked) selectedIds.add(id); else selectedIds.delete(id);
        renderPrompt();
      });

      div.appendChild(swatch);
      div.appendChild(meta);
      div.appendChild(select);

      if (prepend) feed.prepend(div); else feed.appendChild(div);
    }

    async function loadUserProfile() {
      try {
        const { user: u } = await supabaseSession();
        user = u;
        statusEl.textContent = `Signed in: ${user.id.slice(0, 6)}‚Ä¶`;
      } catch (e) {
        console.error('Auth error:', e);
        statusEl.textContent = 'Signed in as guest (auth error)';
      }

      try { premium = await isUserPremium(); } catch { premium = false; }

      // Try to load saved display name
      if (user?.id) {
        const { data, error } = await supabase
          .from('users')
          .select('display_name')
          .eq('user_id', user.id)
          .maybeSingle();
        if (!error && data?.display_name) displayNameInput.value = data.display_name;
      }
    }

    async function loadMessages() {
      try {
        const { data, error } = await supabase
          .from('live_chat_messages')
          .select('id, content, display_name, is_premium, accent_color, created_at')
          .order('created_at', { ascending: false })
          .limit(50);
        if (error) throw error;
        feed.innerHTML = '';
        (data || []).forEach(row => addMessage(row, { prepend: false }));
      } catch (e) {
        console.error('Load messages failed:', e);
        feed.innerHTML = '<div class="hint">Failed to load chat. Retrying shortly‚Ä¶</div>';
      }
    }

    function subscribeRealtime() {
      try {
        const channel = supabase.channel('live_chat_messages');
        channel.on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'live_chat_messages' }, payload => {
          if (payload?.new) addMessage(payload.new, { prepend: true });
        });
        channel.subscribe((status) => {
          if (status === 'SUBSCRIBED') {
            console.log('Realtime subscribed');
          }
        });
      } catch (e) {
        console.warn('Realtime unavailable:', e);
      }
    }

    async function ensureDisplayName() {
      const name = (displayNameInput.value || '').trim().slice(0, 24);
      if (!name) return 'Anonymous';
      try {
        if (user?.id) {
          await supabase.from('users').upsert({ user_id: user.id, display_name: name, updated_at: new Date().toISOString() });
        }
      } catch (e) { /* ignore */ }
      return name;
    }

    async function sendMessage() {
      errEl.style.display = 'none';
      const content = (messageInput.value || '').trim();
      if (!content) {
        errEl.textContent = 'Message cannot be empty.';
        errEl.style.display = 'block';
        return;
      }
      const displayName = await ensureDisplayName();
      const accent = accentInput.value || '#4dabf7';
      try {
        if (!user?.id) {
          const s = await supabaseSession();
          user = s.user;
        }
        const { error } = await supabase
          .from('live_chat_messages')
          .insert({
            user_id: user?.id,
            content,
            display_name: displayName,
            is_premium: !!premium,
            accent_color: accent
          });
        if (error) throw error;
        messageInput.value = '';
      } catch (e) {
        console.error('Send failed:', e);
        errEl.textContent = 'Failed to send. Please try again.';
        errEl.style.display = 'block';
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', e => { if (e.key === 'Enter' && (e.ctrlKey || e.metaKey || !e.shiftKey)) { e.preventDefault(); sendMessage(); } });
    copyBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(promptPreview.textContent || '');
        copyMsg.style.display = 'inline';
        setTimeout(() => (copyMsg.style.display = 'none'), 1200);
      } catch (e) { /* ignore */ }
    });

    // Boot
    await loadUserProfile();
    await loadMessages();
    subscribeRealtime();
  </script>
</body>
</html>
