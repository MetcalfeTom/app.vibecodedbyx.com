<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Gas Tank Delivery</title>
  <link rel="icon" href="https://emojicdn.elk.sh/‚õΩ">
  <meta property="og:title" content="Gas Tank Delivery">
  <meta property="og:description" content="Order gas tanks with real-time location tracking">
  <meta property="og:url" content="https://app.sloppy.live/gas-delivery">
  <meta property="og:image" content="https://emojicdn.elk.sh/‚õΩ?style=apple&size=512">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #1e293b;
      --text-light: #64748b;
      --border: #e2e8f0;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding-bottom: 100px;
    }

    .header {
      background: var(--primary);
      color: white;
      padding: 20px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
    }

    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .card-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-light);
      margin-bottom: 6px;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-family: inherit;
      font-size: 1rem;
      background: var(--bg);
      color: var(--text);
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    .tank-options {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .tank-option {
      padding: 16px 12px;
      border: 2px solid var(--border);
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--card);
    }

    .tank-option:hover {
      border-color: var(--primary);
    }

    .tank-option.selected {
      border-color: var(--primary);
      background: rgba(37, 99, 235, 0.05);
    }

    .tank-option .size {
      font-size: 1.5rem;
      margin-bottom: 4px;
    }

    .tank-option .label {
      font-size: 0.75rem;
      color: var(--text-light);
    }

    .tank-option .price {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--primary);
      margin-top: 4px;
    }

    .quantity-control {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .qty-btn {
      width: 44px;
      height: 44px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--card);
      font-size: 1.25rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .qty-btn:hover {
      background: var(--bg);
    }

    .qty-value {
      font-size: 1.5rem;
      font-weight: 600;
      min-width: 40px;
      text-align: center;
    }

    .location-box {
      background: var(--bg);
      border-radius: 10px;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .location-icon {
      width: 44px;
      height: 44px;
      background: var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      flex-shrink: 0;
    }

    .location-text {
      flex: 1;
    }

    .location-text .coords {
      font-size: 0.75rem;
      color: var(--text-light);
      margin-top: 2px;
    }

    .location-btn {
      padding: 8px 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
    }

    .btn {
      width: 100%;
      padding: 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 12px;
      font-family: inherit;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn:hover {
      background: var(--primary-dark);
    }

    .btn:disabled {
      background: var(--text-light);
      cursor: not-allowed;
    }

    .btn-success {
      background: var(--success);
    }

    .order-summary {
      background: var(--bg);
      border-radius: 10px;
      padding: 16px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .summary-row.total {
      font-weight: 600;
      font-size: 1.1rem;
      border-top: 1px solid var(--border);
      padding-top: 8px;
      margin-top: 8px;
    }

    .orders-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .order-item {
      background: var(--bg);
      border-radius: 10px;
      padding: 16px;
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .order-id {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .order-status {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .status-pending { background: #fef3c7; color: #92400e; }
    .status-confirmed { background: #dbeafe; color: #1e40af; }
    .status-delivering { background: #d1fae5; color: #065f46; }
    .status-delivered { background: #d1fae5; color: #065f46; }

    .order-details {
      font-size: 0.85rem;
      color: var(--text-light);
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .tab {
      flex: 1;
      padding: 12px;
      border: none;
      background: var(--card);
      border-radius: 10px;
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tab.active {
      background: var(--primary);
      color: white;
    }

    .hidden { display: none; }

    .success-message {
      text-align: center;
      padding: 40px 20px;
    }

    .success-icon {
      font-size: 4rem;
      margin-bottom: 20px;
    }

    .success-message h2 {
      color: var(--success);
      margin-bottom: 10px;
    }

    .backlink {
      display: block;
      text-align: center;
      color: var(--text-light);
      font-size: 0.75rem;
      text-decoration: none;
      margin-top: 20px;
    }

    .map-placeholder {
      height: 150px;
      background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
      font-weight: 500;
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>‚õΩ Gas Tank Delivery</h1>
  </div>

  <div class="container">
    <div class="tabs">
      <button class="tab active" data-tab="order">New Order</button>
      <button class="tab" data-tab="track">My Orders</button>
    </div>

    <!-- Order Form -->
    <div id="order-tab">
      <div class="card">
        <div class="card-title">üìç Delivery Location</div>
        
        <div class="location-box">
          <div class="location-icon">üìç</div>
          <div class="location-text">
            <div id="location-status">Tap to get your location</div>
            <div class="coords" id="coords"></div>
          </div>
          <button class="location-btn" id="get-location">Locate</button>
        </div>

        <div class="map-placeholder" id="map-placeholder">
          <span>üìç Location will appear here</span>
        </div>

        <div class="form-group" style="margin-top: 16px;">
          <label>Delivery Address</label>
          <textarea id="address" placeholder="Enter your full address..."></textarea>
        </div>
      </div>

      <div class="card">
        <div class="card-title">üõ¢Ô∏è Select Tank Size</div>
        
        <div class="tank-options">
          <div class="tank-option selected" data-size="small" data-price="25">
            <div class="size">üîµ</div>
            <div class="label">Small</div>
            <div class="price">$25</div>
          </div>
          <div class="tank-option" data-size="medium" data-price="45">
            <div class="size">üü¢</div>
            <div class="label">Medium</div>
            <div class="price">$45</div>
          </div>
          <div class="tank-option" data-size="large" data-price="75">
            <div class="size">üü†</div>
            <div class="label">Large</div>
            <div class="price">$75</div>
          </div>
        </div>

        <div class="form-group" style="margin-top: 20px;">
          <label>Quantity</label>
          <div class="quantity-control">
            <button class="qty-btn" id="qty-minus">‚àí</button>
            <div class="qty-value" id="qty-value">1</div>
            <button class="qty-btn" id="qty-plus">+</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">üë§ Contact Information</div>
        
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="name" placeholder="Your name">
        </div>

        <div class="form-group">
          <label>Phone Number</label>
          <input type="tel" id="phone" placeholder="Your phone number">
        </div>

        <div class="form-group">
          <label>Special Instructions (Optional)</label>
          <textarea id="notes" placeholder="Gate code, landmarks, etc."></textarea>
        </div>
      </div>

      <div class="card">
        <div class="card-title">üìã Order Summary</div>
        
        <div class="order-summary">
          <div class="summary-row">
            <span>Tank Size</span>
            <span id="summary-size">Small</span>
          </div>
          <div class="summary-row">
            <span>Quantity</span>
            <span id="summary-qty">1</span>
          </div>
          <div class="summary-row">
            <span>Unit Price</span>
            <span id="summary-price">$25</span>
          </div>
          <div class="summary-row">
            <span>Delivery Fee</span>
            <span>$5</span>
          </div>
          <div class="summary-row total">
            <span>Total</span>
            <span id="summary-total">$30</span>
          </div>
        </div>

        <button class="btn" id="submit-order" style="margin-top: 16px;">
          Place Order
        </button>
      </div>
    </div>

    <!-- Order Success -->
    <div id="success-tab" class="hidden">
      <div class="card">
        <div class="success-message">
          <div class="success-icon">‚úÖ</div>
          <h2>Order Placed!</h2>
          <p>Your gas tank delivery is on the way.</p>
          <p style="margin-top: 10px; color: var(--text-light); font-size: 0.9rem;">
            Order ID: <strong id="order-id">---</strong>
          </p>
          <button class="btn" style="margin-top: 20px;" id="new-order">Place Another Order</button>
        </div>
      </div>
    </div>

    <!-- Track Orders -->
    <div id="track-tab" class="hidden">
      <div class="card">
        <div class="card-title">üì¶ Your Orders</div>
        <div class="orders-list" id="orders-list">
          <p style="color: var(--text-light); text-align: center; padding: 20px;">
            Loading orders...
          </p>
        </div>
      </div>
    </div>

    <a href="https://sloppy.live" class="backlink">sloppy.live</a>
  </div>

  <script src="/supabase-config.js"></script>
  <script>
    let selectedSize = 'small';
    let selectedPrice = 25;
    let quantity = 1;
    let userLat = null;
    let userLng = null;
    let currentUser = null;

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        document.getElementById('order-tab').classList.add('hidden');
        document.getElementById('track-tab').classList.add('hidden');
        document.getElementById('success-tab').classList.add('hidden');

        const tabName = tab.dataset.tab;
        if (tabName === 'order') {
          document.getElementById('order-tab').classList.remove('hidden');
        } else if (tabName === 'track') {
          document.getElementById('track-tab').classList.remove('hidden');
          loadOrders();
        }
      });
    });

    // Tank selection
    document.querySelectorAll('.tank-option').forEach(option => {
      option.addEventListener('click', () => {
        document.querySelectorAll('.tank-option').forEach(o => o.classList.remove('selected'));
        option.classList.add('selected');
        selectedSize = option.dataset.size;
        selectedPrice = parseInt(option.dataset.price);
        updateSummary();
      });
    });

    // Quantity controls
    document.getElementById('qty-minus').addEventListener('click', () => {
      if (quantity > 1) {
        quantity--;
        document.getElementById('qty-value').textContent = quantity;
        updateSummary();
      }
    });

    document.getElementById('qty-plus').addEventListener('click', () => {
      if (quantity < 10) {
        quantity++;
        document.getElementById('qty-value').textContent = quantity;
        updateSummary();
      }
    });

    function updateSummary() {
      document.getElementById('summary-size').textContent = selectedSize.charAt(0).toUpperCase() + selectedSize.slice(1);
      document.getElementById('summary-qty').textContent = quantity;
      document.getElementById('summary-price').textContent = '$' + selectedPrice;
      const total = (selectedPrice * quantity) + 5;
      document.getElementById('summary-total').textContent = '$' + total;
    }

    // Location
    document.getElementById('get-location').addEventListener('click', () => {
      if (!navigator.geolocation) {
        document.getElementById('location-status').textContent = 'Geolocation not supported';
        return;
      }

      document.getElementById('location-status').textContent = 'Getting location...';

      navigator.geolocation.getCurrentPosition(
        (position) => {
          userLat = position.coords.latitude.toFixed(6);
          userLng = position.coords.longitude.toFixed(6);
          document.getElementById('location-status').textContent = 'Location found!';
          document.getElementById('coords').textContent = `${userLat}, ${userLng}`;
          document.getElementById('map-placeholder').innerHTML = `<span>üìç ${userLat}, ${userLng}</span>`;
        },
        (error) => {
          document.getElementById('location-status').textContent = 'Could not get location';
          console.error(error);
        }
      );
    });

    // Initialize auth
    async function initAuth() {
      const { data: { user } } = await supabase.auth.getUser();

      if (user) {
        currentUser = user;
      } else {
        const { data, error } = await supabase.auth.signInAnonymously();
        if (data?.user) {
          currentUser = data.user;
        }
      }
    }

    // Submit order
    document.getElementById('submit-order').addEventListener('click', async () => {
      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const address = document.getElementById('address').value.trim();
      const notes = document.getElementById('notes').value.trim();

      if (!name || !phone || !address) {
        alert('Please fill in all required fields');
        return;
      }

      if (!currentUser) {
        alert('Please wait for authentication...');
        return;
      }

      const btn = document.getElementById('submit-order');
      btn.disabled = true;
      btn.textContent = 'Placing Order...';

      try {
        const { data, error } = await supabase
          .from('gas_delivery_orders')
          .insert({
            name,
            phone,
            address,
            latitude: userLat || '',
            longitude: userLng || '',
            tank_size: selectedSize,
            quantity,
            notes,
            status: 'pending',
            user_id: currentUser.id
          })
          .select()
          .single();

        if (error) throw error;

        // Show success
        document.getElementById('order-tab').classList.add('hidden');
        document.getElementById('success-tab').classList.remove('hidden');
        document.getElementById('order-id').textContent = data.id?.slice(0, 8) || 'GAS' + Date.now();

        // Reset form
        document.getElementById('name').value = '';
        document.getElementById('phone').value = '';
        document.getElementById('address').value = '';
        document.getElementById('notes').value = '';
        quantity = 1;
        document.getElementById('qty-value').textContent = 1;
        updateSummary();

      } catch (err) {
        console.error('Error:', err);
        alert('Could not place order. Please try again.');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Place Order';
      }
    });

    // New order button
    document.getElementById('new-order').addEventListener('click', () => {
      document.getElementById('success-tab').classList.add('hidden');
      document.getElementById('order-tab').classList.remove('hidden');
    });

    // Load user's orders
    async function loadOrders() {
      if (!currentUser) {
        document.getElementById('orders-list').innerHTML = '<p style="text-align:center;color:var(--text-light);">Please wait...</p>';
        return;
      }

      try {
        const { data, error } = await supabase
          .from('gas_delivery_orders')
          .select('*')
          .eq('user_id', currentUser.id)
          .order('created_at', { ascending: false })
          .limit(10);

        if (error) throw error;

        if (!data || data.length === 0) {
          document.getElementById('orders-list').innerHTML = '<p style="text-align:center;color:var(--text-light);padding:20px;">No orders yet</p>';
          return;
        }

        document.getElementById('orders-list').innerHTML = data.map(order => `
          <div class="order-item">
            <div class="order-header">
              <span class="order-id">#${order.id?.slice(0, 8) || '---'}</span>
              <span class="order-status status-${order.status}">${order.status}</span>
            </div>
            <div class="order-details">
              <div>${order.quantity}x ${order.tank_size} tank</div>
              <div>${order.address?.slice(0, 50)}${order.address?.length > 50 ? '...' : ''}</div>
              <div style="margin-top:4px;font-size:0.75rem;">${new Date(order.created_at).toLocaleString()}</div>
            </div>
          </div>
        `).join('');

      } catch (err) {
        console.error('Error loading orders:', err);
        document.getElementById('orders-list').innerHTML = '<p style="text-align:center;color:var(--text-light);">Could not load orders</p>';
      }
    }

    // Init
    initAuth();
    updateSummary();
  </script>
<script src="/sloppy-header/sloppy-bar.js"></script>
<script src="/vibelib-extended.js"></script>
<script>
  // Compatibility Patch for Legacy Apps
  window.addEventListener("load", () => {
    if (window.SloppyKarma && window.VibeLib.Economy) {
      // Redirect old calls to new engine
      window.SloppyKarma.track = window.VibeLib.Economy.track;
    }
  });
</script>
</body>
</html>
