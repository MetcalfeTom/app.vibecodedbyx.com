<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Icy Tower - Windows 95</title>
  <link rel="icon" href="https://emojicdn.elk.sh/üßä">

  <meta property="og:title" content="Icy Tower Online">
  <meta property="og:description" content="Climb endless icy floors. Jump fast, don't fall!">
  <meta property="og:url" content="https://sloppy.live/icy-tower">
  <meta property="og:image" content="https://sloppy.live/icy-tower/og.png">

  <style>
    @font-face {
      font-family: 'W95FA';
      src: url('https://cdn.jsdelivr.net/gh/nicholasnelson/Windows-95-UI-Kit@master/assets/fonts/W95FA.woff2') format('woff2');
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; overflow: hidden; }

    body {
      font-family: 'W95FA', 'MS Sans Serif', 'Segoe UI', Tahoma, sans-serif;
      font-size: 11px;
      background: #008080;
      color: #000;
      cursor: default;
      user-select: none;
    }

    /* Classic Windows 95 Desktop */
    .desktop {
      width: 100vw;
      height: 100vh;
      background: #008080;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    /* Win95 Window */
    .win95-window {
      background: #c0c0c0;
      border: 2px solid;
      border-color: #ffffff #808080 #808080 #ffffff;
      box-shadow: 1px 1px 0 #000;
      display: flex;
      flex-direction: column;
      max-width: 900px;
      width: 100%;
      max-height: calc(100vh - 80px);
    }

    .win95-titlebar {
      background: linear-gradient(90deg, #000080, #1084d0);
      color: white;
      padding: 2px 3px;
      display: flex;
      align-items: center;
      font-weight: bold;
      font-size: 12px;
      height: 22px;
    }

    .win95-titlebar-icon {
      width: 16px;
      height: 16px;
      margin-right: 4px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .win95-titlebar-text {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
    }

    .win95-titlebar-buttons {
      display: flex;
      gap: 2px;
    }

    .win95-btn {
      background: #c0c0c0;
      border: 2px solid;
      border-color: #ffffff #808080 #808080 #ffffff;
      min-width: 16px;
      height: 14px;
      font-size: 9px;
      font-weight: bold;
      font-family: inherit;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }

    .win95-btn:active {
      border-color: #808080 #ffffff #ffffff #808080;
    }

    .win95-menubar {
      background: #c0c0c0;
      border-bottom: 1px solid #808080;
      padding: 2px 0;
      display: flex;
      gap: 0;
    }

    .win95-menu-item {
      padding: 2px 8px;
      cursor: pointer;
    }

    .win95-menu-item:hover {
      background: #000080;
      color: white;
    }

    .win95-content {
      display: grid;
      grid-template-columns: 1fr 200px;
      flex: 1;
      min-height: 0;
      background: #c0c0c0;
    }

    @media (max-width: 700px) {
      .win95-content { grid-template-columns: 1fr; }
      .win95-sidebar { display: none; }
    }

    /* Game Area */
    .game-area {
      background: #000;
      border: 2px solid;
      border-color: #808080 #ffffff #ffffff #808080;
      margin: 4px;
      position: relative;
      overflow: hidden;
    }

    canvas {
      display: block;
      width: 100%;
      height: 100%;
    }

    /* HUD */
    .game-hud {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 8px;
      display: flex;
      gap: 16px;
      background: linear-gradient(180deg, rgba(0,0,0,0.8), transparent);
      z-index: 5;
    }

    .hud-stat {
      color: #fff;
      text-shadow: 1px 1px 0 #000;
    }

    .hud-stat-label {
      font-size: 10px;
      color: #aaa;
    }

    .hud-stat-value {
      font-size: 16px;
      font-weight: bold;
      color: #0ff;
    }

    .hud-stat-value.combo { color: #ff0; }

    /* Sidebar */
    .win95-sidebar {
      background: #c0c0c0;
      padding: 4px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      overflow-y: auto;
    }

    .win95-group {
      border: 2px solid;
      border-color: #808080 #ffffff #ffffff #808080;
      padding: 8px;
    }

    .win95-group-title {
      background: #c0c0c0;
      position: relative;
      top: -16px;
      margin-bottom: -8px;
      padding: 0 4px;
      width: fit-content;
      font-weight: bold;
    }

    .win95-list {
      background: #fff;
      border: 2px solid;
      border-color: #808080 #ffffff #ffffff #808080;
      max-height: 150px;
      overflow-y: auto;
    }

    .win95-list-item {
      padding: 2px 4px;
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid #c0c0c0;
    }

    .win95-list-item:last-child { border-bottom: none; }

    .win95-list-item.header {
      background: #000080;
      color: white;
      font-weight: bold;
    }

    .win95-list-item .rank { width: 24px; }
    .win95-list-item .name { flex: 1; overflow: hidden; text-overflow: ellipsis; }
    .win95-list-item .score { width: 40px; text-align: right; font-weight: bold; color: #008000; }

    /* Buttons */
    .win95-button {
      background: #c0c0c0;
      border: 2px solid;
      border-color: #ffffff #808080 #808080 #ffffff;
      padding: 4px 12px;
      font-family: inherit;
      font-size: 11px;
      cursor: pointer;
    }

    .win95-button:active {
      border-color: #808080 #ffffff #ffffff #808080;
      padding: 5px 11px 3px 13px;
    }

    .win95-button:focus {
      outline: 1px dotted #000;
      outline-offset: -4px;
    }

    .win95-button.primary {
      font-weight: bold;
    }

    /* Status Bar */
    .win95-statusbar {
      background: #c0c0c0;
      border-top: 2px solid;
      border-color: #808080 #ffffff #ffffff #808080;
      padding: 2px 4px;
      display: flex;
      font-size: 11px;
    }

    .statusbar-section {
      border: 1px solid;
      border-color: #808080 #ffffff #ffffff #808080;
      padding: 1px 8px;
      flex: 1;
    }

    .statusbar-section:first-child { flex: 3; }

    /* Overlays */
    .game-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 128, 128, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .game-overlay.show { display: flex; }

    .overlay-dialog {
      background: #c0c0c0;
      border: 2px solid;
      border-color: #ffffff #808080 #808080 #ffffff;
      box-shadow: 2px 2px 0 #000;
      max-width: 320px;
      width: 90%;
    }

    .overlay-titlebar {
      background: linear-gradient(90deg, #000080, #1084d0);
      color: white;
      padding: 2px 4px;
      font-weight: bold;
      font-size: 11px;
    }

    .overlay-content {
      padding: 16px;
      text-align: center;
    }

    .overlay-content p { margin: 8px 0; }

    .overlay-content .big-score {
      font-size: 32px;
      font-weight: bold;
      color: #000080;
      margin: 12px 0;
    }

    .overlay-buttons {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-top: 12px;
    }

    .win95-input {
      background: #fff;
      border: 2px solid;
      border-color: #808080 #ffffff #ffffff #808080;
      padding: 4px;
      font-family: inherit;
      font-size: 11px;
      width: 100%;
    }

    .input-group {
      margin: 8px 0;
      text-align: left;
    }

    .input-group label {
      display: block;
      margin-bottom: 4px;
    }

    .error-text {
      color: #ff0000;
      font-size: 10px;
      margin-top: 4px;
    }

    /* Power chips */
    .power-chips {
      position: absolute;
      top: 40px;
      left: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      z-index: 5;
    }

    .power-chip {
      background: #c0c0c0;
      border: 2px solid;
      border-color: #ffffff #808080 #808080 #ffffff;
      padding: 2px 6px;
      font-size: 10px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .power-chip-icon {
      width: 12px;
      height: 12px;
      border-radius: 2px;
    }

    .power-chip-icon.double { background: #00ff00; }
    .power-chip-icon.slow { background: #ffff00; }
    .power-chip-icon.boost { background: #ff00ff; }

    /* Toast */
    .toast {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: #c0c0c0;
      border: 2px solid;
      border-color: #ffffff #808080 #808080 #ffffff;
      padding: 8px 16px;
      font-weight: bold;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s, transform 0.2s;
      z-index: 20;
    }

    .toast.show {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }

    /* Mobile touch controls */
    .touch-controls {
      display: none;
      position: absolute;
      bottom: 8px;
      left: 8px;
      right: 8px;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      z-index: 10;
    }

    @media (max-width: 700px) {
      .touch-controls { display: grid; }
    }

    .touch-btn {
      background: #c0c0c0;
      border: 2px solid;
      border-color: #ffffff #808080 #808080 #ffffff;
      height: 60px;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .touch-btn:active {
      border-color: #808080 #ffffff #ffffff #808080;
    }

    /* Taskbar */
    .win95-taskbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 28px;
      background: #c0c0c0;
      border-top: 2px solid #ffffff;
      display: flex;
      align-items: center;
      padding: 2px 4px;
      z-index: 100;
    }

    .start-btn {
      background: #c0c0c0;
      border: 2px solid;
      border-color: #ffffff #808080 #808080 #ffffff;
      padding: 2px 8px;
      font-family: inherit;
      font-weight: bold;
      font-size: 11px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .start-btn:active {
      border-color: #808080 #ffffff #ffffff #808080;
    }

    .taskbar-time {
      margin-left: auto;
      background: #c0c0c0;
      border: 1px solid;
      border-color: #808080 #ffffff #ffffff #808080;
      padding: 2px 8px;
      font-size: 11px;
    }
  </style>
</head>
<body>
  <div class="desktop">
    <div class="win95-window">
      <div class="win95-titlebar">
        <div class="win95-titlebar-icon">üßä</div>
        <div class="win95-titlebar-text">Icy Tower</div>
        <div class="win95-titlebar-buttons">
          <button class="win95-btn" title="Minimize">_</button>
          <button class="win95-btn" title="Maximize">‚ñ°</button>
          <button class="win95-btn" title="Close">√ó</button>
        </div>
      </div>

      <div class="win95-menubar">
        <div class="win95-menu-item">Game</div>
        <div class="win95-menu-item" id="soundMenu">Sound: On</div>
        <div class="win95-menu-item">Help</div>
      </div>

      <div class="win95-content">
        <div class="game-area">
          <canvas id="game"></canvas>

          <div class="game-hud">
            <div class="hud-stat">
              <div class="hud-stat-label">FLOOR</div>
              <div class="hud-stat-value" id="floor">0</div>
            </div>
            <div class="hud-stat">
              <div class="hud-stat-label">BEST</div>
              <div class="hud-stat-value" id="best">0</div>
            </div>
            <div class="hud-stat">
              <div class="hud-stat-label">COMBO</div>
              <div class="hud-stat-value combo" id="combo">x1</div>
            </div>
          </div>

          <div class="power-chips" id="powerChips"></div>
          <div class="toast" id="toast"></div>

          <!-- Start Overlay -->
          <div class="game-overlay show" id="startOverlay">
            <div class="overlay-dialog">
              <div class="overlay-titlebar">Icy Tower</div>
              <div class="overlay-content">
                <p><b>üßä Welcome to Icy Tower!</b></p>
                <p>Climb as high as you can.<br>Don't fall off the screen!</p>
                <p style="font-size:10px;color:#666;">
                  A/D or ‚Üê/‚Üí = Move<br>
                  Space = Jump<br>
                  P = Pause
                </p>
                <div class="overlay-buttons">
                  <button class="win95-button primary" id="playBtn">Start Game</button>
                  <button class="win95-button" id="startMuteBtn">üîä</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Game Over Overlay -->
          <div class="game-overlay" id="gameOverOverlay">
            <div class="overlay-dialog">
              <div class="overlay-titlebar">Game Over</div>
              <div class="overlay-content">
                <p>You reached floor:</p>
                <div class="big-score" id="finalFloor">0</div>
                <div id="saveBlock">
                  <div class="input-group">
                    <label for="playerName">Enter your name:</label>
                    <input class="win95-input" id="playerName" maxlength="20" placeholder="Player">
                  </div>
                  <div id="saveError" class="error-text" style="display:none"></div>
                  <div class="overlay-buttons">
                    <button class="win95-button primary" id="saveScoreBtn">Save Score</button>
                    <button class="win95-button" id="skipSaveBtn">Skip</button>
                  </div>
                </div>
                <div class="overlay-buttons" style="margin-top:12px">
                  <button class="win95-button primary" id="playAgainBtn">Play Again</button>
                  <button class="win95-button" id="shareBtn">Share</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Touch Controls -->
          <div class="touch-controls">
            <button class="touch-btn" id="leftPad">‚óÑ</button>
            <button class="touch-btn" id="jumpPad">‚ñ≤</button>
            <button class="touch-btn" id="rightPad">‚ñ∫</button>
          </div>
        </div>

        <div class="win95-sidebar">
          <div class="win95-group">
            <div class="win95-group-title">Leaderboard</div>
            <div class="win95-list" id="leaderboard">
              <div class="win95-list-item header">
                <span class="rank">#</span>
                <span class="name">Name</span>
                <span class="score">Score</span>
              </div>
              <div class="win95-list-item">
                <span class="rank"></span>
                <span class="name" style="color:#808080">Loading...</span>
                <span class="score"></span>
              </div>
            </div>
            <button class="win95-button" style="width:100%;margin-top:4px" id="refreshBtn">Refresh</button>
          </div>

          <div class="win95-group">
            <div class="win95-group-title">Controls</div>
            <button class="win95-button" style="width:100%;margin-bottom:4px" id="pauseBtn">Pause (P)</button>
            <button class="win95-button" style="width:100%" id="restartBtn">New Game</button>
          </div>

          <div style="margin-top:auto;text-align:center;font-size:10px;color:#808080">
            <a href="https://sloppy.live" target="_blank" style="color:#000080">sloppy.live</a>
          </div>
        </div>
      </div>

      <div class="win95-statusbar">
        <div class="statusbar-section">Ready</div>
        <div class="statusbar-section" id="statusTime"></div>
      </div>
    </div>
  </div>

  <div class="win95-taskbar">
    <button class="start-btn">
      <span>ü™ü</span> Start
    </button>
    <div class="taskbar-time" id="taskbarTime"></div>
  </div>

  <script type="module">
    import supabase, { supabaseSession, isUserPremium } from './supabase-config.js';

    // Update clock
    function updateClock() {
      const now = new Date();
      const time = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
      document.getElementById('taskbarTime').textContent = time;
      document.getElementById('statusTime').textContent = time;
    }
    setInterval(updateClock, 1000);
    updateClock();

    // Canvas Setup
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    let W = 0, H = 0, dpr = Math.min(2, window.devicePixelRatio || 1);

    function resize() {
      W = canvas.clientWidth;
      H = canvas.clientHeight;
      canvas.width = W * dpr;
      canvas.height = H * dpr;
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    window.addEventListener('resize', resize);
    resize();

    // Game State
    const game = {
      running: false,
      paused: false,
      muted: false,
      floor: 0,
      lastFloor: 0,
      best: parseInt(localStorage.getItem('icy-best') || '0'),
      combo: 1,
      comboTimer: 0,
      cameraY: 0,
      cameraTargetY: 0,
      lastTime: 0,
      particles: [],
      platforms: [],
      powerups: [],
      effects: { double: 0, slow: 0, boost: 0 },
    };

    const player = {
      x: 0, y: 0, vx: 0, vy: 0,
      width: 24, height: 32,
      grounded: false, jumpsLeft: 1,
      facingRight: true,
    };

    const PHYSICS = {
      gravity: 0.5,
      jumpForce: -13,
      moveAccel: 1.0,
      moveDecel: 0.85,
      maxSpeed: 6,
      airControl: 0.65,
      cameraSmooth: 0.1,
    };

    // Audio
    let audioCtx;
    function playSound(freq, duration = 0.1, type = 'square', vol = 0.1) {
      if (game.muted) return;
      if (!audioCtx) {
        try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) { return; }
      }
      if (audioCtx.state === 'suspended') audioCtx.resume();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = type;
      osc.frequency.value = freq;
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      gain.gain.setValueAtTime(vol, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
      osc.start();
      osc.stop(audioCtx.currentTime + duration);
    }

    // Particles
    function spawnParticle(x, y, vx, vy, color, life = 0.5) {
      game.particles.push({ x, y, vx, vy, color, life, maxLife: life });
    }

    function spawnJumpParticles(x, y) {
      for (let i = 0; i < 5; i++) {
        spawnParticle(x + (Math.random() - 0.5) * 20, y, (Math.random() - 0.5) * 3, -Math.random() * 2, '#0ff', 0.3);
      }
    }

    // Platforms
    function createPlatform(y) {
      const minW = Math.max(60, W * 0.15);
      const maxW = Math.max(120, W * 0.3);
      const w = minW + Math.random() * (maxW - minW);
      const x = Math.random() * (W - w);
      return { x, y, w, h: 12, type: Math.random() < 0.1 ? 'special' : 'normal' };
    }

    function resetWorld() {
      game.floor = 0;
      game.combo = 1;
      game.comboTimer = 0;
      game.cameraY = 0;
      game.cameraTargetY = 0;
      game.particles = [];
      game.platforms = [];
      game.powerups = [];
      game.effects = { double: 0, slow: 0, boost: 0 };

      player.x = W / 2 - player.width / 2;
      player.y = H * 0.6;
      player.vx = 0;
      player.vy = 0;
      player.grounded = false;
      player.jumpsLeft = 1;

      game.platforms.push({ x: 0, y: H * 0.75, w: W, h: 16, type: 'ground' });

      let y = H * 0.6;
      for (let i = 0; i < 35; i++) {
        y -= 50 + Math.random() * 35;
        const plat = createPlatform(y);
        game.platforms.push(plat);
        if (Math.random() < 0.1 && plat.y < H - 100) {
          const types = ['double', 'slow', 'boost'];
          game.powerups.push({ x: plat.x + plat.w / 2, y: plat.y - 12, type: types[Math.floor(Math.random() * 3)], bob: Math.random() * Math.PI * 2 });
        }
      }
    }

    // Input
    const input = { left: false, right: false, jump: false, jumpPressed: false };

    window.addEventListener('keydown', (e) => {
      if (e.repeat) return;
      if (e.code === 'ArrowLeft' || e.code === 'KeyA') input.left = true;
      if (e.code === 'ArrowRight' || e.code === 'KeyD') input.right = true;
      if (e.code === 'Space' || e.code === 'ArrowUp' || e.code === 'KeyW') {
        input.jump = true;
        input.jumpPressed = true;
        if (!game.running) startGame();
      }
      if (e.code === 'KeyP') togglePause();
    });

    window.addEventListener('keyup', (e) => {
      if (e.code === 'ArrowLeft' || e.code === 'KeyA') input.left = false;
      if (e.code === 'ArrowRight' || e.code === 'KeyD') input.right = false;
      if (e.code === 'Space' || e.code === 'ArrowUp' || e.code === 'KeyW') input.jump = false;
    });

    // Touch controls
    function bindTouch(el, onStart, onEnd) {
      const start = (e) => { e.preventDefault(); onStart(); };
      const end = (e) => { e.preventDefault(); onEnd(); };
      el.addEventListener('touchstart', start, { passive: false });
      el.addEventListener('touchend', end, { passive: false });
      el.addEventListener('mousedown', start);
      el.addEventListener('mouseup', end);
      el.addEventListener('mouseleave', end);
    }

    bindTouch(document.getElementById('leftPad'), () => input.left = true, () => input.left = false);
    bindTouch(document.getElementById('rightPad'), () => input.right = true, () => input.right = false);
    bindTouch(document.getElementById('jumpPad'), () => {
      input.jump = true;
      input.jumpPressed = true;
      if (!game.running) startGame();
    }, () => input.jump = false);

    // Update
    function update(dt) {
      const dtNorm = dt / 16.67;

      if (game.comboTimer > 0) {
        game.comboTimer -= dt;
        if (game.comboTimer <= 0) {
          game.combo = Math.max(1, game.combo - 1);
          game.comboTimer = game.combo > 1 ? 2000 : 0;
        }
      }

      for (const key of Object.keys(game.effects)) {
        game.effects[key] = Math.max(0, game.effects[key] - dt);
      }
      renderPowerChips();

      const accel = PHYSICS.moveAccel * (player.grounded ? 1 : PHYSICS.airControl);
      if (input.left) { player.vx -= accel * dtNorm; player.facingRight = false; }
      else if (input.right) { player.vx += accel * dtNorm; player.facingRight = true; }
      else { player.vx *= Math.pow(PHYSICS.moveDecel, dtNorm); }

      const maxSpd = PHYSICS.maxSpeed * (game.effects.boost > 0 ? 1.2 : 1);
      player.vx = Math.max(-maxSpd, Math.min(maxSpd, player.vx));

      if (input.jumpPressed) {
        const jumpMod = game.effects.boost > 0 ? 1.2 : 1;
        if (player.grounded) {
          player.vy = PHYSICS.jumpForce * jumpMod;
          player.grounded = false;
          player.jumpsLeft = game.effects.double > 0 ? 1 : 0;
          playSound(440, 0.08);
          spawnJumpParticles(player.x + player.width / 2, player.y + player.height);
        } else if (game.effects.double > 0 && player.jumpsLeft > 0) {
          player.vy = PHYSICS.jumpForce * jumpMod * 0.85;
          player.jumpsLeft--;
          playSound(550, 0.06);
          spawnJumpParticles(player.x + player.width / 2, player.y + player.height / 2);
        }
        input.jumpPressed = false;
      }

      const gravMod = game.effects.slow > 0 ? 0.7 : 1;
      player.vy += PHYSICS.gravity * gravMod * dtNorm;
      player.x += player.vx * dtNorm;
      player.y += player.vy * dtNorm;

      if (player.x < -player.width) player.x = W;
      if (player.x > W) player.x = -player.width;

      let landed = false;
      for (const plat of game.platforms) {
        if (player.vy >= 0 &&
            player.x + player.width > plat.x &&
            player.x < plat.x + plat.w &&
            player.y + player.height >= plat.y &&
            player.y + player.height <= plat.y + plat.h + player.vy * dtNorm + 4) {
          player.y = plat.y - player.height;
          player.vy = 0;
          player.grounded = true;
          player.jumpsLeft = game.effects.double > 0 ? 2 : 1;
          landed = true;

          const screenY = plat.y - game.cameraY;
          if (screenY < H * 0.6 && plat.type !== 'ground') {
            game.floor++;
            game.combo = Math.min(10, game.combo + 1);
            game.comboTimer = 2500;
            playSound(300 + game.combo * 40, 0.05, 'sine');
            checkAchievements();
          }
          break;
        }
      }
      if (!landed && player.grounded) player.grounded = false;

      for (let i = game.powerups.length - 1; i >= 0; i--) {
        const pu = game.powerups[i];
        const dx = (player.x + player.width / 2) - pu.x;
        const dy = (player.y + player.height / 2) - pu.y;
        if (Math.sqrt(dx * dx + dy * dy) < 25) {
          applyPowerup(pu.type);
          game.powerups.splice(i, 1);
        }
      }

      game.cameraTargetY = Math.min(game.cameraTargetY, player.y - H * 0.45);
      game.cameraY += (game.cameraTargetY - game.cameraY) * PHYSICS.cameraSmooth * dtNorm;

      const cutoff = game.cameraY + H + 80;
      game.platforms = game.platforms.filter(p => p.y < cutoff);
      game.powerups = game.powerups.filter(p => p.y < cutoff);

      while (game.platforms.length < 40) {
        const topY = Math.min(...game.platforms.map(p => p.y));
        const newY = topY - (50 + Math.random() * 35);
        const plat = createPlatform(newY);
        game.platforms.push(plat);
        if (Math.random() < 0.1 && plat.y < H - 100) {
          const types = ['double', 'slow', 'boost'];
          game.powerups.push({ x: plat.x + plat.w / 2, y: plat.y - 12, type: types[Math.floor(Math.random() * 3)], bob: Math.random() * Math.PI * 2 });
        }
      }

      if (player.y - game.cameraY > H + 40) endGame();

      // Update particles
      for (let i = game.particles.length - 1; i >= 0; i--) {
        const p = game.particles[i];
        p.x += p.vx * dtNorm;
        p.y += p.vy * dtNorm;
        p.vy += 0.1 * dtNorm;
        p.life -= dt / 1000;
        if (p.life <= 0) game.particles.splice(i, 1);
      }
    }

    function applyPowerup(type) {
      game.effects[type] = 8000;
      const msgs = { double: 'Double Jump!', slow: 'Slow Motion!', boost: 'Super Jump!' };
      playSound(600, 0.1, 'sine');
      showToast(msgs[type]);
      unlock('firstPower');
    }

    // Draw
    function draw() {
      // Win95 style background
      ctx.fillStyle = '#000080';
      ctx.fillRect(0, 0, W, H);

      // Pixel grid effect
      ctx.fillStyle = 'rgba(0,0,128,0.3)';
      for (let y = 0; y < H; y += 4) {
        ctx.fillRect(0, y, W, 1);
      }

      const cam = game.cameraY;

      // Platforms - Win95 style 3D
      for (const plat of game.platforms) {
        const py = plat.y - cam;
        if (py < -20 || py > H + 20) continue;

        // Platform body
        ctx.fillStyle = plat.type === 'special' ? '#ffff00' : plat.type === 'ground' ? '#808080' : '#c0c0c0';
        ctx.fillRect(plat.x, py, plat.w, plat.h);

        // 3D borders
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(plat.x, py, plat.w, 2);
        ctx.fillRect(plat.x, py, 2, plat.h);

        ctx.fillStyle = '#808080';
        ctx.fillRect(plat.x, py + plat.h - 2, plat.w, 2);
        ctx.fillRect(plat.x + plat.w - 2, py, 2, plat.h);
      }

      // Powerups
      for (const pu of game.powerups) {
        const py = pu.y - cam;
        if (py < -20 || py > H + 20) continue;
        pu.bob += 0.05;
        const bobY = py + Math.sin(pu.bob) * 3;

        let color = '#00ff00';
        if (pu.type === 'slow') color = '#ffff00';
        if (pu.type === 'boost') color = '#ff00ff';

        ctx.fillStyle = color;
        ctx.fillRect(pu.x - 8, bobY - 8, 16, 16);
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(pu.x - 8, bobY - 8, 16, 2);
        ctx.fillRect(pu.x - 8, bobY - 8, 2, 16);
        ctx.fillStyle = '#808080';
        ctx.fillRect(pu.x - 8, bobY + 6, 16, 2);
        ctx.fillRect(pu.x + 6, bobY - 8, 2, 16);
      }

      // Particles
      for (const p of game.particles) {
        const alpha = p.life / p.maxLife;
        ctx.globalAlpha = alpha;
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x - 2, p.y - cam - 2, 4, 4);
      }
      ctx.globalAlpha = 1;

      // Player - pixelated character
      const px = player.x;
      const py = player.y - cam;

      // Body (Win95 gray)
      ctx.fillStyle = '#c0c0c0';
      ctx.fillRect(px, py, player.width, player.height);

      // 3D effect
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(px, py, player.width, 2);
      ctx.fillRect(px, py, 2, player.height);
      ctx.fillStyle = '#808080';
      ctx.fillRect(px, py + player.height - 2, player.width, 2);
      ctx.fillRect(px + player.width - 2, py, 2, player.height);

      // Face
      ctx.fillStyle = '#000000';
      const eyeOff = player.facingRight ? 2 : -2;
      ctx.fillRect(px + 6 + eyeOff, py + 8, 4, 4);
      ctx.fillRect(px + 14 + eyeOff, py + 8, 4, 4);
      ctx.fillRect(px + 8 + eyeOff, py + 18, 8, 2);

      // Scarf (blue like Win95 titlebar)
      ctx.fillStyle = '#000080';
      ctx.fillRect(px + 2, py + 6, player.width - 4, 4);

      // HUD
      document.getElementById('floor').textContent = game.floor;
      document.getElementById('best').textContent = game.best;
      document.getElementById('combo').textContent = 'x' + game.combo;
    }

    // Game Loop
    function gameLoop(timestamp) {
      const dt = Math.min(32, timestamp - game.lastTime || 16);
      game.lastTime = timestamp;
      if (game.running && !game.paused) update(dt);
      draw();
      requestAnimationFrame(gameLoop);
    }
    requestAnimationFrame(gameLoop);

    // UI
    const startOverlay = document.getElementById('startOverlay');
    const gameOverOverlay = document.getElementById('gameOverOverlay');

    document.getElementById('playBtn').onclick = startGame;
    document.getElementById('playAgainBtn').onclick = () => { gameOverOverlay.classList.remove('show'); startGame(); };
    document.getElementById('pauseBtn').onclick = togglePause;
    document.getElementById('restartBtn').onclick = () => { if (game.running) { game.running = false; resetWorld(); draw(); } };

    const soundMenu = document.getElementById('soundMenu');
    const startMuteBtn = document.getElementById('startMuteBtn');
    function updateMuteUI() {
      soundMenu.textContent = game.muted ? 'Sound: Off' : 'Sound: On';
      startMuteBtn.textContent = game.muted ? 'üîá' : 'üîä';
    }
    soundMenu.onclick = startMuteBtn.onclick = () => { game.muted = !game.muted; updateMuteUI(); };

    document.getElementById('shareBtn').onclick = () => {
      const text = encodeURIComponent(`I reached floor ${game.lastFloor} in Icy Tower! üßä`);
      const url = encodeURIComponent('https://sloppy.live/icy-tower');
      window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank');
    };

    function startGame() {
      if (game.running) return;
      startOverlay.classList.remove('show');
      gameOverOverlay.classList.remove('show');
      resetWorld();
      game.running = true;
      game.paused = false;
    }

    function togglePause() {
      if (!game.running) return;
      game.paused = !game.paused;
      document.getElementById('pauseBtn').textContent = game.paused ? 'Resume (P)' : 'Pause (P)';
    }

    function endGame() {
      game.running = false;
      game.lastFloor = game.floor;
      game.best = Math.max(game.best, game.floor);
      localStorage.setItem('icy-best', game.best);
      document.getElementById('finalFloor').textContent = game.floor;
      gameOverOverlay.classList.add('show');
      if (game.floor >= game.best && game.floor > 0) unlock('newPB');
    }

    // Power chips
    const chipsEl = document.getElementById('powerChips');
    function renderPowerChips() {
      const chips = [];
      if (game.effects.double > 0) chips.push({ type: 'double', label: '2x Jump', time: Math.ceil(game.effects.double / 1000) });
      if (game.effects.slow > 0) chips.push({ type: 'slow', label: 'Slow', time: Math.ceil(game.effects.slow / 1000) });
      if (game.effects.boost > 0) chips.push({ type: 'boost', label: 'Boost', time: Math.ceil(game.effects.boost / 1000) });
      chipsEl.innerHTML = chips.map(c => `
        <div class="power-chip">
          <div class="power-chip-icon ${c.type}"></div>
          ${c.label} ${c.time}s
        </div>
      `).join('');
    }

    // Toast
    const toastEl = document.getElementById('toast');
    let toastTimer = null;
    function showToast(msg) {
      clearTimeout(toastTimer);
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      toastTimer = setTimeout(() => toastEl.classList.remove('show'), 1200);
    }

    // Achievements
    const ACHIEVEMENTS = [
      { key: 'floor20', name: 'Getting Started', check: () => game.floor >= 20 },
      { key: 'floor50', name: 'Climber', check: () => game.floor >= 50 },
      { key: 'floor100', name: 'Icy Pro', check: () => game.floor >= 100 },
      { key: 'combo7', name: 'Combo x7', check: () => game.combo >= 7 },
      { key: 'combo10', name: 'Combo x10', check: () => game.combo >= 10 },
      { key: 'firstPower', name: 'Powered Up', check: () => false },
      { key: 'savedScore', name: 'On The Board', check: () => false },
      { key: 'newPB', name: 'New Record', check: () => false },
    ];

    let unlocked = {};
    try { unlocked = JSON.parse(localStorage.getItem('icy-achievements') || '{}'); } catch {}

    function saveAchievements() { localStorage.setItem('icy-achievements', JSON.stringify(unlocked)); }
    function unlock(key) {
      if (unlocked[key]) return;
      unlocked[key] = true;
      saveAchievements();
      const ach = ACHIEVEMENTS.find(a => a.key === key);
      if (ach) showToast('üèÜ ' + ach.name);
    }
    function checkAchievements() {
      for (const a of ACHIEVEMENTS) {
        if (!unlocked[a.key] && a.check()) unlock(a.key);
      }
    }

    // Leaderboard
    let currentUser = null;
    const leaderboardEl = document.getElementById('leaderboard');

    async function initAuth() {
      try {
        const { user } = await supabaseSession();
        currentUser = user;
      } catch (e) { console.error('Auth error:', e); }
      loadLeaderboard();
    }

    async function loadLeaderboard() {
      try {
        const { data, error } = await supabase
          .from('icy_tower_scores')
          .select('score, display_name')
          .order('score', { ascending: false })
          .limit(8);

        if (error) throw error;

        const header = '<div class="win95-list-item header"><span class="rank">#</span><span class="name">Name</span><span class="score">Score</span></div>';

        if (!data || data.length === 0) {
          leaderboardEl.innerHTML = header + '<div class="win95-list-item"><span class="rank"></span><span class="name" style="color:#808080">No scores</span><span class="score"></span></div>';
          return;
        }

        leaderboardEl.innerHTML = header + data.map((row, i) => `
          <div class="win95-list-item">
            <span class="rank">${i + 1}</span>
            <span class="name">${escapeHtml(row.display_name || 'Anon')}</span>
            <span class="score">${row.score}</span>
          </div>
        `).join('');
      } catch (e) { console.error('Leaderboard error:', e); }
    }

    document.getElementById('refreshBtn').onclick = loadLeaderboard;

    const saveScoreBtn = document.getElementById('saveScoreBtn');
    const skipSaveBtn = document.getElementById('skipSaveBtn');
    const saveError = document.getElementById('saveError');
    const playerNameInput = document.getElementById('playerName');
    const saveBlock = document.getElementById('saveBlock');

    skipSaveBtn.onclick = () => saveBlock.style.display = 'none';
    saveScoreBtn.onclick = async () => {
      saveError.style.display = 'none';
      try {
        const name = (playerNameInput.value || 'Player').slice(0, 20);
        const { error } = await supabase.from('icy_tower_scores').insert([{
          score: game.lastFloor,
          display_name: name,
          user_id: currentUser?.id
        }]);
        if (error) throw error;
        saveBlock.style.display = 'none';
        unlock('savedScore');
        loadLeaderboard();
      } catch (e) {
        saveError.textContent = 'Error: ' + e.message;
        saveError.style.display = 'block';
      }
    };

    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    // Init
    resetWorld();
    draw();
    initAuth();
  </script>
</body>
</html>
