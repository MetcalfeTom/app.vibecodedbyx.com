<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sloppy Friends ‚Äî Social Hub</title>
    <link rel="icon" href="https://emojicdn.elk.sh/üë•">

    <!-- Open Graph -->
    <meta property="og:title" content="Sloppy Friends ‚Äî Social Hub">
    <meta property="og:description" content="See who's online, follow friends, check mentions, and vibe with the community.">
    <meta property="og:url" content="https://app.sloppy.live/sloppy-friends">
    <meta property="og:image" content="https://image.pollinations.ai/prompt/social%20network%20graph%20neon%20connections%20dark%20background%20cyan%20green%20nodes%20pulsing%20digital%20community?width=1200&height=630&nologo=true&referrer=sloppy.live">
    <meta property="og:type" content="website">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Sloppy Friends ‚Äî Social Hub">
    <meta name="twitter:description" content="See who's online, follow friends, check mentions, and vibe with the community.">
    <meta name="twitter:image" content="https://image.pollinations.ai/prompt/social%20network%20graph%20neon%20connections%20dark%20background%20cyan%20green%20nodes%20pulsing%20digital%20community?width=1200&height=630&nologo=true&referrer=sloppy.live">
    <meta name="description" content="See who's online, follow friends, check mentions, and vibe with the community.">
    <meta name="theme-color" content="#0b1420">

    <link href="https://fonts.googleapis.com/css2?family=Overpass:wght@200;400;700;900&family=IBM+Plex+Mono:wght@300;500&display=swap" rel="stylesheet">

    <script>
    window.onerror=function(m,s,l,c,e){try{var x=new XMLHttpRequest();x.open('POST','https://yjyxteqzhhmtrgcaekgz.supabase.co/rest/v1/error_logs',true);x.setRequestHeader('Content-Type','application/json');x.setRequestHeader('apikey','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM8IS32IUYR2eenCCjdDdioiBU');x.send(JSON.stringify({app:'sloppy-friends',message:String(m).slice(0,500),source:String(s).slice(0,200),line:l,col:c,stack:e&&e.stack?String(e.stack).slice(0,1000):''}));}catch(ex){}};
    window.addEventListener('unhandledrejection',function(ev){window.onerror('UnhandledRejection: '+(ev.reason&&ev.reason.message||ev.reason),'',0,0,ev.reason);});
    </script>

    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg-deep: #0b1420;
            --bg-panel: #111d2e;
            --bg-card: #162235;
            --border: #1e3348;
            --accent: #00e5a0;
            --accent-dim: rgba(0, 229, 160, 0.15);
            --accent-glow: rgba(0, 229, 160, 0.25);
            --highlight: #50fa7b;
            --text: #c8d6e5;
            --text-dim: #6b8299;
            --text-bright: #e8f0f8;
            --mention-purple: #c471ed;
            --danger: #ff6b6b;
            --font-display: 'Overpass', sans-serif;
            --font-mono: 'IBM Plex Mono', monospace;
        }

        html, body {
            height: 100%;
            font-family: var(--font-display);
            background: var(--bg-deep);
            color: var(--text);
            overflow: hidden;
        }

        /* === EMBED MODE === */
        body.embed-mode {
            background: transparent;
            overflow-y: auto;
        }

        body.embed-mode .standalone-only { display: none !important; }
        body:not(.embed-mode) .embed-only { display: none !important; }

        /* === STANDALONE LAYOUT === */
        .app-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            max-width: 960px;
            margin: 0 auto;
        }

        body.embed-mode .app-container {
            max-width: 100%;
        }

        .app-header {
            padding: 20px 24px 16px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .app-title {
            font-family: var(--font-display);
            font-weight: 900;
            font-size: 1.8rem;
            color: var(--accent);
            letter-spacing: -0.03em;
        }

        .app-subtitle {
            font-family: var(--font-mono);
            font-weight: 300;
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-top: 4px;
        }

        .back-link {
            display: inline-block;
            margin-top: 8px;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--text-dim);
            text-decoration: none;
        }
        .back-link:hover { color: var(--accent); }

        /* === TABS === */
        .social-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            overflow-x: auto;
        }

        .social-tab {
            flex: 1;
            padding: 10px 16px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-dim);
            font-family: var(--font-mono);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .social-tab:hover { color: var(--text); background: var(--accent-dim); }
        .social-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

        .tab-badge {
            display: inline-block;
            background: var(--accent);
            color: var(--bg-deep);
            font-size: 0.65rem;
            font-weight: 700;
            padding: 1px 5px;
            border-radius: 8px;
            margin-left: 4px;
            vertical-align: middle;
        }

        /* === PANELS === */
        .social-panel {
            display: none;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
        .social-panel.active { display: flex; flex-direction: column; }

        /* === ONLINE USERS (embed + standalone) === */
        .away-status-section {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
        }

        .away-input-row {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .away-input {
            flex: 1;
            background: var(--bg-deep);
            border: 1px solid var(--border);
            color: var(--text-bright);
            padding: 5px 10px;
            font-family: var(--font-mono);
            font-size: 0.8rem;
            border-radius: 4px;
            outline: none;
        }

        .away-input:focus { border-color: var(--accent); box-shadow: 0 0 6px var(--accent-glow); }
        .away-input::placeholder { color: var(--text-dim); font-style: italic; }

        .away-btn {
            background: var(--accent);
            color: var(--bg-deep);
            border: none;
            padding: 5px 10px;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            font-weight: 700;
            border-radius: 4px;
            cursor: pointer;
            transition: filter 0.2s;
        }
        .away-btn:hover { filter: brightness(1.15); }

        .current-status {
            display: none;
            align-items: center;
            gap: 6px;
            margin-top: 6px;
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .current-status .status-val {
            color: var(--accent);
            font-style: italic;
        }

        .clear-btn {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 0.7rem;
            font-family: var(--font-mono);
        }
        .clear-btn:hover { text-decoration: underline; }

        /* User list */
        .user-list {
            list-style: none;
            padding: 4px 0;
            flex: 1;
            overflow-y: auto;
        }

        body.embed-mode .user-list {
            max-height: none;
        }

        .user-item {
            padding: 5px 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-left: 2px solid transparent;
            transition: all 0.15s;
            cursor: pointer;
        }

        .user-item:hover {
            background: rgba(0, 229, 160, 0.05);
            border-left-color: var(--accent);
        }

        .user-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--accent);
            animation: dotPulse 2s infinite;
            flex-shrink: 0;
        }

        @keyframes dotPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .user-avatar-img {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-avatar-emoji { font-size: 1.1rem; }

        .user-info {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex: 1;
        }

        .user-name {
            font-size: 0.85rem;
            font-weight: 400;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .user-status-text {
            font-size: 0.7rem;
            color: var(--text-dim);
            font-style: italic;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* === ACTIVITY FEED === */
        .feed-list {
            padding: 8px 12px;
            flex: 1;
            overflow-y: auto;
        }

        .feed-entry {
            padding: 6px 8px;
            margin-bottom: 4px;
            background: rgba(255,255,255,0.02);
            border-left: 2px solid var(--border);
            font-size: 0.85rem;
        }

        .feed-who {
            color: var(--highlight);
            cursor: pointer;
        }
        .feed-who:hover { text-decoration: underline; }

        .feed-what { color: var(--text-dim); }

        .feed-when {
            color: #445566;
            font-size: 0.75rem;
            font-family: var(--font-mono);
        }

        /* === FOLLOWERS / FOLLOWING === */
        .follow-section {
            padding: 12px;
        }

        .follow-header {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .follow-toggle {
            flex: 1;
            padding: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-dim);
            font-family: var(--font-mono);
            font-size: 0.8rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .follow-toggle.active {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-dim);
        }

        .follow-toggle .follow-count {
            display: block;
            font-family: var(--font-display);
            font-weight: 900;
            font-size: 1.4rem;
            color: var(--text-bright);
        }

        .follow-toggle.active .follow-count { color: var(--accent); }

        .follow-list {
            list-style: none;
        }

        .follow-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            cursor: pointer;
        }

        .follow-item:hover { background: var(--accent-dim); }

        .follow-item-name {
            flex: 1;
            font-size: 0.85rem;
            color: var(--text-bright);
        }

        .follow-item-date {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: var(--text-dim);
        }

        /* === MENTIONS === */
        .mentions-list {
            padding: 8px 12px;
            flex: 1;
            overflow-y: auto;
        }

        .mention-entry {
            padding: 8px 10px;
            margin-bottom: 6px;
            background: var(--bg-card);
            border-left: 3px solid var(--mention-purple);
            border-radius: 0 6px 6px 0;
        }

        .mention-entry.unseen {
            background: rgba(196, 113, 237, 0.08);
            border-left-color: var(--highlight);
        }

        .mention-from {
            font-weight: 700;
            color: var(--mention-purple);
            cursor: pointer;
        }
        .mention-from:hover { text-decoration: underline; }

        .mention-source {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .mention-time {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: #445566;
        }

        /* === EMPTY STATE === */
        .empty-state {
            padding: 32px 16px;
            text-align: center;
            color: var(--text-dim);
            font-size: 0.85rem;
        }

        .empty-state .icon { font-size: 2rem; margin-bottom: 8px; }

        /* === LOADING === */
        .loading-spinner {
            display: flex;
            justify-content: center;
            padding: 24px;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* === ONLINE COUNT (embed) === */
        .online-count {
            padding: 6px 12px;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--text-dim);
            border-bottom: 1px solid var(--border);
        }

        .online-count .count-num { color: var(--accent); font-weight: 700; }

        /* === SCROLLBAR === */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* === MOBILE === */
        @media (max-width: 600px) {
            .app-header { padding: 14px 16px 12px; }
            .app-title { font-size: 1.4rem; }
            .social-tab { padding: 8px 10px; font-size: 0.7rem; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- STANDALONE HEADER -->
        <div class="app-header standalone-only">
            <div class="app-title">SLOPPY FRIENDS</div>
            <div class="app-subtitle">social hub // who's online, follows, mentions</div>
            <a href="https://sloppy.live" class="back-link" target="_blank">&larr; back to stream</a>
        </div>

        <!-- STANDALONE TABS -->
        <div class="social-tabs standalone-only">
            <button class="social-tab active" data-tab="online" onclick="switchTab('online')">
                ONLINE <span class="tab-badge" id="onlineCountBadge">0</span>
            </button>
            <button class="social-tab" data-tab="follows" onclick="switchTab('follows')">
                FOLLOWS
            </button>
            <button class="social-tab" data-tab="mentions" onclick="switchTab('mentions')">
                MENTIONS <span class="tab-badge" id="mentionCountBadge" style="display:none;background:var(--mention-purple)">0</span>
            </button>
            <button class="social-tab" data-tab="activity" onclick="switchTab('activity')">
                ACTIVITY
            </button>
        </div>

        <!-- ONLINE PANEL (used in both standalone and embed) -->
        <div class="social-panel active" id="onlinePanel">
            <div class="away-status-section">
                <div class="away-input-row">
                    <input type="text" class="away-input" id="awayInput"
                        placeholder="Set your status..." maxlength="50">
                    <button class="away-btn" id="awaySetBtn">SET</button>
                </div>
                <div class="current-status" id="currentStatus">
                    Status: <span class="status-val" id="statusVal"></span>
                    <button class="clear-btn" id="clearStatusBtn">clear</button>
                </div>
            </div>
            <div class="online-count" id="onlineCountBar">
                <span class="count-num" id="onlineNum">0</span> online
            </div>
            <ul class="user-list" id="userList"></ul>
        </div>

        <!-- FOLLOWS PANEL (standalone only) -->
        <div class="social-panel standalone-only" id="followsPanel">
            <div class="follow-section">
                <div class="follow-header">
                    <button class="follow-toggle active" id="followersToggle" onclick="showFollowTab('followers')">
                        <span class="follow-count" id="followersCount">0</span>
                        followers
                    </button>
                    <button class="follow-toggle" id="followingToggle" onclick="showFollowTab('following')">
                        <span class="follow-count" id="followingCount">0</span>
                        following
                    </button>
                </div>
                <ul class="follow-list" id="followList"></ul>
                <div class="empty-state" id="followEmpty" style="display:none;">
                    <div class="icon">ü§ù</div>
                    <p>No connections yet</p>
                </div>
            </div>
        </div>

        <!-- MENTIONS PANEL (standalone only) -->
        <div class="social-panel standalone-only" id="mentionsPanel">
            <div class="mentions-list" id="mentionsList">
                <div class="loading-spinner"><div class="spinner"></div></div>
            </div>
        </div>

        <!-- ACTIVITY PANEL (standalone only) -->
        <div class="social-panel standalone-only" id="activityPanel">
            <div class="feed-list" id="activityFeed">
                <div class="feed-entry">
                    <span class="feed-who">System</span>
                    <span class="feed-what">initialized</span>
                    <div class="feed-when">just now</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { createBrowserClient } from "https://cdn.jsdelivr.net/npm/@supabase/ssr@0.7.0/+esm";

        const SUPABASE_URL = 'https://yjyxteqzhhmtrgcaekgz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM8IS32IUYR2eenCCjdDdioiBU';

        const getCookieDomain = () => {
            const h = window.location.hostname;
            if (h.includes('sloppy.live')) return '.sloppy.live';
            if (h.includes('vibecodedbyx.com')) return '.vibecodedbyx.com';
            return '.youreabsolutelyright.xyz';
        };

        const supabase = createBrowserClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            cookieOptions: { name: 'sb-auth-token', domain: getCookieDomain(), path: '/', sameSite: 'lax' }
        });

        // === STATE ===
        const isEmbed = new URLSearchParams(window.location.search).get('embed') === 'true';
        let currentUser = null;
        let profile = { username: 'anon_' + Math.random().toString(36).slice(2, 7), avatar: 'üë§', color: '#00e5a0', status: '' };
        let presenceChannel = null;
        let onlineUsers = [];
        let activeFollowTab = 'followers';
        let mentionCheckInterval = null;

        // === INIT ===
        if (isEmbed) {
            document.body.classList.add('embed-mode');
        }

        async function init() {
            // Auth
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
            } else {
                const { data } = await supabase.auth.signInAnonymously();
                currentUser = data?.session?.user || null;
            }

            // Get profile
            if (currentUser) {
                const { data: prof } = await supabase
                    .from('sloppygram_profiles')
                    .select('username, avatar, avatar_url, color, status')
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                if (prof) {
                    profile.username = prof.username || profile.username;
                    profile.avatar = prof.avatar || 'üë§';
                    profile.avatarUrl = prof.avatar_url || null;
                    profile.color = prof.color || '#00e5a0';
                    profile.status = prof.status || '';
                }
            }

            // Restore status display
            if (profile.status) {
                showCurrentStatus(profile.status);
            }

            if (isEmbed) {
                initEmbed();
            } else {
                initStandalone();
            }
        }

        // === EMBED MODE ===
        function initEmbed() {
            // Listen for messages from parent
            window.addEventListener('message', handleParentMessage);

            // Notify parent we're ready
            window.parent.postMessage({ type: 'friends-ready' }, '*');
        }

        function handleParentMessage(ev) {
            const msg = ev.data;
            if (!msg || !msg.type) return;

            switch (msg.type) {
                case 'presence-sync':
                    onlineUsers = msg.users || [];
                    renderOnlineUsers();
                    break;
                case 'presence-join':
                    addActivityEntry(msg.username || 'Someone', 'joined the chat');
                    break;
                case 'presence-leave':
                    addActivityEntry(msg.username || 'Someone', 'left the chat');
                    break;
                case 'set-profile':
                    if (msg.profile) {
                        profile = { ...profile, ...msg.profile };
                        if (msg.userId) currentUser = { id: msg.userId };
                    }
                    break;
            }
        }

        // === STANDALONE MODE ===
        function initStandalone() {
            setupOwnPresence();
            loadFollowCounts();
            loadMentions();
            mentionCheckInterval = setInterval(checkMentions, 30000);
            setTimeout(checkMentions, 3000);
        }

        async function setupOwnPresence() {
            if (presenceChannel) {
                presenceChannel.unsubscribe();
                supabase.removeChannel(presenceChannel);
            }

            presenceChannel = supabase.channel('sloppygram_presence', {
                config: {
                    presence: { key: currentUser?.id || ('anon_' + Math.random()) }
                }
            });

            presenceChannel
                .on('presence', { event: 'sync' }, () => {
                    const state = presenceChannel.presenceState();
                    const users = [];
                    const seen = {};
                    Object.values(state).forEach(presences => {
                        presences.forEach(p => {
                            if (!seen[p.username]) {
                                seen[p.username] = true;
                                users.push(p);
                            }
                        });
                    });
                    onlineUsers = users;
                    renderOnlineUsers();
                })
                .on('presence', { event: 'join' }, ({ newPresences }) => {
                    const user = newPresences?.[0]?.username || 'Someone';
                    addActivityEntry(user, 'joined');
                })
                .on('presence', { event: 'leave' }, ({ leftPresences }) => {
                    const user = leftPresences?.[0]?.username || 'Someone';
                    addActivityEntry(user, 'left');
                });

            presenceChannel.subscribe(async (status) => {
                if (status === 'SUBSCRIBED') {
                    await presenceChannel.track({
                        username: profile.username,
                        avatar: profile.avatar,
                        avatarUrl: profile.avatarUrl || null,
                        color: profile.color,
                        status: profile.status || '',
                        online_at: new Date().toISOString()
                    });
                }
            });
        }

        // === AWAY STATUS ===
        const awayInput = document.getElementById('awayInput');
        const awaySetBtn = document.getElementById('awaySetBtn');
        const clearStatusBtn = document.getElementById('clearStatusBtn');

        awayInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') setStatus();
        });
        awaySetBtn.addEventListener('click', setStatus);
        clearStatusBtn.addEventListener('click', clearStatus);

        function setStatus() {
            const val = awayInput.value.trim();
            if (!val) return;

            profile.status = val;
            awayInput.value = '';
            showCurrentStatus(val);

            if (isEmbed) {
                window.parent.postMessage({ type: 'set-status', status: val }, '*');
            } else {
                updatePresenceTrack();
            }
        }

        function clearStatus() {
            profile.status = '';
            hideCurrentStatus();

            if (isEmbed) {
                window.parent.postMessage({ type: 'clear-status' }, '*');
            } else {
                updatePresenceTrack();
            }
        }

        function showCurrentStatus(text) {
            const el = document.getElementById('currentStatus');
            const valEl = document.getElementById('statusVal');
            if (el) el.style.display = 'flex';
            if (valEl) valEl.textContent = text;
        }

        function hideCurrentStatus() {
            const el = document.getElementById('currentStatus');
            if (el) el.style.display = 'none';
        }

        async function updatePresenceTrack() {
            if (!presenceChannel) return;
            await presenceChannel.track({
                username: profile.username,
                avatar: profile.avatar,
                avatarUrl: profile.avatarUrl || null,
                color: profile.color,
                status: profile.status || '',
                online_at: new Date().toISOString()
            });
        }

        // === RENDER ONLINE USERS ===
        function renderOnlineUsers() {
            const list = document.getElementById('userList');
            const countBadge = document.getElementById('onlineCountBadge');
            const countNum = document.getElementById('onlineNum');
            const count = onlineUsers.length;

            if (countBadge) countBadge.textContent = count;
            if (countNum) countNum.textContent = count;

            list.innerHTML = onlineUsers.map(u => {
                const safeName = escapeHtml(u.username || 'anon');
                const avatarHtml = u.avatarUrl
                    ? `<img class="user-avatar-img" src="${escapeAttr(u.avatarUrl)}" alt="">`
                    : `<span class="user-avatar-emoji">${u.avatar || 'üë§'}</span>`;
                const statusHtml = u.status
                    ? `<span class="user-status-text">${escapeHtml(u.status)}</span>`
                    : '';
                const color = u.color || 'var(--text-bright)';

                return `<li class="user-item" onclick="handleUserClick('${escapeAttr(u.username)}')">
                    <span class="user-dot"></span>
                    ${avatarHtml}
                    <div class="user-info">
                        <span class="user-name" style="color:${color}">${safeName}</span>
                        ${statusHtml}
                    </div>
                </li>`;
            }).join('');
        }

        // === ACTIVITY FEED ===
        function addActivityEntry(who, action) {
            const feed = document.getElementById('activityFeed');
            if (!feed) return;
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            const div = document.createElement('div');
            div.className = 'feed-entry';
            div.innerHTML = `
                <span class="feed-who" onclick="handleUserClick('${escapeAttr(who)}')">${escapeHtml(who)}</span>
                <span class="feed-what">${escapeHtml(action)}</span>
                <div class="feed-when">${time}</div>
            `;
            feed.insertBefore(div, feed.firstChild);

            while (feed.children.length > 30) {
                feed.removeChild(feed.lastChild);
            }
        }

        // === FOLLOWS ===
        async function loadFollowCounts() {
            if (!profile.username) return;

            const [followers, following] = await Promise.all([
                getFollowers(profile.username),
                getFollowing(profile.username)
            ]);

            document.getElementById('followersCount').textContent = followers.length;
            document.getElementById('followingCount').textContent = following.length;

            renderFollowList(activeFollowTab === 'followers' ? followers : following);
        }

        async function getFollowers(username, limit = 50) {
            try {
                const { data } = await supabase
                    .from('sloppygram_follows')
                    .select('follower_username, created_at')
                    .eq('followed_username', username)
                    .order('created_at', { ascending: false })
                    .limit(limit);
                return data || [];
            } catch { return []; }
        }

        async function getFollowing(username, limit = 50) {
            try {
                const { data } = await supabase
                    .from('sloppygram_follows')
                    .select('followed_username, created_at')
                    .eq('follower_username', username)
                    .order('created_at', { ascending: false })
                    .limit(limit);
                return data || [];
            } catch { return []; }
        }

        window.showFollowTab = async function(tab) {
            activeFollowTab = tab;
            document.getElementById('followersToggle').classList.toggle('active', tab === 'followers');
            document.getElementById('followingToggle').classList.toggle('active', tab === 'following');

            const list = tab === 'followers'
                ? await getFollowers(profile.username)
                : await getFollowing(profile.username);
            renderFollowList(list);
        };

        function renderFollowList(items) {
            const list = document.getElementById('followList');
            const empty = document.getElementById('followEmpty');

            if (!items || items.length === 0) {
                list.innerHTML = '';
                if (empty) empty.style.display = 'block';
                return;
            }

            if (empty) empty.style.display = 'none';

            list.innerHTML = items.map(item => {
                const name = item.follower_username || item.followed_username;
                const date = new Date(item.created_at).toLocaleDateString();
                return `<li class="follow-item" onclick="handleUserClick('${escapeAttr(name)}')">
                    <span class="user-dot"></span>
                    <span class="follow-item-name">${escapeHtml(name)}</span>
                    <span class="follow-item-date">${date}</span>
                </li>`;
            }).join('');
        }

        // === MENTIONS ===
        async function loadMentions() {
            if (!profile.username || !currentUser) return;

            const container = document.getElementById('mentionsList');

            try {
                const { data, error } = await supabase
                    .from('sloppygram_mentions')
                    .select('*')
                    .eq('mentioned_username', profile.username)
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error || !data) {
                    container.innerHTML = '<div class="empty-state"><div class="icon">üì≠</div><p>No mentions yet</p></div>';
                    return;
                }

                if (data.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="icon">üì≠</div><p>No mentions yet</p></div>';
                    return;
                }

                const unseenCount = data.filter(m => !m.seen).length;
                const badge = document.getElementById('mentionCountBadge');
                if (badge) {
                    if (unseenCount > 0) {
                        badge.textContent = unseenCount;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }

                container.innerHTML = data.map(m => {
                    const time = new Date(m.created_at).toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    return `<div class="mention-entry${m.seen ? '' : ' unseen'}">
                        <span class="mention-from" onclick="handleUserClick('${escapeAttr(m.source_username)}')">${escapeHtml(m.source_username)}</span>
                        <span class="mention-source">mentioned you in a ${escapeHtml(m.source_type || 'message')}</span>
                        <div class="mention-time">${time}</div>
                    </div>`;
                }).join('');

                // Mark unseen as seen
                if (unseenCount > 0) {
                    const unseenIds = data.filter(m => !m.seen).map(m => m.id);
                    await supabase
                        .from('sloppygram_mentions')
                        .update({ seen: true })
                        .in('id', unseenIds);
                }
            } catch (err) {
                console.error('Error loading mentions:', err);
                container.innerHTML = '<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><p>Failed to load mentions</p></div>';
            }
        }

        async function checkMentions() {
            if (!profile.username || !currentUser) return;
            try {
                const { data } = await supabase
                    .from('sloppygram_mentions')
                    .select('source_username, source_type, seen')
                    .eq('mentioned_username', profile.username)
                    .eq('seen', false)
                    .limit(10);

                const badge = document.getElementById('mentionCountBadge');
                if (data && data.length > 0 && badge) {
                    badge.textContent = data.length;
                    badge.style.display = 'inline-block';
                }

                // In embed mode, notify parent about unseen mentions
                if (isEmbed && data && data.length > 0) {
                    const recent = data[0];
                    window.parent.postMessage({
                        type: 'mention-alert',
                        from: recent.source_username,
                        sourceType: recent.source_type,
                        count: data.length
                    }, '*');
                }
            } catch (err) {
                console.error('Mention check error:', err);
            }
        }

        // === TAB SWITCHING ===
        window.switchTab = function(tab) {
            document.querySelectorAll('.social-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tab);
            });
            document.querySelectorAll('.social-panel').forEach(p => p.classList.remove('active'));

            const panel = document.getElementById(tab + 'Panel');
            if (panel) panel.classList.add('active');

            // Lazy load
            if (tab === 'follows') loadFollowCounts();
            if (tab === 'mentions') loadMentions();
        };

        // === USER CLICK ===
        window.handleUserClick = function(username) {
            if (isEmbed) {
                window.parent.postMessage({ type: 'username-click', username }, '*');
            } else {
                // Standalone: could open profile in new tab
                window.open('/sloppy-profiles/?user=' + encodeURIComponent(username), '_blank');
            }
        };

        // === UTILITIES ===
        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }

        function escapeAttr(str) {
            if (!str) return '';
            return String(str).replace(/&/g,'&amp;').replace(/'/g,'&#39;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        }

        // === START ===
        init().catch(err => console.error('Init error:', err));
    </script>
<script src="/vibelib-extended.js"></script>
<script>
  // Compatibility Patch for Legacy Apps
  window.addEventListener("load", () => {
    if (window.SloppyKarma && window.VibeLib.Economy) {
      // Redirect old calls to new engine
      window.SloppyKarma.track = window.VibeLib.Economy.track;
    }
  });
</script>
</body>
</html>
