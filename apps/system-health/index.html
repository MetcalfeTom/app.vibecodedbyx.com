<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>System Health Dashboard</title>
  <link rel="icon" href="https://emojicdn.elk.sh/ü©∫">
  <meta property="og:title" content="System Health Dashboard">
  <meta property="og:description" content="Real-time monitoring of sloppy.live database tables and services">
  <meta property="og:url" content="https://app.sloppy.live/system-health">
  <meta property="og:image" content="https://image.pollinations.ai/prompt/cyberpunk%20system%20health%20dashboard%20neon%20green%20monitoring%20grid%20dark%20terminal%20aesthetic%20server%20status?width=1200&height=630&nologo=true&referrer=sloppy.live">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-card: #1a1a24;
      --border: #2a2a3a;
      --text-primary: #e0e0e0;
      --text-secondary: #888;
      --accent-green: #00ff88;
      --accent-yellow: #ffcc00;
      --accent-red: #ff4466;
      --accent-cyan: #00ddff;
      --accent-purple: #aa66ff;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'JetBrains Mono', monospace;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
      padding-top: 40px;
    }

    .grid-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image:
        linear-gradient(rgba(0,255,136,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,255,136,0.03) 1px, transparent 1px);
      background-size: 50px 50px;
      pointer-events: none;
      z-index: 0;
    }

    .container {
      position: relative;
      z-index: 1;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      text-align: center;
      padding: 30px 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 30px;
    }

    h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: 2.5rem;
      background: linear-gradient(90deg, var(--accent-green), var(--accent-cyan));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .status-bar {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .status-dot.green { background: var(--accent-green); box-shadow: 0 0 10px var(--accent-green); }
    .status-dot.yellow { background: var(--accent-yellow); box-shadow: 0 0 10px var(--accent-yellow); }
    .status-dot.red { background: var(--accent-red); box-shadow: 0 0 10px var(--accent-red); }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .metrics-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .metric-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }

    .metric-value {
      font-family: 'Orbitron', sans-serif;
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--accent-cyan);
    }

    .metric-label {
      color: var(--text-secondary);
      font-size: 0.8rem;
      margin-top: 5px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .section {
      margin-bottom: 30px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }

    .section-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.2rem;
      color: var(--accent-purple);
    }

    .section-count {
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    .table-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 12px;
    }

    .table-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
    }

    .table-card:hover {
      border-color: var(--accent-cyan);
      transform: translateY(-2px);
    }

    .table-info {
      display: flex;
      align-items: center;
      gap: 10px;
      overflow: hidden;
    }

    .table-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .table-status.healthy { background: var(--accent-green); }
    .table-status.warning { background: var(--accent-yellow); }
    .table-status.error { background: var(--accent-red); }
    .table-status.loading { background: var(--text-secondary); animation: pulse 1s infinite; }

    .table-name {
      font-size: 0.85rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .table-stats {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .row-count {
      font-size: 0.8rem;
      color: var(--accent-green);
      font-weight: 600;
    }

    .last-update {
      font-size: 0.7rem;
      color: var(--text-secondary);
    }

    .sloppyid-panel {
      background: linear-gradient(135deg, var(--bg-card), #1a1a2e);
      border: 1px solid var(--accent-purple);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
    }

    .sloppyid-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .sloppyid-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.3rem;
      color: var(--accent-purple);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sloppyid-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
    }

    .sloppyid-stat {
      background: rgba(170, 102, 255, 0.1);
      border: 1px solid rgba(170, 102, 255, 0.3);
      border-radius: 8px;
      padding: 15px;
      text-align: center;
    }

    .sloppyid-stat-value {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.5rem;
      color: var(--accent-purple);
    }

    .sloppyid-stat-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 5px;
    }

    .refresh-bar {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 100;
    }

    .refresh-btn {
      background: var(--accent-cyan);
      color: var(--bg-primary);
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
      transition: all 0.2s;
    }

    .refresh-btn:hover {
      transform: scale(1.05);
    }

    .refresh-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .last-refresh {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .backlink {
      text-align: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .backlink a {
      color: var(--accent-cyan);
      text-decoration: none;
      font-size: 0.9rem;
    }

    .backlink a:hover {
      text-decoration: underline;
    }

    .category-icon {
      font-size: 1.2rem;
    }

    @media (max-width: 768px) {
      h1 { font-size: 1.8rem; }
      .status-bar { gap: 20px; }
      .metrics-row { grid-template-columns: repeat(2, 1fr); }
      .table-grid { grid-template-columns: 1fr; }
      .refresh-bar {
        bottom: 10px;
        right: 10px;
        left: 10px;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="grid-bg"></div>
  <div class="container">
    <header>
      <h1>ü©∫ System Health</h1>
      <p class="subtitle">Real-time monitoring of sloppy.live infrastructure</p>
      <div class="status-bar">
        <div class="status-item">
          <div class="status-dot green" id="supabaseStatus"></div>
          <span>Supabase</span>
        </div>
        <div class="status-item">
          <div class="status-dot green" id="authStatus"></div>
          <span>Auth</span>
        </div>
        <div class="status-item">
          <div class="status-dot green" id="realtimeStatus"></div>
          <span>Realtime</span>
        </div>
      </div>
    </header>

    <div class="metrics-row">
      <div class="metric-card">
        <div class="metric-value" id="totalTables">--</div>
        <div class="metric-label">Total Tables</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="healthyTables">--</div>
        <div class="metric-label">Healthy</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="totalRows">--</div>
        <div class="metric-label">Total Rows</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="activeUsers">--</div>
        <div class="metric-label">Active Users (24h)</div>
      </div>
    </div>

    <div class="sloppyid-panel">
      <div class="sloppyid-header">
        <div class="sloppyid-title">
          <span>ü™™</span> SloppyID Status
        </div>
        <div class="status-item">
          <div class="status-dot green" id="sloppyidStatus"></div>
          <span>Operational</span>
        </div>
      </div>
      <div class="sloppyid-stats">
        <div class="sloppyid-stat">
          <div class="sloppyid-stat-value" id="vaultEntries">--</div>
          <div class="sloppyid-stat-label">Vault Entries</div>
        </div>
        <div class="sloppyid-stat">
          <div class="sloppyid-stat-value" id="publicEntries">--</div>
          <div class="sloppyid-stat-label">Public Entries</div>
        </div>
        <div class="sloppyid-stat">
          <div class="sloppyid-stat-value" id="uniqueUsers">--</div>
          <div class="sloppyid-stat-label">Unique Users</div>
        </div>
        <div class="sloppyid-stat">
          <div class="sloppyid-stat-value" id="schemaKeys">4</div>
          <div class="sloppyid-stat-label">Schema Keys</div>
        </div>
      </div>
    </div>

    <div id="tableSections"></div>

    <div class="backlink">
      <a href="https://sloppy.live">‚Üê Back to sloppy.live</a>
    </div>
  </div>

  <div class="refresh-bar">
    <span class="last-refresh" id="lastRefresh">Last refresh: --</span>
    <button class="refresh-btn" id="refreshBtn" onclick="refreshAll()">‚Üª Refresh</button>
  </div>

  <script src="/supabase-config.js"></script>
  <script>
    // Table categories for organization
    const TABLE_CATEGORIES = {
      'Sloppygram Core': {
        icon: 'üí¨',
        tables: ['sloppygram_messages', 'sloppygram_profiles', 'sloppygram_posts', 'sloppygram_manifestos']
      },
      'Sloppygram Social': {
        icon: 'üë•',
        tables: ['sloppygram_post_likes', 'sloppygram_post_comments', 'sloppygram_post_reactions', 'sloppygram_post_tags',
                 'sloppygram_message_votes', 'sloppygram_message_reactions', 'sloppygram_message_tags',
                 'sloppygram_doodle_votes', 'sloppygram_doodle_comments']
      },
      'Sloppygram Manifestos': {
        icon: 'üìú',
        tables: ['sloppygram_manifesto_votes', 'sloppygram_manifesto_reactions', 'sloppygram_manifesto_comments',
                 'sloppygram_manifesto_tags', 'sloppygram_manifesto_lineage']
      },
      'Karma & Badges': {
        icon: '‚ö°',
        tables: ['sloppygram_karma', 'sloppygram_badges', 'sloppygram_reputation']
      },
      'Direct Messages': {
        icon: '‚úâÔ∏è',
        tables: ['sloppygram_dm_conversations', 'sloppygram_dm_messages']
      },
      'Collaborative': {
        icon: 'üé®',
        tables: ['sloppygram_collab_strokes', 'sloppygram_global_backgrounds', 'sloppygram_global_settings', 'sloppygram_radio']
      },
      'Comments & Threads': {
        icon: 'üí≠',
        tables: ['sloppygram_comment_threads', 'sloppygram_comment_votes']
      },
      'Identity & Auth': {
        icon: 'ü™™',
        tables: ['sloppyid_vault', 'users']
      },
      'AI & Events': {
        icon: 'ü§ñ',
        tables: ['ai_events', 'spectrum_endorsements', 'claude_diary_entries']
      },
      'Games': {
        icon: 'üéÆ',
        tables: ['breakout_terminal_scores', 'icy_tower_scores', 'tetris_leaderboard', 'star_catcher_leaderboard',
                 'neon_flappy_commands', 'sea_scourge_leaderboard', 'laptop_fire_scores', 'lighthouse_scores',
                 'pho_scores', 'simpsons_road_rage_scores', 'sloppys_gift_leaderboard', 'bouldering_scores',
                 'treasure_calculator_scores', 'toiletrun_leaderboard']
      },
      'Community': {
        icon: 'üåê',
        tables: ['chat_messages', 'live_chat_messages', 'simple_chat_messages', 'guestbook', 'guestbook_entries',
                 'love_sloppy_guestbook', 'confessions', 'feedback', 'feedback_votes', 'gratitude_entries']
      },
      'Creative': {
        icon: '‚ú®',
        tables: ['graffiti_strokes', 'lofi_beats', 'lofi_beat_votes', 'cosmic_messages', 'future_headlines',
                 'knowledge_messages', 'notes', 'oracle_log', 'quest_entries']
      },
      'Other Services': {
        icon: 'üîß',
        tables: ['app_votes', 'button_presses', 'global_stats', 'tasks', 'kanban_tasks', 'code_sprints',
                 'sprint_participants', 'daily_quests', 'accountability_goals', 'git_info', 'model_analytics',
                 'web_snapshots', 'wiki_cache', 'wiki_scout_cache']
      }
    };

    let tableData = {};
    let isRefreshing = false;

    async function init() {
      await checkConnections();
      await refreshAll();

      // Auto-refresh every 30 seconds
      setInterval(refreshAll, 30000);
    }

    async function checkConnections() {
      // Check Supabase
      try {
        const { data, error } = await supabase.from('users').select('count', { count: 'exact', head: true });
        setStatus('supabaseStatus', !error);
      } catch (e) {
        setStatus('supabaseStatus', false);
      }

      // Check Auth
      try {
        const { data: { session } } = await supabase.auth.getSession();
        setStatus('authStatus', true);
      } catch (e) {
        setStatus('authStatus', false);
      }

      // Check Realtime
      try {
        const channel = supabase.channel('health-check');
        channel.subscribe((status) => {
          setStatus('realtimeStatus', status === 'SUBSCRIBED');
          channel.unsubscribe();
        });
      } catch (e) {
        setStatus('realtimeStatus', false);
      }
    }

    function setStatus(elementId, healthy) {
      const el = document.getElementById(elementId);
      if (el) {
        el.className = 'status-dot ' + (healthy ? 'green' : 'red');
      }
    }

    async function refreshAll() {
      if (isRefreshing) return;
      isRefreshing = true;

      const btn = document.getElementById('refreshBtn');
      btn.disabled = true;
      btn.textContent = '‚Üª Loading...';

      try {
        await Promise.all([
          fetchTableCounts(),
          fetchSloppyIDStats()
        ]);
        renderTables();
        updateMetrics();
        document.getElementById('lastRefresh').textContent =
          'Last refresh: ' + new Date().toLocaleTimeString();
      } catch (e) {
        console.error('Refresh error:', e);
      }

      btn.disabled = false;
      btn.textContent = '‚Üª Refresh';
      isRefreshing = false;
    }

    async function fetchTableCounts() {
      // Get all known tables
      const allTables = new Set();
      Object.values(TABLE_CATEGORIES).forEach(cat => {
        cat.tables.forEach(t => allTables.add(t));
      });

      // Fetch counts in parallel batches
      const tables = Array.from(allTables);
      const batchSize = 10;

      for (let i = 0; i < tables.length; i += batchSize) {
        const batch = tables.slice(i, i + batchSize);
        const promises = batch.map(async (tableName) => {
          try {
            const { count, error } = await supabase
              .from(tableName)
              .select('*', { count: 'exact', head: true });

            tableData[tableName] = {
              count: error ? -1 : (count || 0),
              status: error ? 'error' : 'healthy',
              lastCheck: Date.now()
            };
          } catch (e) {
            tableData[tableName] = {
              count: -1,
              status: 'error',
              lastCheck: Date.now()
            };
          }
        });
        await Promise.all(promises);
      }
    }

    async function fetchSloppyIDStats() {
      try {
        // Total vault entries
        const { count: totalCount } = await supabase
          .from('sloppyid_vault')
          .select('*', { count: 'exact', head: true });

        document.getElementById('vaultEntries').textContent = totalCount || 0;

        // Public entries
        const { count: publicCount } = await supabase
          .from('sloppyid_vault')
          .select('*', { count: 'exact', head: true })
          .eq('is_public', true);

        document.getElementById('publicEntries').textContent = publicCount || 0;

        // Unique users (distinct usernames)
        const { data: users } = await supabase
          .from('sloppyid_vault')
          .select('username')
          .limit(1000);

        const uniqueUsernames = new Set(users ? users.map(u => u.username) : []);
        document.getElementById('uniqueUsers').textContent = uniqueUsernames.size;

        setStatus('sloppyidStatus', true);
      } catch (e) {
        setStatus('sloppyidStatus', false);
      }
    }

    function renderTables() {
      const container = document.getElementById('tableSections');
      container.innerHTML = '';

      Object.entries(TABLE_CATEGORIES).forEach(([categoryName, category]) => {
        const section = document.createElement('div');
        section.className = 'section';

        const tablesWithData = category.tables.filter(t => tableData[t]);
        const healthyCount = tablesWithData.filter(t => tableData[t].status === 'healthy').length;

        section.innerHTML = `
          <div class="section-header">
            <div class="section-title">
              <span class="category-icon">${category.icon}</span> ${categoryName}
            </div>
            <div class="section-count">${healthyCount}/${category.tables.length} healthy</div>
          </div>
          <div class="table-grid">
            ${category.tables.map(tableName => {
              const data = tableData[tableName] || { count: -1, status: 'loading' };
              const displayName = tableName.replace('sloppygram_', '').replace('sloppyid_', '');
              return `
                <div class="table-card">
                  <div class="table-info">
                    <div class="table-status ${data.status}"></div>
                    <span class="table-name" title="${tableName}">${displayName}</span>
                  </div>
                  <div class="table-stats">
                    <span class="row-count">${data.count >= 0 ? data.count.toLocaleString() : '‚Äî'}</span>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;

        container.appendChild(section);
      });
    }

    function updateMetrics() {
      const tables = Object.values(tableData);
      const totalTables = tables.length;
      const healthyTables = tables.filter(t => t.status === 'healthy').length;
      const totalRows = tables.reduce((sum, t) => sum + Math.max(0, t.count), 0);

      document.getElementById('totalTables').textContent = totalTables;
      document.getElementById('healthyTables').textContent = healthyTables;
      document.getElementById('totalRows').textContent = formatNumber(totalRows);

      // Fetch active users
      fetchActiveUsers();
    }

    async function fetchActiveUsers() {
      try {
        const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();

        // Check karma table for recent activity
        const { count } = await supabase
          .from('sloppygram_karma')
          .select('*', { count: 'exact', head: true })
          .gte('last_activity', yesterday);

        document.getElementById('activeUsers').textContent = count || 0;
      } catch (e) {
        document.getElementById('activeUsers').textContent = '--';
      }
    }

    function formatNumber(num) {
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
      return num.toString();
    }

    // Initialize
    init();
  </script>
  <script src="/sloppy-header/sloppy-bar.js"></script>
<script src="/vibelib-extended.js"></script>
<script>
  // Compatibility Patch for Legacy Apps
  window.addEventListener("load", () => {
    if (window.SloppyKarma && window.VibeLib.Economy) {
      // Redirect old calls to new engine
      window.SloppyKarma.track = window.VibeLib.Economy.track;
    }
  });
</script>
</body>
</html>
