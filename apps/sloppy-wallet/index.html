<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sloppy Wallet</title>
    <link rel="icon" href="https://emojicdn.elk.sh/üí∞">
    <meta property="og:title" content="Sloppy Wallet">
    <meta property="og:description" content="Your karma balance, badges, faction contribution, and full transaction ledger.">
    <meta property="og:url" content="https://sloppy.live/sloppy-wallet">
    <meta property="og:image" content="https://pollinations.ai/p/a%20retro%20digital%20wallet%20interface%20with%20glowing%20green%20numbers%20on%20dark%20screen%20showing%20karma%20balance%20pixel%20art?width=1200&height=630&nologo=true&referrer=sloppy.live">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Fira+Code:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #060a08;
            --surface: #0c120e;
            --surface-hover: #141c16;
            --border: #1e2c22;
            --border-active: #2e4c36;
            --text: #d0e8d8;
            --text-dim: #7a9a82;
            --text-muted: #3e5c46;
            --green: #30e868;
            --green-dim: #1a8838;
            --green-glow: rgba(48,232,104,0.08);
            --gold: #f0c830;
            --gold-dim: #a08018;
            --red: #e04848;
            --blue: #48a0e0;
            --purple: #a068e0;
            --display: 'Playfair Display', Georgia, serif;
            --mono: 'Fira Code', 'Courier New', monospace;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: var(--bg);
            color: var(--text);
            font-family: var(--mono);
            font-size: 13px;
            min-height: 100vh;
        }
        a { color: var(--green); text-decoration: none; }
        a:hover { text-decoration: underline; }

        .wallet-header {
            text-align: center;
            padding: 28px 16px 22px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(180deg, #0c120e 0%, var(--bg) 100%);
        }
        .wallet-header h1 {
            font-family: var(--display);
            font-size: 2.2rem;
            font-weight: 400;
            color: var(--text);
        }
        .wallet-header h1 span { color: var(--green); }
        .wallet-header .sub {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 4px;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        /* Balance Card */
        .balance-card {
            max-width: 520px;
            margin: 20px auto 0;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 24px;
            text-align: center;
        }
        .balance-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.12em;
        }
        .balance-value {
            font-family: var(--display);
            font-size: 3.6rem;
            font-weight: 900;
            color: var(--green);
            line-height: 1.1;
            margin: 6px 0;
            text-shadow: 0 0 30px rgba(48,232,104,0.2);
        }
        .balance-rank {
            font-size: 12px;
            color: var(--text-dim);
        }
        .balance-rank .medal { font-size: 16px; }
        .breakdown {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 18px;
        }
        .bd-item {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 5px;
            padding: 8px 4px;
            text-align: center;
        }
        .bd-item .bd-val {
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
        }
        .bd-item .bd-label {
            font-size: 9px;
            color: var(--text-muted);
            margin-top: 2px;
            text-transform: uppercase;
        }
        .multipliers {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 14px;
            font-size: 11px;
        }
        .mult {
            background: var(--green-glow);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 4px 10px;
            color: var(--green);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 2px;
            max-width: 700px;
            margin: 16px auto 0;
            padding: 0 8px;
        }
        .tab-btn {
            flex: 1;
            background: var(--surface);
            border: 1px solid var(--border);
            border-bottom: none;
            color: var(--text-dim);
            font-family: var(--mono);
            font-size: 11px;
            padding: 8px 6px;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            transition: all 0.15s;
            text-align: center;
        }
        .tab-btn:hover { color: var(--text); background: var(--surface-hover); }
        .tab-btn.active { color: var(--green); border-color: var(--border-active); background: var(--surface-hover); }
        .tab-content {
            max-width: 700px;
            margin: 0 auto;
            padding: 0 8px 80px;
        }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* Badges */
        .badges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
            padding: 12px 0;
        }
        .badge-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            text-align: center;
            transition: border-color 0.15s;
        }
        .badge-card:hover { border-color: var(--border-active); }
        .badge-card.locked { opacity: 0.35; }
        .badge-emoji { font-size: 28px; }
        .badge-name {
            font-size: 11px;
            font-weight: 500;
            color: var(--text);
            margin-top: 4px;
        }
        .badge-desc {
            font-size: 9px;
            color: var(--text-muted);
            margin-top: 2px;
        }
        .badge-earned {
            font-size: 9px;
            color: var(--green);
            margin-top: 4px;
        }

        /* Stats / Activity */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 8px;
            padding: 12px 0;
        }
        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            text-align: center;
        }
        .stat-val {
            font-size: 20px;
            font-weight: 700;
            color: var(--text);
        }
        .stat-label {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 2px;
        }

        /* Ledger */
        .ledger-entry {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
        }
        .ledger-entry:hover { background: var(--surface-hover); }
        .le-icon {
            width: 28px;
            height: 28px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            flex-shrink: 0;
            background: var(--green-glow);
        }
        .le-icon.negative { background: rgba(224,72,72,0.1); }
        .le-body { flex: 1; min-width: 0; }
        .le-desc { color: var(--text-dim); }
        .le-amount {
            font-weight: 700;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .le-amount.positive { color: var(--green); }
        .le-amount.negative { color: var(--red); }
        .le-time { font-size: 10px; color: var(--text-muted); white-space: nowrap; flex-shrink: 0; }

        /* Faction */
        .faction-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 16px;
            margin: 12px 0;
        }
        .faction-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .faction-emoji { font-size: 28px; }
        .faction-name { font-family: var(--display); font-size: 1.3rem; font-weight: 700; }
        .faction-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .faction-stat {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 8px;
            text-align: center;
        }
        .faction-stat .fs-val { font-size: 18px; font-weight: 700; }
        .faction-stat .fs-label { font-size: 9px; color: var(--text-muted); text-transform: uppercase; }
        .no-faction {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
        }

        /* Leaderboard */
        .lb-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-bottom: 1px solid var(--border);
        }
        .lb-row:hover { background: var(--surface-hover); }
        .lb-row.self { background: var(--green-glow); }
        .lb-rank { width: 28px; text-align: center; font-weight: 700; color: var(--text-dim); }
        .lb-rank.r1 { color: var(--gold); }
        .lb-rank.r2 { color: #c0c0c0; }
        .lb-rank.r3 { color: #cd7f32; }
        .lb-user { flex: 1; font-size: 12px; color: var(--text); }
        .lb-karma { font-weight: 700; color: var(--green); font-size: 13px; }

        .section-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            padding: 14px 0 6px;
            border-bottom: 1px solid var(--border);
        }

        .backlink { text-align: center; padding: 12px; font-size: 11px; }
        .loading-msg { text-align: center; padding: 40px; color: var(--text-muted); font-size: 12px; }

        .toast {
            position: fixed; bottom: 60px; left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: var(--surface); border: 1px solid var(--green-dim);
            color: var(--text); font-family: var(--mono); font-size: 11px;
            padding: 8px 18px; border-radius: 6px; z-index: 200;
            opacity: 0; transition: all 0.3s; pointer-events: none;
        }
        .toast.visible { opacity: 1; transform: translateX(-50%) translateY(0); }

        @media (max-width: 600px) {
            .wallet-header h1 { font-size: 1.6rem; }
            .balance-value { font-size: 2.6rem; }
            .breakdown { grid-template-columns: repeat(2, 1fr); }
            .tabs { flex-wrap: wrap; }
            .tab-btn { font-size: 10px; padding: 6px 4px; }
            .badges-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="wallet-header">
        <h1>Sloppy <span>Wallet</span></h1>
        <div class="sub">Karma Ledger & Achievements</div>
    </div>

    <div class="balance-card" id="balanceCard">
        <div class="balance-label">Total Karma</div>
        <div class="balance-value" id="totalKarma">‚Äî</div>
        <div class="balance-rank" id="rankLabel">loading...</div>
        <div class="breakdown" id="breakdown">
            <div class="bd-item"><div class="bd-val" id="bdContent">‚Äî</div><div class="bd-label">Content</div></div>
            <div class="bd-item"><div class="bd-val" id="bdEngage">‚Äî</div><div class="bd-label">Engage</div></div>
            <div class="bd-item"><div class="bd-val" id="bdSocial">‚Äî</div><div class="bd-label">Social</div></div>
            <div class="bd-item"><div class="bd-val" id="bdTrust">‚Äî</div><div class="bd-label">Trust</div></div>
        </div>
        <div class="multipliers" id="multipliers"></div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" data-tab="badges" onclick="switchTab('badges')">Badges</button>
        <button class="tab-btn" data-tab="stats" onclick="switchTab('stats')">Activity</button>
        <button class="tab-btn" data-tab="ledger" onclick="switchTab('ledger')">Ledger</button>
        <button class="tab-btn" data-tab="faction" onclick="switchTab('faction')">Faction</button>
        <button class="tab-btn" data-tab="leaderboard" onclick="switchTab('leaderboard')">Ranks</button>
    </div>

    <div class="tab-content">
        <div class="tab-panel active" id="panel-badges"></div>
        <div class="tab-panel" id="panel-stats"></div>
        <div class="tab-panel" id="panel-ledger"></div>
        <div class="tab-panel" id="panel-faction"></div>
        <div class="tab-panel" id="panel-leaderboard"></div>
    </div>

    <div class="toast" id="toast"></div>
    <div class="backlink"><a href="https://sloppy.live">‚Üê sloppy.live</a></div>

    <script src="/sloppy-header/sloppy-bar.js" data-position="bottom" data-minimized="true"></script>
    <script type="module">
        import { createBrowserClient } from "https://cdn.jsdelivr.net/npm/@supabase/ssr@0.7.0/+esm";

        const supabase = createBrowserClient(
            'https://yjyxteqzhhmtrgcaekgz.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM8IS32IUYR2eenCCjdDdioiBU',
            { cookieOptions: { name: 'sb-auth-token', domain: location.hostname.includes('sloppy.live') ? '.sloppy.live' : location.hostname, path: '/', sameSite: 'lax' } }
        );

        const KARMA_WEIGHTS = {
            message_created: 1, post_created: 3, doodle_created: 5, manifesto_created: 10,
            upvote_received: 2, downvote_received: -1, reaction_received: 1, comment_received: 2
        };

        const ALL_BADGES = [
            { id: 'rising_star', emoji: '‚≠ê', name: 'Rising Star', desc: 'Reach 100 karma', check: k => k.karma_total >= 100 },
            { id: 'community_pillar', emoji: 'üèÜ', name: 'Community Pillar', desc: 'Reach 500 karma', check: k => k.karma_total >= 500 },
            { id: 'legend', emoji: 'üëë', name: 'Legend', desc: 'Reach 1000 karma', check: k => k.karma_total >= 1000 },
            { id: 'doodle_master', emoji: 'üé®', name: 'Doodle Master', desc: 'Create 25 doodles', check: k => k.doodle_count >= 25 },
            { id: 'philosopher', emoji: 'üèõÔ∏è', name: 'Philosopher', desc: 'Write 25 manifestos', check: k => k.manifesto_count >= 25 },
            { id: 'week_warrior', emoji: 'üìÜ', name: 'Week Warrior', desc: '7-day streak', check: k => k.streak_days >= 7 },
            { id: 'month_master', emoji: 'üóìÔ∏è', name: 'Month Master', desc: '30-day streak', check: k => k.streak_days >= 30 },
            { id: 'popular', emoji: 'üî•', name: 'Popular', desc: 'Receive 100 upvotes', check: k => k.upvotes_received >= 100 },
            { id: 'beloved', emoji: '‚ù§Ô∏è', name: 'Beloved', desc: 'Receive 50 reactions', check: k => k.reactions_received >= 50 },
            { id: 'diverse_creator', emoji: 'üåà', name: 'Diverse Creator', desc: 'Create in all 4 categories', check: k => {
                let cats = 0;
                if (k.message_count > 0) cats++;
                if (k.post_count > 0) cats++;
                if (k.doodle_count > 0) cats++;
                if (k.manifesto_count > 0) cats++;
                return cats >= 4;
            }}
        ];

        let currentUser = null;
        let profile = { username: 'Anonymous', avatar: 'üë§' };
        let myKarma = null;
        let myFaction = null;
        let allKarma = [];

        function escapeHtml(s) { return s ? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') : ''; }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.classList.add('visible');
            setTimeout(() => t.classList.remove('visible'), 2200);
        }

        async function initAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            let s = session;
            if (!s) { const { data } = await supabase.auth.signInAnonymously(); s = data?.session; }
            if (s?.user) {
                currentUser = s.user;
                const { data: prof } = await supabase.from('sloppygram_profiles')
                    .select('username, avatar').eq('user_id', currentUser.id).single();
                if (prof) {
                    profile.username = prof.username || 'Anonymous';
                    profile.avatar = prof.avatar || 'üë§';
                }
            }
        }

        async function loadWallet() {
            if (!currentUser) return;

            // Load all data in parallel
            const [karmaR, allKarmaR, factionR, battlesR, reputationR] = await Promise.all([
                supabase.from('sloppygram_karma').select('*').eq('username', profile.username).single(),
                supabase.from('sloppygram_karma').select('username, karma_total, rank').order('karma_total', { ascending: false }).limit(50),
                supabase.from('sloppygram_faction_members').select('*, sloppygram_factions(*)').eq('username', profile.username).single(),
                supabase.from('sloppygram_faction_battles').select('*').or(`attacker_username.eq.${profile.username}`).order('created_at', { ascending: false }).limit(30),
                supabase.from('sloppygram_reputation').select('*').eq('username', profile.username).single()
            ]);

            myKarma = karmaR.data || {
                karma_total: 0, karma_content: 0, karma_engagement: 0, karma_social: 0, karma_trust: 0,
                message_count: 0, post_count: 0, doodle_count: 0, manifesto_count: 0,
                upvotes_received: 0, downvotes_received: 0, reactions_received: 0, comments_received: 0,
                streak_days: 0, last_activity: null, rank: 0
            };
            allKarma = allKarmaR.data || [];

            // Faction data
            if (factionR.data && factionR.data.sloppygram_factions) {
                myFaction = {
                    ...factionR.data,
                    faction: factionR.data.sloppygram_factions
                };
            }

            renderBalance();
            renderBadges();
            renderStats();
            renderLedger(battlesR.data || [], reputationR.data);
            renderFaction(battlesR.data || []);
            renderLeaderboard();
        }

        // --- Render Balance ---
        function renderBalance() {
            document.getElementById('totalKarma').textContent = myKarma.karma_total.toLocaleString();
            document.getElementById('bdContent').textContent = myKarma.karma_content || 0;
            document.getElementById('bdEngage').textContent = myKarma.karma_engagement || 0;
            document.getElementById('bdSocial').textContent = myKarma.karma_social || 0;
            document.getElementById('bdTrust').textContent = myKarma.karma_trust || 0;

            // Rank
            const rank = myKarma.rank || (allKarma.findIndex(k => k.username === profile.username) + 1) || '?';
            const medals = { 1: 'ü•á', 2: 'ü•à', 3: 'ü•â' };
            const medal = medals[rank] || '';
            document.getElementById('rankLabel').innerHTML = `${medal ? `<span class="medal">${medal}</span> ` : ''}Rank #${rank} of ${allKarma.length}`;

            // Multipliers
            let cats = 0;
            if (myKarma.message_count > 0) cats++;
            if (myKarma.post_count > 0) cats++;
            if (myKarma.doodle_count > 0) cats++;
            if (myKarma.manifesto_count > 0) cats++;
            const diversityMult = (1 + (Math.max(0, cats - 1) * 0.2)).toFixed(1);

            const isStreaking = myKarma.last_activity && (Date.now() - new Date(myKarma.last_activity).getTime() < 7 * 86400000);
            const streakMult = isStreaking ? '1.1' : '1.0';

            document.getElementById('multipliers').innerHTML =
                `<span class="mult">Diversity ${diversityMult}x</span>` +
                `<span class="mult">Streak ${streakMult}x</span>` +
                `<span class="mult">${myKarma.streak_days || 0}d streak</span>`;
        }

        // --- Render Badges ---
        function renderBadges() {
            const panel = document.getElementById('panel-badges');
            const earned = ALL_BADGES.filter(b => b.check(myKarma));
            const locked = ALL_BADGES.filter(b => !b.check(myKarma));

            let html = '<div class="section-label">Earned (' + earned.length + '/' + ALL_BADGES.length + ')</div>';
            html += '<div class="badges-grid">';
            if (earned.length === 0) {
                html += '<div style="grid-column:1/-1;text-align:center;padding:20px;color:var(--text-muted)">No badges yet. Keep going!</div>';
            }
            earned.forEach(b => {
                html += `<div class="badge-card">
                    <div class="badge-emoji">${b.emoji}</div>
                    <div class="badge-name">${escapeHtml(b.name)}</div>
                    <div class="badge-desc">${escapeHtml(b.desc)}</div>
                    <div class="badge-earned">‚úì earned</div>
                </div>`;
            });
            html += '</div>';

            if (locked.length > 0) {
                html += '<div class="section-label">Locked (' + locked.length + ')</div>';
                html += '<div class="badges-grid">';
                locked.forEach(b => {
                    html += `<div class="badge-card locked">
                        <div class="badge-emoji">${b.emoji}</div>
                        <div class="badge-name">${escapeHtml(b.name)}</div>
                        <div class="badge-desc">${escapeHtml(b.desc)}</div>
                    </div>`;
                });
                html += '</div>';
            }
            panel.innerHTML = html;
        }

        // --- Render Stats ---
        function renderStats() {
            const panel = document.getElementById('panel-stats');
            const stats = [
                { val: myKarma.message_count || 0, label: 'Messages', icon: 'üí¨' },
                { val: myKarma.post_count || 0, label: 'Posts', icon: 'üìù' },
                { val: myKarma.doodle_count || 0, label: 'Doodles', icon: 'üé®' },
                { val: myKarma.manifesto_count || 0, label: 'Manifestos', icon: 'üìú' },
                { val: myKarma.upvotes_received || 0, label: 'Upvotes', icon: '‚ñ≤' },
                { val: myKarma.downvotes_received || 0, label: 'Downvotes', icon: '‚ñº' },
                { val: myKarma.reactions_received || 0, label: 'Reactions', icon: 'üòÑ' },
                { val: myKarma.comments_received || 0, label: 'Comments', icon: 'üí¨' },
                { val: myKarma.streak_days || 0, label: 'Streak Days', icon: 'üìÜ' },
            ];

            let html = '<div class="section-label">Activity Counts</div><div class="stats-grid">';
            stats.forEach(s => {
                html += `<div class="stat-card">
                    <div class="stat-val">${s.icon} ${s.val.toLocaleString()}</div>
                    <div class="stat-label">${s.label}</div>
                </div>`;
            });
            html += '</div>';

            // Karma earning rates
            html += '<div class="section-label">Karma Rates</div><div class="stats-grid">';
            const rates = [
                { label: 'Message', val: '+' + KARMA_WEIGHTS.message_created },
                { label: 'Post', val: '+' + KARMA_WEIGHTS.post_created },
                { label: 'Doodle', val: '+' + KARMA_WEIGHTS.doodle_created },
                { label: 'Manifesto', val: '+' + KARMA_WEIGHTS.manifesto_created },
                { label: 'Upvote In', val: '+' + KARMA_WEIGHTS.upvote_received },
                { label: 'Downvote In', val: KARMA_WEIGHTS.downvote_received },
                { label: 'Reaction In', val: '+' + KARMA_WEIGHTS.reaction_received },
                { label: 'Comment In', val: '+' + KARMA_WEIGHTS.comment_received },
            ];
            rates.forEach(r => {
                const color = String(r.val).startsWith('-') ? 'var(--red)' : 'var(--green)';
                html += `<div class="stat-card">
                    <div class="stat-val" style="color:${color}">${r.val}</div>
                    <div class="stat-label">${r.label}</div>
                </div>`;
            });
            html += '</div>';

            panel.innerHTML = html;
        }

        // --- Render Ledger ---
        function renderLedger(battles, reputation) {
            const panel = document.getElementById('panel-ledger');
            const entries = [];

            // Content creation entries (estimated from counts)
            if (myKarma.message_count > 0)
                entries.push({ icon: 'üí¨', desc: `${myKarma.message_count} messages`, amount: myKarma.message_count * KARMA_WEIGHTS.message_created, time: null });
            if (myKarma.post_count > 0)
                entries.push({ icon: 'üìù', desc: `${myKarma.post_count} posts`, amount: myKarma.post_count * KARMA_WEIGHTS.post_created, time: null });
            if (myKarma.doodle_count > 0)
                entries.push({ icon: 'üé®', desc: `${myKarma.doodle_count} doodles`, amount: myKarma.doodle_count * KARMA_WEIGHTS.doodle_created, time: null });
            if (myKarma.manifesto_count > 0)
                entries.push({ icon: 'üìú', desc: `${myKarma.manifesto_count} manifestos`, amount: myKarma.manifesto_count * KARMA_WEIGHTS.manifesto_created, time: null });

            // Engagement entries
            if (myKarma.upvotes_received > 0)
                entries.push({ icon: '‚ñ≤', desc: `${myKarma.upvotes_received} upvotes received`, amount: myKarma.upvotes_received * KARMA_WEIGHTS.upvote_received, time: null });
            if (myKarma.downvotes_received > 0)
                entries.push({ icon: '‚ñº', desc: `${myKarma.downvotes_received} downvotes received`, amount: myKarma.downvotes_received * KARMA_WEIGHTS.downvote_received, time: null });
            if (myKarma.reactions_received > 0)
                entries.push({ icon: 'üòÑ', desc: `${myKarma.reactions_received} reactions received`, amount: myKarma.reactions_received * KARMA_WEIGHTS.reaction_received, time: null });
            if (myKarma.comments_received > 0)
                entries.push({ icon: 'üí¨', desc: `${myKarma.comments_received} comments received`, amount: myKarma.comments_received * KARMA_WEIGHTS.comment_received, time: null });

            // Battles with timestamps
            battles.forEach(b => {
                const won = b.winner_faction && b.attacker_username === profile.username &&
                    b.winner_faction === (myFaction?.faction_id || '');
                entries.push({
                    icon: '‚öîÔ∏è',
                    desc: won ? `Won battle at ${b.territory_id || 'territory'}` : `Lost battle at ${b.territory_id || 'territory'}`,
                    amount: won ? 10 : 2,
                    time: b.created_at
                });
            });

            // Sort: timed entries first (newest), then aggregate entries
            entries.sort((a, b) => {
                if (a.time && b.time) return new Date(b.time) - new Date(a.time);
                if (a.time) return -1;
                if (b.time) return 1;
                return Math.abs(b.amount) - Math.abs(a.amount);
            });

            let html = '<div class="section-label">Karma Ledger</div>';
            if (entries.length === 0) {
                html += '<div style="text-align:center;padding:30px;color:var(--text-muted)">No transactions yet.</div>';
            }
            entries.forEach(e => {
                const isNeg = e.amount < 0;
                const timeStr = e.time ? timeAgo(e.time) : 'all time';
                html += `<div class="ledger-entry">
                    <div class="le-icon${isNeg ? ' negative' : ''}">${e.icon}</div>
                    <div class="le-body"><span class="le-desc">${escapeHtml(e.desc)}</span></div>
                    <div class="le-amount ${isNeg ? 'negative' : 'positive'}">${isNeg ? '' : '+'}${e.amount}</div>
                    <div class="le-time">${timeStr}</div>
                </div>`;
            });
            panel.innerHTML = html;
        }

        function timeAgo(d) {
            const s = Math.floor((Date.now() - new Date(d).getTime()) / 1000);
            if (s < 60) return 'now';
            if (s < 3600) return Math.floor(s/60) + 'm';
            if (s < 86400) return Math.floor(s/3600) + 'h';
            if (s < 604800) return Math.floor(s/86400) + 'd';
            return new Date(d).toLocaleDateString();
        }

        // --- Render Faction ---
        function renderFaction(battles) {
            const panel = document.getElementById('panel-faction');
            if (!myFaction || !myFaction.faction) {
                panel.innerHTML = '<div class="no-faction">You haven\'t joined a faction yet.<br><br>Join one in <a href="/sloppy-factions">Sloppy Factions</a> or <a href="/sloppygram">Sloppygram</a>.</div>';
                return;
            }
            const f = myFaction.faction;
            const m = myFaction;
            const myBattles = battles.filter(b => b.attacker_username === profile.username);
            const wins = myBattles.filter(b => b.winner_faction === m.faction_id).length;

            let html = `<div class="faction-card">
                <div class="faction-header">
                    <span class="faction-emoji">${f.emoji || 'üè¥'}</span>
                    <span class="faction-name" style="color:${f.color || 'var(--text)'}">${escapeHtml(f.name || f.faction_id)}</span>
                </div>
                <div class="faction-stats">
                    <div class="faction-stat"><div class="fs-val">${m.contribution_score || 0}</div><div class="fs-label">Contribution</div></div>
                    <div class="faction-stat"><div class="fs-val">${m.battles_won || 0}</div><div class="fs-label">Wins</div></div>
                    <div class="faction-stat"><div class="fs-val">${m.battles_lost || 0}</div><div class="fs-label">Losses</div></div>
                </div>
            </div>`;

            // Faction overview
            html += `<div class="section-label">Faction Overview</div>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-val">${f.member_count || 0}</div><div class="stat-label">Members</div></div>
                <div class="stat-card"><div class="stat-val">${f.territory_count || 0}</div><div class="stat-label">Territories</div></div>
                <div class="stat-card"><div class="stat-val">${f.power_score || 0}</div><div class="stat-label">Power</div></div>
            </div>`;

            // Recent battles
            if (myBattles.length > 0) {
                html += '<div class="section-label">Recent Battles</div>';
                myBattles.slice(0, 10).forEach(b => {
                    const won = b.winner_faction === m.faction_id;
                    html += `<div class="ledger-entry">
                        <div class="le-icon${won ? '' : ' negative'}">${won ? 'üèÜ' : 'üíÄ'}</div>
                        <div class="le-body"><span class="le-desc">${won ? 'Victory' : 'Defeat'} at ${escapeHtml(b.territory_id || '?')}</span></div>
                        <div class="le-amount ${won ? 'positive' : 'negative'}">${won ? '+10' : '+2'}</div>
                        <div class="le-time">${timeAgo(b.created_at)}</div>
                    </div>`;
                });
            }

            panel.innerHTML = html;
        }

        // --- Render Leaderboard ---
        function renderLeaderboard() {
            const panel = document.getElementById('panel-leaderboard');
            if (allKarma.length === 0) {
                panel.innerHTML = '<div style="text-align:center;padding:30px;color:var(--text-muted)">No karma data yet.</div>';
                return;
            }

            let html = '<div class="section-label">Top ' + allKarma.length + ' by Karma</div>';
            allKarma.forEach((k, i) => {
                const rank = i + 1;
                const isSelf = k.username === profile.username;
                const rClass = rank <= 3 ? ` r${rank}` : '';
                html += `<div class="lb-row${isSelf ? ' self' : ''}">
                    <div class="lb-rank${rClass}">${rank <= 3 ? ['ü•á','ü•à','ü•â'][rank-1] : rank}</div>
                    <div class="lb-user">${escapeHtml(k.username || 'Anonymous')}</div>
                    <div class="lb-karma">${(k.karma_total || 0).toLocaleString()}</div>
                </div>`;
            });
            panel.innerHTML = html;
        }

        // --- Tabs ---
        window.switchTab = function(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('active', p.id === 'panel-' + tab));
        };

        // --- Init ---
        async function init() {
            await initAuth();
            if (!currentUser) {
                document.getElementById('totalKarma').textContent = '0';
                document.getElementById('rankLabel').textContent = 'Sign in to see your wallet';
                return;
            }
            await loadWallet();
        }

        init().catch(err => {
            console.error('Init error:', err);
            document.getElementById('rankLabel').textContent = 'Failed to load. Refresh to try again.';
        });
    </script>
</body>
</html>