<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sloppy Discovery â€” Find Something New</title>
<link rel="icon" href="https://emojicdn.elk.sh/ðŸ”®">
<meta property="og:title" content="Sloppy Discovery">
<meta property="og:description" content="Explore the best posts, manifestos, and messages across the entire community.">
<meta property="og:url" content="https://app.sloppy.live/sloppy-discovery">
<meta property="og:image" content="https://image.pollinations.ai/prompt/cosmic%20telescope%20looking%20into%20swirling%20galaxy%20of%20glowing%20cards%20and%20text%20fragments%20dark%20purple%20teal%20gold?width=1200&height=630&nologo=true&referrer=sloppy.live">
<link href="https://fonts.googleapis.com/css2?family=Anybody:wght@100;400;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#06060e;--surface:#0c0c18;--surface2:#111122;--border:#1a1a30;--border-hi:#2a2a50;
  --text:#ccc8dc;--dim:#55527a;--accent:#c084fc;--accent2:#818cf8;
  --teal:#2dd4bf;--amber:#fbbf24;--rose:#fb7185;--sky:#38bdf8;
  --post:#818cf8;--manifesto:#c084fc;--chat:#2dd4bf;
}
body{background:var(--bg);color:var(--text);font-family:'DM Mono',monospace;min-height:100vh}
body::before{content:'';position:fixed;inset:0;
  background:radial-gradient(ellipse at 50% 0%,rgba(192,132,252,.04) 0%,transparent 60%),
             radial-gradient(ellipse at 0% 100%,rgba(45,212,191,.03) 0%,transparent 50%);pointer-events:none}
.app{position:relative;max-width:780px;margin:0 auto;padding:20px 16px 80px}

h1{font-family:'Anybody',sans-serif;font-weight:800;font-size:2.6rem;letter-spacing:-.03em;
  background:linear-gradient(135deg,var(--accent),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent;
  line-height:1.1}
.sub{font-size:.6rem;color:var(--dim);letter-spacing:.14em;text-transform:uppercase;margin-top:6px}
header{margin-bottom:24px}

/* Mode bar */
.modes{display:flex;gap:4px;margin-bottom:16px;overflow-x:auto;padding-bottom:4px}
.mode{padding:8px 14px;font-size:.65rem;font-family:'DM Mono',monospace;letter-spacing:.04em;
  text-transform:uppercase;color:var(--dim);background:var(--surface);border:1px solid var(--border);
  border-radius:20px;cursor:pointer;white-space:nowrap;transition:.2s}
.mode:hover{border-color:var(--border-hi);color:var(--text)}
.mode.active{border-color:var(--accent);color:var(--accent);background:rgba(192,132,252,.06)}

/* Tag bar */
.tag-bar{display:flex;gap:6px;margin-bottom:16px;overflow-x:auto;padding-bottom:4px}
.tag-chip{padding:4px 10px;font-size:.6rem;border:1px solid var(--border);border-radius:12px;
  color:var(--dim);background:transparent;cursor:pointer;font-family:'DM Mono',monospace;transition:.2s;white-space:nowrap}
.tag-chip:hover{color:var(--text);border-color:var(--border-hi)}
.tag-chip.active{border-color:var(--teal);color:var(--teal);background:rgba(45,212,191,.06)}

/* Cards */
.feed{display:flex;flex-direction:column;gap:12px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;
  transition:border-color .2s,transform .15s}
.card:hover{border-color:var(--border-hi);transform:translateY(-1px)}
.card-header{display:flex;align-items:center;gap:10px;padding:14px 16px 0}
.card-type{font-size:.55rem;text-transform:uppercase;letter-spacing:.1em;padding:2px 8px;border-radius:10px;font-weight:500}
.card-type.post{background:rgba(129,140,248,.1);color:var(--post)}
.card-type.manifesto{background:rgba(192,132,252,.1);color:var(--manifesto)}
.card-type.chat{background:rgba(45,212,191,.1);color:var(--chat)}
.card-user{font-size:.7rem;color:var(--dim)}
.card-time{font-size:.6rem;color:var(--dim);margin-left:auto}
.card-body{padding:10px 16px 14px}
.card-title{font-family:'Anybody',sans-serif;font-weight:800;font-size:1rem;margin-bottom:4px;color:var(--text);line-height:1.3}
.card-text{font-size:.78rem;line-height:1.6;color:var(--text);opacity:.85;word-break:break-word}
.card-text.truncated{max-height:100px;overflow:hidden;position:relative}
.card-text.truncated::after{content:'';position:absolute;bottom:0;left:0;right:0;height:30px;
  background:linear-gradient(transparent,var(--surface))}
.card-img{width:100%;max-height:300px;object-fit:cover;display:block}
.card-footer{display:flex;align-items:center;gap:14px;padding:0 16px 12px;flex-wrap:wrap}
.card-stat{font-size:.6rem;color:var(--dim);display:flex;align-items:center;gap:3px}
.card-stat .num{color:var(--text);font-weight:500}
.card-tags{display:flex;gap:4px;flex-wrap:wrap;padding:0 16px 10px}
.card-tag{font-size:.55rem;color:var(--accent);background:rgba(192,132,252,.06);
  padding:1px 6px;border-radius:8px;cursor:pointer}
.card-tag:hover{background:rgba(192,132,252,.12)}

/* Score badge */
.card-score{position:absolute;top:12px;right:12px;font-family:'Anybody',sans-serif;font-weight:800;
  font-size:.7rem;padding:2px 8px;border-radius:8px;background:rgba(251,191,36,.1);color:var(--amber)}

/* Surprise button */
.surprise-wrap{text-align:center;margin-bottom:20px}
.surprise-btn{padding:12px 28px;font-family:'Anybody',sans-serif;font-weight:800;font-size:.85rem;
  border:2px solid var(--accent);border-radius:24px;background:rgba(192,132,252,.06);color:var(--accent);
  cursor:pointer;transition:.25s;letter-spacing:.02em}
.surprise-btn:hover{background:rgba(192,132,252,.15);box-shadow:0 0 24px rgba(192,132,252,.15);transform:scale(1.03)}
.surprise-btn:active{transform:scale(.97)}

/* Load more */
.load-more{display:block;margin:20px auto 0;padding:10px 24px;font-family:'DM Mono',monospace;font-size:.7rem;
  border:1px solid var(--border);border-radius:8px;background:var(--surface);color:var(--dim);cursor:pointer;transition:.2s}
.load-more:hover{border-color:var(--accent);color:var(--accent)}

/* Loading / empty */
.loading{text-align:center;padding:40px;color:var(--dim);font-size:.75rem}
.spinner{display:inline-block;width:20px;height:20px;border:2px solid var(--border);
  border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;margin-bottom:8px}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:40px;color:var(--dim);font-size:.8rem}

/* Responsive */
@media(max-width:600px){
  h1{font-size:1.8rem}
  .card-title{font-size:.9rem}
  .modes{gap:3px}
  .mode{padding:6px 10px;font-size:.6rem}
}
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>Discovery</h1>
    <div class="sub">posts Â· manifestos Â· messages â€” all in one place</div>
  </header>

  <div class="modes" id="modes">
    <button class="mode active" data-mode="trending" onclick="setMode('trending')">ðŸ”¥ Trending</button>
    <button class="mode" data-mode="newest" onclick="setMode('newest')">âš¡ Newest</button>
    <button class="mode" data-mode="foryou" onclick="setMode('foryou')">âœ¦ For You</button>
    <button class="mode" data-mode="discussed" onclick="setMode('discussed')">ðŸ’¬ Discussed</button>
    <button class="mode" data-mode="surprise" onclick="setMode('surprise')">ðŸŽ² Surprise</button>
  </div>

  <div class="tag-bar" id="tag-bar"></div>

  <div id="surprise-zone" style="display:none">
    <div class="surprise-wrap">
      <button class="surprise-btn" onclick="rollSurprise()">Roll again</button>
    </div>
  </div>

  <div class="feed" id="feed">
    <div class="loading"><div class="spinner"></div><br>Scanning the network...</div>
  </div>

  <button class="load-more" id="load-more" onclick="loadMore()" style="display:none">Load more</button>
</div>

<script type="module">
import { createBrowserClient } from "https://cdn.jsdelivr.net/npm/@supabase/ssr@0.7.0/+esm";

const SUPABASE_URL = 'https://yjyxteqzhhmtrgcaekgz.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqeXh0ZXF6aGhtdHJnY2Fla2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTg3NDIsImV4cCI6MjA3MjkzNDc0Mn0.G8SRde7IN2QFW1EnASM8IS32IUYR2eenCCjdDdioiBU';

const supabase = createBrowserClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  cookieOptions: {
    name: 'sb-auth-token',
    domain: location.hostname.includes('sloppy.live') ? '.sloppy.live' : location.hostname,
    path: '/', sameSite: 'lax'
  }
});

const ESC = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

// â”€â”€ State â”€â”€
let allItems = [];
let activeMode = 'trending';
let activeTag = null;
let page = 0;
const PAGE_SIZE = 20;
let currentUser = null;
let myFollows = new Set();
let postVotes = {}, postComments = {}, postReactions = {};
let manVotes = {}, manComments = {};
let allTags = [];

// â”€â”€ Load all data â”€â”€
async function loadData() {
  const weekAgo = new Date(Date.now() - 7*24*60*60*1000).toISOString();
  const monthAgo = new Date(Date.now() - 30*24*60*60*1000).toISOString();

  // Auth check
  const { data: { session } } = await supabase.auth.getSession();
  if (session?.user) {
    currentUser = session.user;
    const { data: follows } = await supabase.from('sloppygram_follows')
      .select('followed_username').eq('user_id', currentUser.id);
    (follows || []).forEach(f => myFollows.add(f.followed_username));
  }

  // Content: posts (month), manifestos (month), messages (week)
  const [postRes, manRes, msgRes] = await Promise.all([
    supabase.from('sloppygram_posts')
      .select('id,username,caption,image_url,likes_count,created_at')
      .gte('created_at', monthAgo).order('created_at',{ascending:false}).limit(300),
    supabase.from('sloppygram_manifestos')
      .select('id,username,title,content,upvotes,created_at')
      .gte('created_at', monthAgo).order('created_at',{ascending:false}).limit(200),
    supabase.from('sloppygram_messages')
      .select('id,username,content,message_type,image_data,drawing_data,created_at')
      .gte('created_at', weekAgo).order('created_at',{ascending:false}).limit(300),
  ]);

  // Engagement data
  const postIds = (postRes.data||[]).map(p=>p.id);
  const manIds = (manRes.data||[]).map(m=>m.id);

  const [pvRes, pcRes, prRes, mvRes, mcRes, ptRes, mtRes] = await Promise.all([
    postIds.length ? supabase.from('sloppygram_post_likes').select('post_id,vote_type').in('post_id', postIds) : {data:[]},
    postIds.length ? supabase.from('sloppygram_post_comments').select('post_id').in('post_id', postIds) : {data:[]},
    postIds.length ? supabase.from('sloppygram_post_reactions').select('post_id').in('post_id', postIds) : {data:[]},
    manIds.length ? supabase.from('sloppygram_manifesto_votes').select('manifesto_id,vote_type').in('manifesto_id', manIds) : {data:[]},
    manIds.length ? supabase.from('sloppygram_manifesto_comments').select('manifesto_id').in('manifesto_id', manIds) : {data:[]},
    postIds.length ? supabase.from('sloppygram_post_tags').select('post_id,tag,parent_tag').in('post_id', postIds) : {data:[]},
    manIds.length ? supabase.from('sloppygram_manifesto_tags').select('manifesto_id,tag,parent_tag').in('manifesto_id', manIds) : {data:[]},
  ]);

  // Aggregate votes
  (pvRes.data||[]).forEach(v => { postVotes[v.post_id] = (postVotes[v.post_id]||0) + (v.vote_type === 1 ? 1 : -1); });
  (pcRes.data||[]).forEach(c => { postComments[c.post_id] = (postComments[c.post_id]||0) + 1; });
  (prRes.data||[]).forEach(r => { postReactions[r.post_id] = (postReactions[r.post_id]||0) + 1; });
  (mvRes.data||[]).forEach(v => { manVotes[v.manifesto_id] = (manVotes[v.manifesto_id]||0) + (v.vote_type === 1 ? 1 : -1); });
  (mcRes.data||[]).forEach(c => { manComments[c.manifesto_id] = (manComments[c.manifesto_id]||0) + 1; });

  // Tag maps
  const postTagMap = {}, manTagMap = {};
  (ptRes.data||[]).forEach(t => {
    if (!postTagMap[t.post_id]) postTagMap[t.post_id] = [];
    postTagMap[t.post_id].push(t.parent_tag ? t.parent_tag+'/'+t.tag : t.tag);
  });
  (mtRes.data||[]).forEach(t => {
    if (!manTagMap[t.manifesto_id]) manTagMap[t.manifesto_id] = [];
    manTagMap[t.manifesto_id].push(t.parent_tag ? t.parent_tag+'/'+t.tag : t.tag);
  });

  // Build unified items
  const posts = (postRes.data||[]).map(p => {
    const votes = postVotes[p.id] || 0;
    const comments = postComments[p.id] || 0;
    const reactions = postReactions[p.id] || 0;
    return {
      id: 'p-'+p.id, type: 'post', username: p.username||'anon',
      title: null, text: p.caption||'', image: p.image_url||null,
      votes, comments, reactions, likes: p.likes_count||0,
      tags: postTagMap[p.id]||[],
      created_at: p.created_at,
      score: computeScore(votes, comments, reactions, p.created_at)
    };
  });

  const manifestos = (manRes.data||[]).map(m => {
    const votes = manVotes[m.id] || (m.upvotes||0);
    const comments = manComments[m.id] || 0;
    return {
      id: 'm-'+m.id, type: 'manifesto', username: m.username||'anon',
      title: m.title||'Untitled', text: m.content||'', image: null,
      votes, comments, reactions: 0,
      tags: manTagMap[m.id]||[],
      created_at: m.created_at,
      score: computeScore(votes, comments, 0, m.created_at) * 1.2 // manifesto boost
    };
  });

  const messages = (msgRes.data||[]).filter(m => (m.content||'').length > 20).map(m => ({
    id: 'c-'+m.id, type: 'chat', username: m.username||'anon',
    title: null, text: m.content||'', image: m.image_data||m.drawing_data||null,
    votes: 0, comments: 0, reactions: 0,
    tags: extractTags(m.content),
    created_at: m.created_at,
    score: computeScore(0, 0, 0, m.created_at) * 0.6 // chat discount
  }));

  allItems = [...posts, ...manifestos, ...messages];

  // Collect all tags
  const tagFreq = {};
  allItems.forEach(i => i.tags.forEach(t => { tagFreq[t] = (tagFreq[t]||0) + 1; }));
  allTags = Object.entries(tagFreq).sort((a,b)=>b[1]-a[1]).slice(0, 20).map(([t])=>t);

  renderTagBar();
  render();
}

// â”€â”€ Scoring: HN-style with engagement signals â”€â”€
function computeScore(votes, comments, reactions, created_at) {
  const ageHours = Math.max((Date.now() - new Date(created_at).getTime()) / (60*60*1000), 0.5);
  const engagement = Math.max(votes, 0) * 3 + comments * 5 + reactions * 2;
  // Gravity decay
  return (engagement + 1) / Math.pow(ageHours + 2, 1.4);
}

function extractTags(text) {
  if (!text) return [];
  return (text.match(/#[a-zA-Z0-9_/]+/g)||[]).map(t => t.slice(1).toLowerCase());
}

// â”€â”€ Sort / Filter â”€â”€
function getFilteredSorted() {
  let items = [...allItems];

  // Tag filter
  if (activeTag) {
    items = items.filter(i => i.tags.some(t => t === activeTag || t.startsWith(activeTag + '/')));
  }

  // Mode sorting
  if (activeMode === 'trending') {
    items.sort((a,b) => b.score - a.score);
  } else if (activeMode === 'newest') {
    items.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
  } else if (activeMode === 'discussed') {
    items.sort((a,b) => (b.comments + b.reactions) - (a.comments + a.reactions));
  } else if (activeMode === 'foryou') {
    // Boost content from followed users and similar tags
    items = items.map(i => {
      let boost = 0;
      if (myFollows.has(i.username)) boost += 5;
      if (i.type === 'manifesto') boost += 2;
      if (i.type === 'post' && i.image) boost += 1;
      return { ...i, fyScore: i.score + boost };
    });
    items.sort((a,b) => b.fyScore - a.fyScore);
  } else if (activeMode === 'surprise') {
    // Random shuffle
    for (let i = items.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [items[i], items[j]] = [items[j], items[i]];
    }
  }

  return items;
}

// â”€â”€ Render â”€â”€
function render() {
  const items = getFilteredSorted();
  const visible = items.slice(0, (page + 1) * PAGE_SIZE);

  document.getElementById('surprise-zone').style.display = activeMode === 'surprise' ? '' : 'none';

  if (visible.length === 0) {
    document.getElementById('feed').innerHTML = '<div class="empty">Nothing found. Try a different mode or tag.</div>';
    document.getElementById('load-more').style.display = 'none';
    return;
  }

  document.getElementById('feed').innerHTML = visible.map(renderCard).join('');
  document.getElementById('load-more').style.display = visible.length < items.length ? '' : 'none';
}

function renderCard(item) {
  const typeClass = item.type;
  const typeLabel = item.type === 'post' ? 'Post' : item.type === 'manifesto' ? 'Manifesto' : 'Chat';
  const ago = timeAgo(item.created_at);
  const preview = item.text.length > 280 ? item.text.slice(0, 280) + 'â€¦' : item.text;
  const truncClass = item.text.length > 280 ? ' truncated' : '';

  let imgHtml = '';
  if (item.image && item.type !== 'chat') {
    imgHtml = `<img class="card-img" src="${ESC(item.image)}" alt="" loading="lazy" onerror="this.style.display='none'">`;
  }

  const tagsHtml = item.tags.length > 0
    ? `<div class="card-tags">${item.tags.slice(0,5).map(t =>
        `<span class="card-tag" onclick="setTag('${ESC(t)}')">#${ESC(t)}</span>`
      ).join('')}</div>` : '';

  return `<div class="card" style="position:relative">
    <div class="card-score">${item.score.toFixed(1)}</div>
    ${imgHtml}
    <div class="card-header">
      <span class="card-type ${typeClass}">${typeLabel}</span>
      <span class="card-user">@${ESC(item.username)}</span>
      <span class="card-time">${ago}</span>
    </div>
    <div class="card-body">
      ${item.title ? `<div class="card-title">${ESC(item.title)}</div>` : ''}
      <div class="card-text${truncClass}">${ESC(preview)}</div>
    </div>
    ${tagsHtml}
    <div class="card-footer">
      ${item.votes !== 0 ? `<span class="card-stat">${item.votes > 0 ? 'â–²' : 'â–¼'} <span class="num">${Math.abs(item.votes)}</span></span>` : ''}
      ${item.comments > 0 ? `<span class="card-stat">ðŸ’¬ <span class="num">${item.comments}</span></span>` : ''}
      ${item.reactions > 0 ? `<span class="card-stat">ðŸ˜‚ <span class="num">${item.reactions}</span></span>` : ''}
      ${item.likes > 0 ? `<span class="card-stat">â™¥ <span class="num">${item.likes}</span></span>` : ''}
    </div>
  </div>`;
}

// â”€â”€ Tag bar â”€â”€
function renderTagBar() {
  const bar = document.getElementById('tag-bar');
  if (allTags.length === 0) { bar.innerHTML = ''; return; }
  bar.innerHTML = `<span class="tag-chip${!activeTag ? ' active' : ''}" onclick="setTag(null)">All</span>` +
    allTags.map(t => `<span class="tag-chip${activeTag===t?' active':''}" onclick="setTag('${ESC(t)}')">#${ESC(t)}</span>`).join('');
}

// â”€â”€ Controls â”€â”€
window.setMode = function(mode) {
  activeMode = mode;
  page = 0;
  document.querySelectorAll('.mode').forEach(m => m.classList.toggle('active', m.dataset.mode === mode));
  render();
};

window.setTag = function(tag) {
  activeTag = tag;
  page = 0;
  renderTagBar();
  render();
};

window.loadMore = function() {
  page++;
  render();
};

window.rollSurprise = function() {
  page = 0;
  render(); // re-shuffles
};

function timeAgo(ts) {
  const s = Math.floor((Date.now() - new Date(ts).getTime()) / 1000);
  if (s < 60) return 'just now';
  if (s < 3600) return Math.floor(s/60) + 'm';
  if (s < 86400) return Math.floor(s/3600) + 'h';
  return Math.floor(s/86400) + 'd';
}

// â”€â”€ Real-time â”€â”€
function setupRealtime() {
  const ch = supabase.channel('discovery-rt');
  ['sloppygram_posts','sloppygram_manifestos','sloppygram_messages'].forEach(table => {
    ch.on('postgres_changes', { event: 'INSERT', schema: 'public', table }, payload => {
      const r = payload.new;
      let item;
      if (table === 'sloppygram_posts') {
        item = { id:'p-'+r.id, type:'post', username:r.username||'anon', title:null,
          text:r.caption||'', image:r.image_url||null, votes:0, comments:0, reactions:0,
          likes:0, tags:[], created_at:r.created_at, score:computeScore(0,0,0,r.created_at) };
      } else if (table === 'sloppygram_manifestos') {
        item = { id:'m-'+r.id, type:'manifesto', username:r.username||'anon', title:r.title||'Untitled',
          text:r.content||'', image:null, votes:0, comments:0, reactions:0,
          tags:[], created_at:r.created_at, score:computeScore(0,0,0,r.created_at)*1.2 };
      } else {
        if ((r.content||'').length <= 20) return;
        item = { id:'c-'+r.id, type:'chat', username:r.username||'anon', title:null,
          text:r.content||'', image:null, votes:0, comments:0, reactions:0,
          tags:extractTags(r.content), created_at:r.created_at, score:computeScore(0,0,0,r.created_at)*0.6 };
      }
      allItems.unshift(item);
      if (activeMode === 'newest') render();
    });
  });
  ch.subscribe();
}

// â”€â”€ Init â”€â”€
loadData().then(setupRealtime);
</script>
<script src="/apps/sloppy-header/sloppy-bar.js" data-position="bottom" data-minimized="true"></script>
<script src="/vibelib-extended.js"></script>
<script>
  // Compatibility Patch for Legacy Apps
  window.addEventListener("load", () => {
    if (window.SloppyKarma && window.VibeLib.Economy) {
      // Redirect old calls to new engine
      window.SloppyKarma.track = window.VibeLib.Economy.track;
    }
  });
</script>
</body>
</html>
